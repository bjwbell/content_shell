diff --git a/BUILD.gn b/BUILD.gn
index 01af6cc..dc6b3d3 100644
--- a/BUILD.gn
+++ b/BUILD.gn
@@ -357,7 +357,6 @@ group("both_gn_and_gyp") {
     deps += [
       "//chrome/installer/gcapi",
       "//chrome/tools/build/win/syzygy:chrome_dll_syzygy",
-      "//chrome/tools/disable_outdated_build_detector",
     ]
   }
 
@@ -412,12 +411,16 @@ group("both_gn_and_gyp") {
         "//android_webview/tools/system_webview_shell",
         "//chrome/android:chrome_junit_tests",
         "//chrome/android:chrome_public_apk",
-        "//chrome/android:chrome_public_test_apk",
-        "//chrome/android:chrome_sync_shell_test_apk",
         "//chrome/test/chromedriver/test/webview_shell:chromedriver_webview_shell_apk",
         "//content/shell/android:content_shell_test_apk",
         "//third_party/custom_tabs_client:custom_tabs_client_example_apk",
       ]
+      if (!enable_all_proguard_optimizations) {
+        deps += [
+          "//chrome/android:chrome_public_test_apk",
+          "//chrome/android:chrome_sync_shell_test_apk",
+        ]
+      }
     }
 
     if (target_cpu != "x64") {
diff --git a/DEPS b/DEPS
index c6f0fa7..7da8666 100644
--- a/DEPS
+++ b/DEPS
@@ -36,11 +36,11 @@ vars = {
   # Three lines of non-changing comments so that
   # the commit queue can handle CLs rolling Skia
   # and whatever else without interference from each other.
-  'skia_revision': 'c6f411e72b1fea6608f540f64a57bcacbe3378cd',
+  'skia_revision': 'ac09554dce518e9d4496771f648f3ae17eca857c',
   # Three lines of non-changing comments so that
   # the commit queue can handle CLs rolling V8
   # and whatever else without interference from each other.
-  'v8_revision': 'fbcbbfc7642d55d441d9cbc9409058702e6b78c8',
+  'v8_revision': '61be62536ea2689143396ddca6047016be8be5d2',
   # Three lines of non-changing comments so that
   # the commit queue can handle CLs rolling swarming_client
   # and whatever else without interference from each other.
@@ -52,11 +52,11 @@ vars = {
   # Three lines of non-changing comments so that
   # the commit queue can handle CLs rolling build tools
   # and whatever else without interference from each other.
-  'buildtools_revision': 'e4aa960cb9cd2c7dbaa69655efa85b3d7dff13dd',
+  'buildtools_revision': '9c6ad6f5cbc2f30989edc3504ec7f9d360542512',
   # Three lines of non-changing comments so that
   # the commit queue can handle CLs rolling PDFium
   # and whatever else without interference from each other.
-  'pdfium_revision': '135b99861d0d898850754a845f607ec48f0bcccc',
+  'pdfium_revision': '32e693fe13105fab5baf81b334e932fce62d89b5',
   # Three lines of non-changing comments so that
   # the commit queue can handle CLs rolling openmax_dl
   # and whatever else without interference from each other.
@@ -88,7 +88,7 @@ vars = {
   # Three lines of non-changing comments so that
   # the commit queue can handle CLs rolling catapult
   # and whatever else without interference from each other.
-  'catapult_revision': '05755f0b45dad6bad16914ee87671253933d4669',
+  'catapult_revision': 'bc12d40e619c928c99b4109bdc29b473f441d1e1',
   # Three lines of non-changing comments so that
   # the commit queue can handle CLs rolling libFuzzer
   # and whatever else without interference from each other.
@@ -214,7 +214,7 @@ deps = {
    Var('chromium_git') + '/native_client/src/third_party/scons-2.0.1.git' + '@' + '1c1550e17fc26355d08627fbdec13d8291227067',
 
   'src/third_party/webrtc':
-    Var('chromium_git') + '/external/webrtc/trunk/webrtc.git' + '@' + '1462743480dd6979ff8fbcd3372f7bc3c197f9b4', # commit position 13652
+    Var('chromium_git') + '/external/webrtc/trunk/webrtc.git' + '@' + '518d267d7cf4c1076882c1a463f4ee6acb488e6b', # commit position 13633
 
   'src/third_party/openmax_dl':
     Var('chromium_git') + '/external/webrtc/deps/third_party/openmax.git' + '@' +  Var('openmax_dl_revision'),
diff --git a/android_webview/android_webview_test_apk.isolate b/android_webview/android_webview_test_apk.isolate
new file mode 100644
index 0000000..630854e
--- /dev/null
+++ b/android_webview/android_webview_test_apk.isolate
@@ -0,0 +1,28 @@
+# Copyright 2015 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+{
+  'includes': [
+    '../build/android/android.isolate',
+  ],
+  'variables': {
+    'command': [
+      '<(PRODUCT_DIR)/bin/run_android_webview_test_apk',
+      '--enable-platform-mode',
+      '-e', 'local',
+      '--logcat-output-dir', '${ISOLATED_OUTDIR}/logcats',
+    ],
+    'files': [
+      '../third_party/proguard/lib/proguard.jar',
+      '<(PRODUCT_DIR)/host_forwarder',
+      '<(PRODUCT_DIR)/forwarder_dist/',
+      '<(PRODUCT_DIR)/android_webview_test_apk/',
+      '<(PRODUCT_DIR)/apks/AndroidWebView.apk',
+      '<(PRODUCT_DIR)/apks/AndroidWebViewTest.apk',
+      '<(PRODUCT_DIR)/bin/run_android_webview_test_apk',
+      '<(PRODUCT_DIR)/test.lib.java/AndroidWebViewTest.jar',
+      'android_webview_test_data.isolate',
+      'test/data/',
+    ]
+  },
+}
diff --git a/android_webview/android_webview_test_data.isolate b/android_webview/android_webview_test_data.isolate
new file mode 100644
index 0000000..18a5825
--- /dev/null
+++ b/android_webview/android_webview_test_data.isolate
@@ -0,0 +1,10 @@
+# Copyright (c) 2014 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+{
+  'variables': {
+    'files': [
+      '<(DEPTH)/android_webview/test/data/',
+    ],
+  },
+}
diff --git a/android_webview/browser/aw_form_database_service.cc b/android_webview/browser/aw_form_database_service.cc
index 6096e37..6393f1b 100644
--- a/android_webview/browser/aw_form_database_service.cc
+++ b/android_webview/browser/aw_form_database_service.cc
@@ -18,8 +18,7 @@ namespace {
 
 // Callback to handle database error. It seems chrome uses this to
 // display an error dialog box only.
-void DatabaseErrorCallback(sql::InitStatus init_status,
-                           const std::string& diagnostics) {
+void DatabaseErrorCallback(sql::InitStatus status) {
   LOG(WARNING) << "initializing autocomplete database failed";
 }
 
diff --git a/android_webview/java/src/org/chromium/android_webview/AwContentViewClient.java b/android_webview/java/src/org/chromium/android_webview/AwContentViewClient.java
index b06de5e..8166bd6 100644
--- a/android_webview/java/src/org/chromium/android_webview/AwContentViewClient.java
+++ b/android_webview/java/src/org/chromium/android_webview/AwContentViewClient.java
@@ -6,16 +6,11 @@ package org.chromium.android_webview;
 
 import android.content.Context;
 import android.content.Intent;
-import android.view.Gravity;
 import android.view.KeyEvent;
 import android.view.View;
-import android.view.ViewGroup;
 import android.webkit.URLUtil;
 import android.webkit.WebChromeClient;
 import android.widget.FrameLayout;
-import android.widget.LinearLayout;
-import android.widget.ProgressBar;
-import android.widget.TextView;
 
 import org.chromium.content.browser.ContentVideoViewEmbedder;
 import org.chromium.content.browser.ContentViewClient;
@@ -29,7 +24,6 @@ public class AwContentViewClient extends ContentViewClient implements ContentVid
     private final AwContents mAwContents;
     private final Context mContext;
     private FrameLayout mCustomView;
-    private View mProgressView;
 
     public AwContentViewClient(AwContentsClient awContentsClient, AwSettings awSettings,
             AwContents awContents, Context context) {
@@ -80,40 +74,24 @@ public class AwContentViewClient extends ContentViewClient implements ContentVid
     }
 
     @Override
-    public void enterFullscreenVideo(View videoView, boolean isVideoLoaded) {
+    public void enterFullscreenVideo(View videoView) {
         if (mCustomView == null) {
             // enterFullscreenVideo will only be called after enterFullscreen, but
             // in this case exitFullscreen has been invoked in between them.
             // TODO(igsolla): Fix http://crbug/425926 and replace with assert.
             return;
         }
-
         mCustomView.addView(videoView, 0);
-
-        if (isVideoLoaded) return;
-
-        mProgressView = mAwContentsClient.getVideoLoadingProgressView();
-        if (mProgressView == null) {
-            mProgressView = new ProgressView(mContext);
-        }
-        mCustomView.addView(
-                mProgressView, new FrameLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT,
-                                       ViewGroup.LayoutParams.WRAP_CONTENT, Gravity.CENTER));
     }
 
     @Override
-    public void fullscreenVideoLoaded() {
-        if (mCustomView == null) return;
-
-        if (mProgressView != null) {
-            mCustomView.removeView(mProgressView);
-            mProgressView = null;
-        }
+    public void exitFullscreenVideo() {
+        // Intentional no-op
     }
 
     @Override
-    public void exitFullscreenVideo() {
-        // Intentional no-op
+    public View getVideoLoadingProgressView() {
+        return mAwContentsClient.getVideoLoadingProgressView();
     }
 
     @Override
@@ -170,7 +148,6 @@ public class AwContentViewClient extends ContentViewClient implements ContentVid
     public void exitFullscreen() {
         if (mCustomView != null) {
             mCustomView = null;
-            mProgressView = null;
             mAwContents.exitFullScreen();
             mAwContentsClient.onHideCustomView();
         }
@@ -180,25 +157,4 @@ public class AwContentViewClient extends ContentViewClient implements ContentVid
     public String getProductVersion() {
         return AwContentsStatics.getProductVersion();
     }
-
-    private static class ProgressView extends LinearLayout {
-        private final ProgressBar mProgressBar;
-        private final TextView mTextView;
-
-        public ProgressView(Context context) {
-            super(context);
-            setOrientation(LinearLayout.VERTICAL);
-            setLayoutParams(new LinearLayout.LayoutParams(LinearLayout.LayoutParams.WRAP_CONTENT,
-                    LinearLayout.LayoutParams.WRAP_CONTENT));
-            mProgressBar = new ProgressBar(context, null, android.R.attr.progressBarStyleLarge);
-            mTextView = new TextView(context);
-
-            String videoLoadingText = context.getString(
-                    org.chromium.android_webview.R.string.media_player_loading_video);
-
-            mTextView.setText(videoLoadingText);
-            addView(mProgressBar);
-            addView(mTextView);
-        }
-    }
 }
diff --git a/android_webview/java/strings/android_webview_strings.grd b/android_webview/java/strings/android_webview_strings.grd
index 24ab0b0..776812a 100644
--- a/android_webview/java/strings/android_webview_strings.grd
+++ b/android_webview/java/strings/android_webview_strings.grd
@@ -99,9 +99,6 @@
       <message name="IDS_LICENSE_ACTIVITY_TITLE" desc="The title of the activity that displays licenses of WebView. [CHAR-LIMIT=50]">
         System WebView licenses
       </message>
-      <message name="IDS_MEDIA_PLAYER_LOADING_VIDEO" desc="Text shown while a video is loading [CHAR-LIMIT=16]">
-        Loading video
-      </message>
     </messages>
   </release>
 </grit>
diff --git a/android_webview/javatests/src/org/chromium/android_webview/test/AwContentsClientGetVideoLoadingProgressViewTest.java b/android_webview/javatests/src/org/chromium/android_webview/test/AwContentsClientGetVideoLoadingProgressViewTest.java
index 5060d67..6275682 100644
--- a/android_webview/javatests/src/org/chromium/android_webview/test/AwContentsClientGetVideoLoadingProgressViewTest.java
+++ b/android_webview/javatests/src/org/chromium/android_webview/test/AwContentsClientGetVideoLoadingProgressViewTest.java
@@ -28,11 +28,9 @@ import java.util.concurrent.TimeoutException;
 public class AwContentsClientGetVideoLoadingProgressViewTest extends AwTestBase
         implements View.OnAttachStateChangeListener {
     private static final String VIDEO_TEST_URL =
-            "file:///android_asset/full_screen_video_test_not_preloaded.html";
-    // These values must be kept in sync with the element ids in the above file.
-    private static final String CUSTOM_PLAY_CONTROL_ID = "playControl";
+            "file:///android_asset/full_screen_video_test.html";
+    // This value must be kept in sync with the string in full_screen_video_test.html
     private static final String CUSTOM_FULLSCREEN_CONTROL_ID = "fullscreenControl";
-
     private CallbackHelper mViewAttachedCallbackHelper = new CallbackHelper();
 
     @Override
@@ -72,8 +70,6 @@ public class AwContentsClientGetVideoLoadingProgressViewTest extends AwTestBase
         loadUrlSync(awContents, contentsClient.getOnPageFinishedHelper(), VIDEO_TEST_URL);
         Thread.sleep(5 * 1000);
         DOMUtils.clickNode(this, awContents.getContentViewCore(), CUSTOM_FULLSCREEN_CONTROL_ID);
-        Thread.sleep(1 * 1000);
-        DOMUtils.clickNode(this, awContents.getContentViewCore(), CUSTOM_PLAY_CONTROL_ID);
         waitForViewAttached();
     }
 }
diff --git a/android_webview/javatests/src/org/chromium/android_webview/test/LoadDataWithBaseUrlTest.java b/android_webview/javatests/src/org/chromium/android_webview/test/LoadDataWithBaseUrlTest.java
index 09f5b97..60e8eb5 100644
--- a/android_webview/javatests/src/org/chromium/android_webview/test/LoadDataWithBaseUrlTest.java
+++ b/android_webview/javatests/src/org/chromium/android_webview/test/LoadDataWithBaseUrlTest.java
@@ -259,8 +259,8 @@ public class LoadDataWithBaseUrlTest extends AwTestBase {
             assertEquals(page2Title, getTitleOnUiThread(mAwContents));
 
             HistoryUtils.goBackSync(getInstrumentation(), mWebContents, onPageFinishedHelper);
-            // The title of first page loaded with loadDataWithBaseUrl.
-            assertEquals(page1Title, getTitleOnUiThread(mAwContents));
+            // The title of the 'about.html' specified via historyUrl.
+            assertEquals(CommonResources.ABOUT_TITLE, getTitleOnUiThread(mAwContents));
         } finally {
             webServer.shutdown();
         }
diff --git a/android_webview/system_webview_shell_layout_test_apk_run.isolate b/android_webview/system_webview_shell_layout_test_apk_run.isolate
new file mode 100644
index 0000000..b099a6b
--- /dev/null
+++ b/android_webview/system_webview_shell_layout_test_apk_run.isolate
@@ -0,0 +1,28 @@
+# Copyright 2016 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+{
+  'includes': [
+    '../build/android/android.isolate',
+  ],
+  'variables': {
+    'command': [
+      '<(PRODUCT_DIR)/bin/run_system_webview_shell_layout_test_apk',
+      '--enable-platform-mode',
+      '-e', 'local',
+      '--logcat-output-dir', '${ISOLATED_OUTDIR}/logcats',
+    ],
+    'files': [
+      '../third_party/proguard/lib/proguard.jar',
+      '<(PRODUCT_DIR)/host_forwarder',
+      '<(PRODUCT_DIR)/forwarder_dist/',
+      '<(PRODUCT_DIR)/apks/SystemWebView.apk',
+      '<(PRODUCT_DIR)/apks/SystemWebViewShell.apk',
+      '<(PRODUCT_DIR)/apks/SystemWebViewShellLayoutTest.apk',
+      '<(PRODUCT_DIR)/bin/run_system_webview_shell_layout_test_apk',
+      '<(PRODUCT_DIR)/test.lib.java/SystemWebViewShellLayoutTest.jar',
+      'system_webview_shell_test_apk.isolate',
+      'tools/WebViewShell/test/',
+    ]
+  },
+}
diff --git a/android_webview/system_webview_shell_test_apk.isolate b/android_webview/system_webview_shell_test_apk.isolate
new file mode 100644
index 0000000..dbea4bd
--- /dev/null
+++ b/android_webview/system_webview_shell_test_apk.isolate
@@ -0,0 +1,15 @@
+# Copyright 2015 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+
+{
+  'variables': {
+    'files': [
+      '<(DEPTH)/android_webview/tools/system_webview_shell/test/data/',
+      '<(DEPTH)/third_party/WebKit/LayoutTests/virtual/stable/webexposed/global-interface-listing-expected.txt',
+      '<(DEPTH)/third_party/WebKit/LayoutTests/webexposed/global-interface-listing.html',
+      '<(DEPTH)/third_party/WebKit/LayoutTests/webexposed/global-interface-listing-expected.txt',
+      '<(DEPTH)/third_party/WebKit/LayoutTests/webexposed/resources/global-interface-listing.js',
+    ],
+  },
+}
diff --git a/android_webview/test/BUILD.gn b/android_webview/test/BUILD.gn
index 7de9b0d..5a660f8 100644
--- a/android_webview/test/BUILD.gn
+++ b/android_webview/test/BUILD.gn
@@ -74,7 +74,6 @@ android_assets("android_webview_apk_assets") {
     "shell/assets/full_screen_video.js",
     "shell/assets/full_screen_video_inside_div_test.html",
     "shell/assets/full_screen_video_test.html",
-    "shell/assets/full_screen_video_test_not_preloaded.html",
     "shell/assets/multiple_videos_test.html",
     "shell/assets/platform-media-codec-test.html",
     "shell/assets/video.3gp",
@@ -206,9 +205,7 @@ instrumentation_test_apk("android_webview_test_apk") {
     "../javatests/src/org/chromium/android_webview/test/util/VideoTestUtil.java",
     "../javatests/src/org/chromium/android_webview/test/util/VideoTestWebServer.java",
   ]
-  data = [
-    "data/",
-  ]
+  isolate_file = "../android_webview_test_data.isolate"
   additional_apks = [ "//net/android:net_test_support_apk" ]
 }
 
diff --git a/android_webview/test/shell/assets/full_screen_video_test.html b/android_webview/test/shell/assets/full_screen_video_test.html
index f198bea..6d1979d 100644
--- a/android_webview/test/shell/assets/full_screen_video_test.html
+++ b/android_webview/test/shell/assets/full_screen_video_test.html
@@ -1,4 +1,5 @@
-<!-- NOTE: The ids in this file must be kept in sync with AwContentsClientFullScreenTest -->
+<!-- NOTE: The ids in this file must be kept in sync with AwContentsClientFullScreenTest
+     and AwContentsClientGetVideoLoadingProgressViewTest -->
 
 <html>
 <head>
diff --git a/android_webview/test/shell/assets/full_screen_video_test_not_preloaded.html b/android_webview/test/shell/assets/full_screen_video_test_not_preloaded.html
deleted file mode 100644
index 25c4c6d..0000000
--- a/android_webview/test/shell/assets/full_screen_video_test_not_preloaded.html
+++ /dev/null
@@ -1,15 +0,0 @@
-<!-- NOTE: The ids in this file must be kept in sync with
-     and AwContentsClientGetVideoLoadingProgressViewTest -->
-
-<html>
-<head>
-<script src="full_screen_video.js"></script>
-</head>
-<body>
-<button id="fullscreenControl" style ='padding:10px 10px;' onclick="goFullscreen('video'); return false">Go fullscreen</button>
-<button id="playControl" style='padding:10px 10px;' onclick="playVideo(); return false">Play</button>
-<video style = 'width: 10px; height: 10px;' id='video' controls preload="none">
-    <source src="video.webm" type="video/webm">
-</video>
-</body>
-</html>
diff --git a/android_webview/tools/cts_config/expected_failure_on_bot.json b/android_webview/tools/cts_config/expected_failure_on_bot.json
index 8c01789..1969d47 100644
--- a/android_webview/tools/cts_config/expected_failure_on_bot.json
+++ b/android_webview/tools/cts_config/expected_failure_on_bot.json
@@ -1,5 +1,5 @@
 {
-  "android.webkit.cts.WebViewTest": [
+  "android.webkit.cts.WebViewTest":[
     {
       "name": "testPageScroll",
       "_bug_id": "crbug.com/534643"
diff --git a/android_webview/tools/cts_config/webview_cts_gcs_path.json b/android_webview/tools/cts_config/webview_cts_gcs_path.json
deleted file mode 100644
index 721e35a..0000000
--- a/android_webview/tools/cts_config/webview_cts_gcs_path.json
+++ /dev/null
@@ -1,5 +0,0 @@
-{
-  "arm_64": {
-    "L": "arm_64/L/android-cts-arm_64-2780604.zip"
-  }
-}
diff --git a/android_webview/tools/cts_config/webview_cts_gcs_path.txt b/android_webview/tools/cts_config/webview_cts_gcs_path.txt
new file mode 100644
index 0000000..f434e69
--- /dev/null
+++ b/android_webview/tools/cts_config/webview_cts_gcs_path.txt
@@ -0,0 +1 @@
+android-cts-arm_64-2780604.zip
\ No newline at end of file
diff --git a/android_webview/tools/system_webview_shell/BUILD.gn b/android_webview/tools/system_webview_shell/BUILD.gn
index bba8c47..51d0484 100644
--- a/android_webview/tools/system_webview_shell/BUILD.gn
+++ b/android_webview/tools/system_webview_shell/BUILD.gn
@@ -70,16 +70,10 @@ instrumentation_test_apk("system_webview_shell_layout_test_apk") {
     "layout_tests/src/org/chromium/webview_shell/test/WebViewLayoutTestRunner.java",
     "layout_tests/src/org/chromium/webview_shell/test/WebViewThreadTest.java",
   ]
+  isolate_file = "../../system_webview_shell_test_apk.isolate"
   deps = [
     "//base:base_java",
     "//base:base_java_test_support",
     "//testing/android/reporter:reporter_java",
   ]
-  data = [
-    "test/data/",
-    "//third_party/WebKit/LayoutTests/virtual/stable/webexposed/global-interface-listing-expected.txt",
-    "//third_party/WebKit/LayoutTests/webexposed/global-interface-listing.html",
-    "//third_party/WebKit/LayoutTests/webexposed/global-interface-listing-expected.txt",
-    "//third_party/WebKit/LayoutTests/webexposed/resources/global-interface-listing.js",
-  ]
 }
diff --git a/ash/accelerators/accelerator_commands_aura.cc b/ash/accelerators/accelerator_commands_aura.cc
index 758f1a0..0c5bb98 100644
--- a/ash/accelerators/accelerator_commands_aura.cc
+++ b/ash/accelerators/accelerator_commands_aura.cc
@@ -4,7 +4,6 @@
 
 #include "ash/accelerators/accelerator_commands_aura.h"
 
-#include "ash/common/display/display_info.h"
 #include "ash/common/wm/window_state.h"
 #include "ash/common/wm_window.h"
 #include "ash/display/display_manager.h"
@@ -40,15 +39,15 @@ bool ZoomInternalDisplay(bool up) {
                            ? DisplayManager::kUnifiedDisplayId
                            : display_manager->GetDisplayIdForUIScaling();
   const DisplayInfo& display_info = display_manager->GetDisplayInfo(display_id);
+  DisplayMode mode;
 
-  scoped_refptr<DisplayMode> mode;
-  if (display_manager->IsInUnifiedMode())
-    mode = GetDisplayModeForNextResolution(display_info, up);
-  else
-    mode = GetDisplayModeForNextUIScale(display_info, up);
-
-  if (!mode)
-    return false;
+  if (display_manager->IsInUnifiedMode()) {
+    if (!GetDisplayModeForNextResolution(display_info, up, &mode))
+      return false;
+  } else {
+    if (!GetDisplayModeForNextUIScale(display_info, up, &mode))
+      return false;
+  }
   return display_manager->SetDisplayMode(display_id, mode);
 }
 
@@ -59,10 +58,10 @@ void ResetInternalDisplayZoom() {
   if (display_manager->IsInUnifiedMode()) {
     const DisplayInfo& display_info =
         display_manager->GetDisplayInfo(DisplayManager::kUnifiedDisplayId);
-    const DisplayInfo::DisplayModeList& modes = display_info.display_modes();
-    auto iter = std::find_if(
-        modes.begin(), modes.end(),
-        [](const scoped_refptr<DisplayMode>& mode) { return mode->native(); });
+    const std::vector<DisplayMode>& modes = display_info.display_modes();
+    auto iter =
+        std::find_if(modes.begin(), modes.end(),
+                     [](const DisplayMode& mode) { return mode.native; });
     display_manager->SetDisplayMode(DisplayManager::kUnifiedDisplayId, *iter);
   } else {
     SetDisplayUIScale(display_manager->GetDisplayIdForUIScaling(), 1.0f);
diff --git a/ash/app_list/app_list_presenter_delegate.cc b/ash/app_list/app_list_presenter_delegate.cc
index cefa086..3fca253 100644
--- a/ash/app_list/app_list_presenter_delegate.cc
+++ b/ash/app_list/app_list_presenter_delegate.cc
@@ -9,10 +9,7 @@
 #include "ash/common/shelf/shelf_types.h"
 #include "ash/common/shell_window_ids.h"
 #include "ash/common/wm/maximize_mode/maximize_mode_controller.h"
-#include "ash/common/wm/wm_screen_util.h"
-#include "ash/common/wm_lookup.h"
 #include "ash/common/wm_shell.h"
-#include "ash/common/wm_window.h"
 #include "ash/display/window_tree_host_manager.h"
 #include "ash/root_window_controller.h"
 #include "ash/screen_util.h"
@@ -81,10 +78,11 @@ gfx::Vector2d GetAnchorPositionOffsetToShelf(const gfx::Rect& button_bounds,
 // This calculation excludes the virtual keyboard area. If the height of the
 // display area is less than |minimum_height|, its bottom will be extended to
 // that height (so that the app list never starts above the top of the screen).
-gfx::Point GetCenterOfDisplayForView(views::View* view, int minimum_height) {
-  WmWindow* window = WmLookup::Get()->GetWindowForWidget(view->GetWidget());
-  gfx::Rect bounds = wm::GetDisplayBoundsWithShelf(window);
-  bounds = window->GetRootWindow()->ConvertRectToScreen(bounds);
+gfx::Point GetCenterOfDisplayForView(const views::View* view,
+                                     int minimum_height) {
+  aura::Window* window = view->GetWidget()->GetNativeView();
+  gfx::Rect bounds = ScreenUtil::GetShelfDisplayBoundsInRoot(window);
+  bounds = ScreenUtil::ConvertRectToScreen(window->GetRootWindow(), bounds);
 
   // If the virtual keyboard is active, subtract it from the display bounds, so
   // that the app list is centered in the non-keyboard area of the display.
diff --git a/ash/ash.gyp b/ash/ash.gyp
index 5f7aadd..7a336b0 100644
--- a/ash/ash.gyp
+++ b/ash/ash.gyp
@@ -71,25 +71,8 @@
       'common/default_accessibility_delegate.h',
       'common/display/display_info.cc',
       'common/display/display_info.h',
-      'common/drag_drop/drag_image_view.cc',
-      'common/drag_drop/drag_image_view.h',
       'common/focus_cycler.cc',
       'common/focus_cycler.h',
-      'common/frame/caption_buttons/caption_button_types.h',
-      'common/frame/caption_buttons/frame_caption_button.cc',
-      'common/frame/caption_buttons/frame_caption_button.h',
-      'common/frame/caption_buttons/frame_caption_button_container_view.cc',
-      'common/frame/caption_buttons/frame_caption_button_container_view.h',
-      'common/frame/caption_buttons/frame_size_button.cc',
-      'common/frame/caption_buttons/frame_size_button.h',
-      'common/frame/caption_buttons/frame_size_button_delegate.h',
-      'common/frame/default_header_painter.cc',
-      'common/frame/default_header_painter.h',
-      'common/frame/frame_border_hit_test.cc',
-      'common/frame/frame_border_hit_test.h',
-      'common/frame/header_painter.h',
-      'common/frame/header_painter_util.cc',
-      'common/frame/header_painter_util.h',
       'common/gpu_support.h',
       'common/gpu_support_stub.cc',
       'common/gpu_support_stub.h',
@@ -99,11 +82,9 @@
       'common/login_status.h',
       'common/material_design/material_design_controller.cc',
       'common/material_design/material_design_controller.h',
-      'common/metrics/gesture_action_type.h',
       'common/metrics/user_metrics_action.h',
       'common/multi_profile_uma.cc',
       'common/multi_profile_uma.h',
-      'common/palette_delegate.h',
       'common/pointer_watcher_delegate.h',
       'common/popup_message.cc',
       'common/popup_message.h',
@@ -508,7 +489,6 @@
       'common/wm_root_window_controller_observer.h',
       'common/wm_shell.cc',
       'common/wm_shell.h',
-      'common/wm_transient_window_observer.h',
       'common/wm_window.h',
       'common/wm_window_observer.h',
       'common/wm_window_property.h',
@@ -580,16 +560,31 @@
       'drag_drop/drag_drop_controller.h',
       'drag_drop/drag_drop_tracker.cc',
       'drag_drop/drag_drop_tracker.h',
+      'drag_drop/drag_image_view.cc',
+      'drag_drop/drag_image_view.h',
       'first_run/desktop_cleaner.cc',
       'first_run/desktop_cleaner.h',
       'first_run/first_run_helper.cc',
       'first_run/first_run_helper.h',
       'first_run/first_run_helper_impl.cc',
       'first_run/first_run_helper_impl.h',
+      'frame/caption_buttons/caption_button_types.h',
+      'frame/caption_buttons/frame_caption_button.cc',
+      'frame/caption_buttons/frame_caption_button.h',
+      'frame/caption_buttons/frame_caption_button_container_view.cc',
+      'frame/caption_buttons/frame_caption_button_container_view.h',
+      'frame/caption_buttons/frame_size_button.cc',
+      'frame/caption_buttons/frame_size_button.h',
+      'frame/caption_buttons/frame_size_button_delegate.h',
       'frame/custom_frame_view_ash.cc',
       'frame/custom_frame_view_ash.h',
+      'frame/default_header_painter.cc',
+      'frame/default_header_painter.h',
       'frame/frame_border_hit_test_controller.cc',
       'frame/frame_border_hit_test_controller.h',
+      'frame/header_painter.h',
+      'frame/header_painter_util.cc',
+      'frame/header_painter_util.h',
       'high_contrast/high_contrast_controller.cc',
       'high_contrast/high_contrast_controller.h',
       'host/ash_window_tree_host.cc',
@@ -924,8 +919,6 @@
       'autoclick/autoclick_unittest.cc',
       'common/accelerators/accelerator_table_unittest.cc',
       'common/display/display_info_unittest.cc',
-      'common/frame/caption_buttons/frame_caption_button_container_view_unittest.cc',
-      'common/frame/default_header_painter_unittest.cc',
       'common/material_design/material_design_controller_unittest.cc',
       'common/popup_message_unittest.cc',
       'common/shelf/shelf_background_animator_unittest.cc',
@@ -979,8 +972,10 @@
       'drag_drop/drag_drop_tracker_unittest.cc',
       'extended_desktop_unittest.cc',
       'focus_cycler_unittest.cc',
+      'frame/caption_buttons/frame_caption_button_container_view_unittest.cc',
       'frame/caption_buttons/frame_size_button_unittest.cc',
       'frame/custom_frame_view_ash_unittest.cc',
+      'frame/default_header_painter_unittest.cc',
       'host/ash_window_tree_host_x11_unittest.cc',
       'magnifier/magnification_controller_unittest.cc',
       'metrics/desktop_task_switch_metric_recorder_unittest.cc',
diff --git a/ash/aura/wm_shell_aura.cc b/ash/aura/wm_shell_aura.cc
index 66d5d94..6842682 100644
--- a/ash/aura/wm_shell_aura.cc
+++ b/ash/aura/wm_shell_aura.cc
@@ -19,7 +19,6 @@
 #include "ash/display/window_tree_host_manager.h"
 #include "ash/metrics/task_switch_metrics_recorder.h"
 #include "ash/shell.h"
-#include "ash/touch/touch_uma.h"
 #include "ash/wm/drag_window_resizer.h"
 #include "ash/wm/maximize_mode/maximize_mode_event_handler_aura.h"
 #include "ash/wm/screen_pinning_controller.h"
@@ -27,7 +26,6 @@
 #include "ash/wm/window_util.h"
 #include "base/memory/ptr_util.h"
 #include "ui/aura/client/focus_client.h"
-#include "ui/aura/env.h"
 #include "ui/wm/public/activation_client.h"
 
 #if defined(OS_CHROMEOS)
@@ -97,16 +95,6 @@ bool WmShellAura::IsActiveDisplayId(int64_t display_id) const {
   return Shell::GetInstance()->display_manager()->IsActiveDisplayId(display_id);
 }
 
-display::Display WmShellAura::GetFirstDisplay() const {
-  return Shell::GetInstance()
-      ->display_manager()
-      ->software_mirroring_display_list()[0];
-}
-
-bool WmShellAura::IsInUnifiedMode() const {
-  return Shell::GetInstance()->display_manager()->IsInUnifiedMode();
-}
-
 bool WmShellAura::IsForceMaximizeOnFirstRun() {
   return delegate()->IsForceMaximizeOnFirstRun();
 }
@@ -144,10 +132,6 @@ void WmShellAura::RecordUserMetricsAction(UserMetricsAction action) {
   Shell::GetInstance()->metrics()->RecordUserMetricsAction(action);
 }
 
-void WmShellAura::RecordGestureAction(GestureActionType action) {
-  TouchUMA::GetInstance()->RecordGestureAction(action);
-}
-
 void WmShellAura::RecordTaskSwitchMetric(TaskSwitchSource source) {
   Shell::GetInstance()->metrics()->task_switch_metrics_recorder().OnTaskSwitch(
       source);
@@ -230,10 +214,6 @@ void WmShellAura::RemovePointerWatcher(views::PointerWatcher* watcher) {
   Shell::GetInstance()->RemovePointerWatcher(watcher);
 }
 
-bool WmShellAura::IsTouchDown() {
-  return aura::Env::GetInstance()->is_touch_down();
-}
-
 #if defined(OS_CHROMEOS)
 void WmShellAura::ToggleIgnoreExternalKeyboard() {
   Shell::GetInstance()
diff --git a/ash/aura/wm_shell_aura.h b/ash/aura/wm_shell_aura.h
index d6257f2..afc5edc 100644
--- a/ash/aura/wm_shell_aura.h
+++ b/ash/aura/wm_shell_aura.h
@@ -35,8 +35,6 @@ class ASH_EXPORT WmShellAura : public WmShell,
   WmWindow* GetRootWindowForDisplayId(int64_t display_id) override;
   const DisplayInfo& GetDisplayInfo(int64_t display_id) const override;
   bool IsActiveDisplayId(int64_t display_id) const override;
-  display::Display GetFirstDisplay() const override;
-  bool IsInUnifiedMode() const override;
   bool IsForceMaximizeOnFirstRun() override;
   bool IsPinned() override;
   void SetPinnedWindow(WmWindow* window) override;
@@ -44,7 +42,6 @@ class ASH_EXPORT WmShellAura : public WmShell,
   void LockCursor() override;
   void UnlockCursor() override;
   std::vector<WmWindow*> GetAllRootWindows() override;
-  void RecordGestureAction(GestureActionType action) override;
   void RecordUserMetricsAction(UserMetricsAction action) override;
   void RecordTaskSwitchMetric(TaskSwitchSource source) override;
   void ShowContextMenu(const gfx::Point& location_in_screen,
@@ -67,7 +64,6 @@ class ASH_EXPORT WmShellAura : public WmShell,
   void RemoveDisplayObserver(WmDisplayObserver* observer) override;
   void AddPointerWatcher(views::PointerWatcher* watcher) override;
   void RemovePointerWatcher(views::PointerWatcher* watcher) override;
-  bool IsTouchDown() override;
 #if defined(OS_CHROMEOS)
   void ToggleIgnoreExternalKeyboard() override;
 #endif
diff --git a/ash/aura/wm_window_aura.cc b/ash/aura/wm_window_aura.cc
index eee6440..f6eda09 100644
--- a/ash/aura/wm_window_aura.cc
+++ b/ash/aura/wm_window_aura.cc
@@ -11,7 +11,6 @@
 #include "ash/common/shell_window_ids.h"
 #include "ash/common/wm/window_state.h"
 #include "ash/common/wm_layout_manager.h"
-#include "ash/common/wm_transient_window_observer.h"
 #include "ash/common/wm_window_observer.h"
 #include "ash/common/wm_window_property.h"
 #include "ash/screen_util.h"
@@ -36,10 +35,8 @@
 #include "ui/display/screen.h"
 #include "ui/gfx/geometry/insets.h"
 #include "ui/views/widget/widget.h"
-#include "ui/views/widget/widget_delegate.h"
 #include "ui/wm/core/coordinate_conversion.h"
 #include "ui/wm/core/easy_resize_window_targeter.h"
-#include "ui/wm/core/transient_window_manager.h"
 #include "ui/wm/core/visibility_controller.h"
 #include "ui/wm/core/window_util.h"
 
@@ -91,9 +88,6 @@ WmWindowAura::WmWindowAura(aura::Window* window)
 }
 
 WmWindowAura::~WmWindowAura() {
-  if (added_transient_observer_)
-    ::wm::TransientWindowManager::Get(window_)->RemoveObserver(this);
-
   window_->RemoveObserver(this);
 }
 
@@ -171,11 +165,6 @@ ui::wm::WindowType WmWindowAura::GetType() const {
   return window_->type();
 }
 
-bool WmWindowAura::IsBubble() {
-  views::Widget* widget = views::Widget::GetWidgetForNativeView(window_);
-  return widget->widget_delegate()->AsBubbleDialogDelegate() != nullptr;
-}
-
 ui::Layer* WmWindowAura::GetLayer() {
   return window_->layer();
 }
@@ -696,25 +685,6 @@ bool WmWindowAura::HasObserver(const WmWindowObserver* observer) const {
   return observers_.HasObserver(observer);
 }
 
-void WmWindowAura::AddTransientWindowObserver(
-    WmTransientWindowObserver* observer) {
-  if (!added_transient_observer_) {
-    added_transient_observer_ = true;
-    ::wm::TransientWindowManager::Get(window_)->AddObserver(this);
-  }
-  transient_observers_.AddObserver(observer);
-}
-
-void WmWindowAura::RemoveTransientWindowObserver(
-    WmTransientWindowObserver* observer) {
-  transient_observers_.RemoveObserver(observer);
-  if (added_transient_observer_ &&
-      !transient_observers_.might_have_observers()) {
-    added_transient_observer_ = false;
-    ::wm::TransientWindowManager::Get(window_)->RemoveObserver(this);
-  }
-}
-
 void WmWindowAura::AddLimitedPreTargetHandler(ui::EventHandler* handler) {
   // This behaves differently from WmWindowMus for child and embedded windows.
   window_->AddPreTargetHandler(handler);
@@ -807,16 +777,4 @@ void WmWindowAura::OnWindowTitleChanged(aura::Window* window) {
   FOR_EACH_OBSERVER(WmWindowObserver, observers_, OnWindowTitleChanged(this));
 }
 
-void WmWindowAura::OnTransientChildAdded(aura::Window* window,
-                                         aura::Window* transient) {
-  FOR_EACH_OBSERVER(WmTransientWindowObserver, transient_observers_,
-                    OnTransientChildAdded(this, Get(transient)));
-}
-
-void WmWindowAura::OnTransientChildRemoved(aura::Window* window,
-                                           aura::Window* transient) {
-  FOR_EACH_OBSERVER(WmTransientWindowObserver, transient_observers_,
-                    OnTransientChildRemoved(this, Get(transient)));
-}
-
 }  // namespace ash
diff --git a/ash/aura/wm_window_aura.h b/ash/aura/wm_window_aura.h
index 704b9c8..40b6fbe 100644
--- a/ash/aura/wm_window_aura.h
+++ b/ash/aura/wm_window_aura.h
@@ -10,14 +10,11 @@
 #include "base/macros.h"
 #include "base/observer_list.h"
 #include "ui/aura/window_observer.h"
-#include "ui/wm/core/transient_window_observer.h"
 
 namespace ash {
 
 // WmWindowAura is tied to the life of the underlying aura::Window.
-class ASH_EXPORT WmWindowAura : public WmWindow,
-                                public aura::WindowObserver,
-                                public ::wm::TransientWindowObserver {
+class ASH_EXPORT WmWindowAura : public WmWindow, public aura::WindowObserver {
  public:
   explicit WmWindowAura(aura::Window* window);
   // NOTE: this class is owned by the corresponding window. You shouldn't delete
@@ -56,7 +53,6 @@ class ASH_EXPORT WmWindowAura : public WmWindow,
   int GetShellWindowId() const override;
   WmWindow* GetChildByShellWindowId(int id) override;
   ui::wm::WindowType GetType() const override;
-  bool IsBubble() override;
   ui::Layer* GetLayer() override;
   display::Display GetDisplayNearestWindow() override;
   bool HasNonClientArea() override;
@@ -164,9 +160,6 @@ class ASH_EXPORT WmWindowAura : public WmWindow,
   void AddObserver(WmWindowObserver* observer) override;
   void RemoveObserver(WmWindowObserver* observer) override;
   bool HasObserver(const WmWindowObserver* observer) const override;
-  void AddTransientWindowObserver(WmTransientWindowObserver* observer) override;
-  void RemoveTransientWindowObserver(
-      WmTransientWindowObserver* observer) override;
   void AddLimitedPreTargetHandler(ui::EventHandler* handler) override;
   void RemoveLimitedPreTargetHandler(ui::EventHandler* handler) override;
 
@@ -187,19 +180,10 @@ class ASH_EXPORT WmWindowAura : public WmWindow,
   void OnWindowVisibilityChanged(aura::Window* window, bool visible) override;
   void OnWindowTitleChanged(aura::Window* window) override;
 
-  // ::wm::TransientWindowObserver overrides:
-  void OnTransientChildAdded(aura::Window* window,
-                             aura::Window* transient) override;
-  void OnTransientChildRemoved(aura::Window* window,
-                               aura::Window* transient) override;
-
   aura::Window* window_;
 
   base::ObserverList<WmWindowObserver> observers_;
 
-  bool added_transient_observer_ = false;
-  base::ObserverList<WmTransientWindowObserver> transient_observers_;
-
   DISALLOW_COPY_AND_ASSIGN(WmWindowAura);
 };
 
diff --git a/ash/common/display/display_info.cc b/ash/common/display/display_info.cc
index e9ca9a8..f130b7f 100644
--- a/ash/common/display/display_info.cc
+++ b/ash/common/display/display_info.cc
@@ -60,12 +60,11 @@ bool GetDisplayBounds(const std::string& spec,
 struct DisplayModeSorter {
   explicit DisplayModeSorter(bool is_internal) : is_internal(is_internal) {}
 
-  bool operator()(const scoped_refptr<DisplayMode>& a,
-                  const scoped_refptr<DisplayMode>& b) {
-    gfx::Size size_a_dip = a->GetSizeInDIP(is_internal);
-    gfx::Size size_b_dip = b->GetSizeInDIP(is_internal);
+  bool operator()(const DisplayMode& a, const DisplayMode& b) {
+    gfx::Size size_a_dip = a.GetSizeInDIP(is_internal);
+    gfx::Size size_b_dip = b.GetSizeInDIP(is_internal);
     if (size_a_dip.GetArea() == size_b_dip.GetArea())
-      return (a->refresh_rate() > b->refresh_rate());
+      return (a.refresh_rate > b.refresh_rate);
     return (size_a_dip.GetArea() < size_b_dip.GetArea());
   }
 
@@ -75,67 +74,41 @@ struct DisplayModeSorter {
 }  // namespace
 
 DisplayMode::DisplayMode()
-    : refresh_rate_(0.0f),
-      is_interlaced_(false),
-      native_(false),
-      ui_scale_(1.0f),
-      device_scale_factor_(1.0f) {}
-
-DisplayMode::DisplayMode(const gfx::Size& size)
-    : size_(size),
-      refresh_rate_(0.0f),
-      is_interlaced_(false),
-      native_(false),
-      ui_scale_(1.0f),
-      device_scale_factor_(1.0f) {}
+    : refresh_rate(0.0f),
+      interlaced(false),
+      native(false),
+      ui_scale(1.0f),
+      device_scale_factor(1.0f) {}
 
 DisplayMode::DisplayMode(const gfx::Size& size,
                          float refresh_rate,
-                         bool is_interlaced,
+                         bool interlaced,
                          bool native)
-    : size_(size),
-      refresh_rate_(refresh_rate),
-      is_interlaced_(is_interlaced),
-      native_(native),
-      ui_scale_(1.0f),
-      device_scale_factor_(1.0f) {}
-
-DisplayMode::~DisplayMode(){};
-
-DisplayMode::DisplayMode(const gfx::Size& size,
-                         float refresh_rate,
-                         bool is_interlaced,
-                         bool native,
-                         float ui_scale,
-                         float device_scale_factor)
-    : size_(size),
-      refresh_rate_(refresh_rate),
-      is_interlaced_(is_interlaced),
-      native_(native),
-      ui_scale_(ui_scale),
-      device_scale_factor_(device_scale_factor) {}
+    : size(size),
+      refresh_rate(refresh_rate),
+      interlaced(interlaced),
+      native(native),
+      ui_scale(1.0f),
+      device_scale_factor(1.0f) {}
 
 gfx::Size DisplayMode::GetSizeInDIP(bool is_internal) const {
-  gfx::SizeF size_dip(size_);
-  size_dip.Scale(ui_scale_);
+  gfx::SizeF size_dip(size);
+  size_dip.Scale(ui_scale);
   // DSF=1.25 is special on internal display. The screen is drawn with DSF=1.25
   // but it doesn't affect the screen size computation.
-  if (use_125_dsf_for_ui_scaling && is_internal &&
-      device_scale_factor_ == 1.25f)
+  if (use_125_dsf_for_ui_scaling && is_internal && device_scale_factor == 1.25f)
     return gfx::ToFlooredSize(size_dip);
-  size_dip.Scale(1.0f / device_scale_factor_);
+  size_dip.Scale(1.0f / device_scale_factor);
   return gfx::ToFlooredSize(size_dip);
 }
 
-bool DisplayMode::IsEquivalent(const scoped_refptr<DisplayMode>& other) const {
+bool DisplayMode::IsEquivalent(const DisplayMode& other) const {
   const float kEpsilon = 0.0001f;
-  return size_ == other->size_ &&
-         std::abs(ui_scale_ - other->ui_scale_) < kEpsilon &&
-         std::abs(device_scale_factor_ - other->device_scale_factor_) <
-             kEpsilon;
+  return size == other.size && std::abs(ui_scale - other.ui_scale) < kEpsilon &&
+         std::abs(device_scale_factor - other.device_scale_factor) < kEpsilon;
 }
 
-// static
+// satic
 DisplayInfo DisplayInfo::CreateFromSpec(const std::string& spec) {
   return CreateFromSpecWithID(spec, display::Display::kInvalidDisplayID);
 }
@@ -202,7 +175,7 @@ DisplayInfo DisplayInfo::CreateFromSpecWithID(const std::string& spec,
 #endif
   }
 
-  DisplayModeList display_modes;
+  std::vector<DisplayMode> display_modes;
   parts = base::SplitString(main_spec, "#", base::KEEP_WHITESPACE,
                             base::SPLIT_WANT_NONEMPTY);
   if (parts.size() == 2) {
@@ -214,33 +187,26 @@ DisplayInfo DisplayInfo::CreateFromSpecWithID(const std::string& spec,
     parts = base::SplitString(resolution_list, "|", base::KEEP_WHITESPACE,
                               base::SPLIT_WANT_NONEMPTY);
     for (size_t i = 0; i < parts.size(); ++i) {
-      gfx::Size size;
-      float refresh_rate = 0.0f;
-      bool is_interlaced = false;
-
+      DisplayMode mode;
       gfx::Rect mode_bounds;
       std::vector<std::string> resolution = base::SplitString(
           parts[i], "%", base::KEEP_WHITESPACE, base::SPLIT_WANT_NONEMPTY);
-      if (GetDisplayBounds(resolution[0], &mode_bounds, &device_scale_factor)) {
-        size = mode_bounds.size();
+      if (GetDisplayBounds(resolution[0], &mode_bounds,
+                           &mode.device_scale_factor)) {
+        mode.size = mode_bounds.size();
         if (resolution.size() > 1)
-          sscanf(resolution[1].c_str(), "%f", &refresh_rate);
-        if (size.GetArea() >= largest_area &&
-            refresh_rate > highest_refresh_rate) {
+          sscanf(resolution[1].c_str(), "%f", &mode.refresh_rate);
+        if (mode.size.GetArea() >= largest_area &&
+            mode.refresh_rate > highest_refresh_rate) {
           // Use mode with largest area and highest refresh rate as native.
-          largest_area = size.GetArea();
-          highest_refresh_rate = refresh_rate;
+          largest_area = mode.size.GetArea();
+          highest_refresh_rate = mode.refresh_rate;
           native_mode = i;
         }
-        display_modes.push_back(make_scoped_refptr(
-            new DisplayMode(size, refresh_rate, is_interlaced, false, 1.0,
-                            device_scale_factor)));
+        display_modes.push_back(mode);
       }
     }
-    scoped_refptr<DisplayMode> dm = display_modes[native_mode];
-    display_modes[native_mode] =
-        new DisplayMode(dm->size(), dm->refresh_rate(), dm->is_interlaced(),
-                        true, dm->ui_scale(), dm->device_scale_factor());
+    display_modes[native_mode].native = true;
   }
 
   if (id == display::Display::kInvalidDisplayID)
@@ -406,7 +372,8 @@ gfx::Insets DisplayInfo::GetOverscanInsetsInPixel() const {
   return overscan_insets_in_dip_.Scale(device_scale_factor_);
 }
 
-void DisplayInfo::SetDisplayModes(const DisplayModeList& display_modes) {
+void DisplayInfo::SetDisplayModes(
+    const std::vector<DisplayMode>& display_modes) {
   display_modes_ = display_modes;
   std::sort(display_modes_.begin(), display_modes_.end(),
             DisplayModeSorter(display::Display::IsInternalDisplayId(id_)));
@@ -414,9 +381,10 @@ void DisplayInfo::SetDisplayModes(const DisplayModeList& display_modes) {
 
 gfx::Size DisplayInfo::GetNativeModeSize() const {
   for (size_t i = 0; i < display_modes_.size(); ++i) {
-    if (display_modes_[i]->native())
-      return display_modes_[i]->size();
+    if (display_modes_[i].native)
+      return display_modes_[i].size;
   }
+
   return gfx::Size();
 }
 
@@ -450,15 +418,14 @@ std::string DisplayInfo::ToString() const {
 
 std::string DisplayInfo::ToFullString() const {
   std::string display_modes_str;
-  DisplayModeList::const_iterator iter = display_modes_.begin();
+  std::vector<DisplayMode>::const_iterator iter = display_modes_.begin();
   for (; iter != display_modes_.end(); ++iter) {
-    scoped_refptr<DisplayMode> m(*iter);
     if (!display_modes_str.empty())
       display_modes_str += ",";
-    base::StringAppendF(&display_modes_str, "(%dx%d@%f%c%s)", m->size().width(),
-                        m->size().height(), m->refresh_rate(),
-                        m->is_interlaced() ? 'I' : 'P',
-                        m->native() ? "(N)" : "");
+    base::StringAppendF(&display_modes_str, "(%dx%d@%f%c%s)",
+                        iter->size.width(), iter->size.height(),
+                        iter->refresh_rate, iter->interlaced ? 'I' : 'P',
+                        iter->native ? "(N)" : "");
   }
   return ToString() + ", display_modes==" + display_modes_str;
 }
diff --git a/ash/common/display/display_info.h b/ash/common/display/display_info.h
index c92f0a3..0df3ec6 100644
--- a/ash/common/display/display_info.h
+++ b/ash/common/display/display_info.h
@@ -13,7 +13,6 @@
 
 #include "ash/ash_export.h"
 #include "base/files/file_path.h"
-#include "base/memory/ref_counted.h"
 #include "ui/display/display.h"
 #include "ui/display/types/display_constants.h"
 #include "ui/gfx/geometry/insets.h"
@@ -21,52 +20,26 @@
 
 namespace ash {
 
-// A class that represents the display's mode info.
-class ASH_EXPORT DisplayMode : public base::RefCounted<DisplayMode> {
- public:
+// A struct that represents the display's mode info.
+struct ASH_EXPORT DisplayMode {
   DisplayMode();
-
-  DisplayMode(const gfx::Size& size);
-
   DisplayMode(const gfx::Size& size,
               float refresh_rate,
-              bool is_interlaced,
+              bool interlaced,
               bool native);
 
-  DisplayMode(const gfx::Size& size,
-              float refresh_rate,
-              bool is_interlaced,
-              bool native,
-              float ui_scale,
-              float device_scale_factor);
   // Returns the size in DIP which is visible to the user.
   gfx::Size GetSizeInDIP(bool is_internal) const;
 
   // Returns true if |other| has same size and scale factors.
-  bool IsEquivalent(const scoped_refptr<DisplayMode>& other) const;
-
-  const gfx::Size& size() const { return size_; }
-  bool is_interlaced() const { return is_interlaced_; }
-  float refresh_rate() const { return refresh_rate_; }
-
-  bool native() const { return native_; }
-
-  // Missing from ui::DisplayMode
-  float ui_scale() const { return ui_scale_; }
-  float device_scale_factor() const { return device_scale_factor_; }
-
- private:
-  ~DisplayMode();
-  friend class base::RefCounted<DisplayMode>;
-
-  gfx::Size size_;             // Physical pixel size of the display.
-  float refresh_rate_;         // Refresh rate of the display, in Hz.
-  bool is_interlaced_;         // True if mode is interlaced.
-  bool native_;                // True if mode is native mode of the display.
-  float ui_scale_;             // The UI scale factor of the mode.
-  float device_scale_factor_;  // The device scale factor of the mode.
-
-  DISALLOW_COPY_AND_ASSIGN(DisplayMode);
+  bool IsEquivalent(const DisplayMode& other) const;
+
+  gfx::Size size;             // Physical pixel size of the display.
+  float refresh_rate;         // Refresh rate of the display, in Hz.
+  bool interlaced;            // True if mode is interlaced.
+  bool native;                // True if mode is native mode of the display.
+  float ui_scale;             // The UI scale factor of the mode.
+  float device_scale_factor;  // The device scale factor of the mode.
 };
 
 // DisplayInfo contains metadata for each display. This is used to
@@ -75,8 +48,6 @@ class ASH_EXPORT DisplayMode : public base::RefCounted<DisplayMode> {
 // This class is intentionally made copiable.
 class ASH_EXPORT DisplayInfo {
  public:
-  using DisplayModeList = std::vector<scoped_refptr<DisplayMode>>;
-
   // Creates a DisplayInfo from string spec. 100+200-1440x800 creates display
   // whose size is 1440x800 at the location (100, 200) in host coordinates.
   // The format is
@@ -236,10 +207,12 @@ class ASH_EXPORT DisplayInfo {
   void set_native(bool native) { native_ = native; }
   bool native() const { return native_; }
 
-  const DisplayModeList& display_modes() const { return display_modes_; }
+  const std::vector<DisplayMode>& display_modes() const {
+    return display_modes_;
+  }
   // Sets the display mode list. The mode list will be sorted for the
   // display.
-  void SetDisplayModes(const DisplayModeList& display_modes);
+  void SetDisplayModes(const std::vector<DisplayMode>& display_modes);
 
   // Returns the native mode size. If a native mode is not present, return an
   // empty size.
@@ -340,7 +313,7 @@ class ASH_EXPORT DisplayInfo {
   bool clear_overscan_insets_;
 
   // The list of modes supported by this display.
-  DisplayModeList display_modes_;
+  std::vector<DisplayMode> display_modes_;
 
   // The current profile of the color calibration.
   ui::ColorCalibrationProfile color_profile_;
diff --git a/ash/common/display/display_info_unittest.cc b/ash/common/display/display_info_unittest.cc
index 2cbaaa2..9f1cb43 100644
--- a/ash/common/display/display_info_unittest.cc
+++ b/ash/common/display/display_info_unittest.cc
@@ -13,10 +13,11 @@ std::string GetModeSizeInDIP(const gfx::Size& size,
                              float device_scale_factor,
                              float ui_scale,
                              bool is_internal) {
-  scoped_refptr<DisplayMode> mode =
-      new DisplayMode(size, 0.0 /* refresh_rate */, false /* interlaced */,
-                      false /* native */, ui_scale, device_scale_factor);
-  return mode->GetSizeInDIP(is_internal).ToString();
+  DisplayMode mode;
+  mode.size = size;
+  mode.device_scale_factor = device_scale_factor;
+  mode.ui_scale = ui_scale;
+  return mode.GetSizeInDIP(is_internal).ToString();
 }
 
 }  // namespace
@@ -62,29 +63,29 @@ TEST_F(DisplayInfoTest, CreateFromSpec) {
   EXPECT_EQ("0,0 200x200", info.bounds_in_native().ToString());
   EXPECT_EQ(5u, info.display_modes().size());
   // Modes are sorted in DIP for external display.
-  EXPECT_EQ("150x100", info.display_modes()[0]->size().ToString());
-  EXPECT_EQ("100x100", info.display_modes()[1]->size().ToString());
-  EXPECT_EQ("150x150", info.display_modes()[2]->size().ToString());
-  EXPECT_EQ("200x200", info.display_modes()[3]->size().ToString());
-  EXPECT_EQ("300x200", info.display_modes()[4]->size().ToString());
-
-  EXPECT_EQ(0.0f, info.display_modes()[0]->refresh_rate());
-  EXPECT_EQ(60.0f, info.display_modes()[1]->refresh_rate());
-  EXPECT_EQ(30.0f, info.display_modes()[2]->refresh_rate());
-  EXPECT_EQ(59.9f, info.display_modes()[3]->refresh_rate());
-  EXPECT_EQ(0.0f, info.display_modes()[4]->refresh_rate());
-
-  EXPECT_EQ(2.0f, info.display_modes()[0]->device_scale_factor());
-  EXPECT_EQ(1.0f, info.display_modes()[1]->device_scale_factor());
-  EXPECT_EQ(1.25f, info.display_modes()[2]->device_scale_factor());
-  EXPECT_EQ(1.0f, info.display_modes()[3]->device_scale_factor());
-  EXPECT_EQ(1.0f, info.display_modes()[4]->device_scale_factor());
-
-  EXPECT_FALSE(info.display_modes()[0]->native());
-  EXPECT_FALSE(info.display_modes()[1]->native());
-  EXPECT_FALSE(info.display_modes()[2]->native());
-  EXPECT_FALSE(info.display_modes()[3]->native());
-  EXPECT_TRUE(info.display_modes()[4]->native());
+  EXPECT_EQ("150x100", info.display_modes()[0].size.ToString());
+  EXPECT_EQ("100x100", info.display_modes()[1].size.ToString());
+  EXPECT_EQ("150x150", info.display_modes()[2].size.ToString());
+  EXPECT_EQ("200x200", info.display_modes()[3].size.ToString());
+  EXPECT_EQ("300x200", info.display_modes()[4].size.ToString());
+
+  EXPECT_EQ(0.0f, info.display_modes()[0].refresh_rate);
+  EXPECT_EQ(60.0f, info.display_modes()[1].refresh_rate);
+  EXPECT_EQ(30.0f, info.display_modes()[2].refresh_rate);
+  EXPECT_EQ(59.9f, info.display_modes()[3].refresh_rate);
+  EXPECT_EQ(0.0f, info.display_modes()[4].refresh_rate);
+
+  EXPECT_EQ(2.0f, info.display_modes()[0].device_scale_factor);
+  EXPECT_EQ(1.0f, info.display_modes()[1].device_scale_factor);
+  EXPECT_EQ(1.25f, info.display_modes()[2].device_scale_factor);
+  EXPECT_EQ(1.0f, info.display_modes()[3].device_scale_factor);
+  EXPECT_EQ(1.0f, info.display_modes()[4].device_scale_factor);
+
+  EXPECT_FALSE(info.display_modes()[0].native);
+  EXPECT_FALSE(info.display_modes()[1].native);
+  EXPECT_FALSE(info.display_modes()[2].native);
+  EXPECT_FALSE(info.display_modes()[3].native);
+  EXPECT_TRUE(info.display_modes()[4].native);
 }
 
 TEST_F(DisplayInfoTest, DisplayModeGetSizeInDIPNormal) {
diff --git a/ash/common/drag_drop/OWNERS b/ash/common/drag_drop/OWNERS
deleted file mode 100644
index d231d19..0000000
--- a/ash/common/drag_drop/OWNERS
+++ /dev/null
@@ -1 +0,0 @@
-mfomitchev@chromium.org
diff --git a/ash/common/drag_drop/drag_image_view.cc b/ash/common/drag_drop/drag_image_view.cc
deleted file mode 100644
index 9b5ac61..0000000
--- a/ash/common/drag_drop/drag_image_view.cc
+++ /dev/null
@@ -1,189 +0,0 @@
-// Copyright (c) 2012 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ash/common/drag_drop/drag_image_view.h"
-
-#include <memory>
-
-#include "ash/common/shell_window_ids.h"
-#include "ash/common/wm_lookup.h"
-#include "ash/common/wm_root_window_controller.h"
-#include "ash/common/wm_window.h"
-#include "skia/ext/image_operations.h"
-#include "ui/base/resource/resource_bundle.h"
-#include "ui/display/display.h"
-#include "ui/gfx/canvas.h"
-#include "ui/resources/grit/ui_resources.h"
-#include "ui/views/widget/widget.h"
-
-namespace ash {
-namespace {
-using views::Widget;
-
-std::unique_ptr<Widget> CreateDragWidget(WmWindow* root_window) {
-  std::unique_ptr<Widget> drag_widget(new Widget);
-  Widget::InitParams params;
-  params.type = Widget::InitParams::TYPE_TOOLTIP;
-  params.name = "DragWidget";
-  params.keep_on_top = true;
-  params.accept_events = false;
-  params.ownership = Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET;
-  params.shadow_type = Widget::InitParams::SHADOW_TYPE_NONE;
-  params.opacity = Widget::InitParams::TRANSLUCENT_WINDOW;
-  root_window->GetRootWindowController()->ConfigureWidgetInitParamsForContainer(
-      drag_widget.get(), kShellWindowId_DragImageAndTooltipContainer, &params);
-  drag_widget->Init(params);
-  drag_widget->SetOpacity(1.f);
-  return drag_widget;
-}
-
-}  // namespace
-
-DragImageView::DragImageView(WmWindow* root_window,
-                             ui::DragDropTypes::DragEventSource event_source)
-    : drag_event_source_(event_source),
-      touch_drag_operation_(ui::DragDropTypes::DRAG_NONE) {
-  DCHECK(root_window);
-  widget_ = CreateDragWidget(root_window);
-  widget_->SetContentsView(this);
-  widget_->SetAlwaysOnTop(true);
-
-  // We are owned by the DragDropController.
-  set_owned_by_client();
-}
-
-DragImageView::~DragImageView() {
-  widget_->Hide();
-}
-
-void DragImageView::SetBoundsInScreen(const gfx::Rect& bounds) {
-  widget_->SetBounds(bounds);
-  widget_size_ = bounds.size();
-}
-
-void DragImageView::SetScreenPosition(const gfx::Point& position) {
-  widget_->SetBounds(gfx::Rect(position, widget_size_));
-}
-
-gfx::Rect DragImageView::GetBoundsInScreen() const {
-  return widget_->GetWindowBoundsInScreen();
-}
-
-void DragImageView::SetWidgetVisible(bool visible) {
-  if (visible != widget_->IsVisible()) {
-    if (visible)
-      widget_->Show();
-    else
-      widget_->Hide();
-  }
-}
-
-void DragImageView::SetTouchDragOperationHintOff() {
-  // Simply set the drag type to non-touch so that no hint is drawn.
-  drag_event_source_ = ui::DragDropTypes::DRAG_EVENT_SOURCE_MOUSE;
-  SchedulePaint();
-}
-
-void DragImageView::SetTouchDragOperation(int operation) {
-  if (touch_drag_operation_ == operation)
-    return;
-  touch_drag_operation_ = operation;
-  SchedulePaint();
-}
-
-void DragImageView::SetTouchDragOperationHintPosition(
-    const gfx::Point& position) {
-  if (touch_drag_operation_indicator_position_ == position)
-    return;
-  touch_drag_operation_indicator_position_ = position;
-  SchedulePaint();
-}
-
-void DragImageView::SetOpacity(float visibility) {
-  DCHECK_GE(visibility, 0.0f);
-  DCHECK_LE(visibility, 1.0f);
-  widget_->SetOpacity(visibility);
-}
-
-void DragImageView::OnPaint(gfx::Canvas* canvas) {
-  if (GetImage().isNull())
-    return;
-
-  // |widget_size_| is in DIP. ImageSkia::size() also returns the size in DIP.
-  if (GetImage().size() == widget_size_) {
-    canvas->DrawImageInt(GetImage(), 0, 0);
-  } else {
-    WmWindow* window = WmLookup::Get()->GetWindowForWidget(widget_.get());
-    const float device_scale =
-        window->GetDisplayNearestWindow().device_scale_factor();
-    // The drag image already has device scale factor applied. But
-    // |widget_size_| is in DIP units.
-    gfx::Size scaled_widget_size =
-        gfx::ScaleToRoundedSize(widget_size_, device_scale);
-    gfx::ImageSkiaRep image_rep = GetImage().GetRepresentation(device_scale);
-    if (image_rep.is_null())
-      return;
-    SkBitmap scaled = skia::ImageOperations::Resize(
-        image_rep.sk_bitmap(), skia::ImageOperations::RESIZE_LANCZOS3,
-        scaled_widget_size.width(), scaled_widget_size.height());
-    gfx::ImageSkia image_skia(gfx::ImageSkiaRep(scaled, device_scale));
-    canvas->DrawImageInt(image_skia, 0, 0);
-  }
-
-  if (drag_event_source_ != ui::DragDropTypes::DRAG_EVENT_SOURCE_TOUCH)
-    return;
-
-  gfx::Image* drag_hint = DragHint();
-  if (drag_hint->IsEmpty())
-    return;
-
-  // Make sure drag hint image is positioned within the widget.
-  gfx::Size drag_hint_size = drag_hint->Size();
-  gfx::Point drag_hint_position = touch_drag_operation_indicator_position_;
-  drag_hint_position.Offset(-drag_hint_size.width() / 2, 0);
-  gfx::Rect drag_hint_bounds(drag_hint_position, drag_hint_size);
-  drag_hint_bounds.AdjustToFit(gfx::Rect(widget_size_));
-
-  // Draw image.
-  canvas->DrawImageInt(*(drag_hint->ToImageSkia()), drag_hint_bounds.x(),
-                       drag_hint_bounds.y());
-}
-
-gfx::Image* DragImageView::DragHint() const {
-  // Select appropriate drag hint.
-  gfx::Image* drag_hint =
-      &ui::ResourceBundle::GetSharedInstance().GetImageNamed(
-          IDR_TOUCH_DRAG_TIP_NODROP);
-  if (touch_drag_operation_ & ui::DragDropTypes::DRAG_COPY) {
-    drag_hint = &ui::ResourceBundle::GetSharedInstance().GetImageNamed(
-        IDR_TOUCH_DRAG_TIP_COPY);
-  } else if (touch_drag_operation_ & ui::DragDropTypes::DRAG_MOVE) {
-    drag_hint = &ui::ResourceBundle::GetSharedInstance().GetImageNamed(
-        IDR_TOUCH_DRAG_TIP_MOVE);
-  } else if (touch_drag_operation_ & ui::DragDropTypes::DRAG_LINK) {
-    drag_hint = &ui::ResourceBundle::GetSharedInstance().GetImageNamed(
-        IDR_TOUCH_DRAG_TIP_LINK);
-  }
-  return drag_hint;
-}
-
-void DragImageView::Layout() {
-  View::Layout();
-
-  gfx::Image* drag_hint = DragHint();
-  if (drag_hint->IsEmpty())
-    return;
-
-  gfx::Size drag_hint_size = drag_hint->Size();
-
-  // Enlarge widget if required to fit the drag hint image.
-  if (drag_hint_size.width() > widget_size_.width() ||
-      drag_hint_size.height() > widget_size_.height()) {
-    gfx::Size new_widget_size = widget_size_;
-    new_widget_size.SetToMax(drag_hint_size);
-    widget_->SetSize(new_widget_size);
-  }
-}
-
-}  // namespace ash
diff --git a/ash/common/drag_drop/drag_image_view.h b/ash/common/drag_drop/drag_image_view.h
deleted file mode 100644
index 63b972e..0000000
--- a/ash/common/drag_drop/drag_image_view.h
+++ /dev/null
@@ -1,93 +0,0 @@
-// Copyright (c) 2012 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_DRAG_DROP_DRAG_IMAGE_VIEW_H_
-#define ASH_COMMON_DRAG_DROP_DRAG_IMAGE_VIEW_H_
-
-#include <memory>
-
-#include "base/macros.h"
-#include "ui/base/dragdrop/drag_drop_types.h"
-#include "ui/gfx/geometry/point.h"
-#include "ui/gfx/geometry/size.h"
-#include "ui/views/controls/image_view.h"
-
-namespace gfx {
-class Image;
-}
-
-namespace views {
-class Widget;
-}
-
-namespace ash {
-
-class WmWindow;
-
-// This class allows to show a (native) view always on top of everything. It
-// does this by creating a widget and setting the content as the given view. The
-// caller can then use this object to freely move / drag it around on the
-// desktop in screen coordinates.
-class DragImageView : public views::ImageView {
- public:
-  // |root_window| is the root window on which to create the drag image widget.
-  // |source| is the event source that started this drag drop operation (touch
-  // or mouse). It is used to determine attributes of the drag image such as
-  // whether to show drag operation hint on top of the image.
-  DragImageView(WmWindow* root_window,
-                ui::DragDropTypes::DragEventSource source);
-  ~DragImageView() override;
-
-  // Sets the bounds of the native widget in screen
-  // coordinates.
-  // TODO(oshima): Looks like this is root window's
-  // coordinate. Change this to screen's coordinate.
-  void SetBoundsInScreen(const gfx::Rect& bounds);
-
-  // Sets the position of the native widget.
-  void SetScreenPosition(const gfx::Point& position);
-
-  // Gets the image position in screen coordinates.
-  gfx::Rect GetBoundsInScreen() const;
-
-  // Sets the visibility of the native widget.
-  void SetWidgetVisible(bool visible);
-
-  // For touch drag drop, we show a hint corresponding to the drag operation
-  // (since no mouse cursor is visible). These functions set the hint
-  // parameters.
-  void SetTouchDragOperationHintOff();
-
-  // |operation| is a bit field indicating allowable drag operations from
-  // ui::DragDropTypes::DragOperation.
-  void SetTouchDragOperation(int operation);
-  void SetTouchDragOperationHintPosition(const gfx::Point& position);
-
-  // Sets the |opacity| of the image view between 0.0 and 1.0.
-  void SetOpacity(float opacity);
-
- private:
-  gfx::Image* DragHint() const;
-
-  // Overridden from views::ImageView.
-  void OnPaint(gfx::Canvas* canvas) override;
-
-  // Overridden from views::view
-  void Layout() override;
-
-  std::unique_ptr<views::Widget> widget_;
-  gfx::Size widget_size_;
-
-  ui::DragDropTypes::DragEventSource drag_event_source_;
-
-  // Bitmask of ui::DragDropTypes::DragOperation values.
-  int touch_drag_operation_;
-  gfx::Point touch_drag_operation_indicator_position_;
-
-  DISALLOW_COPY_AND_ASSIGN(DragImageView);
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_DRAG_DROP_DRAG_IMAGE_VIEW_H_
diff --git a/ash/common/frame/OWNERS b/ash/common/frame/OWNERS
deleted file mode 100644
index e710530..0000000
--- a/ash/common/frame/OWNERS
+++ /dev/null
@@ -1 +0,0 @@
-pkotwicz@chromium.org
diff --git a/ash/common/frame/caption_buttons/caption_button_types.h b/ash/common/frame/caption_buttons/caption_button_types.h
deleted file mode 100644
index ca067be..0000000
--- a/ash/common/frame/caption_buttons/caption_button_types.h
+++ /dev/null
@@ -1,25 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_FRAME_CAPTION_BUTTONS_CAPTION_BUTTON_TYPES_H_
-#define ASH_COMMON_FRAME_CAPTION_BUTTONS_CAPTION_BUTTON_TYPES_H_
-
-namespace ash {
-
-// These are the icon types that a caption button can have. The size button's
-// action (SnapType) can be different from its icon.
-enum CaptionButtonIcon {
-  CAPTION_BUTTON_ICON_MINIMIZE,
-  CAPTION_BUTTON_ICON_MAXIMIZE_RESTORE,
-  CAPTION_BUTTON_ICON_CLOSE,
-  CAPTION_BUTTON_ICON_LEFT_SNAPPED,
-  CAPTION_BUTTON_ICON_RIGHT_SNAPPED,
-  CAPTION_BUTTON_ICON_BACK,
-  CAPTION_BUTTON_ICON_LOCATION,
-  CAPTION_BUTTON_ICON_COUNT
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_FRAME_CAPTION_BUTTONS_CAPTION_BUTTON_TYPES_H_
diff --git a/ash/common/frame/caption_buttons/frame_caption_button.cc b/ash/common/frame/caption_buttons/frame_caption_button.cc
deleted file mode 100644
index eaf494c..0000000
--- a/ash/common/frame/caption_buttons/frame_caption_button.cc
+++ /dev/null
@@ -1,189 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ash/common/frame/caption_buttons/frame_caption_button.h"
-
-#include "ui/gfx/animation/slide_animation.h"
-#include "ui/gfx/animation/throb_animation.h"
-#include "ui/gfx/canvas.h"
-#include "ui/gfx/color_palette.h"
-#include "ui/gfx/paint_vector_icon.h"
-#include "ui/gfx/vector_icons_public.h"
-
-namespace ash {
-
-namespace {
-
-// The duration of the crossfade animation when swapping the button's images.
-const int kSwapImagesAnimationDurationMs = 200;
-
-// The duration of the fade out animation of the old icon during a crossfade
-// animation as a ratio of |kSwapImagesAnimationDurationMs|.
-const float kFadeOutRatio = 0.5f;
-
-// The alpha to draw inactive icons with.
-const float kInactiveIconAlpha = 0.2f;
-
-// The colors and alpha values used for the button background hovered and
-// pressed states.
-// TODO(tdanderson|estade): Request these colors from ThemeProvider.
-const int kHoveredAlpha = 0x14;
-const int kPressedAlpha = 0x24;
-
-}  // namespace
-
-// static
-const char FrameCaptionButton::kViewClassName[] = "FrameCaptionButton";
-
-FrameCaptionButton::FrameCaptionButton(views::ButtonListener* listener,
-                                       CaptionButtonIcon icon)
-    : CustomButton(listener),
-      icon_(icon),
-      paint_as_active_(false),
-      use_light_images_(false),
-      alpha_(255),
-      swap_images_animation_(new gfx::SlideAnimation(this)) {
-  swap_images_animation_->Reset(1);
-
-  // Do not flip the gfx::Canvas passed to the OnPaint() method. The snap left
-  // and snap right button icons should not be flipped. The other icons are
-  // horizontally symmetrical.
-}
-
-FrameCaptionButton::~FrameCaptionButton() {}
-
-void FrameCaptionButton::SetImage(CaptionButtonIcon icon,
-                                  Animate animate,
-                                  gfx::VectorIconId icon_image_id) {
-  gfx::ImageSkia new_icon_image = gfx::CreateVectorIcon(
-      icon_image_id, use_light_images_ ? SK_ColorWHITE : gfx::kChromeIconGrey);
-
-  // The early return is dependent on |animate| because callers use SetImage()
-  // with ANIMATE_NO to progress the crossfade animation to the end.
-  if (icon == icon_ &&
-      (animate == ANIMATE_YES || !swap_images_animation_->is_animating()) &&
-      new_icon_image.BackedBySameObjectAs(icon_image_)) {
-    return;
-  }
-
-  if (animate == ANIMATE_YES)
-    crossfade_icon_image_ = icon_image_;
-
-  icon_ = icon;
-  icon_image_id_ = icon_image_id;
-  icon_image_ = new_icon_image;
-
-  if (animate == ANIMATE_YES) {
-    swap_images_animation_->Reset(0);
-    swap_images_animation_->SetSlideDuration(kSwapImagesAnimationDurationMs);
-    swap_images_animation_->Show();
-  } else {
-    swap_images_animation_->Reset(1);
-  }
-  PreferredSizeChanged();
-  SchedulePaint();
-}
-
-bool FrameCaptionButton::IsAnimatingImageSwap() const {
-  return swap_images_animation_->is_animating();
-}
-
-void FrameCaptionButton::SetAlpha(int alpha) {
-  if (alpha_ != alpha) {
-    alpha_ = alpha;
-    SchedulePaint();
-  }
-}
-
-gfx::Size FrameCaptionButton::GetPreferredSize() const {
-  return size_;
-}
-
-const char* FrameCaptionButton::GetClassName() const {
-  return kViewClassName;
-}
-
-void FrameCaptionButton::OnPaint(gfx::Canvas* canvas) {
-  SkAlpha bg_alpha = SK_AlphaTRANSPARENT;
-  if (hover_animation().is_animating())
-    bg_alpha = hover_animation().CurrentValueBetween(0, kHoveredAlpha);
-  else if (state() == STATE_HOVERED)
-    bg_alpha = kHoveredAlpha;
-  else if (state() == STATE_PRESSED)
-    bg_alpha = kPressedAlpha;
-
-  if (bg_alpha != SK_AlphaTRANSPARENT) {
-    canvas->DrawColor(SkColorSetA(
-        use_light_images_ ? SK_ColorWHITE : SK_ColorBLACK, bg_alpha));
-  }
-
-  int icon_alpha = swap_images_animation_->CurrentValueBetween(0, 255);
-  int crossfade_icon_alpha = 0;
-  if (icon_alpha < static_cast<int>(kFadeOutRatio * 255))
-    crossfade_icon_alpha = static_cast<int>(255 - icon_alpha / kFadeOutRatio);
-
-  if (crossfade_icon_alpha > 0 && !crossfade_icon_image_.isNull()) {
-    gfx::Canvas icon_canvas(icon_image_.size(), canvas->image_scale(), false);
-    SkPaint paint;
-    paint.setAlpha(icon_alpha);
-    icon_canvas.DrawImageInt(icon_image_, 0, 0, paint);
-
-    paint.setAlpha(crossfade_icon_alpha);
-    paint.setXfermodeMode(SkXfermode::kPlus_Mode);
-    icon_canvas.DrawImageInt(crossfade_icon_image_, 0, 0, paint);
-
-    PaintCentered(canvas, gfx::ImageSkia(icon_canvas.ExtractImageRep()),
-                  alpha_);
-  } else {
-    if (!swap_images_animation_->is_animating())
-      icon_alpha = alpha_;
-    PaintCentered(canvas, icon_image_, icon_alpha);
-  }
-}
-
-void FrameCaptionButton::OnGestureEvent(ui::GestureEvent* event) {
-  // CustomButton does not become pressed when the user drags off and then back
-  // onto the button. Make FrameCaptionButton pressed in this case because this
-  // behavior is more consistent with AlternateFrameSizeButton.
-  if (event->type() == ui::ET_GESTURE_SCROLL_BEGIN ||
-      event->type() == ui::ET_GESTURE_SCROLL_UPDATE) {
-    if (HitTestPoint(event->location())) {
-      SetState(STATE_PRESSED);
-      RequestFocus();
-      event->StopPropagation();
-    } else {
-      SetState(STATE_NORMAL);
-    }
-  } else if (event->type() == ui::ET_GESTURE_SCROLL_END) {
-    if (HitTestPoint(event->location())) {
-      SetState(STATE_HOVERED);
-      NotifyClick(*event);
-      event->StopPropagation();
-    }
-  }
-  CustomButton::OnGestureEvent(event);
-}
-
-void FrameCaptionButton::PaintCentered(gfx::Canvas* canvas,
-                                       const gfx::ImageSkia& to_center,
-                                       int alpha) {
-  if (!paint_as_active_) {
-    // Paint icons as active when they are hovered over or pressed.
-    double inactive_alpha = kInactiveIconAlpha;
-    if (hover_animation().is_animating()) {
-      inactive_alpha =
-          hover_animation().CurrentValueBetween(inactive_alpha, 1.0f);
-    } else if (state() == STATE_PRESSED || state() == STATE_HOVERED) {
-      inactive_alpha = 1.0f;
-    }
-    alpha *= inactive_alpha;
-  }
-
-  SkPaint paint;
-  paint.setAlpha(alpha);
-  canvas->DrawImageInt(to_center, (width() - to_center.width()) / 2,
-                       (height() - to_center.height()) / 2, paint);
-}
-
-}  // namespace ash
diff --git a/ash/common/frame/caption_buttons/frame_caption_button.h b/ash/common/frame/caption_buttons/frame_caption_button.h
deleted file mode 100644
index 3f80862..0000000
--- a/ash/common/frame/caption_buttons/frame_caption_button.h
+++ /dev/null
@@ -1,108 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_H_
-#define ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_H_
-
-#include <memory>
-
-#include "ash/ash_export.h"
-#include "ash/common/frame/caption_buttons/caption_button_types.h"
-#include "base/macros.h"
-#include "ui/gfx/image/image_skia.h"
-#include "ui/views/controls/button/custom_button.h"
-
-namespace gfx {
-class SlideAnimation;
-enum class VectorIconId;
-}
-
-namespace ash {
-
-// Base class for the window caption buttons (minimize, maximize, restore,
-// close).
-class ASH_EXPORT FrameCaptionButton : public views::CustomButton {
- public:
-  enum Animate { ANIMATE_YES, ANIMATE_NO };
-
-  static const char kViewClassName[];
-
-  FrameCaptionButton(views::ButtonListener* listener, CaptionButtonIcon icon);
-  ~FrameCaptionButton() override;
-
-  // Sets the image to use to paint the button. If |animate| is ANIMATE_YES,
-  // the button crossfades to the new visuals. If the image id matches the one
-  // currently used by the button and |animate| is ANIMATE_NO, the crossfade
-  // animation is progressed to the end.
-  void SetImage(CaptionButtonIcon icon,
-                Animate animate,
-                gfx::VectorIconId icon_image_id);
-
-  // Returns true if the button is crossfading to new visuals set in
-  // SetImage().
-  bool IsAnimatingImageSwap() const;
-
-  // Sets the alpha to use for painting. Used to animate visibility changes.
-  void SetAlpha(int alpha);
-
-  // views::View overrides:
-  gfx::Size GetPreferredSize() const override;
-  const char* GetClassName() const override;
-  void OnPaint(gfx::Canvas* canvas) override;
-
-  void set_paint_as_active(bool paint_as_active) {
-    paint_as_active_ = paint_as_active;
-  }
-
-  void set_use_light_images(bool light) { use_light_images_ = light; }
-
-  CaptionButtonIcon icon() const { return icon_; }
-
-  gfx::VectorIconId icon_image_id() const { return icon_image_id_; }
-
-  void set_size(const gfx::Size& size) { size_ = size; }
-
- protected:
-  // views::CustomButton override:
-  void OnGestureEvent(ui::GestureEvent* event) override;
-
- private:
-  // Paints |to_center| centered within the button with |alpha|.
-  void PaintCentered(gfx::Canvas* canvas,
-                     const gfx::ImageSkia& to_center,
-                     int alpha);
-
-  // The button's current icon.
-  CaptionButtonIcon icon_;
-
-  // The size of the button.
-  gfx::Size size_;
-
-  // Whether the button should be painted as active.
-  bool paint_as_active_;
-
-  // Whether to paint in a lighter color (for use on dark backgrounds).
-  bool use_light_images_;
-
-  // Current alpha to use for painting.
-  int alpha_;
-
-  // The image id (kept for the purposes of testing) and image used to paint the
-  // button's icon.
-  gfx::VectorIconId icon_image_id_;
-  gfx::ImageSkia icon_image_;
-
-  // The icon image to crossfade from.
-  gfx::ImageSkia crossfade_icon_image_;
-
-  // Crossfade animation started when the button's images are changed by
-  // SetImage().
-  std::unique_ptr<gfx::SlideAnimation> swap_images_animation_;
-
-  DISALLOW_COPY_AND_ASSIGN(FrameCaptionButton);
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_H_
diff --git a/ash/common/frame/caption_buttons/frame_caption_button_container_view.cc b/ash/common/frame/caption_buttons/frame_caption_button_container_view.cc
deleted file mode 100644
index 918c3df..0000000
--- a/ash/common/frame/caption_buttons/frame_caption_button_container_view.cc
+++ /dev/null
@@ -1,412 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-
-#include <cmath>
-#include <map>
-
-#include "ash/common/ash_switches.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button.h"
-#include "ash/common/frame/caption_buttons/frame_size_button.h"
-#include "ash/common/wm/maximize_mode/maximize_mode_controller.h"
-#include "ash/common/wm_shell.h"
-#include "ui/base/hit_test.h"
-#include "ui/base/l10n/l10n_util.h"
-#include "ui/compositor/scoped_animation_duration_scale_mode.h"
-#include "ui/gfx/animation/slide_animation.h"
-#include "ui/gfx/animation/tween.h"
-#include "ui/gfx/canvas.h"
-#include "ui/gfx/geometry/insets.h"
-#include "ui/gfx/geometry/point.h"
-#include "ui/gfx/vector_icons_public.h"
-#include "ui/strings/grit/ui_strings.h"  // Accessibility names
-#include "ui/views/widget/widget.h"
-#include "ui/views/widget/widget_delegate.h"
-
-namespace ash {
-
-namespace {
-
-// Duration of the animation of the position of |minimize_button_|.
-const int kPositionAnimationDurationMs = 500;
-
-// Duration of the animation of the alpha of |size_button_|.
-const int kAlphaAnimationDurationMs = 250;
-
-// Delay during |maximize_mode_animation_| hide to wait before beginning to
-// animate the position of |minimize_button_|.
-const int kHidePositionDelayMs = 100;
-
-// Duration of |maximize_mode_animation_| hiding.
-// Hiding size button 250
-// |------------------------|
-// Delay 100      Slide minimize button 500
-// |---------|-------------------------------------------------|
-const int kHideAnimationDurationMs =
-    kHidePositionDelayMs + kPositionAnimationDurationMs;
-
-// Delay during |maximize_mode_animation_| show to wait before beginning to
-// animate the alpha of |size_button_|.
-const int kShowAnimationAlphaDelayMs = 100;
-
-// Duration of |maximize_mode_animation_| showing.
-// Slide minimize button 500
-// |-------------------------------------------------|
-// Delay 100   Show size button 250
-// |---------|-----------------------|
-const int kShowAnimationDurationMs = kPositionAnimationDurationMs;
-
-// Value of |maximize_mode_animation_| showing to begin animating alpha of
-// |size_button_|.
-float SizeButtonShowStartValue() {
-  return static_cast<float>(kShowAnimationAlphaDelayMs) /
-         kShowAnimationDurationMs;
-}
-
-// Amount of |maximize_mode_animation_| showing to animate the alpha of
-// |size_button_|.
-float SizeButtonShowDuration() {
-  return static_cast<float>(kAlphaAnimationDurationMs) /
-         kShowAnimationDurationMs;
-}
-
-// Amount of |maximize_mode_animation_| hiding to animate the alpha of
-// |size_button_|.
-float SizeButtonHideDuration() {
-  return static_cast<float>(kAlphaAnimationDurationMs) /
-         kHideAnimationDurationMs;
-}
-
-// Value of |maximize_mode_animation_| hiding to begin animating the position of
-// |minimize_button_|.
-float HidePositionStartValue() {
-  return 1.0f -
-         static_cast<float>(kHidePositionDelayMs) / kHideAnimationDurationMs;
-}
-
-// Converts |point| from |src| to |dst| and hittests against |dst|.
-bool ConvertPointToViewAndHitTest(const views::View* src,
-                                  const views::View* dst,
-                                  const gfx::Point& point) {
-  gfx::Point converted(point);
-  views::View::ConvertPointToTarget(src, dst, &converted);
-  return dst->HitTestPoint(converted);
-}
-
-// Bounds animation values to the range 0.0 - 1.0. Allows for mapping of offset
-// animations to the expected range so that gfx::Tween::CalculateValue() can be
-// used.
-double CapAnimationValue(double value) {
-  return std::min(1.0, std::max(0.0, value));
-}
-
-}  // namespace
-
-// static
-const char FrameCaptionButtonContainerView::kViewClassName[] =
-    "FrameCaptionButtonContainerView";
-
-FrameCaptionButtonContainerView::FrameCaptionButtonContainerView(
-    views::Widget* frame)
-    : frame_(frame),
-      minimize_button_(NULL),
-      size_button_(NULL),
-      close_button_(NULL) {
-  bool size_button_visibility = ShouldSizeButtonBeVisible();
-  maximize_mode_animation_.reset(new gfx::SlideAnimation(this));
-  maximize_mode_animation_->SetTweenType(gfx::Tween::LINEAR);
-
-  // Ensure animation tracks visibility of size button.
-  if (size_button_visibility)
-    maximize_mode_animation_->Reset(1.0f);
-
-  // Insert the buttons left to right.
-  minimize_button_ = new FrameCaptionButton(this, CAPTION_BUTTON_ICON_MINIMIZE);
-  minimize_button_->SetAccessibleName(
-      l10n_util::GetStringUTF16(IDS_APP_ACCNAME_MINIMIZE));
-  minimize_button_->SetVisible(frame_->widget_delegate()->CanMinimize());
-  AddChildView(minimize_button_);
-
-  size_button_ = new FrameSizeButton(this, frame, this);
-  size_button_->SetAccessibleName(
-      l10n_util::GetStringUTF16(IDS_APP_ACCNAME_MAXIMIZE));
-  size_button_->SetVisible(size_button_visibility);
-  AddChildView(size_button_);
-
-  close_button_ = new FrameCaptionButton(this, CAPTION_BUTTON_ICON_CLOSE);
-  close_button_->SetAccessibleName(
-      l10n_util::GetStringUTF16(IDS_APP_ACCNAME_CLOSE));
-  AddChildView(close_button_);
-}
-
-FrameCaptionButtonContainerView::~FrameCaptionButtonContainerView() {}
-
-void FrameCaptionButtonContainerView::TestApi::EndAnimations() {
-  container_view_->maximize_mode_animation_->End();
-}
-
-void FrameCaptionButtonContainerView::SetButtonImage(
-    CaptionButtonIcon icon,
-    gfx::VectorIconId icon_image_id) {
-  button_icon_id_map_[icon] = icon_image_id;
-
-  FrameCaptionButton* buttons[] = {minimize_button_, size_button_,
-                                   close_button_};
-  for (size_t i = 0; i < arraysize(buttons); ++i) {
-    if (buttons[i]->icon() == icon)
-      buttons[i]->SetImage(icon, FrameCaptionButton::ANIMATE_NO, icon_image_id);
-  }
-}
-
-void FrameCaptionButtonContainerView::SetPaintAsActive(bool paint_as_active) {
-  minimize_button_->set_paint_as_active(paint_as_active);
-  size_button_->set_paint_as_active(paint_as_active);
-  close_button_->set_paint_as_active(paint_as_active);
-}
-
-void FrameCaptionButtonContainerView::SetUseLightImages(bool light) {
-  minimize_button_->set_use_light_images(light);
-  size_button_->set_use_light_images(light);
-  close_button_->set_use_light_images(light);
-}
-
-void FrameCaptionButtonContainerView::ResetWindowControls() {
-  SetButtonsToNormal(ANIMATE_NO);
-}
-
-int FrameCaptionButtonContainerView::NonClientHitTest(
-    const gfx::Point& point) const {
-  if (close_button_->visible() &&
-      ConvertPointToViewAndHitTest(this, close_button_, point)) {
-    return HTCLOSE;
-  } else if (size_button_->visible() &&
-             ConvertPointToViewAndHitTest(this, size_button_, point)) {
-    return HTMAXBUTTON;
-  } else if (minimize_button_->visible() &&
-             ConvertPointToViewAndHitTest(this, minimize_button_, point)) {
-    return HTMINBUTTON;
-  }
-  return HTNOWHERE;
-}
-
-void FrameCaptionButtonContainerView::UpdateSizeButtonVisibility() {
-  bool visible = ShouldSizeButtonBeVisible();
-  if (visible) {
-    size_button_->SetVisible(true);
-    maximize_mode_animation_->SetSlideDuration(kShowAnimationDurationMs);
-    maximize_mode_animation_->Show();
-  } else {
-    maximize_mode_animation_->SetSlideDuration(kHideAnimationDurationMs);
-    maximize_mode_animation_->Hide();
-  }
-}
-
-void FrameCaptionButtonContainerView::SetButtonSize(const gfx::Size& size) {
-  minimize_button_->set_size(size);
-  size_button_->set_size(size);
-  close_button_->set_size(size);
-}
-
-gfx::Size FrameCaptionButtonContainerView::GetPreferredSize() const {
-  int width = 0;
-  for (int i = 0; i < child_count(); ++i) {
-    const views::View* child = child_at(i);
-    if (child->visible())
-      width += child_at(i)->GetPreferredSize().width();
-  }
-  return gfx::Size(width, close_button_->GetPreferredSize().height());
-}
-
-void FrameCaptionButtonContainerView::Layout() {
-  int x = 0;
-  for (int i = 0; i < child_count(); ++i) {
-    views::View* child = child_at(i);
-    if (!child->visible())
-      continue;
-
-    gfx::Size size = child->GetPreferredSize();
-    child->SetBounds(x, 0, size.width(), size.height());
-    x += size.width();
-  }
-  if (maximize_mode_animation_->is_animating()) {
-    AnimationProgressed(maximize_mode_animation_.get());
-  }
-}
-
-const char* FrameCaptionButtonContainerView::GetClassName() const {
-  return kViewClassName;
-}
-
-void FrameCaptionButtonContainerView::AnimationEnded(
-    const gfx::Animation* animation) {
-  // Ensure that position is calculated at least once.
-  AnimationProgressed(animation);
-
-  double current_value = maximize_mode_animation_->GetCurrentValue();
-  if (current_value == 0.0) {
-    size_button_->SetVisible(false);
-    PreferredSizeChanged();
-  }
-}
-
-void FrameCaptionButtonContainerView::AnimationProgressed(
-    const gfx::Animation* animation) {
-  double current_value = animation->GetCurrentValue();
-  int size_alpha = 0;
-  int minimize_x = 0;
-  if (maximize_mode_animation_->IsShowing()) {
-    double scaled_value =
-        CapAnimationValue((current_value - SizeButtonShowStartValue()) /
-                          SizeButtonShowDuration());
-    double tweened_value_alpha =
-        gfx::Tween::CalculateValue(gfx::Tween::EASE_OUT, scaled_value);
-    size_alpha = gfx::Tween::LinearIntValueBetween(tweened_value_alpha, 0, 255);
-
-    double tweened_value_slide =
-        gfx::Tween::CalculateValue(gfx::Tween::EASE_OUT, current_value);
-    minimize_x = gfx::Tween::LinearIntValueBetween(tweened_value_slide,
-                                                   size_button_->x(), 0);
-  } else {
-    double scaled_value_alpha =
-        CapAnimationValue((1.0f - current_value) / SizeButtonHideDuration());
-    double tweened_value_alpha =
-        gfx::Tween::CalculateValue(gfx::Tween::EASE_IN, scaled_value_alpha);
-    size_alpha = gfx::Tween::LinearIntValueBetween(tweened_value_alpha, 255, 0);
-
-    double scaled_value_position = CapAnimationValue(
-        (HidePositionStartValue() - current_value) / HidePositionStartValue());
-    double tweened_value_position =
-        gfx::Tween::CalculateValue(gfx::Tween::EASE_OUT, scaled_value_position);
-    minimize_x = gfx::Tween::LinearIntValueBetween(tweened_value_position, 0,
-                                                   size_button_->x());
-  }
-  size_button_->SetAlpha(size_alpha);
-  minimize_button_->SetX(minimize_x);
-}
-
-void FrameCaptionButtonContainerView::SetButtonIcon(FrameCaptionButton* button,
-                                                    CaptionButtonIcon icon,
-                                                    Animate animate) {
-  // The early return is dependant on |animate| because callers use
-  // SetButtonIcon() with ANIMATE_NO to progress |button|'s crossfade animation
-  // to the end.
-  if (button->icon() == icon &&
-      (animate == ANIMATE_YES || !button->IsAnimatingImageSwap())) {
-    return;
-  }
-
-  FrameCaptionButton::Animate fcb_animate =
-      (animate == ANIMATE_YES) ? FrameCaptionButton::ANIMATE_YES
-                               : FrameCaptionButton::ANIMATE_NO;
-  auto it = button_icon_id_map_.find(icon);
-  if (it != button_icon_id_map_.end())
-    button->SetImage(icon, fcb_animate, it->second);
-}
-
-bool FrameCaptionButtonContainerView::ShouldSizeButtonBeVisible() const {
-  return !WmShell::Get()
-              ->maximize_mode_controller()
-              ->IsMaximizeModeWindowManagerEnabled() &&
-         frame_->widget_delegate()->CanMaximize();
-}
-
-void FrameCaptionButtonContainerView::ButtonPressed(views::Button* sender,
-                                                    const ui::Event& event) {
-  // Abort any animations of the button icons.
-  SetButtonsToNormal(ANIMATE_NO);
-
-  UserMetricsAction action = UMA_WINDOW_MAXIMIZE_BUTTON_CLICK_MINIMIZE;
-  if (sender == minimize_button_) {
-    frame_->Minimize();
-  } else if (sender == size_button_) {
-    if (frame_->IsFullscreen()) {  // Can be clicked in immersive fullscreen.
-      frame_->Restore();
-      action = UMA_WINDOW_MAXIMIZE_BUTTON_CLICK_EXIT_FULLSCREEN;
-    } else if (frame_->IsMaximized()) {
-      frame_->Restore();
-      action = UMA_WINDOW_MAXIMIZE_BUTTON_CLICK_RESTORE;
-    } else {
-      frame_->Maximize();
-      action = UMA_WINDOW_MAXIMIZE_BUTTON_CLICK_MAXIMIZE;
-    }
-
-    if (event.IsGestureEvent())
-      WmShell::Get()->RecordGestureAction(GESTURE_FRAMEMAXIMIZE_TAP);
-  } else if (sender == close_button_) {
-    frame_->Close();
-    action = UMA_WINDOW_CLOSE_BUTTON_CLICK;
-  } else {
-    return;
-  }
-  WmShell::Get()->RecordUserMetricsAction(action);
-}
-
-bool FrameCaptionButtonContainerView::IsMinimizeButtonVisible() const {
-  return minimize_button_->visible();
-}
-
-void FrameCaptionButtonContainerView::SetButtonsToNormal(Animate animate) {
-  SetButtonIcons(CAPTION_BUTTON_ICON_MINIMIZE, CAPTION_BUTTON_ICON_CLOSE,
-                 animate);
-  minimize_button_->SetState(views::Button::STATE_NORMAL);
-  size_button_->SetState(views::Button::STATE_NORMAL);
-  close_button_->SetState(views::Button::STATE_NORMAL);
-}
-
-void FrameCaptionButtonContainerView::SetButtonIcons(
-    CaptionButtonIcon minimize_button_icon,
-    CaptionButtonIcon close_button_icon,
-    Animate animate) {
-  SetButtonIcon(minimize_button_, minimize_button_icon, animate);
-  SetButtonIcon(close_button_, close_button_icon, animate);
-}
-
-const FrameCaptionButton* FrameCaptionButtonContainerView::GetButtonClosestTo(
-    const gfx::Point& position_in_screen) const {
-  // Since the buttons all have the same size, the closest button is the button
-  // with the center point closest to |position_in_screen|.
-  // TODO(pkotwicz): Make the caption buttons not overlap.
-  gfx::Point position(position_in_screen);
-  views::View::ConvertPointFromScreen(this, &position);
-
-  FrameCaptionButton* buttons[] = {minimize_button_, size_button_,
-                                   close_button_};
-  int min_squared_distance = INT_MAX;
-  FrameCaptionButton* closest_button = NULL;
-  for (size_t i = 0; i < arraysize(buttons); ++i) {
-    FrameCaptionButton* button = buttons[i];
-    if (!button->visible())
-      continue;
-
-    gfx::Point center_point = button->GetLocalBounds().CenterPoint();
-    views::View::ConvertPointToTarget(button, this, &center_point);
-    int squared_distance = static_cast<int>(
-        pow(static_cast<double>(position.x() - center_point.x()), 2) +
-        pow(static_cast<double>(position.y() - center_point.y()), 2));
-    if (squared_distance < min_squared_distance) {
-      min_squared_distance = squared_distance;
-      closest_button = button;
-    }
-  }
-  return closest_button;
-}
-
-void FrameCaptionButtonContainerView::SetHoveredAndPressedButtons(
-    const FrameCaptionButton* to_hover,
-    const FrameCaptionButton* to_press) {
-  FrameCaptionButton* buttons[] = {minimize_button_, size_button_,
-                                   close_button_};
-  for (size_t i = 0; i < arraysize(buttons); ++i) {
-    FrameCaptionButton* button = buttons[i];
-    views::Button::ButtonState new_state = views::Button::STATE_NORMAL;
-    if (button == to_hover)
-      new_state = views::Button::STATE_HOVERED;
-    else if (button == to_press)
-      new_state = views::Button::STATE_PRESSED;
-    button->SetState(new_state);
-  }
-}
-
-}  // namespace ash
diff --git a/ash/common/frame/caption_buttons/frame_caption_button_container_view.h b/ash/common/frame/caption_buttons/frame_caption_button_container_view.h
deleted file mode 100644
index 55fd39c..0000000
--- a/ash/common/frame/caption_buttons/frame_caption_button_container_view.h
+++ /dev/null
@@ -1,157 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_CONTAINER_VIEW_H_
-#define ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_CONTAINER_VIEW_H_
-
-#include <map>
-
-#include "ash/ash_export.h"
-#include "ash/common/frame/caption_buttons/frame_size_button_delegate.h"
-#include "base/macros.h"
-#include "ui/gfx/animation/animation_delegate.h"
-#include "ui/views/controls/button/button.h"
-#include "ui/views/view.h"
-
-namespace gfx {
-class SlideAnimation;
-enum class VectorIconId;
-}
-
-namespace views {
-class Widget;
-}
-
-namespace ash {
-
-// Container view for the frame caption buttons. It performs the appropriate
-// action when a caption button is clicked.
-class ASH_EXPORT FrameCaptionButtonContainerView
-    : public views::View,
-      public views::ButtonListener,
-      public FrameSizeButtonDelegate,
-      public gfx::AnimationDelegate {
- public:
-  static const char kViewClassName[];
-
-  // |frame| is the views::Widget that the caption buttons act on.
-  explicit FrameCaptionButtonContainerView(views::Widget* frame);
-  ~FrameCaptionButtonContainerView() override;
-
-  // For testing.
-  class ASH_EXPORT TestApi {
-   public:
-    explicit TestApi(FrameCaptionButtonContainerView* container_view)
-        : container_view_(container_view) {}
-
-    void EndAnimations();
-
-    FrameCaptionButton* minimize_button() const {
-      return container_view_->minimize_button_;
-    }
-
-    FrameCaptionButton* size_button() const {
-      return container_view_->size_button_;
-    }
-
-    FrameCaptionButton* close_button() const {
-      return container_view_->close_button_;
-    }
-
-   private:
-    FrameCaptionButtonContainerView* container_view_;
-
-    DISALLOW_COPY_AND_ASSIGN(TestApi);
-  };
-
-  // Sets the id of the vector image to paint the button for |icon|. The
-  // FrameCaptionButtonContainerView will keep track of the image to use for
-  // |icon| even if none of the buttons currently use |icon|.
-  void SetButtonImage(CaptionButtonIcon icon, gfx::VectorIconId icon_image_id);
-
-  // Sets whether the buttons should be painted as active. Does not schedule
-  // a repaint.
-  void SetPaintAsActive(bool paint_as_active);
-
-  // Sets whether the buttons should be painted in a lighter color (for use on
-  // dark backgrounds).
-  void SetUseLightImages(bool light);
-
-  // Tell the window controls to reset themselves to the normal state.
-  void ResetWindowControls();
-
-  // Determines the window HT* code for the caption button at |point|. Returns
-  // HTNOWHERE if |point| is not over any of the caption buttons. |point| must
-  // be in the coordinates of the FrameCaptionButtonContainerView.
-  int NonClientHitTest(const gfx::Point& point) const;
-
-  // Updates the size button's visibility based on whether |frame_| can be
-  // maximized and if maximize mode is enabled. A parent view should relayout
-  // to reflect the change in visibility.
-  void UpdateSizeButtonVisibility();
-
-  // Sets the size of the buttons in this container.
-  void SetButtonSize(const gfx::Size& size);
-
-  // views::View:
-  gfx::Size GetPreferredSize() const override;
-  void Layout() override;
-  const char* GetClassName() const override;
-
-  // gfx::AnimationDelegate:
-  void AnimationEnded(const gfx::Animation* animation) override;
-  void AnimationProgressed(const gfx::Animation* animation) override;
-
- private:
-  friend class FrameCaptionButtonContainerViewTest;
-
-  // Sets |button|'s icon to |icon|. If |animate| is ANIMATE_YES, the button
-  // will crossfade to the new icon. If |animate| is ANIMATE_NO and
-  // |icon| == |button|->icon(), the crossfade animation is progressed to the
-  // end.
-  void SetButtonIcon(FrameCaptionButton* button,
-                     CaptionButtonIcon icon,
-                     Animate animate);
-
-  // Returns true if maximize mode is not enabled, and |frame_| widget delegate
-  // can be maximized.
-  bool ShouldSizeButtonBeVisible() const;
-
-  // views::ButtonListener:
-  void ButtonPressed(views::Button* sender, const ui::Event& event) override;
-
-  // FrameSizeButtonDelegate:
-  bool IsMinimizeButtonVisible() const override;
-  void SetButtonsToNormal(Animate animate) override;
-  void SetButtonIcons(CaptionButtonIcon minimize_button_icon,
-                      CaptionButtonIcon close_button_icon,
-                      Animate animate) override;
-  const FrameCaptionButton* GetButtonClosestTo(
-      const gfx::Point& position_in_screen) const override;
-  void SetHoveredAndPressedButtons(const FrameCaptionButton* to_hover,
-                                   const FrameCaptionButton* to_press) override;
-
-  // The widget that the buttons act on.
-  views::Widget* frame_;
-
-  // The buttons. In the normal button style, at most one of |minimize_button_|
-  // and |size_button_| is visible.
-  FrameCaptionButton* minimize_button_;
-  FrameCaptionButton* size_button_;
-  FrameCaptionButton* close_button_;
-
-  // Mapping of the image ID needed to paint a button for each of the values of
-  // CaptionButtonIcon.
-  std::map<CaptionButtonIcon, gfx::VectorIconId> button_icon_id_map_;
-
-  // Animation that affects the position of |minimize_button_| and the
-  // visibility of |size_button_|.
-  std::unique_ptr<gfx::SlideAnimation> maximize_mode_animation_;
-
-  DISALLOW_COPY_AND_ASSIGN(FrameCaptionButtonContainerView);
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_CONTAINER_VIEW_H_
diff --git a/ash/common/frame/caption_buttons/frame_caption_button_container_view_unittest.cc b/ash/common/frame/caption_buttons/frame_caption_button_container_view_unittest.cc
deleted file mode 100644
index 067e868..0000000
--- a/ash/common/frame/caption_buttons/frame_caption_button_container_view_unittest.cc
+++ /dev/null
@@ -1,204 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-
-#include "ash/common/ash_layout_constants.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button.h"
-#include "ash/common/wm/maximize_mode/maximize_mode_controller.h"
-#include "ash/common/wm_shell.h"
-#include "ash/test/ash_test_base.h"
-#include "grit/ash_resources.h"
-#include "ui/gfx/geometry/rect.h"
-#include "ui/gfx/vector_icons_public.h"
-#include "ui/views/widget/widget.h"
-#include "ui/views/widget/widget_delegate.h"
-
-namespace ash {
-
-namespace {
-
-class TestWidgetDelegate : public views::WidgetDelegateView {
- public:
-  TestWidgetDelegate(bool can_maximize, bool can_minimize)
-      : can_maximize_(can_maximize), can_minimize_(can_minimize) {}
-  ~TestWidgetDelegate() override {}
-
-  bool CanMaximize() const override { return can_maximize_; }
-
-  bool CanMinimize() const override { return can_minimize_; }
-
- private:
-  bool can_maximize_;
-  bool can_minimize_;
-
-  DISALLOW_COPY_AND_ASSIGN(TestWidgetDelegate);
-};
-
-}  // namespace
-
-class FrameCaptionButtonContainerViewTest : public ash::test::AshTestBase {
- public:
-  enum MaximizeAllowed { MAXIMIZE_ALLOWED, MAXIMIZE_DISALLOWED };
-
-  enum MinimizeAllowed { MINIMIZE_ALLOWED, MINIMIZE_DISALLOWED };
-
-  FrameCaptionButtonContainerViewTest() {}
-
-  ~FrameCaptionButtonContainerViewTest() override {}
-
-  // Creates a widget which allows maximizing based on |maximize_allowed|.
-  // The caller takes ownership of the returned widget.
-  views::Widget* CreateTestWidget(MaximizeAllowed maximize_allowed,
-                                  MinimizeAllowed minimize_allowed)
-      WARN_UNUSED_RESULT {
-    views::Widget* widget = new views::Widget;
-    views::Widget::InitParams params;
-    params.delegate =
-        new TestWidgetDelegate(maximize_allowed == MAXIMIZE_ALLOWED,
-                               minimize_allowed == MINIMIZE_ALLOWED);
-    params.ownership = views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET;
-    params.context = CurrentContext();
-    widget->Init(params);
-    return widget;
-  }
-
-  // Sets arbitrary images for the icons and assign the default caption button
-  // size to the buttons in |container|.
-  void InitContainer(FrameCaptionButtonContainerView* container) {
-    container->SetButtonSize(
-        GetAshLayoutSize(AshLayoutSize::NON_BROWSER_CAPTION_BUTTON));
-    for (int icon = 0; icon < CAPTION_BUTTON_ICON_COUNT; ++icon) {
-      container->SetButtonImage(static_cast<CaptionButtonIcon>(icon),
-                                gfx::VectorIconId::WINDOW_CONTROL_CLOSE);
-    }
-  }
-
-  // Tests that |leftmost| and |rightmost| are at |container|'s edges.
-  bool CheckButtonsAtEdges(FrameCaptionButtonContainerView* container,
-                           const ash::FrameCaptionButton& leftmost,
-                           const ash::FrameCaptionButton& rightmost) {
-    gfx::Rect expected(container->GetPreferredSize());
-
-    gfx::Rect container_size(container->GetPreferredSize());
-    if (leftmost.y() == rightmost.y() &&
-        leftmost.height() == rightmost.height() &&
-        leftmost.x() == expected.x() && leftmost.y() == expected.y() &&
-        leftmost.height() == expected.height() &&
-        rightmost.bounds().right() == expected.right()) {
-      return true;
-    }
-
-    LOG(ERROR) << "Buttons " << leftmost.bounds().ToString() << " "
-               << rightmost.bounds().ToString() << " not at edges of "
-               << expected.ToString();
-    return false;
-  }
-
- private:
-  DISALLOW_COPY_AND_ASSIGN(FrameCaptionButtonContainerViewTest);
-};
-
-// Test how the allowed actions affect which caption buttons are visible.
-TEST_F(FrameCaptionButtonContainerViewTest, ButtonVisibility) {
-  // All the buttons should be visible when minimizing and maximizing are
-  // allowed.
-  FrameCaptionButtonContainerView container1(
-      CreateTestWidget(MAXIMIZE_ALLOWED, MINIMIZE_ALLOWED));
-  InitContainer(&container1);
-  container1.Layout();
-  FrameCaptionButtonContainerView::TestApi t1(&container1);
-  EXPECT_TRUE(t1.minimize_button()->visible());
-  EXPECT_TRUE(t1.size_button()->visible());
-  EXPECT_TRUE(t1.close_button()->visible());
-  EXPECT_TRUE(CheckButtonsAtEdges(&container1, *t1.minimize_button(),
-                                  *t1.close_button()));
-
-  // The minimize button should be visible when minimizing is allowed but
-  // maximizing is disallowed.
-  FrameCaptionButtonContainerView container2(
-      CreateTestWidget(MAXIMIZE_DISALLOWED, MINIMIZE_ALLOWED));
-  InitContainer(&container2);
-  container2.Layout();
-  FrameCaptionButtonContainerView::TestApi t2(&container2);
-  EXPECT_TRUE(t2.minimize_button()->visible());
-  EXPECT_FALSE(t2.size_button()->visible());
-  EXPECT_TRUE(t2.close_button()->visible());
-  EXPECT_TRUE(CheckButtonsAtEdges(&container2, *t2.minimize_button(),
-                                  *t2.close_button()));
-
-  // Neither the minimize button nor the size button should be visible when
-  // neither minimizing nor maximizing are allowed.
-  FrameCaptionButtonContainerView container3(
-      CreateTestWidget(MAXIMIZE_DISALLOWED, MINIMIZE_DISALLOWED));
-  InitContainer(&container3);
-  container3.Layout();
-  FrameCaptionButtonContainerView::TestApi t3(&container3);
-  EXPECT_FALSE(t3.minimize_button()->visible());
-  EXPECT_FALSE(t3.size_button()->visible());
-  EXPECT_TRUE(t3.close_button()->visible());
-  EXPECT_TRUE(
-      CheckButtonsAtEdges(&container3, *t3.close_button(), *t3.close_button()));
-}
-
-// Tests that the layout animations trigered by button visibility result in the
-// correct placement of the buttons.
-TEST_F(FrameCaptionButtonContainerViewTest,
-       TestUpdateSizeButtonVisibilityAnimation) {
-  FrameCaptionButtonContainerView container(
-      CreateTestWidget(MAXIMIZE_ALLOWED, MINIMIZE_ALLOWED));
-  InitContainer(&container);
-  container.SetBoundsRect(gfx::Rect(container.GetPreferredSize()));
-  container.Layout();
-
-  FrameCaptionButtonContainerView::TestApi test(&container);
-  gfx::Rect initial_minimize_button_bounds = test.minimize_button()->bounds();
-  gfx::Rect initial_size_button_bounds = test.size_button()->bounds();
-  gfx::Rect initial_close_button_bounds = test.close_button()->bounds();
-  gfx::Rect initial_container_bounds = container.bounds();
-
-  ASSERT_EQ(initial_size_button_bounds.x(),
-            initial_minimize_button_bounds.right());
-  ASSERT_EQ(initial_close_button_bounds.x(),
-            initial_size_button_bounds.right());
-
-  // Hidden size button should result in minimize button animating to the
-  // right. The size button should not be visible, but should not have moved.
-  WmShell::Get()->maximize_mode_controller()->EnableMaximizeModeWindowManager(
-      true);
-  container.UpdateSizeButtonVisibility();
-  test.EndAnimations();
-  // Parent needs to layout in response to size change.
-  container.Layout();
-
-  EXPECT_TRUE(test.minimize_button()->visible());
-  EXPECT_FALSE(test.size_button()->visible());
-  EXPECT_TRUE(test.close_button()->visible());
-  gfx::Rect minimize_button_bounds = test.minimize_button()->bounds();
-  gfx::Rect close_button_bounds = test.close_button()->bounds();
-  EXPECT_EQ(close_button_bounds.x(), minimize_button_bounds.right());
-  EXPECT_EQ(initial_size_button_bounds, test.size_button()->bounds());
-  EXPECT_EQ(initial_close_button_bounds.size(), close_button_bounds.size());
-  EXPECT_LT(container.GetPreferredSize().width(),
-            initial_container_bounds.width());
-
-  // Revealing the size button should cause the minimize button to return to its
-  // original position.
-  WmShell::Get()->maximize_mode_controller()->EnableMaximizeModeWindowManager(
-      false);
-  container.UpdateSizeButtonVisibility();
-  // Calling code needs to layout in response to size change.
-  container.Layout();
-  test.EndAnimations();
-  EXPECT_TRUE(test.minimize_button()->visible());
-  EXPECT_TRUE(test.size_button()->visible());
-  EXPECT_TRUE(test.close_button()->visible());
-  EXPECT_EQ(initial_minimize_button_bounds, test.minimize_button()->bounds());
-  EXPECT_EQ(initial_size_button_bounds, test.size_button()->bounds());
-  EXPECT_EQ(initial_close_button_bounds, test.close_button()->bounds());
-  EXPECT_EQ(container.GetPreferredSize().width(),
-            initial_container_bounds.width());
-}
-
-}  // namespace ash
diff --git a/ash/common/frame/caption_buttons/frame_size_button.cc b/ash/common/frame/caption_buttons/frame_size_button.cc
deleted file mode 100644
index e283809..0000000
--- a/ash/common/frame/caption_buttons/frame_size_button.cc
+++ /dev/null
@@ -1,271 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ash/common/frame/caption_buttons/frame_size_button.h"
-
-#include "ash/common/wm/window_positioning_utils.h"
-#include "ash/common/wm/window_state.h"
-#include "ash/common/wm/wm_event.h"
-#include "ash/common/wm/workspace/phantom_window_controller.h"
-#include "ash/common/wm_lookup.h"
-#include "ash/common/wm_shell.h"
-#include "ash/common/wm_window.h"
-#include "base/i18n/rtl.h"
-#include "ui/gfx/geometry/vector2d.h"
-#include "ui/views/widget/widget.h"
-
-namespace ash {
-
-namespace {
-
-// The default delay between the user pressing the size button and the buttons
-// adjacent to the size button morphing into buttons for snapping left and
-// right.
-const int kSetButtonsToSnapModeDelayMs = 150;
-
-// The amount that a user can overshoot one of the caption buttons while in
-// "snap mode" and keep the button hovered/pressed.
-const int kMaxOvershootX = 200;
-const int kMaxOvershootY = 50;
-
-// Returns true if a mouse drag while in "snap mode" at |location_in_screen|
-// would hover/press |button| or keep it hovered/pressed.
-bool HitTestButton(const FrameCaptionButton* button,
-                   const gfx::Point& location_in_screen) {
-  gfx::Rect expanded_bounds_in_screen = button->GetBoundsInScreen();
-  if (button->state() == views::Button::STATE_HOVERED ||
-      button->state() == views::Button::STATE_PRESSED) {
-    expanded_bounds_in_screen.Inset(-kMaxOvershootX, -kMaxOvershootY);
-  }
-  return expanded_bounds_in_screen.Contains(location_in_screen);
-}
-
-}  // namespace
-
-FrameSizeButton::FrameSizeButton(views::ButtonListener* listener,
-                                 views::Widget* frame,
-                                 FrameSizeButtonDelegate* delegate)
-    : FrameCaptionButton(listener, CAPTION_BUTTON_ICON_MAXIMIZE_RESTORE),
-      frame_(frame),
-      delegate_(delegate),
-      set_buttons_to_snap_mode_delay_ms_(kSetButtonsToSnapModeDelayMs),
-      in_snap_mode_(false),
-      snap_type_(SNAP_NONE) {}
-
-FrameSizeButton::~FrameSizeButton() {}
-
-bool FrameSizeButton::OnMousePressed(const ui::MouseEvent& event) {
-  // The minimize and close buttons are set to snap left and right when snapping
-  // is enabled. Do not enable snapping if the minimize button is not visible.
-  // The close button is always visible.
-  if (IsTriggerableEvent(event) && !in_snap_mode_ &&
-      delegate_->IsMinimizeButtonVisible()) {
-    StartSetButtonsToSnapModeTimer(event);
-  }
-  FrameCaptionButton::OnMousePressed(event);
-  return true;
-}
-
-bool FrameSizeButton::OnMouseDragged(const ui::MouseEvent& event) {
-  UpdateSnapType(event);
-  // By default a FrameCaptionButton reverts to STATE_NORMAL once the mouse
-  // leaves its bounds. Skip FrameCaptionButton's handling when
-  // |in_snap_mode_| == true because we want different behavior.
-  if (!in_snap_mode_)
-    FrameCaptionButton::OnMouseDragged(event);
-  return true;
-}
-
-void FrameSizeButton::OnMouseReleased(const ui::MouseEvent& event) {
-  if (!IsTriggerableEvent(event) || !CommitSnap(event))
-    FrameCaptionButton::OnMouseReleased(event);
-}
-
-void FrameSizeButton::OnMouseCaptureLost() {
-  SetButtonsToNormalMode(FrameSizeButtonDelegate::ANIMATE_YES);
-  FrameCaptionButton::OnMouseCaptureLost();
-}
-
-void FrameSizeButton::OnMouseMoved(const ui::MouseEvent& event) {
-  // Ignore any synthetic mouse moves during a drag.
-  if (!in_snap_mode_)
-    FrameCaptionButton::OnMouseMoved(event);
-}
-
-void FrameSizeButton::OnGestureEvent(ui::GestureEvent* event) {
-  if (event->details().touch_points() > 1) {
-    SetButtonsToNormalMode(FrameSizeButtonDelegate::ANIMATE_YES);
-    return;
-  }
-
-  if (event->type() == ui::ET_GESTURE_TAP_DOWN) {
-    StartSetButtonsToSnapModeTimer(*event);
-    // Go through FrameCaptionButton's handling so that the button gets pressed.
-    FrameCaptionButton::OnGestureEvent(event);
-    return;
-  }
-
-  if (event->type() == ui::ET_GESTURE_SCROLL_BEGIN ||
-      event->type() == ui::ET_GESTURE_SCROLL_UPDATE) {
-    UpdateSnapType(*event);
-    event->SetHandled();
-    return;
-  }
-
-  if (event->type() == ui::ET_GESTURE_TAP ||
-      event->type() == ui::ET_GESTURE_SCROLL_END ||
-      event->type() == ui::ET_SCROLL_FLING_START ||
-      event->type() == ui::ET_GESTURE_END) {
-    if (CommitSnap(*event)) {
-      event->SetHandled();
-      return;
-    }
-  }
-
-  FrameCaptionButton::OnGestureEvent(event);
-}
-
-void FrameSizeButton::StartSetButtonsToSnapModeTimer(
-    const ui::LocatedEvent& event) {
-  set_buttons_to_snap_mode_timer_event_location_ = event.location();
-  if (set_buttons_to_snap_mode_delay_ms_ == 0) {
-    AnimateButtonsToSnapMode();
-  } else {
-    set_buttons_to_snap_mode_timer_.Start(
-        FROM_HERE,
-        base::TimeDelta::FromMilliseconds(set_buttons_to_snap_mode_delay_ms_),
-        this, &FrameSizeButton::AnimateButtonsToSnapMode);
-  }
-}
-
-void FrameSizeButton::AnimateButtonsToSnapMode() {
-  SetButtonsToSnapMode(FrameSizeButtonDelegate::ANIMATE_YES);
-}
-
-void FrameSizeButton::SetButtonsToSnapMode(
-    FrameSizeButtonDelegate::Animate animate) {
-  in_snap_mode_ = true;
-
-  // When using a right-to-left layout the close button is left of the size
-  // button and the minimize button is right of the size button.
-  if (base::i18n::IsRTL()) {
-    delegate_->SetButtonIcons(CAPTION_BUTTON_ICON_RIGHT_SNAPPED,
-                              CAPTION_BUTTON_ICON_LEFT_SNAPPED, animate);
-  } else {
-    delegate_->SetButtonIcons(CAPTION_BUTTON_ICON_LEFT_SNAPPED,
-                              CAPTION_BUTTON_ICON_RIGHT_SNAPPED, animate);
-  }
-}
-
-void FrameSizeButton::UpdateSnapType(const ui::LocatedEvent& event) {
-  if (!in_snap_mode_) {
-    // Set the buttons adjacent to the size button to snap left and right early
-    // if the user drags past the drag threshold.
-    // |set_buttons_to_snap_mode_timer_| is checked to avoid entering the snap
-    // mode as a result of an unsupported drag type (e.g. only the right mouse
-    // button is pressed).
-    gfx::Vector2d delta(event.location() -
-                        set_buttons_to_snap_mode_timer_event_location_);
-    if (!set_buttons_to_snap_mode_timer_.IsRunning() ||
-        !views::View::ExceededDragThreshold(delta)) {
-      return;
-    }
-    AnimateButtonsToSnapMode();
-  }
-
-  gfx::Point event_location_in_screen(event.location());
-  views::View::ConvertPointToScreen(this, &event_location_in_screen);
-  const FrameCaptionButton* to_hover =
-      GetButtonToHover(event_location_in_screen);
-  bool press_size_button =
-      to_hover || HitTestButton(this, event_location_in_screen);
-
-  if (to_hover) {
-    // Progress the minimize and close icon morph animations to the end if they
-    // are in progress.
-    SetButtonsToSnapMode(FrameSizeButtonDelegate::ANIMATE_NO);
-  }
-
-  delegate_->SetHoveredAndPressedButtons(to_hover,
-                                         press_size_button ? this : NULL);
-
-  snap_type_ = SNAP_NONE;
-  if (to_hover) {
-    switch (to_hover->icon()) {
-      case CAPTION_BUTTON_ICON_LEFT_SNAPPED:
-        snap_type_ = SNAP_LEFT;
-        break;
-      case CAPTION_BUTTON_ICON_RIGHT_SNAPPED:
-        snap_type_ = SNAP_RIGHT;
-        break;
-      case CAPTION_BUTTON_ICON_MAXIMIZE_RESTORE:
-      case CAPTION_BUTTON_ICON_MINIMIZE:
-      case CAPTION_BUTTON_ICON_CLOSE:
-      case CAPTION_BUTTON_ICON_BACK:
-      case CAPTION_BUTTON_ICON_LOCATION:
-      case CAPTION_BUTTON_ICON_COUNT:
-        NOTREACHED();
-        break;
-    }
-  }
-
-  if (snap_type_ == SNAP_LEFT || snap_type_ == SNAP_RIGHT) {
-    WmWindow* window = WmLookup::Get()->GetWindowForWidget(frame_);
-    if (!phantom_window_controller_.get())
-      phantom_window_controller_.reset(new PhantomWindowController(window));
-    gfx::Rect phantom_bounds_in_parent =
-        (snap_type_ == SNAP_LEFT)
-            ? wm::GetDefaultLeftSnappedWindowBoundsInParent(window)
-            : wm::GetDefaultRightSnappedWindowBoundsInParent(window);
-    phantom_window_controller_->Show(
-        window->GetParent()->ConvertRectToScreen(phantom_bounds_in_parent));
-  } else {
-    phantom_window_controller_.reset();
-  }
-}
-
-const FrameCaptionButton* FrameSizeButton::GetButtonToHover(
-    const gfx::Point& event_location_in_screen) const {
-  const FrameCaptionButton* closest_button =
-      delegate_->GetButtonClosestTo(event_location_in_screen);
-  if ((closest_button->icon() == CAPTION_BUTTON_ICON_LEFT_SNAPPED ||
-       closest_button->icon() == CAPTION_BUTTON_ICON_RIGHT_SNAPPED) &&
-      HitTestButton(closest_button, event_location_in_screen)) {
-    return closest_button;
-  }
-  return NULL;
-}
-
-bool FrameSizeButton::CommitSnap(const ui::LocatedEvent& event) {
-  // The position of |event| may be different than the position of the previous
-  // event.
-  UpdateSnapType(event);
-
-  if (in_snap_mode_ && (snap_type_ == SNAP_LEFT || snap_type_ == SNAP_RIGHT)) {
-    WmWindow* window = WmLookup::Get()->GetWindowForWidget(frame_);
-    wm::WindowState* window_state = window->GetWindowState();
-    const wm::WMEvent snap_event(snap_type_ == SNAP_LEFT
-                                     ? wm::WM_EVENT_SNAP_LEFT
-                                     : wm::WM_EVENT_SNAP_RIGHT);
-    window_state->OnWMEvent(&snap_event);
-    WmShell::Get()->RecordUserMetricsAction(
-        snap_type_ == SNAP_LEFT ? UMA_WINDOW_MAXIMIZE_BUTTON_MAXIMIZE_LEFT
-                                : UMA_WINDOW_MAXIMIZE_BUTTON_MAXIMIZE_RIGHT);
-    SetButtonsToNormalMode(FrameSizeButtonDelegate::ANIMATE_NO);
-    return true;
-  }
-  SetButtonsToNormalMode(FrameSizeButtonDelegate::ANIMATE_YES);
-  return false;
-}
-
-void FrameSizeButton::SetButtonsToNormalMode(
-    FrameSizeButtonDelegate::Animate animate) {
-  in_snap_mode_ = false;
-  snap_type_ = SNAP_NONE;
-  set_buttons_to_snap_mode_timer_.Stop();
-  delegate_->SetButtonsToNormal(animate);
-  phantom_window_controller_.reset();
-}
-
-}  // namespace ash
diff --git a/ash/common/frame/caption_buttons/frame_size_button.h b/ash/common/frame/caption_buttons/frame_size_button.h
deleted file mode 100644
index 0ab4dcf..0000000
--- a/ash/common/frame/caption_buttons/frame_size_button.h
+++ /dev/null
@@ -1,120 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_H_
-#define ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_H_
-
-#include <memory>
-
-#include "ash/ash_export.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button.h"
-#include "ash/common/frame/caption_buttons/frame_size_button_delegate.h"
-#include "base/macros.h"
-#include "base/timer/timer.h"
-
-namespace views {
-class Widget;
-}
-
-namespace ash {
-class FrameSizeButtonDelegate;
-class PhantomWindowController;
-
-// The maximize/restore button.
-// When the mouse is pressed over the size button or the size button is touched:
-// - The minimize and close buttons are set to snap left and snap right
-//   respectively.
-// - The size button stays pressed while the mouse is over the buttons to snap
-//   left and to snap right. The button underneath the mouse is hovered.
-// When the drag terminates, the action for the button underneath the mouse
-// is executed. For the sake of simplicity, the size button is the event
-// handler for a click starting on the size button and the entire drag.
-class ASH_EXPORT FrameSizeButton : public FrameCaptionButton {
- public:
-  FrameSizeButton(views::ButtonListener* listener,
-                  views::Widget* frame,
-                  FrameSizeButtonDelegate* delegate);
-
-  ~FrameSizeButton() override;
-
-  // views::CustomButton overrides:
-  bool OnMousePressed(const ui::MouseEvent& event) override;
-  bool OnMouseDragged(const ui::MouseEvent& event) override;
-  void OnMouseReleased(const ui::MouseEvent& event) override;
-  void OnMouseCaptureLost() override;
-  void OnMouseMoved(const ui::MouseEvent& event) override;
-  void OnGestureEvent(ui::GestureEvent* event) override;
-
-  void set_delay_to_set_buttons_to_snap_mode(int delay_ms) {
-    set_buttons_to_snap_mode_delay_ms_ = delay_ms;
-  }
-
- private:
-  enum SnapType { SNAP_LEFT, SNAP_RIGHT, SNAP_NONE };
-
-  // Starts |set_buttons_to_snap_mode_timer_|.
-  void StartSetButtonsToSnapModeTimer(const ui::LocatedEvent& event);
-
-  // Animates the buttons adjacent to the size button to snap left and right.
-  void AnimateButtonsToSnapMode();
-
-  // Sets the buttons adjacent to the size button to snap left and right.
-  // Passing in ANIMATE_NO progresses the animation (if any) to the end.
-  void SetButtonsToSnapMode(FrameSizeButtonDelegate::Animate animate);
-
-  // Updates |snap_type_|, whether the size button is pressed and whether any
-  // other buttons are hovered.
-  void UpdateSnapType(const ui::LocatedEvent& event);
-
-  // Returns the button which should be hovered (if any) while in "snap mode"
-  // for |event_location_in_screen|.
-  const FrameCaptionButton* GetButtonToHover(
-      const gfx::Point& event_location_in_screen) const;
-
-  // Snaps |frame_| according to |snap_type_|. Returns true if |frame_| was
-  // snapped.
-  bool CommitSnap(const ui::LocatedEvent& event);
-
-  // Sets the buttons adjacent to the size button to minimize and close again.
-  // Clears any state set while snapping was enabled. |animate| indicates
-  // whether the buttons should animate back to their original icons.
-  void SetButtonsToNormalMode(FrameSizeButtonDelegate::Animate animate);
-
-  // Widget that the size button acts on.
-  views::Widget* frame_;
-
-  // Not owned.
-  FrameSizeButtonDelegate* delegate_;
-
-  // Location of the event which started |set_buttons_to_snap_mode_timer_| in
-  // view coordinates.
-  gfx::Point set_buttons_to_snap_mode_timer_event_location_;
-
-  // The delay between the user pressing the size button and the buttons
-  // adjacent to the size button morphing into buttons for snapping left and
-  // right.
-  int set_buttons_to_snap_mode_delay_ms_;
-
-  base::OneShotTimer set_buttons_to_snap_mode_timer_;
-
-  // Whether the buttons adjacent to the size button snap the window left and
-  // right.
-  bool in_snap_mode_;
-
-  // The action to execute when the drag/click is ended. If
-  // |snap_type_| == SNAP_NONE, the size button's default action is run when the
-  // drag/click is ended.
-  SnapType snap_type_;
-
-  // Displays a preview of how the window's bounds will change as a result of
-  // snapping the window left or right. The preview is only visible if the snap
-  // left or snap right button is pressed.
-  std::unique_ptr<PhantomWindowController> phantom_window_controller_;
-
-  DISALLOW_COPY_AND_ASSIGN(FrameSizeButton);
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_H_
diff --git a/ash/common/frame/caption_buttons/frame_size_button_delegate.h b/ash/common/frame/caption_buttons/frame_size_button_delegate.h
deleted file mode 100644
index 9aba5fc..0000000
--- a/ash/common/frame/caption_buttons/frame_size_button_delegate.h
+++ /dev/null
@@ -1,55 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_DELEGATE_H_
-#define ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_DELEGATE_H_
-
-#include "ash/ash_export.h"
-#include "ash/common/frame/caption_buttons/caption_button_types.h"
-
-namespace gfx {
-class Insets;
-class Point;
-class Vector2d;
-}
-
-namespace ash {
-class FrameCaptionButton;
-
-// Delegate interface for FrameSizeButton.
-class ASH_EXPORT FrameSizeButtonDelegate {
- public:
-  enum Animate { ANIMATE_YES, ANIMATE_NO };
-
-  // Returns whether the minimize button is visible.
-  virtual bool IsMinimizeButtonVisible() const = 0;
-
-  // Reset the caption button views::Button::ButtonState back to normal. If
-  // |animate| is ANIMATE_YES, the buttons will crossfade back to their
-  // original icons.
-  virtual void SetButtonsToNormal(Animate animate) = 0;
-
-  // Sets the minimize and close button icons. The buttons will crossfade to
-  // their new icons if |animate| is ANIMATE_YES.
-  virtual void SetButtonIcons(CaptionButtonIcon minimize_button_icon,
-                              CaptionButtonIcon close_button_icon,
-                              Animate animate) = 0;
-
-  // Returns the button closest to |position_in_screen|.
-  virtual const FrameCaptionButton* GetButtonClosestTo(
-      const gfx::Point& position_in_screen) const = 0;
-
-  // Sets |to_hover| and |to_pressed| to STATE_HOVERED and STATE_PRESSED
-  // respectively. All other buttons are to set to STATE_NORMAL.
-  virtual void SetHoveredAndPressedButtons(
-      const FrameCaptionButton* to_hover,
-      const FrameCaptionButton* to_press) = 0;
-
- protected:
-  virtual ~FrameSizeButtonDelegate() {}
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_DELEGATE_H_
diff --git a/ash/common/frame/default_header_painter.cc b/ash/common/frame/default_header_painter.cc
deleted file mode 100644
index c0ef3a8..0000000
--- a/ash/common/frame/default_header_painter.cc
+++ /dev/null
@@ -1,319 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ash/common/frame/default_header_painter.h"
-
-#include "ash/common/ash_layout_constants.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-#include "ash/common/frame/header_painter_util.h"
-#include "base/debug/leak_annotations.h"
-#include "base/logging.h"  // DCHECK
-#include "grit/ash_resources.h"
-#include "third_party/skia/include/core/SkPaint.h"
-#include "third_party/skia/include/core/SkPath.h"
-#include "ui/base/resource/resource_bundle.h"
-#include "ui/gfx/animation/slide_animation.h"
-#include "ui/gfx/canvas.h"
-#include "ui/gfx/color_utils.h"
-#include "ui/gfx/font_list.h"
-#include "ui/gfx/geometry/rect.h"
-#include "ui/gfx/image/image.h"
-#include "ui/gfx/scoped_canvas.h"
-#include "ui/gfx/skia_util.h"
-#include "ui/gfx/vector_icons_public.h"
-#include "ui/views/view.h"
-#include "ui/views/widget/native_widget_aura.h"
-#include "ui/views/widget/widget.h"
-#include "ui/views/widget/widget_delegate.h"
-
-using views::Widget;
-
-namespace {
-
-// Color for the window title text.
-const SkColor kTitleTextColor = SkColorSetRGB(40, 40, 40);
-// Color of the active window header/content separator line.
-const SkColor kHeaderContentSeparatorColor = SkColorSetRGB(150, 150, 152);
-// Color of the inactive window header/content separator line.
-const SkColor kHeaderContentSeparatorInactiveColor =
-    SkColorSetRGB(180, 180, 182);
-// The default color of the frame.
-const SkColor kDefaultFrameColor = SkColorSetRGB(242, 242, 242);
-// Duration of crossfade animation for activating and deactivating frame.
-const int kActivationCrossfadeDurationMs = 200;
-
-// Tiles an image into an area, rounding the top corners.
-void TileRoundRect(gfx::Canvas* canvas,
-                   const SkPaint& paint,
-                   const gfx::Rect& bounds,
-                   int corner_radius) {
-  SkRect rect = gfx::RectToSkRect(bounds);
-  const SkScalar corner_radius_scalar = SkIntToScalar(corner_radius);
-  SkScalar radii[8] = {corner_radius_scalar,
-                       corner_radius_scalar,  // top-left
-                       corner_radius_scalar,
-                       corner_radius_scalar,  // top-right
-                       0,
-                       0,  // bottom-right
-                       0,
-                       0};  // bottom-left
-  SkPath path;
-  path.addRoundRect(rect, radii, SkPath::kCW_Direction);
-  canvas->DrawPath(path, paint);
-}
-
-// Returns the FontList to use for the title.
-const gfx::FontList& GetTitleFontList() {
-  static const gfx::FontList* title_font_list =
-      new gfx::FontList(views::NativeWidgetAura::GetWindowTitleFontList());
-  ANNOTATE_LEAKING_OBJECT_PTR(title_font_list);
-  return *title_font_list;
-}
-
-}  // namespace
-
-namespace ash {
-
-///////////////////////////////////////////////////////////////////////////////
-// DefaultHeaderPainter, public:
-
-DefaultHeaderPainter::DefaultHeaderPainter()
-    : frame_(NULL),
-      view_(NULL),
-      left_header_view_(NULL),
-      active_frame_color_(kDefaultFrameColor),
-      inactive_frame_color_(kDefaultFrameColor),
-      caption_button_container_(NULL),
-      painted_height_(0),
-      mode_(MODE_INACTIVE),
-      initial_paint_(true),
-      activation_animation_(new gfx::SlideAnimation(this)) {}
-
-DefaultHeaderPainter::~DefaultHeaderPainter() {}
-
-void DefaultHeaderPainter::Init(
-    views::Widget* frame,
-    views::View* header_view,
-    FrameCaptionButtonContainerView* caption_button_container) {
-  DCHECK(frame);
-  DCHECK(header_view);
-  DCHECK(caption_button_container);
-  frame_ = frame;
-  view_ = header_view;
-  caption_button_container_ = caption_button_container;
-  caption_button_container_->SetButtonSize(
-      GetAshLayoutSize(AshLayoutSize::NON_BROWSER_CAPTION_BUTTON));
-  UpdateAllButtonImages();
-}
-
-int DefaultHeaderPainter::GetMinimumHeaderWidth() const {
-  // Ensure we have enough space for the window icon and buttons. We allow
-  // the title string to collapse to zero width.
-  return GetTitleBounds().x() +
-         caption_button_container_->GetMinimumSize().width();
-}
-
-void DefaultHeaderPainter::PaintHeader(gfx::Canvas* canvas, Mode mode) {
-  Mode old_mode = mode_;
-  mode_ = mode;
-
-  if (mode_ != old_mode) {
-    UpdateAllButtonImages();
-    if (!initial_paint_ && HeaderPainterUtil::CanAnimateActivation(frame_)) {
-      activation_animation_->SetSlideDuration(kActivationCrossfadeDurationMs);
-      if (mode_ == MODE_ACTIVE)
-        activation_animation_->Show();
-      else
-        activation_animation_->Hide();
-    } else {
-      if (mode_ == MODE_ACTIVE)
-        activation_animation_->Reset(1);
-      else
-        activation_animation_->Reset(0);
-    }
-    initial_paint_ = false;
-  }
-
-  int corner_radius = (frame_->IsMaximized() || frame_->IsFullscreen())
-                          ? 0
-                          : HeaderPainterUtil::GetTopCornerRadiusWhenRestored();
-
-  SkPaint paint;
-  int active_alpha = activation_animation_->CurrentValueBetween(0, 255);
-  paint.setColor(color_utils::AlphaBlend(active_frame_color_,
-                                         inactive_frame_color_, active_alpha));
-
-  TileRoundRect(canvas, paint, GetLocalBounds(), corner_radius);
-
-  if (!frame_->IsMaximized() && !frame_->IsFullscreen() &&
-      mode_ == MODE_INACTIVE && !UsesCustomFrameColors()) {
-    PaintHighlightForInactiveRestoredWindow(canvas);
-  }
-  if (frame_->widget_delegate() &&
-      frame_->widget_delegate()->ShouldShowWindowTitle()) {
-    PaintTitleBar(canvas);
-  }
-  if (!UsesCustomFrameColors())
-    PaintHeaderContentSeparator(canvas);
-}
-
-void DefaultHeaderPainter::LayoutHeader() {
-  caption_button_container_->SetUseLightImages(ShouldUseLightImages());
-  UpdateSizeButtonImages();
-  caption_button_container_->Layout();
-
-  gfx::Size caption_button_container_size =
-      caption_button_container_->GetPreferredSize();
-  caption_button_container_->SetBounds(
-      view_->width() - caption_button_container_size.width(), 0,
-      caption_button_container_size.width(),
-      caption_button_container_size.height());
-
-  if (left_header_view_) {
-    // Vertically center the left header view with respect to the caption button
-    // container.
-    // Floor when computing the center of |caption_button_container_|.
-    gfx::Size size = left_header_view_->GetPreferredSize();
-    int icon_offset_y =
-        caption_button_container_->height() / 2 - size.height() / 2;
-    left_header_view_->SetBounds(HeaderPainterUtil::GetLeftViewXInset(),
-                                 icon_offset_y, size.width(), size.height());
-  }
-
-  // The header/content separator line overlays the caption buttons.
-  SetHeaderHeightForPainting(caption_button_container_->height());
-}
-
-int DefaultHeaderPainter::GetHeaderHeight() const {
-  return caption_button_container_->height();
-}
-
-int DefaultHeaderPainter::GetHeaderHeightForPainting() const {
-  return painted_height_;
-}
-
-void DefaultHeaderPainter::SetHeaderHeightForPainting(int height) {
-  painted_height_ = height;
-}
-
-void DefaultHeaderPainter::SchedulePaintForTitle() {
-  view_->SchedulePaintInRect(GetTitleBounds());
-}
-
-void DefaultHeaderPainter::SetFrameColors(SkColor active_frame_color,
-                                          SkColor inactive_frame_color) {
-  active_frame_color_ = active_frame_color;
-  inactive_frame_color_ = inactive_frame_color;
-  UpdateAllButtonImages();
-}
-
-void DefaultHeaderPainter::UpdateLeftHeaderView(views::View* left_header_view) {
-  left_header_view_ = left_header_view;
-}
-
-///////////////////////////////////////////////////////////////////////////////
-// gfx::AnimationDelegate overrides:
-
-void DefaultHeaderPainter::AnimationProgressed(
-    const gfx::Animation* animation) {
-  view_->SchedulePaintInRect(GetLocalBounds());
-}
-
-///////////////////////////////////////////////////////////////////////////////
-// DefaultHeaderPainter, private:
-
-void DefaultHeaderPainter::PaintHighlightForInactiveRestoredWindow(
-    gfx::Canvas* canvas) {
-  ui::ResourceBundle& rb = ui::ResourceBundle::GetSharedInstance();
-  gfx::ImageSkia top_edge =
-      *rb.GetImageSkiaNamed(IDR_AURA_WINDOW_HEADER_SHADE_INACTIVE_TOP);
-  gfx::ImageSkia left_edge =
-      *rb.GetImageSkiaNamed(IDR_AURA_WINDOW_HEADER_SHADE_INACTIVE_LEFT);
-  gfx::ImageSkia right_edge =
-      *rb.GetImageSkiaNamed(IDR_AURA_WINDOW_HEADER_SHADE_INACTIVE_RIGHT);
-  gfx::ImageSkia bottom_edge =
-      *rb.GetImageSkiaNamed(IDR_AURA_WINDOW_HEADER_SHADE_INACTIVE_BOTTOM);
-
-  int left_edge_width = left_edge.width();
-  int right_edge_width = right_edge.width();
-  canvas->DrawImageInt(left_edge, 0, 0);
-  canvas->DrawImageInt(right_edge, view_->width() - right_edge_width, 0);
-  canvas->TileImageInt(top_edge, left_edge_width, 0,
-                       view_->width() - left_edge_width - right_edge_width,
-                       top_edge.height());
-
-  DCHECK_EQ(left_edge.height(), right_edge.height());
-  int bottom = left_edge.height();
-  int bottom_height = bottom_edge.height();
-  canvas->TileImageInt(bottom_edge, left_edge_width, bottom - bottom_height,
-                       view_->width() - left_edge_width - right_edge_width,
-                       bottom_height);
-}
-
-void DefaultHeaderPainter::PaintTitleBar(gfx::Canvas* canvas) {
-  // The window icon is painted by its own views::View.
-  gfx::Rect title_bounds = GetTitleBounds();
-  title_bounds.set_x(view_->GetMirroredXForRect(title_bounds));
-  canvas->DrawStringRectWithFlags(
-      frame_->widget_delegate()->GetWindowTitle(), GetTitleFontList(),
-      kTitleTextColor, title_bounds, gfx::Canvas::NO_SUBPIXEL_RENDERING);
-}
-
-void DefaultHeaderPainter::PaintHeaderContentSeparator(gfx::Canvas* canvas) {
-  gfx::ScopedCanvas scoped_canvas(canvas);
-  const float scale = canvas->UndoDeviceScaleFactor();
-  gfx::RectF rect(0, painted_height_ * scale - 1, view_->width() * scale, 1);
-  SkPaint paint;
-  paint.setColor((mode_ == MODE_ACTIVE) ? kHeaderContentSeparatorColor
-                                        : kHeaderContentSeparatorInactiveColor);
-  canvas->sk_canvas()->drawRect(gfx::RectFToSkRect(rect), paint);
-}
-
-bool DefaultHeaderPainter::ShouldUseLightImages() {
-  return color_utils::IsDark(mode_ == MODE_INACTIVE ? inactive_frame_color_
-                                                    : active_frame_color_);
-}
-
-void DefaultHeaderPainter::UpdateAllButtonImages() {
-  caption_button_container_->SetUseLightImages(ShouldUseLightImages());
-  caption_button_container_->SetButtonImage(
-      CAPTION_BUTTON_ICON_MINIMIZE, gfx::VectorIconId::WINDOW_CONTROL_MINIMIZE);
-
-  UpdateSizeButtonImages();
-
-  caption_button_container_->SetButtonImage(
-      CAPTION_BUTTON_ICON_CLOSE, gfx::VectorIconId::WINDOW_CONTROL_CLOSE);
-
-  caption_button_container_->SetButtonImage(
-      CAPTION_BUTTON_ICON_LEFT_SNAPPED,
-      gfx::VectorIconId::WINDOW_CONTROL_LEFT_SNAPPED);
-
-  caption_button_container_->SetButtonImage(
-      CAPTION_BUTTON_ICON_RIGHT_SNAPPED,
-      gfx::VectorIconId::WINDOW_CONTROL_RIGHT_SNAPPED);
-}
-
-void DefaultHeaderPainter::UpdateSizeButtonImages() {
-  gfx::VectorIconId icon_id = frame_->IsMaximized() || frame_->IsFullscreen()
-                                  ? gfx::VectorIconId::WINDOW_CONTROL_RESTORE
-                                  : gfx::VectorIconId::WINDOW_CONTROL_MAXIMIZE;
-  caption_button_container_->SetButtonImage(
-      CAPTION_BUTTON_ICON_MAXIMIZE_RESTORE, icon_id);
-}
-
-gfx::Rect DefaultHeaderPainter::GetLocalBounds() const {
-  return gfx::Rect(view_->width(), painted_height_);
-}
-
-gfx::Rect DefaultHeaderPainter::GetTitleBounds() const {
-  return HeaderPainterUtil::GetTitleBounds(
-      left_header_view_, caption_button_container_, GetTitleFontList());
-}
-
-bool DefaultHeaderPainter::UsesCustomFrameColors() const {
-  return active_frame_color_ != kDefaultFrameColor ||
-         inactive_frame_color_ != kDefaultFrameColor;
-}
-
-}  // namespace ash
diff --git a/ash/common/frame/default_header_painter.h b/ash/common/frame/default_header_painter.h
deleted file mode 100644
index d9ea50c..0000000
--- a/ash/common/frame/default_header_painter.h
+++ /dev/null
@@ -1,120 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_FRAME_DEFAULT_HEADER_PAINTER_H_
-#define ASH_COMMON_FRAME_DEFAULT_HEADER_PAINTER_H_
-
-#include <memory>
-
-#include "ash/ash_export.h"
-#include "ash/common/frame/header_painter.h"
-#include "base/compiler_specific.h"  // override
-#include "base/gtest_prod_util.h"
-#include "base/macros.h"
-#include "third_party/skia/include/core/SkColor.h"
-#include "ui/gfx/animation/animation_delegate.h"
-
-namespace gfx {
-class ImageSkia;
-class Rect;
-class SlideAnimation;
-}
-namespace views {
-class View;
-class Widget;
-}
-
-namespace ash {
-class FrameCaptionButtonContainerView;
-
-// Helper class for painting the default window header.
-class ASH_EXPORT DefaultHeaderPainter : public HeaderPainter,
-                                        public gfx::AnimationDelegate {
- public:
-  DefaultHeaderPainter();
-  ~DefaultHeaderPainter() override;
-
-  // DefaultHeaderPainter does not take ownership of any of the parameters.
-  void Init(views::Widget* frame,
-            views::View* header_view,
-            FrameCaptionButtonContainerView* caption_button_container);
-
-  // HeaderPainter overrides:
-  int GetMinimumHeaderWidth() const override;
-  void PaintHeader(gfx::Canvas* canvas, Mode mode) override;
-  void LayoutHeader() override;
-  int GetHeaderHeight() const override;
-  int GetHeaderHeightForPainting() const override;
-  void SetHeaderHeightForPainting(int height) override;
-  void SchedulePaintForTitle() override;
-
-  // Sets the left header view for the header. Passing NULL removes the view.
-  void UpdateLeftHeaderView(views::View* left_header_view);
-
-  // Sets the active and inactive frame colors. Note the inactive frame color
-  // will have some transparency added when the frame is drawn.
-  void SetFrameColors(SkColor active_frame_color, SkColor inactive_frame_color);
-
- private:
-  FRIEND_TEST_ALL_PREFIXES(DefaultHeaderPainterTest, TitleIconAlignment);
-  FRIEND_TEST_ALL_PREFIXES(DefaultHeaderPainterTest, LightIcons);
-
-  // gfx::AnimationDelegate override:
-  void AnimationProgressed(const gfx::Animation* animation) override;
-
-  // Paints highlight around the edge of the header for inactive restored
-  // windows.
-  void PaintHighlightForInactiveRestoredWindow(gfx::Canvas* canvas);
-
-  // Paints the title bar, primarily the title string.
-  void PaintTitleBar(gfx::Canvas* canvas);
-
-  // Paints the header/content separator.
-  void PaintHeaderContentSeparator(gfx::Canvas* canvas);
-
-  // Whether light caption images should be used. This is the case when the
-  // background of the frame is dark.
-  bool ShouldUseLightImages();
-
-  // Update all the images in the caption buttons.
-  void UpdateAllButtonImages();
-
-  // Updates the size button's images.
-  void UpdateSizeButtonImages();
-
-  // Returns the header bounds in the coordinates of |view_|. The header is
-  // assumed to be positioned at the top left corner of |view_| and to have the
-  // same width as |view_|.
-  gfx::Rect GetLocalBounds() const;
-
-  // Returns the bounds for the title.
-  gfx::Rect GetTitleBounds() const;
-
-  // Returns whether the frame uses custom frame coloring.
-  bool UsesCustomFrameColors() const;
-
-  views::Widget* frame_;
-  views::View* view_;
-  views::View* left_header_view_;  // May be NULL.
-  SkColor active_frame_color_;
-  SkColor inactive_frame_color_;
-  FrameCaptionButtonContainerView* caption_button_container_;
-
-  // The height of the header to paint.
-  int painted_height_;
-
-  // Whether the header should be painted as active.
-  Mode mode_;
-
-  // Whether the header is painted for the first time.
-  bool initial_paint_;
-
-  std::unique_ptr<gfx::SlideAnimation> activation_animation_;
-
-  DISALLOW_COPY_AND_ASSIGN(DefaultHeaderPainter);
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_FRAME_DEFAULT_HEADER_PAINTER_H_
diff --git a/ash/common/frame/default_header_painter_unittest.cc b/ash/common/frame/default_header_painter_unittest.cc
deleted file mode 100644
index 2108962..0000000
--- a/ash/common/frame/default_header_painter_unittest.cc
+++ /dev/null
@@ -1,85 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ash/common/frame/default_header_painter.h"
-
-#include <memory>
-
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-#include "ash/common/shell_window_ids.h"
-#include "ash/test/ash_test_base.h"
-#include "ui/views/test/test_views.h"
-#include "ui/views/widget/widget.h"
-#include "ui/views/window/non_client_view.h"
-
-using ash::HeaderPainter;
-using views::NonClientFrameView;
-using views::Widget;
-
-namespace ash {
-
-using DefaultHeaderPainterTest = test::AshTestBase;
-
-// Ensure the title text is vertically aligned with the window icon.
-TEST_F(DefaultHeaderPainterTest, TitleIconAlignment) {
-  std::unique_ptr<Widget> w = CreateTestWidget(
-      nullptr, kShellWindowId_DefaultContainer, gfx::Rect(1, 2, 3, 4));
-  ash::FrameCaptionButtonContainerView container(w.get());
-  views::StaticSizedView window_icon(gfx::Size(16, 16));
-  window_icon.SetBounds(0, 0, 16, 16);
-  w->SetBounds(gfx::Rect(0, 0, 500, 500));
-  w->Show();
-
-  DefaultHeaderPainter painter;
-  painter.Init(w.get(), w->non_client_view()->frame_view(), &container);
-  painter.UpdateLeftHeaderView(&window_icon);
-  painter.LayoutHeader();
-  gfx::Rect title_bounds = painter.GetTitleBounds();
-  EXPECT_EQ(window_icon.bounds().CenterPoint().y(),
-            title_bounds.CenterPoint().y());
-}
-
-// Ensure the light icons are used when appropriate.
-TEST_F(DefaultHeaderPainterTest, LightIcons) {
-  std::unique_ptr<Widget> w = CreateTestWidget(
-      nullptr, kShellWindowId_DefaultContainer, gfx::Rect(1, 2, 3, 4));
-  ash::FrameCaptionButtonContainerView container(w.get());
-  views::StaticSizedView window_icon(gfx::Size(16, 16));
-  window_icon.SetBounds(0, 0, 16, 16);
-  w->SetBounds(gfx::Rect(0, 0, 500, 500));
-  w->Show();
-
-  DefaultHeaderPainter painter;
-  painter.Init(w.get(), w->non_client_view()->frame_view(), &container);
-
-  // Check by default light icons are not used.
-  painter.mode_ = HeaderPainter::MODE_ACTIVE;
-  EXPECT_FALSE(painter.ShouldUseLightImages());
-  painter.mode_ = HeaderPainter::MODE_INACTIVE;
-  EXPECT_FALSE(painter.ShouldUseLightImages());
-
-  // Check that setting dark colors should use light icons.
-  painter.SetFrameColors(SkColorSetRGB(0, 0, 0), SkColorSetRGB(0, 0, 0));
-  painter.mode_ = HeaderPainter::MODE_ACTIVE;
-  EXPECT_TRUE(painter.ShouldUseLightImages());
-  painter.mode_ = HeaderPainter::MODE_INACTIVE;
-  EXPECT_TRUE(painter.ShouldUseLightImages());
-
-  // Check that inactive and active colors are used properly.
-  painter.SetFrameColors(SkColorSetRGB(0, 0, 0), SkColorSetRGB(255, 255, 255));
-  painter.mode_ = HeaderPainter::MODE_ACTIVE;
-  EXPECT_TRUE(painter.ShouldUseLightImages());
-  painter.mode_ = HeaderPainter::MODE_INACTIVE;
-  EXPECT_FALSE(painter.ShouldUseLightImages());
-
-  // Check not so light or dark colors.
-  painter.SetFrameColors(SkColorSetRGB(70, 70, 70),
-                         SkColorSetRGB(200, 200, 200));
-  painter.mode_ = HeaderPainter::MODE_ACTIVE;
-  EXPECT_TRUE(painter.ShouldUseLightImages());
-  painter.mode_ = HeaderPainter::MODE_INACTIVE;
-  EXPECT_FALSE(painter.ShouldUseLightImages());
-}
-
-}  // namespace ash
diff --git a/ash/common/frame/frame_border_hit_test.cc b/ash/common/frame/frame_border_hit_test.cc
deleted file mode 100644
index 3f0116a..0000000
--- a/ash/common/frame/frame_border_hit_test.cc
+++ /dev/null
@@ -1,67 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ash/common/frame/frame_border_hit_test.h"
-
-#include "ash/common/ash_constants.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-#include "ash/common/wm_shell.h"
-#include "ui/base/hit_test.h"
-#include "ui/views/widget/widget.h"
-#include "ui/views/widget/widget_delegate.h"
-#include "ui/views/window/non_client_view.h"
-
-namespace ash {
-
-int FrameBorderNonClientHitTest(
-    views::NonClientFrameView* view,
-    FrameCaptionButtonContainerView* caption_button_container,
-    const gfx::Point& point_in_widget) {
-  gfx::Rect expanded_bounds = view->bounds();
-  int outside_bounds = kResizeOutsideBoundsSize;
-
-  if (WmShell::Get()->IsTouchDown())
-    outside_bounds *= kResizeOutsideBoundsScaleForTouch;
-  expanded_bounds.Inset(-outside_bounds, -outside_bounds);
-
-  if (!expanded_bounds.Contains(point_in_widget))
-    return HTNOWHERE;
-
-  // Check the frame first, as we allow a small area overlapping the contents
-  // to be used for resize handles.
-  views::Widget* frame = view->GetWidget();
-  bool can_ever_resize = frame->widget_delegate()->CanResize();
-  // Don't allow overlapping resize handles when the window is maximized or
-  // fullscreen, as it can't be resized in those states.
-  int resize_border = kResizeInsideBoundsSize;
-  if (frame->IsMaximized() || frame->IsFullscreen()) {
-    resize_border = 0;
-    can_ever_resize = false;
-  }
-  int frame_component = view->GetHTComponentForFrame(
-      point_in_widget, resize_border, resize_border, kResizeAreaCornerSize,
-      kResizeAreaCornerSize, can_ever_resize);
-  if (frame_component != HTNOWHERE)
-    return frame_component;
-
-  int client_component =
-      frame->client_view()->NonClientHitTest(point_in_widget);
-  if (client_component != HTNOWHERE)
-    return client_component;
-
-  if (caption_button_container->visible()) {
-    gfx::Point point_in_caption_button_container(point_in_widget);
-    views::View::ConvertPointFromWidget(caption_button_container,
-                                        &point_in_caption_button_container);
-    int caption_button_component = caption_button_container->NonClientHitTest(
-        point_in_caption_button_container);
-    if (caption_button_component != HTNOWHERE)
-      return caption_button_component;
-  }
-
-  // Caption is a safe default.
-  return HTCAPTION;
-}
-
-}  // namespace ash
diff --git a/ash/common/frame/frame_border_hit_test.h b/ash/common/frame/frame_border_hit_test.h
deleted file mode 100644
index 4c79cad..0000000
--- a/ash/common/frame/frame_border_hit_test.h
+++ /dev/null
@@ -1,30 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_FRAME_FRAME_BORDER_HIT_TEST_H_
-#define ASH_COMMON_FRAME_FRAME_BORDER_HIT_TEST_H_
-
-#include "ash/ash_export.h"
-
-namespace gfx {
-class Point;
-}
-
-namespace views {
-class NonClientFrameView;
-}
-
-namespace ash {
-
-class FrameCaptionButtonContainerView;
-
-// Returns the HitTestCompat for the specified point.
-ASH_EXPORT int FrameBorderNonClientHitTest(
-    views::NonClientFrameView* view,
-    FrameCaptionButtonContainerView* caption_button_container,
-    const gfx::Point& point_in_widget);
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_FRAME_FRAME_BORDER_HIT_TEST_H_
diff --git a/ash/common/frame/header_painter.h b/ash/common/frame/header_painter.h
deleted file mode 100644
index f60d62f..0000000
--- a/ash/common/frame/header_painter.h
+++ /dev/null
@@ -1,47 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_FRAME_HEADER_PAINTER_H_
-#define ASH_COMMON_FRAME_HEADER_PAINTER_H_
-
-#include "ash/ash_export.h"
-
-namespace gfx {
-class Canvas;
-}
-
-namespace ash {
-
-// Helper class for painting the window header.
-class ASH_EXPORT HeaderPainter {
- public:
-  enum Mode { MODE_ACTIVE, MODE_INACTIVE };
-
-  virtual ~HeaderPainter() {}
-
-  // Returns the header's minimum width.
-  virtual int GetMinimumHeaderWidth() const = 0;
-
-  // Paints the header.
-  virtual void PaintHeader(gfx::Canvas* canvas, Mode mode) = 0;
-
-  // Performs layout for the header.
-  virtual void LayoutHeader() = 0;
-
-  // Get the height of the header.
-  virtual int GetHeaderHeight() const = 0;
-
-  // Gets / sets how much of the header is painted. This allows the header to
-  // paint under things (like the tabstrip) which have transparent /
-  // non-painting sections. This height does not affect LayoutHeader().
-  virtual int GetHeaderHeightForPainting() const = 0;
-  virtual void SetHeaderHeightForPainting(int height_for_painting) = 0;
-
-  // Schedule a re-paint of the entire title.
-  virtual void SchedulePaintForTitle() = 0;
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_FRAME_HEADER_PAINTER_H_
diff --git a/ash/common/frame/header_painter_util.cc b/ash/common/frame/header_painter_util.cc
deleted file mode 100644
index dfd5454..0000000
--- a/ash/common/frame/header_painter_util.cc
+++ /dev/null
@@ -1,98 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ash/common/frame/header_painter_util.h"
-
-#include <algorithm>
-
-#include "ash/common/wm_lookup.h"
-#include "ash/common/wm_window.h"
-#include "ui/compositor/layer.h"
-#include "ui/compositor/layer_animator.h"
-#include "ui/gfx/font_list.h"
-#include "ui/gfx/geometry/rect.h"
-#include "ui/views/view.h"
-#include "ui/views/widget/widget.h"
-
-namespace {
-
-// Radius of the header's top corners when the window is restored.
-const int kTopCornerRadiusWhenRestored = 2;
-
-// Distance between left edge of the window and the leftmost view.
-const int kLeftViewXInset = 9;
-
-// Space between the title text and the caption buttons.
-const int kTitleCaptionButtonSpacing = 5;
-
-// Space between window icon and title text.
-const int kTitleIconOffsetX = 5;
-
-// Space between window edge and title text, when there is no icon.
-const int kTitleNoIconOffsetX = 8;
-
-// In the pre-Ash era the web content area had a frame along the left edge, so
-// user-generated theme images for the new tab page assume they are shifted
-// right relative to the header.  Now that we have removed the left edge frame
-// we need to copy the theme image for the window header from a few pixels
-// inset to preserve alignment with the NTP image, or else we'll break a bunch
-// of existing themes.  We do something similar on OS X for the same reason.
-const int kThemeFrameImageInsetX = 5;
-
-}  // namespace
-
-namespace ash {
-
-// static
-int HeaderPainterUtil::GetTopCornerRadiusWhenRestored() {
-  return kTopCornerRadiusWhenRestored;
-}
-
-// static
-int HeaderPainterUtil::GetLeftViewXInset() {
-  return kLeftViewXInset;
-}
-
-// static
-int HeaderPainterUtil::GetThemeBackgroundXInset() {
-  return kThemeFrameImageInsetX;
-}
-
-// static
-gfx::Rect HeaderPainterUtil::GetTitleBounds(
-    const views::View* left_view,
-    const views::View* right_view,
-    const gfx::FontList& title_font_list) {
-  int x = left_view ? left_view->bounds().right() + kTitleIconOffsetX
-                    : kTitleNoIconOffsetX;
-  int height = title_font_list.GetHeight();
-  // Floor when computing the center of |caption_button_container| and when
-  // computing the center of the text.
-  int y = std::max(0, (right_view->height() / 2) - (height / 2));
-  int width = std::max(0, right_view->x() - kTitleCaptionButtonSpacing - x);
-  return gfx::Rect(x, y, width, height);
-}
-
-// static
-bool HeaderPainterUtil::CanAnimateActivation(views::Widget* widget) {
-  // Do not animate the header if the parent (e.g.
-  // kShellWindowId_DefaultContainer) is already animating. All of the
-  // implementers of HeaderPainter animate activation by continuously painting
-  // during the animation. This gives the parent's animation a slower frame
-  // rate.
-  // TODO(sky): Expose a better way to determine this rather than assuming the
-  // parent is a toplevel container.
-  WmWindow* window = WmLookup::Get()->GetWindowForWidget(widget);
-  if (!window || !window->GetParent())
-    return true;
-
-  ui::LayerAnimator* parent_layer_animator =
-      window->GetParent()->GetLayer()->GetAnimator();
-  return !parent_layer_animator->IsAnimatingProperty(
-             ui::LayerAnimationElement::OPACITY) &&
-         !parent_layer_animator->IsAnimatingProperty(
-             ui::LayerAnimationElement::VISIBILITY);
-}
-
-}  // namespace ash
diff --git a/ash/common/frame/header_painter_util.h b/ash/common/frame/header_painter_util.h
deleted file mode 100644
index 71c42ad..0000000
--- a/ash/common/frame/header_painter_util.h
+++ /dev/null
@@ -1,55 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_FRAME_HEADER_PAINTER_UTIL_H_
-#define ASH_COMMON_FRAME_HEADER_PAINTER_UTIL_H_
-
-#include "ash/ash_export.h"
-#include "base/macros.h"
-
-namespace gfx {
-class FontList;
-class Rect;
-}
-namespace views {
-class View;
-class Widget;
-}
-
-namespace ash {
-
-// Static-only helper class for functionality used accross multiple
-// implementations of HeaderPainter.
-class ASH_EXPORT HeaderPainterUtil {
- public:
-  // Returns the radius of the header's corners when the window is restored.
-  static int GetTopCornerRadiusWhenRestored();
-
-  // Returns the default distance between the left edge of the window and the
-  // leftmost view in the header.
-  static int GetLeftViewXInset();
-
-  // Returns the amount that the frame background is inset from the left edge of
-  // the window.
-  static int GetThemeBackgroundXInset();
-
-  // Returns the bounds for the header's title given the views to the left and
-  // right of the title, and the font used.
-  // |left_view| should be NULL if there is no view to the left of the title.
-  static gfx::Rect GetTitleBounds(const views::View* left_view,
-                                  const views::View* right_view,
-                                  const gfx::FontList& title_font_list);
-
-  // Returns true if the header for |widget| can animate to new visuals when the
-  // widget's activation changes. Returns false if the header should switch to
-  // new visuals instantaneously.
-  static bool CanAnimateActivation(views::Widget* widget);
-
- private:
-  DISALLOW_IMPLICIT_CONSTRUCTORS(HeaderPainterUtil);
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_FRAME_HEADER_PAINTER_UTIL_H_
diff --git a/ash/common/metrics/gesture_action_type.h b/ash/common/metrics/gesture_action_type.h
deleted file mode 100644
index feee85a..0000000
--- a/ash/common/metrics/gesture_action_type.h
+++ /dev/null
@@ -1,40 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_METRICS_GESTURE_ACTION_TYPE_H_
-#define ASH_COMMON_METRICS_GESTURE_ACTION_TYPE_H_
-
-namespace ash {
-
-enum GestureActionType {
-  GESTURE_UNKNOWN,
-  GESTURE_OMNIBOX_PINCH,
-  GESTURE_OMNIBOX_SCROLL,
-  GESTURE_TABSTRIP_PINCH,
-  GESTURE_TABSTRIP_SCROLL,
-  GESTURE_BEZEL_SCROLL,
-  GESTURE_DESKTOP_SCROLL,
-  GESTURE_DESKTOP_PINCH,
-  GESTURE_WEBPAGE_PINCH,
-  GESTURE_WEBPAGE_SCROLL,
-  GESTURE_WEBPAGE_TAP,
-  GESTURE_TABSTRIP_TAP,
-  GESTURE_BEZEL_DOWN,
-  GESTURE_TABSWITCH_TAP,
-  GESTURE_TABNOSWITCH_TAP,
-  GESTURE_TABCLOSE_TAP,
-  GESTURE_NEWTAB_TAP,
-  GESTURE_ROOTVIEWTOP_TAP,
-  GESTURE_FRAMEMAXIMIZE_TAP,
-  GESTURE_FRAMEVIEW_TAP,
-  GESTURE_MAXIMIZE_DOUBLETAP,
-  // NOTE: Add new action types only immediately above this line. Also,
-  // make sure the enum list in tools/histogram/histograms.xml is
-  // updated with any change in here.
-  GESTURE_ACTION_COUNT
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_METRICS_GESTURE_ACTION_TYPE_H_
diff --git a/ash/common/palette_delegate.h b/ash/common/palette_delegate.h
deleted file mode 100644
index e167751..0000000
--- a/ash/common/palette_delegate.h
+++ /dev/null
@@ -1,27 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_PALETTE_DELEGATE_H_
-#define ASH_COMMON_PALETTE_DELEGATE_H_
-
-#include "ash/ash_export.h"
-#include "base/macros.h"
-
-namespace ash {
-
-// This delegate allows the UI code in ash, e.g. |PaletteTray|, to perform
-// Chrome-specific actions.
-class PaletteDelegate {
- public:
-  virtual ~PaletteDelegate() {}
-
-  // TODO(jdufault): This delegate will be implemented in later CLs.
-
- private:
-  DISALLOW_ASSIGN(PaletteDelegate);
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_PALETTE_DELEGATE_H_
diff --git a/ash/common/shell_delegate.h b/ash/common/shell_delegate.h
index 08551f0..a4c32c4 100644
--- a/ash/common/shell_delegate.h
+++ b/ash/common/shell_delegate.h
@@ -41,7 +41,6 @@ class AccessibilityDelegate;
 class GPUSupport;
 class MediaDelegate;
 class NewWindowDelegate;
-class PaletteDelegate;
 class PointerWatcherDelegate;
 class SessionStateDelegate;
 class ShelfDelegate;
@@ -124,8 +123,6 @@ class ASH_EXPORT ShellDelegate {
   // Creates a media delegate. Shell takes ownership of the delegate.
   virtual MediaDelegate* CreateMediaDelegate() = 0;
 
-  virtual std::unique_ptr<PaletteDelegate> CreatePaletteDelegate() = 0;
-
   virtual std::unique_ptr<PointerWatcherDelegate>
   CreatePointerWatcherDelegate() = 0;
 
diff --git a/ash/common/system/chromeos/network/tray_sms.cc b/ash/common/system/chromeos/network/tray_sms.cc
index 25c9030..95c6151 100644
--- a/ash/common/system/chromeos/network/tray_sms.cc
+++ b/ash/common/system/chromeos/network/tray_sms.cc
@@ -411,7 +411,7 @@ void TraySms::Update(bool notify) {
     if (default_)
       default_->SetVisible(false);
     if (detailed_)
-      HideDetailedView(true /* animate */);
+      HideDetailedView();
     HideNotificationView();
   } else {
     if (default_) {
diff --git a/ash/common/system/tray/system_tray.cc b/ash/common/system/tray/system_tray.cc
index 75a6b09..979e3a1 100644
--- a/ash/common/system/tray/system_tray.cc
+++ b/ash/common/system/tray/system_tray.cc
@@ -42,7 +42,6 @@
 #include "ui/views/layout/box_layout.h"
 #include "ui/views/layout/fill_layout.h"
 #include "ui/views/view.h"
-#include "ui/views/widget/widget.h"
 
 #if defined(OS_CHROMEOS)
 #include "ash/common/system/chromeos/audio/tray_audio_chromeos.h"
@@ -130,7 +129,6 @@ SystemTray::SystemTray(WmShelf* wm_shelf)
       hide_notifications_(false),
       full_system_tray_menu_(false),
       tray_accessibility_(nullptr),
-      tray_audio_(nullptr),
       tray_cast_(nullptr),
       tray_date_(nullptr),
       tray_update_(nullptr),
@@ -208,8 +206,7 @@ void SystemTray::CreateItems(SystemTrayDelegate* delegate) {
   screen_share_tray_item_ = new ScreenShareTrayItem(this);
   AddTrayItem(screen_share_tray_item_);
   AddTrayItem(new MultiProfileMediaTrayItem(this));
-  tray_audio_ = new TrayAudioChromeOs(this);
-  AddTrayItem(tray_audio_);
+  AddTrayItem(new TrayAudioChromeOs(this));
   AddTrayItem(new TrayBrightness(this));
   AddTrayItem(new TrayCapsLock(this));
   // TODO(jamescook): Remove this when mus has support for display management
@@ -280,21 +277,9 @@ void SystemTray::SetDetailedViewCloseDelay(int close_delay) {
     system_bubble_->bubble()->StartAutoCloseTimer(close_delay);
 }
 
-void SystemTray::HideDetailedView(SystemTrayItem* item, bool animate) {
+void SystemTray::HideDetailedView(SystemTrayItem* item) {
   if (item != detailed_item_)
     return;
-
-  if (!animate) {
-    // In unittest, GetSystemBubble might return nullptr.
-    if (GetSystemBubble()) {
-      GetSystemBubble()
-          ->bubble_view()
-          ->GetWidget()
-          ->SetVisibilityAnimationTransition(
-              views::Widget::VisibilityTransition::ANIMATE_NONE);
-    }
-  }
-
   DestroySystemBubble();
   UpdateNotificationBubble();
 }
@@ -387,10 +372,6 @@ views::View* SystemTray::GetHelpButtonView() const {
   return tray_date_->GetHelpButtonView();
 }
 
-TrayAudio* SystemTray::GetTrayAudio() const {
-  return tray_audio_;
-}
-
 bool SystemTray::CloseNotificationBubbleForTest() const {
   if (!notification_bubble_)
     return false;
diff --git a/ash/common/system/tray/system_tray.h b/ash/common/system/tray/system_tray.h
index 6d08ceb..9029cb1 100644
--- a/ash/common/system/tray/system_tray.h
+++ b/ash/common/system/tray/system_tray.h
@@ -25,7 +25,6 @@ class SystemBubbleWrapper;
 class SystemTrayDelegate;
 class SystemTrayItem;
 class TrayAccessibility;
-class TrayAudio;
 class TrayCast;
 class TrayDate;
 class TrayUpdate;
@@ -75,9 +74,8 @@ class ASH_EXPORT SystemTray : public TrayBackgroundView,
   // seconds.
   void SetDetailedViewCloseDelay(int close_delay);
 
-  // Hides the detailed view for |item|. If |animate| is false, disable
-  // the hiding animation for hiding |item|.
-  void HideDetailedView(SystemTrayItem* item, bool animate);
+  // Hides the detailed view for |item|.
+  void HideDetailedView(SystemTrayItem* item);
 
   // Shows the notification view for |item|.
   void ShowNotificationView(SystemTrayItem* item);
@@ -123,9 +121,6 @@ class ASH_EXPORT SystemTray : public TrayBackgroundView,
   // otherwise.
   views::View* GetHelpButtonView() const;
 
-  // Returns TrayAudio object if present or null otherwise.
-  TrayAudio* GetTrayAudio() const;
-
   // Accessors for testing.
 
   // Returns true if the bubble exists.
@@ -252,9 +247,7 @@ class ASH_EXPORT SystemTray : public TrayBackgroundView,
   // Note that the value is only valid when |system_bubble_| is true.
   bool full_system_tray_menu_;
 
-  // These objects are not owned by this class.
-  TrayAccessibility* tray_accessibility_;
-  TrayAudio* tray_audio_;  // May be null.
+  TrayAccessibility* tray_accessibility_;  // not owned
   TrayCast* tray_cast_;
   TrayDate* tray_date_;
   TrayUpdate* tray_update_;
diff --git a/ash/common/system/tray/system_tray_item.cc b/ash/common/system/tray/system_tray_item.cc
index 6b92f83..59902be 100644
--- a/ash/common/system/tray/system_tray_item.cc
+++ b/ash/common/system/tray/system_tray_item.cc
@@ -57,8 +57,8 @@ void SystemTrayItem::SetDetailedViewCloseDelay(int for_seconds) {
   system_tray()->SetDetailedViewCloseDelay(for_seconds);
 }
 
-void SystemTrayItem::HideDetailedView(bool animate) {
-  system_tray()->HideDetailedView(this, animate);
+void SystemTrayItem::HideDetailedView() {
+  system_tray()->HideDetailedView(this);
 }
 
 void SystemTrayItem::ShowNotificationView() {
diff --git a/ash/common/system/tray/system_tray_item.h b/ash/common/system/tray/system_tray_item.h
index b83c2df..4925f6a 100644
--- a/ash/common/system/tray/system_tray_item.h
+++ b/ash/common/system/tray/system_tray_item.h
@@ -121,9 +121,8 @@ class ASH_EXPORT SystemTrayItem {
   // currently-shown view is for this item.
   void SetDetailedViewCloseDelay(int for_seconds);
 
-  // Hides the detailed view for this item. Disable hiding animation if
-  // |animate| is false.
-  void HideDetailedView(bool animate);
+  // Hides the detailed view for this item.
+  void HideDetailedView();
 
   // Shows a notification for this item.
   void ShowNotificationView();
diff --git a/ash/common/wm/wm_screen_util.cc b/ash/common/wm/wm_screen_util.cc
index fdc7396..92a268f 100644
--- a/ash/common/wm/wm_screen_util.cc
+++ b/ash/common/wm/wm_screen_util.cc
@@ -5,11 +5,8 @@
 #include "ash/common/wm/wm_screen_util.h"
 
 #include "ash/common/wm_root_window_controller.h"
-#include "ash/common/wm_shell.h"
 #include "ash/common/wm_window.h"
 #include "ui/display/display.h"
-#include "ui/display/screen.h"
-#include "ui/gfx/geometry/size_conversions.h"
 
 namespace ash {
 namespace wm {
@@ -35,17 +32,5 @@ gfx::Rect GetMaximizedWindowBoundsInParent(WmWindow* window) {
   return GetDisplayBoundsInParent(window);
 }
 
-gfx::Rect GetDisplayBoundsWithShelf(WmWindow* window) {
-  if (WmShell::Get()->IsInUnifiedMode()) {
-    // In unified desktop mode, there is only one shelf in the first display.
-    gfx::SizeF size(WmShell::Get()->GetFirstDisplay().size());
-    float scale = window->GetRootWindow()->GetBounds().height() / size.height();
-    size.Scale(scale, scale);
-    return gfx::Rect(gfx::ToCeiledSize(size));
-  }
-
-  return window->GetRootWindow()->GetBounds();
-}
-
 }  // namespace wm
 }  // namespace ash
diff --git a/ash/common/wm/wm_screen_util.h b/ash/common/wm/wm_screen_util.h
index 6dcfc16..6ba858a 100644
--- a/ash/common/wm/wm_screen_util.h
+++ b/ash/common/wm/wm_screen_util.h
@@ -22,12 +22,6 @@ ASH_EXPORT gfx::Rect GetDisplayWorkAreaBounds(WmWindow* window);
 ASH_EXPORT gfx::Rect GetDisplayBoundsInParent(WmWindow* window);
 ASH_EXPORT gfx::Rect GetMaximizedWindowBoundsInParent(WmWindow* window);
 
-// Returns the bounds of the physical display containing the shelf for |window|.
-// Physical displays can differ from logical displays in unified desktop mode.
-// TODO(oshima): Consider using physical displays in window layout, instead of
-// root windows, and only use logical display in display management code.
-ASH_EXPORT gfx::Rect GetDisplayBoundsWithShelf(WmWindow* window);
-
 }  // namespace wm
 }  // namespace ash
 
diff --git a/ash/common/wm_shell.cc b/ash/common/wm_shell.cc
index 6d629cb..b6a269c 100644
--- a/ash/common/wm_shell.cc
+++ b/ash/common/wm_shell.cc
@@ -12,7 +12,6 @@
 #include "ash/common/focus_cycler.h"
 #include "ash/common/keyboard/keyboard_ui.h"
 #include "ash/common/new_window_delegate.h"
-#include "ash/common/palette_delegate.h"
 #include "ash/common/session/session_state_delegate.h"
 #include "ash/common/shelf/app_list_shelf_item_delegate.h"
 #include "ash/common/shelf/shelf_delegate.h"
@@ -62,7 +61,6 @@ void WmShell::Initialize() {
   // instead of the WmShell constructor.
   accessibility_delegate_.reset(delegate_->CreateAccessibilityDelegate());
   media_delegate_.reset(delegate_->CreateMediaDelegate());
-  palette_delegate_ = delegate_->CreatePaletteDelegate();
   toast_manager_.reset(new ToastManager);
 
   // Create the app list item in the shelf data model.
diff --git a/ash/common/wm_shell.h b/ash/common/wm_shell.h
index 0f029eb..a679e0f 100644
--- a/ash/common/wm_shell.h
+++ b/ash/common/wm_shell.h
@@ -12,16 +12,11 @@
 
 #include "ash/ash_export.h"
 #include "ash/common/media_delegate.h"
-#include "ash/common/metrics/gesture_action_type.h"
 #include "ash/common/metrics/user_metrics_action.h"
 #include "ash/common/wm/lock_state_observer.h"
 #include "base/observer_list.h"
 #include "ui/base/ui_base_types.h"
 
-namespace display {
-class Display;
-}
-
 namespace gfx {
 class Point;
 }
@@ -42,7 +37,6 @@ class KeyboardUI;
 class MaximizeModeController;
 class MruWindowTracker;
 class NewWindowDelegate;
-class PaletteDelegate;
 class ScopedDisableInternalMouseAndKeyboard;
 class SessionStateDelegate;
 class ShelfDelegate;
@@ -123,8 +117,6 @@ class ASH_EXPORT WmShell {
     root_window_for_new_windows_ = root;
   }
 
-  PaletteDelegate* palette_delegate() { return palette_delegate_.get(); }
-
   ShelfDelegate* shelf_delegate() { return shelf_delegate_.get(); }
 
   ShelfModel* shelf_model() { return shelf_model_.get(); }
@@ -166,22 +158,13 @@ class ASH_EXPORT WmShell {
   WmWindow* GetRootWindowForNewWindows();
 
   // Retuns the display info associated with |display_id|.
-  // TODO(mash): Remove when DisplayManager has been moved. crbug.com/622480
+  // TODO(msw): Remove this when DisplayManager has been moved. crbug.com/622480
   virtual const DisplayInfo& GetDisplayInfo(int64_t display_id) const = 0;
 
   // Matches that of DisplayManager::IsActiveDisplayId().
-  // TODO(mash): Remove when DisplayManager has been moved. crbug.com/622480
+  // TODO: Remove this when DisplayManager has been moved. crbug.com/622480
   virtual bool IsActiveDisplayId(int64_t display_id) const = 0;
 
-  // Returns true if the desktop is in unified mode.
-  // TODO(mash): Remove when DisplayManager has been moved. crbug.com/622480
-  virtual bool IsInUnifiedMode() const = 0;
-
-  // Returns the first display; this is the first display listed by hardware,
-  // which corresponds to internal displays on devices with integrated displays.
-  // TODO(mash): Remove when DisplayManager has been moved. crbug.com/622480
-  virtual display::Display GetFirstDisplay() const = 0;
-
   // Returns true if the first window shown on first run should be
   // unconditionally maximized, overriding the heuristic that normally chooses
   // the window size.
@@ -235,7 +218,6 @@ class ASH_EXPORT WmShell {
 
   virtual std::vector<WmWindow*> GetAllRootWindows() = 0;
 
-  virtual void RecordGestureAction(GestureActionType action) = 0;
   virtual void RecordUserMetricsAction(UserMetricsAction action) = 0;
   virtual void RecordTaskSwitchMetric(TaskSwitchSource source) = 0;
 
@@ -303,9 +285,6 @@ class ASH_EXPORT WmShell {
 
   void SetShelfDelegateForTesting(std::unique_ptr<ShelfDelegate> test_delegate);
 
-  // True if any touch points are down.
-  virtual bool IsTouchDown() = 0;
-
 #if defined(OS_CHROMEOS)
   LogoutConfirmationController* logout_confirmation_controller() {
     return logout_confirmation_controller_.get();
@@ -368,7 +347,6 @@ class ASH_EXPORT WmShell {
   std::unique_ptr<MediaDelegate> media_delegate_;
   std::unique_ptr<MruWindowTracker> mru_window_tracker_;
   std::unique_ptr<NewWindowDelegate> new_window_delegate_;
-  std::unique_ptr<PaletteDelegate> palette_delegate_;
   std::unique_ptr<ShelfDelegate> shelf_delegate_;
   std::unique_ptr<ShelfModel> shelf_model_;
   std::unique_ptr<ShelfWindowWatcher> shelf_window_watcher_;
diff --git a/ash/common/wm_transient_window_observer.h b/ash/common/wm_transient_window_observer.h
deleted file mode 100644
index c49ed27..0000000
--- a/ash/common/wm_transient_window_observer.h
+++ /dev/null
@@ -1,25 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef ASH_COMMON_WM_TRANSIENT_WINDOW_OBSERVER_H_
-#define ASH_COMMON_WM_TRANSIENT_WINDOW_OBSERVER_H_
-
-#include "ash/ash_export.h"
-
-namespace ash {
-
-class WmWindow;
-
-class ASH_EXPORT WmTransientWindowObserver {
- public:
-  virtual void OnTransientChildAdded(WmWindow* window, WmWindow* transient) {}
-  virtual void OnTransientChildRemoved(WmWindow* window, WmWindow* transient) {}
-
- protected:
-  virtual ~WmTransientWindowObserver() {}
-};
-
-}  // namespace ash
-
-#endif  // ASH_COMMON_WM_TRANSIENT_WINDOW_OBSERVER_H_
diff --git a/ash/common/wm_window.h b/ash/common/wm_window.h
index a5670e9..6e600ec 100644
--- a/ash/common/wm_window.h
+++ b/ash/common/wm_window.h
@@ -43,7 +43,6 @@ struct ShelfItemDetails;
 class WmLayoutManager;
 class WmRootWindowController;
 class WmShell;
-class WmTransientWindowObserver;
 class WmWindowObserver;
 enum class WmWindowProperty;
 
@@ -86,8 +85,6 @@ class ASH_EXPORT WmWindow {
 
   virtual ui::wm::WindowType GetType() const = 0;
 
-  virtual bool IsBubble() = 0;
-
   // TODO(sky): seems like this shouldn't be exposed.
   virtual ui::Layer* GetLayer() = 0;
 
@@ -294,11 +291,6 @@ class ASH_EXPORT WmWindow {
   virtual void RemoveObserver(WmWindowObserver* observer) = 0;
   virtual bool HasObserver(const WmWindowObserver* observer) const = 0;
 
-  virtual void AddTransientWindowObserver(
-      WmTransientWindowObserver* observer) = 0;
-  virtual void RemoveTransientWindowObserver(
-      WmTransientWindowObserver* observer) = 0;
-
   // Adds or removes a handler to receive events targeted at this window, before
   // this window handles the events itself; the handler does not recieve events
   // from embedded windows. This only supports windows with internal widgets;
diff --git a/ash/display/display_change_observer_chromeos.cc b/ash/display/display_change_observer_chromeos.cc
index 4014566..a6521ef 100644
--- a/ash/display/display_change_observer_chromeos.cc
+++ b/ash/display/display_change_observer_chromeos.cc
@@ -12,6 +12,7 @@
 #include <vector>
 
 #include "ash/common/ash_switches.h"
+#include "ash/common/display/display_info.h"
 #include "ash/common/wm_shell.h"
 #include "ash/display/display_layout_store.h"
 #include "ash/display/display_manager.h"
@@ -75,34 +76,32 @@ void UpdateInternalDisplayId(
 }  // namespace
 
 // static
-DisplayInfo::DisplayModeList DisplayChangeObserver::GetInternalDisplayModeList(
+std::vector<DisplayMode> DisplayChangeObserver::GetInternalDisplayModeList(
     const DisplayInfo& display_info,
     const ui::DisplaySnapshot& output) {
   const ui::DisplayMode* ui_native_mode = output.native_mode();
-  scoped_refptr<DisplayMode> native_mode =
-      new DisplayMode(ui_native_mode->size(), ui_native_mode->refresh_rate(),
-                      ui_native_mode->is_interlaced(), true, 1.0,
-                      display_info.device_scale_factor());
+  DisplayMode native_mode(ui_native_mode->size(),
+                          ui_native_mode->refresh_rate(),
+                          ui_native_mode->is_interlaced(), true);
+  native_mode.device_scale_factor = display_info.device_scale_factor();
 
   return CreateInternalDisplayModeList(native_mode);
 }
 
 // static
-DisplayInfo::DisplayModeList DisplayChangeObserver::GetExternalDisplayModeList(
+std::vector<DisplayMode> DisplayChangeObserver::GetExternalDisplayModeList(
     const ui::DisplaySnapshot& output) {
-  using DisplayModeMap =
-      std::map<std::pair<int, int>, scoped_refptr<DisplayMode>>;
+  typedef std::map<std::pair<int, int>, DisplayMode> DisplayModeMap;
   DisplayModeMap display_mode_map;
 
-  scoped_refptr<DisplayMode> native_mode = new DisplayMode();
+  DisplayMode native_mode;
   for (const auto& mode_info : output.modes()) {
     const std::pair<int, int> size(mode_info->size().width(),
                                    mode_info->size().height());
-    scoped_refptr<DisplayMode> display_mode =
-        new DisplayMode(mode_info->size(), mode_info->refresh_rate(),
-                        mode_info->is_interlaced(),
-                        output.native_mode() == mode_info.get(), 1.0, 1.0);
-    if (display_mode->native())
+    const DisplayMode display_mode(mode_info->size(), mode_info->refresh_rate(),
+                                   mode_info->is_interlaced(),
+                                   output.native_mode() == mode_info.get());
+    if (display_mode.native)
       native_mode = display_mode;
 
     // Add the display mode if it isn't already present and override interlaced
@@ -110,33 +109,31 @@ DisplayInfo::DisplayModeList DisplayChangeObserver::GetExternalDisplayModeList(
     DisplayModeMap::iterator display_mode_it = display_mode_map.find(size);
     if (display_mode_it == display_mode_map.end())
       display_mode_map.insert(std::make_pair(size, display_mode));
-    else if (display_mode_it->second->is_interlaced() &&
-             !display_mode->is_interlaced())
-      display_mode_it->second = std::move(display_mode);
+    else if (display_mode_it->second.interlaced && !display_mode.interlaced)
+      display_mode_it->second = display_mode;
   }
 
-  DisplayInfo::DisplayModeList display_mode_list;
+  std::vector<DisplayMode> display_mode_list;
   for (const auto& display_mode_pair : display_mode_map)
-    display_mode_list.push_back(std::move(display_mode_pair.second));
+    display_mode_list.push_back(display_mode_pair.second);
 
   if (output.native_mode()) {
-    const std::pair<int, int> size(native_mode->size().width(),
-                                   native_mode->size().height());
+    const std::pair<int, int> size(native_mode.size.width(),
+                                   native_mode.size.height());
     DisplayModeMap::iterator it = display_mode_map.find(size);
     DCHECK(it != display_mode_map.end())
         << "Native mode must be part of the mode list.";
 
     // If the native mode was replaced re-add it.
-    if (!it->second->native())
+    if (!it->second.native)
       display_mode_list.push_back(native_mode);
   }
 
-  if (native_mode->size().width() >= kMinimumWidthFor4K) {
+  if (native_mode.size.width() >= kMinimumWidthFor4K) {
     for (size_t i = 0; i < arraysize(kAdditionalDeviceScaleFactorsFor4k); ++i) {
-      scoped_refptr<DisplayMode> mode = new DisplayMode(
-          native_mode->size(), native_mode->refresh_rate(),
-          native_mode->is_interlaced(), false /* native */,
-          native_mode->ui_scale(), kAdditionalDeviceScaleFactorsFor4k[i]);
+      DisplayMode mode = native_mode;
+      mode.device_scale_factor = kAdditionalDeviceScaleFactorsFor4k[i];
+      mode.native = false;
       display_mode_list.push_back(mode);
     }
   }
@@ -175,12 +172,12 @@ ui::MultipleDisplayState DisplayChangeObserver::GetStateForDisplayIds(
 
 bool DisplayChangeObserver::GetResolutionForDisplayId(int64_t display_id,
                                                       gfx::Size* size) const {
-  scoped_refptr<DisplayMode> mode =
-      Shell::GetInstance()->display_manager()->GetSelectedModeForDisplayId(
-          display_id);
-  if (!mode)
+  DisplayMode mode;
+  if (!Shell::GetInstance()->display_manager()->GetSelectedModeForDisplayId(
+          display_id, &mode))
     return false;
-  *size = mode->size();
+
+  *size = mode.size;
   return true;
 }
 
@@ -205,11 +202,10 @@ void DisplayChangeObserver::OnDisplayModeChanged(
       if (dpi)
         device_scale_factor = FindDeviceScaleFactor(dpi);
     } else {
-      scoped_refptr<DisplayMode> mode =
-          Shell::GetInstance()->display_manager()->GetSelectedModeForDisplayId(
-              state->display_id());
-      if (mode) {
-        device_scale_factor = mode->device_scale_factor();
+      DisplayMode mode;
+      if (Shell::GetInstance()->display_manager()->GetSelectedModeForDisplayId(
+              state->display_id(), &mode)) {
+        device_scale_factor = mode.device_scale_factor;
       } else {
         // For monitors that are 40 inches and 4K or above, set
         // |device_scale_factor| to 2x. For margin purposes, 100 is subtracted
@@ -258,7 +254,7 @@ void DisplayChangeObserver::OnDisplayModeChanged(
     if (dpi)
       new_info.set_device_dpi(dpi);
 
-    DisplayInfo::DisplayModeList display_modes =
+    std::vector<DisplayMode> display_modes =
         (state->type() == ui::DISPLAY_CONNECTION_TYPE_INTERNAL)
             ? GetInternalDisplayModeList(new_info, *state)
             : GetExternalDisplayModeList(*state);
diff --git a/ash/display/display_change_observer_chromeos.h b/ash/display/display_change_observer_chromeos.h
index 4141e64..8d7e1d9 100644
--- a/ash/display/display_change_observer_chromeos.h
+++ b/ash/display/display_change_observer_chromeos.h
@@ -10,7 +10,6 @@
 #include <vector>
 
 #include "ash/ash_export.h"
-#include "ash/common/display/display_info.h"
 #include "ash/common/shell_observer.h"
 #include "base/macros.h"
 #include "ui/display/chromeos/display_configurator.h"
@@ -18,7 +17,8 @@
 
 namespace ash {
 
-class DisplayMode;
+class DisplayInfo;
+struct DisplayMode;
 class DisplaySnapshot;
 
 // An object that observes changes in display configuration and
@@ -29,12 +29,12 @@ class DisplayChangeObserver : public ui::DisplayConfigurator::StateController,
                               public ShellObserver {
  public:
   // Returns the mode list for internal display.
-  ASH_EXPORT static DisplayInfo::DisplayModeList GetInternalDisplayModeList(
+  ASH_EXPORT static std::vector<DisplayMode> GetInternalDisplayModeList(
       const DisplayInfo& display_info,
       const ui::DisplaySnapshot& output);
 
   // Returns the resolution list.
-  ASH_EXPORT static DisplayInfo::DisplayModeList GetExternalDisplayModeList(
+  ASH_EXPORT static std::vector<DisplayMode> GetExternalDisplayModeList(
       const ui::DisplaySnapshot& output);
 
   DisplayChangeObserver();
diff --git a/ash/display/display_change_observer_chromeos_unittest.cc b/ash/display/display_change_observer_chromeos_unittest.cc
index 4f0fdcb..50a7801 100644
--- a/ash/display/display_change_observer_chromeos_unittest.cc
+++ b/ash/display/display_change_observer_chromeos_unittest.cc
@@ -57,32 +57,32 @@ TEST_F(DisplayChangeObserverTest, GetExternalDisplayModeList) {
   ui::TestDisplaySnapshot display_snapshot;
   display_snapshot.set_modes(std::move(modes));
 
-  DisplayInfo::DisplayModeList display_modes =
+  std::vector<DisplayMode> display_modes =
       DisplayChangeObserver::GetExternalDisplayModeList(display_snapshot);
   ASSERT_EQ(6u, display_modes.size());
-  EXPECT_EQ("640x480", display_modes[0]->size().ToString());
-  EXPECT_TRUE(display_modes[0]->is_interlaced());
-  EXPECT_EQ(display_modes[0]->refresh_rate(), 60);
+  EXPECT_EQ("640x480", display_modes[0].size.ToString());
+  EXPECT_TRUE(display_modes[0].interlaced);
+  EXPECT_EQ(display_modes[0].refresh_rate, 60);
 
-  EXPECT_EQ("1024x600", display_modes[1]->size().ToString());
-  EXPECT_FALSE(display_modes[1]->is_interlaced());
-  EXPECT_EQ(display_modes[1]->refresh_rate(), 70);
+  EXPECT_EQ("1024x600", display_modes[1].size.ToString());
+  EXPECT_FALSE(display_modes[1].interlaced);
+  EXPECT_EQ(display_modes[1].refresh_rate, 70);
 
-  EXPECT_EQ("1024x768", display_modes[2]->size().ToString());
-  EXPECT_TRUE(display_modes[2]->is_interlaced());
-  EXPECT_EQ(display_modes[2]->refresh_rate(), 70);
+  EXPECT_EQ("1024x768", display_modes[2].size.ToString());
+  EXPECT_TRUE(display_modes[2].interlaced);
+  EXPECT_EQ(display_modes[2].refresh_rate, 70);
 
-  EXPECT_EQ("1280x720", display_modes[3]->size().ToString());
-  EXPECT_FALSE(display_modes[3]->is_interlaced());
-  EXPECT_EQ(display_modes[3]->refresh_rate(), 60);
+  EXPECT_EQ("1280x720", display_modes[3].size.ToString());
+  EXPECT_FALSE(display_modes[3].interlaced);
+  EXPECT_EQ(display_modes[3].refresh_rate, 60);
 
-  EXPECT_EQ("1920x1080", display_modes[4]->size().ToString());
-  EXPECT_FALSE(display_modes[4]->is_interlaced());
-  EXPECT_EQ(display_modes[4]->refresh_rate(), 80);
+  EXPECT_EQ("1920x1080", display_modes[4].size.ToString());
+  EXPECT_FALSE(display_modes[4].interlaced);
+  EXPECT_EQ(display_modes[4].refresh_rate, 80);
 
-  EXPECT_EQ("1920x1200", display_modes[5]->size().ToString());
-  EXPECT_FALSE(display_modes[5]->is_interlaced());
-  EXPECT_EQ(display_modes[5]->refresh_rate(), 60);
+  EXPECT_EQ("1920x1200", display_modes[5].size.ToString());
+  EXPECT_FALSE(display_modes[5].interlaced);
+  EXPECT_EQ(display_modes[5].refresh_rate, 60);
 
   // Outputs without any modes shouldn't cause a crash.
   modes.clear();
@@ -114,33 +114,33 @@ TEST_F(DisplayChangeObserverTest, GetInternalDisplayModeList) {
   DisplayInfo info(1, "", false);
   info.SetBounds(gfx::Rect(0, 0, 1366, 768));
 
-  DisplayInfo::DisplayModeList display_modes =
+  std::vector<DisplayMode> display_modes =
       DisplayChangeObserver::GetInternalDisplayModeList(info, display_snapshot);
   ASSERT_EQ(5u, display_modes.size());
-  EXPECT_EQ("1366x768", display_modes[0]->size().ToString());
-  EXPECT_FALSE(display_modes[0]->native());
-  EXPECT_NEAR(display_modes[0]->ui_scale(), 0.5, 0.01);
-  EXPECT_EQ(display_modes[0]->refresh_rate(), 60);
-
-  EXPECT_EQ("1366x768", display_modes[1]->size().ToString());
-  EXPECT_FALSE(display_modes[1]->native());
-  EXPECT_NEAR(display_modes[1]->ui_scale(), 0.6, 0.01);
-  EXPECT_EQ(display_modes[1]->refresh_rate(), 60);
-
-  EXPECT_EQ("1366x768", display_modes[2]->size().ToString());
-  EXPECT_FALSE(display_modes[2]->native());
-  EXPECT_NEAR(display_modes[2]->ui_scale(), 0.75, 0.01);
-  EXPECT_EQ(display_modes[2]->refresh_rate(), 60);
-
-  EXPECT_EQ("1366x768", display_modes[3]->size().ToString());
-  EXPECT_TRUE(display_modes[3]->native());
-  EXPECT_NEAR(display_modes[3]->ui_scale(), 1.0, 0.01);
-  EXPECT_EQ(display_modes[3]->refresh_rate(), 60);
-
-  EXPECT_EQ("1366x768", display_modes[4]->size().ToString());
-  EXPECT_FALSE(display_modes[4]->native());
-  EXPECT_NEAR(display_modes[4]->ui_scale(), 1.125, 0.01);
-  EXPECT_EQ(display_modes[4]->refresh_rate(), 60);
+  EXPECT_EQ("1366x768", display_modes[0].size.ToString());
+  EXPECT_FALSE(display_modes[0].native);
+  EXPECT_NEAR(display_modes[0].ui_scale, 0.5, 0.01);
+  EXPECT_EQ(display_modes[0].refresh_rate, 60);
+
+  EXPECT_EQ("1366x768", display_modes[1].size.ToString());
+  EXPECT_FALSE(display_modes[1].native);
+  EXPECT_NEAR(display_modes[1].ui_scale, 0.6, 0.01);
+  EXPECT_EQ(display_modes[1].refresh_rate, 60);
+
+  EXPECT_EQ("1366x768", display_modes[2].size.ToString());
+  EXPECT_FALSE(display_modes[2].native);
+  EXPECT_NEAR(display_modes[2].ui_scale, 0.75, 0.01);
+  EXPECT_EQ(display_modes[2].refresh_rate, 60);
+
+  EXPECT_EQ("1366x768", display_modes[3].size.ToString());
+  EXPECT_TRUE(display_modes[3].native);
+  EXPECT_NEAR(display_modes[3].ui_scale, 1.0, 0.01);
+  EXPECT_EQ(display_modes[3].refresh_rate, 60);
+
+  EXPECT_EQ("1366x768", display_modes[4].size.ToString());
+  EXPECT_FALSE(display_modes[4].native);
+  EXPECT_NEAR(display_modes[4].ui_scale, 1.125, 0.01);
+  EXPECT_EQ(display_modes[4].refresh_rate, 60);
 }
 
 TEST_F(DisplayChangeObserverTest, GetInternalHiDPIDisplayModeList) {
@@ -161,48 +161,48 @@ TEST_F(DisplayChangeObserverTest, GetInternalHiDPIDisplayModeList) {
   info.SetBounds(gfx::Rect(0, 0, 2560, 1700));
   info.set_device_scale_factor(2.0f);
 
-  DisplayInfo::DisplayModeList display_modes =
+  std::vector<DisplayMode> display_modes =
       DisplayChangeObserver::GetInternalDisplayModeList(info, display_snapshot);
   ASSERT_EQ(8u, display_modes.size());
-  EXPECT_EQ("2560x1700", display_modes[0]->size().ToString());
-  EXPECT_FALSE(display_modes[0]->native());
-  EXPECT_NEAR(display_modes[0]->ui_scale(), 0.5, 0.01);
-  EXPECT_EQ(display_modes[0]->refresh_rate(), 60);
-
-  EXPECT_EQ("2560x1700", display_modes[1]->size().ToString());
-  EXPECT_FALSE(display_modes[1]->native());
-  EXPECT_NEAR(display_modes[1]->ui_scale(), 0.625, 0.01);
-  EXPECT_EQ(display_modes[1]->refresh_rate(), 60);
-
-  EXPECT_EQ("2560x1700", display_modes[2]->size().ToString());
-  EXPECT_FALSE(display_modes[2]->native());
-  EXPECT_NEAR(display_modes[2]->ui_scale(), 0.8, 0.01);
-  EXPECT_EQ(display_modes[2]->refresh_rate(), 60);
-
-  EXPECT_EQ("2560x1700", display_modes[3]->size().ToString());
-  EXPECT_FALSE(display_modes[3]->native());
-  EXPECT_NEAR(display_modes[3]->ui_scale(), 1.0, 0.01);
-  EXPECT_EQ(display_modes[3]->refresh_rate(), 60);
-
-  EXPECT_EQ("2560x1700", display_modes[4]->size().ToString());
-  EXPECT_FALSE(display_modes[4]->native());
-  EXPECT_NEAR(display_modes[4]->ui_scale(), 1.125, 0.01);
-  EXPECT_EQ(display_modes[4]->refresh_rate(), 60);
-
-  EXPECT_EQ("2560x1700", display_modes[5]->size().ToString());
-  EXPECT_FALSE(display_modes[5]->native());
-  EXPECT_NEAR(display_modes[5]->ui_scale(), 1.25, 0.01);
-  EXPECT_EQ(display_modes[5]->refresh_rate(), 60);
-
-  EXPECT_EQ("2560x1700", display_modes[6]->size().ToString());
-  EXPECT_FALSE(display_modes[6]->native());
-  EXPECT_NEAR(display_modes[6]->ui_scale(), 1.5, 0.01);
-  EXPECT_EQ(display_modes[6]->refresh_rate(), 60);
-
-  EXPECT_EQ("2560x1700", display_modes[7]->size().ToString());
-  EXPECT_TRUE(display_modes[7]->native());
-  EXPECT_NEAR(display_modes[7]->ui_scale(), 2.0, 0.01);
-  EXPECT_EQ(display_modes[7]->refresh_rate(), 60);
+  EXPECT_EQ("2560x1700", display_modes[0].size.ToString());
+  EXPECT_FALSE(display_modes[0].native);
+  EXPECT_NEAR(display_modes[0].ui_scale, 0.5, 0.01);
+  EXPECT_EQ(display_modes[0].refresh_rate, 60);
+
+  EXPECT_EQ("2560x1700", display_modes[1].size.ToString());
+  EXPECT_FALSE(display_modes[1].native);
+  EXPECT_NEAR(display_modes[1].ui_scale, 0.625, 0.01);
+  EXPECT_EQ(display_modes[1].refresh_rate, 60);
+
+  EXPECT_EQ("2560x1700", display_modes[2].size.ToString());
+  EXPECT_FALSE(display_modes[2].native);
+  EXPECT_NEAR(display_modes[2].ui_scale, 0.8, 0.01);
+  EXPECT_EQ(display_modes[2].refresh_rate, 60);
+
+  EXPECT_EQ("2560x1700", display_modes[3].size.ToString());
+  EXPECT_FALSE(display_modes[3].native);
+  EXPECT_NEAR(display_modes[3].ui_scale, 1.0, 0.01);
+  EXPECT_EQ(display_modes[3].refresh_rate, 60);
+
+  EXPECT_EQ("2560x1700", display_modes[4].size.ToString());
+  EXPECT_FALSE(display_modes[4].native);
+  EXPECT_NEAR(display_modes[4].ui_scale, 1.125, 0.01);
+  EXPECT_EQ(display_modes[4].refresh_rate, 60);
+
+  EXPECT_EQ("2560x1700", display_modes[5].size.ToString());
+  EXPECT_FALSE(display_modes[5].native);
+  EXPECT_NEAR(display_modes[5].ui_scale, 1.25, 0.01);
+  EXPECT_EQ(display_modes[5].refresh_rate, 60);
+
+  EXPECT_EQ("2560x1700", display_modes[6].size.ToString());
+  EXPECT_FALSE(display_modes[6].native);
+  EXPECT_NEAR(display_modes[6].ui_scale, 1.5, 0.01);
+  EXPECT_EQ(display_modes[6].refresh_rate, 60);
+
+  EXPECT_EQ("2560x1700", display_modes[7].size.ToString());
+  EXPECT_TRUE(display_modes[7].native);
+  EXPECT_NEAR(display_modes[7].ui_scale, 2.0, 0.01);
+  EXPECT_EQ(display_modes[7].refresh_rate, 60);
 }
 
 TEST_F(DisplayChangeObserverTest, GetInternalDisplayModeList1_25) {
@@ -219,33 +219,33 @@ TEST_F(DisplayChangeObserverTest, GetInternalDisplayModeList1_25) {
   info.SetBounds(gfx::Rect(0, 0, 1920, 1080));
   info.set_device_scale_factor(1.25);
 
-  DisplayInfo::DisplayModeList display_modes =
+  std::vector<DisplayMode> display_modes =
       DisplayChangeObserver::GetInternalDisplayModeList(info, display_snapshot);
   ASSERT_EQ(5u, display_modes.size());
-  EXPECT_EQ("1920x1080", display_modes[0]->size().ToString());
-  EXPECT_FALSE(display_modes[0]->native());
-  EXPECT_NEAR(display_modes[0]->ui_scale(), 0.5, 0.01);
-  EXPECT_EQ(display_modes[0]->refresh_rate(), 60);
-
-  EXPECT_EQ("1920x1080", display_modes[1]->size().ToString());
-  EXPECT_FALSE(display_modes[1]->native());
-  EXPECT_NEAR(display_modes[1]->ui_scale(), 0.625, 0.01);
-  EXPECT_EQ(display_modes[1]->refresh_rate(), 60);
-
-  EXPECT_EQ("1920x1080", display_modes[2]->size().ToString());
-  EXPECT_FALSE(display_modes[2]->native());
-  EXPECT_NEAR(display_modes[2]->ui_scale(), 0.8, 0.01);
-  EXPECT_EQ(display_modes[2]->refresh_rate(), 60);
-
-  EXPECT_EQ("1920x1080", display_modes[3]->size().ToString());
-  EXPECT_TRUE(display_modes[3]->native());
-  EXPECT_NEAR(display_modes[3]->ui_scale(), 1.0, 0.01);
-  EXPECT_EQ(display_modes[3]->refresh_rate(), 60);
-
-  EXPECT_EQ("1920x1080", display_modes[4]->size().ToString());
-  EXPECT_FALSE(display_modes[4]->native());
-  EXPECT_NEAR(display_modes[4]->ui_scale(), 1.25, 0.01);
-  EXPECT_EQ(display_modes[4]->refresh_rate(), 60);
+  EXPECT_EQ("1920x1080", display_modes[0].size.ToString());
+  EXPECT_FALSE(display_modes[0].native);
+  EXPECT_NEAR(display_modes[0].ui_scale, 0.5, 0.01);
+  EXPECT_EQ(display_modes[0].refresh_rate, 60);
+
+  EXPECT_EQ("1920x1080", display_modes[1].size.ToString());
+  EXPECT_FALSE(display_modes[1].native);
+  EXPECT_NEAR(display_modes[1].ui_scale, 0.625, 0.01);
+  EXPECT_EQ(display_modes[1].refresh_rate, 60);
+
+  EXPECT_EQ("1920x1080", display_modes[2].size.ToString());
+  EXPECT_FALSE(display_modes[2].native);
+  EXPECT_NEAR(display_modes[2].ui_scale, 0.8, 0.01);
+  EXPECT_EQ(display_modes[2].refresh_rate, 60);
+
+  EXPECT_EQ("1920x1080", display_modes[3].size.ToString());
+  EXPECT_TRUE(display_modes[3].native);
+  EXPECT_NEAR(display_modes[3].ui_scale, 1.0, 0.01);
+  EXPECT_EQ(display_modes[3].refresh_rate, 60);
+
+  EXPECT_EQ("1920x1080", display_modes[4].size.ToString());
+  EXPECT_FALSE(display_modes[4].native);
+  EXPECT_NEAR(display_modes[4].ui_scale, 1.25, 0.01);
+  EXPECT_EQ(display_modes[4].refresh_rate, 60);
 }
 
 TEST_F(DisplayChangeObserverTest, GetExternalDisplayModeList4K) {
@@ -291,53 +291,53 @@ TEST_F(DisplayChangeObserverTest, GetExternalDisplayModeList4K) {
   display_snapshot.set_native_mode(modes[0].get());
   display_snapshot.set_modes(std::move(modes));
 
-  DisplayInfo::DisplayModeList display_modes =
+  std::vector<DisplayMode> display_modes =
       DisplayChangeObserver::GetExternalDisplayModeList(display_snapshot);
   DisplayInfo info(1, "", false);
   info.SetDisplayModes(display_modes);  // Sort as external display.
   display_modes = info.display_modes();
 
   ASSERT_EQ(9u, display_modes.size());
-  EXPECT_EQ("640x480", display_modes[0]->size().ToString());
-  EXPECT_TRUE(display_modes[0]->is_interlaced());
-  EXPECT_EQ(display_modes[0]->refresh_rate(), 60);
-
-  EXPECT_EQ("1024x600", display_modes[1]->size().ToString());
-  EXPECT_FALSE(display_modes[1]->is_interlaced());
-  EXPECT_EQ(display_modes[1]->refresh_rate(), 70);
-
-  EXPECT_EQ("1024x768", display_modes[2]->size().ToString());
-  EXPECT_TRUE(display_modes[2]->is_interlaced());
-  EXPECT_EQ(display_modes[2]->refresh_rate(), 70);
-
-  EXPECT_EQ("1280x720", display_modes[3]->size().ToString());
-  EXPECT_FALSE(display_modes[3]->is_interlaced());
-  EXPECT_EQ(display_modes[3]->refresh_rate(), 60);
-
-  EXPECT_EQ("1920x1080", display_modes[4]->size().ToString());
-  EXPECT_FALSE(display_modes[4]->is_interlaced());
-  EXPECT_EQ(display_modes[4]->refresh_rate(), 80);
-
-  EXPECT_EQ("3840x2160", display_modes[5]->size().ToString());
-  EXPECT_FALSE(display_modes[5]->is_interlaced());
-  EXPECT_FALSE(display_modes[5]->native());
-  EXPECT_EQ(display_modes[5]->refresh_rate(), 30);
-  EXPECT_EQ(display_modes[5]->device_scale_factor(), 2.0);
-
-  EXPECT_EQ("1920x1200", display_modes[6]->size().ToString());
-  EXPECT_FALSE(display_modes[6]->is_interlaced());
-  EXPECT_EQ(display_modes[6]->refresh_rate(), 60);
-
-  EXPECT_EQ("3840x2160", display_modes[7]->size().ToString());
-  EXPECT_FALSE(display_modes[7]->is_interlaced());
-  EXPECT_FALSE(display_modes[7]->native());
-  EXPECT_EQ(display_modes[7]->refresh_rate(), 30);
-  EXPECT_EQ(display_modes[7]->device_scale_factor(), 1.25);
-
-  EXPECT_EQ("3840x2160", display_modes[8]->size().ToString());
-  EXPECT_FALSE(display_modes[8]->is_interlaced());
-  EXPECT_TRUE(display_modes[8]->native());
-  EXPECT_EQ(display_modes[8]->refresh_rate(), 30);
+  EXPECT_EQ("640x480", display_modes[0].size.ToString());
+  EXPECT_TRUE(display_modes[0].interlaced);
+  EXPECT_EQ(display_modes[0].refresh_rate, 60);
+
+  EXPECT_EQ("1024x600", display_modes[1].size.ToString());
+  EXPECT_FALSE(display_modes[1].interlaced);
+  EXPECT_EQ(display_modes[1].refresh_rate, 70);
+
+  EXPECT_EQ("1024x768", display_modes[2].size.ToString());
+  EXPECT_TRUE(display_modes[2].interlaced);
+  EXPECT_EQ(display_modes[2].refresh_rate, 70);
+
+  EXPECT_EQ("1280x720", display_modes[3].size.ToString());
+  EXPECT_FALSE(display_modes[3].interlaced);
+  EXPECT_EQ(display_modes[3].refresh_rate, 60);
+
+  EXPECT_EQ("1920x1080", display_modes[4].size.ToString());
+  EXPECT_FALSE(display_modes[4].interlaced);
+  EXPECT_EQ(display_modes[4].refresh_rate, 80);
+
+  EXPECT_EQ("3840x2160", display_modes[5].size.ToString());
+  EXPECT_FALSE(display_modes[5].interlaced);
+  EXPECT_FALSE(display_modes[5].native);
+  EXPECT_EQ(display_modes[5].refresh_rate, 30);
+  EXPECT_EQ(display_modes[5].device_scale_factor, 2.0);
+
+  EXPECT_EQ("1920x1200", display_modes[6].size.ToString());
+  EXPECT_FALSE(display_modes[6].interlaced);
+  EXPECT_EQ(display_modes[6].refresh_rate, 60);
+
+  EXPECT_EQ("3840x2160", display_modes[7].size.ToString());
+  EXPECT_FALSE(display_modes[7].interlaced);
+  EXPECT_FALSE(display_modes[7].native);
+  EXPECT_EQ(display_modes[7].refresh_rate, 30);
+  EXPECT_EQ(display_modes[7].device_scale_factor, 1.25);
+
+  EXPECT_EQ("3840x2160", display_modes[8].size.ToString());
+  EXPECT_FALSE(display_modes[8].interlaced);
+  EXPECT_TRUE(display_modes[8].native);
+  EXPECT_EQ(display_modes[8].refresh_rate, 30);
 
   // Outputs without any modes shouldn't cause a crash.
   modes.clear();
@@ -401,18 +401,18 @@ TEST_F(DisplayChangeObserverTest,
   display_snapshot.set_native_mode(modes[0].get());
   display_snapshot.set_modes(std::move(modes));
 
-  DisplayInfo::DisplayModeList display_modes =
+  std::vector<DisplayMode> display_modes =
       DisplayChangeObserver::GetExternalDisplayModeList(display_snapshot);
   ASSERT_EQ(2u, display_modes.size());
-  EXPECT_EQ("1920x1080", display_modes[0]->size().ToString());
-  EXPECT_FALSE(display_modes[0]->is_interlaced());
-  EXPECT_FALSE(display_modes[0]->native());
-  EXPECT_EQ(display_modes[0]->refresh_rate(), 60);
-
-  EXPECT_EQ("1920x1080", display_modes[1]->size().ToString());
-  EXPECT_TRUE(display_modes[1]->is_interlaced());
-  EXPECT_TRUE(display_modes[1]->native());
-  EXPECT_EQ(display_modes[1]->refresh_rate(), 60);
+  EXPECT_EQ("1920x1080", display_modes[0].size.ToString());
+  EXPECT_FALSE(display_modes[0].interlaced);
+  EXPECT_FALSE(display_modes[0].native);
+  EXPECT_EQ(display_modes[0].refresh_rate, 60);
+
+  EXPECT_EQ("1920x1080", display_modes[1].size.ToString());
+  EXPECT_TRUE(display_modes[1].interlaced);
+  EXPECT_TRUE(display_modes[1].native);
+  EXPECT_EQ(display_modes[1].refresh_rate, 60);
 }
 
 }  // namespace ash
diff --git a/ash/display/display_manager.cc b/ash/display/display_manager.cc
index 05c0f13..14c9225 100644
--- a/ash/display/display_manager.cc
+++ b/ash/display/display_manager.cc
@@ -14,7 +14,6 @@
 #include <vector>
 
 #include "ash/common/ash_switches.h"
-#include "ash/common/display/display_info.h"
 #include "ash/display/display_layout_store.h"
 #include "ash/display/display_util.h"
 #include "ash/display/extended_mouse_warp_controller.h"
@@ -85,21 +84,21 @@ display::Display& GetInvalidDisplay() {
   return *invalid_display;
 }
 
-DisplayInfo::DisplayModeList::const_iterator FindDisplayMode(
+std::vector<DisplayMode>::const_iterator FindDisplayMode(
     const DisplayInfo& info,
-    const scoped_refptr<DisplayMode>& target_mode) {
-  const DisplayInfo::DisplayModeList& modes = info.display_modes();
+    const DisplayMode& target_mode) {
+  const std::vector<DisplayMode>& modes = info.display_modes();
   return std::find_if(modes.begin(), modes.end(),
-                      [target_mode](const scoped_refptr<DisplayMode>& mode) {
-                        return target_mode->IsEquivalent(mode);
+                      [target_mode](const DisplayMode& mode) {
+                        return target_mode.IsEquivalent(mode);
                       });
 }
 
 void SetInternalDisplayModeList(DisplayInfo* info) {
-  scoped_refptr<DisplayMode> native_mode =
-      new DisplayMode(info->bounds_in_native().size(), 0.0 /* refresh_rate */,
-                      false /* interlaced */, false /* native_mode */,
-                      1.0 /* ui_scale */, info->device_scale_factor());
+  DisplayMode native_mode;
+  native_mode.size = info->bounds_in_native().size();
+  native_mode.device_scale_factor = info->device_scale_factor();
+  native_mode.ui_scale = 1.0f;
   info->SetDisplayModes(CreateInternalDisplayModeList(native_mode));
 }
 
@@ -115,8 +114,8 @@ void MaybeInitInternalDisplay(DisplayInfo* info) {
 gfx::Size GetMaxNativeSize(const DisplayInfo& info) {
   gfx::Size size;
   for (auto& mode : info.display_modes()) {
-    if (mode->size().GetArea() > size.GetArea())
-      size = mode->size();
+    if (mode.size.GetArea() > size.GetArea())
+      size = mode.size;
   }
   return size;
 }
@@ -353,9 +352,8 @@ void DisplayManager::SetDisplayRotation(
   }
 }
 
-bool DisplayManager::SetDisplayMode(
-    int64_t display_id,
-    const scoped_refptr<DisplayMode>& display_mode) {
+bool DisplayManager::SetDisplayMode(int64_t display_id,
+                                    const DisplayMode& display_mode) {
   bool change_ui_scale = GetDisplayIdForUIScaling() == display_id;
 
   DisplayInfoList display_info_list;
@@ -367,24 +365,23 @@ bool DisplayManager::SetDisplayMode(
       auto iter = FindDisplayMode(info, display_mode);
       if (iter == info.display_modes().end()) {
         LOG(WARNING) << "Unsupported display mode was requested:"
-                     << "size=" << display_mode->size().ToString()
-                     << ", ui scale=" << display_mode->ui_scale()
-                     << ", scale factor="
-                     << display_mode->device_scale_factor();
+                     << "size=" << display_mode.size.ToString()
+                     << ", ui scale=" << display_mode.ui_scale
+                     << ", scale fator=" << display_mode.device_scale_factor;
         return false;
       }
 
       if (change_ui_scale) {
-        if (info.configured_ui_scale() == display_mode->ui_scale())
+        if (info.configured_ui_scale() == display_mode.ui_scale)
           return true;
-        info.set_configured_ui_scale(display_mode->ui_scale());
+        info.set_configured_ui_scale(display_mode.ui_scale);
         display_property_changed = true;
       } else {
         display_modes_[display_id] = *iter;
-        if (info.bounds_in_native().size() != display_mode->size())
+        if (info.bounds_in_native().size() != display_mode.size)
           resolution_changed = true;
-        if (info.device_scale_factor() != display_mode->device_scale_factor()) {
-          info.set_device_scale_factor(display_mode->device_scale_factor());
+        if (info.device_scale_factor() != display_mode.device_scale_factor) {
+          info.set_device_scale_factor(display_mode.device_scale_factor);
           display_property_changed = true;
         }
       }
@@ -436,17 +433,16 @@ void DisplayManager::RegisterDisplayProperty(
     DCHECK(!display::Display::IsInternalDisplayId(display_id));
     // Default refresh rate, until OnNativeDisplaysChanged() updates us with the
     // actual display info, is 60 Hz.
-    scoped_refptr<DisplayMode> mode = new DisplayMode(
-        resolution_in_pixels, 60.0f, false, false, 1.0, device_scale_factor);
+    DisplayMode mode(resolution_in_pixels, 60.0f, false, false);
+    mode.device_scale_factor = device_scale_factor;
     display_modes_[display_id] = mode;
   }
 }
 
-scoped_refptr<DisplayMode> DisplayManager::GetActiveModeForDisplayId(
+DisplayMode DisplayManager::GetActiveModeForDisplayId(
     int64_t display_id) const {
-  scoped_refptr<DisplayMode> selected_mode(
-      GetSelectedModeForDisplayId(display_id));
-  if (selected_mode)
+  DisplayMode selected_mode;
+  if (GetSelectedModeForDisplayId(display_id, &selected_mode))
     return selected_mode;
 
   // If 'selected' mode is empty, it should return the default mode. This means
@@ -458,10 +454,10 @@ scoped_refptr<DisplayMode> DisplayManager::GetActiveModeForDisplayId(
 
   for (auto& mode : info.display_modes()) {
     if (GetDisplayIdForUIScaling() == display_id) {
-      if (info.configured_ui_scale() == mode->ui_scale())
-        return mode.get();
-    } else if (mode->native()) {
-      return mode.get();
+      if (info.configured_ui_scale() == mode.ui_scale)
+        return mode;
+    } else if (mode.native) {
+      return mode;
     }
   }
   return selected_mode;
@@ -478,13 +474,13 @@ void DisplayManager::RegisterDisplayRotationProperties(
     delegate_->PostDisplayConfigurationChange();
 }
 
-scoped_refptr<DisplayMode> DisplayManager::GetSelectedModeForDisplayId(
-    int64_t id) const {
-  std::map<int64_t, scoped_refptr<DisplayMode>>::const_iterator iter =
-      display_modes_.find(id);
+bool DisplayManager::GetSelectedModeForDisplayId(int64_t id,
+                                                 DisplayMode* mode_out) const {
+  std::map<int64_t, DisplayMode>::const_iterator iter = display_modes_.find(id);
   if (iter == display_modes_.end())
-    return scoped_refptr<DisplayMode>();
-  return iter->second;
+    return false;
+  *mode_out = iter->second;
+  return true;
 }
 
 bool DisplayManager::IsDisplayUIScalingEnabled() const {
@@ -578,11 +574,11 @@ void DisplayManager::OnNativeDisplaysChanged(
       new_display_info_list.push_back(*iter);
     }
 
-    scoped_refptr<DisplayMode> new_mode(new DisplayMode(
-        iter->bounds_in_native().size(), 0.0 /* refresh rate */,
-        false /* interlaced */, false /* native */, iter->configured_ui_scale(),
-        iter->device_scale_factor()));
-    const DisplayInfo::DisplayModeList& display_modes = iter->display_modes();
+    DisplayMode new_mode;
+    new_mode.size = iter->bounds_in_native().size();
+    new_mode.device_scale_factor = iter->device_scale_factor();
+    new_mode.ui_scale = iter->configured_ui_scale();
+    const std::vector<DisplayMode>& display_modes = iter->display_modes();
     // This is empty the displays are initialized from InitFromCommandLine.
     if (display_modes.empty())
       continue;
@@ -1134,7 +1130,7 @@ void DisplayManager::CreateSoftwareMirroringDisplayInfo(
         }
       }
 
-      DisplayInfo::DisplayModeList display_mode_list;
+      std::vector<DisplayMode> display_mode_list;
       std::set<std::pair<float, float>> dsf_scale_list;
 
       // 2nd Pass. Compute the unified display size.
@@ -1154,28 +1150,22 @@ void DisplayManager::CreateSoftwareMirroringDisplayInfo(
 
       DisplayInfo info(kUnifiedDisplayId, "Unified Desktop", false);
 
-      scoped_refptr<DisplayMode> native_mode(
-          new DisplayMode(unified_bounds.size(), 60.0f, false, true, 1.0, 1.0));
-      DisplayInfo::DisplayModeList modes =
+      DisplayMode native_mode(unified_bounds.size(), 60.0f, false, true);
+      std::vector<DisplayMode> modes =
           CreateUnifiedDisplayModeList(native_mode, dsf_scale_list);
 
       // Find the default mode.
       auto iter = std::find_if(
           modes.begin(), modes.end(),
-          [default_height, default_device_scale_factor](
-              const scoped_refptr<DisplayMode>& mode) {
-            return mode->size().height() == default_height &&
-                   mode->device_scale_factor() == default_device_scale_factor;
+          [default_height,
+           default_device_scale_factor](const DisplayMode& mode) {
+            return mode.size.height() == default_height &&
+                   mode.device_scale_factor == default_device_scale_factor;
           });
-
-      scoped_refptr<DisplayMode> dm(*iter);
-      *iter = make_scoped_refptr(new DisplayMode(
-          dm->size(), dm->refresh_rate(), dm->is_interlaced(),
-          true /* native */, dm->ui_scale(), dm->device_scale_factor()));
-
+      iter->native = true;
       info.SetDisplayModes(modes);
-      info.set_device_scale_factor(dm->device_scale_factor());
-      info.SetBounds(gfx::Rect(dm->size()));
+      info.set_device_scale_factor(iter->device_scale_factor);
+      info.SetBounds(gfx::Rect(iter->size));
 
       // Forget the configured resolution if the original unified
       // desktop resolution has changed.
@@ -1187,11 +1177,11 @@ void DisplayManager::CreateSoftwareMirroringDisplayInfo(
 
       // 3rd Pass. Set the selected mode, then recompute the mirroring
       // display size.
-      scoped_refptr<DisplayMode> mode =
-          GetSelectedModeForDisplayId(kUnifiedDisplayId);
-      if (mode && FindDisplayMode(info, mode) != info.display_modes().end()) {
-        info.set_device_scale_factor(mode->device_scale_factor());
-        info.SetBounds(gfx::Rect(mode->size()));
+      DisplayMode mode;
+      if (GetSelectedModeForDisplayId(kUnifiedDisplayId, &mode) &&
+          FindDisplayMode(info, mode) != info.display_modes().end()) {
+        info.set_device_scale_factor(mode.device_scale_factor);
+        info.SetBounds(gfx::Rect(mode.size));
       } else {
         display_modes_.erase(kUnifiedDisplayId);
       }
@@ -1224,8 +1214,8 @@ display::Display* DisplayManager::FindDisplayForId(int64_t id) {
       [id](const display::Display& display) { return display.id() == id; });
   if (iter != active_display_list_.end())
     return &(*iter);
-  // TODO(oshima): This happens when windows in unified desktop have
-  // been moved to a normal window. Fix this.
+  // TODO(oshima): This happens when a windows in unified desktop have
+  // been moved to normal window. Fix this.
   if (id != kUnifiedDisplayId)
     DLOG(WARNING) << "Could not find display:" << id;
   return nullptr;
diff --git a/ash/display/display_manager.h b/ash/display/display_manager.h
index e6a1b91..c8ee67f 100644
--- a/ash/display/display_manager.h
+++ b/ash/display/display_manager.h
@@ -17,7 +17,6 @@
 #include "base/compiler_specific.h"
 #include "base/gtest_prod_util.h"
 #include "base/macros.h"
-#include "base/memory/ref_counted.h"
 #include "base/memory/weak_ptr.h"
 #include "ui/display/display.h"
 #include "ui/display/manager/display_layout.h"
@@ -165,8 +164,7 @@ class ASH_EXPORT DisplayManager
   // ui-scale change, and device scale factor change. Returns true if it changes
   // the display resolution so that the caller needs to show a notification in
   // case the new resolution actually doesn't work.
-  bool SetDisplayMode(int64_t display_id,
-                      const scoped_refptr<DisplayMode>& display_mode);
+  bool SetDisplayMode(int64_t display_id, const DisplayMode& display_mode);
 
   // Register per display properties. |overscan_insets| is NULL if
   // the display has no custom overscan insets.
@@ -195,13 +193,12 @@ class ASH_EXPORT DisplayManager
   }
 
   // Returns the display mode of |display_id| which is currently used.
-  scoped_refptr<DisplayMode> GetActiveModeForDisplayId(
-      int64_t display_id) const;
+  DisplayMode GetActiveModeForDisplayId(int64_t display_id) const;
 
   // Returns the display's selected mode. This returns false and doesn't
   // set |mode_out| if the display mode is in default.
-  scoped_refptr<DisplayMode> GetSelectedModeForDisplayId(
-      int64_t display_id) const;
+  bool GetSelectedModeForDisplayId(int64_t display_id,
+                                   DisplayMode* mode_out) const;
 
   // Tells if the virtual resolution feature is enabled.
   bool IsDisplayUIScalingEnabled() const;
@@ -421,7 +418,7 @@ class ASH_EXPORT DisplayManager
   std::map<int64_t, DisplayInfo> display_info_;
 
   // Selected display modes for displays. Key is the displays' ID.
-  std::map<int64_t, scoped_refptr<DisplayMode>> display_modes_;
+  std::map<int64_t, DisplayMode> display_modes_;
 
   // When set to true, the host window's resize event updates
   // the display's size. This is set to true when running on
diff --git a/ash/display/display_manager_unittest.cc b/ash/display/display_manager_unittest.cc
index 0495984..1558c5e 100644
--- a/ash/display/display_manager_unittest.cc
+++ b/ash/display/display_manager_unittest.cc
@@ -911,13 +911,13 @@ TEST_P(DisplayManagerTest, DontRememberBestResolution) {
   int display_id = 1000;
   DisplayInfo native_display_info =
       CreateDisplayInfo(display_id, gfx::Rect(0, 0, 1000, 500));
-  DisplayInfo::DisplayModeList display_modes;
-  display_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(1000, 500), 58.0f, false, true)));
-  display_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(800, 300), 59.0f, false, false)));
-  display_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(400, 500), 60.0f, false, false)));
+  std::vector<DisplayMode> display_modes;
+  display_modes.push_back(
+      DisplayMode(gfx::Size(1000, 500), 58.0f, false, true));
+  display_modes.push_back(
+      DisplayMode(gfx::Size(800, 300), 59.0f, false, false));
+  display_modes.push_back(
+      DisplayMode(gfx::Size(400, 500), 60.0f, false, false));
 
   native_display_info.SetDisplayModes(display_modes);
 
@@ -925,46 +925,41 @@ TEST_P(DisplayManagerTest, DontRememberBestResolution) {
   display_info_list.push_back(native_display_info);
   display_manager()->OnNativeDisplaysChanged(display_info_list);
 
-  scoped_refptr<DisplayMode> mode;
-  scoped_refptr<DisplayMode> expected_mode(
-      new DisplayMode(gfx::Size(1000, 500), 0.0f, false, false));
-
-  mode = display_manager()->GetSelectedModeForDisplayId(display_id);
-  EXPECT_FALSE(!!mode);
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  DisplayMode mode;
+  DisplayMode expected_mode;
+  expected_mode.size = gfx::Size(1000, 500);
+  EXPECT_FALSE(
+      display_manager()->GetSelectedModeForDisplayId(display_id, &mode));
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
 
   // Unsupported resolution.
   test::SetDisplayResolution(display_id, gfx::Size(800, 4000));
-  mode = display_manager()->GetSelectedModeForDisplayId(display_id);
-  EXPECT_FALSE(!!mode);
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  EXPECT_FALSE(
+      display_manager()->GetSelectedModeForDisplayId(display_id, &mode));
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
 
   // Supported resolution.
   test::SetDisplayResolution(display_id, gfx::Size(800, 300));
-  mode = display_manager()->GetSelectedModeForDisplayId(display_id);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("800x300", mode->size().ToString());
-  EXPECT_EQ(59.0f, mode->refresh_rate());
-  EXPECT_FALSE(mode->native());
-
-  expected_mode = new DisplayMode(gfx::Size(800, 300), 0.0f, false, false);
-
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  EXPECT_TRUE(
+      display_manager()->GetSelectedModeForDisplayId(display_id, &mode));
+  EXPECT_EQ("800x300", mode.size.ToString());
+  EXPECT_EQ(59.0f, mode.refresh_rate);
+  EXPECT_FALSE(mode.native);
+  expected_mode.size = gfx::Size(800, 300);
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
 
   // Best resolution.
   test::SetDisplayResolution(display_id, gfx::Size(1000, 500));
-  mode = display_manager()->GetSelectedModeForDisplayId(display_id);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("1000x500", mode->size().ToString());
-  EXPECT_EQ(58.0f, mode->refresh_rate());
-  EXPECT_TRUE(mode->native());
-
-  expected_mode = new DisplayMode(gfx::Size(1000, 500), 0.0f, false, false);
-
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  EXPECT_TRUE(
+      display_manager()->GetSelectedModeForDisplayId(display_id, &mode));
+  EXPECT_EQ("1000x500", mode.size.ToString());
+  EXPECT_EQ(58.0f, mode.refresh_rate);
+  EXPECT_TRUE(mode.native);
+  expected_mode.size = gfx::Size(1000, 500);
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
 }
 #endif  // defined(OS_CHROMEOS)
@@ -975,15 +970,15 @@ TEST_P(DisplayManagerTest, ResolutionFallback) {
   int display_id = 1000;
   DisplayInfo native_display_info =
       CreateDisplayInfo(display_id, gfx::Rect(0, 0, 1000, 500));
-  DisplayInfo::DisplayModeList display_modes;
-  display_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(1000, 500), 58.0f, false, true)));
-  display_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(800, 300), 59.0f, false, false)));
-  display_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(400, 500), 60.0f, false, false)));
-
-  DisplayInfo::DisplayModeList copy = display_modes;
+  std::vector<DisplayMode> display_modes;
+  display_modes.push_back(
+      DisplayMode(gfx::Size(1000, 500), 58.0f, false, true));
+  display_modes.push_back(
+      DisplayMode(gfx::Size(800, 300), 59.0f, false, false));
+  display_modes.push_back(
+      DisplayMode(gfx::Size(400, 500), 60.0f, false, false));
+
+  std::vector<DisplayMode> copy = display_modes;
   native_display_info.SetDisplayModes(copy);
 
   std::vector<DisplayInfo> display_info_list;
@@ -999,30 +994,30 @@ TEST_P(DisplayManagerTest, ResolutionFallback) {
     new_display_info_list.push_back(new_native_display_info);
     display_manager()->OnNativeDisplaysChanged(new_display_info_list);
 
-    scoped_refptr<DisplayMode> mode =
-        display_manager()->GetSelectedModeForDisplayId(display_id);
-    EXPECT_TRUE(!!mode);
-    EXPECT_EQ("400x500", mode->size().ToString());
-    EXPECT_EQ(60.0f, mode->refresh_rate());
-    EXPECT_FALSE(mode->native());
+    DisplayMode mode;
+    EXPECT_TRUE(
+        display_manager()->GetSelectedModeForDisplayId(display_id, &mode));
+    EXPECT_EQ("400x500", mode.size.ToString());
+    EXPECT_EQ(60.0f, mode.refresh_rate);
+    EXPECT_FALSE(mode.native);
   }
   {
     // Best resolution should find itself on the resolutions list.
     test::SetDisplayResolution(display_id, gfx::Size(800, 300));
     DisplayInfo new_native_display_info =
         CreateDisplayInfo(display_id, gfx::Rect(0, 0, 1000, 500));
-    DisplayInfo::DisplayModeList copy = display_modes;
+    std::vector<DisplayMode> copy = display_modes;
     new_native_display_info.SetDisplayModes(copy);
     std::vector<DisplayInfo> new_display_info_list;
     new_display_info_list.push_back(new_native_display_info);
     display_manager()->OnNativeDisplaysChanged(new_display_info_list);
 
-    scoped_refptr<DisplayMode> mode =
-        display_manager()->GetSelectedModeForDisplayId(display_id);
-    EXPECT_TRUE(!!mode);
-    EXPECT_EQ("1000x500", mode->size().ToString());
-    EXPECT_EQ(58.0f, mode->refresh_rate());
-    EXPECT_TRUE(mode->native());
+    DisplayMode mode;
+    EXPECT_TRUE(
+        display_manager()->GetSelectedModeForDisplayId(display_id, &mode));
+    EXPECT_EQ("1000x500", mode.size.ToString());
+    EXPECT_EQ(58.0f, mode.refresh_rate);
+    EXPECT_TRUE(mode.native);
   }
 }
 #endif  // defined(OS_CHROMEOS)
@@ -1214,77 +1209,55 @@ TEST_P(DisplayManagerTest, UIScaleWithDisplayMode) {
   // Setup the display modes with UI-scale.
   DisplayInfo native_display_info =
       CreateDisplayInfo(display_id, gfx::Rect(0, 0, 1280, 800));
-  const scoped_refptr<DisplayMode>& base_mode(
-      new DisplayMode(gfx::Size(1280, 800), 60.0f, false, false));
-  DisplayInfo::DisplayModeList mode_list =
-      CreateInternalDisplayModeList(base_mode);
+  const DisplayMode base_mode(gfx::Size(1280, 800), 60.0f, false, false);
+  std::vector<DisplayMode> mode_list = CreateInternalDisplayModeList(base_mode);
   native_display_info.SetDisplayModes(mode_list);
 
   std::vector<DisplayInfo> display_info_list;
   display_info_list.push_back(native_display_info);
   display_manager()->OnNativeDisplaysChanged(display_info_list);
 
-  scoped_refptr<DisplayMode> expected_mode = base_mode;
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  DisplayMode expected_mode = base_mode;
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
 
   test::ScopedSetInternalDisplayId set_internal(display_id);
 
   SetDisplayUIScale(display_id, 1.5f);
   EXPECT_EQ(1.0f, GetDisplayInfoAt(0).configured_ui_scale());
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
   SetDisplayUIScale(display_id, 1.25f);
   EXPECT_EQ(1.0f, GetDisplayInfoAt(0).configured_ui_scale());
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
   SetDisplayUIScale(display_id, 1.125f);
   EXPECT_EQ(1.125f, GetDisplayInfoAt(0).configured_ui_scale());
-
-  expected_mode = new DisplayMode(
-      expected_mode->size(), expected_mode->refresh_rate(),
-      expected_mode->is_interlaced(), expected_mode->native(),
-      1.125f /* ui_scale */, expected_mode->device_scale_factor());
-
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  expected_mode.ui_scale = 1.125f;
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
   SetDisplayUIScale(display_id, 0.8f);
   EXPECT_EQ(0.8f, GetDisplayInfoAt(0).configured_ui_scale());
-
-  expected_mode = new DisplayMode(
-      expected_mode->size(), expected_mode->refresh_rate(),
-      expected_mode->is_interlaced(), expected_mode->native(),
-      0.8f /* ui_scale */, expected_mode->device_scale_factor());
-
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  expected_mode.ui_scale = 0.8f;
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
   SetDisplayUIScale(display_id, 0.75f);
   EXPECT_EQ(0.8f, GetDisplayInfoAt(0).configured_ui_scale());
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
   SetDisplayUIScale(display_id, 0.625f);
   EXPECT_EQ(0.625f, GetDisplayInfoAt(0).configured_ui_scale());
-
-  expected_mode = new DisplayMode(
-      expected_mode->size(), expected_mode->refresh_rate(),
-      expected_mode->is_interlaced(), expected_mode->native(),
-      0.625f /* ui_scale */, expected_mode->device_scale_factor());
-
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  expected_mode.ui_scale = 0.625f;
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
   SetDisplayUIScale(display_id, 0.6f);
   EXPECT_EQ(0.625f, GetDisplayInfoAt(0).configured_ui_scale());
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
   SetDisplayUIScale(display_id, 0.5f);
   EXPECT_EQ(0.5f, GetDisplayInfoAt(0).configured_ui_scale());
-
-  expected_mode = new DisplayMode(
-      expected_mode->size(), expected_mode->refresh_rate(),
-      expected_mode->is_interlaced(), expected_mode->native(),
-      0.5f /* ui_scale */, expected_mode->device_scale_factor());
-
-  EXPECT_TRUE(expected_mode->IsEquivalent(
+  expected_mode.ui_scale = 0.5f;
+  EXPECT_TRUE(expected_mode.IsEquivalent(
       display_manager()->GetActiveModeForDisplayId(display_id)));
 }
 
@@ -1328,10 +1301,8 @@ TEST_P(DisplayManagerTest, FHD125DefaultsTo08UIScaling) {
       CreateDisplayInfo(display_id, gfx::Rect(0, 0, 1920, 1080));
   native_display_info.set_device_scale_factor(1.25);
 
-  const scoped_refptr<DisplayMode>& base_mode(
-      new DisplayMode(gfx::Size(1920, 1080), 60.0f, false, false));
-  DisplayInfo::DisplayModeList mode_list =
-      CreateInternalDisplayModeList(base_mode);
+  const DisplayMode base_mode(gfx::Size(1920, 1080), 60.0f, false, false);
+  std::vector<DisplayMode> mode_list = CreateInternalDisplayModeList(base_mode);
   native_display_info.SetDisplayModes(mode_list);
 
   std::vector<DisplayInfo> display_info_list;
@@ -1363,10 +1334,8 @@ TEST_P(DisplayManagerTest, FHD125DefaultsTo08UIScalingNoOverride) {
       CreateDisplayInfo(display_id, gfx::Rect(0, 0, 1920, 1080));
   native_display_info.set_device_scale_factor(1.25);
 
-  const scoped_refptr<DisplayMode>& base_mode(
-      new DisplayMode(gfx::Size(1920, 1080), 60.0f, false, false));
-  DisplayInfo::DisplayModeList mode_list =
-      CreateInternalDisplayModeList(base_mode);
+  const DisplayMode base_mode(gfx::Size(1920, 1080), 60.0f, false, false);
+  std::vector<DisplayMode> mode_list = CreateInternalDisplayModeList(base_mode);
   native_display_info.SetDisplayModes(mode_list);
 
   std::vector<DisplayInfo> display_info_list;
@@ -1392,17 +1361,17 @@ TEST_P(DisplayManagerTest, ResolutionChangeInUnifiedMode) {
   int64_t unified_id = display::Screen::GetScreen()->GetPrimaryDisplay().id();
   DisplayInfo info = display_manager()->GetDisplayInfo(unified_id);
   ASSERT_EQ(2u, info.display_modes().size());
-  EXPECT_EQ("400x200", info.display_modes()[0]->size().ToString());
-  EXPECT_TRUE(info.display_modes()[0]->native());
-  EXPECT_EQ("800x400", info.display_modes()[1]->size().ToString());
-  EXPECT_FALSE(info.display_modes()[1]->native());
+  EXPECT_EQ("400x200", info.display_modes()[0].size.ToString());
+  EXPECT_TRUE(info.display_modes()[0].native);
+  EXPECT_EQ("800x400", info.display_modes()[1].size.ToString());
+  EXPECT_FALSE(info.display_modes()[1].native);
   EXPECT_EQ(
       "400x200",
       display::Screen::GetScreen()->GetPrimaryDisplay().size().ToString());
-  scoped_refptr<DisplayMode> active_mode =
+  DisplayMode active_mode =
       display_manager()->GetActiveModeForDisplayId(unified_id);
-  EXPECT_EQ(1.0f, active_mode->ui_scale());
-  EXPECT_EQ("400x200", active_mode->size().ToString());
+  EXPECT_EQ(1.0f, active_mode.ui_scale);
+  EXPECT_EQ("400x200", active_mode.size.ToString());
 
   EXPECT_TRUE(test::SetDisplayResolution(unified_id, gfx::Size(800, 400)));
   EXPECT_EQ(
@@ -1410,8 +1379,8 @@ TEST_P(DisplayManagerTest, ResolutionChangeInUnifiedMode) {
       display::Screen::GetScreen()->GetPrimaryDisplay().size().ToString());
 
   active_mode = display_manager()->GetActiveModeForDisplayId(unified_id);
-  EXPECT_EQ(1.0f, active_mode->ui_scale());
-  EXPECT_EQ("800x400", active_mode->size().ToString());
+  EXPECT_EQ(1.0f, active_mode.ui_scale);
+  EXPECT_EQ("800x400", active_mode.size.ToString());
 
   // resolution change will not persist in unified desktop mode.
   UpdateDisplay("600x600, 200x200");
@@ -1419,9 +1388,9 @@ TEST_P(DisplayManagerTest, ResolutionChangeInUnifiedMode) {
       "1200x600",
       display::Screen::GetScreen()->GetPrimaryDisplay().size().ToString());
   active_mode = display_manager()->GetActiveModeForDisplayId(unified_id);
-  EXPECT_EQ(1.0f, active_mode->ui_scale());
-  EXPECT_TRUE(active_mode->native());
-  EXPECT_EQ("1200x600", active_mode->size().ToString());
+  EXPECT_EQ(1.0f, active_mode.ui_scale);
+  EXPECT_TRUE(active_mode.native);
+  EXPECT_EQ("1200x600", active_mode.size.ToString());
 }
 
 // TODO(scottmg): RootWindow doesn't get resized on Windows
@@ -1943,10 +1912,10 @@ TEST_P(DisplayManagerTest, UnifiedDesktopWith2xDSF) {
   DisplayInfo info =
       display_manager()->GetDisplayInfo(screen->GetPrimaryDisplay().id());
   EXPECT_EQ(2u, info.display_modes().size());
-  EXPECT_EQ("1640x800", info.display_modes()[0]->size().ToString());
-  EXPECT_EQ(2.0f, info.display_modes()[0]->device_scale_factor());
-  EXPECT_EQ("1025x500", info.display_modes()[1]->size().ToString());
-  EXPECT_EQ(1.0f, info.display_modes()[1]->device_scale_factor());
+  EXPECT_EQ("1640x800", info.display_modes()[0].size.ToString());
+  EXPECT_EQ(2.0f, info.display_modes()[0].device_scale_factor);
+  EXPECT_EQ("1025x500", info.display_modes()[1].size.ToString());
+  EXPECT_EQ(1.0f, info.display_modes()[1].device_scale_factor);
 
   // For 1x, 400 + 500 / 800 * 100 = 1025.
   EXPECT_EQ("1025x500", screen->GetPrimaryDisplay().size().ToString());
@@ -1962,10 +1931,10 @@ TEST_P(DisplayManagerTest, UnifiedDesktopWith2xDSF) {
   UpdateDisplay("1200x800*2,1000x1000");
   info = display_manager()->GetDisplayInfo(screen->GetPrimaryDisplay().id());
   EXPECT_EQ(2u, info.display_modes().size());
-  EXPECT_EQ("2000x800", info.display_modes()[0]->size().ToString());
-  EXPECT_EQ(2.0f, info.display_modes()[0]->device_scale_factor());
-  EXPECT_EQ("2500x1000", info.display_modes()[1]->size().ToString());
-  EXPECT_EQ(1.0f, info.display_modes()[1]->device_scale_factor());
+  EXPECT_EQ("2000x800", info.display_modes()[0].size.ToString());
+  EXPECT_EQ(2.0f, info.display_modes()[0].device_scale_factor);
+  EXPECT_EQ("2500x1000", info.display_modes()[1].size.ToString());
+  EXPECT_EQ(1.0f, info.display_modes()[1].device_scale_factor);
 
   // For 2x, (800 / 1000 * 1000 + 1200) / 2 = 1000
   EXPECT_EQ("1000x400", screen->GetPrimaryDisplay().size().ToString());
@@ -1982,10 +1951,10 @@ TEST_P(DisplayManagerTest, UnifiedDesktopWith2xDSF) {
   UpdateDisplay("1200x800*2,1000x1000*2");
   info = display_manager()->GetDisplayInfo(screen->GetPrimaryDisplay().id());
   EXPECT_EQ(2u, info.display_modes().size());
-  EXPECT_EQ("2000x800", info.display_modes()[0]->size().ToString());
-  EXPECT_EQ(2.0f, info.display_modes()[0]->device_scale_factor());
-  EXPECT_EQ("2500x1000", info.display_modes()[1]->size().ToString());
-  EXPECT_EQ(2.0f, info.display_modes()[1]->device_scale_factor());
+  EXPECT_EQ("2000x800", info.display_modes()[0].size.ToString());
+  EXPECT_EQ(2.0f, info.display_modes()[0].device_scale_factor);
+  EXPECT_EQ("2500x1000", info.display_modes()[1].size.ToString());
+  EXPECT_EQ(2.0f, info.display_modes()[1].device_scale_factor);
 
   EXPECT_EQ("1000x400", screen->GetPrimaryDisplay().size().ToString());
   EXPECT_EQ("1000x400",
@@ -2000,10 +1969,10 @@ TEST_P(DisplayManagerTest, UnifiedDesktopWith2xDSF) {
   UpdateDisplay("1000x800*2,300x800");
   info = display_manager()->GetDisplayInfo(screen->GetPrimaryDisplay().id());
   EXPECT_EQ(2u, info.display_modes().size());
-  EXPECT_EQ("1300x800", info.display_modes()[0]->size().ToString());
-  EXPECT_EQ(2.0f, info.display_modes()[0]->device_scale_factor());
-  EXPECT_EQ("1300x800", info.display_modes()[1]->size().ToString());
-  EXPECT_EQ(1.0f, info.display_modes()[1]->device_scale_factor());
+  EXPECT_EQ("1300x800", info.display_modes()[0].size.ToString());
+  EXPECT_EQ(2.0f, info.display_modes()[0].device_scale_factor);
+  EXPECT_EQ("1300x800", info.display_modes()[1].size.ToString());
+  EXPECT_EQ(1.0f, info.display_modes()[1].device_scale_factor);
 
   EXPECT_EQ("650x400", screen->GetPrimaryDisplay().size().ToString());
   EXPECT_EQ("650x400",
@@ -2017,10 +1986,10 @@ TEST_P(DisplayManagerTest, UnifiedDesktopWith2xDSF) {
   // being 2x.
   UpdateDisplay("1000x800,300x800*2");
   EXPECT_EQ(2u, info.display_modes().size());
-  EXPECT_EQ("1300x800", info.display_modes()[0]->size().ToString());
-  EXPECT_EQ(2.0f, info.display_modes()[0]->device_scale_factor());
-  EXPECT_EQ("1300x800", info.display_modes()[1]->size().ToString());
-  EXPECT_EQ(1.0f, info.display_modes()[1]->device_scale_factor());
+  EXPECT_EQ("1300x800", info.display_modes()[0].size.ToString());
+  EXPECT_EQ(2.0f, info.display_modes()[0].device_scale_factor);
+  EXPECT_EQ("1300x800", info.display_modes()[1].size.ToString());
+  EXPECT_EQ(1.0f, info.display_modes()[1].device_scale_factor);
 
   EXPECT_EQ("1300x800", screen->GetPrimaryDisplay().size().ToString());
   EXPECT_EQ("1300x800",
@@ -2130,14 +2099,15 @@ TEST_P(DisplayManagerTest, DockMode) {
   EXPECT_FALSE(display_manager()->IsActiveDisplayId(internal_id));
 
   const DisplayInfo& info = display_manager()->GetDisplayInfo(internal_id);
+  DisplayMode mode;
 
-  EXPECT_FALSE(!!GetDisplayModeForNextUIScale(info, true));
-  EXPECT_FALSE(!!GetDisplayModeForNextUIScale(info, false));
+  EXPECT_FALSE(GetDisplayModeForNextUIScale(info, true, &mode));
+  EXPECT_FALSE(GetDisplayModeForNextUIScale(info, false, &mode));
   EXPECT_FALSE(SetDisplayUIScale(internal_id, 1.0f));
 
   DisplayInfo invalid_info;
-  EXPECT_FALSE(!!GetDisplayModeForNextUIScale(invalid_info, true));
-  EXPECT_FALSE(!!GetDisplayModeForNextUIScale(invalid_info, false));
+  EXPECT_FALSE(GetDisplayModeForNextUIScale(invalid_info, true, &mode));
+  EXPECT_FALSE(GetDisplayModeForNextUIScale(invalid_info, false, &mode));
   EXPECT_FALSE(SetDisplayUIScale(display::Display::kInvalidDisplayID, 1.0f));
 }
 
diff --git a/ash/display/display_util.cc b/ash/display/display_util.cc
index beff41b..f5fba96 100644
--- a/ash/display/display_util.cc
+++ b/ash/display/display_util.cc
@@ -69,19 +69,18 @@ const float kUIScalesFor1_25x[] = {0.5f, 0.625f, 0.8f, 1.0f, 1.25f};
 const float kUIScalesFor1280[] = {0.5f, 0.625f, 0.8f, 1.0f, 1.125f};
 const float kUIScalesFor1366[] = {0.5f, 0.6f, 0.75f, 1.0f, 1.125f};
 
-std::vector<float> GetScalesForDisplay(
-    const scoped_refptr<DisplayMode>& native_mode) {
+std::vector<float> GetScalesForDisplay(const DisplayMode& native_mode) {
 #define ASSIGN_ARRAY(v, a) v.assign(a, a + arraysize(a))
 
   std::vector<float> ret;
-  if (native_mode->device_scale_factor() == 2.0f) {
+  if (native_mode.device_scale_factor == 2.0f) {
     ASSIGN_ARRAY(ret, kUIScalesFor2x);
     return ret;
-  } else if (native_mode->device_scale_factor() == 1.25f) {
+  } else if (native_mode.device_scale_factor == 1.25f) {
     ASSIGN_ARRAY(ret, kUIScalesFor1_25x);
     return ret;
   }
-  switch (native_mode->size().width()) {
+  switch (native_mode.size.width()) {
     case 1280:
       ASSIGN_ARRAY(ret, kUIScalesFor1280);
       break;
@@ -92,7 +91,7 @@ std::vector<float> GetScalesForDisplay(
       ASSIGN_ARRAY(ret, kUIScalesFor1280);
 #if defined(OS_CHROMEOS)
       if (base::SysInfo::IsRunningOnChromeOS())
-        NOTREACHED() << "Unknown resolution:" << native_mode->size().ToString();
+        NOTREACHED() << "Unknown resolution:" << native_mode.size.ToString();
 #endif
   }
   return ret;
@@ -101,9 +100,9 @@ std::vector<float> GetScalesForDisplay(
 struct ScaleComparator {
   explicit ScaleComparator(float s) : scale(s) {}
 
-  bool operator()(const scoped_refptr<DisplayMode>& mode) const {
+  bool operator()(const DisplayMode& mode) const {
     const float kEpsilon = 0.0001f;
-    return std::abs(scale - mode->ui_scale()) < kEpsilon;
+    return std::abs(scale - mode.ui_scale) < kEpsilon;
   }
   float scale;
 };
@@ -114,20 +113,23 @@ void ConvertPointFromScreenToNative(aura::WindowTreeHost* host,
   host->ConvertPointToNativeScreen(point);
 }
 
-scoped_refptr<DisplayMode> GetDisplayModeForUIScale(const DisplayInfo& info,
-                                                    float ui_scale) {
-  const DisplayInfo::DisplayModeList& modes = info.display_modes();
+bool GetDisplayModeForUIScale(const DisplayInfo& info,
+                              float ui_scale,
+                              DisplayMode* out) {
+  const std::vector<DisplayMode>& modes = info.display_modes();
   auto iter = std::find_if(modes.begin(), modes.end(),
-                           [ui_scale](const scoped_refptr<DisplayMode>& mode) {
-                             return mode->ui_scale() == ui_scale;
+                           [ui_scale](const DisplayMode& mode) {
+                             return mode.ui_scale == ui_scale;
                            });
   if (iter == modes.end())
-    return scoped_refptr<DisplayMode>();
-  return *iter;
+    return false;
+  *out = *iter;
+  return true;
 }
 
-scoped_refptr<DisplayMode>
-FindNextMode(const DisplayInfo::DisplayModeList& modes, size_t index, bool up) {
+DisplayMode FindNextMode(const std::vector<DisplayMode>& modes,
+                         size_t index,
+                         bool up) {
   DCHECK_LT(index, modes.size());
   size_t new_index = index;
   if (up && (index + 1 < modes.size()))
@@ -139,99 +141,98 @@ FindNextMode(const DisplayInfo::DisplayModeList& modes, size_t index, bool up) {
 
 }  // namespace
 
-DisplayInfo::DisplayModeList CreateInternalDisplayModeList(
-    const scoped_refptr<DisplayMode>& native_mode) {
-  DisplayInfo::DisplayModeList display_mode_list;
+std::vector<DisplayMode> CreateInternalDisplayModeList(
+    const DisplayMode& native_mode) {
+  std::vector<DisplayMode> display_mode_list;
 
-  float native_ui_scale = (native_mode->device_scale_factor() == 1.25f)
+  float native_ui_scale = (native_mode.device_scale_factor == 1.25f)
                               ? 1.0f
-                              : native_mode->device_scale_factor();
+                              : native_mode.device_scale_factor;
   for (float ui_scale : GetScalesForDisplay(native_mode)) {
-    scoped_refptr<DisplayMode> mode(new DisplayMode(
-        native_mode->size(), native_mode->refresh_rate(),
-        native_mode->is_interlaced(), ui_scale == native_ui_scale, ui_scale,
-        native_mode->device_scale_factor()));
+    DisplayMode mode = native_mode;
+    mode.ui_scale = ui_scale;
+    mode.native = (ui_scale == native_ui_scale);
     display_mode_list.push_back(mode);
   }
   return display_mode_list;
 }
 
-DisplayInfo::DisplayModeList CreateUnifiedDisplayModeList(
-    const scoped_refptr<DisplayMode>& native_mode,
+std::vector<DisplayMode> CreateUnifiedDisplayModeList(
+    const DisplayMode& native_mode,
     const std::set<std::pair<float, float>>& dsf_scale_list) {
-  DisplayInfo::DisplayModeList display_mode_list;
+  std::vector<DisplayMode> display_mode_list;
 
   for (auto& pair : dsf_scale_list) {
-    gfx::SizeF scaled_size(native_mode->size());
+    DisplayMode mode = native_mode;
+    mode.device_scale_factor = pair.first;
+    gfx::SizeF scaled_size(native_mode.size);
     scaled_size.Scale(pair.second);
-    scoped_refptr<DisplayMode> mode(new DisplayMode(
-        gfx::ToFlooredSize(scaled_size), native_mode->refresh_rate(),
-        native_mode->is_interlaced(), false /* native */,
-        native_mode->ui_scale(), pair.first /* device_scale_factor */));
+    mode.size = gfx::ToFlooredSize(scaled_size);
+    mode.native = false;
     display_mode_list.push_back(mode);
   }
   // Sort the mode by the size in DIP.
   std::sort(display_mode_list.begin(), display_mode_list.end(),
-            [](const scoped_refptr<DisplayMode>& a,
-               const scoped_refptr<DisplayMode>& b) {
-              return a->GetSizeInDIP(false).GetArea() <
-                     b->GetSizeInDIP(false).GetArea();
+            [](const DisplayMode& a, const DisplayMode& b) {
+              return a.GetSizeInDIP(false).GetArea() <
+                     b.GetSizeInDIP(false).GetArea();
             });
   return display_mode_list;
 }
 
-scoped_refptr<DisplayMode> GetDisplayModeForResolution(
-    const DisplayInfo& info,
-    const gfx::Size& resolution) {
+bool GetDisplayModeForResolution(const DisplayInfo& info,
+                                 const gfx::Size& resolution,
+                                 DisplayMode* out) {
   if (display::Display::IsInternalDisplayId(info.id()))
-    return scoped_refptr<DisplayMode>();
+    return false;
 
-  const DisplayInfo::DisplayModeList& modes = info.display_modes();
+  const std::vector<DisplayMode>& modes = info.display_modes();
   DCHECK_NE(0u, modes.size());
-  scoped_refptr<DisplayMode> target_mode;
-  DisplayInfo::DisplayModeList::const_iterator iter =
-      std::find_if(modes.begin(), modes.end(),
-                   [resolution](const scoped_refptr<DisplayMode>& mode) {
-                     return mode->size() == resolution;
-                   });
+  DisplayMode target_mode;
+  target_mode.size = resolution;
+  std::vector<DisplayMode>::const_iterator iter = std::find_if(
+      modes.begin(), modes.end(), [resolution](const DisplayMode& mode) {
+        return mode.size == resolution;
+      });
   if (iter == modes.end()) {
     LOG(WARNING) << "Unsupported resolution was requested:"
                  << resolution.ToString();
-    return scoped_refptr<DisplayMode>();
+    return false;
   }
-  return *iter;
+  *out = *iter;
+  return true;
 }
 
-scoped_refptr<DisplayMode> GetDisplayModeForNextUIScale(const DisplayInfo& info,
-                                                        bool up) {
+bool GetDisplayModeForNextUIScale(const DisplayInfo& info,
+                                  bool up,
+                                  DisplayMode* out) {
   DisplayManager* display_manager = Shell::GetInstance()->display_manager();
   if (!display_manager->IsActiveDisplayId(info.id()) ||
       !display::Display::IsInternalDisplayId(info.id())) {
-    return scoped_refptr<DisplayMode>();
+    return false;
   }
-  const DisplayInfo::DisplayModeList& modes = info.display_modes();
+  const std::vector<DisplayMode>& modes = info.display_modes();
   ScaleComparator comparator(info.configured_ui_scale());
   auto iter = std::find_if(modes.begin(), modes.end(), comparator);
-  return FindNextMode(modes, iter - modes.begin(), up);
+  *out = FindNextMode(modes, iter - modes.begin(), up);
+  return true;
 }
 
-scoped_refptr<DisplayMode> GetDisplayModeForNextResolution(
-    const DisplayInfo& info,
-    bool up) {
+bool GetDisplayModeForNextResolution(const DisplayInfo& info,
+                                     bool up,
+                                     DisplayMode* out) {
   if (display::Display::IsInternalDisplayId(info.id()))
-    return scoped_refptr<DisplayMode>();
-
-  const DisplayInfo::DisplayModeList& modes = info.display_modes();
-  scoped_refptr<DisplayMode> tmp = new DisplayMode(
-      info.size_in_pixel(), 0.0, false, false, 1.0, info.device_scale_factor());
-  gfx::Size resolution = tmp->GetSizeInDIP(false);
-
-  auto iter =
-      std::find_if(modes.begin(), modes.end(),
-                   [resolution](const scoped_refptr<DisplayMode>& mode) {
-                     return mode->GetSizeInDIP(false) == resolution;
-                   });
-  return FindNextMode(modes, iter - modes.begin(), up);
+    return false;
+  const std::vector<DisplayMode>& modes = info.display_modes();
+  DisplayMode tmp(info.size_in_pixel(), 0.0f, false, false);
+  tmp.device_scale_factor = info.device_scale_factor();
+  gfx::Size resolution = tmp.GetSizeInDIP(false);
+  auto iter = std::find_if(modes.begin(), modes.end(),
+                           [resolution](const DisplayMode& mode) {
+                             return mode.GetSizeInDIP(false) == resolution;
+                           });
+  *out = FindNextMode(modes, iter - modes.begin(), up);
+  return true;
 }
 
 bool SetDisplayUIScale(int64_t id, float ui_scale) {
@@ -241,16 +242,15 @@ bool SetDisplayUIScale(int64_t id, float ui_scale) {
     return false;
   }
   const DisplayInfo& info = display_manager->GetDisplayInfo(id);
-
-  scoped_refptr<DisplayMode> mode = GetDisplayModeForUIScale(info, ui_scale);
-  if (!mode)
+  DisplayMode mode;
+  if (!GetDisplayModeForUIScale(info, ui_scale, &mode))
     return false;
   return display_manager->SetDisplayMode(id, mode);
 }
 
 bool HasDisplayModeForUIScale(const DisplayInfo& info, float ui_scale) {
   ScaleComparator comparator(ui_scale);
-  const DisplayInfo::DisplayModeList& modes = info.display_modes();
+  const std::vector<DisplayMode>& modes = info.display_modes();
   return std::find_if(modes.begin(), modes.end(), comparator) != modes.end();
 }
 
diff --git a/ash/display/display_util.h b/ash/display/display_util.h
index 6dfa6a5..38bbcdc 100644
--- a/ash/display/display_util.h
+++ b/ash/display/display_util.h
@@ -12,8 +12,6 @@
 #include <vector>
 
 #include "ash/ash_export.h"
-#include "ash/common/display/display_info.h"
-#include "base/memory/ref_counted.h"
 #include "ui/display/manager/display_layout.h"
 
 namespace gfx {
@@ -24,37 +22,37 @@ class Size;
 
 namespace ash {
 class AshWindowTreeHost;
-class DisplayMode;
+struct DisplayMode;
 class DisplayInfo;
 
 // Creates the display mode list for internal display
 // based on |native_mode|.
-ASH_EXPORT DisplayInfo::DisplayModeList CreateInternalDisplayModeList(
-    const scoped_refptr<DisplayMode>& native_mode);
+ASH_EXPORT std::vector<DisplayMode> CreateInternalDisplayModeList(
+    const DisplayMode& native_mode);
 
 // Creates the display mode list for unified display
 // based on |native_mode| and |scales|.
-ASH_EXPORT DisplayInfo::DisplayModeList CreateUnifiedDisplayModeList(
-    const scoped_refptr<DisplayMode>& native_mode,
+ASH_EXPORT std::vector<DisplayMode> CreateUnifiedDisplayModeList(
+    const DisplayMode& native_mode,
     const std::set<std::pair<float, float>>& dsf_scale_list);
 
 // Gets the display mode for |resolution|. Returns false if no display
 // mode matches the resolution, or the display is an internal display.
-ASH_EXPORT scoped_refptr<DisplayMode> GetDisplayModeForResolution(
-    const DisplayInfo& info,
-    const gfx::Size& resolution);
+ASH_EXPORT bool GetDisplayModeForResolution(const DisplayInfo& info,
+                                            const gfx::Size& resolution,
+                                            DisplayMode* out);
 
 // Gets the display mode for the next valid UI scale. Returns false
 // if the display is not an internal display.
-ASH_EXPORT scoped_refptr<DisplayMode> GetDisplayModeForNextUIScale(
-    const DisplayInfo& info,
-    bool up);
+ASH_EXPORT bool GetDisplayModeForNextUIScale(const DisplayInfo& info,
+                                             bool up,
+                                             DisplayMode* out);
 
 // Gets the display mode for the next valid resolution. Returns false
 // if the display is an internal display.
-ASH_EXPORT scoped_refptr<DisplayMode> GetDisplayModeForNextResolution(
-    const DisplayInfo& info,
-    bool up);
+ASH_EXPORT bool GetDisplayModeForNextResolution(const DisplayInfo& info,
+                                                bool up,
+                                                DisplayMode* out);
 
 // Sets the UI scale for the |display_id|. Returns false if the
 // display_id is not an internal display.
diff --git a/ash/display/resolution_notification_controller.cc b/ash/display/resolution_notification_controller.cc
index 2889600..ed57757 100644
--- a/ash/display/resolution_notification_controller.cc
+++ b/ash/display/resolution_notification_controller.cc
@@ -94,8 +94,8 @@ const char ResolutionNotificationController::kNotificationId[] =
 
 struct ResolutionNotificationController::ResolutionChangeInfo {
   ResolutionChangeInfo(int64_t display_id,
-                       const scoped_refptr<DisplayMode>& old_resolution,
-                       const scoped_refptr<DisplayMode>& new_resolution,
+                       const DisplayMode& old_resolution,
+                       const DisplayMode& new_resolution,
                        const base::Closure& accept_callback);
   ~ResolutionChangeInfo();
 
@@ -103,14 +103,14 @@ struct ResolutionNotificationController::ResolutionChangeInfo {
   int64_t display_id;
 
   // The resolution before the change.
-  scoped_refptr<DisplayMode> old_resolution;
+  DisplayMode old_resolution;
 
   // The requested resolution. Note that this may be different from
   // |current_resolution| which is the actual resolution set.
-  scoped_refptr<DisplayMode> new_resolution;
+  DisplayMode new_resolution;
 
   // The actual resolution after the change.
-  scoped_refptr<DisplayMode> current_resolution;
+  DisplayMode current_resolution;
 
   // The callback when accept is chosen.
   base::Closure accept_callback;
@@ -129,8 +129,8 @@ struct ResolutionNotificationController::ResolutionChangeInfo {
 
 ResolutionNotificationController::ResolutionChangeInfo::ResolutionChangeInfo(
     int64_t display_id,
-    const scoped_refptr<DisplayMode>& old_resolution,
-    const scoped_refptr<DisplayMode>& new_resolution,
+    const DisplayMode& old_resolution,
+    const DisplayMode& new_resolution,
     const base::Closure& accept_callback)
     : display_id(display_id),
       old_resolution(old_resolution),
@@ -145,11 +145,7 @@ ResolutionNotificationController::ResolutionChangeInfo::ResolutionChangeInfo(
 }
 
 ResolutionNotificationController::ResolutionChangeInfo::
-    ~ResolutionChangeInfo() {
-  old_resolution = nullptr;
-  new_resolution = nullptr;
-  current_resolution = nullptr;
-}
+    ~ResolutionChangeInfo() {}
 
 ResolutionNotificationController::ResolutionNotificationController() {
   Shell::GetInstance()->window_tree_host_manager()->AddObserver(this);
@@ -163,25 +159,22 @@ ResolutionNotificationController::~ResolutionNotificationController() {
 
 void ResolutionNotificationController::PrepareNotification(
     int64_t display_id,
-    const scoped_refptr<DisplayMode>& old_resolution,
-    const scoped_refptr<DisplayMode>& new_resolution,
+    const DisplayMode& old_resolution,
+    const DisplayMode& new_resolution,
     const base::Closure& accept_callback) {
-  DCHECK(old_resolution);
-  DCHECK(new_resolution);
-
   DCHECK(!display::Display::IsInternalDisplayId(display_id));
   // If multiple resolution changes are invoked for the same display,
   // the original resolution for the first resolution change has to be used
   // instead of the specified |old_resolution|.
-  scoped_refptr<DisplayMode> original_resolution;
+  DisplayMode original_resolution;
   if (change_info_ && change_info_->display_id == display_id) {
-    DCHECK(change_info_->new_resolution->size() == old_resolution->size());
+    DCHECK(change_info_->new_resolution.size == old_resolution.size);
     original_resolution = change_info_->old_resolution;
   }
 
   change_info_.reset(new ResolutionChangeInfo(display_id, old_resolution,
                                               new_resolution, accept_callback));
-  if (original_resolution && !original_resolution->size().IsEmpty())
+  if (!original_resolution.size.IsEmpty())
     change_info_->old_resolution = original_resolution;
 }
 
@@ -218,19 +211,17 @@ void ResolutionNotificationController::CreateOrUpdateNotification(
       Shell::GetInstance()->display_manager()->GetDisplayNameForId(
           change_info_->display_id));
   const base::string16 message =
-      (change_info_->new_resolution->size() ==
-       change_info_->current_resolution->size())
+      (change_info_->new_resolution.size ==
+       change_info_->current_resolution.size)
           ? l10n_util::GetStringFUTF16(
                 IDS_ASH_STATUS_TRAY_DISPLAY_RESOLUTION_CHANGED, display_name,
-                base::UTF8ToUTF16(
-                    change_info_->new_resolution->size().ToString()))
+                base::UTF8ToUTF16(change_info_->new_resolution.size.ToString()))
           : l10n_util::GetStringFUTF16(
                 IDS_ASH_STATUS_TRAY_DISPLAY_RESOLUTION_CHANGED_TO_UNSUPPORTED,
                 display_name,
+                base::UTF8ToUTF16(change_info_->new_resolution.size.ToString()),
                 base::UTF8ToUTF16(
-                    change_info_->new_resolution->size().ToString()),
-                base::UTF8ToUTF16(
-                    change_info_->current_resolution->size().ToString()));
+                    change_info_->current_resolution.size.ToString()));
 
   ui::ResourceBundle& bundle = ui::ResourceBundle::GetSharedInstance();
   std::unique_ptr<Notification> notification(new Notification(
@@ -276,7 +267,7 @@ void ResolutionNotificationController::RevertResolutionChange() {
   if (!change_info_)
     return;
   int64_t display_id = change_info_->display_id;
-  scoped_refptr<DisplayMode> old_resolution = change_info_->old_resolution;
+  DisplayMode old_resolution = change_info_->old_resolution;
   change_info_.reset();
   Shell::GetInstance()->display_manager()->SetDisplayMode(display_id,
                                                           old_resolution);
diff --git a/ash/display/resolution_notification_controller.h b/ash/display/resolution_notification_controller.h
index ad27b52..6ad59f9 100644
--- a/ash/display/resolution_notification_controller.h
+++ b/ash/display/resolution_notification_controller.h
@@ -27,7 +27,7 @@ class Widget;
 
 namespace ash {
 
-class DisplayMode;
+struct DisplayMode;
 
 // A class which manages the notification of display resolution change and
 // also manages the timeout in case the new resolution is unusable.
@@ -51,8 +51,8 @@ class ASH_EXPORT ResolutionNotificationController
   // method will be combined with resolution change methods like
   // DisplayManager::SetDisplayMode().
   void PrepareNotification(int64_t display_id,
-                           const scoped_refptr<DisplayMode>& old_resolution,
-                           const scoped_refptr<DisplayMode>& new_resolution,
+                           const DisplayMode& old_resolution,
+                           const DisplayMode& new_resolution,
                            const base::Closure& accept_callback);
 
   // Returns true if the notification is visible or scheduled to be visible and
diff --git a/ash/display/resolution_notification_controller_unittest.cc b/ash/display/resolution_notification_controller_unittest.cc
index addaace..5bf87a8 100644
--- a/ash/display/resolution_notification_controller_unittest.cc
+++ b/ash/display/resolution_notification_controller_unittest.cc
@@ -64,13 +64,10 @@ class ResolutionNotificationControllerTest : public ash::test::AshTestBase {
     DisplayManager* display_manager = Shell::GetInstance()->display_manager();
 
     const DisplayInfo& info = display_manager->GetDisplayInfo(display.id());
-    scoped_refptr<DisplayMode> old_mode(
-        new DisplayMode(info.size_in_pixel(), 60 /* refresh_rate */,
-                        false /* interlaced */, false /* native */));
-    scoped_refptr<DisplayMode> new_mode(
-        new DisplayMode(new_resolution, old_mode->refresh_rate(),
-                        old_mode->is_interlaced(), old_mode->native(),
-                        old_mode->ui_scale(), old_mode->device_scale_factor()));
+    DisplayMode old_mode(info.size_in_pixel(), 60 /* refresh_rate */,
+                         false /* interlaced */, false /* native */);
+    DisplayMode new_mode = old_mode;
+    new_mode.size = new_resolution;
 
     if (display_manager->SetDisplayMode(display.id(), new_mode)) {
       controller()->PrepareNotification(
@@ -173,21 +170,19 @@ TEST_F(ResolutionNotificationControllerTest, Basic) {
   EXPECT_FALSE(controller()->DoesNotificationTimeout());
   EXPECT_EQ(ExpectedNotificationMessage(id2, gfx::Size(200, 200)),
             GetNotificationMessage());
-  scoped_refptr<DisplayMode> mode =
-      display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("200x200", mode->size().ToString());
-  EXPECT_EQ(60.0, mode->refresh_rate());
+  DisplayMode mode;
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("200x200", mode.size.ToString());
+  EXPECT_EQ(60.0, mode.refresh_rate);
 
   // Click the revert button, which reverts to the best resolution.
   ClickOnNotificationButton(0);
   RunAllPendingInMessageLoop();
   EXPECT_FALSE(IsNotificationVisible());
   EXPECT_EQ(0, accept_count());
-  mode = display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("250x250", mode->size().ToString());
-  EXPECT_EQ(59.0, mode->refresh_rate());
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("250x250", mode.size.ToString());
+  EXPECT_EQ(59.0, mode.refresh_rate);
 }
 
 TEST_F(ResolutionNotificationControllerTest, ClickMeansAccept) {
@@ -206,21 +201,19 @@ TEST_F(ResolutionNotificationControllerTest, ClickMeansAccept) {
                                 gfx::Size(200, 200));
   EXPECT_TRUE(IsNotificationVisible());
   EXPECT_FALSE(controller()->DoesNotificationTimeout());
-  scoped_refptr<DisplayMode> mode =
-      display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("200x200", mode->size().ToString());
-  EXPECT_EQ(60.0, mode->refresh_rate());
+  DisplayMode mode;
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("200x200", mode.size.ToString());
+  EXPECT_EQ(60.0, mode.refresh_rate);
 
   // Click the revert button, which reverts the resolution.
   ClickOnNotification();
   RunAllPendingInMessageLoop();
   EXPECT_FALSE(IsNotificationVisible());
   EXPECT_EQ(1, accept_count());
-  mode = display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("200x200", mode->size().ToString());
-  EXPECT_EQ(60.0, mode->refresh_rate());
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("200x200", mode.size.ToString());
+  EXPECT_EQ(60.0, mode.refresh_rate);
 }
 
 TEST_F(ResolutionNotificationControllerTest, AcceptButton) {
@@ -242,13 +235,11 @@ TEST_F(ResolutionNotificationControllerTest, AcceptButton) {
   ClickOnNotificationButton(0);
   EXPECT_FALSE(IsNotificationVisible());
   EXPECT_EQ(1, accept_count());
-
-  scoped_refptr<DisplayMode> mode =
-      display_manager->GetSelectedModeForDisplayId(display.id());
-  EXPECT_TRUE(!!mode);
-
-  EXPECT_EQ("200x200", mode->size().ToString());
-  EXPECT_EQ(60.0f, mode->refresh_rate());
+  DisplayMode mode;
+  EXPECT_TRUE(
+      display_manager->GetSelectedModeForDisplayId(display.id(), &mode));
+  EXPECT_EQ("200x200", mode.size.ToString());
+  EXPECT_EQ(60.0f, mode.refresh_rate);
 
   // In that case the second button is revert.
   UpdateDisplay("300x300#300x300%59|200x200%60");
@@ -259,11 +250,10 @@ TEST_F(ResolutionNotificationControllerTest, AcceptButton) {
   ClickOnNotificationButton(1);
   EXPECT_FALSE(IsNotificationVisible());
   EXPECT_EQ(1, accept_count());
-  mode = display_manager->GetSelectedModeForDisplayId(display.id());
-  EXPECT_TRUE(!!mode);
-
-  EXPECT_EQ("300x300", mode->size().ToString());
-  EXPECT_EQ(59.0f, mode->refresh_rate());
+  EXPECT_TRUE(
+      display_manager->GetSelectedModeForDisplayId(display.id(), &mode));
+  EXPECT_EQ("300x300", mode.size.ToString());
+  EXPECT_EQ(59.0f, mode.refresh_rate);
 }
 
 TEST_F(ResolutionNotificationControllerTest, Close) {
@@ -282,11 +272,10 @@ TEST_F(ResolutionNotificationControllerTest, Close) {
                                 gfx::Size(200, 200));
   EXPECT_TRUE(IsNotificationVisible());
   EXPECT_FALSE(controller()->DoesNotificationTimeout());
-  scoped_refptr<DisplayMode> mode =
-      display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("200x200", mode->size().ToString());
-  EXPECT_EQ(60.0f, mode->refresh_rate());
+  DisplayMode mode;
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("200x200", mode.size.ToString());
+  EXPECT_EQ(60.0f, mode.refresh_rate);
 
   // Close the notification (imitates clicking [x] button). Also verifies if
   // this does not cause a crash.  See crbug.com/271784
@@ -315,11 +304,11 @@ TEST_F(ResolutionNotificationControllerTest, Timeout) {
   EXPECT_EQ(0, accept_count());
   ash::DisplayManager* display_manager =
       ash::Shell::GetInstance()->display_manager();
-  scoped_refptr<DisplayMode> mode =
-      display_manager->GetSelectedModeForDisplayId(display.id());
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("300x300", mode->size().ToString());
-  EXPECT_EQ(59.0f, mode->refresh_rate());
+  DisplayMode mode;
+  EXPECT_TRUE(
+      display_manager->GetSelectedModeForDisplayId(display.id(), &mode));
+  EXPECT_EQ("300x300", mode.size.ToString());
+  EXPECT_EQ(59.0f, mode.refresh_rate);
 }
 
 TEST_F(ResolutionNotificationControllerTest, DisplayDisconnected) {
@@ -341,12 +330,11 @@ TEST_F(ResolutionNotificationControllerTest, DisplayDisconnected) {
   RunAllPendingInMessageLoop();
   EXPECT_FALSE(IsNotificationVisible());
   EXPECT_EQ(0, accept_count());
-  scoped_refptr<DisplayMode> mode =
-      display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
+  DisplayMode mode;
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
   gfx::Size resolution;
-  EXPECT_EQ("200x200", mode->size().ToString());
-  EXPECT_EQ(59.0f, mode->refresh_rate());
+  EXPECT_EQ("200x200", mode.size.ToString());
+  EXPECT_EQ(59.0f, mode.refresh_rate);
 }
 
 TEST_F(ResolutionNotificationControllerTest, MultipleResolutionChange) {
@@ -364,20 +352,18 @@ TEST_F(ResolutionNotificationControllerTest, MultipleResolutionChange) {
                                 gfx::Size(200, 200));
   EXPECT_TRUE(IsNotificationVisible());
   EXPECT_FALSE(controller()->DoesNotificationTimeout());
-  scoped_refptr<DisplayMode> mode =
-      display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("200x200", mode->size().ToString());
-  EXPECT_EQ(59.0f, mode->refresh_rate());
+  DisplayMode mode;
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("200x200", mode.size.ToString());
+  EXPECT_EQ(59.0f, mode.refresh_rate);
 
   // Invokes SetDisplayResolutionAndNotify during the previous notification is
   // visible.
   SetDisplayResolutionAndNotify(ScreenUtil::GetSecondaryDisplay(),
                                 gfx::Size(250, 250));
-  mode = display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("250x250", mode->size().ToString());
-  EXPECT_EQ(58.0f, mode->refresh_rate());
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("250x250", mode.size.ToString());
+  EXPECT_EQ(58.0f, mode.refresh_rate);
 
   // Then, click the revert button. Although |old_resolution| for the second
   // SetDisplayResolutionAndNotify is 200x200, it should revert to the original
@@ -386,10 +372,9 @@ TEST_F(ResolutionNotificationControllerTest, MultipleResolutionChange) {
   RunAllPendingInMessageLoop();
   EXPECT_FALSE(IsNotificationVisible());
   EXPECT_EQ(0, accept_count());
-  mode = display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("250x250", mode->size().ToString());
-  EXPECT_EQ(58.0f, mode->refresh_rate());
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("250x250", mode.size.ToString());
+  EXPECT_EQ(58.0f, mode.refresh_rate);
 }
 
 TEST_F(ResolutionNotificationControllerTest, Fallback) {
@@ -414,22 +399,19 @@ TEST_F(ResolutionNotificationControllerTest, Fallback) {
   EXPECT_EQ(ExpectedFallbackNotificationMessage(id2, gfx::Size(220, 220),
                                                 gfx::Size(200, 200)),
             GetNotificationMessage());
-  scoped_refptr<DisplayMode> mode =
-      display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("200x200", mode->size().ToString());
-  EXPECT_EQ(60.0f, mode->refresh_rate());
+  DisplayMode mode;
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("200x200", mode.size.ToString());
+  EXPECT_EQ(60.0f, mode.refresh_rate);
 
   // Click the revert button, which reverts to the best resolution.
   ClickOnNotificationButton(0);
   RunAllPendingInMessageLoop();
   EXPECT_FALSE(IsNotificationVisible());
   EXPECT_EQ(0, accept_count());
-
-  mode = display_manager->GetSelectedModeForDisplayId(id2);
-  EXPECT_TRUE(!!mode);
-  EXPECT_EQ("250x250", mode->size().ToString());
-  EXPECT_EQ(58.0f, mode->refresh_rate());
+  EXPECT_TRUE(display_manager->GetSelectedModeForDisplayId(id2, &mode));
+  EXPECT_EQ("250x250", mode.size.ToString());
+  EXPECT_EQ(58.0f, mode.refresh_rate);
 }
 
 }  // namespace ash
diff --git a/ash/display/window_tree_host_manager.cc b/ash/display/window_tree_host_manager.cc
index 8179cbe..79badc2 100644
--- a/ash/display/window_tree_host_manager.cc
+++ b/ash/display/window_tree_host_manager.cc
@@ -136,12 +136,12 @@ void SetDisplayPropertiesOnHost(AshWindowTreeHost* ash_host,
       CreateRootWindowTransformerForDisplay(host->window(), display));
   ash_host->SetRootWindowTransformer(std::move(transformer));
 
-  scoped_refptr<DisplayMode> mode =
+  DisplayMode mode =
       GetDisplayManager()->GetActiveModeForDisplayId(display.id());
-  if (mode && mode->refresh_rate() > 0.0f) {
+  if (mode.refresh_rate > 0.0f) {
     host->compositor()->SetAuthoritativeVSyncInterval(
         base::TimeDelta::FromMicroseconds(base::Time::kMicrosecondsPerSecond /
-                                          mode->refresh_rate()));
+                                          mode.refresh_rate));
   }
 
   // Just movnig the display requires the full redraw.
diff --git a/ash/display/window_tree_host_manager_unittest.cc b/ash/display/window_tree_host_manager_unittest.cc
index dd481bb..a754e19 100644
--- a/ash/display/window_tree_host_manager_unittest.cc
+++ b/ash/display/window_tree_host_manager_unittest.cc
@@ -6,13 +6,11 @@
 
 #include <memory>
 
-#include "ash/aura/wm_window_aura.h"
 #include "ash/common/ash_switches.h"
 #include "ash/common/display/display_info.h"
 #include "ash/common/material_design/material_design_controller.h"
 #include "ash/common/wm/window_state.h"
 #include "ash/common/wm/wm_event.h"
-#include "ash/common/wm/wm_screen_util.h"
 #include "ash/display/display_layout_store.h"
 #include "ash/display/display_manager.h"
 #include "ash/display/display_util.h"
@@ -1299,8 +1297,7 @@ class RootWindowTestObserver : public aura::WindowObserver {
   void OnWindowBoundsChanged(aura::Window* window,
                              const gfx::Rect& old_bounds,
                              const gfx::Rect& new_bounds) override {
-    shelf_display_bounds_ =
-        wm::GetDisplayBoundsWithShelf(WmWindowAura::Get(window));
+    shelf_display_bounds_ = ScreenUtil::GetShelfDisplayBoundsInRoot(window);
   }
 
   const gfx::Rect& shelf_display_bounds() const {
@@ -1315,8 +1312,8 @@ class RootWindowTestObserver : public aura::WindowObserver {
 
 }  // names
 
-// Make sure that GetDisplayBoundsWithShelf returns the correct bounds
-// when the primary display gets replaced in one of the following scenarios:
+// Make sure that GetShelfDisplayBoundsInRoot returns the correct bounds
+// when primary display gets replaced in a following scenario.
 // 1) Two displays connected: a) b)
 // 2) both are disconnected and new one with the same size as b) is connected
 // in one configuration event.
diff --git a/ash/drag_drop/drag_drop_controller.cc b/ash/drag_drop/drag_drop_controller.cc
index ab9e48c..4ace737 100644
--- a/ash/drag_drop/drag_drop_controller.cc
+++ b/ash/drag_drop/drag_drop_controller.cc
@@ -6,10 +6,8 @@
 
 #include <utility>
 
-#include "ash/aura/wm_window_aura.h"
-#include "ash/common/drag_drop/drag_image_view.h"
-#include "ash/common/wm_shell.h"
 #include "ash/drag_drop/drag_drop_tracker.h"
+#include "ash/drag_drop/drag_image_view.h"
 #include "ash/shell.h"
 #include "base/bind.h"
 #include "base/message_loop/message_loop.h"
@@ -136,11 +134,9 @@ DragDropController::DragDropController()
       current_drag_event_source_(ui::DragDropTypes::DRAG_EVENT_SOURCE_MOUSE),
       weak_factory_(this) {
   Shell::GetInstance()->PrependPreTargetHandler(this);
-  WmShell::Get()->AddDisplayObserver(this);
 }
 
 DragDropController::~DragDropController() {
-  WmShell::Get()->RemoveDisplayObserver(this);
   Shell::GetInstance()->RemovePreTargetHandler(this);
   Cleanup();
   if (cancel_animation_)
@@ -203,8 +199,7 @@ int DragDropController::StartDragAndDrop(
   drag_image_final_bounds_for_cancel_animation_ =
       gfx::Rect(start_location - provider->GetDragImageOffset(),
                 provider->GetDragImage().size());
-  drag_image_.reset(new DragImageView(
-      WmWindowAura::Get(source_window->GetRootWindow()), source));
+  drag_image_.reset(new DragImageView(source_window->GetRootWindow(), source));
   drag_image_->SetImage(provider->GetDragImage());
   drag_image_offset_ = provider->GetDragImageOffset();
   gfx::Rect drag_image_bounds(start_location, drag_image_->GetPreferredSize());
@@ -542,13 +537,6 @@ void DragDropController::AnimationCanceled(const gfx::Animation* animation) {
   AnimationEnded(animation);
 }
 
-void DragDropController::OnDisplayConfigurationChanging() {
-  // Abort in-progress drags if a monitor is added or removed because the drag
-  // image widget's container may be destroyed.
-  if (IsDragDropInProgress())
-    DragCancel();
-}
-
 void DragDropController::StartCanceledAnimation(int animation_duration_ms) {
   DCHECK(drag_image_.get());
   drag_image_->SetTouchDragOperationHintOff();
diff --git a/ash/drag_drop/drag_drop_controller.h b/ash/drag_drop/drag_drop_controller.h
index fcd114d..dbe2658 100644
--- a/ash/drag_drop/drag_drop_controller.h
+++ b/ash/drag_drop/drag_drop_controller.h
@@ -8,7 +8,6 @@
 #include <memory>
 
 #include "ash/ash_export.h"
-#include "ash/common/wm_display_observer.h"
 #include "base/callback.h"
 #include "base/macros.h"
 #include "base/memory/weak_ptr.h"
@@ -36,8 +35,7 @@ class DragDropControllerTest;
 class ASH_EXPORT DragDropController : public aura::client::DragDropClient,
                                       public ui::EventHandler,
                                       public gfx::AnimationDelegate,
-                                      public aura::WindowObserver,
-                                      public WmDisplayObserver {
+                                      public aura::WindowObserver {
  public:
   DragDropController();
   ~DragDropController() override;
@@ -87,9 +85,6 @@ class ASH_EXPORT DragDropController : public aura::client::DragDropClient,
   void AnimationProgressed(const gfx::Animation* animation) override;
   void AnimationCanceled(const gfx::Animation* animation) override;
 
-  // WmDisplayObserver:
-  void OnDisplayConfigurationChanging() override;
-
   // Helper method to start drag widget flying back animation.
   void StartCanceledAnimation(int animation_duration_ms);
 
diff --git a/ash/drag_drop/drag_drop_controller_unittest.cc b/ash/drag_drop/drag_drop_controller_unittest.cc
index 1d18c77..4d2911d 100644
--- a/ash/drag_drop/drag_drop_controller_unittest.cc
+++ b/ash/drag_drop/drag_drop_controller_unittest.cc
@@ -4,8 +4,8 @@
 
 #include "ash/drag_drop/drag_drop_controller.h"
 
-#include "ash/common/drag_drop/drag_image_view.h"
 #include "ash/drag_drop/drag_drop_tracker.h"
+#include "ash/drag_drop/drag_image_view.h"
 #include "ash/shell.h"
 #include "ash/test/ash_test_base.h"
 #include "base/command_line.h"
@@ -1054,47 +1054,6 @@ TEST_F(DragDropControllerTest, DragCancelAcrossDisplays) {
   }
 }
 
-// Verifies that a drag is aborted if a display is disconnected during the drag.
-TEST_F(DragDropControllerTest, DragCancelOnDisplayDisconnect) {
-  if (!SupportsMultipleDisplays())
-    return;
-
-  UpdateDisplay("400x400,400x400");
-  for (aura::Window* root : Shell::GetInstance()->GetAllRootWindows()) {
-    aura::client::SetDragDropClient(root, drag_drop_controller_.get());
-  }
-
-  ui::OSExchangeData data;
-  data.SetString(base::UTF8ToUTF16("I am being dragged"));
-  std::unique_ptr<views::Widget> widget(CreateNewWidget());
-  aura::Window* window = widget->GetNativeWindow();
-  drag_drop_controller_->StartDragAndDrop(
-      data, window->GetRootWindow(), window, gfx::Point(5, 5),
-      ui::DragDropTypes::DRAG_MOVE, ui::DragDropTypes::DRAG_EVENT_SOURCE_MOUSE);
-
-  // Start dragging.
-  ui::MouseEvent e1(ui::ET_MOUSE_DRAGGED, gfx::Point(200, 0),
-                    gfx::Point(200, 0), ui::EventTimeForNow(), ui::EF_NONE,
-                    ui::EF_NONE);
-  drag_drop_controller_->DragUpdate(window, e1);
-  EXPECT_TRUE(drag_drop_controller_->drag_start_received_);
-  EXPECT_TRUE(drag_drop_controller_->IsDragDropInProgress());
-
-  // Drag onto the secondary display.
-  ui::MouseEvent e2(ui::ET_MOUSE_DRAGGED, gfx::Point(600, 0),
-                    gfx::Point(600, 0), ui::EventTimeForNow(), ui::EF_NONE,
-                    ui::EF_NONE);
-  drag_drop_controller_->DragUpdate(window, e2);
-  EXPECT_TRUE(drag_drop_controller_->IsDragDropInProgress());
-
-  // Disconnect the secondary display.
-  UpdateDisplay("800x600");
-
-  // The drag is canceled.
-  EXPECT_TRUE(drag_drop_controller_->drag_canceled_);
-  EXPECT_FALSE(drag_drop_controller_->IsDragDropInProgress());
-}
-
 TEST_F(DragDropControllerTest, TouchDragDropCompletesOnFling) {
   base::CommandLine::ForCurrentProcess()->AppendSwitch(
       switches::kEnableTouchDragDrop);
diff --git a/ash/drag_drop/drag_image_view.cc b/ash/drag_drop/drag_image_view.cc
new file mode 100644
index 0000000..bacdaee
--- /dev/null
+++ b/ash/drag_drop/drag_image_view.cc
@@ -0,0 +1,187 @@
+// Copyright (c) 2012 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "ash/drag_drop/drag_image_view.h"
+
+#include "skia/ext/image_operations.h"
+#include "ui/aura/window.h"
+#include "ui/base/resource/resource_bundle.h"
+#include "ui/compositor/dip_util.h"
+#include "ui/gfx/canvas.h"
+#include "ui/gfx/geometry/size_conversions.h"
+#include "ui/resources/grit/ui_resources.h"
+#include "ui/views/widget/widget.h"
+#include "ui/wm/core/shadow_types.h"
+
+namespace ash {
+namespace {
+using views::Widget;
+
+Widget* CreateDragWidget(gfx::NativeView context) {
+  Widget* drag_widget = new Widget;
+  Widget::InitParams params;
+  params.type = Widget::InitParams::TYPE_TOOLTIP;
+  params.keep_on_top = true;
+  params.context = context;
+  params.accept_events = false;
+  params.ownership = Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET;
+  params.opacity = Widget::InitParams::TRANSLUCENT_WINDOW;
+  drag_widget->Init(params);
+  drag_widget->SetOpacity(1.f);
+  drag_widget->GetNativeWindow()->set_owned_by_parent(false);
+  drag_widget->GetNativeWindow()->SetName("DragWidget");
+  SetShadowType(drag_widget->GetNativeView(), wm::SHADOW_TYPE_NONE);
+  return drag_widget;
+}
+}
+
+DragImageView::DragImageView(gfx::NativeView context,
+                             ui::DragDropTypes::DragEventSource event_source)
+    : views::ImageView(),
+      drag_event_source_(event_source),
+      touch_drag_operation_(ui::DragDropTypes::DRAG_NONE) {
+  widget_.reset(CreateDragWidget(context));
+  widget_->SetContentsView(this);
+  widget_->SetAlwaysOnTop(true);
+
+  // We are owned by the DragDropController.
+  set_owned_by_client();
+}
+
+DragImageView::~DragImageView() {
+  widget_->Hide();
+}
+
+void DragImageView::SetBoundsInScreen(const gfx::Rect& bounds) {
+  widget_->SetBounds(bounds);
+  widget_size_ = bounds.size();
+}
+
+void DragImageView::SetScreenPosition(const gfx::Point& position) {
+  widget_->SetBounds(gfx::Rect(position, widget_size_));
+}
+
+gfx::Rect DragImageView::GetBoundsInScreen() const {
+  return widget_->GetWindowBoundsInScreen();
+}
+
+void DragImageView::SetWidgetVisible(bool visible) {
+  if (visible != widget_->IsVisible()) {
+    if (visible)
+      widget_->Show();
+    else
+      widget_->Hide();
+  }
+}
+
+void DragImageView::SetTouchDragOperationHintOff() {
+  // Simply set the drag type to non-touch so that no hint is drawn.
+  drag_event_source_ = ui::DragDropTypes::DRAG_EVENT_SOURCE_MOUSE;
+  SchedulePaint();
+}
+
+void DragImageView::SetTouchDragOperation(int operation) {
+  if (touch_drag_operation_ == operation)
+    return;
+  touch_drag_operation_ = operation;
+  SchedulePaint();
+}
+
+void DragImageView::SetTouchDragOperationHintPosition(
+    const gfx::Point& position) {
+  if (touch_drag_operation_indicator_position_ == position)
+    return;
+  touch_drag_operation_indicator_position_ = position;
+  SchedulePaint();
+}
+
+void DragImageView::SetOpacity(float visibility) {
+  DCHECK_GE(visibility, 0.0f);
+  DCHECK_LE(visibility, 1.0f);
+  widget_->SetOpacity(visibility);
+}
+
+void DragImageView::OnPaint(gfx::Canvas* canvas) {
+  if (GetImage().isNull())
+    return;
+
+  // |widget_size_| is in DIP. ImageSkia::size() also returns the size in DIP.
+  if (GetImage().size() == widget_size_) {
+    canvas->DrawImageInt(GetImage(), 0, 0);
+  } else {
+    float device_scale = 1;
+    if (widget_->GetNativeView() && widget_->GetNativeView()->layer()) {
+      device_scale =
+          ui::GetDeviceScaleFactor(widget_->GetNativeView()->layer());
+    }
+    // The drag image already has device scale factor applied. But
+    // |widget_size_| is in DIP units.
+    gfx::Size scaled_widget_size =
+        gfx::ScaleToRoundedSize(widget_size_, device_scale);
+    gfx::ImageSkiaRep image_rep = GetImage().GetRepresentation(device_scale);
+    if (image_rep.is_null())
+      return;
+    SkBitmap scaled = skia::ImageOperations::Resize(
+        image_rep.sk_bitmap(), skia::ImageOperations::RESIZE_LANCZOS3,
+        scaled_widget_size.width(), scaled_widget_size.height());
+    gfx::ImageSkia image_skia(gfx::ImageSkiaRep(scaled, device_scale));
+    canvas->DrawImageInt(image_skia, 0, 0);
+  }
+
+  if (drag_event_source_ != ui::DragDropTypes::DRAG_EVENT_SOURCE_TOUCH)
+    return;
+
+  gfx::Image* drag_hint = DragHint();
+  if (drag_hint->IsEmpty())
+    return;
+
+  // Make sure drag hint image is positioned within the widget.
+  gfx::Size drag_hint_size = drag_hint->Size();
+  gfx::Point drag_hint_position = touch_drag_operation_indicator_position_;
+  drag_hint_position.Offset(-drag_hint_size.width() / 2, 0);
+  gfx::Rect drag_hint_bounds(drag_hint_position, drag_hint_size);
+  drag_hint_bounds.AdjustToFit(gfx::Rect(widget_size_));
+
+  // Draw image.
+  canvas->DrawImageInt(*(drag_hint->ToImageSkia()), drag_hint_bounds.x(),
+                       drag_hint_bounds.y());
+}
+
+gfx::Image* DragImageView::DragHint() const {
+  // Select appropriate drag hint.
+  gfx::Image* drag_hint =
+      &ui::ResourceBundle::GetSharedInstance().GetImageNamed(
+          IDR_TOUCH_DRAG_TIP_NODROP);
+  if (touch_drag_operation_ & ui::DragDropTypes::DRAG_COPY) {
+    drag_hint = &ui::ResourceBundle::GetSharedInstance().GetImageNamed(
+        IDR_TOUCH_DRAG_TIP_COPY);
+  } else if (touch_drag_operation_ & ui::DragDropTypes::DRAG_MOVE) {
+    drag_hint = &ui::ResourceBundle::GetSharedInstance().GetImageNamed(
+        IDR_TOUCH_DRAG_TIP_MOVE);
+  } else if (touch_drag_operation_ & ui::DragDropTypes::DRAG_LINK) {
+    drag_hint = &ui::ResourceBundle::GetSharedInstance().GetImageNamed(
+        IDR_TOUCH_DRAG_TIP_LINK);
+  }
+  return drag_hint;
+}
+
+void DragImageView::Layout() {
+  View::Layout();
+
+  gfx::Image* drag_hint = DragHint();
+  if (drag_hint->IsEmpty())
+    return;
+
+  gfx::Size drag_hint_size = drag_hint->Size();
+
+  // Enlarge widget if required to fit the drag hint image.
+  if (drag_hint_size.width() > widget_size_.width() ||
+      drag_hint_size.height() > widget_size_.height()) {
+    gfx::Size new_widget_size = widget_size_;
+    new_widget_size.SetToMax(drag_hint_size);
+    widget_->SetSize(new_widget_size);
+  }
+}
+
+}  // namespace ash
diff --git a/ash/drag_drop/drag_image_view.h b/ash/drag_drop/drag_image_view.h
new file mode 100644
index 0000000..8211c76
--- /dev/null
+++ b/ash/drag_drop/drag_image_view.h
@@ -0,0 +1,88 @@
+// Copyright (c) 2012 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef ASH_DRAG_DROP_DRAG_IMAGE_VIEW_H_
+#define ASH_DRAG_DROP_DRAG_IMAGE_VIEW_H_
+
+#include <memory>
+
+#include "base/macros.h"
+#include "ui/base/dragdrop/drag_drop_types.h"
+#include "ui/views/controls/image_view.h"
+
+namespace gfx {
+class Image;
+}
+
+namespace views {
+class Widget;
+}
+
+namespace ash {
+
+// This class allows to show a (native) view always on top of everything. It
+// does this by creating a widget and setting the content as the given view. The
+// caller can then use this object to freely move / drag it around on the
+// desktop in screen coordinates.
+class DragImageView : public views::ImageView {
+ public:
+  // |context is the native view context used to create the widget holding the
+  // drag image.
+  // |source| is the event source that started this drag drop operation (touch
+  // or mouse). It is used to determine attributes of the drag image such as
+  // whether to show drag operation hint on top of the image.
+  DragImageView(gfx::NativeView context,
+                ui::DragDropTypes::DragEventSource source);
+  ~DragImageView() override;
+
+  // Sets the bounds of the native widget in screen
+  // coordinates.
+  // TODO(oshima): Looks like this is root window's
+  // coordinate. Change this to screen's coordinate.
+  void SetBoundsInScreen(const gfx::Rect& bounds);
+
+  // Sets the position of the native widget.
+  void SetScreenPosition(const gfx::Point& position);
+
+  // Gets the image position in screen coordinates.
+  gfx::Rect GetBoundsInScreen() const;
+
+  // Sets the visibility of the native widget.
+  void SetWidgetVisible(bool visible);
+
+  // For touch drag drop, we show a hint corresponding to the drag operation
+  // (since no mouse cursor is visible). These functions set the hint
+  // parameters.
+  void SetTouchDragOperationHintOff();
+
+  // |operation| is a bit field indicating allowable drag operations from
+  // ui::DragDropTypes::DragOperation.
+  void SetTouchDragOperation(int operation);
+  void SetTouchDragOperationHintPosition(const gfx::Point& position);
+
+  // Sets the |opacity| of the image view between 0.0 and 1.0.
+  void SetOpacity(float opacity);
+
+ private:
+  gfx::Image* DragHint() const;
+
+  // Overridden from views::ImageView.
+  void OnPaint(gfx::Canvas* canvas) override;
+
+  // Overridden from views::view
+  void Layout() override;
+
+  std::unique_ptr<views::Widget> widget_;
+  gfx::Size widget_size_;
+
+  ui::DragDropTypes::DragEventSource drag_event_source_;
+  int touch_drag_operation_;
+  gfx::Point touch_drag_operation_indicator_position_;
+
+  DISALLOW_COPY_AND_ASSIGN(DragImageView);
+};
+
+}  // namespace ash
+
+#endif  // ASH_DRAG_DROP_DRAG_IMAGE_VIEW_H_
diff --git a/ash/frame/caption_buttons/caption_button_types.h b/ash/frame/caption_buttons/caption_button_types.h
new file mode 100644
index 0000000..ece7d8e
--- /dev/null
+++ b/ash/frame/caption_buttons/caption_button_types.h
@@ -0,0 +1,25 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef ASH_FRAME_CAPTION_BUTTONS_CAPTION_BUTTON_TYPES_H_
+#define ASH_FRAME_CAPTION_BUTTONS_CAPTION_BUTTON_TYPES_H_
+
+namespace ash {
+
+// These are the icon types that a caption button can have. The size button's
+// action (SnapType) can be different from its icon.
+enum CaptionButtonIcon {
+  CAPTION_BUTTON_ICON_MINIMIZE,
+  CAPTION_BUTTON_ICON_MAXIMIZE_RESTORE,
+  CAPTION_BUTTON_ICON_CLOSE,
+  CAPTION_BUTTON_ICON_LEFT_SNAPPED,
+  CAPTION_BUTTON_ICON_RIGHT_SNAPPED,
+  CAPTION_BUTTON_ICON_BACK,
+  CAPTION_BUTTON_ICON_LOCATION,
+  CAPTION_BUTTON_ICON_COUNT
+};
+
+}  // namespace ash
+
+#endif  // ASH_FRAME_CAPTION_BUTTONS_CAPTION_BUTTON_TYPES_H_
diff --git a/ash/frame/caption_buttons/frame_caption_button.cc b/ash/frame/caption_buttons/frame_caption_button.cc
new file mode 100644
index 0000000..1a97d89
--- /dev/null
+++ b/ash/frame/caption_buttons/frame_caption_button.cc
@@ -0,0 +1,189 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "ash/frame/caption_buttons/frame_caption_button.h"
+
+#include "ui/gfx/animation/slide_animation.h"
+#include "ui/gfx/animation/throb_animation.h"
+#include "ui/gfx/canvas.h"
+#include "ui/gfx/color_palette.h"
+#include "ui/gfx/paint_vector_icon.h"
+#include "ui/gfx/vector_icons_public.h"
+
+namespace ash {
+
+namespace {
+
+// The duration of the crossfade animation when swapping the button's images.
+const int kSwapImagesAnimationDurationMs = 200;
+
+// The duration of the fade out animation of the old icon during a crossfade
+// animation as a ratio of |kSwapImagesAnimationDurationMs|.
+const float kFadeOutRatio = 0.5f;
+
+// The alpha to draw inactive icons with.
+const float kInactiveIconAlpha = 0.2f;
+
+// The colors and alpha values used for the button background hovered and
+// pressed states.
+// TODO(tdanderson|estade): Request these colors from ThemeProvider.
+const int kHoveredAlpha = 0x14;
+const int kPressedAlpha = 0x24;
+
+}  // namespace
+
+// static
+const char FrameCaptionButton::kViewClassName[] = "FrameCaptionButton";
+
+FrameCaptionButton::FrameCaptionButton(views::ButtonListener* listener,
+                                       CaptionButtonIcon icon)
+    : CustomButton(listener),
+      icon_(icon),
+      paint_as_active_(false),
+      use_light_images_(false),
+      alpha_(255),
+      swap_images_animation_(new gfx::SlideAnimation(this)) {
+  swap_images_animation_->Reset(1);
+
+  // Do not flip the gfx::Canvas passed to the OnPaint() method. The snap left
+  // and snap right button icons should not be flipped. The other icons are
+  // horizontally symmetrical.
+}
+
+FrameCaptionButton::~FrameCaptionButton() {}
+
+void FrameCaptionButton::SetImage(CaptionButtonIcon icon,
+                                  Animate animate,
+                                  gfx::VectorIconId icon_image_id) {
+  gfx::ImageSkia new_icon_image = gfx::CreateVectorIcon(
+      icon_image_id, use_light_images_ ? SK_ColorWHITE : gfx::kChromeIconGrey);
+
+  // The early return is dependent on |animate| because callers use SetImage()
+  // with ANIMATE_NO to progress the crossfade animation to the end.
+  if (icon == icon_ &&
+      (animate == ANIMATE_YES || !swap_images_animation_->is_animating()) &&
+      new_icon_image.BackedBySameObjectAs(icon_image_)) {
+    return;
+  }
+
+  if (animate == ANIMATE_YES)
+    crossfade_icon_image_ = icon_image_;
+
+  icon_ = icon;
+  icon_image_id_ = icon_image_id;
+  icon_image_ = new_icon_image;
+
+  if (animate == ANIMATE_YES) {
+    swap_images_animation_->Reset(0);
+    swap_images_animation_->SetSlideDuration(kSwapImagesAnimationDurationMs);
+    swap_images_animation_->Show();
+  } else {
+    swap_images_animation_->Reset(1);
+  }
+  PreferredSizeChanged();
+  SchedulePaint();
+}
+
+bool FrameCaptionButton::IsAnimatingImageSwap() const {
+  return swap_images_animation_->is_animating();
+}
+
+void FrameCaptionButton::SetAlpha(int alpha) {
+  if (alpha_ != alpha) {
+    alpha_ = alpha;
+    SchedulePaint();
+  }
+}
+
+gfx::Size FrameCaptionButton::GetPreferredSize() const {
+  return size_;
+}
+
+const char* FrameCaptionButton::GetClassName() const {
+  return kViewClassName;
+}
+
+void FrameCaptionButton::OnPaint(gfx::Canvas* canvas) {
+  SkAlpha bg_alpha = SK_AlphaTRANSPARENT;
+  if (hover_animation().is_animating())
+    bg_alpha = hover_animation().CurrentValueBetween(0, kHoveredAlpha);
+  else if (state() == STATE_HOVERED)
+    bg_alpha = kHoveredAlpha;
+  else if (state() == STATE_PRESSED)
+    bg_alpha = kPressedAlpha;
+
+  if (bg_alpha != SK_AlphaTRANSPARENT) {
+    canvas->DrawColor(SkColorSetA(
+        use_light_images_ ? SK_ColorWHITE : SK_ColorBLACK, bg_alpha));
+  }
+
+  int icon_alpha = swap_images_animation_->CurrentValueBetween(0, 255);
+  int crossfade_icon_alpha = 0;
+  if (icon_alpha < static_cast<int>(kFadeOutRatio * 255))
+    crossfade_icon_alpha = static_cast<int>(255 - icon_alpha / kFadeOutRatio);
+
+  if (crossfade_icon_alpha > 0 && !crossfade_icon_image_.isNull()) {
+    gfx::Canvas icon_canvas(icon_image_.size(), canvas->image_scale(), false);
+    SkPaint paint;
+    paint.setAlpha(icon_alpha);
+    icon_canvas.DrawImageInt(icon_image_, 0, 0, paint);
+
+    paint.setAlpha(crossfade_icon_alpha);
+    paint.setXfermodeMode(SkXfermode::kPlus_Mode);
+    icon_canvas.DrawImageInt(crossfade_icon_image_, 0, 0, paint);
+
+    PaintCentered(canvas, gfx::ImageSkia(icon_canvas.ExtractImageRep()),
+                  alpha_);
+  } else {
+    if (!swap_images_animation_->is_animating())
+      icon_alpha = alpha_;
+    PaintCentered(canvas, icon_image_, icon_alpha);
+  }
+}
+
+void FrameCaptionButton::OnGestureEvent(ui::GestureEvent* event) {
+  // CustomButton does not become pressed when the user drags off and then back
+  // onto the button. Make FrameCaptionButton pressed in this case because this
+  // behavior is more consistent with AlternateFrameSizeButton.
+  if (event->type() == ui::ET_GESTURE_SCROLL_BEGIN ||
+      event->type() == ui::ET_GESTURE_SCROLL_UPDATE) {
+    if (HitTestPoint(event->location())) {
+      SetState(STATE_PRESSED);
+      RequestFocus();
+      event->StopPropagation();
+    } else {
+      SetState(STATE_NORMAL);
+    }
+  } else if (event->type() == ui::ET_GESTURE_SCROLL_END) {
+    if (HitTestPoint(event->location())) {
+      SetState(STATE_HOVERED);
+      NotifyClick(*event);
+      event->StopPropagation();
+    }
+  }
+  CustomButton::OnGestureEvent(event);
+}
+
+void FrameCaptionButton::PaintCentered(gfx::Canvas* canvas,
+                                       const gfx::ImageSkia& to_center,
+                                       int alpha) {
+  if (!paint_as_active_) {
+    // Paint icons as active when they are hovered over or pressed.
+    double inactive_alpha = kInactiveIconAlpha;
+    if (hover_animation().is_animating()) {
+      inactive_alpha =
+          hover_animation().CurrentValueBetween(inactive_alpha, 1.0f);
+    } else if (state() == STATE_PRESSED || state() == STATE_HOVERED) {
+      inactive_alpha = 1.0f;
+    }
+    alpha *= inactive_alpha;
+  }
+
+  SkPaint paint;
+  paint.setAlpha(alpha);
+  canvas->DrawImageInt(to_center, (width() - to_center.width()) / 2,
+                       (height() - to_center.height()) / 2, paint);
+}
+
+}  // namespace ash
diff --git a/ash/frame/caption_buttons/frame_caption_button.h b/ash/frame/caption_buttons/frame_caption_button.h
new file mode 100644
index 0000000..08cc210
--- /dev/null
+++ b/ash/frame/caption_buttons/frame_caption_button.h
@@ -0,0 +1,108 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef ASH_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_H_
+#define ASH_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_H_
+
+#include <memory>
+
+#include "ash/ash_export.h"
+#include "ash/frame/caption_buttons/caption_button_types.h"
+#include "base/macros.h"
+#include "ui/gfx/image/image_skia.h"
+#include "ui/views/controls/button/custom_button.h"
+
+namespace gfx {
+class SlideAnimation;
+enum class VectorIconId;
+}
+
+namespace ash {
+
+// Base class for the window caption buttons (minimize, maximize, restore,
+// close).
+class ASH_EXPORT FrameCaptionButton : public views::CustomButton {
+ public:
+  enum Animate { ANIMATE_YES, ANIMATE_NO };
+
+  static const char kViewClassName[];
+
+  FrameCaptionButton(views::ButtonListener* listener, CaptionButtonIcon icon);
+  ~FrameCaptionButton() override;
+
+  // Sets the image to use to paint the button. If |animate| is ANIMATE_YES,
+  // the button crossfades to the new visuals. If the image id matches the one
+  // currently used by the button and |animate| is ANIMATE_NO, the crossfade
+  // animation is progressed to the end.
+  void SetImage(CaptionButtonIcon icon,
+                Animate animate,
+                gfx::VectorIconId icon_image_id);
+
+  // Returns true if the button is crossfading to new visuals set in
+  // SetImage().
+  bool IsAnimatingImageSwap() const;
+
+  // Sets the alpha to use for painting. Used to animate visibility changes.
+  void SetAlpha(int alpha);
+
+  // views::View overrides:
+  gfx::Size GetPreferredSize() const override;
+  const char* GetClassName() const override;
+  void OnPaint(gfx::Canvas* canvas) override;
+
+  void set_paint_as_active(bool paint_as_active) {
+    paint_as_active_ = paint_as_active;
+  }
+
+  void set_use_light_images(bool light) { use_light_images_ = light; }
+
+  CaptionButtonIcon icon() const { return icon_; }
+
+  gfx::VectorIconId icon_image_id() const { return icon_image_id_; }
+
+  void set_size(const gfx::Size& size) { size_ = size; }
+
+ protected:
+  // views::CustomButton override:
+  void OnGestureEvent(ui::GestureEvent* event) override;
+
+ private:
+  // Paints |to_center| centered within the button with |alpha|.
+  void PaintCentered(gfx::Canvas* canvas,
+                     const gfx::ImageSkia& to_center,
+                     int alpha);
+
+  // The button's current icon.
+  CaptionButtonIcon icon_;
+
+  // The size of the button.
+  gfx::Size size_;
+
+  // Whether the button should be painted as active.
+  bool paint_as_active_;
+
+  // Whether to paint in a lighter color (for use on dark backgrounds).
+  bool use_light_images_;
+
+  // Current alpha to use for painting.
+  int alpha_;
+
+  // The image id (kept for the purposes of testing) and image used to paint the
+  // button's icon.
+  gfx::VectorIconId icon_image_id_;
+  gfx::ImageSkia icon_image_;
+
+  // The icon image to crossfade from.
+  gfx::ImageSkia crossfade_icon_image_;
+
+  // Crossfade animation started when the button's images are changed by
+  // SetImage().
+  std::unique_ptr<gfx::SlideAnimation> swap_images_animation_;
+
+  DISALLOW_COPY_AND_ASSIGN(FrameCaptionButton);
+};
+
+}  // namespace ash
+
+#endif  // ASH_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_H_
diff --git a/ash/frame/caption_buttons/frame_caption_button_container_view.cc b/ash/frame/caption_buttons/frame_caption_button_container_view.cc
new file mode 100644
index 0000000..6dc0028
--- /dev/null
+++ b/ash/frame/caption_buttons/frame_caption_button_container_view.cc
@@ -0,0 +1,416 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
+
+#include <cmath>
+#include <map>
+
+#include "ash/common/ash_switches.h"
+#include "ash/common/wm/maximize_mode/maximize_mode_controller.h"
+#include "ash/common/wm_shell.h"
+#include "ash/frame/caption_buttons/frame_caption_button.h"
+#include "ash/frame/caption_buttons/frame_size_button.h"
+#include "ash/shell.h"
+#include "ash/touch/touch_uma.h"
+#include "ui/base/hit_test.h"
+#include "ui/base/l10n/l10n_util.h"
+#include "ui/compositor/scoped_animation_duration_scale_mode.h"
+#include "ui/gfx/animation/slide_animation.h"
+#include "ui/gfx/animation/tween.h"
+#include "ui/gfx/canvas.h"
+#include "ui/gfx/geometry/insets.h"
+#include "ui/gfx/geometry/point.h"
+#include "ui/gfx/vector_icons_public.h"
+#include "ui/strings/grit/ui_strings.h"  // Accessibility names
+#include "ui/views/widget/widget.h"
+#include "ui/views/widget/widget_delegate.h"
+
+namespace ash {
+
+namespace {
+
+// Duration of the animation of the position of |minimize_button_|.
+const int kPositionAnimationDurationMs = 500;
+
+// Duration of the animation of the alpha of |size_button_|.
+const int kAlphaAnimationDurationMs = 250;
+
+// Delay during |maximize_mode_animation_| hide to wait before beginning to
+// animate the position of |minimize_button_|.
+const int kHidePositionDelayMs = 100;
+
+// Duration of |maximize_mode_animation_| hiding.
+// Hiding size button 250
+// |------------------------|
+// Delay 100      Slide minimize button 500
+// |---------|-------------------------------------------------|
+const int kHideAnimationDurationMs =
+    kHidePositionDelayMs + kPositionAnimationDurationMs;
+
+// Delay during |maximize_mode_animation_| show to wait before beginning to
+// animate the alpha of |size_button_|.
+const int kShowAnimationAlphaDelayMs = 100;
+
+// Duration of |maximize_mode_animation_| showing.
+// Slide minimize button 500
+// |-------------------------------------------------|
+// Delay 100   Show size button 250
+// |---------|-----------------------|
+const int kShowAnimationDurationMs = kPositionAnimationDurationMs;
+
+// Value of |maximize_mode_animation_| showing to begin animating alpha of
+// |size_button_|.
+float SizeButtonShowStartValue() {
+  return static_cast<float>(kShowAnimationAlphaDelayMs) /
+         kShowAnimationDurationMs;
+}
+
+// Amount of |maximize_mode_animation_| showing to animate the alpha of
+// |size_button_|.
+float SizeButtonShowDuration() {
+  return static_cast<float>(kAlphaAnimationDurationMs) /
+         kShowAnimationDurationMs;
+}
+
+// Amount of |maximize_mode_animation_| hiding to animate the alpha of
+// |size_button_|.
+float SizeButtonHideDuration() {
+  return static_cast<float>(kAlphaAnimationDurationMs) /
+         kHideAnimationDurationMs;
+}
+
+// Value of |maximize_mode_animation_| hiding to begin animating the position of
+// |minimize_button_|.
+float HidePositionStartValue() {
+  return 1.0f -
+         static_cast<float>(kHidePositionDelayMs) / kHideAnimationDurationMs;
+}
+
+// Converts |point| from |src| to |dst| and hittests against |dst|.
+bool ConvertPointToViewAndHitTest(const views::View* src,
+                                  const views::View* dst,
+                                  const gfx::Point& point) {
+  gfx::Point converted(point);
+  views::View::ConvertPointToTarget(src, dst, &converted);
+  return dst->HitTestPoint(converted);
+}
+
+// Bounds animation values to the range 0.0 - 1.0. Allows for mapping of offset
+// animations to the expected range so that gfx::Tween::CalculateValue() can be
+// used.
+double CapAnimationValue(double value) {
+  return std::min(1.0, std::max(0.0, value));
+}
+
+}  // namespace
+
+// static
+const char FrameCaptionButtonContainerView::kViewClassName[] =
+    "FrameCaptionButtonContainerView";
+
+FrameCaptionButtonContainerView::FrameCaptionButtonContainerView(
+    views::Widget* frame)
+    : frame_(frame),
+      minimize_button_(NULL),
+      size_button_(NULL),
+      close_button_(NULL) {
+  bool size_button_visibility = ShouldSizeButtonBeVisible();
+  maximize_mode_animation_.reset(new gfx::SlideAnimation(this));
+  maximize_mode_animation_->SetTweenType(gfx::Tween::LINEAR);
+
+  // Ensure animation tracks visibility of size button.
+  if (size_button_visibility)
+    maximize_mode_animation_->Reset(1.0f);
+
+  // Insert the buttons left to right.
+  minimize_button_ = new FrameCaptionButton(this, CAPTION_BUTTON_ICON_MINIMIZE);
+  minimize_button_->SetAccessibleName(
+      l10n_util::GetStringUTF16(IDS_APP_ACCNAME_MINIMIZE));
+  minimize_button_->SetVisible(frame_->widget_delegate()->CanMinimize());
+  AddChildView(minimize_button_);
+
+  size_button_ = new FrameSizeButton(this, frame, this);
+  size_button_->SetAccessibleName(
+      l10n_util::GetStringUTF16(IDS_APP_ACCNAME_MAXIMIZE));
+  size_button_->SetVisible(size_button_visibility);
+  AddChildView(size_button_);
+
+  close_button_ = new FrameCaptionButton(this, CAPTION_BUTTON_ICON_CLOSE);
+  close_button_->SetAccessibleName(
+      l10n_util::GetStringUTF16(IDS_APP_ACCNAME_CLOSE));
+  AddChildView(close_button_);
+}
+
+FrameCaptionButtonContainerView::~FrameCaptionButtonContainerView() {}
+
+void FrameCaptionButtonContainerView::TestApi::EndAnimations() {
+  container_view_->maximize_mode_animation_->End();
+}
+
+void FrameCaptionButtonContainerView::SetButtonImage(
+    CaptionButtonIcon icon,
+    gfx::VectorIconId icon_image_id) {
+  button_icon_id_map_[icon] = icon_image_id;
+
+  FrameCaptionButton* buttons[] = {minimize_button_, size_button_,
+                                   close_button_};
+  for (size_t i = 0; i < arraysize(buttons); ++i) {
+    if (buttons[i]->icon() == icon)
+      buttons[i]->SetImage(icon, FrameCaptionButton::ANIMATE_NO, icon_image_id);
+  }
+}
+
+void FrameCaptionButtonContainerView::SetPaintAsActive(bool paint_as_active) {
+  minimize_button_->set_paint_as_active(paint_as_active);
+  size_button_->set_paint_as_active(paint_as_active);
+  close_button_->set_paint_as_active(paint_as_active);
+}
+
+void FrameCaptionButtonContainerView::SetUseLightImages(bool light) {
+  minimize_button_->set_use_light_images(light);
+  size_button_->set_use_light_images(light);
+  close_button_->set_use_light_images(light);
+}
+
+void FrameCaptionButtonContainerView::ResetWindowControls() {
+  SetButtonsToNormal(ANIMATE_NO);
+}
+
+int FrameCaptionButtonContainerView::NonClientHitTest(
+    const gfx::Point& point) const {
+  if (close_button_->visible() &&
+      ConvertPointToViewAndHitTest(this, close_button_, point)) {
+    return HTCLOSE;
+  } else if (size_button_->visible() &&
+             ConvertPointToViewAndHitTest(this, size_button_, point)) {
+    return HTMAXBUTTON;
+  } else if (minimize_button_->visible() &&
+             ConvertPointToViewAndHitTest(this, minimize_button_, point)) {
+    return HTMINBUTTON;
+  }
+  return HTNOWHERE;
+}
+
+void FrameCaptionButtonContainerView::UpdateSizeButtonVisibility() {
+  bool visible = ShouldSizeButtonBeVisible();
+  if (visible) {
+    size_button_->SetVisible(true);
+    maximize_mode_animation_->SetSlideDuration(kShowAnimationDurationMs);
+    maximize_mode_animation_->Show();
+  } else {
+    maximize_mode_animation_->SetSlideDuration(kHideAnimationDurationMs);
+    maximize_mode_animation_->Hide();
+  }
+}
+
+void FrameCaptionButtonContainerView::SetButtonSize(const gfx::Size& size) {
+  minimize_button_->set_size(size);
+  size_button_->set_size(size);
+  close_button_->set_size(size);
+}
+
+gfx::Size FrameCaptionButtonContainerView::GetPreferredSize() const {
+  int width = 0;
+  for (int i = 0; i < child_count(); ++i) {
+    const views::View* child = child_at(i);
+    if (child->visible())
+      width += child_at(i)->GetPreferredSize().width();
+  }
+  return gfx::Size(width, close_button_->GetPreferredSize().height());
+}
+
+void FrameCaptionButtonContainerView::Layout() {
+  int x = 0;
+  for (int i = 0; i < child_count(); ++i) {
+    views::View* child = child_at(i);
+    if (!child->visible())
+      continue;
+
+    gfx::Size size = child->GetPreferredSize();
+    child->SetBounds(x, 0, size.width(), size.height());
+    x += size.width();
+  }
+  if (maximize_mode_animation_->is_animating()) {
+    AnimationProgressed(maximize_mode_animation_.get());
+  }
+}
+
+const char* FrameCaptionButtonContainerView::GetClassName() const {
+  return kViewClassName;
+}
+
+void FrameCaptionButtonContainerView::AnimationEnded(
+    const gfx::Animation* animation) {
+  // Ensure that position is calculated at least once.
+  AnimationProgressed(animation);
+
+  double current_value = maximize_mode_animation_->GetCurrentValue();
+  if (current_value == 0.0) {
+    size_button_->SetVisible(false);
+    PreferredSizeChanged();
+  }
+}
+
+void FrameCaptionButtonContainerView::AnimationProgressed(
+    const gfx::Animation* animation) {
+  double current_value = animation->GetCurrentValue();
+  int size_alpha = 0;
+  int minimize_x = 0;
+  if (maximize_mode_animation_->IsShowing()) {
+    double scaled_value =
+        CapAnimationValue((current_value - SizeButtonShowStartValue()) /
+                          SizeButtonShowDuration());
+    double tweened_value_alpha =
+        gfx::Tween::CalculateValue(gfx::Tween::EASE_OUT, scaled_value);
+    size_alpha = gfx::Tween::LinearIntValueBetween(tweened_value_alpha, 0, 255);
+
+    double tweened_value_slide =
+        gfx::Tween::CalculateValue(gfx::Tween::EASE_OUT, current_value);
+    minimize_x = gfx::Tween::LinearIntValueBetween(tweened_value_slide,
+                                                   size_button_->x(), 0);
+  } else {
+    double scaled_value_alpha =
+        CapAnimationValue((1.0f - current_value) / SizeButtonHideDuration());
+    double tweened_value_alpha =
+        gfx::Tween::CalculateValue(gfx::Tween::EASE_IN, scaled_value_alpha);
+    size_alpha = gfx::Tween::LinearIntValueBetween(tweened_value_alpha, 255, 0);
+
+    double scaled_value_position = CapAnimationValue(
+        (HidePositionStartValue() - current_value) / HidePositionStartValue());
+    double tweened_value_position =
+        gfx::Tween::CalculateValue(gfx::Tween::EASE_OUT, scaled_value_position);
+    minimize_x = gfx::Tween::LinearIntValueBetween(tweened_value_position, 0,
+                                                   size_button_->x());
+  }
+  size_button_->SetAlpha(size_alpha);
+  minimize_button_->SetX(minimize_x);
+}
+
+void FrameCaptionButtonContainerView::SetButtonIcon(FrameCaptionButton* button,
+                                                    CaptionButtonIcon icon,
+                                                    Animate animate) {
+  // The early return is dependant on |animate| because callers use
+  // SetButtonIcon() with ANIMATE_NO to progress |button|'s crossfade animation
+  // to the end.
+  if (button->icon() == icon &&
+      (animate == ANIMATE_YES || !button->IsAnimatingImageSwap())) {
+    return;
+  }
+
+  FrameCaptionButton::Animate fcb_animate =
+      (animate == ANIMATE_YES) ? FrameCaptionButton::ANIMATE_YES
+                               : FrameCaptionButton::ANIMATE_NO;
+  auto it = button_icon_id_map_.find(icon);
+  if (it != button_icon_id_map_.end())
+    button->SetImage(icon, fcb_animate, it->second);
+}
+
+bool FrameCaptionButtonContainerView::ShouldSizeButtonBeVisible() const {
+  return !WmShell::Get()
+              ->maximize_mode_controller()
+              ->IsMaximizeModeWindowManagerEnabled() &&
+         frame_->widget_delegate()->CanMaximize();
+}
+
+void FrameCaptionButtonContainerView::ButtonPressed(views::Button* sender,
+                                                    const ui::Event& event) {
+  // Abort any animations of the button icons.
+  SetButtonsToNormal(ANIMATE_NO);
+
+  UserMetricsAction action = UMA_WINDOW_MAXIMIZE_BUTTON_CLICK_MINIMIZE;
+  if (sender == minimize_button_) {
+    frame_->Minimize();
+  } else if (sender == size_button_) {
+    if (frame_->IsFullscreen()) {  // Can be clicked in immersive fullscreen.
+      frame_->Restore();
+      action = UMA_WINDOW_MAXIMIZE_BUTTON_CLICK_EXIT_FULLSCREEN;
+    } else if (frame_->IsMaximized()) {
+      frame_->Restore();
+      action = UMA_WINDOW_MAXIMIZE_BUTTON_CLICK_RESTORE;
+    } else {
+      frame_->Maximize();
+      action = UMA_WINDOW_MAXIMIZE_BUTTON_CLICK_MAXIMIZE;
+    }
+
+    if (event.IsGestureEvent()) {
+      TouchUMA::GetInstance()->RecordGestureAction(
+          TouchUMA::GESTURE_FRAMEMAXIMIZE_TAP);
+    }
+  } else if (sender == close_button_) {
+    frame_->Close();
+    action = UMA_WINDOW_CLOSE_BUTTON_CLICK;
+  } else {
+    return;
+  }
+  WmShell::Get()->RecordUserMetricsAction(action);
+}
+
+bool FrameCaptionButtonContainerView::IsMinimizeButtonVisible() const {
+  return minimize_button_->visible();
+}
+
+void FrameCaptionButtonContainerView::SetButtonsToNormal(Animate animate) {
+  SetButtonIcons(CAPTION_BUTTON_ICON_MINIMIZE, CAPTION_BUTTON_ICON_CLOSE,
+                 animate);
+  minimize_button_->SetState(views::Button::STATE_NORMAL);
+  size_button_->SetState(views::Button::STATE_NORMAL);
+  close_button_->SetState(views::Button::STATE_NORMAL);
+}
+
+void FrameCaptionButtonContainerView::SetButtonIcons(
+    CaptionButtonIcon minimize_button_icon,
+    CaptionButtonIcon close_button_icon,
+    Animate animate) {
+  SetButtonIcon(minimize_button_, minimize_button_icon, animate);
+  SetButtonIcon(close_button_, close_button_icon, animate);
+}
+
+const FrameCaptionButton* FrameCaptionButtonContainerView::GetButtonClosestTo(
+    const gfx::Point& position_in_screen) const {
+  // Since the buttons all have the same size, the closest button is the button
+  // with the center point closest to |position_in_screen|.
+  // TODO(pkotwicz): Make the caption buttons not overlap.
+  gfx::Point position(position_in_screen);
+  views::View::ConvertPointFromScreen(this, &position);
+
+  FrameCaptionButton* buttons[] = {minimize_button_, size_button_,
+                                   close_button_};
+  int min_squared_distance = INT_MAX;
+  FrameCaptionButton* closest_button = NULL;
+  for (size_t i = 0; i < arraysize(buttons); ++i) {
+    FrameCaptionButton* button = buttons[i];
+    if (!button->visible())
+      continue;
+
+    gfx::Point center_point = button->GetLocalBounds().CenterPoint();
+    views::View::ConvertPointToTarget(button, this, &center_point);
+    int squared_distance = static_cast<int>(
+        pow(static_cast<double>(position.x() - center_point.x()), 2) +
+        pow(static_cast<double>(position.y() - center_point.y()), 2));
+    if (squared_distance < min_squared_distance) {
+      min_squared_distance = squared_distance;
+      closest_button = button;
+    }
+  }
+  return closest_button;
+}
+
+void FrameCaptionButtonContainerView::SetHoveredAndPressedButtons(
+    const FrameCaptionButton* to_hover,
+    const FrameCaptionButton* to_press) {
+  FrameCaptionButton* buttons[] = {minimize_button_, size_button_,
+                                   close_button_};
+  for (size_t i = 0; i < arraysize(buttons); ++i) {
+    FrameCaptionButton* button = buttons[i];
+    views::Button::ButtonState new_state = views::Button::STATE_NORMAL;
+    if (button == to_hover)
+      new_state = views::Button::STATE_HOVERED;
+    else if (button == to_press)
+      new_state = views::Button::STATE_PRESSED;
+    button->SetState(new_state);
+  }
+}
+
+}  // namespace ash
diff --git a/ash/frame/caption_buttons/frame_caption_button_container_view.h b/ash/frame/caption_buttons/frame_caption_button_container_view.h
new file mode 100644
index 0000000..f099cf8
--- /dev/null
+++ b/ash/frame/caption_buttons/frame_caption_button_container_view.h
@@ -0,0 +1,157 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef ASH_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_CONTAINER_VIEW_H_
+#define ASH_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_CONTAINER_VIEW_H_
+
+#include <map>
+
+#include "ash/ash_export.h"
+#include "ash/frame/caption_buttons/frame_size_button_delegate.h"
+#include "base/macros.h"
+#include "ui/gfx/animation/animation_delegate.h"
+#include "ui/views/controls/button/button.h"
+#include "ui/views/view.h"
+
+namespace gfx {
+class SlideAnimation;
+enum class VectorIconId;
+}
+
+namespace views {
+class Widget;
+}
+
+namespace ash {
+
+// Container view for the frame caption buttons. It performs the appropriate
+// action when a caption button is clicked.
+class ASH_EXPORT FrameCaptionButtonContainerView
+    : public views::View,
+      public views::ButtonListener,
+      public FrameSizeButtonDelegate,
+      public gfx::AnimationDelegate {
+ public:
+  static const char kViewClassName[];
+
+  // |frame| is the views::Widget that the caption buttons act on.
+  explicit FrameCaptionButtonContainerView(views::Widget* frame);
+  ~FrameCaptionButtonContainerView() override;
+
+  // For testing.
+  class ASH_EXPORT TestApi {
+   public:
+    explicit TestApi(FrameCaptionButtonContainerView* container_view)
+        : container_view_(container_view) {}
+
+    void EndAnimations();
+
+    FrameCaptionButton* minimize_button() const {
+      return container_view_->minimize_button_;
+    }
+
+    FrameCaptionButton* size_button() const {
+      return container_view_->size_button_;
+    }
+
+    FrameCaptionButton* close_button() const {
+      return container_view_->close_button_;
+    }
+
+   private:
+    FrameCaptionButtonContainerView* container_view_;
+
+    DISALLOW_COPY_AND_ASSIGN(TestApi);
+  };
+
+  // Sets the id of the vector image to paint the button for |icon|. The
+  // FrameCaptionButtonContainerView will keep track of the image to use for
+  // |icon| even if none of the buttons currently use |icon|.
+  void SetButtonImage(CaptionButtonIcon icon, gfx::VectorIconId icon_image_id);
+
+  // Sets whether the buttons should be painted as active. Does not schedule
+  // a repaint.
+  void SetPaintAsActive(bool paint_as_active);
+
+  // Sets whether the buttons should be painted in a lighter color (for use on
+  // dark backgrounds).
+  void SetUseLightImages(bool light);
+
+  // Tell the window controls to reset themselves to the normal state.
+  void ResetWindowControls();
+
+  // Determines the window HT* code for the caption button at |point|. Returns
+  // HTNOWHERE if |point| is not over any of the caption buttons. |point| must
+  // be in the coordinates of the FrameCaptionButtonContainerView.
+  int NonClientHitTest(const gfx::Point& point) const;
+
+  // Updates the size button's visibility based on whether |frame_| can be
+  // maximized and if maximize mode is enabled. A parent view should relayout
+  // to reflect the change in visibility.
+  void UpdateSizeButtonVisibility();
+
+  // Sets the size of the buttons in this container.
+  void SetButtonSize(const gfx::Size& size);
+
+  // views::View:
+  gfx::Size GetPreferredSize() const override;
+  void Layout() override;
+  const char* GetClassName() const override;
+
+  // gfx::AnimationDelegate:
+  void AnimationEnded(const gfx::Animation* animation) override;
+  void AnimationProgressed(const gfx::Animation* animation) override;
+
+ private:
+  friend class FrameCaptionButtonContainerViewTest;
+
+  // Sets |button|'s icon to |icon|. If |animate| is ANIMATE_YES, the button
+  // will crossfade to the new icon. If |animate| is ANIMATE_NO and
+  // |icon| == |button|->icon(), the crossfade animation is progressed to the
+  // end.
+  void SetButtonIcon(FrameCaptionButton* button,
+                     CaptionButtonIcon icon,
+                     Animate animate);
+
+  // Returns true if maximize mode is not enabled, and |frame_| widget delegate
+  // can be maximized.
+  bool ShouldSizeButtonBeVisible() const;
+
+  // views::ButtonListener:
+  void ButtonPressed(views::Button* sender, const ui::Event& event) override;
+
+  // FrameSizeButtonDelegate:
+  bool IsMinimizeButtonVisible() const override;
+  void SetButtonsToNormal(Animate animate) override;
+  void SetButtonIcons(CaptionButtonIcon minimize_button_icon,
+                      CaptionButtonIcon close_button_icon,
+                      Animate animate) override;
+  const FrameCaptionButton* GetButtonClosestTo(
+      const gfx::Point& position_in_screen) const override;
+  void SetHoveredAndPressedButtons(const FrameCaptionButton* to_hover,
+                                   const FrameCaptionButton* to_press) override;
+
+  // The widget that the buttons act on.
+  views::Widget* frame_;
+
+  // The buttons. In the normal button style, at most one of |minimize_button_|
+  // and |size_button_| is visible.
+  FrameCaptionButton* minimize_button_;
+  FrameCaptionButton* size_button_;
+  FrameCaptionButton* close_button_;
+
+  // Mapping of the image ID needed to paint a button for each of the values of
+  // CaptionButtonIcon.
+  std::map<CaptionButtonIcon, gfx::VectorIconId> button_icon_id_map_;
+
+  // Animation that affects the position of |minimize_button_| and the
+  // visibility of |size_button_|.
+  std::unique_ptr<gfx::SlideAnimation> maximize_mode_animation_;
+
+  DISALLOW_COPY_AND_ASSIGN(FrameCaptionButtonContainerView);
+};
+
+}  // namespace ash
+
+#endif  // ASH_FRAME_CAPTION_BUTTONS_FRAME_CAPTION_BUTTON_CONTAINER_VIEW_H_
diff --git a/ash/frame/caption_buttons/frame_caption_button_container_view_unittest.cc b/ash/frame/caption_buttons/frame_caption_button_container_view_unittest.cc
new file mode 100644
index 0000000..d8b5c60
--- /dev/null
+++ b/ash/frame/caption_buttons/frame_caption_button_container_view_unittest.cc
@@ -0,0 +1,205 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
+
+#include "ash/common/ash_layout_constants.h"
+#include "ash/common/wm/maximize_mode/maximize_mode_controller.h"
+#include "ash/common/wm_shell.h"
+#include "ash/frame/caption_buttons/frame_caption_button.h"
+#include "ash/shell.h"
+#include "ash/test/ash_test_base.h"
+#include "grit/ash_resources.h"
+#include "ui/gfx/geometry/rect.h"
+#include "ui/gfx/vector_icons_public.h"
+#include "ui/views/widget/widget.h"
+#include "ui/views/widget/widget_delegate.h"
+
+namespace ash {
+
+namespace {
+
+class TestWidgetDelegate : public views::WidgetDelegateView {
+ public:
+  TestWidgetDelegate(bool can_maximize, bool can_minimize)
+      : can_maximize_(can_maximize), can_minimize_(can_minimize) {}
+  ~TestWidgetDelegate() override {}
+
+  bool CanMaximize() const override { return can_maximize_; }
+
+  bool CanMinimize() const override { return can_minimize_; }
+
+ private:
+  bool can_maximize_;
+  bool can_minimize_;
+
+  DISALLOW_COPY_AND_ASSIGN(TestWidgetDelegate);
+};
+
+}  // namespace
+
+class FrameCaptionButtonContainerViewTest : public ash::test::AshTestBase {
+ public:
+  enum MaximizeAllowed { MAXIMIZE_ALLOWED, MAXIMIZE_DISALLOWED };
+
+  enum MinimizeAllowed { MINIMIZE_ALLOWED, MINIMIZE_DISALLOWED };
+
+  FrameCaptionButtonContainerViewTest() {}
+
+  ~FrameCaptionButtonContainerViewTest() override {}
+
+  // Creates a widget which allows maximizing based on |maximize_allowed|.
+  // The caller takes ownership of the returned widget.
+  views::Widget* CreateTestWidget(MaximizeAllowed maximize_allowed,
+                                  MinimizeAllowed minimize_allowed)
+      WARN_UNUSED_RESULT {
+    views::Widget* widget = new views::Widget;
+    views::Widget::InitParams params;
+    params.delegate =
+        new TestWidgetDelegate(maximize_allowed == MAXIMIZE_ALLOWED,
+                               minimize_allowed == MINIMIZE_ALLOWED);
+    params.ownership = views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET;
+    params.context = CurrentContext();
+    widget->Init(params);
+    return widget;
+  }
+
+  // Sets arbitrary images for the icons and assign the default caption button
+  // size to the buttons in |container|.
+  void InitContainer(FrameCaptionButtonContainerView* container) {
+    container->SetButtonSize(
+        GetAshLayoutSize(AshLayoutSize::NON_BROWSER_CAPTION_BUTTON));
+    for (int icon = 0; icon < CAPTION_BUTTON_ICON_COUNT; ++icon) {
+      container->SetButtonImage(static_cast<CaptionButtonIcon>(icon),
+                                gfx::VectorIconId::WINDOW_CONTROL_CLOSE);
+    }
+  }
+
+  // Tests that |leftmost| and |rightmost| are at |container|'s edges.
+  bool CheckButtonsAtEdges(FrameCaptionButtonContainerView* container,
+                           const ash::FrameCaptionButton& leftmost,
+                           const ash::FrameCaptionButton& rightmost) {
+    gfx::Rect expected(container->GetPreferredSize());
+
+    gfx::Rect container_size(container->GetPreferredSize());
+    if (leftmost.y() == rightmost.y() &&
+        leftmost.height() == rightmost.height() &&
+        leftmost.x() == expected.x() && leftmost.y() == expected.y() &&
+        leftmost.height() == expected.height() &&
+        rightmost.bounds().right() == expected.right()) {
+      return true;
+    }
+
+    LOG(ERROR) << "Buttons " << leftmost.bounds().ToString() << " "
+               << rightmost.bounds().ToString() << " not at edges of "
+               << expected.ToString();
+    return false;
+  }
+
+ private:
+  DISALLOW_COPY_AND_ASSIGN(FrameCaptionButtonContainerViewTest);
+};
+
+// Test how the allowed actions affect which caption buttons are visible.
+TEST_F(FrameCaptionButtonContainerViewTest, ButtonVisibility) {
+  // All the buttons should be visible when minimizing and maximizing are
+  // allowed.
+  FrameCaptionButtonContainerView container1(
+      CreateTestWidget(MAXIMIZE_ALLOWED, MINIMIZE_ALLOWED));
+  InitContainer(&container1);
+  container1.Layout();
+  FrameCaptionButtonContainerView::TestApi t1(&container1);
+  EXPECT_TRUE(t1.minimize_button()->visible());
+  EXPECT_TRUE(t1.size_button()->visible());
+  EXPECT_TRUE(t1.close_button()->visible());
+  EXPECT_TRUE(CheckButtonsAtEdges(&container1, *t1.minimize_button(),
+                                  *t1.close_button()));
+
+  // The minimize button should be visible when minimizing is allowed but
+  // maximizing is disallowed.
+  FrameCaptionButtonContainerView container2(
+      CreateTestWidget(MAXIMIZE_DISALLOWED, MINIMIZE_ALLOWED));
+  InitContainer(&container2);
+  container2.Layout();
+  FrameCaptionButtonContainerView::TestApi t2(&container2);
+  EXPECT_TRUE(t2.minimize_button()->visible());
+  EXPECT_FALSE(t2.size_button()->visible());
+  EXPECT_TRUE(t2.close_button()->visible());
+  EXPECT_TRUE(CheckButtonsAtEdges(&container2, *t2.minimize_button(),
+                                  *t2.close_button()));
+
+  // Neither the minimize button nor the size button should be visible when
+  // neither minimizing nor maximizing are allowed.
+  FrameCaptionButtonContainerView container3(
+      CreateTestWidget(MAXIMIZE_DISALLOWED, MINIMIZE_DISALLOWED));
+  InitContainer(&container3);
+  container3.Layout();
+  FrameCaptionButtonContainerView::TestApi t3(&container3);
+  EXPECT_FALSE(t3.minimize_button()->visible());
+  EXPECT_FALSE(t3.size_button()->visible());
+  EXPECT_TRUE(t3.close_button()->visible());
+  EXPECT_TRUE(
+      CheckButtonsAtEdges(&container3, *t3.close_button(), *t3.close_button()));
+}
+
+// Tests that the layout animations trigered by button visibility result in the
+// correct placement of the buttons.
+TEST_F(FrameCaptionButtonContainerViewTest,
+       TestUpdateSizeButtonVisibilityAnimation) {
+  FrameCaptionButtonContainerView container(
+      CreateTestWidget(MAXIMIZE_ALLOWED, MINIMIZE_ALLOWED));
+  InitContainer(&container);
+  container.SetBoundsRect(gfx::Rect(container.GetPreferredSize()));
+  container.Layout();
+
+  FrameCaptionButtonContainerView::TestApi test(&container);
+  gfx::Rect initial_minimize_button_bounds = test.minimize_button()->bounds();
+  gfx::Rect initial_size_button_bounds = test.size_button()->bounds();
+  gfx::Rect initial_close_button_bounds = test.close_button()->bounds();
+  gfx::Rect initial_container_bounds = container.bounds();
+
+  ASSERT_EQ(initial_size_button_bounds.x(),
+            initial_minimize_button_bounds.right());
+  ASSERT_EQ(initial_close_button_bounds.x(),
+            initial_size_button_bounds.right());
+
+  // Hidden size button should result in minimize button animating to the
+  // right. The size button should not be visible, but should not have moved.
+  WmShell::Get()->maximize_mode_controller()->EnableMaximizeModeWindowManager(
+      true);
+  container.UpdateSizeButtonVisibility();
+  test.EndAnimations();
+  // Parent needs to layout in response to size change.
+  container.Layout();
+
+  EXPECT_TRUE(test.minimize_button()->visible());
+  EXPECT_FALSE(test.size_button()->visible());
+  EXPECT_TRUE(test.close_button()->visible());
+  gfx::Rect minimize_button_bounds = test.minimize_button()->bounds();
+  gfx::Rect close_button_bounds = test.close_button()->bounds();
+  EXPECT_EQ(close_button_bounds.x(), minimize_button_bounds.right());
+  EXPECT_EQ(initial_size_button_bounds, test.size_button()->bounds());
+  EXPECT_EQ(initial_close_button_bounds.size(), close_button_bounds.size());
+  EXPECT_LT(container.GetPreferredSize().width(),
+            initial_container_bounds.width());
+
+  // Revealing the size button should cause the minimize button to return to its
+  // original position.
+  WmShell::Get()->maximize_mode_controller()->EnableMaximizeModeWindowManager(
+      false);
+  container.UpdateSizeButtonVisibility();
+  // Calling code needs to layout in response to size change.
+  container.Layout();
+  test.EndAnimations();
+  EXPECT_TRUE(test.minimize_button()->visible());
+  EXPECT_TRUE(test.size_button()->visible());
+  EXPECT_TRUE(test.close_button()->visible());
+  EXPECT_EQ(initial_minimize_button_bounds, test.minimize_button()->bounds());
+  EXPECT_EQ(initial_size_button_bounds, test.size_button()->bounds());
+  EXPECT_EQ(initial_close_button_bounds, test.close_button()->bounds());
+  EXPECT_EQ(container.GetPreferredSize().width(),
+            initial_container_bounds.width());
+}
+
+}  // namespace ash
diff --git a/ash/frame/caption_buttons/frame_size_button.cc b/ash/frame/caption_buttons/frame_size_button.cc
new file mode 100644
index 0000000..171ffcb
--- /dev/null
+++ b/ash/frame/caption_buttons/frame_size_button.cc
@@ -0,0 +1,278 @@
+// Copyright 2014 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "ash/frame/caption_buttons/frame_size_button.h"
+
+#include "ash/aura/wm_window_aura.h"
+#include "ash/common/wm/window_positioning_utils.h"
+#include "ash/common/wm/window_state.h"
+#include "ash/common/wm/wm_event.h"
+#include "ash/common/wm/workspace/phantom_window_controller.h"
+#include "ash/common/wm_shell.h"
+#include "ash/screen_util.h"
+#include "ash/wm/window_state_aura.h"
+#include "ash/wm/window_util.h"
+#include "base/i18n/rtl.h"
+#include "ui/aura/window.h"
+#include "ui/gfx/geometry/vector2d.h"
+#include "ui/views/widget/widget.h"
+
+namespace ash {
+
+namespace {
+
+// The default delay between the user pressing the size button and the buttons
+// adjacent to the size button morphing into buttons for snapping left and
+// right.
+const int kSetButtonsToSnapModeDelayMs = 150;
+
+// The amount that a user can overshoot one of the caption buttons while in
+// "snap mode" and keep the button hovered/pressed.
+const int kMaxOvershootX = 200;
+const int kMaxOvershootY = 50;
+
+// Returns true if a mouse drag while in "snap mode" at |location_in_screen|
+// would hover/press |button| or keep it hovered/pressed.
+bool HitTestButton(const FrameCaptionButton* button,
+                   const gfx::Point& location_in_screen) {
+  gfx::Rect expanded_bounds_in_screen = button->GetBoundsInScreen();
+  if (button->state() == views::Button::STATE_HOVERED ||
+      button->state() == views::Button::STATE_PRESSED) {
+    expanded_bounds_in_screen.Inset(-kMaxOvershootX, -kMaxOvershootY);
+  }
+  return expanded_bounds_in_screen.Contains(location_in_screen);
+}
+
+}  // namespace
+
+FrameSizeButton::FrameSizeButton(views::ButtonListener* listener,
+                                 views::Widget* frame,
+                                 FrameSizeButtonDelegate* delegate)
+    : FrameCaptionButton(listener, CAPTION_BUTTON_ICON_MAXIMIZE_RESTORE),
+      frame_(frame),
+      delegate_(delegate),
+      set_buttons_to_snap_mode_delay_ms_(kSetButtonsToSnapModeDelayMs),
+      in_snap_mode_(false),
+      snap_type_(SNAP_NONE) {}
+
+FrameSizeButton::~FrameSizeButton() {}
+
+bool FrameSizeButton::OnMousePressed(const ui::MouseEvent& event) {
+  // The minimize and close buttons are set to snap left and right when snapping
+  // is enabled. Do not enable snapping if the minimize button is not visible.
+  // The close button is always visible.
+  if (IsTriggerableEvent(event) && !in_snap_mode_ &&
+      delegate_->IsMinimizeButtonVisible()) {
+    StartSetButtonsToSnapModeTimer(event);
+  }
+  FrameCaptionButton::OnMousePressed(event);
+  return true;
+}
+
+bool FrameSizeButton::OnMouseDragged(const ui::MouseEvent& event) {
+  UpdateSnapType(event);
+  // By default a FrameCaptionButton reverts to STATE_NORMAL once the mouse
+  // leaves its bounds. Skip FrameCaptionButton's handling when
+  // |in_snap_mode_| == true because we want different behavior.
+  if (!in_snap_mode_)
+    FrameCaptionButton::OnMouseDragged(event);
+  return true;
+}
+
+void FrameSizeButton::OnMouseReleased(const ui::MouseEvent& event) {
+  if (!IsTriggerableEvent(event) || !CommitSnap(event))
+    FrameCaptionButton::OnMouseReleased(event);
+}
+
+void FrameSizeButton::OnMouseCaptureLost() {
+  SetButtonsToNormalMode(FrameSizeButtonDelegate::ANIMATE_YES);
+  FrameCaptionButton::OnMouseCaptureLost();
+}
+
+void FrameSizeButton::OnMouseMoved(const ui::MouseEvent& event) {
+  // Ignore any synthetic mouse moves during a drag.
+  if (!in_snap_mode_)
+    FrameCaptionButton::OnMouseMoved(event);
+}
+
+void FrameSizeButton::OnGestureEvent(ui::GestureEvent* event) {
+  if (event->details().touch_points() > 1) {
+    SetButtonsToNormalMode(FrameSizeButtonDelegate::ANIMATE_YES);
+    return;
+  }
+
+  if (event->type() == ui::ET_GESTURE_TAP_DOWN) {
+    StartSetButtonsToSnapModeTimer(*event);
+    // Go through FrameCaptionButton's handling so that the button gets pressed.
+    FrameCaptionButton::OnGestureEvent(event);
+    return;
+  }
+
+  if (event->type() == ui::ET_GESTURE_SCROLL_BEGIN ||
+      event->type() == ui::ET_GESTURE_SCROLL_UPDATE) {
+    UpdateSnapType(*event);
+    event->SetHandled();
+    return;
+  }
+
+  if (event->type() == ui::ET_GESTURE_TAP ||
+      event->type() == ui::ET_GESTURE_SCROLL_END ||
+      event->type() == ui::ET_SCROLL_FLING_START ||
+      event->type() == ui::ET_GESTURE_END) {
+    if (CommitSnap(*event)) {
+      event->SetHandled();
+      return;
+    }
+  }
+
+  FrameCaptionButton::OnGestureEvent(event);
+}
+
+void FrameSizeButton::StartSetButtonsToSnapModeTimer(
+    const ui::LocatedEvent& event) {
+  set_buttons_to_snap_mode_timer_event_location_ = event.location();
+  if (set_buttons_to_snap_mode_delay_ms_ == 0) {
+    AnimateButtonsToSnapMode();
+  } else {
+    set_buttons_to_snap_mode_timer_.Start(
+        FROM_HERE,
+        base::TimeDelta::FromMilliseconds(set_buttons_to_snap_mode_delay_ms_),
+        this, &FrameSizeButton::AnimateButtonsToSnapMode);
+  }
+}
+
+void FrameSizeButton::AnimateButtonsToSnapMode() {
+  SetButtonsToSnapMode(FrameSizeButtonDelegate::ANIMATE_YES);
+}
+
+void FrameSizeButton::SetButtonsToSnapMode(
+    FrameSizeButtonDelegate::Animate animate) {
+  in_snap_mode_ = true;
+
+  // When using a right-to-left layout the close button is left of the size
+  // button and the minimize button is right of the size button.
+  if (base::i18n::IsRTL()) {
+    delegate_->SetButtonIcons(CAPTION_BUTTON_ICON_RIGHT_SNAPPED,
+                              CAPTION_BUTTON_ICON_LEFT_SNAPPED, animate);
+  } else {
+    delegate_->SetButtonIcons(CAPTION_BUTTON_ICON_LEFT_SNAPPED,
+                              CAPTION_BUTTON_ICON_RIGHT_SNAPPED, animate);
+  }
+}
+
+void FrameSizeButton::UpdateSnapType(const ui::LocatedEvent& event) {
+  if (!in_snap_mode_) {
+    // Set the buttons adjacent to the size button to snap left and right early
+    // if the user drags past the drag threshold.
+    // |set_buttons_to_snap_mode_timer_| is checked to avoid entering the snap
+    // mode as a result of an unsupported drag type (e.g. only the right mouse
+    // button is pressed).
+    gfx::Vector2d delta(event.location() -
+                        set_buttons_to_snap_mode_timer_event_location_);
+    if (!set_buttons_to_snap_mode_timer_.IsRunning() ||
+        !views::View::ExceededDragThreshold(delta)) {
+      return;
+    }
+    AnimateButtonsToSnapMode();
+  }
+
+  gfx::Point event_location_in_screen(event.location());
+  views::View::ConvertPointToScreen(this, &event_location_in_screen);
+  const FrameCaptionButton* to_hover =
+      GetButtonToHover(event_location_in_screen);
+  bool press_size_button =
+      to_hover || HitTestButton(this, event_location_in_screen);
+
+  if (to_hover) {
+    // Progress the minimize and close icon morph animations to the end if they
+    // are in progress.
+    SetButtonsToSnapMode(FrameSizeButtonDelegate::ANIMATE_NO);
+  }
+
+  delegate_->SetHoveredAndPressedButtons(to_hover,
+                                         press_size_button ? this : NULL);
+
+  snap_type_ = SNAP_NONE;
+  if (to_hover) {
+    switch (to_hover->icon()) {
+      case CAPTION_BUTTON_ICON_LEFT_SNAPPED:
+        snap_type_ = SNAP_LEFT;
+        break;
+      case CAPTION_BUTTON_ICON_RIGHT_SNAPPED:
+        snap_type_ = SNAP_RIGHT;
+        break;
+      case CAPTION_BUTTON_ICON_MAXIMIZE_RESTORE:
+      case CAPTION_BUTTON_ICON_MINIMIZE:
+      case CAPTION_BUTTON_ICON_CLOSE:
+      case CAPTION_BUTTON_ICON_BACK:
+      case CAPTION_BUTTON_ICON_LOCATION:
+      case CAPTION_BUTTON_ICON_COUNT:
+        NOTREACHED();
+        break;
+    }
+  }
+
+  if (snap_type_ == SNAP_LEFT || snap_type_ == SNAP_RIGHT) {
+    aura::Window* window = frame_->GetNativeWindow();
+    if (!phantom_window_controller_.get()) {
+      phantom_window_controller_.reset(
+          new PhantomWindowController(WmWindowAura::Get(window)));
+    }
+    gfx::Rect phantom_bounds_in_parent =
+        (snap_type_ == SNAP_LEFT)
+            ? wm::GetDefaultLeftSnappedWindowBoundsInParent(
+                  WmWindowAura::Get(window))
+            : wm::GetDefaultRightSnappedWindowBoundsInParent(
+                  WmWindowAura::Get(window));
+    phantom_window_controller_->Show(ScreenUtil::ConvertRectToScreen(
+        window->parent(), phantom_bounds_in_parent));
+  } else {
+    phantom_window_controller_.reset();
+  }
+}
+
+const FrameCaptionButton* FrameSizeButton::GetButtonToHover(
+    const gfx::Point& event_location_in_screen) const {
+  const FrameCaptionButton* closest_button =
+      delegate_->GetButtonClosestTo(event_location_in_screen);
+  if ((closest_button->icon() == CAPTION_BUTTON_ICON_LEFT_SNAPPED ||
+       closest_button->icon() == CAPTION_BUTTON_ICON_RIGHT_SNAPPED) &&
+      HitTestButton(closest_button, event_location_in_screen)) {
+    return closest_button;
+  }
+  return NULL;
+}
+
+bool FrameSizeButton::CommitSnap(const ui::LocatedEvent& event) {
+  // The position of |event| may be different than the position of the previous
+  // event.
+  UpdateSnapType(event);
+
+  if (in_snap_mode_ && (snap_type_ == SNAP_LEFT || snap_type_ == SNAP_RIGHT)) {
+    wm::WindowState* window_state =
+        wm::GetWindowState(frame_->GetNativeWindow());
+    const wm::WMEvent snap_event(snap_type_ == SNAP_LEFT
+                                     ? wm::WM_EVENT_SNAP_LEFT
+                                     : wm::WM_EVENT_SNAP_RIGHT);
+    window_state->OnWMEvent(&snap_event);
+    WmShell::Get()->RecordUserMetricsAction(
+        snap_type_ == SNAP_LEFT ? UMA_WINDOW_MAXIMIZE_BUTTON_MAXIMIZE_LEFT
+                                : UMA_WINDOW_MAXIMIZE_BUTTON_MAXIMIZE_RIGHT);
+    SetButtonsToNormalMode(FrameSizeButtonDelegate::ANIMATE_NO);
+    return true;
+  }
+  SetButtonsToNormalMode(FrameSizeButtonDelegate::ANIMATE_YES);
+  return false;
+}
+
+void FrameSizeButton::SetButtonsToNormalMode(
+    FrameSizeButtonDelegate::Animate animate) {
+  in_snap_mode_ = false;
+  snap_type_ = SNAP_NONE;
+  set_buttons_to_snap_mode_timer_.Stop();
+  delegate_->SetButtonsToNormal(animate);
+  phantom_window_controller_.reset();
+}
+
+}  // namespace ash
diff --git a/ash/frame/caption_buttons/frame_size_button.h b/ash/frame/caption_buttons/frame_size_button.h
new file mode 100644
index 0000000..bebca5a
--- /dev/null
+++ b/ash/frame/caption_buttons/frame_size_button.h
@@ -0,0 +1,120 @@
+// Copyright 2014 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef ASH_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_H_
+#define ASH_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_H_
+
+#include <memory>
+
+#include "ash/ash_export.h"
+#include "ash/frame/caption_buttons/frame_caption_button.h"
+#include "ash/frame/caption_buttons/frame_size_button_delegate.h"
+#include "base/macros.h"
+#include "base/timer/timer.h"
+
+namespace views {
+class Widget;
+}
+
+namespace ash {
+class FrameSizeButtonDelegate;
+class PhantomWindowController;
+
+// The maximize/restore button.
+// When the mouse is pressed over the size button or the size button is touched:
+// - The minimize and close buttons are set to snap left and snap right
+//   respectively.
+// - The size button stays pressed while the mouse is over the buttons to snap
+//   left and to snap right. The button underneath the mouse is hovered.
+// When the drag terminates, the action for the button underneath the mouse
+// is executed. For the sake of simplicity, the size button is the event
+// handler for a click starting on the size button and the entire drag.
+class ASH_EXPORT FrameSizeButton : public FrameCaptionButton {
+ public:
+  FrameSizeButton(views::ButtonListener* listener,
+                  views::Widget* frame,
+                  FrameSizeButtonDelegate* delegate);
+
+  ~FrameSizeButton() override;
+
+  // views::CustomButton overrides:
+  bool OnMousePressed(const ui::MouseEvent& event) override;
+  bool OnMouseDragged(const ui::MouseEvent& event) override;
+  void OnMouseReleased(const ui::MouseEvent& event) override;
+  void OnMouseCaptureLost() override;
+  void OnMouseMoved(const ui::MouseEvent& event) override;
+  void OnGestureEvent(ui::GestureEvent* event) override;
+
+  void set_delay_to_set_buttons_to_snap_mode(int delay_ms) {
+    set_buttons_to_snap_mode_delay_ms_ = delay_ms;
+  }
+
+ private:
+  enum SnapType { SNAP_LEFT, SNAP_RIGHT, SNAP_NONE };
+
+  // Starts |set_buttons_to_snap_mode_timer_|.
+  void StartSetButtonsToSnapModeTimer(const ui::LocatedEvent& event);
+
+  // Animates the buttons adjacent to the size button to snap left and right.
+  void AnimateButtonsToSnapMode();
+
+  // Sets the buttons adjacent to the size button to snap left and right.
+  // Passing in ANIMATE_NO progresses the animation (if any) to the end.
+  void SetButtonsToSnapMode(FrameSizeButtonDelegate::Animate animate);
+
+  // Updates |snap_type_|, whether the size button is pressed and whether any
+  // other buttons are hovered.
+  void UpdateSnapType(const ui::LocatedEvent& event);
+
+  // Returns the button which should be hovered (if any) while in "snap mode"
+  // for |event_location_in_screen|.
+  const FrameCaptionButton* GetButtonToHover(
+      const gfx::Point& event_location_in_screen) const;
+
+  // Snaps |frame_| according to |snap_type_|. Returns true if |frame_| was
+  // snapped.
+  bool CommitSnap(const ui::LocatedEvent& event);
+
+  // Sets the buttons adjacent to the size button to minimize and close again.
+  // Clears any state set while snapping was enabled. |animate| indicates
+  // whether the buttons should animate back to their original icons.
+  void SetButtonsToNormalMode(FrameSizeButtonDelegate::Animate animate);
+
+  // Widget that the size button acts on.
+  views::Widget* frame_;
+
+  // Not owned.
+  FrameSizeButtonDelegate* delegate_;
+
+  // Location of the event which started |set_buttons_to_snap_mode_timer_| in
+  // view coordinates.
+  gfx::Point set_buttons_to_snap_mode_timer_event_location_;
+
+  // The delay between the user pressing the size button and the buttons
+  // adjacent to the size button morphing into buttons for snapping left and
+  // right.
+  int set_buttons_to_snap_mode_delay_ms_;
+
+  base::OneShotTimer set_buttons_to_snap_mode_timer_;
+
+  // Whether the buttons adjacent to the size button snap the window left and
+  // right.
+  bool in_snap_mode_;
+
+  // The action to execute when the drag/click is ended. If
+  // |snap_type_| == SNAP_NONE, the size button's default action is run when the
+  // drag/click is ended.
+  SnapType snap_type_;
+
+  // Displays a preview of how the window's bounds will change as a result of
+  // snapping the window left or right. The preview is only visible if the snap
+  // left or snap right button is pressed.
+  std::unique_ptr<PhantomWindowController> phantom_window_controller_;
+
+  DISALLOW_COPY_AND_ASSIGN(FrameSizeButton);
+};
+
+}  // namespace ash
+
+#endif  // ASH_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_H_
diff --git a/ash/frame/caption_buttons/frame_size_button_delegate.h b/ash/frame/caption_buttons/frame_size_button_delegate.h
new file mode 100644
index 0000000..98f6014
--- /dev/null
+++ b/ash/frame/caption_buttons/frame_size_button_delegate.h
@@ -0,0 +1,55 @@
+// Copyright 2014 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef ASH_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_DELEGATE_H_
+#define ASH_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_DELEGATE_H_
+
+#include "ash/ash_export.h"
+#include "ash/frame/caption_buttons/caption_button_types.h"
+
+namespace gfx {
+class Insets;
+class Point;
+class Vector2d;
+}
+
+namespace ash {
+class FrameCaptionButton;
+
+// Delegate interface for FrameSizeButton.
+class ASH_EXPORT FrameSizeButtonDelegate {
+ public:
+  enum Animate { ANIMATE_YES, ANIMATE_NO };
+
+  // Returns whether the minimize button is visible.
+  virtual bool IsMinimizeButtonVisible() const = 0;
+
+  // Reset the caption button views::Button::ButtonState back to normal. If
+  // |animate| is ANIMATE_YES, the buttons will crossfade back to their
+  // original icons.
+  virtual void SetButtonsToNormal(Animate animate) = 0;
+
+  // Sets the minimize and close button icons. The buttons will crossfade to
+  // their new icons if |animate| is ANIMATE_YES.
+  virtual void SetButtonIcons(CaptionButtonIcon minimize_button_icon,
+                              CaptionButtonIcon close_button_icon,
+                              Animate animate) = 0;
+
+  // Returns the button closest to |position_in_screen|.
+  virtual const FrameCaptionButton* GetButtonClosestTo(
+      const gfx::Point& position_in_screen) const = 0;
+
+  // Sets |to_hover| and |to_pressed| to STATE_HOVERED and STATE_PRESSED
+  // respectively. All other buttons are to set to STATE_NORMAL.
+  virtual void SetHoveredAndPressedButtons(
+      const FrameCaptionButton* to_hover,
+      const FrameCaptionButton* to_press) = 0;
+
+ protected:
+  virtual ~FrameSizeButtonDelegate() {}
+};
+
+}  // namespace ash
+
+#endif  // ASH_FRAME_CAPTION_BUTTONS_FRAME_SIZE_BUTTON_DELEGATE_H_
diff --git a/ash/frame/caption_buttons/frame_size_button_unittest.cc b/ash/frame/caption_buttons/frame_size_button_unittest.cc
index 61c4d83..56cb9d2 100644
--- a/ash/frame/caption_buttons/frame_size_button_unittest.cc
+++ b/ash/frame/caption_buttons/frame_size_button_unittest.cc
@@ -2,12 +2,12 @@
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
-#include "ash/common/frame/caption_buttons/frame_size_button.h"
+#include "ash/frame/caption_buttons/frame_size_button.h"
 
 #include "ash/common/ash_layout_constants.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
 #include "ash/common/wm/window_state.h"
+#include "ash/frame/caption_buttons/frame_caption_button.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
 #include "ash/shell.h"
 #include "ash/test/ash_test_base.h"
 #include "ash/wm/window_state_aura.h"
diff --git a/ash/frame/custom_frame_view_ash.cc b/ash/frame/custom_frame_view_ash.cc
index a73ac62..c0f057c 100644
--- a/ash/frame/custom_frame_view_ash.cc
+++ b/ash/frame/custom_frame_view_ash.cc
@@ -9,10 +9,6 @@
 
 #include "ash/aura/wm_window_aura.h"
 #include "ash/common/ash_switches.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-#include "ash/common/frame/default_header_painter.h"
-#include "ash/common/frame/frame_border_hit_test.h"
-#include "ash/common/frame/header_painter.h"
 #include "ash/common/material_design/material_design_controller.h"
 #include "ash/common/session/session_state_delegate.h"
 #include "ash/common/shell_observer.h"
@@ -21,7 +17,10 @@
 #include "ash/common/wm/window_state_observer.h"
 #include "ash/common/wm_lookup.h"
 #include "ash/common/wm_shell.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
+#include "ash/frame/default_header_painter.h"
 #include "ash/frame/frame_border_hit_test_controller.h"
+#include "ash/frame/header_painter.h"
 #include "ash/wm/immersive_fullscreen_controller.h"
 #include "ash/wm/window_state_aura.h"
 #include "base/command_line.h"
@@ -494,7 +493,7 @@ gfx::Rect CustomFrameViewAsh::GetWindowBoundsForClientBounds(
 }
 
 int CustomFrameViewAsh::NonClientHitTest(const gfx::Point& point) {
-  return FrameBorderNonClientHitTest(
+  return FrameBorderHitTestController::NonClientHitTest(
       this, header_view_->caption_button_container(), point);
 }
 
diff --git a/ash/frame/custom_frame_view_ash_unittest.cc b/ash/frame/custom_frame_view_ash_unittest.cc
index 8ebec96..bfcd114 100644
--- a/ash/frame/custom_frame_view_ash_unittest.cc
+++ b/ash/frame/custom_frame_view_ash_unittest.cc
@@ -7,10 +7,10 @@
 #include <memory>
 
 #include "ash/common/ash_layout_constants.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
 #include "ash/common/wm/maximize_mode/maximize_mode_controller.h"
 #include "ash/common/wm_shell.h"
+#include "ash/frame/caption_buttons/frame_caption_button.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
 #include "ash/shell.h"
 #include "ash/test/ash_test_base.h"
 #include "ash/test/test_session_state_delegate.h"
diff --git a/ash/frame/default_header_painter.cc b/ash/frame/default_header_painter.cc
new file mode 100644
index 0000000..7d9c95d
--- /dev/null
+++ b/ash/frame/default_header_painter.cc
@@ -0,0 +1,319 @@
+// Copyright 2014 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "ash/frame/default_header_painter.h"
+
+#include "ash/common/ash_layout_constants.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
+#include "ash/frame/header_painter_util.h"
+#include "base/debug/leak_annotations.h"
+#include "base/logging.h"  // DCHECK
+#include "grit/ash_resources.h"
+#include "third_party/skia/include/core/SkPaint.h"
+#include "third_party/skia/include/core/SkPath.h"
+#include "ui/base/resource/resource_bundle.h"
+#include "ui/gfx/animation/slide_animation.h"
+#include "ui/gfx/canvas.h"
+#include "ui/gfx/color_utils.h"
+#include "ui/gfx/font_list.h"
+#include "ui/gfx/geometry/rect.h"
+#include "ui/gfx/image/image.h"
+#include "ui/gfx/scoped_canvas.h"
+#include "ui/gfx/skia_util.h"
+#include "ui/gfx/vector_icons_public.h"
+#include "ui/views/view.h"
+#include "ui/views/widget/native_widget_aura.h"
+#include "ui/views/widget/widget.h"
+#include "ui/views/widget/widget_delegate.h"
+
+using views::Widget;
+
+namespace {
+
+// Color for the window title text.
+const SkColor kTitleTextColor = SkColorSetRGB(40, 40, 40);
+// Color of the active window header/content separator line.
+const SkColor kHeaderContentSeparatorColor = SkColorSetRGB(150, 150, 152);
+// Color of the inactive window header/content separator line.
+const SkColor kHeaderContentSeparatorInactiveColor =
+    SkColorSetRGB(180, 180, 182);
+// The default color of the frame.
+const SkColor kDefaultFrameColor = SkColorSetRGB(242, 242, 242);
+// Duration of crossfade animation for activating and deactivating frame.
+const int kActivationCrossfadeDurationMs = 200;
+
+// Tiles an image into an area, rounding the top corners.
+void TileRoundRect(gfx::Canvas* canvas,
+                   const SkPaint& paint,
+                   const gfx::Rect& bounds,
+                   int corner_radius) {
+  SkRect rect = gfx::RectToSkRect(bounds);
+  const SkScalar corner_radius_scalar = SkIntToScalar(corner_radius);
+  SkScalar radii[8] = {corner_radius_scalar,
+                       corner_radius_scalar,  // top-left
+                       corner_radius_scalar,
+                       corner_radius_scalar,  // top-right
+                       0,
+                       0,  // bottom-right
+                       0,
+                       0};  // bottom-left
+  SkPath path;
+  path.addRoundRect(rect, radii, SkPath::kCW_Direction);
+  canvas->DrawPath(path, paint);
+}
+
+// Returns the FontList to use for the title.
+const gfx::FontList& GetTitleFontList() {
+  static const gfx::FontList* title_font_list =
+      new gfx::FontList(views::NativeWidgetAura::GetWindowTitleFontList());
+  ANNOTATE_LEAKING_OBJECT_PTR(title_font_list);
+  return *title_font_list;
+}
+
+}  // namespace
+
+namespace ash {
+
+///////////////////////////////////////////////////////////////////////////////
+// DefaultHeaderPainter, public:
+
+DefaultHeaderPainter::DefaultHeaderPainter()
+    : frame_(NULL),
+      view_(NULL),
+      left_header_view_(NULL),
+      active_frame_color_(kDefaultFrameColor),
+      inactive_frame_color_(kDefaultFrameColor),
+      caption_button_container_(NULL),
+      painted_height_(0),
+      mode_(MODE_INACTIVE),
+      initial_paint_(true),
+      activation_animation_(new gfx::SlideAnimation(this)) {}
+
+DefaultHeaderPainter::~DefaultHeaderPainter() {}
+
+void DefaultHeaderPainter::Init(
+    views::Widget* frame,
+    views::View* header_view,
+    FrameCaptionButtonContainerView* caption_button_container) {
+  DCHECK(frame);
+  DCHECK(header_view);
+  DCHECK(caption_button_container);
+  frame_ = frame;
+  view_ = header_view;
+  caption_button_container_ = caption_button_container;
+  caption_button_container_->SetButtonSize(
+      GetAshLayoutSize(AshLayoutSize::NON_BROWSER_CAPTION_BUTTON));
+  UpdateAllButtonImages();
+}
+
+int DefaultHeaderPainter::GetMinimumHeaderWidth() const {
+  // Ensure we have enough space for the window icon and buttons. We allow
+  // the title string to collapse to zero width.
+  return GetTitleBounds().x() +
+         caption_button_container_->GetMinimumSize().width();
+}
+
+void DefaultHeaderPainter::PaintHeader(gfx::Canvas* canvas, Mode mode) {
+  Mode old_mode = mode_;
+  mode_ = mode;
+
+  if (mode_ != old_mode) {
+    UpdateAllButtonImages();
+    if (!initial_paint_ && HeaderPainterUtil::CanAnimateActivation(frame_)) {
+      activation_animation_->SetSlideDuration(kActivationCrossfadeDurationMs);
+      if (mode_ == MODE_ACTIVE)
+        activation_animation_->Show();
+      else
+        activation_animation_->Hide();
+    } else {
+      if (mode_ == MODE_ACTIVE)
+        activation_animation_->Reset(1);
+      else
+        activation_animation_->Reset(0);
+    }
+    initial_paint_ = false;
+  }
+
+  int corner_radius = (frame_->IsMaximized() || frame_->IsFullscreen())
+                          ? 0
+                          : HeaderPainterUtil::GetTopCornerRadiusWhenRestored();
+
+  SkPaint paint;
+  int active_alpha = activation_animation_->CurrentValueBetween(0, 255);
+  paint.setColor(color_utils::AlphaBlend(active_frame_color_,
+                                         inactive_frame_color_, active_alpha));
+
+  TileRoundRect(canvas, paint, GetLocalBounds(), corner_radius);
+
+  if (!frame_->IsMaximized() && !frame_->IsFullscreen() &&
+      mode_ == MODE_INACTIVE && !UsesCustomFrameColors()) {
+    PaintHighlightForInactiveRestoredWindow(canvas);
+  }
+  if (frame_->widget_delegate() &&
+      frame_->widget_delegate()->ShouldShowWindowTitle()) {
+    PaintTitleBar(canvas);
+  }
+  if (!UsesCustomFrameColors())
+    PaintHeaderContentSeparator(canvas);
+}
+
+void DefaultHeaderPainter::LayoutHeader() {
+  caption_button_container_->SetUseLightImages(ShouldUseLightImages());
+  UpdateSizeButtonImages();
+  caption_button_container_->Layout();
+
+  gfx::Size caption_button_container_size =
+      caption_button_container_->GetPreferredSize();
+  caption_button_container_->SetBounds(
+      view_->width() - caption_button_container_size.width(), 0,
+      caption_button_container_size.width(),
+      caption_button_container_size.height());
+
+  if (left_header_view_) {
+    // Vertically center the left header view with respect to the caption button
+    // container.
+    // Floor when computing the center of |caption_button_container_|.
+    gfx::Size size = left_header_view_->GetPreferredSize();
+    int icon_offset_y =
+        caption_button_container_->height() / 2 - size.height() / 2;
+    left_header_view_->SetBounds(HeaderPainterUtil::GetLeftViewXInset(),
+                                 icon_offset_y, size.width(), size.height());
+  }
+
+  // The header/content separator line overlays the caption buttons.
+  SetHeaderHeightForPainting(caption_button_container_->height());
+}
+
+int DefaultHeaderPainter::GetHeaderHeight() const {
+  return caption_button_container_->height();
+}
+
+int DefaultHeaderPainter::GetHeaderHeightForPainting() const {
+  return painted_height_;
+}
+
+void DefaultHeaderPainter::SetHeaderHeightForPainting(int height) {
+  painted_height_ = height;
+}
+
+void DefaultHeaderPainter::SchedulePaintForTitle() {
+  view_->SchedulePaintInRect(GetTitleBounds());
+}
+
+void DefaultHeaderPainter::SetFrameColors(SkColor active_frame_color,
+                                          SkColor inactive_frame_color) {
+  active_frame_color_ = active_frame_color;
+  inactive_frame_color_ = inactive_frame_color;
+  UpdateAllButtonImages();
+}
+
+void DefaultHeaderPainter::UpdateLeftHeaderView(views::View* left_header_view) {
+  left_header_view_ = left_header_view;
+}
+
+///////////////////////////////////////////////////////////////////////////////
+// gfx::AnimationDelegate overrides:
+
+void DefaultHeaderPainter::AnimationProgressed(
+    const gfx::Animation* animation) {
+  view_->SchedulePaintInRect(GetLocalBounds());
+}
+
+///////////////////////////////////////////////////////////////////////////////
+// DefaultHeaderPainter, private:
+
+void DefaultHeaderPainter::PaintHighlightForInactiveRestoredWindow(
+    gfx::Canvas* canvas) {
+  ui::ResourceBundle& rb = ui::ResourceBundle::GetSharedInstance();
+  gfx::ImageSkia top_edge =
+      *rb.GetImageSkiaNamed(IDR_AURA_WINDOW_HEADER_SHADE_INACTIVE_TOP);
+  gfx::ImageSkia left_edge =
+      *rb.GetImageSkiaNamed(IDR_AURA_WINDOW_HEADER_SHADE_INACTIVE_LEFT);
+  gfx::ImageSkia right_edge =
+      *rb.GetImageSkiaNamed(IDR_AURA_WINDOW_HEADER_SHADE_INACTIVE_RIGHT);
+  gfx::ImageSkia bottom_edge =
+      *rb.GetImageSkiaNamed(IDR_AURA_WINDOW_HEADER_SHADE_INACTIVE_BOTTOM);
+
+  int left_edge_width = left_edge.width();
+  int right_edge_width = right_edge.width();
+  canvas->DrawImageInt(left_edge, 0, 0);
+  canvas->DrawImageInt(right_edge, view_->width() - right_edge_width, 0);
+  canvas->TileImageInt(top_edge, left_edge_width, 0,
+                       view_->width() - left_edge_width - right_edge_width,
+                       top_edge.height());
+
+  DCHECK_EQ(left_edge.height(), right_edge.height());
+  int bottom = left_edge.height();
+  int bottom_height = bottom_edge.height();
+  canvas->TileImageInt(bottom_edge, left_edge_width, bottom - bottom_height,
+                       view_->width() - left_edge_width - right_edge_width,
+                       bottom_height);
+}
+
+void DefaultHeaderPainter::PaintTitleBar(gfx::Canvas* canvas) {
+  // The window icon is painted by its own views::View.
+  gfx::Rect title_bounds = GetTitleBounds();
+  title_bounds.set_x(view_->GetMirroredXForRect(title_bounds));
+  canvas->DrawStringRectWithFlags(
+      frame_->widget_delegate()->GetWindowTitle(), GetTitleFontList(),
+      kTitleTextColor, title_bounds, gfx::Canvas::NO_SUBPIXEL_RENDERING);
+}
+
+void DefaultHeaderPainter::PaintHeaderContentSeparator(gfx::Canvas* canvas) {
+  gfx::ScopedCanvas scoped_canvas(canvas);
+  const float scale = canvas->UndoDeviceScaleFactor();
+  gfx::RectF rect(0, painted_height_ * scale - 1, view_->width() * scale, 1);
+  SkPaint paint;
+  paint.setColor((mode_ == MODE_ACTIVE) ? kHeaderContentSeparatorColor
+                                        : kHeaderContentSeparatorInactiveColor);
+  canvas->sk_canvas()->drawRect(gfx::RectFToSkRect(rect), paint);
+}
+
+bool DefaultHeaderPainter::ShouldUseLightImages() {
+  return color_utils::IsDark(mode_ == MODE_INACTIVE ? inactive_frame_color_
+                                                    : active_frame_color_);
+}
+
+void DefaultHeaderPainter::UpdateAllButtonImages() {
+  caption_button_container_->SetUseLightImages(ShouldUseLightImages());
+  caption_button_container_->SetButtonImage(
+      CAPTION_BUTTON_ICON_MINIMIZE, gfx::VectorIconId::WINDOW_CONTROL_MINIMIZE);
+
+  UpdateSizeButtonImages();
+
+  caption_button_container_->SetButtonImage(
+      CAPTION_BUTTON_ICON_CLOSE, gfx::VectorIconId::WINDOW_CONTROL_CLOSE);
+
+  caption_button_container_->SetButtonImage(
+      CAPTION_BUTTON_ICON_LEFT_SNAPPED,
+      gfx::VectorIconId::WINDOW_CONTROL_LEFT_SNAPPED);
+
+  caption_button_container_->SetButtonImage(
+      CAPTION_BUTTON_ICON_RIGHT_SNAPPED,
+      gfx::VectorIconId::WINDOW_CONTROL_RIGHT_SNAPPED);
+}
+
+void DefaultHeaderPainter::UpdateSizeButtonImages() {
+  gfx::VectorIconId icon_id = frame_->IsMaximized() || frame_->IsFullscreen()
+                                  ? gfx::VectorIconId::WINDOW_CONTROL_RESTORE
+                                  : gfx::VectorIconId::WINDOW_CONTROL_MAXIMIZE;
+  caption_button_container_->SetButtonImage(
+      CAPTION_BUTTON_ICON_MAXIMIZE_RESTORE, icon_id);
+}
+
+gfx::Rect DefaultHeaderPainter::GetLocalBounds() const {
+  return gfx::Rect(view_->width(), painted_height_);
+}
+
+gfx::Rect DefaultHeaderPainter::GetTitleBounds() const {
+  return HeaderPainterUtil::GetTitleBounds(
+      left_header_view_, caption_button_container_, GetTitleFontList());
+}
+
+bool DefaultHeaderPainter::UsesCustomFrameColors() const {
+  return active_frame_color_ != kDefaultFrameColor ||
+         inactive_frame_color_ != kDefaultFrameColor;
+}
+
+}  // namespace ash
diff --git a/ash/frame/default_header_painter.h b/ash/frame/default_header_painter.h
new file mode 100644
index 0000000..dd56551
--- /dev/null
+++ b/ash/frame/default_header_painter.h
@@ -0,0 +1,120 @@
+// Copyright 2014 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef ASH_FRAME_DEFAULT_HEADER_PAINTER_H_
+#define ASH_FRAME_DEFAULT_HEADER_PAINTER_H_
+
+#include <memory>
+
+#include "ash/ash_export.h"
+#include "ash/frame/header_painter.h"
+#include "base/compiler_specific.h"  // override
+#include "base/gtest_prod_util.h"
+#include "base/macros.h"
+#include "third_party/skia/include/core/SkColor.h"
+#include "ui/gfx/animation/animation_delegate.h"
+
+namespace gfx {
+class ImageSkia;
+class Rect;
+class SlideAnimation;
+}
+namespace views {
+class View;
+class Widget;
+}
+
+namespace ash {
+class FrameCaptionButtonContainerView;
+
+// Helper class for painting the default window header.
+class ASH_EXPORT DefaultHeaderPainter : public HeaderPainter,
+                                        public gfx::AnimationDelegate {
+ public:
+  DefaultHeaderPainter();
+  ~DefaultHeaderPainter() override;
+
+  // DefaultHeaderPainter does not take ownership of any of the parameters.
+  void Init(views::Widget* frame,
+            views::View* header_view,
+            FrameCaptionButtonContainerView* caption_button_container);
+
+  // HeaderPainter overrides:
+  int GetMinimumHeaderWidth() const override;
+  void PaintHeader(gfx::Canvas* canvas, Mode mode) override;
+  void LayoutHeader() override;
+  int GetHeaderHeight() const override;
+  int GetHeaderHeightForPainting() const override;
+  void SetHeaderHeightForPainting(int height) override;
+  void SchedulePaintForTitle() override;
+
+  // Sets the left header view for the header. Passing NULL removes the view.
+  void UpdateLeftHeaderView(views::View* left_header_view);
+
+  // Sets the active and inactive frame colors. Note the inactive frame color
+  // will have some transparency added when the frame is drawn.
+  void SetFrameColors(SkColor active_frame_color, SkColor inactive_frame_color);
+
+ private:
+  FRIEND_TEST_ALL_PREFIXES(DefaultHeaderPainterTest, TitleIconAlignment);
+  FRIEND_TEST_ALL_PREFIXES(DefaultHeaderPainterTest, LightIcons);
+
+  // gfx::AnimationDelegate override:
+  void AnimationProgressed(const gfx::Animation* animation) override;
+
+  // Paints highlight around the edge of the header for inactive restored
+  // windows.
+  void PaintHighlightForInactiveRestoredWindow(gfx::Canvas* canvas);
+
+  // Paints the title bar, primarily the title string.
+  void PaintTitleBar(gfx::Canvas* canvas);
+
+  // Paints the header/content separator.
+  void PaintHeaderContentSeparator(gfx::Canvas* canvas);
+
+  // Whether light caption images should be used. This is the case when the
+  // background of the frame is dark.
+  bool ShouldUseLightImages();
+
+  // Update all the images in the caption buttons.
+  void UpdateAllButtonImages();
+
+  // Updates the size button's images.
+  void UpdateSizeButtonImages();
+
+  // Returns the header bounds in the coordinates of |view_|. The header is
+  // assumed to be positioned at the top left corner of |view_| and to have the
+  // same width as |view_|.
+  gfx::Rect GetLocalBounds() const;
+
+  // Returns the bounds for the title.
+  gfx::Rect GetTitleBounds() const;
+
+  // Returns whether the frame uses custom frame coloring.
+  bool UsesCustomFrameColors() const;
+
+  views::Widget* frame_;
+  views::View* view_;
+  views::View* left_header_view_;  // May be NULL.
+  SkColor active_frame_color_;
+  SkColor inactive_frame_color_;
+  FrameCaptionButtonContainerView* caption_button_container_;
+
+  // The height of the header to paint.
+  int painted_height_;
+
+  // Whether the header should be painted as active.
+  Mode mode_;
+
+  // Whether the header is painted for the first time.
+  bool initial_paint_;
+
+  std::unique_ptr<gfx::SlideAnimation> activation_animation_;
+
+  DISALLOW_COPY_AND_ASSIGN(DefaultHeaderPainter);
+};
+
+}  // namespace ash
+
+#endif  // ASH_FRAME_DEFAULT_HEADER_PAINTER_H_
diff --git a/ash/frame/default_header_painter_unittest.cc b/ash/frame/default_header_painter_unittest.cc
new file mode 100644
index 0000000..04454e3
--- /dev/null
+++ b/ash/frame/default_header_painter_unittest.cc
@@ -0,0 +1,85 @@
+// Copyright 2014 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "ash/frame/default_header_painter.h"
+
+#include <memory>
+
+#include "ash/common/shell_window_ids.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
+#include "ash/test/ash_test_base.h"
+#include "ui/views/test/test_views.h"
+#include "ui/views/widget/widget.h"
+#include "ui/views/window/non_client_view.h"
+
+using ash::HeaderPainter;
+using views::NonClientFrameView;
+using views::Widget;
+
+namespace ash {
+
+using DefaultHeaderPainterTest = test::AshTestBase;
+
+// Ensure the title text is vertically aligned with the window icon.
+TEST_F(DefaultHeaderPainterTest, TitleIconAlignment) {
+  std::unique_ptr<Widget> w = CreateTestWidget(
+      nullptr, kShellWindowId_DefaultContainer, gfx::Rect(1, 2, 3, 4));
+  ash::FrameCaptionButtonContainerView container(w.get());
+  views::StaticSizedView window_icon(gfx::Size(16, 16));
+  window_icon.SetBounds(0, 0, 16, 16);
+  w->SetBounds(gfx::Rect(0, 0, 500, 500));
+  w->Show();
+
+  DefaultHeaderPainter painter;
+  painter.Init(w.get(), w->non_client_view()->frame_view(), &container);
+  painter.UpdateLeftHeaderView(&window_icon);
+  painter.LayoutHeader();
+  gfx::Rect title_bounds = painter.GetTitleBounds();
+  EXPECT_EQ(window_icon.bounds().CenterPoint().y(),
+            title_bounds.CenterPoint().y());
+}
+
+// Ensure the light icons are used when appropriate.
+TEST_F(DefaultHeaderPainterTest, LightIcons) {
+  std::unique_ptr<Widget> w = CreateTestWidget(
+      nullptr, kShellWindowId_DefaultContainer, gfx::Rect(1, 2, 3, 4));
+  ash::FrameCaptionButtonContainerView container(w.get());
+  views::StaticSizedView window_icon(gfx::Size(16, 16));
+  window_icon.SetBounds(0, 0, 16, 16);
+  w->SetBounds(gfx::Rect(0, 0, 500, 500));
+  w->Show();
+
+  DefaultHeaderPainter painter;
+  painter.Init(w.get(), w->non_client_view()->frame_view(), &container);
+
+  // Check by default light icons are not used.
+  painter.mode_ = HeaderPainter::MODE_ACTIVE;
+  EXPECT_FALSE(painter.ShouldUseLightImages());
+  painter.mode_ = HeaderPainter::MODE_INACTIVE;
+  EXPECT_FALSE(painter.ShouldUseLightImages());
+
+  // Check that setting dark colors should use light icons.
+  painter.SetFrameColors(SkColorSetRGB(0, 0, 0), SkColorSetRGB(0, 0, 0));
+  painter.mode_ = HeaderPainter::MODE_ACTIVE;
+  EXPECT_TRUE(painter.ShouldUseLightImages());
+  painter.mode_ = HeaderPainter::MODE_INACTIVE;
+  EXPECT_TRUE(painter.ShouldUseLightImages());
+
+  // Check that inactive and active colors are used properly.
+  painter.SetFrameColors(SkColorSetRGB(0, 0, 0), SkColorSetRGB(255, 255, 255));
+  painter.mode_ = HeaderPainter::MODE_ACTIVE;
+  EXPECT_TRUE(painter.ShouldUseLightImages());
+  painter.mode_ = HeaderPainter::MODE_INACTIVE;
+  EXPECT_FALSE(painter.ShouldUseLightImages());
+
+  // Check not so light or dark colors.
+  painter.SetFrameColors(SkColorSetRGB(70, 70, 70),
+                         SkColorSetRGB(200, 200, 200));
+  painter.mode_ = HeaderPainter::MODE_ACTIVE;
+  EXPECT_TRUE(painter.ShouldUseLightImages());
+  painter.mode_ = HeaderPainter::MODE_INACTIVE;
+  EXPECT_FALSE(painter.ShouldUseLightImages());
+}
+
+}  // namespace ash
diff --git a/ash/frame/frame_border_hit_test_controller.cc b/ash/frame/frame_border_hit_test_controller.cc
index e3c090b..ab254a3 100644
--- a/ash/frame/frame_border_hit_test_controller.cc
+++ b/ash/frame/frame_border_hit_test_controller.cc
@@ -6,9 +6,18 @@
 
 #include <memory>
 
+#include "ash/common/ash_constants.h"
+#include "ash/common/wm/window_state_observer.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
 #include "ash/wm/resize_handle_window_targeter.h"
+#include "ui/aura/env.h"
 #include "ui/aura/window.h"
+#include "ui/aura/window_observer.h"
+#include "ui/aura/window_targeter.h"
+#include "ui/base/hit_test.h"
 #include "ui/views/widget/widget.h"
+#include "ui/views/widget/widget_delegate.h"
+#include "ui/views/window/non_client_view.h"
 
 namespace ash {
 
@@ -20,4 +29,55 @@ FrameBorderHitTestController::FrameBorderHitTestController(views::Widget* frame)
 
 FrameBorderHitTestController::~FrameBorderHitTestController() {}
 
+// static
+int FrameBorderHitTestController::NonClientHitTest(
+    views::NonClientFrameView* view,
+    FrameCaptionButtonContainerView* caption_button_container,
+    const gfx::Point& point_in_widget) {
+  gfx::Rect expanded_bounds = view->bounds();
+  int outside_bounds = kResizeOutsideBoundsSize;
+
+  if (aura::Env::GetInstance()->is_touch_down())
+    outside_bounds *= kResizeOutsideBoundsScaleForTouch;
+  expanded_bounds.Inset(-outside_bounds, -outside_bounds);
+
+  if (!expanded_bounds.Contains(point_in_widget))
+    return HTNOWHERE;
+
+  // Check the frame first, as we allow a small area overlapping the contents
+  // to be used for resize handles.
+  views::Widget* frame = view->GetWidget();
+  bool can_ever_resize = frame->widget_delegate()->CanResize();
+  // Don't allow overlapping resize handles when the window is maximized or
+  // fullscreen, as it can't be resized in those states.
+  int resize_border = kResizeInsideBoundsSize;
+  if (frame->IsMaximized() || frame->IsFullscreen()) {
+    resize_border = 0;
+    can_ever_resize = false;
+  }
+  int frame_component = view->GetHTComponentForFrame(
+      point_in_widget, resize_border, resize_border, kResizeAreaCornerSize,
+      kResizeAreaCornerSize, can_ever_resize);
+  if (frame_component != HTNOWHERE)
+    return frame_component;
+
+  int client_component =
+      frame->client_view()->NonClientHitTest(point_in_widget);
+  if (client_component != HTNOWHERE)
+    return client_component;
+
+  if (caption_button_container->visible()) {
+    gfx::Point point_in_caption_button_container(point_in_widget);
+    views::View::ConvertPointFromWidget(caption_button_container,
+                                        &point_in_caption_button_container);
+    int caption_button_component = caption_button_container->NonClientHitTest(
+        point_in_caption_button_container);
+    if (caption_button_component != HTNOWHERE)
+      return caption_button_component;
+  }
+
+  // Caption is a safe default.
+  return HTCAPTION;
+}
+
 }  // namespace ash
diff --git a/ash/frame/frame_border_hit_test_controller.h b/ash/frame/frame_border_hit_test_controller.h
index af2a2ca..e46ff5b 100644
--- a/ash/frame/frame_border_hit_test_controller.h
+++ b/ash/frame/frame_border_hit_test_controller.h
@@ -6,25 +6,38 @@
 #define ASH_FRAME_FRAME_BORDER_HITTEST_CONTROLLER_H_
 
 #include "ash/ash_export.h"
+#include "base/compiler_specific.h"
 #include "base/macros.h"
 
 namespace aura {
 class Window;
 }
 
+namespace gfx {
+class Point;
+}
+
 namespace views {
+class NonClientFrameView;
 class Widget;
 }
 
 namespace ash {
+class FrameCaptionButtonContainerView;
 
 // Class which manages the hittest override bounds for |frame|.
-// TODO(sky): remove this class entirely. It isn't really needed.
 class ASH_EXPORT FrameBorderHitTestController {
  public:
   explicit FrameBorderHitTestController(views::Widget* frame);
   virtual ~FrameBorderHitTestController();
 
+  // Does the non client hit test on behalf of |view|. |point_in_widget| must be
+  // in the coordinates of |view|'s widget.
+  static int NonClientHitTest(
+      views::NonClientFrameView* view,
+      FrameCaptionButtonContainerView* caption_button_container,
+      const gfx::Point& point_in_widget);
+
  private:
   // The window whose hittest override bounds are being managed.
   aura::Window* frame_window_;
diff --git a/ash/frame/header_painter.h b/ash/frame/header_painter.h
new file mode 100644
index 0000000..517f2aa
--- /dev/null
+++ b/ash/frame/header_painter.h
@@ -0,0 +1,47 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef ASH_FRAME_HEADER_PAINTER_H_
+#define ASH_FRAME_HEADER_PAINTER_H_
+
+#include "ash/ash_export.h"
+
+namespace gfx {
+class Canvas;
+}
+
+namespace ash {
+
+// Helper class for painting the window header.
+class ASH_EXPORT HeaderPainter {
+ public:
+  enum Mode { MODE_ACTIVE, MODE_INACTIVE };
+
+  virtual ~HeaderPainter() {}
+
+  // Returns the header's minimum width.
+  virtual int GetMinimumHeaderWidth() const = 0;
+
+  // Paints the header.
+  virtual void PaintHeader(gfx::Canvas* canvas, Mode mode) = 0;
+
+  // Performs layout for the header.
+  virtual void LayoutHeader() = 0;
+
+  // Get the height of the header.
+  virtual int GetHeaderHeight() const = 0;
+
+  // Gets / sets how much of the header is painted. This allows the header to
+  // paint under things (like the tabstrip) which have transparent /
+  // non-painting sections. This height does not affect LayoutHeader().
+  virtual int GetHeaderHeightForPainting() const = 0;
+  virtual void SetHeaderHeightForPainting(int height_for_painting) = 0;
+
+  // Schedule a re-paint of the entire title.
+  virtual void SchedulePaintForTitle() = 0;
+};
+
+}  // namespace ash
+
+#endif  // ASH_FRAME_HEADER_PAINTER_H_
diff --git a/ash/frame/header_painter_util.cc b/ash/frame/header_painter_util.cc
new file mode 100644
index 0000000..ab5b9d5
--- /dev/null
+++ b/ash/frame/header_painter_util.cc
@@ -0,0 +1,97 @@
+// Copyright 2014 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "ash/frame/header_painter_util.h"
+
+#include <algorithm>
+
+#include "ui/aura/window.h"
+#include "ui/compositor/layer.h"
+#include "ui/compositor/layer_animator.h"
+#include "ui/gfx/font_list.h"
+#include "ui/gfx/geometry/rect.h"
+#include "ui/views/view.h"
+#include "ui/views/widget/widget.h"
+
+namespace {
+
+// Radius of the header's top corners when the window is restored.
+const int kTopCornerRadiusWhenRestored = 2;
+
+// Distance between left edge of the window and the leftmost view.
+const int kLeftViewXInset = 9;
+
+// Space between the title text and the caption buttons.
+const int kTitleCaptionButtonSpacing = 5;
+
+// Space between window icon and title text.
+const int kTitleIconOffsetX = 5;
+
+// Space between window edge and title text, when there is no icon.
+const int kTitleNoIconOffsetX = 8;
+
+// In the pre-Ash era the web content area had a frame along the left edge, so
+// user-generated theme images for the new tab page assume they are shifted
+// right relative to the header.  Now that we have removed the left edge frame
+// we need to copy the theme image for the window header from a few pixels
+// inset to preserve alignment with the NTP image, or else we'll break a bunch
+// of existing themes.  We do something similar on OS X for the same reason.
+const int kThemeFrameImageInsetX = 5;
+
+}  // namespace
+
+namespace ash {
+
+// static
+int HeaderPainterUtil::GetTopCornerRadiusWhenRestored() {
+  return kTopCornerRadiusWhenRestored;
+}
+
+// static
+int HeaderPainterUtil::GetLeftViewXInset() {
+  return kLeftViewXInset;
+}
+
+// static
+int HeaderPainterUtil::GetThemeBackgroundXInset() {
+  return kThemeFrameImageInsetX;
+}
+
+// static
+gfx::Rect HeaderPainterUtil::GetTitleBounds(
+    const views::View* left_view,
+    const views::View* right_view,
+    const gfx::FontList& title_font_list) {
+  int x = left_view ? left_view->bounds().right() + kTitleIconOffsetX
+                    : kTitleNoIconOffsetX;
+  int height = title_font_list.GetHeight();
+  // Floor when computing the center of |caption_button_container| and when
+  // computing the center of the text.
+  int y = std::max(0, (right_view->height() / 2) - (height / 2));
+  int width = std::max(0, right_view->x() - kTitleCaptionButtonSpacing - x);
+  return gfx::Rect(x, y, width, height);
+}
+
+// static
+bool HeaderPainterUtil::CanAnimateActivation(views::Widget* widget) {
+  // Do not animate the header if the parent (e.g.
+  // kShellWindowId_DefaultContainer) is already animating. All of the
+  // implementers of HeaderPainter animate activation by continuously painting
+  // during the animation. This gives the parent's animation a slower frame
+  // rate.
+  // TODO(sky): Expose a better way to determine this rather than assuming the
+  // parent is a toplevel container.
+  aura::Window* window = widget->GetNativeWindow();
+  if (!window->parent())
+    return true;
+
+  ui::LayerAnimator* parent_layer_animator =
+      window->parent()->layer()->GetAnimator();
+  return !parent_layer_animator->IsAnimatingProperty(
+             ui::LayerAnimationElement::OPACITY) &&
+         !parent_layer_animator->IsAnimatingProperty(
+             ui::LayerAnimationElement::VISIBILITY);
+}
+
+}  // namespace ash
diff --git a/ash/frame/header_painter_util.h b/ash/frame/header_painter_util.h
new file mode 100644
index 0000000..d0b5e3c
--- /dev/null
+++ b/ash/frame/header_painter_util.h
@@ -0,0 +1,55 @@
+// Copyright 2014 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef ASH_FRAME_HEADER_PAINTER_UTIL_H_
+#define ASH_FRAME_HEADER_PAINTER_UTIL_H_
+
+#include "ash/ash_export.h"
+#include "base/macros.h"
+
+namespace gfx {
+class FontList;
+class Rect;
+}
+namespace views {
+class View;
+class Widget;
+}
+
+namespace ash {
+
+// Static-only helper class for functionality used accross multiple
+// implementations of HeaderPainter.
+class ASH_EXPORT HeaderPainterUtil {
+ public:
+  // Returns the radius of the header's corners when the window is restored.
+  static int GetTopCornerRadiusWhenRestored();
+
+  // Returns the default distance between the left edge of the window and the
+  // leftmost view in the header.
+  static int GetLeftViewXInset();
+
+  // Returns the amount that the frame background is inset from the left edge of
+  // the window.
+  static int GetThemeBackgroundXInset();
+
+  // Returns the bounds for the header's title given the views to the left and
+  // right of the title, and the font used.
+  // |left_view| should be NULL if there is no view to the left of the title.
+  static gfx::Rect GetTitleBounds(const views::View* left_view,
+                                  const views::View* right_view,
+                                  const gfx::FontList& title_font_list);
+
+  // Returns true if the header for |widget| can animate to new visuals when the
+  // widget's activation changes. Returns false if the header should switch to
+  // new visuals instantaneously.
+  static bool CanAnimateActivation(views::Widget* widget);
+
+ private:
+  DISALLOW_IMPLICIT_CONSTRUCTORS(HeaderPainterUtil);
+};
+
+}  // namespace ash
+
+#endif  // ASH_FRAME_HEADER_PAINTER_UTIL_H_
diff --git a/ash/mus/bridge/wm_shell_mus.cc b/ash/mus/bridge/wm_shell_mus.cc
index 02943f8..0e71dfb 100644
--- a/ash/mus/bridge/wm_shell_mus.cc
+++ b/ash/mus/bridge/wm_shell_mus.cc
@@ -33,7 +33,6 @@
 #include "services/ui/common/util.h"
 #include "services/ui/public/cpp/window.h"
 #include "services/ui/public/cpp/window_tree_client.h"
-#include "ui/display/screen.h"
 
 namespace ash {
 namespace mus {
@@ -211,29 +210,17 @@ WmWindow* WmShellMus::GetRootWindowForDisplayId(int64_t display_id) {
 }
 
 const DisplayInfo& WmShellMus::GetDisplayInfo(int64_t display_id) const {
-  // TODO(mash): implement http://crbug.com/622480.
   NOTIMPLEMENTED();
   static DisplayInfo fake_info;
   return fake_info;
 }
 
 bool WmShellMus::IsActiveDisplayId(int64_t display_id) const {
-  // TODO(mash): implement http://crbug.com/622480.
+  // TODO: implement http://crbug.com/622480.
   NOTIMPLEMENTED();
   return true;
 }
 
-display::Display WmShellMus::GetFirstDisplay() const {
-  // TODO(mash): implement http://crbug.com/622480.
-  NOTIMPLEMENTED();
-  return display::Screen::GetScreen()->GetPrimaryDisplay();
-}
-
-bool WmShellMus::IsInUnifiedMode() const {
-  // TODO(mash): implement http://crbug.com/622480.
-  return false;
-}
-
 bool WmShellMus::IsForceMaximizeOnFirstRun() {
   NOTIMPLEMENTED();
   return false;
@@ -268,11 +255,6 @@ std::vector<WmWindow*> WmShellMus::GetAllRootWindows() {
   return wm_windows;
 }
 
-void WmShellMus::RecordGestureAction(GestureActionType action) {
-  // TODO: http://crbug.com/616581.
-  NOTIMPLEMENTED();
-}
-
 void WmShellMus::RecordUserMetricsAction(UserMetricsAction action) {
   // TODO: http://crbug.com/616581.
   NOTIMPLEMENTED();
@@ -354,12 +336,6 @@ void WmShellMus::RemovePointerWatcher(views::PointerWatcher* watcher) {
   NOTIMPLEMENTED();
 }
 
-bool WmShellMus::IsTouchDown() {
-  // TODO: implement me, http://crbug.com/634967.
-  NOTIMPLEMENTED();
-  return false;
-}
-
 #if defined(OS_CHROMEOS)
 void WmShellMus::ToggleIgnoreExternalKeyboard() {
   NOTIMPLEMENTED();
diff --git a/ash/mus/bridge/wm_shell_mus.h b/ash/mus/bridge/wm_shell_mus.h
index b66450e..02da8a8 100644
--- a/ash/mus/bridge/wm_shell_mus.h
+++ b/ash/mus/bridge/wm_shell_mus.h
@@ -63,8 +63,6 @@ class WmShellMus : public WmShell, public ui::WindowTreeClientObserver {
   WmWindow* GetRootWindowForDisplayId(int64_t display_id) override;
   const DisplayInfo& GetDisplayInfo(int64_t display_id) const override;
   bool IsActiveDisplayId(int64_t display_id) const override;
-  display::Display GetFirstDisplay() const override;
-  bool IsInUnifiedMode() const override;
   bool IsForceMaximizeOnFirstRun() override;
   bool IsPinned() override;
   void SetPinnedWindow(WmWindow* window) override;
@@ -72,7 +70,6 @@ class WmShellMus : public WmShell, public ui::WindowTreeClientObserver {
   void LockCursor() override;
   void UnlockCursor() override;
   std::vector<WmWindow*> GetAllRootWindows() override;
-  void RecordGestureAction(GestureActionType action) override;
   void RecordUserMetricsAction(UserMetricsAction action) override;
   void RecordTaskSwitchMetric(TaskSwitchSource source) override;
   void ShowContextMenu(const gfx::Point& location_in_screen,
@@ -95,7 +92,6 @@ class WmShellMus : public WmShell, public ui::WindowTreeClientObserver {
   void RemoveDisplayObserver(WmDisplayObserver* observer) override;
   void AddPointerWatcher(views::PointerWatcher* watcher) override;
   void RemovePointerWatcher(views::PointerWatcher* watcher) override;
-  bool IsTouchDown() override;
 #if defined(OS_CHROMEOS)
   void ToggleIgnoreExternalKeyboard() override;
 #endif
diff --git a/ash/mus/bridge/wm_window_mus.cc b/ash/mus/bridge/wm_window_mus.cc
index 49b3aa7..25c7c93 100644
--- a/ash/mus/bridge/wm_window_mus.cc
+++ b/ash/mus/bridge/wm_window_mus.cc
@@ -7,7 +7,6 @@
 #include "ash/common/wm/container_finder.h"
 #include "ash/common/wm/window_state.h"
 #include "ash/common/wm_layout_manager.h"
-#include "ash/common/wm_transient_window_observer.h"
 #include "ash/common/wm_window_observer.h"
 #include "ash/common/wm_window_property.h"
 #include "ash/mus/bridge/mus_layout_manager_adapter.h"
@@ -206,10 +205,6 @@ ui::wm::WindowType WmWindowMus::GetType() const {
   return GetWmWindowType(window_);
 }
 
-bool WmWindowMus::IsBubble() {
-  return GetWindowType(window_) == ui::mojom::WindowType::BUBBLE;
-}
-
 ui::Layer* WmWindowMus::GetLayer() {
   // TODO(sky): this function should be nuked entirely.
   NOTIMPLEMENTED();
@@ -771,16 +766,6 @@ bool WmWindowMus::HasObserver(const WmWindowObserver* observer) const {
   return observers_.HasObserver(observer);
 }
 
-void WmWindowMus::AddTransientWindowObserver(
-    WmTransientWindowObserver* observer) {
-  transient_observers_.AddObserver(observer);
-}
-
-void WmWindowMus::RemoveTransientWindowObserver(
-    WmTransientWindowObserver* observer) {
-  transient_observers_.RemoveObserver(observer);
-}
-
 void WmWindowMus::AddLimitedPreTargetHandler(ui::EventHandler* handler) {
   DCHECK(GetInternalWidget());
   widget_->GetNativeWindow()->AddPreTargetHandler(handler);
@@ -850,17 +835,5 @@ void WmWindowMus::OnWindowDestroyed(ui::Window* window) {
   FOR_EACH_OBSERVER(WmWindowObserver, observers_, OnWindowDestroyed(this));
 }
 
-void WmWindowMus::OnTransientChildAdded(ui::Window* window,
-                                        ui::Window* transient) {
-  FOR_EACH_OBSERVER(WmTransientWindowObserver, transient_observers_,
-                    OnTransientChildAdded(this, Get(transient)));
-}
-
-void WmWindowMus::OnTransientChildRemoved(ui::Window* window,
-                                          ui::Window* transient) {
-  FOR_EACH_OBSERVER(WmTransientWindowObserver, transient_observers_,
-                    OnTransientChildRemoved(this, Get(transient)));
-}
-
 }  // namespace mus
 }  // namespace ash
diff --git a/ash/mus/bridge/wm_window_mus.h b/ash/mus/bridge/wm_window_mus.h
index a8e1145..cee1128 100644
--- a/ash/mus/bridge/wm_window_mus.h
+++ b/ash/mus/bridge/wm_window_mus.h
@@ -111,7 +111,6 @@ class WmWindowMus : public WmWindow, public ui::WindowObserver {
   int GetShellWindowId() const override;
   WmWindow* GetChildByShellWindowId(int id) override;
   ui::wm::WindowType GetType() const override;
-  bool IsBubble() override;
   ui::Layer* GetLayer() override;
   display::Display GetDisplayNearestWindow() override;
   bool HasNonClientArea() override;
@@ -219,9 +218,6 @@ class WmWindowMus : public WmWindow, public ui::WindowObserver {
   void AddObserver(WmWindowObserver* observer) override;
   void RemoveObserver(WmWindowObserver* observer) override;
   bool HasObserver(const WmWindowObserver* observer) const override;
-  void AddTransientWindowObserver(WmTransientWindowObserver* observer) override;
-  void RemoveTransientWindowObserver(
-      WmTransientWindowObserver* observer) override;
   void AddLimitedPreTargetHandler(ui::EventHandler* handler) override;
   void RemoveLimitedPreTargetHandler(ui::EventHandler* handler) override;
 
@@ -242,10 +238,6 @@ class WmWindowMus : public WmWindow, public ui::WindowObserver {
                              const gfx::Rect& new_bounds) override;
   void OnWindowDestroying(ui::Window* window) override;
   void OnWindowDestroyed(ui::Window* window) override;
-  void OnTransientChildAdded(ui::Window* window,
-                             ui::Window* transient) override;
-  void OnTransientChildRemoved(ui::Window* window,
-                               ui::Window* transient) override;
 
   ui::Window* window_;
 
@@ -273,8 +265,6 @@ class WmWindowMus : public WmWindow, public ui::WindowObserver {
   // resizing easier.
   bool children_use_extended_hit_region_ = false;
 
-  base::ObserverList<WmTransientWindowObserver, true> transient_observers_;
-
   DISALLOW_COPY_AND_ASSIGN(WmWindowMus);
 };
 
diff --git a/ash/mus/shell_delegate_mus.cc b/ash/mus/shell_delegate_mus.cc
index 32ffcd4..cf45d1d 100644
--- a/ash/mus/shell_delegate_mus.cc
+++ b/ash/mus/shell_delegate_mus.cc
@@ -8,7 +8,6 @@
 
 #include "ash/common/gpu_support_stub.h"
 #include "ash/common/media_delegate.h"
-#include "ash/common/palette_delegate.h"
 #include "ash/common/pointer_watcher_delegate.h"
 #include "ash/common/session/session_state_delegate.h"
 #include "ash/common/system/tray/default_system_tray_delegate.h"
@@ -197,11 +196,6 @@ MediaDelegate* ShellDelegateMus::CreateMediaDelegate() {
   return new MediaDelegateStub;
 }
 
-std::unique_ptr<PaletteDelegate> ShellDelegateMus::CreatePaletteDelegate() {
-  NOTIMPLEMENTED();
-  return nullptr;
-}
-
 std::unique_ptr<PointerWatcherDelegate>
 ShellDelegateMus::CreatePointerWatcherDelegate() {
   NOTIMPLEMENTED();
diff --git a/ash/mus/shell_delegate_mus.h b/ash/mus/shell_delegate_mus.h
index ea782e5..bd1cfc9 100644
--- a/ash/mus/shell_delegate_mus.h
+++ b/ash/mus/shell_delegate_mus.h
@@ -46,7 +46,6 @@ class ShellDelegateMus : public ShellDelegate {
   AccessibilityDelegate* CreateAccessibilityDelegate() override;
   NewWindowDelegate* CreateNewWindowDelegate() override;
   MediaDelegate* CreateMediaDelegate() override;
-  std::unique_ptr<PaletteDelegate> CreatePaletteDelegate() override;
   std::unique_ptr<PointerWatcherDelegate> CreatePointerWatcherDelegate()
       override;
   ui::MenuModel* CreateContextMenu(WmShelf* wm_shelf,
diff --git a/ash/screen_util.cc b/ash/screen_util.cc
index 8da7296..1ffa98c 100644
--- a/ash/screen_util.cc
+++ b/ash/screen_util.cc
@@ -53,6 +53,32 @@ gfx::Rect ScreenUtil::GetDisplayWorkAreaBoundsInParent(aura::Window* window) {
 }
 
 // static
+gfx::Rect ScreenUtil::GetShelfDisplayBoundsInRoot(aura::Window* window) {
+  DisplayManager* display_manager = Shell::GetInstance()->display_manager();
+  if (display_manager->IsInUnifiedMode()) {
+    // In unified desktop mode, there is only one shelf in the 1st display.
+    const display::Display& first =
+        display_manager->software_mirroring_display_list()[0];
+    float scale =
+        static_cast<float>(window->GetRootWindow()->bounds().height()) /
+        first.size().height();
+    gfx::SizeF size(first.size());
+    size.Scale(scale, scale);
+    return gfx::Rect(gfx::ToCeiledSize(size));
+  }
+
+  if (Shell::GetInstance()->in_mus()) {
+    // In mus the RootWindow is the widget's root window, so use the display
+    // bounds.
+    display::Display display =
+        display::Screen::GetScreen()->GetDisplayNearestWindow(window);
+    return display.bounds();
+  }
+
+  return window->GetRootWindow()->bounds();
+}
+
+// static
 gfx::Rect ScreenUtil::ConvertRectToScreen(aura::Window* window,
                                           const gfx::Rect& rect) {
   gfx::Point point = rect.origin();
diff --git a/ash/screen_util.h b/ash/screen_util.h
index 22d5a50..853c12e 100644
--- a/ash/screen_util.h
+++ b/ash/screen_util.h
@@ -40,6 +40,15 @@ class ASH_EXPORT ScreenUtil {
   // Returns the display's work area bounds in parent coordinates.
   static gfx::Rect GetDisplayWorkAreaBoundsInParent(aura::Window* window);
 
+  // Returns the physical display bounds containing the shelf that
+  // shares the same root window as |root|. Physical displays can
+  // differ from logical displays in unified desktop mode.
+  // TODO(oshima): If we need to expand the unified desktop support to
+  // general use, we should consider always using physical display in
+  // window layout instead of root window, and keep the logical
+  // display only in display management code.
+  static gfx::Rect GetShelfDisplayBoundsInRoot(aura::Window* window);
+
   // TODO(oshima): Move following two to wm/coordinate_conversion.h
   // Converts |rect| from |window|'s coordinates to the virtual screen
   // coordinates.
diff --git a/ash/screen_util_unittest.cc b/ash/screen_util_unittest.cc
index 77d33c3..095cabd 100644
--- a/ash/screen_util_unittest.cc
+++ b/ash/screen_util_unittest.cc
@@ -4,9 +4,6 @@
 
 #include "ash/screen_util.h"
 
-#include "ash/common/wm/wm_screen_util.h"
-#include "ash/common/wm_lookup.h"
-#include "ash/common/wm_window.h"
 #include "ash/display/display_manager.h"
 #include "ash/shell.h"
 #include "ash/test/ash_md_test_base.h"
@@ -132,23 +129,30 @@ TEST_P(ScreenUtilTest, ShelfDisplayBoundsInUnifiedDesktop) {
 
   views::Widget* widget = views::Widget::CreateWindowWithContextAndBounds(
       NULL, CurrentContext(), gfx::Rect(10, 10, 100, 100));
-  WmWindow* window = WmLookup::Get()->GetWindowForWidget(widget);
 
   UpdateDisplay("500x400");
-  EXPECT_EQ("0,0 500x400", wm::GetDisplayBoundsWithShelf(window).ToString());
+  EXPECT_EQ("0,0 500x400",
+            ScreenUtil::GetShelfDisplayBoundsInRoot(widget->GetNativeWindow())
+                .ToString());
 
   UpdateDisplay("500x400,600x400");
-  EXPECT_EQ("0,0 500x400", wm::GetDisplayBoundsWithShelf(window).ToString());
+  EXPECT_EQ("0,0 500x400",
+            ScreenUtil::GetShelfDisplayBoundsInRoot(widget->GetNativeWindow())
+                .ToString());
 
   // Move to the 2nd physical display. Shelf's display still should be
   // the first.
   widget->SetBounds(gfx::Rect(800, 0, 100, 100));
   ASSERT_EQ("800,0 100x100", widget->GetWindowBoundsInScreen().ToString());
 
-  EXPECT_EQ("0,0 500x400", wm::GetDisplayBoundsWithShelf(window).ToString());
+  EXPECT_EQ("0,0 500x400",
+            ScreenUtil::GetShelfDisplayBoundsInRoot(widget->GetNativeWindow())
+                .ToString());
 
   UpdateDisplay("600x500");
-  EXPECT_EQ("0,0 600x500", wm::GetDisplayBoundsWithShelf(window).ToString());
+  EXPECT_EQ("0,0 600x500",
+            ScreenUtil::GetShelfDisplayBoundsInRoot(widget->GetNativeWindow())
+                .ToString());
 }
 
 }  // namespace test
diff --git a/ash/shelf/shelf_layout_manager.cc b/ash/shelf/shelf_layout_manager.cc
index 01cad5a..737785c 100644
--- a/ash/shelf/shelf_layout_manager.cc
+++ b/ash/shelf/shelf_layout_manager.cc
@@ -18,12 +18,12 @@
 #include "ash/common/wm/fullscreen_window_finder.h"
 #include "ash/common/wm/mru_window_tracker.h"
 #include "ash/common/wm/window_state.h"
-#include "ash/common/wm/wm_screen_util.h"
 #include "ash/common/wm_lookup.h"
 #include "ash/common/wm_root_window_controller.h"
 #include "ash/common/wm_root_window_controller_observer.h"
 #include "ash/common/wm_shell.h"
 #include "ash/common/wm_window.h"
+#include "ash/screen_util.h"
 #include "ash/shelf/shelf.h"
 #include "ash/shelf/shelf_bezel_event_filter.h"
 #include "ash/shelf/shelf_layout_manager_observer.h"
@@ -248,8 +248,8 @@ bool ShelfLayoutManager::IsVisible() const {
 
 gfx::Rect ShelfLayoutManager::GetIdealBounds() {
   const int shelf_size = GetShelfConstant(SHELF_SIZE);
-  WmWindow* shelf_window = WmLookup::Get()->GetWindowForWidget(shelf_widget_);
-  gfx::Rect rect(wm::GetDisplayBoundsInParent(shelf_window));
+  gfx::Rect rect(
+      ScreenUtil::GetDisplayBoundsInParent(shelf_widget_->GetNativeView()));
   return SelectValueForShelfAlignment(
       gfx::Rect(rect.x(), rect.bottom() - shelf_size, rect.width(), shelf_size),
       gfx::Rect(rect.x(), rect.y(), shelf_size, rect.height()),
@@ -733,8 +733,8 @@ void ShelfLayoutManager::UpdateBoundsAndOpacity(
     GetLayer(shelf_widget_)->SetOpacity(target_bounds.opacity);
     // mash::wm::ShelfLayout manages window bounds when running in mash.
     if (!Shell::GetInstance()->in_mus()) {
-      WmWindow* window = WmLookup::Get()->GetWindowForWidget(shelf_widget_);
-      shelf_widget_->SetBounds(window->GetParent()->ConvertRectToScreen(
+      shelf_widget_->SetBounds(ScreenUtil::ConvertRectToScreen(
+          shelf_widget_->GetNativeView()->parent(),
           target_bounds.shelf_bounds_in_root));
     }
 
@@ -755,10 +755,10 @@ void ShelfLayoutManager::UpdateBoundsAndOpacity(
     status_bounds.Offset(target_bounds.shelf_bounds_in_root.OffsetFromOrigin());
     // mash::wm::ShelfLayout manages window bounds when running mash.
     if (!Shell::GetInstance()->in_mus()) {
-      WmWindow* window = WmLookup::Get()->GetWindowForWidget(
-          shelf_widget_->status_area_widget());
       shelf_widget_->status_area_widget()->SetBounds(
-          window->GetParent()->ConvertRectToScreen(status_bounds));
+          ScreenUtil::ConvertRectToScreen(
+              shelf_widget_->status_area_widget()->GetNativeView()->parent(),
+              status_bounds));
     }
     // For crbug.com/622431, when the shelf alignment is BOTTOM_LOCKED, we
     // don't set display work area, as it is not real user-set alignment.
@@ -807,8 +807,8 @@ void ShelfLayoutManager::CalculateTargetBounds(const State& state,
     shelf_size = 0;
   }
 
-  WmWindow* shelf_window = WmLookup::Get()->GetWindowForWidget(shelf_widget_);
-  gfx::Rect available_bounds = wm::GetDisplayBoundsWithShelf(shelf_window);
+  gfx::Rect available_bounds =
+      ScreenUtil::GetShelfDisplayBoundsInRoot(root_window_);
   available_bounds.Inset(0, chromevox_panel_height_, 0, 0);
   int shelf_width = PrimaryAxisValue(available_bounds.width(), shelf_size);
   int shelf_height = PrimaryAxisValue(shelf_size, available_bounds.height());
@@ -892,17 +892,16 @@ void ShelfLayoutManager::CalculateTargetBounds(const State& state,
 
   available_bounds.Subtract(target_bounds->shelf_bounds_in_root);
   available_bounds.Subtract(keyboard_bounds_);
-
-  WmWindow* root = shelf_window->GetRootWindow();
-  user_work_area_bounds_ = root->ConvertRectToScreen(available_bounds);
+  user_work_area_bounds_ =
+      ScreenUtil::ConvertRectToScreen(root_window_, available_bounds);
 }
 
 void ShelfLayoutManager::UpdateTargetBoundsForGesture(
     TargetBounds* target_bounds) const {
   CHECK_EQ(GESTURE_DRAG_IN_PROGRESS, gesture_drag_status_);
   bool horizontal = IsHorizontalAlignment();
-  WmWindow* window = WmLookup::Get()->GetWindowForWidget(shelf_widget_);
-  gfx::Rect available_bounds = wm::GetDisplayBoundsWithShelf(window);
+  gfx::Rect available_bounds =
+      ScreenUtil::GetShelfDisplayBoundsInRoot(root_window_);
   int resistance_free_region = 0;
 
   if (gesture_drag_auto_hide_state_ == SHELF_AUTO_HIDE_HIDDEN &&
diff --git a/ash/shelf/shelf_view.cc b/ash/shelf/shelf_view.cc
index c465a90..39c00cc 100644
--- a/ash/shelf/shelf_view.cc
+++ b/ash/shelf/shelf_view.cc
@@ -7,9 +7,9 @@
 #include <algorithm>
 #include <memory>
 
+#include "ash/aura/wm_window_aura.h"
 #include "ash/common/ash_constants.h"
 #include "ash/common/ash_switches.h"
-#include "ash/common/drag_drop/drag_image_view.h"
 #include "ash/common/scoped_root_window_for_new_windows.h"
 #include "ash/common/shelf/app_list_button.h"
 #include "ash/common/shelf/overflow_bubble.h"
@@ -25,7 +25,7 @@
 #include "ash/common/wm/root_window_finder.h"
 #include "ash/common/wm_lookup.h"
 #include "ash/common/wm_shell.h"
-#include "ash/common/wm_window.h"
+#include "ash/drag_drop/drag_image_view.h"
 #include "ash/shelf/shelf.h"
 #include "ash/shelf/shelf_icon_observer.h"
 #include "ash/shelf/shelf_widget.h"
@@ -575,12 +575,9 @@ void ShelfView::CreateDragIconProxy(
     const gfx::Vector2d& cursor_offset_from_center,
     float scale_factor) {
   drag_replaced_view_ = replaced_view;
-  WmWindow* root_window =
-      WmLookup::Get()
-          ->GetWindowForWidget(drag_replaced_view_->GetWidget())
-          ->GetRootWindow();
   drag_image_.reset(new DragImageView(
-      root_window, ui::DragDropTypes::DRAG_EVENT_SOURCE_MOUSE));
+      drag_replaced_view_->GetWidget()->GetNativeWindow()->GetRootWindow(),
+      ui::DragDropTypes::DRAG_EVENT_SOURCE_MOUSE));
   drag_image_->SetImage(icon);
   gfx::Size size = drag_image_->GetPreferredSize();
   size.set_width(size.width() * scale_factor);
@@ -650,9 +647,11 @@ bool ShelfView::StartDrag(const std::string& app_id,
   // First we have to center the mouse cursor over the item.
   gfx::Point pt = drag_and_drop_view->GetBoundsInScreen().CenterPoint();
   views::View::ConvertPointFromScreen(drag_and_drop_view, &pt);
-  gfx::Point point_in_root =
-      wm::GetRootWindowAt(location_in_screen_coordinates)
-          ->ConvertPointFromScreen(location_in_screen_coordinates);
+  gfx::Point point_in_root = location_in_screen_coordinates;
+  ::wm::ConvertPointFromScreen(
+      WmWindowAura::GetAuraWindow(
+          ash::wm::GetRootWindowAt(location_in_screen_coordinates)),
+      &point_in_root);
   ui::MouseEvent event(ui::ET_MOUSE_PRESSED, pt, point_in_root,
                        ui::EventTimeForNow(), 0, 0);
   PointerPressedOnButton(drag_and_drop_view, DRAG_AND_DROP, event);
@@ -671,9 +670,11 @@ bool ShelfView::Drag(const gfx::Point& location_in_screen_coordinates) {
   views::View* drag_and_drop_view =
       view_model_->view_at(model_->ItemIndexByID(drag_and_drop_shelf_id_));
   ConvertPointFromScreen(drag_and_drop_view, &pt);
-  gfx::Point point_in_root =
-      wm::GetRootWindowAt(location_in_screen_coordinates)
-          ->ConvertPointFromScreen(location_in_screen_coordinates);
+  gfx::Point point_in_root = location_in_screen_coordinates;
+  ::wm::ConvertPointFromScreen(
+      WmWindowAura::GetAuraWindow(
+          ash::wm::GetRootWindowAt(location_in_screen_coordinates)),
+      &point_in_root);
   ui::MouseEvent event(ui::ET_MOUSE_DRAGGED, pt, point_in_root,
                        ui::EventTimeForNow(), 0, 0);
   PointerDraggedOnButton(drag_and_drop_view, DRAG_AND_DROP, event);
diff --git a/ash/shell/shell_delegate_impl.cc b/ash/shell/shell_delegate_impl.cc
index efea66b..e815146 100644
--- a/ash/shell/shell_delegate_impl.cc
+++ b/ash/shell/shell_delegate_impl.cc
@@ -10,7 +10,6 @@
 #include "ash/common/gpu_support_stub.h"
 #include "ash/common/media_delegate.h"
 #include "ash/common/new_window_delegate.h"
-#include "ash/common/palette_delegate.h"
 #include "ash/common/session/session_state_delegate.h"
 #include "ash/common/shell_window_ids.h"
 #include "ash/common/system/tray/default_system_tray_delegate.h"
@@ -80,15 +79,6 @@ class MediaDelegateImpl : public MediaDelegate {
   DISALLOW_COPY_AND_ASSIGN(MediaDelegateImpl);
 };
 
-class PaletteDelegateImpl : public PaletteDelegate {
- public:
-  PaletteDelegateImpl() {};
-  ~PaletteDelegateImpl() override {};
-
- private:
-  DISALLOW_COPY_AND_ASSIGN(PaletteDelegateImpl);
-};
-
 class SessionStateDelegateImpl : public SessionStateDelegate {
  public:
   SessionStateDelegateImpl()
@@ -253,10 +243,6 @@ ash::MediaDelegate* ShellDelegateImpl::CreateMediaDelegate() {
   return new MediaDelegateImpl;
 }
 
-std::unique_ptr<PaletteDelegate> ShellDelegateImpl::CreatePaletteDelegate() {
-  return base::WrapUnique(new PaletteDelegateImpl());
-}
-
 std::unique_ptr<ash::PointerWatcherDelegate>
 ShellDelegateImpl::CreatePointerWatcherDelegate() {
   return base::WrapUnique(new PointerWatcherDelegateAura);
diff --git a/ash/shell/shell_delegate_impl.h b/ash/shell/shell_delegate_impl.h
index 0e2c11f..3938713 100644
--- a/ash/shell/shell_delegate_impl.h
+++ b/ash/shell/shell_delegate_impl.h
@@ -49,7 +49,6 @@ class ShellDelegateImpl : public ShellDelegate {
   AccessibilityDelegate* CreateAccessibilityDelegate() override;
   NewWindowDelegate* CreateNewWindowDelegate() override;
   MediaDelegate* CreateMediaDelegate() override;
-  std::unique_ptr<PaletteDelegate> CreatePaletteDelegate() override;
   std::unique_ptr<PointerWatcherDelegate> CreatePointerWatcherDelegate()
       override;
   ui::MenuModel* CreateContextMenu(WmShelf* wm_shelf,
diff --git a/ash/system/toast/toast_manager_unittest.cc b/ash/system/toast/toast_manager_unittest.cc
index dd0482d..7c79707 100644
--- a/ash/system/toast/toast_manager_unittest.cc
+++ b/ash/system/toast/toast_manager_unittest.cc
@@ -5,7 +5,6 @@
 #include "ash/common/shelf/shelf_constants.h"
 #include "ash/common/shelf/wm_shelf.h"
 #include "ash/common/system/toast/toast_manager.h"
-#include "ash/common/wm/wm_screen_util.h"
 #include "ash/common/wm_shell.h"
 #include "ash/display/display_manager.h"
 #include "ash/screen_util.h"
@@ -162,7 +161,8 @@ TEST_F(ToastManagerTest, PositionWithVisibleBottomShelf) {
   EXPECT_EQ(1, GetToastSerial());
 
   gfx::Rect toast_bounds = GetCurrentWidget()->GetWindowBoundsInScreen();
-  gfx::Rect root_bounds = wm::GetDisplayBoundsWithShelf(shelf->GetWindow());
+  gfx::Rect root_bounds =
+      ScreenUtil::GetShelfDisplayBoundsInRoot(Shell::GetPrimaryRootWindow());
 
   EXPECT_TRUE(toast_bounds.Intersects(shelf->GetUserWorkAreaBounds()));
   EXPECT_NEAR(root_bounds.CenterPoint().x(), toast_bounds.CenterPoint().x(), 1);
@@ -191,7 +191,8 @@ TEST_F(ToastManagerTest, PositionWithAutoHiddenBottomShelf) {
   EXPECT_EQ(1, GetToastSerial());
 
   gfx::Rect toast_bounds = GetCurrentWidget()->GetWindowBoundsInScreen();
-  gfx::Rect root_bounds = wm::GetDisplayBoundsWithShelf(shelf->GetWindow());
+  gfx::Rect root_bounds =
+      ScreenUtil::GetShelfDisplayBoundsInRoot(Shell::GetPrimaryRootWindow());
 
   EXPECT_TRUE(toast_bounds.Intersects(shelf->GetUserWorkAreaBounds()));
   EXPECT_NEAR(root_bounds.CenterPoint().x(), toast_bounds.CenterPoint().x(), 1);
@@ -209,7 +210,8 @@ TEST_F(ToastManagerTest, PositionWithHiddenBottomShelf) {
   EXPECT_EQ(1, GetToastSerial());
 
   gfx::Rect toast_bounds = GetCurrentWidget()->GetWindowBoundsInScreen();
-  gfx::Rect root_bounds = wm::GetDisplayBoundsWithShelf(shelf->GetWindow());
+  gfx::Rect root_bounds =
+      ScreenUtil::GetShelfDisplayBoundsInRoot(Shell::GetPrimaryRootWindow());
 
   EXPECT_TRUE(toast_bounds.Intersects(shelf->GetUserWorkAreaBounds()));
   EXPECT_NEAR(root_bounds.CenterPoint().x(), toast_bounds.CenterPoint().x(), 1);
@@ -226,7 +228,8 @@ TEST_F(ToastManagerTest, PositionWithVisibleLeftShelf) {
 
   gfx::Rect toast_bounds = GetCurrentWidget()->GetWindowBoundsInScreen();
   gfx::RectF precise_toast_bounds(toast_bounds);
-  gfx::Rect root_bounds = wm::GetDisplayBoundsWithShelf(shelf->GetWindow());
+  gfx::Rect root_bounds =
+      ScreenUtil::GetShelfDisplayBoundsInRoot(Shell::GetPrimaryRootWindow());
 
   EXPECT_TRUE(toast_bounds.Intersects(shelf->GetUserWorkAreaBounds()));
   EXPECT_EQ(root_bounds.bottom() - 5, toast_bounds.bottom());
@@ -258,7 +261,8 @@ TEST_F(ToastManagerTest, PositionWithUnifiedDesktop) {
   EXPECT_EQ(1, GetToastSerial());
 
   gfx::Rect toast_bounds = GetCurrentWidget()->GetWindowBoundsInScreen();
-  gfx::Rect root_bounds = wm::GetDisplayBoundsWithShelf(shelf->GetWindow());
+  gfx::Rect root_bounds =
+      ScreenUtil::GetShelfDisplayBoundsInRoot(Shell::GetPrimaryRootWindow());
 
   EXPECT_TRUE(toast_bounds.Intersects(shelf->GetUserWorkAreaBounds()));
   EXPECT_TRUE(root_bounds.Contains(toast_bounds));
diff --git a/ash/sysui/shell_delegate_mus.cc b/ash/sysui/shell_delegate_mus.cc
index 68a99c7..2f36b2f 100644
--- a/ash/sysui/shell_delegate_mus.cc
+++ b/ash/sysui/shell_delegate_mus.cc
@@ -7,7 +7,6 @@
 #include "ash/common/default_accessibility_delegate.h"
 #include "ash/common/gpu_support_stub.h"
 #include "ash/common/media_delegate.h"
-#include "ash/common/palette_delegate.h"
 #include "ash/common/session/session_state_delegate.h"
 #include "ash/common/system/tray/default_system_tray_delegate.h"
 #include "ash/sysui/app_list_presenter_mus.h"
@@ -196,11 +195,6 @@ MediaDelegate* ShellDelegateMus::CreateMediaDelegate() {
   return new MediaDelegateStub;
 }
 
-std::unique_ptr<PaletteDelegate> ShellDelegateMus::CreatePaletteDelegate() {
-  NOTIMPLEMENTED();
-  return nullptr;
-}
-
 std::unique_ptr<PointerWatcherDelegate>
 ShellDelegateMus::CreatePointerWatcherDelegate() {
   return base::WrapUnique(new PointerWatcherDelegateMus);
diff --git a/ash/sysui/shell_delegate_mus.h b/ash/sysui/shell_delegate_mus.h
index 670769b..9960343 100644
--- a/ash/sysui/shell_delegate_mus.h
+++ b/ash/sysui/shell_delegate_mus.h
@@ -44,7 +44,6 @@ class ShellDelegateMus : public ShellDelegate {
   AccessibilityDelegate* CreateAccessibilityDelegate() override;
   NewWindowDelegate* CreateNewWindowDelegate() override;
   MediaDelegate* CreateMediaDelegate() override;
-  std::unique_ptr<PaletteDelegate> CreatePaletteDelegate() override;
   std::unique_ptr<PointerWatcherDelegate> CreatePointerWatcherDelegate()
       override;
   ui::MenuModel* CreateContextMenu(WmShelf* wm_shelf,
diff --git a/ash/test/display_manager_test_api.cc b/ash/test/display_manager_test_api.cc
index a06ddd2..b43e61a 100644
--- a/ash/test/display_manager_test_api.cc
+++ b/ash/test/display_manager_test_api.cc
@@ -155,9 +155,8 @@ ScopedSetInternalDisplayId::~ScopedSetInternalDisplayId() {
 bool SetDisplayResolution(int64_t display_id, const gfx::Size& resolution) {
   DisplayManager* display_manager = Shell::GetInstance()->display_manager();
   const DisplayInfo& info = display_manager->GetDisplayInfo(display_id);
-  scoped_refptr<DisplayMode> mode =
-      GetDisplayModeForResolution(info, resolution);
-  if (!mode)
+  DisplayMode mode;
+  if (!GetDisplayModeForResolution(info, resolution, &mode))
     return false;
   return display_manager->SetDisplayMode(display_id, mode);
 }
diff --git a/ash/test/test_shell_delegate.cc b/ash/test/test_shell_delegate.cc
index 28412c9..64e87b4 100644
--- a/ash/test/test_shell_delegate.cc
+++ b/ash/test/test_shell_delegate.cc
@@ -12,7 +12,6 @@
 #include "ash/common/gpu_support_stub.h"
 #include "ash/common/media_delegate.h"
 #include "ash/common/new_window_delegate.h"
-#include "ash/common/palette_delegate.h"
 #include "ash/common/session/session_state_delegate.h"
 #include "ash/common/shell_window_ids.h"
 #include "ash/common/wm/window_state.h"
@@ -187,10 +186,6 @@ MediaDelegate* TestShellDelegate::CreateMediaDelegate() {
   return new MediaDelegateImpl;
 }
 
-std::unique_ptr<PaletteDelegate> TestShellDelegate::CreatePaletteDelegate() {
-  return nullptr;
-}
-
 std::unique_ptr<PointerWatcherDelegate>
 TestShellDelegate::CreatePointerWatcherDelegate() {
   return base::WrapUnique(new PointerWatcherDelegateAura);
diff --git a/ash/test/test_shell_delegate.h b/ash/test/test_shell_delegate.h
index f3d7afb..09676b9 100644
--- a/ash/test/test_shell_delegate.h
+++ b/ash/test/test_shell_delegate.h
@@ -54,7 +54,6 @@ class TestShellDelegate : public ShellDelegate {
   AccessibilityDelegate* CreateAccessibilityDelegate() override;
   NewWindowDelegate* CreateNewWindowDelegate() override;
   MediaDelegate* CreateMediaDelegate() override;
-  std::unique_ptr<PaletteDelegate> CreatePaletteDelegate() override;
   std::unique_ptr<PointerWatcherDelegate> CreatePointerWatcherDelegate()
       override;
   ui::MenuModel* CreateContextMenu(WmShelf* wm_shelf,
diff --git a/ash/touch/touch_transformer_controller_unittest.cc b/ash/touch/touch_transformer_controller_unittest.cc
index befc514..0d19e03 100644
--- a/ash/touch/touch_transformer_controller_unittest.cc
+++ b/ash/touch/touch_transformer_controller_unittest.cc
@@ -21,8 +21,8 @@ DisplayInfo CreateDisplayInfo(int64_t id,
   info.AddInputDevice(touch_device_id);
 
   // Create a default mode.
-  DisplayInfo::DisplayModeList default_modes(
-      1, make_scoped_refptr(new DisplayMode(bounds.size(), 60, false, true)));
+  std::vector<DisplayMode> default_modes(
+      1, DisplayMode(bounds.size(), 60, false, true));
   info.SetDisplayModes(default_modes);
 
   return info;
@@ -45,13 +45,10 @@ TEST_F(TouchTransformerControllerTest, MirrorModeLetterboxing) {
   DisplayInfo internal_display_info =
       CreateDisplayInfo(1, 10u, gfx::Rect(0, 0, 1920, 1200));
   internal_display_info.set_is_aspect_preserving_scaling(true);
-
-  DisplayInfo::DisplayModeList internal_modes;
-
-  internal_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(2560, 1700), 60, false, true)));
-  internal_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(1920, 1200), 60, false, false)));
+  std::vector<DisplayMode> internal_modes;
+  internal_modes.push_back(DisplayMode(gfx::Size(2560, 1700), 60, false, true));
+  internal_modes.push_back(
+      DisplayMode(gfx::Size(1920, 1200), 60, false, false));
   internal_display_info.SetDisplayModes(internal_modes);
 
   DisplayInfo external_display_info =
@@ -118,11 +115,9 @@ TEST_F(TouchTransformerControllerTest, MirrorModePillarboxing) {
   DisplayInfo internal_display_info =
       CreateDisplayInfo(1, 10, gfx::Rect(0, 0, 1024, 768));
   internal_display_info.set_is_aspect_preserving_scaling(true);
-  DisplayInfo::DisplayModeList internal_modes;
-  internal_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(1366, 768), 60, false, true)));
-  internal_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(1024, 768), 60, false, false)));
+  std::vector<DisplayMode> internal_modes;
+  internal_modes.push_back(DisplayMode(gfx::Size(1366, 768), 60, false, true));
+  internal_modes.push_back(DisplayMode(gfx::Size(1024, 768), 60, false, false));
   internal_display_info.SetDisplayModes(internal_modes);
 
   DisplayInfo external_display_info =
@@ -192,16 +187,14 @@ TEST_F(TouchTransformerControllerTest, SoftwareMirrorMode) {
   // translated to point (0, 950) in the framebuffer.
   DisplayInfo display1_info =
       CreateDisplayInfo(1, 10u, gfx::Rect(0, 0, 1280, 850));
-  DisplayInfo::DisplayModeList display1_modes;
-  display1_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(1280, 850), 60, false, true)));
+  std::vector<DisplayMode> display1_modes;
+  display1_modes.push_back(DisplayMode(gfx::Size(1280, 850), 60, false, true));
   display1_info.SetDisplayModes(display1_modes);
 
   DisplayInfo display2_info =
       CreateDisplayInfo(2, 11u, gfx::Rect(0, 950, 1920, 1080));
-  DisplayInfo::DisplayModeList display2_modes;
-  display2_modes.push_back(make_scoped_refptr(
-      new DisplayMode(gfx::Size(1920, 1080), 60, false, true)));
+  std::vector<DisplayMode> display2_modes;
+  display2_modes.push_back(DisplayMode(gfx::Size(1920, 1080), 60, false, true));
   display2_info.SetDisplayModes(display2_modes);
 
   gfx::Size fb_size(1920, 1990);
diff --git a/ash/touch/touch_uma.cc b/ash/touch/touch_uma.cc
index 45cbf48..2eb8559 100644
--- a/ash/touch/touch_uma.cc
+++ b/ash/touch/touch_uma.cc
@@ -14,7 +14,6 @@
 #include "ui/events/event.h"
 #include "ui/events/event_utils.h"
 #include "ui/gfx/geometry/point_conversions.h"
-#include "ui/views/widget/widget.h"
 
 #if defined(USE_X11)
 #include <X11/extensions/XInput2.h>
@@ -221,7 +220,7 @@ void TouchUMA::UpdateTouchState(const ui::TouchEvent& event) {
   }
 }
 
-GestureActionType TouchUMA::FindGestureActionType(
+TouchUMA::GestureActionType TouchUMA::FindGestureActionType(
     aura::Window* window,
     const ui::GestureEvent& event) {
   if (!window || window->GetRootWindow() == window) {
diff --git a/ash/touch/touch_uma.h b/ash/touch/touch_uma.h
index fb9a5fc..86f91e4 100644
--- a/ash/touch/touch_uma.h
+++ b/ash/touch/touch_uma.h
@@ -5,30 +5,52 @@
 #ifndef ASH_TOUCH_TOUCH_OBSERVER_UMA_H_
 #define ASH_TOUCH_TOUCH_OBSERVER_UMA_H_
 
-#include "ash/ash_export.h"
-#include "ash/common/metrics/gesture_action_type.h"
+#include <map>
+
+#include "ash/shell.h"
 #include "base/macros.h"
 #include "base/memory/singleton.h"
+#include "ui/gfx/geometry/point.h"
+#include "ui/views/widget/widget.h"
 
 namespace aura {
 class Window;
 }
 
-namespace ui {
-class GestureEvent;
-class TouchEvent;
-}
-
-namespace gfx {
-class Point;
-}
-
 namespace ash {
 
 // Records some touch/gesture event specific details (e.g. what gestures are
 // targetted to which components etc.)
 class ASH_EXPORT TouchUMA {
  public:
+  enum GestureActionType {
+    GESTURE_UNKNOWN,
+    GESTURE_OMNIBOX_PINCH,
+    GESTURE_OMNIBOX_SCROLL,
+    GESTURE_TABSTRIP_PINCH,
+    GESTURE_TABSTRIP_SCROLL,
+    GESTURE_BEZEL_SCROLL,
+    GESTURE_DESKTOP_SCROLL,
+    GESTURE_DESKTOP_PINCH,
+    GESTURE_WEBPAGE_PINCH,
+    GESTURE_WEBPAGE_SCROLL,
+    GESTURE_WEBPAGE_TAP,
+    GESTURE_TABSTRIP_TAP,
+    GESTURE_BEZEL_DOWN,
+    GESTURE_TABSWITCH_TAP,
+    GESTURE_TABNOSWITCH_TAP,
+    GESTURE_TABCLOSE_TAP,
+    GESTURE_NEWTAB_TAP,
+    GESTURE_ROOTVIEWTOP_TAP,
+    GESTURE_FRAMEMAXIMIZE_TAP,
+    GESTURE_FRAMEVIEW_TAP,
+    GESTURE_MAXIMIZE_DOUBLETAP,
+    // NOTE: Add new action types only immediately above this line. Also,
+    // make sure the enum list in tools/histogram/histograms.xml is
+    // updated with any change in here.
+    GESTURE_ACTION_COUNT
+  };
+
   // Returns the singleton instance.
   static TouchUMA* GetInstance();
 
diff --git a/ash/touch/touchscreen_util_unittest.cc b/ash/touch/touchscreen_util_unittest.cc
index 9b68544..adfc236 100644
--- a/ash/touch/touchscreen_util_unittest.cc
+++ b/ash/touch/touchscreen_util_unittest.cc
@@ -26,22 +26,18 @@ class TouchscreenUtilTest : public test::AshTestBase {
     // with matching size.
     {
       DisplayInfo display(1, "1", false);
-      scoped_refptr<DisplayMode> mode(
-          new DisplayMode(gfx::Size(1920, 1080), 60.0, false /* interlaced */,
-                          true /* native */, 1.0 /* ui_scale */,
-                          1.0 /* device_scale_factor */));
-      DisplayInfo::DisplayModeList modes(1, mode);
+      DisplayMode mode(gfx::Size(1920, 1080), 60.0, false, true);
+      mode.native = true;
+      std::vector<DisplayMode> modes(1, mode);
       display.SetDisplayModes(modes);
       displays_.push_back(display);
     }
 
     {
       DisplayInfo display(2, "2", false);
-
-      scoped_refptr<DisplayMode> mode(new DisplayMode(
-          gfx::Size(800, 600), 60.0, false /* interlaced */, true /* native */,
-          1.0 /* ui_scale */, 1.0 /* device_scale_factor */));
-      DisplayInfo::DisplayModeList modes(1, mode);
+      DisplayMode mode(gfx::Size(800, 600), 60.0, false, true);
+      mode.native = true;
+      std::vector<DisplayMode> modes(1, mode);
       display.SetDisplayModes(modes);
       displays_.push_back(display);
     }
@@ -54,12 +50,9 @@ class TouchscreenUtilTest : public test::AshTestBase {
 
     {
       DisplayInfo display(4, "4", false);
-
-      scoped_refptr<DisplayMode> mode(
-          new DisplayMode(gfx::Size(1024, 768), 60.0, false /* interlaced */,
-                          /* native */ true, 1.0 /* ui_scale */,
-                          1.0 /* device_scale_factor */));
-      DisplayInfo::DisplayModeList modes(1, mode);
+      DisplayMode mode(gfx::Size(1024, 768), 60.0, false, true);
+      mode.native = true;
+      std::vector<DisplayMode> modes(1, mode);
       display.SetDisplayModes(modes);
       displays_.push_back(display);
     }
diff --git a/ash/wm/lock_window_state.cc b/ash/wm/lock_window_state.cc
index 59a6490..4e1254f 100644
--- a/ash/wm/lock_window_state.cc
+++ b/ash/wm/lock_window_state.cc
@@ -12,9 +12,8 @@
 #include "ash/common/wm/window_state_delegate.h"
 #include "ash/common/wm/window_state_util.h"
 #include "ash/common/wm/wm_event.h"
-#include "ash/common/wm/wm_screen_util.h"
-#include "ash/common/wm_shell.h"
 #include "ash/display/display_manager.h"
+#include "ash/screen_util.h"
 #include "ash/shell.h"
 #include "ash/wm/lock_layout_manager.h"
 #include "ash/wm/window_animations.h"
@@ -169,9 +168,14 @@ wm::WindowStateType LockWindowState::GetMaximizedOrCenteredWindowType(
 }
 
 gfx::Rect GetBoundsForLockWindow(aura::Window* window) {
-  if (WmShell::Get()->IsInUnifiedMode())
-    return WmShell::Get()->GetFirstDisplay().bounds();
-  return wm::GetDisplayBoundsInParent(WmWindowAura::Get(window));
+  DisplayManager* display_manager = Shell::GetInstance()->display_manager();
+  if (display_manager->IsInUnifiedMode()) {
+    const display::Display& first =
+        display_manager->software_mirroring_display_list()[0];
+    return first.bounds();
+  } else {
+    return ScreenUtil::GetDisplayBoundsInParent(window);
+  }
 }
 
 void LockWindowState::UpdateBounds(wm::WindowState* window_state) {
@@ -186,7 +190,9 @@ void LockWindowState::UpdateBounds(wm::WindowState* window_state) {
       keyboard_controller->keyboard_visible()) {
     keyboard_bounds = keyboard_controller->current_keyboard_bounds();
   }
-  gfx::Rect bounds = wm::GetDisplayBoundsWithShelf(window_state->window());
+  gfx::Rect bounds = ScreenUtil::GetShelfDisplayBoundsInRoot(
+      ash::WmWindowAura::GetAuraWindow(window_state->window()));
+
   bounds.set_height(bounds.height() - keyboard_bounds.height());
 
   VLOG(1) << "Updating window bounds to: " << bounds.ToString();
diff --git a/ash/wm/panels/panel_frame_view.cc b/ash/wm/panels/panel_frame_view.cc
index c06548e..129d901 100644
--- a/ash/wm/panels/panel_frame_view.cc
+++ b/ash/wm/panels/panel_frame_view.cc
@@ -4,11 +4,10 @@
 
 #include "ash/wm/panels/panel_frame_view.h"
 
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-#include "ash/common/frame/default_header_painter.h"
-#include "ash/common/frame/frame_border_hit_test.h"
 #include "ash/common/material_design/material_design_controller.h"
 #include "ash/common/wm_shell.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
+#include "ash/frame/default_header_painter.h"
 #include "ash/frame/frame_border_hit_test_controller.h"
 #include "ui/aura/client/aura_constants.h"
 #include "ui/aura/window.h"
@@ -127,7 +126,8 @@ gfx::Rect PanelFrameView::GetWindowBoundsForClientBounds(
 int PanelFrameView::NonClientHitTest(const gfx::Point& point) {
   if (!header_painter_)
     return HTNOWHERE;
-  return FrameBorderNonClientHitTest(this, caption_button_container_, point);
+  return FrameBorderHitTestController::NonClientHitTest(
+      this, caption_button_container_, point);
 }
 
 void PanelFrameView::OnPaint(gfx::Canvas* canvas) {
diff --git a/ash/wm/power_button_controller.cc b/ash/wm/power_button_controller.cc
index b4c5916..73c686a 100644
--- a/ash/wm/power_button_controller.cc
+++ b/ash/wm/power_button_controller.cc
@@ -8,8 +8,6 @@
 #include "ash/common/ash_switches.h"
 #include "ash/common/session/session_state_delegate.h"
 #include "ash/common/shell_window_ids.h"
-#include "ash/common/system/audio/tray_audio.h"
-#include "ash/common/system/tray/system_tray.h"
 #include "ash/common/wm/maximize_mode/maximize_mode_controller.h"
 #include "ash/common/wm_shell.h"
 #include "ash/shell.h"
@@ -22,7 +20,6 @@
 #include "ui/wm/core/compound_event_filter.h"
 
 #if defined(OS_CHROMEOS)
-#include "chromeos/audio/cras_audio_handler.h"
 #include "chromeos/dbus/dbus_thread_manager.h"
 #endif
 
@@ -32,9 +29,6 @@ PowerButtonController::PowerButtonController(LockStateController* controller)
     : power_button_down_(false),
       lock_button_down_(false),
       volume_down_pressed_(false),
-#if defined(OS_CHROMEOS)
-      volume_percent_before_screenshot_(0),
-#endif
       brightness_is_zero_(false),
       internal_display_off_and_external_display_on_(false),
       has_legacy_power_button_(
@@ -86,21 +80,8 @@ void PowerButtonController::OnPowerButtonEvent(
       WmShell::Get()
           ->maximize_mode_controller()
           ->IsMaximizeModeWindowManagerEnabled()) {
-    SystemTray* system_tray = Shell::GetInstance()->GetPrimarySystemTray();
-    if (system_tray && system_tray->GetTrayAudio())
-      system_tray->GetTrayAudio()->HideDetailedView(false);
-
     WmShell::Get()->accelerator_controller()->PerformActionIfEnabled(
         TAKE_SCREENSHOT);
-
-#if defined(OS_CHROMEOS)
-    // Restore volume.
-    chromeos::CrasAudioHandler* audio_handler =
-        chromeos::CrasAudioHandler::Get();
-    audio_handler->SetOutputVolumePercentWithoutNotifyingObservers(
-        volume_percent_before_screenshot_,
-        chromeos::CrasAudioHandler::VOLUME_CHANGE_MAXIMIZE_MODE_SCREENSHOT);
-#endif
     return;
   }
 
@@ -170,17 +151,8 @@ void PowerButtonController::OnLockButtonEvent(
 }
 
 void PowerButtonController::OnKeyEvent(ui::KeyEvent* event) {
-  if (event->key_code() == ui::VKEY_VOLUME_DOWN) {
+  if (event->key_code() == ui::VKEY_VOLUME_DOWN)
     volume_down_pressed_ = event->type() == ui::ET_KEY_PRESSED;
-#if defined(OS_CHROMEOS)
-    if (!event->is_repeat()) {
-      chromeos::CrasAudioHandler* audio_handler =
-          chromeos::CrasAudioHandler::Get();
-      volume_percent_before_screenshot_ =
-          audio_handler->GetOutputVolumePercent();
-    }
-#endif
-  }
 }
 
 #if defined(OS_CHROMEOS)
diff --git a/ash/wm/power_button_controller.h b/ash/wm/power_button_controller.h
index 7043966..970ddab 100644
--- a/ash/wm/power_button_controller.h
+++ b/ash/wm/power_button_controller.h
@@ -87,12 +87,6 @@ class ASH_EXPORT PowerButtonController
   // True when the volume down button is being held down.
   bool volume_down_pressed_;
 
-#if defined(OS_CHROMEOS)
-  // Volume to be restored after a screenshot is taken by pressing the power
-  // button while holding VKEY_VOLUME_DOWN.
-  int volume_percent_before_screenshot_;
-#endif
-
   // Has the screen brightness been reduced to 0%?
   bool brightness_is_zero_;
 
diff --git a/ash/wm/workspace/workspace_event_handler.cc b/ash/wm/workspace/workspace_event_handler.cc
index c982867..33d3302 100644
--- a/ash/wm/workspace/workspace_event_handler.cc
+++ b/ash/wm/workspace/workspace_event_handler.cc
@@ -9,11 +9,11 @@
 #include "ash/common/wm/wm_event.h"
 #include "ash/common/wm_shell.h"
 #include "ash/common/wm_window.h"
+#include "ash/touch/touch_uma.h"
 #include "ash/wm/window_state_aura.h"
 #include "ui/aura/window.h"
 #include "ui/aura/window_delegate.h"
 #include "ui/base/hit_test.h"
-#include "ui/events/event.h"
 
 namespace ash {
 
@@ -87,14 +87,16 @@ void WorkspaceEventHandler::OnGestureEvent(ui::GestureEvent* event) {
     return;
 
   if (event->details().tap_count() != 2) {
-    WmShell::Get()->RecordGestureAction(GESTURE_FRAMEVIEW_TAP);
+    TouchUMA::GetInstance()->RecordGestureAction(
+        TouchUMA::GESTURE_FRAMEVIEW_TAP);
     return;
   }
 
   if (click_component_ == previous_target_component) {
     WmShell::Get()->RecordUserMetricsAction(
         UMA_TOGGLE_MAXIMIZE_CAPTION_GESTURE);
-    WmShell::Get()->RecordGestureAction(GESTURE_MAXIMIZE_DOUBLETAP);
+    TouchUMA::GetInstance()->RecordGestureAction(
+        TouchUMA::GESTURE_MAXIMIZE_DOUBLETAP);
     const wm::WMEvent wm_event(wm::WM_EVENT_TOGGLE_MAXIMIZE_CAPTION);
     wm::GetWindowState(target)->OnWMEvent(&wm_event);
     event->StopPropagation();
diff --git a/base/android/base_proguard_config.flags b/base/android/base_proguard_config.flags
index 6ff4351..2926ee1 100644
--- a/base/android/base_proguard_config.flags
+++ b/base/android/base_proguard_config.flags
@@ -1,9 +1,8 @@
 # Keep line number information, useful for stack traces.
 -keepattributes SourceFile,LineNumberTable
 
-# Keep all annotation related attributes that can affect runtime
--keepattributes RuntimeVisible*Annotations
--keepattributes AnnotationDefault
+# Keep all runtime visible annotations
+-keepattributes RuntimeVisibleAnnotations
 
 # Keep the annotations, because if we don't, the ProGuard rules that use them
 # will not be respected. These classes then show up in our final dex, which we
diff --git a/base/task_scheduler/scheduler_worker_pool_impl.cc b/base/task_scheduler/scheduler_worker_pool_impl.cc
index daf19ce..39a5e2e 100644
--- a/base/task_scheduler/scheduler_worker_pool_impl.cc
+++ b/base/task_scheduler/scheduler_worker_pool_impl.cc
@@ -433,7 +433,7 @@ void SchedulerWorkerPoolImpl::SchedulerWorkerDelegateImpl::OnMainEntry(
 #endif
 
   PlatformThread::SetName(
-      StringPrintf("TaskScheduler%sWorker%d", outer_->name_.c_str(), index_));
+      StringPrintf("%sWorker%d", outer_->name_.c_str(), index_));
 
   DCHECK(!tls_current_worker.Get().Get());
   DCHECK(!tls_current_worker_pool.Get().Get());
diff --git a/base/task_scheduler/scheduler_worker_pool_params.h b/base/task_scheduler/scheduler_worker_pool_params.h
index bba7855..a084166 100644
--- a/base/task_scheduler/scheduler_worker_pool_params.h
+++ b/base/task_scheduler/scheduler_worker_pool_params.h
@@ -21,15 +21,14 @@ class BASE_EXPORT SchedulerWorkerPoolParams final {
     DISALLOWED,
   };
 
-  // Construct a scheduler worker pool parameter object. |name| will be used to
-  // label the pool's threads ("TaskScheduler" + |name| + index) and histograms
-  // ("TaskScheduler." + histogram name + "." + |name| + extra suffixes). The
-  // pool will contain up to |max_threads|. |priority_hint| is the preferred
-  // thread priority; the actual thread priority depends on shutdown state and
-  // platform capabilities. |io_restriction| indicates whether Tasks on the pool
-  // are allowed to make I/O calls. |suggested_reclaim_time| sets a suggestion
-  // on when to reclaim idle threads. The pool is free to ignore this value for
-  // performance or correctness reasons.
+  // Construct a scheduler worker pool parameter object that instructs a
+  // scheduler worker pool to use the label |name| and create up to
+  // |max_threads| threads. |priority_hint| is the preferred thread priority;
+  // the actual thread priority depends on shutdown state and platform
+  // capabilities. |io_restriction| indicates whether Tasks on the scheduler
+  // worker pool are allowed to make I/O calls. |suggested_reclaim_time| sets a
+  // suggestion on when to reclaim idle threads. The worker pool is free to
+  // ignore this value for performance or correctness reasons.
   SchedulerWorkerPoolParams(const std::string& name,
                             ThreadPriority priority_hint,
                             IORestriction io_restriction,
@@ -38,10 +37,19 @@ class BASE_EXPORT SchedulerWorkerPoolParams final {
   SchedulerWorkerPoolParams(SchedulerWorkerPoolParams&& other);
   SchedulerWorkerPoolParams& operator=(SchedulerWorkerPoolParams&& other);
 
+  // Name of the pool. Used to label the pool's threads.
   const std::string& name() const { return name_; }
+
+  // Preferred priority for the pool's threads.
   ThreadPriority priority_hint() const { return priority_hint_; }
+
+  // Whether I/O is allowed in the pool.
   IORestriction io_restriction() const { return io_restriction_; }
+
+  // Maximum number of threads in the pool.
   size_t max_threads() const { return max_threads_; }
+
+  // Suggested reclaim time for threads in the worker pool.
   const TimeDelta& suggested_reclaim_time() const {
     return suggested_reclaim_time_;
   }
diff --git a/base/task_scheduler/task_scheduler_impl_unittest.cc b/base/task_scheduler/task_scheduler_impl_unittest.cc
index 21a18b0..fe5a98f 100644
--- a/base/task_scheduler/task_scheduler_impl_unittest.cc
+++ b/base/task_scheduler/task_scheduler_impl_unittest.cc
@@ -171,20 +171,24 @@ class TaskSchedulerImplTest
     std::vector<SchedulerWorkerPoolParams> params_vector;
 
     ASSERT_EQ(BACKGROUND_WORKER_POOL, params_vector.size());
-    params_vector.emplace_back("Background", ThreadPriority::BACKGROUND,
+    params_vector.emplace_back("TaskSchedulerBackground",
+                               ThreadPriority::BACKGROUND,
                                IORestriction::DISALLOWED, 1U, TimeDelta::Max());
 
     ASSERT_EQ(BACKGROUND_FILE_IO_WORKER_POOL, params_vector.size());
-    params_vector.emplace_back("BackgroundFileIO", ThreadPriority::BACKGROUND,
+    params_vector.emplace_back("TaskSchedulerBackgroundFileIO",
+                               ThreadPriority::BACKGROUND,
                                IORestriction::ALLOWED, 3U, TimeDelta::Max());
 
     ASSERT_EQ(FOREGROUND_WORKER_POOL, params_vector.size());
-    params_vector.emplace_back("Foreground", ThreadPriority::NORMAL,
+    params_vector.emplace_back("TaskSchedulerForeground",
+                               ThreadPriority::NORMAL,
                                IORestriction::DISALLOWED, 4U, TimeDelta::Max());
 
     ASSERT_EQ(FOREGROUND_FILE_IO_WORKER_POOL, params_vector.size());
-    params_vector.emplace_back("ForegroundFileIO", ThreadPriority::NORMAL,
-                               IORestriction::ALLOWED, 12U, TimeDelta::Max());
+    params_vector.emplace_back("TaskSchedulerForegroundFileIO",
+                               ThreadPriority::NORMAL, IORestriction::ALLOWED,
+                               12U, TimeDelta::Max());
 
     scheduler_ = TaskSchedulerImpl::Create(params_vector,
                                            Bind(&GetThreadPoolIndexForTraits));
diff --git a/base/threading/platform_thread_mac.mm b/base/threading/platform_thread_mac.mm
index 4db5a36..e743044 100644
--- a/base/threading/platform_thread_mac.mm
+++ b/base/threading/platform_thread_mac.mm
@@ -205,9 +205,10 @@ ThreadPriority PlatformThread::GetCurrentThreadPriority() {
     case ThreadPriority::DISPLAY:
     case ThreadPriority::REALTIME_AUDIO:
       return thread_priority;
+    default:
+      NOTREACHED() << "Unknown priority.";
+      return ThreadPriority::NORMAL;
   }
-  NOTREACHED() << "Unknown priority.";
-  return ThreadPriority::NORMAL;
 }
 
 size_t GetDefaultThreadStackSize(const pthread_attr_t& attributes) {
diff --git a/base/threading/platform_thread_unittest.cc b/base/threading/platform_thread_unittest.cc
index 121ac6a..0febf8b 100644
--- a/base/threading/platform_thread_unittest.cc
+++ b/base/threading/platform_thread_unittest.cc
@@ -260,9 +260,9 @@ class ThreadPriorityTestThread : public FunctionTestThread {
 // Test changing a created thread's priority (which has different semantics on
 // some platforms).
 TEST(PlatformThreadTest, ThreadPriorityCurrentThread) {
-  const bool increased_priority_allowed =
+  const bool increase_priority_allowed =
       PlatformThread::CanIncreaseCurrentThreadPriority();
-  if (increased_priority_allowed) {
+  if (increase_priority_allowed) {
     // Bump the priority in order to verify that new threads are started with
     // normal priority.
     PlatformThread::SetCurrentThreadPriority(ThreadPriority::DISPLAY);
@@ -270,7 +270,7 @@ TEST(PlatformThreadTest, ThreadPriorityCurrentThread) {
 
   // Toggle each supported priority on the thread and confirm it affects it.
   for (size_t i = 0; i < arraysize(kThreadPriorityTestValues); ++i) {
-    if (!increased_priority_allowed &&
+    if (!increase_priority_allowed &&
         kThreadPriorityTestValues[i] >
             PlatformThread::GetCurrentThreadPriority()) {
       continue;
diff --git a/base/threading/simple_thread.cc b/base/threading/simple_thread.cc
index 6c64a17..fa1a344 100644
--- a/base/threading/simple_thread.cc
+++ b/base/threading/simple_thread.cc
@@ -12,39 +12,29 @@
 namespace base {
 
 SimpleThread::SimpleThread(const std::string& name_prefix)
-    : name_prefix_(name_prefix),
-      name_(name_prefix),
-      thread_(),
-      event_(WaitableEvent::ResetPolicy::MANUAL,
-             WaitableEvent::InitialState::NOT_SIGNALED),
-      tid_(0),
-      joined_(false) {}
+    : SimpleThread(name_prefix, Options()) {}
 
 SimpleThread::SimpleThread(const std::string& name_prefix,
                            const Options& options)
     : name_prefix_(name_prefix),
       name_(name_prefix),
       options_(options),
-      thread_(),
       event_(WaitableEvent::ResetPolicy::MANUAL,
-             WaitableEvent::InitialState::NOT_SIGNALED),
-      tid_(0),
-      joined_(false) {}
+             WaitableEvent::InitialState::NOT_SIGNALED) {}
 
 SimpleThread::~SimpleThread() {
   DCHECK(HasBeenStarted()) << "SimpleThread was never started.";
-  DCHECK(HasBeenJoined()) << "SimpleThread destroyed without being Join()ed.";
+  DCHECK(thread_.is_null()) << "Joinable SimpleThread destroyed without being "
+                            << "Join()ed.";
 }
 
 void SimpleThread::Start() {
   DCHECK(!HasBeenStarted()) << "Tried to Start a thread multiple times.";
-  bool success;
-  if (options_.priority() == ThreadPriority::NORMAL) {
-    success = PlatformThread::Create(options_.stack_size(), this, &thread_);
-  } else {
-    success = PlatformThread::CreateWithPriority(options_.stack_size(), this,
-                                                 &thread_, options_.priority());
-  }
+  bool success = options_.joinable
+      ? PlatformThread::CreateWithPriority(options_.stack_size, this,
+                                           &thread_, options_.priority)
+      : PlatformThread::CreateNonJoinableWithPriority(
+            options_.stack_size, this, options_.priority);
   DCHECK(success);
   base::ThreadRestrictions::ScopedAllowWait allow_wait;
   event_.Wait();  // Wait for the thread to complete initialization.
@@ -53,7 +43,9 @@ void SimpleThread::Start() {
 void SimpleThread::Join() {
   DCHECK(HasBeenStarted()) << "Tried to Join a never-started thread.";
   DCHECK(!HasBeenJoined()) << "Tried to Join a thread multiple times.";
+  DCHECK(!thread_.is_null()) << "A non-joinable thread can't be joined.";
   PlatformThread::Join(thread_);
+  thread_ = PlatformThreadHandle();
   joined_ = true;
 }
 
diff --git a/base/threading/simple_thread.h b/base/threading/simple_thread.h
index 3deeb10..dd1fc6c 100644
--- a/base/threading/simple_thread.h
+++ b/base/threading/simple_thread.h
@@ -48,6 +48,7 @@
 
 #include "base/base_export.h"
 #include "base/compiler_specific.h"
+#include "base/macros.h"
 #include "base/synchronization/lock.h"
 #include "base/synchronization/waitable_event.h"
 #include "base/threading/platform_thread.h"
@@ -58,25 +59,25 @@ namespace base {
 // virtual Run method, or you can use the DelegateSimpleThread interface.
 class BASE_EXPORT SimpleThread : public PlatformThread::Delegate {
  public:
-  class BASE_EXPORT Options {
+  struct BASE_EXPORT Options {
    public:
-    Options() : stack_size_(0), priority_(ThreadPriority::NORMAL) {}
-    explicit Options(ThreadPriority priority)
-        : stack_size_(0), priority_(priority) {}
-    ~Options() {}
+    Options() = default;
+    explicit Options(ThreadPriority priority_in) : priority(priority_in) {}
+    ~Options() = default;
 
-    // We use the standard compiler-supplied copy constructor.
+    // Allow copies.
+    Options(const Options& other) = default;
+    Options& operator=(const Options& other) = default;
 
     // A custom stack size, or 0 for the system default.
-    void set_stack_size(size_t size) { stack_size_ = size; }
-    size_t stack_size() const { return stack_size_; }
-
-    // A custom thread priority.
-    void set_priority(ThreadPriority priority) { priority_ = priority; }
-    ThreadPriority priority() const { return priority_; }
-   private:
-    size_t stack_size_;
-    ThreadPriority priority_;
+    size_t stack_size = 0;
+
+    ThreadPriority priority = ThreadPriority::NORMAL;
+
+    // If false, the thread's PlatformThreadHandle will not be kept around and
+    // the SimpleThread instance will not be required to be Join()'ed before
+    // being destroyed
+    bool joinable = true;
   };
 
   // Create a SimpleThread.  |options| should be used to manage any specific
@@ -106,7 +107,7 @@ class BASE_EXPORT SimpleThread : public PlatformThread::Delegate {
   // Return True if Start() has ever been called.
   bool HasBeenStarted();
 
-  // Return True if Join() has evern been called.
+  // Return True if Join() has ever been called.
   bool HasBeenJoined() { return joined_; }
 
   // Overridden from PlatformThread::Delegate:
@@ -116,10 +117,12 @@ class BASE_EXPORT SimpleThread : public PlatformThread::Delegate {
   const std::string name_prefix_;
   std::string name_;
   const Options options_;
-  PlatformThreadHandle thread_;  // PlatformThread handle, invalid after Join!
+  PlatformThreadHandle thread_;  // PlatformThread handle, reset after Join.
   WaitableEvent event_;          // Signaled if Start() was ever called.
-  PlatformThreadId tid_;         // The backing thread's id.
-  bool joined_;                  // True if Join has been called.
+  PlatformThreadId tid_ = kInvalidThreadId;  // The backing thread's id.
+  bool joined_ = false;          // True if Join has been called.
+
+  DISALLOW_COPY_AND_ASSIGN(SimpleThread);
 };
 
 class BASE_EXPORT DelegateSimpleThread : public SimpleThread {
@@ -142,6 +145,8 @@ class BASE_EXPORT DelegateSimpleThread : public SimpleThread {
 
  private:
   Delegate* delegate_;
+
+  DISALLOW_COPY_AND_ASSIGN(DelegateSimpleThread);
 };
 
 // DelegateSimpleThreadPool allows you to start up a fixed number of threads,
@@ -186,6 +191,8 @@ class BASE_EXPORT DelegateSimpleThreadPool
   std::queue<Delegate*> delegates_;
   base::Lock lock_;            // Locks delegates_
   WaitableEvent dry_;    // Not signaled when there is no work to do.
+
+  DISALLOW_COPY_AND_ASSIGN(DelegateSimpleThreadPool);
 };
 
 }  // namespace base
diff --git a/base/threading/simple_thread_unittest.cc b/base/threading/simple_thread_unittest.cc
index 14dd459..26e3a90 100644
--- a/base/threading/simple_thread_unittest.cc
+++ b/base/threading/simple_thread_unittest.cc
@@ -2,16 +2,29 @@
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
+#include <memory>
+
 #include "base/atomic_sequence_num.h"
 #include "base/strings/string_number_conversions.h"
 #include "base/synchronization/waitable_event.h"
+#include "base/test/gtest_util.h"
+#include "base/threading/platform_thread.h"
 #include "base/threading/simple_thread.h"
+#include "base/time/time.h"
 #include "testing/gtest/include/gtest/gtest.h"
 
 namespace base {
 
 namespace {
 
+// Sleeps a tiny amount to augment chances of tests using it running in races
+// should there be any while the tested thread is alive.
+class SleepRunner : public DelegateSimpleThread::Delegate {
+  void Run() override {
+    PlatformThread::Sleep(TimeDelta::FromMilliseconds(20));
+  }
+};
+
 class SetIntRunner : public DelegateSimpleThread::Delegate {
  public:
   SetIntRunner(int* ptr, int val) : ptr_(ptr), val_(val) { }
@@ -133,6 +146,25 @@ TEST(SimpleThreadTest, NamedWithOptions) {
             std::string("event_waiter/") + IntToString(thread.tid()));
 }
 
+TEST(SimpleThreadTest, JoinNonJoinableThreadDeath) {
+  SleepRunner runner;
+  SimpleThread::Options options;
+  options.joinable = false;
+  DelegateSimpleThread thread(&runner, "noop_runner", options);
+
+  thread.Start();
+  EXPECT_DCHECK_DEATH(thread.Join());
+}
+
+TEST(SimpleThreadTest, DeleteNonJoinableWithoutJoinIsSafe) {
+  SleepRunner runner;
+  SimpleThread::Options options;
+  options.joinable = false;
+  DelegateSimpleThread thread(&runner, "noop_runner", options);
+  thread.Start();
+  // Nothing blows up when |thread| goes out of scope.
+}
+
 TEST(SimpleThreadTest, ThreadPool) {
   AtomicSequenceNumber seq;
   SeqRunner runner(&seq);
diff --git a/base/threading/thread_unittest.cc b/base/threading/thread_unittest.cc
index 481ac4b..5c6c275 100644
--- a/base/threading/thread_unittest.cc
+++ b/base/threading/thread_unittest.cc
@@ -154,9 +154,6 @@ TEST_F(ThreadTest, StartWithOptions_StackSize) {
   event.Wait();
 }
 
-// Intentional test-only race for otherwise untestable code, won't fix.
-// https://crbug.com/634383
-#if !defined(THREAD_SANITIZER)
 TEST_F(ThreadTest, StartWithOptions_NonJoinable) {
   Thread* a = new Thread("StartNonJoinable");
   // Non-joinable threads have to be leaked for now (see
@@ -196,7 +193,6 @@ TEST_F(ThreadTest, StartWithOptions_NonJoinable) {
   // The thread should now have stopped on its own.
   EXPECT_FALSE(a->IsRunning());
 }
-#endif
 
 TEST_F(ThreadTest, TwoTasksOnJoinableThread) {
   bool was_invoked = false;
@@ -292,11 +288,7 @@ TEST_F(ThreadTest, StartTwice) {
   EXPECT_FALSE(a.IsRunning());
 }
 
-// Intentional test-only race for otherwise untestable code, won't fix.
-// https://crbug.com/634383
-#if !defined(THREAD_SANITIZER)
 TEST_F(ThreadTest, StartTwiceNonJoinableNotAllowed) {
-  LOG(ERROR) << __FUNCTION__;
   Thread* a = new Thread("StartTwiceNonJoinable");
   // Non-joinable threads have to be leaked for now (see
   // Thread::Options::joinable for details).
@@ -331,7 +323,6 @@ TEST_F(ThreadTest, StartTwiceNonJoinableNotAllowed) {
   // Restarting it should not be allowed.
   EXPECT_DCHECK_DEATH(a->Start());
 }
-#endif
 
 TEST_F(ThreadTest, ThreadName) {
   Thread a("ThreadName");
diff --git a/base/trace_event/heap_profiler_allocation_register.h b/base/trace_event/heap_profiler_allocation_register.h
index 873aebf..86e2721 100644
--- a/base/trace_event/heap_profiler_allocation_register.h
+++ b/base/trace_event/heap_profiler_allocation_register.h
@@ -45,7 +45,8 @@ class FixedHashMap {
   using KVPair = std::pair<const Key, Value>;
 
   // For implementation simplicity API uses integer index instead
-  // of iterators. Most operations (except Find) on KVIndex are O(1).
+  // of iterators. Most operations (except FindValidIndex) on KVIndex
+  // are O(1).
   using KVIndex = size_t;
   static const KVIndex kInvalidKVIndex = static_cast<KVIndex>(-1);
 
@@ -304,14 +305,10 @@ class BASE_EXPORT AllocationRegister {
   static const size_t kAllocationBuckets = 1 << 18;
   static const size_t kAllocationCapacity = 1500000;
 
-  // 2^16 works well with BacktraceHasher. When increasing this number make
-  // sure BacktraceHasher still produces low number of collisions.
-  static const size_t kBacktraceBuckets = 1 << 16;
-#if defined(OS_ANDROID)
-  static const size_t kBacktraceCapacity = 32000;  // 22K was observed
-#else
-  static const size_t kBacktraceCapacity = 55000;  // 45K was observed on Linux
-#endif
+  // Expect max 2^15 unique backtraces. Can be changed to 2^16 without
+  // needing to tweak BacktraceHasher implementation.
+  static const size_t kBacktraceBuckets = 1 << 15;
+  static const size_t kBacktraceCapacity = kBacktraceBuckets;
 
   struct BacktraceHasher {
     size_t operator () (const Backtrace& backtrace) const;
diff --git a/blimp/BUILD.gn b/blimp/BUILD.gn
index a4f74ac..bcfbd81 100644
--- a/blimp/BUILD.gn
+++ b/blimp/BUILD.gn
@@ -28,7 +28,6 @@ group("blimp") {
 
   if (is_linux) {
     deps += [
-      ":client_engine_integration",
       "//blimp/engine",
       "//blimp/engine:blimp_engine_bundle",
     ]
@@ -177,34 +176,7 @@ if (is_linux) {
       "--output",
       rebase_path(_bundle),
       "--tar-contents-rooted-in",
-      rebase_path("//"),
-    ]
-  }
-
-  # Wraps and Builds the Blimp client and engine integration script and
-  # ends up in root_out_dir/bin.
-  action("client_engine_integration") {
-    _wrapped_script = "//blimp/tools/client_engine_integration.py"
-
-    _script_basename = get_path_info(_wrapped_script, "name")
-    _output_path = "${root_out_dir}/bin/${_script_basename}"
-
-    script = "//build/android/gyp/create_tool_wrapper.py"
-    inputs = [
-      _wrapped_script,
-    ]
-    outputs = [
-      _output_path,
-    ]
-
-    args = [
-      "--output",
-      rebase_path(_output_path, root_build_dir),
-      "--target",
-      rebase_path(_wrapped_script, root_build_dir),
-      "--output-directory",
-      rebase_path(root_out_dir, root_build_dir),
-      "--flag-name=--output-linux-directory",
+      rebase_path("//")
     ]
   }
 }
diff --git a/blimp/engine/session/blimp_engine_session.cc b/blimp/engine/session/blimp_engine_session.cc
index 6277723..5fecef3 100644
--- a/blimp/engine/session/blimp_engine_session.cc
+++ b/blimp/engine/session/blimp_engine_session.cc
@@ -176,6 +176,7 @@ EngineNetworkComponents::~EngineNetworkComponents() {
 void EngineNetworkComponents::Initialize(const std::string& client_token) {
   DCHECK_CURRENTLY_ON(content::BrowserThread::IO);
   DCHECK(!connection_manager_);
+
   // Plumb authenticated connections from the authentication handler
   // to |this| (which will then pass it to |connection_handler_|.
   authentication_handler_ =
@@ -193,7 +194,6 @@ void EngineNetworkComponents::Initialize(const std::string& client_token) {
 
   transport->GetLocalAddress(&address);
   port_ = address.port();
-  DVLOG(1) << "Engine port #: " << port_;
 }
 
 void EngineNetworkComponents::HandleConnection(
diff --git a/blimp/tools/PRESUBMIT.py b/blimp/tools/PRESUBMIT.py
index b162d96..a298aa5 100644
--- a/blimp/tools/PRESUBMIT.py
+++ b/blimp/tools/PRESUBMIT.py
@@ -11,23 +11,8 @@ def CommonChecks(input_api, output_api):
   This is currently limited to pylint.
   """
   checks = []
-
-  blimp_tools_dir = input_api.PresubmitLocalPath()
-
-  def J(*dirs):
-    """Returns a path relative to presubmit directory."""
-    return input_api.os_path.join(blimp_tools_dir, *dirs)
-
   checks.extend(input_api.canned_checks.GetPylint(
-      input_api,
-      output_api,
-      pylintrc='pylintrc',
-      extra_paths_list=[
-          J(),
-          J('..', '..', 'build', 'android'),
-          J('..', '..', 'third_party', 'catapult', 'devil')
-      ]))
-
+      input_api, output_api, pylintrc='pylintrc'))
   return input_api.RunTests(checks, False)
 
 
diff --git a/blimp/tools/client_engine_integration.py b/blimp/tools/client_engine_integration.py
deleted file mode 100755
index 75235ae..0000000
--- a/blimp/tools/client_engine_integration.py
+++ /dev/null
@@ -1,314 +0,0 @@
-#!/usr/bin/env python
-# Copyright 2016 The Chromium Authors. All rights reserved.
-# Use of this source code is governed by a BSD-style license that can be
-# found in the LICENSE file.
-
-"""Blimp Client + Engine integration test system
-
-   Set up Client and Engine
-   Set up Forward to connect machine host with client device.
-   Start Engine and run blimp on Android Client.
-"""
-
-import argparse
-import json
-import logging
-import posixpath
-import os
-import re
-import signal
-import subprocess
-import sys
-import time
-
-SRC_PATH = os.path.abspath(
-    os.path.join(os.path.dirname(__file__), '..', '..'))
-
-DEVIL_PATH = os.path.join(SRC_PATH, 'third_party', 'catapult',
-                          'devil')
-
-if DEVIL_PATH not in sys.path:
-  sys.path.append(DEVIL_PATH)
-
-from devil.android import device_blacklist
-from devil.android import device_utils
-from devil.android import forwarder
-from devil.android.sdk import intent
-from devil.utils import cmd_helper
-
-_CLIENT_TOKEN_PATH = posixpath.join('/', 'data', 'data',
-                                    'org.chromium.blimp',
-                                    'blimp_client_token')
-_TOKEN_FILE_PATH = os.path.join(SRC_PATH, 'blimp', 'test', 'data',
-                                'test_client_token')
-PORT_PATTERN = re.compile(r'.*Engine port #: (\d+)')
-ARGS_JSON_FILE = 'blimp_script_args.json'
-
-def AddStartArguments(parser):
-  parser.add_argument('-d',
-                      '--device',
-                      help='Serial number of device we should use.')
-  parser.add_argument('--blacklist-file',
-                      default=None,
-                      help='Device blacklist JSON file.')
-  parser.add_argument('--engine-ip',
-                      default='127.0.0.1',
-                      help='Blimp engine IP.')
-
-
-def _IsNonEmptyFile(fpath):
-  return os.path.isfile(fpath) and os.path.getsize(fpath) > 0
-
-
-def RunClient(device, optional_url):
-  """Run Blimp client.
-
-  Args:
-    device: (DeviceUtils) device to run the tests on.
-    optional_url: (str) URL to navigate to.
-  """
-  run_client_intent = intent.Intent(
-      action='android.intent.action.VIEW',
-      package='org.chromium.blimp',
-      activity='org.chromium.blimp.BlimpRendererActivity',
-      data=optional_url)
-  device.StartActivity(run_client_intent, blocking=True)
-
-
-def RunEngine(output_linux_directory, token_file_path):
-  """Start running engine
-
-  Args:
-    output_linux_directory: (str) Path to the root linux build directory.
-    token_file_path: (str) Path to the client auth token file.
-
-  Returns:
-    port: (str) Engine port number generated by engine session.
-  """
-  port = '0'
-  blimp_engine_app = os.path.join(output_linux_directory,
-                                  'blimp_engine_app')
-  blimp_fonts_path = os.path.join(output_linux_directory, 'gen',
-                                  'third_party', 'blimp_fonts')
-  run_engine_cmd = [
-      blimp_engine_app +
-      ' --android-fonts-path=' + blimp_fonts_path +
-      ' --blimp-client-token-path=' + token_file_path +
-      ' --enable-logging=stderr' +
-      ' -v=0' +
-      ' --vmodule="blimp*=1"']
-  p = subprocess.Popen(run_engine_cmd, shell=True,
-                       stdout=subprocess.PIPE,
-                       stderr=subprocess.STDOUT)
-
-  for line in iter(p.stdout.readline, ''):
-    l = line.rstrip()
-    match = re.match(PORT_PATTERN, l)
-    if match:
-      port = match.group(1)
-      break
-
-  return port, p
-
-
-def SetCommandFlag(device, engine_ip, engine_port):
-  """Set up adb Blimp command line flags
-
-  Args:
-    device: (str) Serial number of device we should use.
-    engine_ip: (str) Blimp engine IP address.
-    engine_port: (str) Port on the engine.
-  """
-  cmd_helper.GetCmdStatusAndOutput([
-      os.path.join(SRC_PATH, 'build', 'android',
-                   'adb_blimp_command_line'),
-      '--device=' + str(device),
-      '--engine-ip=' + engine_ip,
-      '--engine-port=' + engine_port,
-      '--engine-transport=tcp',
-      '-v=0',
-      '--vmodule=*blimp*=1',
-      '--blimp-client-token-path=' + _CLIENT_TOKEN_PATH])
-
-
-def _JsonEncodeDefault(obj):
-  if isinstance(obj, argparse.Namespace):
-    result = obj.__dict__
-    result.update({'_type': 'args'})
-    return result
-  raise TypeError("Json object must be an instance of argparse.Namespace")
-
-
-def _FromJson(json_object):
-  if json_object.get('_type') == 'args':
-    result = argparse.Namespace()
-    for key, value in json_object.iteritems():
-      setattr(result, key, value)
-    return result
-  return json_object
-
-
-def _Start(args, json_file_path, device):
-  """Start engine and forwarder
-
-  Args:
-    args: parsed command line arguments.
-    json_file_path: json file path which keeps the script variables.
-    device: (DeviceUtils) device to run the tests on.
-  """
-  if _IsNonEmptyFile(json_file_path):
-    logging.error('Error: An engine instance is already running.')
-    sys.exit(1)
-
-  json_args = argparse.Namespace()
-  for k in args.__dict__:
-    if not k == "func":
-      setattr(json_args, k, args.__dict__[k])
-  json_object = {'args': json_args}
-  device.EnableRoot()
-  host_device_tuples = [(_TOKEN_FILE_PATH, _CLIENT_TOKEN_PATH)]
-  device.PushChangedFiles(host_device_tuples)
-
-  port_number, engine_process = RunEngine(
-      args.output_linux_directory, _TOKEN_FILE_PATH)
-  json_object['port_number'] = port_number
-  json_object['pid'] = engine_process.pid
-  logging.info("Engine port number: %s", port_number)
-  logging.info("Engine running PID: %d", engine_process.pid)
-
-  if engine_process.poll() is None:
-    try:
-      port_pairs = [(port_number, port_number)]
-      forwarder.Forwarder.Map(port_pairs, device)
-      SetCommandFlag(device, args.engine_ip, port_number)
-      print "Blimp engine started"
-      return engine_process
-
-    finally:
-      with open(json_file_path, 'w') as f:
-        json.dump(json_object, f, default=_JsonEncodeDefault)
-
-
-def _Run(args, json_file_path, device):
-  """Start engine and forwarder and keep runnning.
-
-  Args:
-    args: parsed command line arguments.
-    json_file_path: json file path which keeps the script variables.
-    device: (DeviceUtils) device to run the tests on.
-  """
-  try:
-    engine_process = _Start(args, json_file_path, device)
-    while True:
-      time.sleep(1)
-      return_code = engine_process.poll()
-      if return_code is not None:
-        # The engine died.
-        sys.exit(1)
-  except KeyboardInterrupt:
-    sys.exit(0)
-  finally:
-    _Stop(args, json_file_path, device)
-
-
-def _Load(args, json_file_path, device): # pylint: disable=unused-argument
-  """Start client and load the url
-
-  Args:
-    args: parsed command line arguments.
-    json_file_path: json file path which keeps the script variables.
-    device: (DeviceUtils) device to run the tests on.
-  """
-  device.Install(os.path.join(SRC_PATH, args.apk_path),
-                 reinstall=True)
-  run_client_intent = intent.Intent(
-      action='android.intent.action.VIEW',
-      package='org.chromium.blimp',
-      activity='org.chromium.blimp.BlimpRendererActivity',
-      data=args.optional_url)
-  device.StartActivity(run_client_intent, blocking=True)
-
-
-def _Stop(args, json_file_path, device): # pylint: disable=unused-argument
-  """Stop engine and forwarder
-
-  Args:
-    args: (unused) parsed command line arguments.
-    json_file_path: json file path which keeps the script variables.
-    device: (DeviceUtils) device to run the tests on.
-  """
-  if not _IsNonEmptyFile(json_file_path):
-    logging.error('Error: cannot find json file: ' + json_file_path)
-    sys.exit(1)
-  try:
-    with open(json_file_path, 'r') as f:
-      jsonarg = json.load(f, object_hook=_FromJson)
-    pid = int(jsonarg['pid'])
-    try:
-      forwarder.Forwarder.UnmapAllDevicePorts(device)
-    finally:
-      os.kill(pid, signal.SIGKILL)
-  finally:
-    os.remove(json_file_path)
-
-
-def main():
-  parser = argparse.ArgumentParser()
-  parser.add_argument('-l',
-                      '--output-linux-directory',
-                      required=True,
-                      help='Path to the root linux build directory.'
-                           ' Example: "out-linux/Debug"')
-  subparsers = parser.add_subparsers(dest="subparser_name")
-
-  start_parser = subparsers.add_parser('start')
-  start_parser.set_defaults(func=_Start)
-  AddStartArguments(start_parser)
-
-  run_parser = subparsers.add_parser('run')
-  run_parser.set_defaults(func=_Run)
-  AddStartArguments(run_parser)
-
-  load_parser = subparsers.add_parser('load')
-  load_parser.set_defaults(func=_Load)
-  load_parser.add_argument('-p',
-                           '--apk-path',
-                           required=True,
-                           help='The path to the APK to install. '
-                                'Including the name of the apk containing '
-                                'the application (with the .apk extension).')
-  load_parser.add_argument('-u',
-                           '--optional-url',
-                           help='URL to navigate to.')
-
-  stop_parser = subparsers.add_parser('stop')
-  stop_parser.set_defaults(func=_Stop)
-
-  args = parser.parse_args()
-
-  json_file_path = os.path.join(SRC_PATH, args.output_linux_directory,
-                                ARGS_JSON_FILE)
-  blacklist_file = ''
-  serial = ''
-  if args.subparser_name == 'start' or args.subparser_name == 'run':
-    blacklist_file = args.blacklist_file
-    serial = args.device
-  else:
-    with open(json_file_path, 'r') as f:
-      file_lines = f.readlines()
-    jsonarg = json.loads(file_lines[0], object_hook=_FromJson)
-    blacklist_file = jsonarg['args'].blacklist_file
-    serial = jsonarg['args'].device
-
-  blacklist = (device_blacklist.Blacklist(blacklist_file)
-               if blacklist_file
-               else None)
-  device = device_utils.DeviceUtils.HealthyDevices(
-      blacklist=blacklist, device_arg=serial)[0]
-
-  args.func(args, json_file_path, device)
-
-
-if __name__ == '__main__':
-  main()
-
diff --git a/breakpad/BUILD.gn b/breakpad/BUILD.gn
index c7730e7..b15764c 100644
--- a/breakpad/BUILD.gn
+++ b/breakpad/BUILD.gn
@@ -332,15 +332,6 @@ if (is_mac) {
   }
 }
 
-if (is_ios) {
-  binary_symlink("dump_syms") {
-    binary_label = ":$target_name($host_toolchain)"
-  }
-  binary_symlink("symupload") {
-    binary_label = ":$target_name($host_toolchain)"
-  }
-}
-
 if (is_mac) {
   static_library("utilities") {
     sources = [
diff --git a/build/all.gyp b/build/all.gyp
index 3c8210b..04cd975 100644
--- a/build/all.gyp
+++ b/build/all.gyp
@@ -226,7 +226,6 @@
         }],
         ['OS=="win"', {
           'dependencies': [
-            '../chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.gyp:*',
             '../chrome_elf/chrome_elf.gyp:*',
             '../courgette/courgette.gyp:*',
             '../rlz/rlz.gyp:*',
diff --git a/build/android/gn/generate_isolate.py b/build/android/gn/generate_isolate.py
index 1ac75b1..9c387d9 100755
--- a/build/android/gn/generate_isolate.py
+++ b/build/android/gn/generate_isolate.py
@@ -29,10 +29,6 @@ _ANDROID_BLACKLIST = (
 
 _DEVICE_BLACKLIST = (
     r'.*\.py',  # Some test_support targets include python deps.
-
-    # v8's blobs get packaged into APKs.
-    r'.*natives_blob.*\.bin',
-    r'.*snapshot_blob.*\.bin',
 )
 
 _ASSERT_WHITELIST = (
diff --git a/build/android/gyp/java_cpp_enum.py b/build/android/gyp/java_cpp_enum.py
index ffab05c..21913da 100755
--- a/build/android/gyp/java_cpp_enum.py
+++ b/build/android/gyp/java_cpp_enum.py
@@ -27,12 +27,11 @@ ENUM_FIXED_TYPE_WHITELIST = ['char', 'unsigned char',
 
 class EnumDefinition(object):
   def __init__(self, original_enum_name=None, class_name_override=None,
-               enum_package=None, entries=None, comments=None, fixed_type=None):
+               enum_package=None, entries=None, fixed_type=None):
     self.original_enum_name = original_enum_name
     self.class_name_override = class_name_override
     self.enum_package = enum_package
     self.entries = collections.OrderedDict(entries or [])
-    self.comments = collections.OrderedDict(comments or [])
     self.prefix_to_strip = None
     self.fixed_type = fixed_type
 
@@ -41,11 +40,6 @@ class EnumDefinition(object):
       raise Exception('Multiple definitions of key %s found.' % key)
     self.entries[key] = value
 
-  def AppendEntryComment(self, key, value):
-    if key in self.comments:
-      raise Exception('Multiple definitions of key %s found.' % key)
-    self.comments[key] = value
-
   @property
   def class_name(self):
     return self.class_name_override or self.original_enum_name
@@ -130,7 +124,7 @@ class DirectiveSet(object):
 
 
 class HeaderParser(object):
-  single_line_comment_re = re.compile(r'\s*//\s*([^\n]+)')
+  single_line_comment_re = re.compile(r'\s*//')
   multi_line_comment_start_re = re.compile(r'\s*/\*')
   enum_line_re = re.compile(r'^\s*(\w+)(\s*\=\s*([^,\n]+))?,?')
   enum_end_re = re.compile(r'^\s*}\s*;\.*$')
@@ -156,7 +150,6 @@ class HeaderParser(object):
     self._enum_definitions = []
     self._in_enum = False
     self._current_definition = None
-    self._current_comments = []
     self._generator_directives = DirectiveSet()
     self._multi_line_generator_directive = None
 
@@ -178,9 +171,7 @@ class HeaderParser(object):
       self._ParseEnumLine(line)
 
   def _ParseEnumLine(self, line):
-    enum_comment = HeaderParser.single_line_comment_re.match(line)
-    if enum_comment:
-      self._current_comments.append(enum_comment.groups()[0])
+    if HeaderParser.single_line_comment_re.match(line):
       return
     if HeaderParser.multi_line_comment_start_re.match(line):
       raise Exception('Multi-line comments in enums are not supported in ' +
@@ -196,10 +187,6 @@ class HeaderParser(object):
       enum_key = enum_entry.groups()[0]
       enum_value = enum_entry.groups()[2]
       self._current_definition.AppendEntry(enum_key, enum_value)
-      if self._current_comments:
-         self._current_definition.AppendEntryComment(
-                 enum_key, ' '.join(self._current_comments))
-         self._current_comments = []
 
   def _ParseMultiLineDirectiveLine(self, line):
     multi_line_directive_continuation = (
@@ -302,17 +289,6 @@ ${ENUM_ENTRIES}
         'NAME': enum_name,
         'VALUE': enum_value,
     }
-    enum_comments = enum_definition.comments.get(enum_name)
-    if enum_comments:
-        enum_comments_indent = '   * '
-        comments_line_wrapper = textwrap.TextWrapper(
-                initial_indent=enum_comments_indent,
-                subsequent_indent=enum_comments_indent,
-                width=100)
-        enum_entries_string.append('  /**')
-        enum_entries_string.append(
-                '\n'.join(comments_line_wrapper.wrap(enum_comments)))
-        enum_entries_string.append('   */')
     enum_entries_string.append(enum_template.substitute(values))
     enum_names.append(enum_name)
   enum_entries_string = '\n'.join(enum_entries_string)
diff --git a/build/android/gyp/java_cpp_enum_tests.py b/build/android/gyp/java_cpp_enum_tests.py
index 643a410..3444cfa 100755
--- a/build/android/gyp/java_cpp_enum_tests.py
+++ b/build/android/gyp/java_cpp_enum_tests.py
@@ -26,13 +26,7 @@ class TestPreprocess(unittest.TestCase):
   def testOutput(self):
     definition = EnumDefinition(original_enum_name='ClassName',
                                 enum_package='some.package',
-                                entries=[('E1', 1), ('E2', '2 << 2')],
-                                comments=[('E2', 'This is a comment.'),
-                                          ('E1', 'This is a multiple line '
-                                                 'comment that is really long. '
-                                                 'This is a multiple line '
-                                                 'comment that is really '
-                                                 'really long.')])
+                                entries=[('E1', 1), ('E2', '2 << 2')])
     output = GenerateOutput('path/to/file', definition)
     expected = """
 // Copyright %d The Chromium Authors. All rights reserved.
@@ -57,22 +51,11 @@ public class ClassName {
   })
   @Retention(RetentionPolicy.SOURCE)
   public @interface ClassNameEnum {}
-  /**
-   * %s
-   * really really long.
-   */
   public static final int E1 = 1;
-  /**
-   * This is a comment.
-   */
   public static final int E2 = 2 << 2;
 }
 """
-    long_comment = ('This is a multiple line comment that is really long. '
-                    'This is a multiple line comment that is')
-    self.assertEqual(
-            expected % (date.today().year, GetScriptName(), long_comment),
-            output)
+    self.assertEqual(expected % (date.today().year, GetScriptName()), output)
 
   def testParseSimpleEnum(self):
     test_data = """
@@ -151,8 +134,6 @@ public class ClassName {
       // GENERATED_JAVA_PREFIX_TO_STRIP: P_
       enum EnumTwo {
         P_A,
-        // This comment spans
-        // two lines.
         P_B
       };
     """.split('\n')
@@ -164,13 +145,10 @@ public class ClassName {
     self.assertEqual(collections.OrderedDict([('A', '1'),
                                               ('B', 'A')]),
                      definition.entries)
-    self.assertEqual(collections.OrderedDict([('ENUM_ONE_B', 'Comment there')]),
-                     definition.comments)
+
     definition = definitions[1]
     self.assertEqual('EnumTwo', definition.class_name)
     self.assertEqual('other.package', definition.enum_package)
-    self.assertEqual(collections.OrderedDict(
-        [('P_B', 'This comment spans two lines.')]), definition.comments)
     self.assertEqual(collections.OrderedDict([('A', 0),
                                               ('B', 1)]),
                      definition.entries)
diff --git a/build/android/gyp/util/proguard_util.py b/build/android/gyp/util/proguard_util.py
index 1027a68..f1449c8 100644
--- a/build/android/gyp/util/proguard_util.py
+++ b/build/android/gyp/util/proguard_util.py
@@ -105,6 +105,18 @@ class ProguardCmdBuilder(object):
     if self._tested_apk_info_path:
       tested_apk_info = build_utils.ReadJson(self._tested_apk_info_path)
       self._configs += tested_apk_info['configs']
+      self._injars = [
+          p for p in self._injars if not p in tested_apk_info['inputs']]
+      if not self._libraries:
+        self._libraries = []
+      self._libraries += tested_apk_info['inputs']
+      self._mapping = tested_apk_info['mapping']
+      cmd += [
+        '-dontobfuscate',
+        '-dontoptimize',
+        '-dontshrink',
+        '-dontskipnonpubliclibraryclassmembers',
+      ]
 
     if self._mapping:
       cmd += [
diff --git a/build/android/gyp/write_build_config.py b/build/android/gyp/write_build_config.py
index 22b4e27..fa38432 100755
--- a/build/android/gyp/write_build_config.py
+++ b/build/android/gyp/write_build_config.py
@@ -521,33 +521,14 @@ def main(argv):
     javac_classpath = [c['jar_path'] for c in direct_library_deps]
     java_full_classpath = [c['jar_path'] for c in all_library_deps]
 
-  # The java code for an instrumentation test apk is assembled differently for
-  # ProGuard vs. non-ProGuard.
-  #
-  # Without ProGuard: Each library's jar is dexed separately and then combined
-  # into a single classes.dex. A test apk will include all dex files not already
-  # present in the apk-under-test. At runtime all test code lives in the test
-  # apk, and the program code lives in the apk-under-test.
-  #
-  # With ProGuard: Each library's .jar file is fed into ProGuard, which outputs
-  # a single .jar, which is then dexed into a classes.dex. A test apk includes
-  # all jar files from the program and the tests because having them separate
-  # doesn't work with ProGuard's whole-program optimizations. Although the
-  # apk-under-test still has all of its code in its classes.dex, none of it is
-  # used at runtime because the copy of it within the test apk takes precidence.
+  # An instrumentation test apk should exclude the dex files that are in the apk
+  # under test.
   if options.type == 'android_apk' and options.tested_apk_config:
     tested_apk_config = GetDepConfig(options.tested_apk_config)
 
     expected_tested_package = tested_apk_config['package_name']
     AndroidManifest(options.android_manifest).CheckInstrumentation(
         expected_tested_package)
-    if options.proguard_enabled:
-      # Add all tested classes to the test's classpath to ensure that the test's
-      # java code is a superset of the tested apk's java code
-      java_full_classpath += [
-          jar for jar in tested_apk_config['java']['full_classpath']
-          if jar not in java_full_classpath]
-
     if tested_apk_config['proguard_enabled']:
       assert options.proguard_enabled, ('proguard must be enabled for '
           'instrumentation apks if it\'s enabled for the tested apk.')
@@ -583,7 +564,7 @@ def main(argv):
     config['javac']['classpath'] = javac_classpath
     config['javac']['interface_classpath'] = [
         _AsInterfaceJar(p) for p in javac_classpath]
-    deps_info['java'] = {
+    config['java'] = {
       'full_classpath': java_full_classpath
     }
 
diff --git a/build/android/lint/suppressions.xml b/build/android/lint/suppressions.xml
index 2111f9a..210594b 100644
--- a/build/android/lint/suppressions.xml
+++ b/build/android/lint/suppressions.xml
@@ -108,13 +108,8 @@ Still reading?
   <issue id="UnusedResources">
     <!-- Used by Android's policies system -->
     <ignore regexp="restriction_values.xml" />
+
     <ignore path="android_webview/tools/automated_ui_tests/java/res/" />
-    <!--
-        This file isn't used if the target SDK version is less than 24.
-        TODO(estevenson) remove this and the conditional inclusion in
-        AndroidManifest.xml after rolling to SDK 24.
-    -->
-    <ignore path="chrome/android/java/res/xml/network_security_config.xml" />
   </issue>
   <issue id="SignatureOrSystemPermissions" severity="ignore"/>
   <issue id="UnusedAttribute" severity="ignore"/>
diff --git a/build/config/BUILD.gn b/build/config/BUILD.gn
index 3ea0fd0..ef5c433 100644
--- a/build/config/BUILD.gn
+++ b/build/config/BUILD.gn
@@ -38,27 +38,13 @@ declare_args() {
   disable_precompiled_headers = false
 }
 
-# ==============================================
-#   PLEASE DO NOT ADD MORE THINGS TO THIS LIST
-# ==============================================
+# TODO(brettw) Most of these should be removed. Instead of global feature
+# flags, we should have more modular flags that apply only to a target and its
+# dependents. For example, depending on the "x11" meta-target should define
+# USE_X11 for all dependents so that everything that could use X11 gets the
+# define, but anything that doesn't depend on X11 doesn't see it.
 #
-# Legacy feature defines applied to all targets.
-#
-# These are applied to every single compile in the build and most of them are
-# only relevant to a few files. This bloats command lines and causes
-# unnecessary recompiles when flags are flipped.
-#
-# To pass defines to source code from the build, use the buildflag system which
-# will write headers containing the defines you need. This isolates the define
-# and means its definition can participate in the build graph, only recompiling
-# things when it actually changes.
-#
-# See //build/buildflag_header.gni for inntructions on generating headers.
-#
-# This will also allow you to scope your build flag to a BUILD.gn file (or a
-# .gni file if you need it from more than one place) rather than making global
-# flags. See //build/config/BUILDCONFIG.gn for advice on where to define
-# build flags.
+# For now we define these globally to match the current GYP build.
 config("feature_flags") {
   # Don't use deprecated V8 APIs anywhere.
   defines = [ "V8_DEPRECATION_WARNINGS" ]
@@ -270,12 +256,6 @@ config("feature_flags") {
   if (!fieldtrial_testing_like_official_build && !is_chrome_branded) {
     defines += [ "FIELDTRIAL_TESTING_ENABLED" ]
   }
-
-  # ==============================================
-  #   PLEASE DO NOT ADD MORE THINGS TO THIS LIST
-  # ==============================================
-  #
-  # See the comment at the top.
 }
 
 # Debug/release ----------------------------------------------------------------
diff --git a/build/config/BUILDCONFIG.gn b/build/config/BUILDCONFIG.gn
index 6390ae9..e539df7 100644
--- a/build/config/BUILDCONFIG.gn
+++ b/build/config/BUILDCONFIG.gn
@@ -3,18 +3,6 @@
 # found in the LICENSE file.
 
 # =============================================================================
-# WHAT IS THIS FILE?
-# =============================================================================
-#
-# This is the master GN build configuration. This file is loaded after the
-# build args (args.gn) for the build directory and after the toplevel ".gn"
-# file (which points to this file as the build configuration).
-#
-# This file will be executed and the resulting context will be used to execute
-# every other file in the build. So variables declared here (that don't start
-# with an underscore) will be implicitly global.
-
-# =============================================================================
 # PLATFORM SELECTION
 # =============================================================================
 #
@@ -81,31 +69,31 @@ if (current_os == "") {
 #
 # YOU SHOULD ALMOST NEVER NEED TO ADD FLAGS TO THIS FILE. GN allows any file in
 # the build to declare build flags. If you need a flag for a single component,
-# you can just declare it in the corresponding BUILD.gn file.
-#
-# - If your feature is a single target, say //components/foo, you can put
-#   a declare_args() block in //components/foo/BUILD.gn and use it there.
-#   Nobody else in the build needs to see the flag.
-#
-# - Defines based on build variables should be implemented via the generated
-#   build flag header system. See //build/buildflag_header.gni. You can put
-#   the buildflag_header target in the same file as the build flag itself. You
-#   should almost never set "defines" directly.
-#
-# - If your flag toggles a target on and off or toggles between different
-#   versions of similar things, write a "group" target that forwards to the
-#   right target (or no target) depending on the value of the build flag. This
-#   group can be in the same BUILD.gn file as the build flag, and targets can
-#   depend unconditionally on the group rather than duplicating flag checks
-#   across many targets.
-#
-# - If a semi-random set of build files REALLY needs to know about a define and
-#   the above pattern for isolating the build logic in a forwarding group
-#   doesn't work, you can put the argument in a .gni file. This should be put
-#   in the lowest level of the build that knows about this feature (which should
-#   almost always be outside of the //build directory!).
-#
-# Other flag advice:
+# you can just declare it in the corresponding BUILD.gn file. If you need a
+# flag in multiple components, there are a few options:
+#
+# - If your feature is a single target, say //components/foo, and the targets
+#   depending on foo need to have some define set if foo is enabled: (1) Write
+#   a declare_args block in foo's BUILD.gn file listing your enable_foo build
+#   flag. (2) Write a config in that file listing the define, and list that
+#   config in foo's public_configs. This will propagate that define to all the
+#   targets depending on foo. (3) When foo is not enabled, just make it expand
+#   to an empty group (or whatever's appropriate for the "off" state of your
+#   feature).
+#
+# - If a semi-random set of targets need to know about a define: (1) In the
+#   lowest level of the build that knows about this feature, add a declare_args
+#   block in the build file for your enable flag. (2) Write a config that adds
+#   a define conditionally based on that build flags. (3) Manually add that
+#   config to the "configs" applying to the targets that need the define.
+#
+# - If a semi-random set of targets need to know about the build flag (to do
+#   file inclusion or exclusion, more than just defines): (1) Write a .gni file
+#   in the lowest-level directory that knows about the feature. (2) Put the
+#   declare_args block with your build flag in that .gni file. (3) Import that
+#   .gni file from the BUILD.gn files that need the flag.
+#
+# Other advice:
 #
 # - Use boolean values when possible. If you need a default value that expands
 #   to some complex thing in the default case (like the location of the
diff --git a/build/config/android/config.gni b/build/config/android/config.gni
index fe196b9..88f1364 100644
--- a/build/config/android/config.gni
+++ b/build/config/android/config.gni
@@ -118,6 +118,13 @@ if (is_android) {
     # Required for Android M+ due to SELinux policies (stronger sandboxing).
     disable_incremental_isolated_processes = false
 
+    # Enables all ProGuard optimizations. These optimizations must not be
+    # enabled for instrumentation tests, since they cause code required by the
+    # tests to be removed.
+    # TODO(smaier): when buildbots get updated to set this flag, change the
+    # default to is_official_build
+    enable_all_proguard_optimizations = false
+
     # Speed up incremental compiles by compiling only changed files.
     enable_incremental_javac = false
 
@@ -129,6 +136,11 @@ if (is_android) {
     use_order_profiling = false
   }
 
+  # Ensuring we never have a situation where we are asking to have debug java
+  # on alongside all ProGuard optimizations turned on, as these are mutually
+  # exclusive.
+  assert(!(is_java_debug && enable_all_proguard_optimizations))
+
   # Neither of these should ever be used for release builds since they are
   # somewhat experimental and dx --incremental is known to not produce
   # byte-for-byte identical output.
diff --git a/build/config/android/internal_rules.gni b/build/config/android/internal_rules.gni
index 7aa21f5..986a56c 100644
--- a/build/config/android/internal_rules.gni
+++ b/build/config/android/internal_rules.gni
@@ -867,7 +867,7 @@ if (enable_java_templates) {
         rebase_path(depfile, root_build_dir),
         "--output",
         rebase_path(java_script, root_build_dir),
-        "--classpath=@FileArg($_rebased_build_config:deps_info:java:full_classpath)",
+        "--classpath=@FileArg($_rebased_build_config:java:full_classpath)",
         "--jar-path",
         rebase_path(_jar_path, root_build_dir),
         "--main-class",
@@ -2386,7 +2386,6 @@ if (enable_java_templates) {
     group(target_name) {
       forward_variables_from(invoker,
                              [
-                               "data",
                                "data_deps",
                                "visibility",
                              ])
diff --git a/build/config/android/rules.gni b/build/config/android/rules.gni
index 239be85..d838ceb 100644
--- a/build/config/android/rules.gni
+++ b/build/config/android/rules.gni
@@ -2247,40 +2247,19 @@ if (enable_java_templates) {
   template("instrumentation_test_apk") {
     testonly = true
     _apk_target_name = "${target_name}__apk"
-    _gen_isolate_target_name = "${target_name}__isolate"
     _test_runner_target_name = "${target_name}__test_runner_script"
     _install_script_name = "install_$target_name"
 
-    _target_dir_name = get_label_info(":$target_name", "dir")
-    _device_isolate_path = "$root_out_dir/gen.runtime/$_target_dir_name/$target_name.device.isolate"
-    device_isolate(_gen_isolate_target_name) {
-      forward_variables_from(invoker,
-                             [
-                               "data",
-                               "data_deps",
-                               "deps",
-                               "public_deps",
-                             ])
-      output = _device_isolate_path
-    }
-
-    if (defined(invoker.isolate_file)) {
-      assert(invoker.isolate_file != "")
-    }
-
     test_runner_script(_test_runner_target_name) {
       forward_variables_from(invoker,
                              [
                                "additional_apks",
                                "apk_under_test",
+                               "isolate_file",
                              ])
       test_name = invoker.target_name
       test_type = "instrumentation"
       apk_target = ":$_apk_target_name"
-      isolate_file = _device_isolate_path
-      deps = [
-        ":$_gen_isolate_target_name",
-      ]
     }
 
     test_runner_script("${_test_runner_target_name}_incremental") {
@@ -2288,15 +2267,12 @@ if (enable_java_templates) {
                              [
                                "additional_apks",
                                "apk_under_test",
+                               "isolate_file",
                              ])
       test_name = "${invoker.target_name}_incremental"
       test_type = "instrumentation"
       apk_target = ":$_apk_target_name"
       incremental_install = true
-      isolate_file = _device_isolate_path
-      deps = [
-        ":$_gen_isolate_target_name",
-      ]
     }
 
     android_apk(_apk_target_name) {
@@ -2314,15 +2290,6 @@ if (enable_java_templates) {
         data_deps += invoker.additional_apks
       }
 
-      if (defined(invoker.proguard_enabled) && invoker.proguard_enabled) {
-        # When ProGuard is on, we use ProGuard to combine the under test java
-        # code and the test java code. This is to allow us to apply all ProGuard
-        # optimizations that we ship with, but not have them break tests. The
-        # apk under test will still have the same resources, assets, and
-        # manifest, all of which are the ones used in the tests.
-        proguard_configs = [ "//testing/android/proguard_for_test.flags" ]
-      }
-
       create_dist_ijar = true
       if (defined(invoker.run_findbugs_override)) {
         # Only allow findbugs when there are java files.
diff --git a/build/config/features.gni b/build/config/features.gni
index d9a5fa2..6ef2c41 100644
--- a/build/config/features.gni
+++ b/build/config/features.gni
@@ -2,17 +2,17 @@
 # Use of this source code is governed by a BSD-style license that can be
 # found in the LICENSE file.
 
-# =============================================
-#   PLEASE DO NOT ADD MORE FLAGS TO THIS FILE
-# =============================================
+# This file contains Chrome-feature-related build flags (see ui.gni for
+# UI-related ones). These should theoretically be moved to the build files of
+# the features themselves.
 #
-# These flags are effectively global. Your feature flag should go near the
-# code it controls. Most of these items are here now because they control
-# legacy global #defines passed to the compiler (now replaced with generated
-# buildflag headers -- see //build/buildflag_header.gni).
+# However, today we have many "bad" dependencies on some of these flags from,
+# e.g. base, so they need to be global to match the GYP configuration. Also,
+# anything that needs a grit define must be in either this file or ui.gni.
 #
-# There is more advice on where to put build flags in the "Build flag" section
-# of //build/config/BUILDCONFIG.gn.
+# PLEASE TRY TO AVOID ADDING FLAGS TO THIS FILE in cases where grit isn't
+# required. See the declare_args block of BUILDCONFIG.gn for advice on how
+# to set up feature flags.
 
 import("//build/config/chrome_build.gni")
 import("//build/config/chromecast_build.gni")
@@ -177,9 +177,3 @@ use_brlapi = is_chromeos
 enable_configuration_policy = !is_ios
 
 enable_mac_keystone = is_mac && is_chrome_branded && is_official_build
-#
-# =============================================
-#   PLEASE DO NOT ADD MORE FLAGS TO THIS FILE
-# =============================================
-#
-# See comment at the top.
diff --git a/build/config/sanitizers/BUILD.gn b/build/config/sanitizers/BUILD.gn
index cf51896..359453b 100644
--- a/build/config/sanitizers/BUILD.gn
+++ b/build/config/sanitizers/BUILD.gn
@@ -176,10 +176,6 @@ config("default_sanitizer_ldflags") {
       ldflags += [ "-fsanitize=vptr" ]
     }
 
-    if (use_sanitizer_coverage) {
-      ldflags += [ "-fsanitize-coverage=$sanitizer_coverage_flags" ]
-    }
-
     if (is_cfi && !is_nacl) {
       ldflags += [ "-fsanitize=cfi-vcall" ]
       if (use_cfi_cast) {
diff --git a/build/config/sanitizers/sanitizers.gni b/build/config/sanitizers/sanitizers.gni
index 40ffb94..ba1aec4 100644
--- a/build/config/sanitizers/sanitizers.gni
+++ b/build/config/sanitizers/sanitizers.gni
@@ -146,9 +146,8 @@ if (use_afl && sanitizer_coverage_flags == "") {
   sanitizer_coverage_flags = "edge,indirect-calls,8bit-counters"
 }
 
-using_sanitizer =
-    is_asan || is_lsan || is_tsan || is_msan || is_ubsan || is_ubsan_null ||
-    is_ubsan_vptr || is_ubsan_security || use_sanitizer_coverage
+using_sanitizer = is_asan || is_lsan || is_tsan || is_msan || is_ubsan ||
+                  is_ubsan_null || is_ubsan_vptr || is_ubsan_security
 
 assert(!using_sanitizer || is_clang,
        "Sanitizers (is_*san) require setting is_clang = true in 'gn args'")
diff --git a/build/config/ui.gni b/build/config/ui.gni
index 849b720..77d98df 100644
--- a/build/config/ui.gni
+++ b/build/config/ui.gni
@@ -2,20 +2,17 @@
 # Use of this source code is governed by a BSD-style license that can be
 # found in the LICENSE file.
 
-# =============================================
-#   PLEASE DO NOT ADD MORE FLAGS TO THIS FILE
-# =============================================
+# This file contains UI-related build flags (see features.gni for Chrome
+# feature-related ones). These should theoretically be moved to the ui
+# directory.
 #
-# These flags are effectively global. Your feature flag should go near the
-# code it controls. Most of these items are here now because they control
-# legacy global #defines passed to the compiler (now replaced with generated
-# buildflag headers -- see //build/buildflag_header.gni).
+# However, today we have many "bad" dependencies on some of these flags from,
+# e.g. base, so they need to be global to match the GYP configuration. Also,
+# anything that needs a grit define must be in either this file or features.gni.
 #
-# These flags are ui-related so should eventually be moved to various places
-# in //ui/*.
-#
-# There is more advice on where to put build flags in the "Build flag" section
-# of //build/config/BUILDCONFIG.gn.
+# PLEASE TRY TO AVOID ADDING FLAGS TO THIS FILE in cases where grit isn't
+# required. See the declare_args block of BUILDCONFIG.gn for advice on how
+# to set up feature flags.
 
 import("//build/config/chromecast_build.gni")
 import("//build/config/features.gni")
@@ -91,8 +88,3 @@ use_atk = is_desktop_linux && use_x11 && use_gconf
 
 use_clipboard_aurax11 =
     (is_desktop_linux && use_aura && use_x11) || enable_clipboard_aurax11
-# =============================================
-#   PLEASE DO NOT ADD MORE FLAGS TO THIS FILE
-# =============================================
-#
-# See comment at the top.
diff --git a/build/gn_migration.gypi b/build/gn_migration.gypi
index 25a61eb..7535ff3 100644
--- a/build/gn_migration.gypi
+++ b/build/gn_migration.gypi
@@ -495,8 +495,6 @@
             '../chrome/chrome.gyp:setup',
             '../chrome/chrome.gyp:setup_unittests',
             '../chrome/installer/mini_installer.gyp:mini_installer',
-            '../chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.gyp:disable_outdated_build_detector',
-            '../chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.gyp:disable_outdated_build_detector_unittests',
             '../chrome_elf/chrome_elf.gyp:chrome_elf_unittests',
             '../chrome_elf/chrome_elf.gyp:dll_hash_main',
             '../components/components.gyp:wifi_test',
diff --git a/build/sanitizers/tsan_suppressions.cc b/build/sanitizers/tsan_suppressions.cc
index 4b27af0..ef7465a 100644
--- a/build/sanitizers/tsan_suppressions.cc
+++ b/build/sanitizers/tsan_suppressions.cc
@@ -270,6 +270,11 @@ char kTSanDefaultSuppressions[] =
 // http://crbug.com/633145
 "race:third_party/libjpeg_turbo/simd/jsimd_x86_64.c\n"
 
+// Intentional test-only race for otherwise untestable code, won't fix.
+// http://crbug.com/634383
+"race:ThreadTest_StartTwiceNonJoinableNotAllowed_Test::TestBody\n"
+"race:ThreadTest_StartWithOptions_NonJoinable_Test::TestBody\n"
+
 // End of suppressions.
 ;  // Please keep this semicolon.
 
diff --git a/build/toolchain/gcc_toolchain.gni b/build/toolchain/gcc_toolchain.gni
index 0045411..10a82bc 100644
--- a/build/toolchain/gcc_toolchain.gni
+++ b/build/toolchain/gcc_toolchain.gni
@@ -73,7 +73,7 @@ import("//build/toolchain/toolchain.gni")
 #      all shared libraries and executables as they are built. The pre-stripped
 #      artifacts will be put in lib.unstripped/ and exe.unstripped/.
 #
-# Optional build argument controls.
+# Optional build argument contols.
 #
 #  - clear_sanitizers
 #      When set to true, is_asan, is_msan, etc.will all be set to false. Often
diff --git a/cc/DEPS b/cc/DEPS
index 3518958..1a32581 100644
--- a/cc/DEPS
+++ b/cc/DEPS
@@ -5,6 +5,7 @@ include_rules = [
   "+gpu/command_buffer/client/gles2_interface_stub.h", # for tests
   "+gpu/command_buffer/client/gpu_memory_buffer_manager.h",
   "+gpu/command_buffer/common/capabilities.h",
+  "+gpu/command_buffer/common/gles2_cmd_format.h",
   "+gpu/command_buffer/common/gpu_memory_allocation.h",
   "+gpu/command_buffer/common/mailbox.h",
   "+gpu/command_buffer/common/mailbox_holder.h",
diff --git a/cc/animation/animation_player.h b/cc/animation/animation_player.h
index 5c4c58e..247b24c 100644
--- a/cc/animation/animation_player.h
+++ b/cc/animation/animation_player.h
@@ -7,6 +7,7 @@
 
 #include <vector>
 
+#include "base/containers/linked_list.h"
 #include "base/macros.h"
 #include "base/memory/ref_counted.h"
 #include "base/time/time.h"
@@ -30,7 +31,8 @@ class ElementAnimations;
 // same-property animations.
 // Each AnimationPlayer has its copy on the impl thread.
 // This is a CC counterpart for blink::AnimationPlayer (in 1:1 relationship).
-class CC_EXPORT AnimationPlayer : public base::RefCounted<AnimationPlayer> {
+class CC_EXPORT AnimationPlayer : public base::RefCounted<AnimationPlayer>,
+                                  public base::LinkNode<AnimationPlayer> {
  public:
   static scoped_refptr<AnimationPlayer> Create(int id);
   scoped_refptr<AnimationPlayer> CreateImplInstance() const;
diff --git a/cc/animation/element_animations.cc b/cc/animation/element_animations.cc
index f75ffbe..708cdee 100644
--- a/cc/animation/element_animations.cc
+++ b/cc/animation/element_animations.cc
@@ -111,15 +111,21 @@ void ElementAnimations::ElementUnregistered(ElementId element_id,
 }
 
 void ElementAnimations::AddPlayer(AnimationPlayer* player) {
-  players_list_->AddObserver(player);
+  players_list_->Append(player);
 }
 
 void ElementAnimations::RemovePlayer(AnimationPlayer* player) {
-  players_list_->RemoveObserver(player);
+  for (PlayersListNode* node = players_list_->head();
+       node != players_list_->end(); node = node->next()) {
+    if (node->value() == player) {
+      node->RemoveFromList();
+      return;
+    }
+  }
 }
 
 bool ElementAnimations::IsEmpty() const {
-  return !players_list_->might_have_observers();
+  return players_list_->empty();
 }
 
 void ElementAnimations::PushPropertiesTo(
@@ -275,7 +281,7 @@ void ElementAnimations::NotifyAnimationFinished(const AnimationEvent& event) {
 
 void ElementAnimations::NotifyAnimationTakeover(const AnimationEvent& event) {
   DCHECK(event.target_property == TargetProperty::SCROLL_OFFSET);
-  if (!IsEmpty()) {
+  if (!players_list_->empty()) {
     std::unique_ptr<AnimationCurve> animation_curve = event.curve->Clone();
     NotifyPlayersAnimationTakeover(event.monotonic_time, event.target_property,
                                    event.animation_start_time,
@@ -1429,32 +1435,33 @@ void ElementAnimations::NotifyPlayersAnimationStarted(
     base::TimeTicks monotonic_time,
     TargetProperty::Type target_property,
     int group) {
-  ElementAnimations::PlayersList::Iterator it(players_list_.get());
-  AnimationPlayer* player;
-  // TODO(crbug.com/634916): Shouldn't manually iterate through the list if
-  // base::ObserverList has a callback mechanism.
-  while ((player = it.GetNext()) != nullptr)
+  for (PlayersListNode* node = players_list_->head();
+       node != players_list_->end(); node = node->next()) {
+    AnimationPlayer* player = node->value();
     player->NotifyAnimationStarted(monotonic_time, target_property, group);
+  }
 }
 
 void ElementAnimations::NotifyPlayersAnimationFinished(
     base::TimeTicks monotonic_time,
     TargetProperty::Type target_property,
     int group) {
-  ElementAnimations::PlayersList::Iterator it(players_list_.get());
-  AnimationPlayer* player;
-  while ((player = it.GetNext()) != nullptr)
+  for (PlayersListNode* node = players_list_->head();
+       node != players_list_->end(); node = node->next()) {
+    AnimationPlayer* player = node->value();
     player->NotifyAnimationFinished(monotonic_time, target_property, group);
+  }
 }
 
 void ElementAnimations::NotifyPlayersAnimationAborted(
     base::TimeTicks monotonic_time,
     TargetProperty::Type target_property,
     int group) {
-  ElementAnimations::PlayersList::Iterator it(players_list_.get());
-  AnimationPlayer* player;
-  while ((player = it.GetNext()) != nullptr)
+  for (PlayersListNode* node = players_list_->head();
+       node != players_list_->end(); node = node->next()) {
+    AnimationPlayer* player = node->value();
     player->NotifyAnimationAborted(monotonic_time, target_property, group);
+  }
 }
 
 void ElementAnimations::NotifyPlayersAnimationTakeover(
@@ -1463,10 +1470,10 @@ void ElementAnimations::NotifyPlayersAnimationTakeover(
     double animation_start_time,
     std::unique_ptr<AnimationCurve> curve) {
   DCHECK(curve);
-  ElementAnimations::PlayersList::Iterator it(players_list_.get());
-  AnimationPlayer* player;
-  while ((player = it.GetNext()) != nullptr) {
+  for (PlayersListNode* node = players_list_->head();
+       node != players_list_->end(); node = node->next()) {
     std::unique_ptr<AnimationCurve> animation_curve = curve->Clone();
+    AnimationPlayer* player = node->value();
     player->NotifyAnimationTakeover(monotonic_time, target_property,
                                     animation_start_time,
                                     std::move(animation_curve));
diff --git a/cc/animation/element_animations.h b/cc/animation/element_animations.h
index 93f4f0e..a465604 100644
--- a/cc/animation/element_animations.h
+++ b/cc/animation/element_animations.h
@@ -9,9 +9,9 @@
 #include <memory>
 #include <vector>
 
+#include "base/containers/linked_list.h"
 #include "base/macros.h"
 #include "base/memory/ref_counted.h"
-#include "base/observer_list.h"
 #include "base/time/time.h"
 #include "cc/animation/animation.h"
 #include "cc/animation/animation_curve.h"
@@ -62,8 +62,9 @@ class CC_EXPORT ElementAnimations : public base::RefCounted<ElementAnimations> {
   void RemovePlayer(AnimationPlayer* player);
   bool IsEmpty() const;
 
-  typedef base::ObserverList<AnimationPlayer> PlayersList;
-  PlayersList& players_list() const { return *players_list_.get(); }
+  typedef base::LinkedList<AnimationPlayer> PlayersList;
+  typedef base::LinkNode<AnimationPlayer> PlayersListNode;
+  const PlayersList& players_list() const { return *players_list_.get(); }
 
   // Ensures that the list of active animations on the main thread and the impl
   // thread are kept in sync. This function does not take ownership of the impl
diff --git a/cc/animation/element_animations_unittest.cc b/cc/animation/element_animations_unittest.cc
index 4085986..e5582b0 100644
--- a/cc/animation/element_animations_unittest.cc
+++ b/cc/animation/element_animations_unittest.cc
@@ -191,11 +191,12 @@ TEST_F(ElementAnimationsTest, AddRemovePlayers) {
   EXPECT_TRUE(element_animations_impl);
 
   int list_size_before = 0;
-  ElementAnimations::PlayersList::Iterator it(
-      &element_animations_impl->players_list());
-  AnimationPlayer* player;
-  while ((player = it.GetNext()) != nullptr) {
-    EXPECT_TRUE(timeline_->GetPlayerById(player->id()));
+  for (const ElementAnimations::PlayersListNode* node =
+           element_animations_impl->players_list().head();
+       node != element_animations_impl->players_list().end();
+       node = node->next()) {
+    const AnimationPlayer* player_impl = node->value();
+    EXPECT_TRUE(timeline_->GetPlayerById(player_impl->id()));
     ++list_size_before;
   }
   EXPECT_EQ(3, list_size_before);
@@ -209,10 +210,12 @@ TEST_F(ElementAnimationsTest, AddRemovePlayers) {
   EXPECT_EQ(element_animations_impl, player_impl_->element_animations());
 
   int list_size_after = 0;
-  it = ElementAnimations::PlayersList::Iterator(
-      &element_animations_impl->players_list());
-  while ((player = it.GetNext()) != nullptr) {
-    EXPECT_TRUE(timeline_->GetPlayerById(player->id()));
+  for (const ElementAnimations::PlayersListNode* node =
+           element_animations_impl->players_list().head();
+       node != element_animations_impl->players_list().end();
+       node = node->next()) {
+    const AnimationPlayer* player_impl = node->value();
+    EXPECT_TRUE(timeline_->GetPlayerById(player_impl->id()));
     ++list_size_after;
   }
   EXPECT_EQ(2, list_size_after);
@@ -297,72 +300,6 @@ TEST_F(ElementAnimationsTest,
                           ->GetValue(base::TimeDelta()));
 }
 
-class TestAnimationDelegateThatDestroysPlayer : public TestAnimationDelegate {
- public:
-  TestAnimationDelegateThatDestroysPlayer() {}
-
-  void NotifyAnimationStarted(base::TimeTicks monotonic_time,
-                              TargetProperty::Type target_property,
-                              int group) override {
-    TestAnimationDelegate::NotifyAnimationStarted(monotonic_time,
-                                                  target_property, group);
-    // Detaching player from the timeline ensures that the timeline doesn't hold
-    // a reference to the player and the player is destroyed.
-    timeline_->DetachPlayer(player_);
-  };
-
-  void setTimelineAndPlayer(scoped_refptr<AnimationTimeline> timeline,
-                            scoped_refptr<AnimationPlayer> player) {
-    timeline_ = timeline;
-    player_ = player;
-  }
-
- private:
-  scoped_refptr<AnimationTimeline> timeline_;
-  scoped_refptr<AnimationPlayer> player_;
-};
-
-// Test that we don't crash if a player is deleted while ElementAnimations is
-// iterating through the list of players (see crbug.com/631052). This test
-// passes if it doesn't crash.
-TEST_F(ElementAnimationsTest, AddedPlayerIsDestroyed) {
-  CreateTestLayer(true, false);
-  AttachTimelinePlayerLayer();
-  CreateImplTimelineAndPlayer();
-
-  scoped_refptr<ElementAnimations> animations = element_animations();
-  scoped_refptr<ElementAnimations> animations_impl = element_animations_impl();
-
-  TestAnimationDelegateThatDestroysPlayer delegate;
-  {
-    scoped_refptr<AnimationPlayer> player =
-        AnimationPlayer::Create(AnimationIdProvider::NextPlayerId());
-    delegate.setTimelineAndPlayer(timeline_, player);
-
-    timeline_->AttachPlayer(player);
-    player->AttachElement(element_id_);
-    player->set_animation_delegate(&delegate);
-  }
-
-  int animation_id = AddOpacityTransitionToElementAnimations(
-      animations.get(), 1.0, 0.f, 1.f, false);
-
-  animations->PushPropertiesTo(animations_impl.get());
-  animations_impl->ActivateAnimations();
-  EXPECT_TRUE(animations_impl->GetAnimationById(animation_id));
-
-  animations_impl->Animate(kInitialTickTime);
-
-  auto events = host_impl_->CreateEvents();
-  animations_impl->UpdateState(true, events.get());
-  EXPECT_EQ(1u, events->events_.size());
-  EXPECT_EQ(AnimationEvent::STARTED, events->events_[0].type);
-
-  // The actual detachment happens here, inside the callback
-  animations->NotifyAnimationStarted(events->events_[0]);
-  EXPECT_TRUE(delegate.started());
-}
-
 // If an animation is started on the impl thread before it is ticked on the main
 // thread, we must be sure to respect the synchronized start time.
 TEST_F(ElementAnimationsTest, DoNotClobberStartTimes) {
diff --git a/cc/blink/web_content_layer_impl.cc b/cc/blink/web_content_layer_impl.cc
index cf6e344..c5068f1 100644
--- a/cc/blink/web_content_layer_impl.cc
+++ b/cc/blink/web_content_layer_impl.cc
@@ -75,7 +75,7 @@ WebContentLayerImpl::PaintContentsToDisplayList(
   settings.use_cached_picture = UseCachedPictureRaster();
 
   scoped_refptr<cc::DisplayItemList> display_list =
-      cc::DisplayItemList::Create(PaintableRegion(), settings);
+      cc::DisplayItemList::Create(settings);
   if (client_) {
     WebDisplayItemListImpl list(display_list.get());
     client_->paintContents(&list, PaintingControlToWeb(painting_control));
diff --git a/cc/blink/web_display_item_list_impl.cc b/cc/blink/web_display_item_list_impl.cc
index c524008..7685a4f 100644
--- a/cc/blink/web_display_item_list_impl.cc
+++ b/cc/blink/web_display_item_list_impl.cc
@@ -32,8 +32,7 @@ namespace {
 scoped_refptr<cc::DisplayItemList> CreateUncachedDisplayItemListForBlink() {
   cc::DisplayItemListSettings settings;
   settings.use_cached_picture = false;
-  gfx::Rect layer_rect;
-  return cc::DisplayItemList::Create(layer_rect, settings);
+  return cc::DisplayItemList::Create(settings);
 }
 
 }  // namespace
@@ -50,13 +49,8 @@ WebDisplayItemListImpl::WebDisplayItemListImpl(
 void WebDisplayItemListImpl::appendDrawingItem(
     const blink::WebRect& visual_rect,
     sk_sp<const SkPicture> picture) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::DrawingDisplayItem>(
-        visual_rect, std::move(picture));
-  } else {
-    cc::DrawingDisplayItem item(std::move(picture));
-    display_item_list_->RasterIntoCanvas(item);
-  }
+  display_item_list_->CreateAndAppendItem<cc::DrawingDisplayItem>(
+      visual_rect, std::move(picture));
 }
 
 void WebDisplayItemListImpl::appendClipItem(
@@ -68,23 +62,13 @@ void WebDisplayItemListImpl::appendClipItem(
     rounded_rects.push_back(rounded_clip_rects[i]);
   }
   bool antialias = true;
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::ClipDisplayItem>(
-        visual_rect, clip_rect, rounded_rects, antialias);
-  } else {
-    cc::ClipDisplayItem item(clip_rect, rounded_rects, antialias);
-    display_item_list_->RasterIntoCanvas(item);
-  }
+  display_item_list_->CreateAndAppendItem<cc::ClipDisplayItem>(
+      visual_rect, clip_rect, rounded_rects, antialias);
 }
 
 void WebDisplayItemListImpl::appendEndClipItem(
     const blink::WebRect& visual_rect) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::EndClipDisplayItem>(
-        visual_rect);
-  } else {
-    display_item_list_->RasterIntoCanvas(cc::EndClipDisplayItem());
-  }
+  display_item_list_->CreateAndAppendItem<cc::EndClipDisplayItem>(visual_rect);
 }
 
 void WebDisplayItemListImpl::appendClipPathItem(
@@ -92,45 +76,27 @@ void WebDisplayItemListImpl::appendClipPathItem(
     const SkPath& clip_path,
     SkRegion::Op clip_op,
     bool antialias) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::ClipPathDisplayItem>(
-        visual_rect, clip_path, clip_op, antialias);
-  } else {
-    cc::ClipPathDisplayItem item(clip_path, clip_op, antialias);
-    display_item_list_->RasterIntoCanvas(item);
-  }
+  display_item_list_->CreateAndAppendItem<cc::ClipPathDisplayItem>(
+      visual_rect, clip_path, clip_op, antialias);
 }
 
 void WebDisplayItemListImpl::appendEndClipPathItem(
     const blink::WebRect& visual_rect) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::EndClipPathDisplayItem>(
-        visual_rect);
-  } else {
-    display_item_list_->RasterIntoCanvas(cc::EndClipPathDisplayItem());
-  }
+  display_item_list_->CreateAndAppendItem<cc::EndClipPathDisplayItem>(
+      visual_rect);
 }
 
 void WebDisplayItemListImpl::appendFloatClipItem(
     const blink::WebRect& visual_rect,
     const blink::WebFloatRect& clip_rect) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::FloatClipDisplayItem>(
-        visual_rect, clip_rect);
-  } else {
-    cc::FloatClipDisplayItem item(clip_rect);
-    display_item_list_->RasterIntoCanvas(item);
-  }
+  display_item_list_->CreateAndAppendItem<cc::FloatClipDisplayItem>(visual_rect,
+                                                                    clip_rect);
 }
 
 void WebDisplayItemListImpl::appendEndFloatClipItem(
     const blink::WebRect& visual_rect) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::EndFloatClipDisplayItem>(
-        visual_rect);
-  } else {
-    display_item_list_->RasterIntoCanvas(cc::EndFloatClipDisplayItem());
-  }
+  display_item_list_->CreateAndAppendItem<cc::EndFloatClipDisplayItem>(
+      visual_rect);
 }
 
 void WebDisplayItemListImpl::appendTransformItem(
@@ -139,23 +105,14 @@ void WebDisplayItemListImpl::appendTransformItem(
   gfx::Transform transform(gfx::Transform::kSkipInitialization);
   transform.matrix() = matrix;
 
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::TransformDisplayItem>(
-        visual_rect, transform);
-  } else {
-    cc::TransformDisplayItem item(transform);
-    display_item_list_->RasterIntoCanvas(item);
-  }
+  display_item_list_->CreateAndAppendItem<cc::TransformDisplayItem>(visual_rect,
+                                                                    transform);
 }
 
 void WebDisplayItemListImpl::appendEndTransformItem(
     const blink::WebRect& visual_rect) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::EndTransformDisplayItem>(
-        visual_rect);
-  } else {
-    display_item_list_->RasterIntoCanvas(cc::EndTransformDisplayItem());
-  }
+  display_item_list_->CreateAndAppendItem<cc::EndTransformDisplayItem>(
+      visual_rect);
 }
 
 void WebDisplayItemListImpl::appendCompositingItem(
@@ -170,49 +127,29 @@ void WebDisplayItemListImpl::appendCompositingItem(
   // value, but that breaks slimming paint reftests.
 
   const bool kLcdTextRequiresOpaqueLayer = true;
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::CompositingDisplayItem>(
-        visual_rect, static_cast<uint8_t>(gfx::ToFlooredInt(255 * opacity)),
-        xfermode, bounds, sk_ref_sp(color_filter), kLcdTextRequiresOpaqueLayer);
-  } else {
-    cc::CompositingDisplayItem item(
-        static_cast<uint8_t>(gfx::ToFlooredInt(255 * opacity)), xfermode,
-        bounds, sk_ref_sp(color_filter), kLcdTextRequiresOpaqueLayer);
-    display_item_list_->RasterIntoCanvas(item);
-  }
+  display_item_list_->CreateAndAppendItem<cc::CompositingDisplayItem>(
+      visual_rect, static_cast<uint8_t>(gfx::ToFlooredInt(255 * opacity)),
+      xfermode, bounds, sk_ref_sp(color_filter), kLcdTextRequiresOpaqueLayer);
 }
 
 void WebDisplayItemListImpl::appendEndCompositingItem(
     const blink::WebRect& visual_rect) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::EndCompositingDisplayItem>(
-        visual_rect);
-  } else {
-    display_item_list_->RasterIntoCanvas(cc::EndCompositingDisplayItem());
-  }
+  display_item_list_->CreateAndAppendItem<cc::EndCompositingDisplayItem>(
+      visual_rect);
 }
 
 void WebDisplayItemListImpl::appendFilterItem(
     const blink::WebRect& visual_rect,
     const cc::FilterOperations& filters,
     const blink::WebFloatRect& bounds) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::FilterDisplayItem>(
-        visual_rect, filters, bounds);
-  } else {
-    cc::FilterDisplayItem item(filters, bounds);
-    display_item_list_->RasterIntoCanvas(item);
-  }
+  display_item_list_->CreateAndAppendItem<cc::FilterDisplayItem>(
+      visual_rect, filters, bounds);
 }
 
 void WebDisplayItemListImpl::appendEndFilterItem(
     const blink::WebRect& visual_rect) {
-  if (display_item_list_->RetainsIndividualDisplayItems()) {
-    display_item_list_->CreateAndAppendItem<cc::EndFilterDisplayItem>(
-        visual_rect);
-  } else {
-    display_item_list_->RasterIntoCanvas(cc::EndFilterDisplayItem());
-  }
+  display_item_list_->CreateAndAppendItem<cc::EndFilterDisplayItem>(
+      visual_rect);
 }
 
 void WebDisplayItemListImpl::appendScrollItem(
@@ -221,7 +158,8 @@ void WebDisplayItemListImpl::appendScrollItem(
     ScrollContainerId) {
   SkMatrix44 matrix(SkMatrix44::kUninitialized_Constructor);
   matrix.setTranslate(-scroll_offset.width, -scroll_offset.height, 0);
-  // TODO(wkorman): Should we translate the visual rect as well?
+  // TODO(wkorman): http://crbug.com/633636 Should we translate the visual rect
+  // as well? Create a test case and investigate.
   appendTransformItem(visual_rect, matrix);
 }
 
diff --git a/cc/debug/rasterize_and_record_benchmark.cc b/cc/debug/rasterize_and_record_benchmark.cc
index 5babc0e..4e40132 100644
--- a/cc/debug/rasterize_and_record_benchmark.cc
+++ b/cc/debug/rasterize_and_record_benchmark.cc
@@ -161,7 +161,7 @@ void RasterizeAndRecordBenchmark::RunOnLayer(PictureLayer* layer) {
         if (display_list->ShouldBeAnalyzedForSolidColor()) {
           gfx::Size layer_size = layer->paint_properties().bounds;
           skia::AnalysisCanvas canvas(layer_size.width(), layer_size.height());
-          display_list->Raster(&canvas, nullptr, gfx::Rect(), 1.f);
+          display_list->Raster(&canvas, nullptr, gfx::Rect(layer_size), 1.f);
         }
 
         if (memory_used) {
diff --git a/cc/debug/rasterize_and_record_benchmark.h b/cc/debug/rasterize_and_record_benchmark.h
index f68b566..f52b838 100644
--- a/cc/debug/rasterize_and_record_benchmark.h
+++ b/cc/debug/rasterize_and_record_benchmark.h
@@ -16,7 +16,6 @@
 #include "base/time/time.h"
 #include "cc/debug/micro_benchmark_controller.h"
 #include "cc/playback/recording_source.h"
-#include "ui/gfx/geometry/rect.h"
 
 namespace base {
 class DictionaryValue;
@@ -26,6 +25,7 @@ namespace cc {
 
 class LayerTreeHost;
 class Layer;
+
 class RasterizeAndRecordBenchmark : public MicroBenchmark {
  public:
   explicit RasterizeAndRecordBenchmark(
diff --git a/cc/layers/empty_content_layer_client.cc b/cc/layers/empty_content_layer_client.cc
index 1eac1a1..982e8f0 100644
--- a/cc/layers/empty_content_layer_client.cc
+++ b/cc/layers/empty_content_layer_client.cc
@@ -31,7 +31,7 @@ gfx::Rect EmptyContentLayerClient::PaintableRegion() {
 scoped_refptr<DisplayItemList>
 EmptyContentLayerClient::PaintContentsToDisplayList(
     PaintingControlSetting painting_status) {
-  return DisplayItemList::Create(gfx::Rect(), DisplayItemListSettings());
+  return DisplayItemList::Create(DisplayItemListSettings());
 }
 
 bool EmptyContentLayerClient::FillsBoundsCompletely() const {
diff --git a/cc/layers/picture_image_layer.cc b/cc/layers/picture_image_layer.cc
index 4971e48..f854b0d 100644
--- a/cc/layers/picture_image_layer.cc
+++ b/cc/layers/picture_image_layer.cc
@@ -66,7 +66,7 @@ scoped_refptr<DisplayItemList> PictureImageLayer::PaintContentsToDisplayList(
   settings.use_cached_picture =
       layer_tree_host()->settings().use_cached_picture_raster;
   scoped_refptr<DisplayItemList> display_list =
-      DisplayItemList::Create(PaintableRegion(), settings);
+      DisplayItemList::Create(settings);
 
   SkPictureRecorder recorder;
   SkCanvas* canvas =
diff --git a/cc/layers/picture_layer_impl_unittest.cc b/cc/layers/picture_layer_impl_unittest.cc
index a35faf5..3e0d734 100644
--- a/cc/layers/picture_layer_impl_unittest.cc
+++ b/cc/layers/picture_layer_impl_unittest.cc
@@ -270,7 +270,7 @@ class PictureLayerImplTest : public TestLayerTreeHostBase {
   void SetInitialDeviceScaleFactor(float device_scale_factor) {
     // Device scale factor is a per-tree property. However, tests can't directly
     // set the pending tree's device scale factor before the pending tree is
-    // created, and setting it after SetupPendingTreeis too late, since
+    // created, and setting it after SetupPendingTree is too late, since
     // draw properties will already have been updated on the tree. To handle
     // this, we initially set only the active tree's device scale factor, and we
     // copy this over to the pending tree inside SetupPendingTree.
diff --git a/cc/output/gl_renderer.cc b/cc/output/gl_renderer.cc
index e760ac0..75a3db5 100644
--- a/cc/output/gl_renderer.cc
+++ b/cc/output/gl_renderer.cc
@@ -47,6 +47,7 @@
 #include "gpu/GLES2/gl2extchromium.h"
 #include "gpu/command_buffer/client/context_support.h"
 #include "gpu/command_buffer/client/gles2_interface.h"
+#include "gpu/command_buffer/common/gles2_cmd_format.h"
 #include "gpu/command_buffer/common/gpu_memory_allocation.h"
 #include "skia/ext/texture_handle.h"
 #include "third_party/skia/include/core/SkBitmap.h"
diff --git a/cc/playback/discardable_image_map_unittest.cc b/cc/playback/discardable_image_map_unittest.cc
index 6510939..9cdb9e2 100644
--- a/cc/playback/discardable_image_map_unittest.cc
+++ b/cc/playback/discardable_image_map_unittest.cc
@@ -94,7 +94,7 @@ TEST_F(DiscardableImageMapTest, GetDiscardableImagesInRectTest) {
   {
     DiscardableImageMap::ScopedMetadataGenerator generator(&image_map,
                                                            visible_rect.size());
-    display_list->Raster(generator.canvas(), nullptr, visible_rect, 1.f);
+    display_list->Raster(generator.canvas(), nullptr, gfx::Rect(), 1.f);
   }
 
   for (int y = 0; y < 4; ++y) {
@@ -167,7 +167,7 @@ TEST_F(DiscardableImageMapTest, GetDiscardableImagesInRectNonZeroLayer) {
   {
     DiscardableImageMap::ScopedMetadataGenerator generator(&image_map,
                                                            layer_size);
-    display_list->Raster(generator.canvas(), nullptr, visible_rect, 1.f);
+    display_list->Raster(generator.canvas(), nullptr, gfx::Rect(), 1.f);
   }
 
   for (int y = 0; y < 4; ++y) {
@@ -263,7 +263,7 @@ TEST_F(DiscardableImageMapTest, GetDiscardableImagesInRectOnePixelQuery) {
   {
     DiscardableImageMap::ScopedMetadataGenerator generator(&image_map,
                                                            visible_rect.size());
-    display_list->Raster(generator.canvas(), nullptr, visible_rect, 1.f);
+    display_list->Raster(generator.canvas(), nullptr, gfx::Rect(), 1.f);
   }
 
   for (int y = 0; y < 4; ++y) {
@@ -302,7 +302,7 @@ TEST_F(DiscardableImageMapTest, GetDiscardableImagesInRectMassiveImage) {
   {
     DiscardableImageMap::ScopedMetadataGenerator generator(&image_map,
                                                            visible_rect.size());
-    display_list->Raster(generator.canvas(), nullptr, visible_rect, 1.f);
+    display_list->Raster(generator.canvas(), nullptr, gfx::Rect(), 1.f);
   }
   std::vector<PositionDrawImage> images =
       GetDiscardableImagesInRect(image_map, gfx::Rect(0, 0, 1, 1));
diff --git a/cc/playback/display_item_list.cc b/cc/playback/display_item_list.cc
index 24736f4..ea4c086 100644
--- a/cc/playback/display_item_list.cc
+++ b/cc/playback/display_item_list.cc
@@ -26,6 +26,7 @@
 #include "third_party/skia/include/core/SkPictureRecorder.h"
 #include "third_party/skia/include/utils/SkPictureUtils.h"
 #include "ui/gfx/geometry/rect.h"
+#include "ui/gfx/geometry/rect_conversions.h"
 #include "ui/gfx/skia_util.h"
 
 namespace cc {
@@ -43,41 +44,42 @@ bool DisplayItemsTracingEnabled() {
   return tracing_enabled;
 }
 
+bool GetCanvasClipBounds(SkCanvas* canvas, gfx::Rect* clip_bounds) {
+  SkRect canvas_clip_bounds;
+  if (!canvas->getClipBounds(&canvas_clip_bounds))
+    return false;
+  *clip_bounds = ToEnclosingRect(gfx::SkRectToRectF(canvas_clip_bounds));
+  return true;
+}
+
 const int kDefaultNumDisplayItemsToReserve = 100;
 
 }  // namespace
 
-DisplayItemList::Inputs::Inputs(gfx::Rect layer_rect,
-                                const DisplayItemListSettings& settings)
+DisplayItemList::Inputs::Inputs(const DisplayItemListSettings& settings)
     : items(LargestDisplayItemSize(),
             LargestDisplayItemSize() * kDefaultNumDisplayItemsToReserve),
-      settings(settings),
-      layer_rect(layer_rect),
-      is_suitable_for_gpu_rasterization(true) {}
+      settings(settings) {}
 
 DisplayItemList::Inputs::~Inputs() {}
 
 scoped_refptr<DisplayItemList> DisplayItemList::Create(
-    const gfx::Rect& layer_rect,
     const DisplayItemListSettings& settings) {
-  return make_scoped_refptr(new DisplayItemList(
-      layer_rect, settings,
-      !settings.use_cached_picture || DisplayItemsTracingEnabled()));
+  return make_scoped_refptr(new DisplayItemList(settings));
 }
 
 scoped_refptr<DisplayItemList> DisplayItemList::CreateFromProto(
     const proto::DisplayItemList& proto,
     ClientPictureCache* client_picture_cache,
     std::vector<uint32_t>* used_engine_picture_ids) {
-  gfx::Rect layer_rect = ProtoToRect(proto.layer_rect());
   scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(ProtoToRect(proto.layer_rect()),
-                              DisplayItemListSettings(proto.settings()));
+      DisplayItemList::Create(DisplayItemListSettings(proto.settings()));
 
   for (int i = 0; i < proto.items_size(); i++) {
     const proto::DisplayItem& item_proto = proto.items(i);
+    const gfx::Rect visual_rect = ProtoToRect(proto.visual_rects(i));
     DisplayItemProtoFactory::AllocateAndConstruct(
-        layer_rect, list.get(), item_proto, client_picture_cache,
+        visual_rect, list.get(), item_proto, client_picture_cache,
         used_engine_picture_ids);
   }
 
@@ -86,23 +88,8 @@ scoped_refptr<DisplayItemList> DisplayItemList::CreateFromProto(
   return list;
 }
 
-DisplayItemList::DisplayItemList(gfx::Rect layer_rect,
-                                 const DisplayItemListSettings& settings,
-                                 bool retain_individual_display_items)
-    : retain_individual_display_items_(retain_individual_display_items),
-      approximate_op_count_(0),
-      picture_memory_usage_(0),
-      inputs_(layer_rect, settings) {
-  if (inputs_.settings.use_cached_picture) {
-    SkRTreeFactory factory;
-    recorder_.reset(new SkPictureRecorder());
-
-    SkCanvas* canvas = recorder_->beginRecording(
-        inputs_.layer_rect.width(), inputs_.layer_rect.height(), &factory);
-    canvas->translate(-inputs_.layer_rect.x(), -inputs_.layer_rect.y());
-    canvas->clipRect(gfx::RectToSkRect(inputs_.layer_rect));
-  }
-}
+DisplayItemList::DisplayItemList(const DisplayItemListSettings& settings)
+    : inputs_(settings) {}
 
 DisplayItemList::~DisplayItemList() {
 }
@@ -110,14 +97,18 @@ DisplayItemList::~DisplayItemList() {
 void DisplayItemList::ToProtobuf(proto::DisplayItemList* proto) {
   // The flattened SkPicture approach is going away, and the proto
   // doesn't currently support serializing that flattened picture.
-  DCHECK(retain_individual_display_items_);
-
-  RectToProto(inputs_.layer_rect, proto->mutable_layer_rect());
   inputs_.settings.ToProtobuf(proto->mutable_settings());
 
   DCHECK_EQ(0, proto->items_size());
-  for (const auto& item : inputs_.items)
+  DCHECK_EQ(0, proto->visual_rects_size());
+  DCHECK(inputs_.items.size() == inputs_.visual_rects.size())
+      << "items.size() " << inputs_.items.size() << " visual_rects.size() "
+      << inputs_.visual_rects.size();
+  int i = 0;
+  for (const auto& item : inputs_.items) {
+    RectToProto(inputs_.visual_rects[i++], proto->add_visual_rects());
     item.ToProtobuf(proto->add_items());
+  }
 }
 
 void DisplayItemList::Raster(SkCanvas* canvas,
@@ -125,7 +116,6 @@ void DisplayItemList::Raster(SkCanvas* canvas,
                              const gfx::Rect& canvas_target_playback_rect,
                              float contents_scale) const {
   canvas->save();
-
   if (!canvas_target_playback_rect.IsEmpty()) {
     // canvas_target_playback_rect is specified in device space. We can't
     // use clipRect because canvas CTM will be applied on it. Use clipRegion
@@ -134,7 +124,6 @@ void DisplayItemList::Raster(SkCanvas* canvas,
     device_clip.setRect(gfx::RectToSkIRect(canvas_target_playback_rect));
     canvas->clipRegion(device_clip);
   }
-
   canvas->scale(contents_scale, contents_scale);
   Raster(canvas, callback);
   canvas->restore();
@@ -142,113 +131,67 @@ void DisplayItemList::Raster(SkCanvas* canvas,
 
 void DisplayItemList::Raster(SkCanvas* canvas,
                              SkPicture::AbortCallback* callback) const {
-  if (!inputs_.settings.use_cached_picture) {
-    for (const auto& item : inputs_.items)
-      item.Raster(canvas, callback);
-  } else {
-    DCHECK(picture_);
-
-    canvas->save();
-    canvas->translate(inputs_.layer_rect.x(), inputs_.layer_rect.y());
-    if (callback) {
-      // If we have a callback, we need to call |draw()|, |drawPicture()|
-      // doesn't take a callback.  This is used by |AnalysisCanvas| to early
-      // out.
-      picture_->playback(canvas, callback);
-    } else {
-      // Prefer to call |drawPicture()| on the canvas since it could place the
-      // entire picture on the canvas instead of parsing the skia operations.
-      canvas->drawPicture(picture_.get());
-    }
-    canvas->restore();
-  }
-}
+  gfx::Rect canvas_playback_rect;
+  if (!GetCanvasClipBounds(canvas, &canvas_playback_rect))
+    return;
 
-void DisplayItemList::ProcessAppendedItem(const DisplayItem* item) {
-  if (inputs_.settings.use_cached_picture) {
-    DCHECK(recorder_);
-    item->Raster(recorder_->getRecordingCanvas(), nullptr);
-  }
-  if (!retain_individual_display_items_) {
-    inputs_.items.Clear();
+  std::vector<size_t> indices;
+  rtree_.Search(canvas_playback_rect, &indices);
+  for (size_t index : indices) {
+    inputs_.items[index].Raster(canvas, callback);
+    // We use a callback during solid color analysis on the compositor thread to
+    // break out early. Since we're handling a sequence of pictures via rtree
+    // query results ourselves, we have to respect the callback and early out.
+    if (callback && callback->abort())
+      break;
   }
 }
 
-void DisplayItemList::RasterIntoCanvas(const DisplayItem& item) {
-  DCHECK(recorder_);
-  DCHECK(!retain_individual_display_items_);
-
-  item.Raster(recorder_->getRecordingCanvas(), nullptr);
-}
-
-bool DisplayItemList::RetainsIndividualDisplayItems() const {
-  return retain_individual_display_items_;
-}
-
 void DisplayItemList::Finalize() {
   TRACE_EVENT0("cc", "DisplayItemList::Finalize");
-  // TODO(dtrainor): Need to deal with serializing visual_rects_.
+  // TODO(dtrainor): Need to deal with serializing inputs_.visual_rects.
   // http://crbug.com/568757.
-  DCHECK(!retain_individual_display_items_ ||
-         inputs_.items.size() == inputs_.visual_rects.size())
+  DCHECK(inputs_.items.size() == inputs_.visual_rects.size())
       << "items.size() " << inputs_.items.size() << " visual_rects.size() "
       << inputs_.visual_rects.size();
-
-  // TODO(vmpstr): Build and make use of an RTree from the visual
-  // rects. For now we just clear them out since we won't ever need
-  // them to stick around post-Finalize. http://crbug.com/527245
-  // This clears both the vector and the vector's capacity, since visual_rects_
-  // won't be used anymore.
-  std::vector<gfx::Rect>().swap(inputs_.visual_rects);
-
-  if (inputs_.settings.use_cached_picture) {
-    // Convert to an SkPicture for faster rasterization.
-    DCHECK(inputs_.settings.use_cached_picture);
-    DCHECK(!picture_);
-    picture_ = recorder_->finishRecordingAsPicture();
-    DCHECK(picture_);
-    picture_memory_usage_ =
-        SkPictureUtils::ApproximateBytesUsed(picture_.get());
-    recorder_.reset();
-  }
+  rtree_.Build(inputs_.visual_rects);
+
+  // TODO(wkorman): Restore the below, potentially with a switch to allow
+  // clearing visual rects except for Blimp engine. http://crbug.com/633750
+  // if (!retain_visual_rects_)
+  //   // This clears both the vector and the vector's capacity, since
+  //   // visual_rects won't be used anymore.
+  //   std::vector<gfx::Rect>().swap(inputs_.visual_rects);
 }
 
 bool DisplayItemList::IsSuitableForGpuRasterization() const {
-  return inputs_.is_suitable_for_gpu_rasterization;
+  // TODO(wkorman): This is more permissive than Picture's implementation, since
+  // none of the items might individually trigger a veto even though they
+  // collectively have enough "bad" operations that a corresponding Picture
+  // would get vetoed. See crbug.com/513016.
+  return inputs_.all_items_are_suitable_for_gpu_rasterization;
 }
 
 int DisplayItemList::ApproximateOpCount() const {
-  if (retain_individual_display_items_)
-    return approximate_op_count_;
-  return picture_ ? picture_->approximateOpCount() : 0;
+  return approximate_op_count_;
 }
 
 size_t DisplayItemList::ApproximateMemoryUsage() const {
-  // We double-count in this case. Produce zero to avoid being misleading.
-  if (inputs_.settings.use_cached_picture && retain_individual_display_items_)
-    return 0;
-
-  DCHECK(!inputs_.settings.use_cached_picture || picture_);
-
   size_t memory_usage = sizeof(*this);
 
   size_t external_memory_usage = 0;
-  if (retain_individual_display_items_) {
-    // Warning: this double-counts SkPicture data if use_cached_picture is
-    // also true.
-    for (const auto& item : inputs_.items) {
-      external_memory_usage += item.ExternalMemoryUsage();
-    }
+  // Warning: this double-counts SkPicture data if use_cached_picture is
+  // also true.
+  for (const auto& item : inputs_.items) {
+    external_memory_usage += item.ExternalMemoryUsage();
   }
 
   // Memory outside this class due to |items_|.
   memory_usage += inputs_.items.GetCapacityInBytes() + external_memory_usage;
 
-  // Memory outside this class due to |picture|.
-  memory_usage += picture_memory_usage_;
-
   // TODO(jbroman): Does anything else owned by this class substantially
   // contribute to memory usage?
+  // TODO(vmpstr): Probably DiscardableImageMap is worth counting here.
 
   return memory_usage;
 }
@@ -275,22 +218,19 @@ DisplayItemList::AsValue(bool include_items) const {
     }
     state->EndArray();  // "items".
   }
-  state->SetValue("layer_rect", MathUtil::AsValue(inputs_.layer_rect));
   state->EndDictionary();  // "params".
 
-  if (!inputs_.layer_rect.IsEmpty()) {
-    SkPictureRecorder recorder;
-    SkCanvas* canvas = recorder.beginRecording(inputs_.layer_rect.width(),
-                                               inputs_.layer_rect.height());
-    canvas->translate(-inputs_.layer_rect.x(), -inputs_.layer_rect.y());
-    canvas->clipRect(gfx::RectToSkRect(inputs_.layer_rect));
-    Raster(canvas, NULL, gfx::Rect(), 1.f);
-    sk_sp<SkPicture> picture = recorder.finishRecordingAsPicture();
-
-    std::string b64_picture;
-    PictureDebugUtil::SerializeAsBase64(picture.get(), &b64_picture);
-    state->SetString("skp64", b64_picture);
-  }
+  SkPictureRecorder recorder;
+  gfx::Rect bounds = rtree_.GetBounds();
+  SkCanvas* canvas = recorder.beginRecording(bounds.width(), bounds.height());
+  canvas->translate(-bounds.x(), -bounds.y());
+  canvas->clipRect(gfx::RectToSkRect(bounds));
+  Raster(canvas, nullptr, gfx::Rect(), 1.f);
+  sk_sp<SkPicture> picture = recorder.finishRecordingAsPicture();
+
+  std::string b64_picture;
+  PictureDebugUtil::SerializeAsBase64(picture.get(), &b64_picture);
+  state->SetString("skp64", b64_picture);
 
   return std::move(state);
 }
@@ -308,19 +248,11 @@ void DisplayItemList::EmitTraceSnapshot() const {
 void DisplayItemList::GenerateDiscardableImagesMetadata() {
   // This should be only called once, and only after CreateAndCacheSkPicture.
   DCHECK(image_map_.empty());
-  DCHECK(!inputs_.settings.use_cached_picture || picture_);
-  if (inputs_.settings.use_cached_picture && !picture_->willPlayBackBitmaps())
-    return;
 
-  // The cached picture is translated by -layer_rect_.origin during record,
-  // so we need to offset that back in order to get right positioning for
-  // images.
+  gfx::Rect bounds = rtree_.GetBounds();
   DiscardableImageMap::ScopedMetadataGenerator generator(
-      &image_map_,
-      gfx::Size(inputs_.layer_rect.right(), inputs_.layer_rect.bottom()));
-  Raster(generator.canvas(), nullptr,
-         gfx::Rect(inputs_.layer_rect.right(), inputs_.layer_rect.bottom()),
-         1.f);
+      &image_map_, gfx::Size(bounds.right(), bounds.bottom()));
+  Raster(generator.canvas(), nullptr, gfx::Rect(), 1.f);
 }
 
 void DisplayItemList::GetDiscardableImagesInRect(
diff --git a/cc/playback/display_item_list.h b/cc/playback/display_item_list.h
index 402e73f..87a98fc 100644
--- a/cc/playback/display_item_list.h
+++ b/cc/playback/display_item_list.h
@@ -16,11 +16,13 @@
 #include "base/trace_event/trace_event.h"
 #include "cc/base/cc_export.h"
 #include "cc/base/contiguous_container.h"
+#include "cc/base/rtree.h"
 #include "cc/playback/discardable_image_map.h"
 #include "cc/playback/display_item.h"
 #include "cc/playback/display_item_list_settings.h"
 #include "third_party/skia/include/core/SkPicture.h"
 #include "ui/gfx/geometry/rect.h"
+#include "ui/gfx/geometry/rect_conversions.h"
 
 class SkCanvas;
 class SkPictureRecorder;
@@ -37,13 +39,8 @@ class DisplayItemList;
 class CC_EXPORT DisplayItemList
     : public base::RefCountedThreadSafe<DisplayItemList> {
  public:
-  // Creates a display item list. If picture caching is used, then layer_rect
-  // specifies the cull rect of the display item list (the picture will not
-  // exceed this rect). If picture caching is not used, then the given rect can
-  // be empty.
-  // TODO(vmpstr): Maybe this cull rect can be part of the settings instead.
+  // Creates a display item list.
   static scoped_refptr<DisplayItemList> Create(
-      const gfx::Rect& layer_rect,
       const DisplayItemListSettings& settings);
 
   // Creates a DisplayItemList from a Protobuf.
@@ -65,11 +62,6 @@ class CC_EXPORT DisplayItemList
 
   void Raster(SkCanvas* canvas, SkPicture::AbortCallback* callback) const;
 
-  // This is a fast path for use only if canvas_ is set and
-  // retain_individual_display_items_ is false. This method also updates
-  // approximate_op_count_.
-  void RasterIntoCanvas(const DisplayItem& display_item);
-
   // Because processing happens in this function, all the set up for
   // this item should be done via the args, which is why the return
   // type needs to be const, to prevent set-after-processing mistakes.
@@ -80,7 +72,6 @@ class CC_EXPORT DisplayItemList
     auto* item = &inputs_.items.AllocateAndConstruct<DisplayItemType>(
         std::forward<Args>(args)...);
     approximate_op_count_ += item->ApproximateOpCount();
-    ProcessAppendedItem(item);
     return *item;
   }
 
@@ -89,15 +80,13 @@ class CC_EXPORT DisplayItemList
   void Finalize();
 
   void SetIsSuitableForGpuRasterization(bool is_suitable) {
-    inputs_.is_suitable_for_gpu_rasterization = is_suitable;
+    inputs_.all_items_are_suitable_for_gpu_rasterization = is_suitable;
   }
   bool IsSuitableForGpuRasterization() const;
   int ApproximateOpCount() const;
   size_t ApproximateMemoryUsage() const;
   bool ShouldBeAnalyzedForSolidColor() const;
 
-  bool RetainsIndividualDisplayItems() const;
-
   std::unique_ptr<base::trace_event::ConvertableToTraceFormat> AsValue(
       bool include_items) const;
 
@@ -108,6 +97,10 @@ class CC_EXPORT DisplayItemList
                                   float raster_scale,
                                   std::vector<DrawImage>* images);
 
+  void SetRetainVisualRectsForTesting(bool retain) {
+    retain_visual_rects_ = retain;
+  }
+
   gfx::Rect VisualRectForTesting(int index) {
     return inputs_.visual_rects[index];
   }
@@ -121,27 +114,21 @@ class CC_EXPORT DisplayItemList
   }
 
  private:
-  DisplayItemList(gfx::Rect layer_rect,
-                  const DisplayItemListSettings& display_list_settings,
-                  bool retain_individual_display_items);
+  explicit DisplayItemList(
+      const DisplayItemListSettings& display_list_settings);
   ~DisplayItemList();
 
-  void ProcessAppendedItem(const DisplayItem* item);
-
-  sk_sp<SkPicture> picture_;
-
-  std::unique_ptr<SkPictureRecorder> recorder_;
-
-  bool retain_individual_display_items_;
-  int approximate_op_count_;
+  RTree rtree_;
+  // For testing purposes only. Whether to keep visual rects across calls to
+  // Finalize().
+  bool retain_visual_rects_ = false;
 
-  // Memory usage due to the cached SkPicture.
-  size_t picture_memory_usage_;
+  int approximate_op_count_ = 0;
 
   DiscardableImageMap image_map_;
 
   struct Inputs {
-    Inputs(gfx::Rect layer_rect, const DisplayItemListSettings& settings);
+    explicit Inputs(const DisplayItemListSettings& settings);
     ~Inputs();
 
     ContiguousContainer<DisplayItem> items;
@@ -153,8 +140,7 @@ class CC_EXPORT DisplayItemList
     std::vector<gfx::Rect> visual_rects;
 
     const DisplayItemListSettings settings;
-    gfx::Rect layer_rect;
-    bool is_suitable_for_gpu_rasterization;
+    bool all_items_are_suitable_for_gpu_rasterization = true;
   };
 
   Inputs inputs_;
diff --git a/cc/playback/display_item_list_unittest.cc b/cc/playback/display_item_list_unittest.cc
index 1bb6d3d..bbdd5e7 100644
--- a/cc/playback/display_item_list_unittest.cc
+++ b/cc/playback/display_item_list_unittest.cc
@@ -137,8 +137,9 @@ TEST(DisplayItemListTest, SerializeSingleDrawingItem) {
   gfx::Size layer_size(10, 10);
 
   DisplayItemListSettings settings;
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(gfx::Rect(layer_size), settings);
+  settings.use_cached_picture = true;
+  scoped_refptr<DisplayItemList> list = DisplayItemList::Create(settings);
+  list->SetRetainVisualRectsForTesting(true);
 
   // Build the DrawingDisplayItem.
   AppendFirstSerializationTestPicture(list, layer_size);
@@ -150,8 +151,9 @@ TEST(DisplayItemListTest, SerializeClipItem) {
   gfx::Size layer_size(10, 10);
 
   DisplayItemListSettings settings;
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(gfx::Rect(layer_size), settings);
+  settings.use_cached_picture = true;
+  scoped_refptr<DisplayItemList> list = DisplayItemList::Create(settings);
+  list->SetRetainVisualRectsForTesting(true);
 
   // Build the DrawingDisplayItem.
   AppendFirstSerializationTestPicture(list, layer_size);
@@ -176,8 +178,9 @@ TEST(DisplayItemListTest, SerializeClipPathItem) {
   gfx::Size layer_size(10, 10);
 
   DisplayItemListSettings settings;
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(gfx::Rect(layer_size), settings);
+  settings.use_cached_picture = true;
+  scoped_refptr<DisplayItemList> list = DisplayItemList::Create(settings);
+  list->SetRetainVisualRectsForTesting(true);
 
   // Build the DrawingDisplayItem.
   AppendFirstSerializationTestPicture(list, layer_size);
@@ -201,8 +204,9 @@ TEST(DisplayItemListTest, SerializeCompositingItem) {
   gfx::Size layer_size(10, 10);
 
   DisplayItemListSettings settings;
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(gfx::Rect(layer_size), settings);
+  settings.use_cached_picture = true;
+  scoped_refptr<DisplayItemList> list = DisplayItemList::Create(settings);
+  list->SetRetainVisualRectsForTesting(true);
 
   // Build the DrawingDisplayItem.
   AppendFirstSerializationTestPicture(list, layer_size);
@@ -226,8 +230,9 @@ TEST(DisplayItemListTest, SerializeFloatClipItem) {
   gfx::Size layer_size(10, 10);
 
   DisplayItemListSettings settings;
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(gfx::Rect(layer_size), settings);
+  settings.use_cached_picture = true;
+  scoped_refptr<DisplayItemList> list = DisplayItemList::Create(settings);
+  list->SetRetainVisualRectsForTesting(true);
 
   // Build the DrawingDisplayItem.
   AppendFirstSerializationTestPicture(list, layer_size);
@@ -249,8 +254,9 @@ TEST(DisplayItemListTest, SerializeTransformItem) {
   gfx::Size layer_size(10, 10);
 
   DisplayItemListSettings settings;
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(gfx::Rect(layer_size), settings);
+  settings.use_cached_picture = true;
+  scoped_refptr<DisplayItemList> list = DisplayItemList::Create(settings);
+  list->SetRetainVisualRectsForTesting(true);
 
   // Build the DrawingDisplayItem.
   AppendFirstSerializationTestPicture(list, layer_size);
@@ -280,8 +286,8 @@ TEST(DisplayItemListTest, SingleDrawingItem) {
   red_paint.setColor(SK_ColorRED);
   unsigned char pixels[4 * 100 * 100] = {0};
   DisplayItemListSettings settings;
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(layer_rect, settings);
+  settings.use_cached_picture = true;
+  scoped_refptr<DisplayItemList> list = DisplayItemList::Create(settings);
 
   gfx::PointF offset(8.f, 9.f);
   gfx::RectF recording_rect(offset, gfx::SizeF(layer_rect.size()));
@@ -323,8 +329,7 @@ TEST(DisplayItemListTest, ClipItem) {
   unsigned char pixels[4 * 100 * 100] = {0};
   DisplayItemListSettings settings;
   settings.use_cached_picture = true;
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(layer_rect, settings);
+  scoped_refptr<DisplayItemList> list = DisplayItemList::Create(settings);
 
   gfx::PointF first_offset(8.f, 9.f);
   gfx::RectF first_recording_rect(first_offset, gfx::SizeF(layer_rect.size()));
@@ -383,8 +388,7 @@ TEST(DisplayItemListTest, TransformItem) {
   unsigned char pixels[4 * 100 * 100] = {0};
   DisplayItemListSettings settings;
   settings.use_cached_picture = true;
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(layer_rect, settings);
+  scoped_refptr<DisplayItemList> list = DisplayItemList::Create(settings);
 
   gfx::PointF first_offset(8.f, 9.f);
   gfx::RectF first_recording_rect(first_offset, gfx::SizeF(layer_rect.size()));
@@ -436,10 +440,8 @@ TEST(DisplayItemListTest, FilterItem) {
   gfx::Rect layer_rect(100, 100);
   FilterOperations filters;
   unsigned char pixels[4 * 100 * 100] = {0};
-  DisplayItemListSettings settings;
-  settings.use_cached_picture = true;
   scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(layer_rect, settings);
+      DisplayItemList::Create(DisplayItemListSettings());
 
   sk_sp<SkSurface> source_surface = SkSurface::MakeRasterN32Premul(50, 50);
   SkCanvas* source_canvas = source_surface->getCanvas();
@@ -495,9 +497,8 @@ TEST(DisplayItemListTest, CompactingItems) {
   gfx::RectF recording_rect(offset, gfx::SizeF(layer_rect.size()));
 
   DisplayItemListSettings no_caching_settings;
-  no_caching_settings.use_cached_picture = false;
   scoped_refptr<DisplayItemList> list_without_caching =
-      DisplayItemList::Create(layer_rect, no_caching_settings);
+      DisplayItemList::Create(no_caching_settings);
 
   canvas =
       sk_ref_sp(recorder.beginRecording(gfx::RectFToSkRect(recording_rect)));
@@ -514,7 +515,7 @@ TEST(DisplayItemListTest, CompactingItems) {
   DisplayItemListSettings caching_settings;
   caching_settings.use_cached_picture = true;
   scoped_refptr<DisplayItemList> list_with_caching =
-      DisplayItemList::Create(layer_rect, caching_settings);
+      DisplayItemList::Create(caching_settings);
   list_with_caching->CreateAndAppendItem<DrawingDisplayItem>(kVisualRect,
                                                              picture);
   list_with_caching->Finalize();
@@ -543,7 +544,7 @@ TEST(DisplayItemListTest, ApproximateMemoryUsage) {
   // Using a cached picture, we should get about the right size.
   DisplayItemListSettings caching_settings;
   caching_settings.use_cached_picture = true;
-  list = DisplayItemList::Create(layer_rect, caching_settings);
+  list = DisplayItemList::Create(caching_settings);
   list->CreateAndAppendItem<DrawingDisplayItem>(kVisualRect, picture);
   list->Finalize();
   memory_usage = list->ApproximateMemoryUsage();
@@ -553,43 +554,36 @@ TEST(DisplayItemListTest, ApproximateMemoryUsage) {
   // Using no cached picture, we should still get the right size.
   DisplayItemListSettings no_caching_settings;
   no_caching_settings.use_cached_picture = false;
-  list = DisplayItemList::Create(layer_rect, no_caching_settings);
+  list = DisplayItemList::Create(no_caching_settings);
   list->CreateAndAppendItem<DrawingDisplayItem>(kVisualRect, picture);
   list->Finalize();
   memory_usage = list->ApproximateMemoryUsage();
   EXPECT_GE(memory_usage, picture_size);
   EXPECT_LE(memory_usage, 2 * picture_size);
-
-  // To avoid double counting, we expect zero size to be computed if both the
-  // picture and items are retained (currently this only happens due to certain
-  // categories being traced).
-  list = new DisplayItemList(layer_rect, caching_settings, true);
-  list->CreateAndAppendItem<DrawingDisplayItem>(kVisualRect, picture);
-  list->Finalize();
-  memory_usage = list->ApproximateMemoryUsage();
-  EXPECT_EQ(static_cast<size_t>(0), memory_usage);
 }
 
-TEST(DisplayItemListTest, AsValueWithRectAndNoItems) {
+TEST(DisplayItemListTest, AsValueWithNoItems) {
   scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(gfx::Rect(1, 2, 8, 9), DisplayItemListSettings());
+      DisplayItemList::Create(DisplayItemListSettings());
+  list->SetRetainVisualRectsForTesting(true);
   list->Finalize();
 
   std::string value = list->AsValue(true)->ToString();
   EXPECT_NE(value.find("\"items\":[]"), std::string::npos);
-  EXPECT_NE(value.find("\"layer_rect\":[1,2,8,9]"), std::string::npos);
+  EXPECT_EQ(value.find("visualRect: [0,0 42x42]"), std::string::npos);
   EXPECT_NE(value.find("\"skp64\":"), std::string::npos);
 
   value = list->AsValue(false)->ToString();
   EXPECT_EQ(value.find("\"items\":"), std::string::npos);
-  EXPECT_NE(value.find("\"layer_rect\":[1,2,8,9]"), std::string::npos);
+  EXPECT_EQ(value.find("visualRect: [0,0 42x42]"), std::string::npos);
   EXPECT_NE(value.find("\"skp64\":"), std::string::npos);
 }
 
-TEST(DisplayItemListTest, AsValueWithRectAndItems) {
+TEST(DisplayItemListTest, AsValueWithItems) {
   gfx::Rect layer_rect = gfx::Rect(1, 2, 8, 9);
   scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(layer_rect, DisplayItemListSettings());
+      DisplayItemList::Create(DisplayItemListSettings());
+  list->SetRetainVisualRectsForTesting(true);
   gfx::Transform transform;
   transform.Translate(6.f, 7.f);
   list->CreateAndAppendItem<TransformDisplayItem>(kVisualRect, transform);
@@ -600,55 +594,14 @@ TEST(DisplayItemListTest, AsValueWithRectAndItems) {
   std::string value = list->AsValue(true)->ToString();
   EXPECT_NE(value.find("{\"items\":[\"TransformDisplayItem"),
             std::string::npos);
-  EXPECT_NE(value.find("\"layer_rect\":[1,2,8,9]"), std::string::npos);
+  EXPECT_NE(value.find("visualRect: [0,0 42x42]"), std::string::npos);
   EXPECT_NE(value.find("\"skp64\":"), std::string::npos);
 
   value = list->AsValue(false)->ToString();
   EXPECT_EQ(value.find("{\"items\":[\"TransformDisplayItem"),
             std::string::npos);
-  EXPECT_NE(value.find("\"layer_rect\":[1,2,8,9]"), std::string::npos);
+  EXPECT_EQ(value.find("visualRect: [0,0 42x42]"), std::string::npos);
   EXPECT_NE(value.find("\"skp64\":"), std::string::npos);
 }
 
-TEST(DisplayItemListTest, AsValueWithEmptyRectAndNoItems) {
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(gfx::Rect(), DisplayItemListSettings());
-  list->Finalize();
-
-  std::string value = list->AsValue(true)->ToString();
-  EXPECT_NE(value.find("\"items\":[]"), std::string::npos);
-  EXPECT_NE(value.find("\"layer_rect\":[0,0,0,0]"), std::string::npos);
-  EXPECT_EQ(value.find("\"skp64\":"), std::string::npos);
-
-  value = list->AsValue(false)->ToString();
-  EXPECT_EQ(value.find("\"items\":"), std::string::npos);
-  EXPECT_NE(value.find("\"layer_rect\":[0,0,0,0]"), std::string::npos);
-  EXPECT_EQ(value.find("\"skp64\":"), std::string::npos);
-}
-
-TEST(DisplayItemListTest, AsValueWithEmptyRectAndItems) {
-  scoped_refptr<DisplayItemList> list =
-      DisplayItemList::Create(gfx::Rect(), DisplayItemListSettings());
-  gfx::Transform transform;
-  transform.Translate(6.f, 7.f);
-  list->CreateAndAppendItem<TransformDisplayItem>(kVisualRect, transform);
-  AppendFirstSerializationTestPicture(list, gfx::Size());
-  list->CreateAndAppendItem<EndTransformDisplayItem>(kVisualRect);
-  list->Finalize();
-
-  std::string value = list->AsValue(true)->ToString();
-  EXPECT_NE(value.find("\"items\":[\"TransformDisplayItem"), std::string::npos);
-  EXPECT_NE(value.find("\"layer_rect\":[0,0,0,0]"), std::string::npos);
-  // There should be one skp64 entry present associated with the test picture
-  // item, though the overall list has no skp64 as the layer rect is empty.
-  EXPECT_NE(value.find("\"skp64\":"), std::string::npos);
-
-  value = list->AsValue(false)->ToString();
-  EXPECT_EQ(value.find("\"items\":"), std::string::npos);
-  EXPECT_NE(value.find("\"layer_rect\":[0,0,0,0]"), std::string::npos);
-  // There should be no skp64 entry present as the items aren't included and the
-  // layer rect is empty.
-  EXPECT_EQ(value.find("\"skp64\":"), std::string::npos);
-}
-
 }  // namespace cc
diff --git a/cc/playback/recording_source.cc b/cc/playback/recording_source.cc
index 198fb26..7af4a34 100644
--- a/cc/playback/recording_source.cc
+++ b/cc/playback/recording_source.cc
@@ -190,7 +190,7 @@ void RecordingSource::DetermineIfSolidColor() {
                display_list_->ApproximateOpCount());
   gfx::Size layer_size = GetSize();
   skia::AnalysisCanvas canvas(layer_size.width(), layer_size.height());
-  display_list_->Raster(&canvas, nullptr, gfx::Rect(), 1.f);
+  display_list_->Raster(&canvas, nullptr, gfx::Rect(layer_size), 1.f);
   is_solid_color_ = canvas.GetColorIfSolid(&solid_color_);
 }
 
diff --git a/cc/proto/display_item.proto b/cc/proto/display_item.proto
index 05cc060..2b7db4b 100644
--- a/cc/proto/display_item.proto
+++ b/cc/proto/display_item.proto
@@ -21,8 +21,8 @@ message DisplayItemListSettings {
 
 message DisplayItemList {
   repeated DisplayItem items = 1;
-  optional cc.proto.Rect layer_rect = 2;
   optional DisplayItemListSettings settings = 3;
+  repeated cc.proto.Rect visual_rects = 4;
 }
 
 message DisplayItem {
diff --git a/cc/test/animation_timelines_test_common.cc b/cc/test/animation_timelines_test_common.cc
index 5f640b8..e937763 100644
--- a/cc/test/animation_timelines_test_common.cc
+++ b/cc/test/animation_timelines_test_common.cc
@@ -495,22 +495,16 @@ AnimationPlayer* AnimationTimelinesTest::GetPlayerForElementId(
     ElementId element_id) {
   const scoped_refptr<ElementAnimations> element_animations =
       host_->GetElementAnimationsForElementId(element_id);
-  return element_animations
-             ? ElementAnimations::PlayersList::Iterator(
-                   &element_animations->players_list())
-                   .GetNext()
-             : nullptr;
+  return element_animations ? element_animations->players_list().head()->value()
+                            : nullptr;
 }
 
 AnimationPlayer* AnimationTimelinesTest::GetImplPlayerForLayerId(
     ElementId element_id) {
   const scoped_refptr<ElementAnimations> element_animations =
       host_impl_->GetElementAnimationsForElementId(element_id);
-  return element_animations
-             ? ElementAnimations::PlayersList::Iterator(
-                   &element_animations->players_list())
-                   .GetNext()
-             : nullptr;
+  return element_animations ? element_animations->players_list().head()->value()
+                            : nullptr;
 }
 
 int AnimationTimelinesTest::NextTestLayerId() {
diff --git a/cc/test/fake_content_layer_client.cc b/cc/test/fake_content_layer_client.cc
index d1b1537..15d9e44 100644
--- a/cc/test/fake_content_layer_client.cc
+++ b/cc/test/fake_content_layer_client.cc
@@ -55,7 +55,8 @@ FakeContentLayerClient::PaintContentsToDisplayList(
   DisplayItemListSettings settings;
   settings.use_cached_picture = display_list_use_cached_picture_;
   scoped_refptr<DisplayItemList> display_list =
-      DisplayItemList::Create(PaintableRegion(), settings);
+      DisplayItemList::Create(settings);
+  display_list->SetRetainVisualRectsForTesting(true);
   SkPictureRecorder recorder;
   sk_sp<SkCanvas> canvas;
 
diff --git a/cc/test/fake_picture_layer.cc b/cc/test/fake_picture_layer.cc
index 4ab5a02..c5dd84a 100644
--- a/cc/test/fake_picture_layer.cc
+++ b/cc/test/fake_picture_layer.cc
@@ -12,8 +12,7 @@ FakePictureLayer::FakePictureLayer(ContentLayerClient* client)
     : PictureLayer(client),
       update_count_(0),
       push_properties_count_(0),
-      always_update_resources_(false),
-      force_unsuitable_for_gpu_rasterization_(false) {
+      always_update_resources_(false) {
   SetBounds(gfx::Size(1, 1));
   SetIsDrawable(true);
 }
diff --git a/cc/test/skia_common.cc b/cc/test/skia_common.cc
index d7ffe2f..ec39908 100644
--- a/cc/test/skia_common.cc
+++ b/cc/test/skia_common.cc
@@ -49,7 +49,7 @@ void DrawDisplayList(unsigned char* buffer,
   bitmap.installPixels(info, buffer, info.minRowBytes());
   SkCanvas canvas(bitmap);
   canvas.clipRect(gfx::RectToSkRect(layer_rect));
-  list->Raster(&canvas, NULL, gfx::Rect(), 1.0f);
+  list->Raster(&canvas, NULL, layer_rect, 1.0f);
 }
 
 bool AreDisplayListDrawingResultsSame(const gfx::Rect& layer_rect,
diff --git a/cc/test/solid_color_content_layer_client.cc b/cc/test/solid_color_content_layer_client.cc
index efa6355..ccc1a74 100644
--- a/cc/test/solid_color_content_layer_client.cc
+++ b/cc/test/solid_color_content_layer_client.cc
@@ -52,7 +52,7 @@ SolidColorContentLayerClient::PaintContentsToDisplayList(
   DisplayItemListSettings settings;
   settings.use_cached_picture = false;
   scoped_refptr<DisplayItemList> display_list =
-      DisplayItemList::Create(clip, settings);
+      DisplayItemList::Create(settings);
 
   display_list->CreateAndAppendItem<DrawingDisplayItem>(
       clip, recorder.finishRecordingAsPicture());
diff --git a/cc/trees/draw_property_utils.cc b/cc/trees/draw_property_utils.cc
index f41e2ef..01652a0 100644
--- a/cc/trees/draw_property_utils.cc
+++ b/cc/trees/draw_property_utils.cc
@@ -81,8 +81,9 @@ static const EffectNode* ContentsTargetEffectNode(
     const int effect_tree_index,
     const EffectTree& effect_tree) {
   const EffectNode* effect_node = effect_tree.Node(effect_tree_index);
-  return effect_node->render_surface ? effect_node
-                                     : effect_tree.Node(effect_node->target_id);
+  return effect_node->has_render_surface
+             ? effect_node
+             : effect_tree.Node(effect_node->target_id);
 }
 
 template <typename LayerType>
@@ -530,7 +531,7 @@ void CalculateVisibleRects(
         layer->set_visible_layer_rect(gfx::Rect(layer_bounds));
         continue;
       }
-      if (target_effect_node->id > EffectTree::kContentsRootNodeId) {
+      if (target_effect_node->id != EffectTree::kContentsRootNodeId) {
         ConcatInverseSurfaceContentsScale(target_effect_node, &target_to_layer);
 #if DCHECK_IS_ON()
         VerifySurfaceContentsScalesMatch(target_effect_node->id, target_node_id,
@@ -1206,15 +1207,12 @@ gfx::Transform DrawTransform(const LayerImpl* layer,
                              const EffectTree& effect_tree) {
   gfx::Transform xform;
   const bool owns_non_root_surface =
-      !IsRootLayer(layer) && layer->render_surface();
+      !IsRootLayer(layer) && layer->has_render_surface();
   if (!owns_non_root_surface) {
     // If you're not the root, or you don't own a surface, you need to apply
     // your local offset.
-    xform =
-        transform_tree.property_trees()->non_root_surfaces_enabled
-            ? transform_tree.ToTarget(layer->transform_tree_index(),
-                                      layer->render_target_effect_tree_index())
-            : transform_tree.ToScreen(layer->transform_tree_index());
+    xform = transform_tree.ToTarget(layer->transform_tree_index(),
+                                    layer->render_target_effect_tree_index());
     if (layer->should_flatten_transform_from_property_tree())
       xform.FlattenTo2d();
     xform.Translate(layer->offset_to_transform_parent().x(),
@@ -1444,8 +1442,13 @@ void ComputeLayerDrawProperties(LayerImpl* layer,
 
   layer->draw_properties().screen_space_transform =
       ScreenSpaceTransformInternal(layer, property_trees->transform_tree);
-  layer->draw_properties().target_space_transform = DrawTransform(
-      layer, property_trees->transform_tree, property_trees->effect_tree);
+  if (property_trees->non_root_surfaces_enabled) {
+    layer->draw_properties().target_space_transform = DrawTransform(
+        layer, property_trees->transform_tree, property_trees->effect_tree);
+  } else {
+    layer->draw_properties().target_space_transform =
+        layer->draw_properties().screen_space_transform;
+  }
   layer->draw_properties().screen_space_transform_is_animating =
       transform_node->to_screen_is_potentially_animated;
 
diff --git a/cc/trees/layer_tree_host_impl_unittest.cc b/cc/trees/layer_tree_host_impl_unittest.cc
index 2244c9a..087ecd0 100644
--- a/cc/trees/layer_tree_host_impl_unittest.cc
+++ b/cc/trees/layer_tree_host_impl_unittest.cc
@@ -2770,26 +2770,16 @@ class LayerTreeHostImplTestScrollbarAnimation : public LayerTreeHostImplTest {
     settings.scrollbar_fade_delay_ms = 20;
     settings.scrollbar_fade_duration_ms = 20;
 
-    // If no animator is set, scrollbar won't show and no animation is expected.
-    bool expecting_animations = animator != LayerTreeSettings::NO_ANIMATOR;
-
     SetupLayers(settings);
 
     base::TimeTicks fake_now = base::TimeTicks::Now();
 
-    if (expecting_animations) {
-      // A task will be posted to fade the initial scrollbar.
-      EXPECT_FALSE(did_request_next_frame_);
-      EXPECT_FALSE(did_request_redraw_);
-      EXPECT_FALSE(animation_task_.Equals(base::Closure()));
-      requested_animation_delay_ = base::TimeDelta();
-      animation_task_ = base::Closure();
-    } else {
-      EXPECT_FALSE(did_request_next_frame_);
-      EXPECT_FALSE(did_request_redraw_);
-      EXPECT_TRUE(animation_task_.Equals(base::Closure()));
-      EXPECT_EQ(base::TimeDelta(), requested_animation_delay_);
-    }
+    // A task will be posted to fade the initial scrollbar.
+    EXPECT_FALSE(did_request_next_frame_);
+    EXPECT_FALSE(did_request_redraw_);
+    EXPECT_FALSE(animation_task_.Equals(base::Closure()));
+    requested_animation_delay_ = base::TimeDelta();
+    animation_task_ = base::Closure();
 
     // If no scroll happened during a scroll gesture, it should have no effect.
     host_impl_->ScrollBegin(BeginState(gfx::Point()).get(),
@@ -2827,49 +2817,42 @@ class LayerTreeHostImplTestScrollbarAnimation : public LayerTreeHostImplTest {
     host_impl_->ScrollEnd(EndState().get());
     EXPECT_FALSE(did_request_next_frame_);
     EXPECT_FALSE(did_request_redraw_);
-    if (expecting_animations) {
-      EXPECT_EQ(base::TimeDelta::FromMilliseconds(20),
-                requested_animation_delay_);
-      EXPECT_FALSE(animation_task_.Equals(base::Closure()));
-    } else {
-      EXPECT_EQ(base::TimeDelta(), requested_animation_delay_);
-      EXPECT_TRUE(animation_task_.Equals(base::Closure()));
-    }
+    EXPECT_EQ(base::TimeDelta::FromMilliseconds(20),
+              requested_animation_delay_);
+    EXPECT_FALSE(animation_task_.Equals(base::Closure()));
 
-    if (expecting_animations) {
-      // Before the scrollbar animation begins, we should not get redraws.
-      begin_frame_args =
-          CreateBeginFrameArgsForTesting(BEGINFRAME_FROM_HERE, fake_now);
-      host_impl_->WillBeginImplFrame(begin_frame_args);
-      host_impl_->Animate();
-      EXPECT_FALSE(did_request_next_frame_);
-      did_request_next_frame_ = false;
-      EXPECT_FALSE(did_request_redraw_);
-      did_request_redraw_ = false;
-      host_impl_->DidFinishImplFrame();
-
-      // Start the scrollbar animation.
-      fake_now += requested_animation_delay_;
-      requested_animation_delay_ = base::TimeDelta();
-      animation_task_.Run();
-      animation_task_ = base::Closure();
-      EXPECT_TRUE(did_request_next_frame_);
-      did_request_next_frame_ = false;
-      EXPECT_FALSE(did_request_redraw_);
-
-      // After the scrollbar animation begins, we should start getting redraws.
-      begin_frame_args =
-          CreateBeginFrameArgsForTesting(BEGINFRAME_FROM_HERE, fake_now);
-      host_impl_->WillBeginImplFrame(begin_frame_args);
-      host_impl_->Animate();
-      EXPECT_TRUE(did_request_next_frame_);
-      did_request_next_frame_ = false;
-      EXPECT_TRUE(did_request_redraw_);
-      did_request_redraw_ = false;
-      EXPECT_EQ(base::TimeDelta(), requested_animation_delay_);
-      EXPECT_TRUE(animation_task_.Equals(base::Closure()));
-      host_impl_->DidFinishImplFrame();
-    }
+    // Before the scrollbar animation begins, we should not get redraws.
+    begin_frame_args =
+        CreateBeginFrameArgsForTesting(BEGINFRAME_FROM_HERE, fake_now);
+    host_impl_->WillBeginImplFrame(begin_frame_args);
+    host_impl_->Animate();
+    EXPECT_FALSE(did_request_next_frame_);
+    did_request_next_frame_ = false;
+    EXPECT_FALSE(did_request_redraw_);
+    did_request_redraw_ = false;
+    host_impl_->DidFinishImplFrame();
+
+    // Start the scrollbar animation.
+    fake_now += requested_animation_delay_;
+    requested_animation_delay_ = base::TimeDelta();
+    animation_task_.Run();
+    animation_task_ = base::Closure();
+    EXPECT_TRUE(did_request_next_frame_);
+    did_request_next_frame_ = false;
+    EXPECT_FALSE(did_request_redraw_);
+
+    // After the scrollbar animation begins, we should start getting redraws.
+    begin_frame_args =
+        CreateBeginFrameArgsForTesting(BEGINFRAME_FROM_HERE, fake_now);
+    host_impl_->WillBeginImplFrame(begin_frame_args);
+    host_impl_->Animate();
+    EXPECT_TRUE(did_request_next_frame_);
+    did_request_next_frame_ = false;
+    EXPECT_TRUE(did_request_redraw_);
+    did_request_redraw_ = false;
+    EXPECT_EQ(base::TimeDelta(), requested_animation_delay_);
+    EXPECT_TRUE(animation_task_.Equals(base::Closure()));
+    host_impl_->DidFinishImplFrame();
 
     // Setting the scroll offset outside a scroll should also cause the
     // scrollbar to appear and to schedule a scrollbar animation.
@@ -2883,30 +2866,23 @@ class LayerTreeHostImplTestScrollbarAnimation : public LayerTreeHostImplTest {
           host_impl_->InnerViewportScrollLayer()->transform_tree_index());
     EXPECT_FALSE(did_request_next_frame_);
     EXPECT_FALSE(did_request_redraw_);
-    if (expecting_animations) {
-      EXPECT_EQ(base::TimeDelta::FromMilliseconds(20),
-                requested_animation_delay_);
-      EXPECT_FALSE(animation_task_.Equals(base::Closure()));
-      requested_animation_delay_ = base::TimeDelta();
-      animation_task_ = base::Closure();
-    } else {
-      EXPECT_EQ(base::TimeDelta(), requested_animation_delay_);
-      EXPECT_TRUE(animation_task_.Equals(base::Closure()));
-    }
-
-    if (expecting_animations) {
-      // Scrolling should have stopped the animation, so we should not be
-      // getting redraws.
-      begin_frame_args =
-          CreateBeginFrameArgsForTesting(BEGINFRAME_FROM_HERE, fake_now);
-      host_impl_->WillBeginImplFrame(begin_frame_args);
-      host_impl_->Animate();
-      EXPECT_FALSE(did_request_next_frame_);
-      did_request_next_frame_ = false;
-      EXPECT_FALSE(did_request_redraw_);
-      did_request_redraw_ = false;
-      host_impl_->DidFinishImplFrame();
-    }
+    EXPECT_EQ(base::TimeDelta::FromMilliseconds(20),
+              requested_animation_delay_);
+    EXPECT_FALSE(animation_task_.Equals(base::Closure()));
+    requested_animation_delay_ = base::TimeDelta();
+    animation_task_ = base::Closure();
+
+    // Scrolling should have stopped the animation, so we should not be getting
+    // redraws.
+    begin_frame_args =
+        CreateBeginFrameArgsForTesting(BEGINFRAME_FROM_HERE, fake_now);
+    host_impl_->WillBeginImplFrame(begin_frame_args);
+    host_impl_->Animate();
+    EXPECT_FALSE(did_request_next_frame_);
+    did_request_next_frame_ = false;
+    EXPECT_FALSE(did_request_redraw_);
+    did_request_redraw_ = false;
+    host_impl_->DidFinishImplFrame();
 
     // Scrollbar animation is not triggered unnecessarily.
     host_impl_->ScrollBegin(BeginState(gfx::Point()).get(),
@@ -2929,16 +2905,11 @@ class LayerTreeHostImplTestScrollbarAnimation : public LayerTreeHostImplTest {
     host_impl_->active_tree()->SetPageScaleOnActiveTree(1.1f);
     EXPECT_FALSE(did_request_next_frame_);
     EXPECT_FALSE(did_request_redraw_);
-    if (expecting_animations) {
-      EXPECT_EQ(base::TimeDelta::FromMilliseconds(20),
-                requested_animation_delay_);
-      EXPECT_FALSE(animation_task_.Equals(base::Closure()));
-      requested_animation_delay_ = base::TimeDelta();
-      animation_task_ = base::Closure();
-    } else {
-      EXPECT_EQ(base::TimeDelta(), requested_animation_delay_);
-      EXPECT_TRUE(animation_task_.Equals(base::Closure()));
-    }
+    EXPECT_EQ(base::TimeDelta::FromMilliseconds(20),
+              requested_animation_delay_);
+    EXPECT_FALSE(animation_task_.Equals(base::Closure()));
+    requested_animation_delay_ = base::TimeDelta();
+    animation_task_ = base::Closure();
   }
 };
 
@@ -2950,10 +2921,6 @@ TEST_F(LayerTreeHostImplTestScrollbarAnimation, Thinning) {
   RunTest(LayerTreeSettings::THINNING);
 }
 
-TEST_F(LayerTreeHostImplTestScrollbarAnimation, NoAnimator) {
-  RunTest(LayerTreeSettings::NO_ANIMATOR);
-}
-
 class LayerTreeHostImplTestScrollbarOpacity : public LayerTreeHostImplTest {
  protected:
   void RunTest(LayerTreeSettings::ScrollbarAnimator animator) {
@@ -2963,9 +2930,6 @@ class LayerTreeHostImplTestScrollbarOpacity : public LayerTreeHostImplTest {
     settings.scrollbar_fade_duration_ms = 20;
     gfx::Size content_size(100, 100);
 
-    // If no animator is set, scrollbar won't show and no animation is expected.
-    bool expecting_animations = animator != LayerTreeSettings::NO_ANIMATOR;
-
     CreateHostImpl(settings, CreateOutputSurface());
     host_impl_->CreatePendingTree();
     CreateScrollAndContentsLayers(host_impl_->pending_tree(), content_size);
@@ -2991,13 +2955,8 @@ class LayerTreeHostImplTestScrollbarOpacity : public LayerTreeHostImplTest {
     EXPECT_FLOAT_EQ(active_scrollbar_layer->Opacity(),
                     active_tree_node->opacity);
 
-    if (expecting_animations) {
-      host_impl_->ScrollbarAnimationControllerForId(scroll->id())
-          ->DidMouseMoveNear(0);
-    } else {
-      EXPECT_EQ(nullptr,
-                host_impl_->ScrollbarAnimationControllerForId(scroll->id()));
-    }
+    host_impl_->ScrollbarAnimationControllerForId(scroll->id())
+        ->DidMouseMoveNear(0);
     host_impl_->ScrollBegin(BeginState(gfx::Point()).get(),
                             InputHandler::WHEEL);
     host_impl_->ScrollBy(UpdateState(gfx::Point(), gfx::Vector2dF(0, 5)).get());
@@ -3012,32 +2971,21 @@ class LayerTreeHostImplTestScrollbarOpacity : public LayerTreeHostImplTest {
 
     LayerImpl* pending_scrollbar_layer =
         host_impl_->pending_tree()->LayerById(400);
-    pending_scrollbar_layer->SetNeedsPushProperties();
     EffectNode* pending_tree_node =
         host_impl_->pending_tree()->property_trees()->effect_tree.Node(
             pending_scrollbar_layer->effect_tree_index());
     host_impl_->pending_tree()
         ->property_trees()
         ->always_use_active_tree_opacity_effect_ids.push_back(400);
-    if (expecting_animations) {
-      EXPECT_FLOAT_EQ(1.f, active_tree_node->opacity);
-      EXPECT_FLOAT_EQ(1.f, active_scrollbar_layer->Opacity());
-    } else {
-      EXPECT_FLOAT_EQ(0.f, active_tree_node->opacity);
-      EXPECT_FLOAT_EQ(0.f, active_scrollbar_layer->Opacity());
-    }
+    EXPECT_FLOAT_EQ(1.f, active_tree_node->opacity);
+    EXPECT_FLOAT_EQ(1.f, active_scrollbar_layer->Opacity());
     EXPECT_FLOAT_EQ(0.f, pending_tree_node->opacity);
     host_impl_->ActivateSyncTree();
     active_tree_node =
         host_impl_->active_tree()->property_trees()->effect_tree.Node(
             active_scrollbar_layer->effect_tree_index());
-    if (expecting_animations) {
-      EXPECT_FLOAT_EQ(1.f, active_tree_node->opacity);
-      EXPECT_FLOAT_EQ(1.f, active_scrollbar_layer->Opacity());
-    } else {
-      EXPECT_FLOAT_EQ(0.f, active_tree_node->opacity);
-      EXPECT_FLOAT_EQ(0.f, active_scrollbar_layer->Opacity());
-    }
+    EXPECT_FLOAT_EQ(1.f, active_tree_node->opacity);
+    EXPECT_FLOAT_EQ(1.f, active_scrollbar_layer->Opacity());
   }
 };
 
@@ -3049,10 +2997,6 @@ TEST_F(LayerTreeHostImplTestScrollbarOpacity, Thinning) {
   RunTest(LayerTreeSettings::THINNING);
 }
 
-TEST_F(LayerTreeHostImplTestScrollbarOpacity, NoAnimator) {
-  RunTest(LayerTreeSettings::NO_ANIMATOR);
-}
-
 TEST_F(LayerTreeHostImplTest, ScrollbarInnerLargerThanOuter) {
   LayerTreeSettings settings = DefaultSettings();
   CreateHostImpl(settings, CreateOutputSurface());
diff --git a/cc/trees/layer_tree_host_pixeltest_masks.cc b/cc/trees/layer_tree_host_pixeltest_masks.cc
index d991b64..fe5debf 100644
--- a/cc/trees/layer_tree_host_pixeltest_masks.cc
+++ b/cc/trees/layer_tree_host_pixeltest_masks.cc
@@ -60,7 +60,7 @@ class MaskContentLayerClient : public ContentLayerClient {
     }
 
     scoped_refptr<DisplayItemList> display_list =
-        DisplayItemList::Create(PaintableRegion(), DisplayItemListSettings());
+        DisplayItemList::Create(DisplayItemListSettings());
     display_list->CreateAndAppendItem<DrawingDisplayItem>(
         PaintableRegion(), recorder.finishRecordingAsPicture());
 
@@ -360,7 +360,7 @@ class CheckerContentLayerClient : public ContentLayerClient {
     }
 
     scoped_refptr<DisplayItemList> display_list =
-        DisplayItemList::Create(PaintableRegion(), DisplayItemListSettings());
+        DisplayItemList::Create(DisplayItemListSettings());
     display_list->CreateAndAppendItem<DrawingDisplayItem>(
         PaintableRegion(), recorder.finishRecordingAsPicture());
 
@@ -398,7 +398,7 @@ class CircleContentLayerClient : public ContentLayerClient {
                        paint);
 
     scoped_refptr<DisplayItemList> display_list =
-        DisplayItemList::Create(PaintableRegion(), DisplayItemListSettings());
+        DisplayItemList::Create(DisplayItemListSettings());
     display_list->CreateAndAppendItem<DrawingDisplayItem>(
         PaintableRegion(), recorder.finishRecordingAsPicture());
 
diff --git a/cc/trees/layer_tree_host_pixeltest_tiles.cc b/cc/trees/layer_tree_host_pixeltest_tiles.cc
index a7833dd..d3e76c4 100644
--- a/cc/trees/layer_tree_host_pixeltest_tiles.cc
+++ b/cc/trees/layer_tree_host_pixeltest_tiles.cc
@@ -113,7 +113,7 @@ class BlueYellowClient : public ContentLayerClient {
     DisplayItemListSettings settings;
     settings.use_cached_picture = false;
     scoped_refptr<DisplayItemList> display_list =
-        DisplayItemList::Create(PaintableRegion(), settings);
+        DisplayItemList::Create(settings);
 
     SkPictureRecorder recorder;
     sk_sp<SkCanvas> canvas =
diff --git a/cc/trees/property_tree.cc b/cc/trees/property_tree.cc
index b2af225..d88ebd3 100644
--- a/cc/trees/property_tree.cc
+++ b/cc/trees/property_tree.cc
@@ -260,8 +260,6 @@ void TransformTree::CombineTransformsBetween(int source_id,
 
   gfx::Transform combined_transform;
   if (current->id > dest_id) {
-    // TODO(sunxd): Instead of using target space transform, only use to_parent
-    // here when we fully implement computing draw transforms on demand.
     combined_transform = ToTarget(current->id, kInvalidNodeId);
     // The stored target space transform has surface contents scale baked in,
     // but we need the unscaled transform.
@@ -1801,8 +1799,8 @@ CombinedAnimationScale PropertyTrees::GetAnimationScales(
     // Computing maximum animated scale in the presence of non-scale/translation
     // transforms isn't supported.
     bool failed_for_non_scale_or_translation =
-        !transform_tree.Node(transform_node_id)
-             ->to_parent.IsScaleOrTranslation();
+        !transform_tree.ToTarget(transform_node_id, effect_tree.kInvalidNodeId)
+             .IsScaleOrTranslation();
 
     // We don't attempt to accumulate animation scale from multiple nodes with
     // scale animations, because of the risk of significant overestimation. For
@@ -1869,9 +1867,10 @@ CombinedAnimationScale PropertyTrees::GetAnimationScales(
       } else {
         gfx::Vector2dF ancestor_scales =
             parent_node ? MathUtil::ComputeTransform2dScaleComponents(
-                              transform_tree.ToScreen(parent_node->id), 0.f)
+                              transform_tree.ToTarget(
+                                  parent_node->id, effect_tree.kInvalidNodeId),
+                              0.f)
                         : gfx::Vector2dF(1.f, 1.f);
-
         float max_ancestor_scale =
             std::max(ancestor_scales.x(), ancestor_scales.y());
         cached_data_.animation_scales[transform_node_id]
diff --git a/chrome/BUILD.gn b/chrome/BUILD.gn
index b56bbb8..cb04370 100644
--- a/chrome/BUILD.gn
+++ b/chrome/BUILD.gn
@@ -768,6 +768,16 @@ if (is_win) {
       sources += [ "$root_out_dir/chrome_200_percent.pak" ]
     }
 
+    # TODO(estade): remove material design specific resources.
+    # See crbug.com/613593
+    if (is_mac) {
+      sources += [ "$root_out_dir/chrome_material_100_percent.pak" ]
+
+      if (enable_hidpi) {
+        sources += [ "$root_out_dir/chrome_material_200_percent.pak" ]
+      }
+    }
+
     if (enable_mac_keystone) {
       sources += [
         "browser/mac/keystone_promote_postflight.sh",
@@ -1378,6 +1388,14 @@ group("packed_resources") {
   if (enable_hidpi) {
     public_deps += [ ":repack_chrome_200_percent" ]
   }
+
+  if (is_mac) {
+    public_deps += [ ":repack_chrome_material_100_percent" ]
+
+    if (enable_hidpi) {
+      public_deps += [ ":repack_chrome_material_200_percent" ]
+    }
+  }
 }
 
 repack("packed_extra_resources") {
@@ -1604,6 +1622,60 @@ if (enable_hidpi) {
   }
 }
 
+# Generates a rule to repack a set of material design resources for the browser
+# top chrome, substituting a given string in for the percentage (e.g. "100",
+# "200").
+template("chrome_repack_material_percent") {
+  percent = invoker.percent
+
+  repack_name = "${target_name}_repack"
+  repack_output_file =
+      "$root_gen_dir/repack/chrome_material_${percent}_percent.pak"
+
+  copy_name = target_name
+
+  repack(repack_name) {
+    visibility = [ ":$copy_name" ]
+
+    # All sources should also have deps for completeness.
+    sources = [
+      "$root_gen_dir/chrome/theme_resources_material_${percent}_percent.pak",
+    ]
+
+    deps = [
+      "//chrome/app/theme:theme_resources",
+      "//components/resources",
+    ]
+
+    output = repack_output_file
+  }
+
+  copy(copy_name) {
+    visibility = [ ":*" ]
+    deps = [
+      ":$repack_name",
+    ]
+    sources = [
+      repack_output_file,
+    ]
+    outputs = [
+      "$root_build_dir/chrome_material_${percent}_percent.pak",
+    ]
+  }
+}
+
+if (is_mac) {
+  chrome_repack_material_percent("repack_chrome_material_100_percent") {
+    percent = "100"
+  }
+
+  if (enable_hidpi) {
+    chrome_repack_material_percent("repack_chrome_material_200_percent") {
+      percent = "200"
+    }
+  }
+}
+
 # GYP version: chrome/chrome_resources.gyp:chrome_strings
 group("strings") {
   public_deps = [
diff --git a/chrome/VERSION b/chrome/VERSION
index 1c44b7c..3a948ae 100644
--- a/chrome/VERSION
+++ b/chrome/VERSION
@@ -1,4 +1,4 @@
 MAJOR=54
 MINOR=0
-BUILD=2822
+BUILD=2821
 PATCH=0
diff --git a/chrome/android/BUILD.gn b/chrome/android/BUILD.gn
index f436317..0490b4a 100644
--- a/chrome/android/BUILD.gn
+++ b/chrome/android/BUILD.gn
@@ -400,26 +400,6 @@ android_library("chrome_test_java") {
     "//ui/android:ui_javatests",
     google_play_services_library,
   ]
-
-  data = [
-    "//chrome/test/data/android/",
-    "//chrome/test/data/banners/",
-    "//chrome/test/data/encoding_tests/auto_detect/Big5_with_no_encoding_specified.html",
-    "//chrome/test/data/geolocation/",
-    "//chrome/test/data/google/",
-    "//chrome/test/data/image_search/valid.png",
-    "//chrome/test/data/navigation_interception/",
-    "//chrome/test/data/notifications/",
-    "//chrome/test/data/popup_blocker/",
-    "//chrome/test/data/push_messaging/",
-    "//chrome/test/data/translate/",
-    "//chrome/test/data/webapps/",
-    "//chrome/test/media_router/resources/",
-    "//content/test/data/android/geolocation.html",
-    "//content/test/data/media/getusermedia.html",
-    "//content/test/data/media/session/",
-    "//content/test/data/media/webrtc_test_utilities.js",
-  ]
 }
 
 # Overrides icon / name defined in chrome_java_resources.
@@ -591,24 +571,27 @@ jinja_template("chrome_sync_shell_test_apk_manifest") {
   variables = chrome_sync_shell_jinja_variables
 }
 
-# GYP: //chrome/android/chrome_apk.gyp:chrome_public_test_apk
-instrumentation_test_apk("chrome_public_test_apk") {
-  apk_name = "ChromePublicTest"
-  apk_under_test = ":chrome_public_apk"
-  android_manifest = chrome_public_test_apk_manifest
-  android_manifest_dep = ":chrome_public_test_apk_manifest"
+if (!enable_all_proguard_optimizations) {
+  # GYP: //chrome/android/chrome_apk.gyp:chrome_public_test_apk
+  instrumentation_test_apk("chrome_public_test_apk") {
+    apk_name = "ChromePublicTest"
+    apk_under_test = ":chrome_public_apk"
+    android_manifest = chrome_public_test_apk_manifest
+    android_manifest_dep = ":chrome_public_test_apk_manifest"
 
-  deps = [
-    ":chrome_test_java",
-    "//chrome/android/webapk/libs/runtime_library:runtime_library_javatests",
-    "//chrome/android/webapk/shell_apk:shell_apk_javatests",
-  ]
-  additional_apks = [
-    "//chrome/android/webapk/shell_apk/javatests/dex_optimizer:dex_optimizer_apk",
-    "//chrome/test/android/chrome_public_test_support:chrome_public_test_support_apk",
-    "//net/android:net_test_support_apk",
-  ]
-  proguard_enabled = !is_java_debug
+    deps = [
+      ":chrome_test_java",
+      "//chrome/android/webapk/libs/runtime_library:runtime_library_javatests",
+      "//chrome/android/webapk/shell_apk:shell_apk_javatests",
+    ]
+    additional_apks = [
+      "//chrome/android/webapk/shell_apk/javatests/dex_optimizer:dex_optimizer_apk",
+      "//chrome/test/android/chrome_public_test_support:chrome_public_test_support_apk",
+      "//net/android:net_test_support_apk",
+    ]
+    isolate_file = "../chrome_public_test_apk.isolate"
+    proguard_enabled = !is_java_debug
+  }
 }
 
 android_library("chrome_sync_shell_test_apk_java") {
@@ -635,14 +618,16 @@ android_library("chrome_sync_shell_test_apk_java") {
   ]
 }
 
-# GYP: //chrome/android/chrome_apk.gyp:chrome_sync_shell_test_apk
-instrumentation_test_apk("chrome_sync_shell_test_apk") {
-  apk_name = "ChromeSyncShellTest"
-  apk_under_test = ":chrome_sync_shell_apk"
-  android_manifest = chrome_sync_shell_test_apk_manifest
-  android_manifest_dep = ":chrome_sync_shell_test_apk_manifest"
-  deps = [
-    ":chrome_sync_shell_test_apk_java",
-  ]
-  proguard_enabled = !is_java_debug
+if (!enable_all_proguard_optimizations) {
+  # GYP: //chrome/android/chrome_apk.gyp:chrome_sync_shell_test_apk
+  instrumentation_test_apk("chrome_sync_shell_test_apk") {
+    apk_name = "ChromeSyncShellTest"
+    apk_under_test = ":chrome_sync_shell_apk"
+    android_manifest = chrome_sync_shell_test_apk_manifest
+    android_manifest_dep = ":chrome_sync_shell_test_apk_manifest"
+    deps = [
+      ":chrome_sync_shell_test_apk_java",
+    ]
+    proguard_enabled = !is_java_debug
+  }
 }
diff --git a/chrome/android/chrome_public_apk_tmpl.gni b/chrome/android/chrome_public_apk_tmpl.gni
index 2305a0c..057eed6 100644
--- a/chrome/android/chrome_public_apk_tmpl.gni
+++ b/chrome/android/chrome_public_apk_tmpl.gni
@@ -53,6 +53,9 @@ template("chrome_public_apk_tmpl") {
                            "//chrome/android/java/proguard.flags",
                            "//base/android/base_proguard_config.flags",
                          ]
+      if (!enable_all_proguard_optimizations) {
+        proguard_configs += [ "//testing/android/proguard_for_test.flags" ]
+      }
     }
 
     if (!defined(use_chromium_linker)) {
diff --git a/chrome/android/chrome_public_test_apk.isolate b/chrome/android/chrome_public_test_apk.isolate
new file mode 100644
index 0000000..c2c623a
--- /dev/null
+++ b/chrome/android/chrome_public_test_apk.isolate
@@ -0,0 +1,27 @@
+# Copyright 2015 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+{
+  'includes': [
+    '../../build/android/android.isolate',
+    '../chrome_public_test_apk.isolate',
+  ],
+  'variables': {
+    'command': [
+      '<(PRODUCT_DIR)/bin/run_chrome_public_test_apk',
+      '--enable-platform-mode',
+      '-e', 'local',
+      '--logcat-output-dir', '${ISOLATED_OUTDIR}/logcats',
+    ],
+    'files': [
+      '../../third_party/proguard/',
+      '../chrome_public_test_apk.isolate',
+      '<(PRODUCT_DIR)/apks/ChromePublic.apk',
+      '<(PRODUCT_DIR)/apks/ChromePublicTest.apk',
+      '<(PRODUCT_DIR)/apks/ChromePublicTestSupport.apk',
+      '<(PRODUCT_DIR)/apks/ChromiumNetTestSupport.apk',
+      '<(PRODUCT_DIR)/bin/run_chrome_public_test_apk',
+      '<(PRODUCT_DIR)/test.lib.java/ChromePublicTest.jar',
+    ]
+  },
+}
diff --git a/chrome/android/chrome_sync_shell_test_apk.isolate b/chrome/android/chrome_sync_shell_test_apk.isolate
new file mode 100644
index 0000000..918323f
--- /dev/null
+++ b/chrome/android/chrome_sync_shell_test_apk.isolate
@@ -0,0 +1,24 @@
+# Copyright 2015 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+{
+  'includes': [
+    '../../build/android/android.isolate',
+  ],
+  'variables': {
+    'command': [
+      '<(PRODUCT_DIR)/bin/run_chrome_sync_shell_test_apk',
+      '--enable-platform-mode',
+      '-e', 'local',
+      '--logcat-output-dir', '${ISOLATED_OUTDIR}/logcats',
+    ],
+    'files': [
+      '../../third_party/proguard/',
+      '../test/data/',
+      '<(PRODUCT_DIR)/apks/ChromeSyncShell.apk',
+      '<(PRODUCT_DIR)/apks/ChromeSyncShellTest.apk',
+      '<(PRODUCT_DIR)/bin/run_chrome_sync_shell_test_apk',
+      '<(PRODUCT_DIR)/test.lib.java/',
+    ]
+  },
+}
diff --git a/chrome/android/java/res/drawable/notification_icon_bg.xml b/chrome/android/java/res/drawable/notification_icon_bg.xml
new file mode 100644
index 0000000..11ef229
--- /dev/null
+++ b/chrome/android/java/res/drawable/notification_icon_bg.xml
@@ -0,0 +1,15 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright 2014 The Chromium Authors. All rights reserved.
+
+     Use of this source code is governed by a BSD-style license that can be
+     found in the LICENSE file.
+-->
+
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+    android:shape="oval" >
+    <solid android:color="@color/light_active_color" />
+    <size
+        android:width="40dp"
+        android:height="40dp"/>
+</shape>
\ No newline at end of file
diff --git a/chrome/android/java/res/values/colors.xml b/chrome/android/java/res/values/colors.xml
index f3f3fbd..0b0254f 100644
--- a/chrome/android/java/res/values/colors.xml
+++ b/chrome/android/java/res/values/colors.xml
@@ -87,6 +87,7 @@
     <color name="signin_head_background">#fff</color>
     <color name="signin_body_background">#fafafa</color>
     <color name="signin_border_line_color">#000</color>
+    <color name="signin_disabled_button_text_color">#42000000</color>
 
     <!-- Sad Tab colors -->
     <color name="sad_tab_header_text_color">#333333</color>
diff --git a/chrome/android/java/res/values/dimens.xml b/chrome/android/java/res/values/dimens.xml
index 0884174..69b6db7 100644
--- a/chrome/android/java/res/values/dimens.xml
+++ b/chrome/android/java/res/values/dimens.xml
@@ -277,6 +277,7 @@
     <dimen name="ntp_search_box_material_padding_right">2dp</dimen>
     <dimen name="ntp_search_box_transition_length">16dp</dimen>
     <dimen name="ntp_wide_card_lateral_margins">48dp</dimen>
+    <dimen name="ntp_list_item_padding">16dp</dimen>
     <dimen name="ntp_list_item_min_height">48dp</dimen>
     <dimen name="ntp_list_item_text_size">16sp</dimen>
     <dimen name="ntp_shadow_height">9dp</dimen>
@@ -287,6 +288,12 @@
     <dimen name="snippets_card_9_patch_adjustment">2dp</dimen>
     <dimen name="snippets_article_header_height">40dp</dimen>
 
+    <!-- Interests page -->
+    <dimen name="ntp_interest_item_text_size">20sp</dimen>
+    <dimen name="ntp_interest_item_min_height">180dp</dimen>
+    <dimen name="ntp_interest_item_image_size">120dp</dimen>
+    <dimen name="ntp_interest_item_image_text_size">20sp</dimen>
+
     <!-- Recent tabs page -->
     <dimen name="recent_tabs_visible_separator_padding">8dp</dimen>
 
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ChromeApplication.java b/chrome/android/java/src/org/chromium/chrome/browser/ChromeApplication.java
index ace78a5..cadcc47 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ChromeApplication.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ChromeApplication.java
@@ -92,7 +92,7 @@ import org.chromium.chrome.browser.tabmodel.document.DocumentTabModelSelector;
 import org.chromium.chrome.browser.tabmodel.document.StorageDelegate;
 import org.chromium.chrome.browser.tabmodel.document.TabDelegate;
 import org.chromium.chrome.browser.util.FeatureUtilities;
-import org.chromium.chrome.browser.webapps.WebApkInstaller;
+import org.chromium.chrome.browser.webapps.WebApkBuilder;
 import org.chromium.components.sync.signin.AccountManagerDelegate;
 import org.chromium.components.sync.signin.AccountManagerHelper;
 import org.chromium.components.sync.signin.SystemAccountManagerDelegate;
@@ -307,7 +307,6 @@ public class ChromeApplication extends ContentApplication {
 
         ChildProcessLauncher.onSentToBackground();
         IntentHandler.clearPendingReferrer();
-        IntentHandler.clearPendingIncognitoIntent();
 
         if (FeatureUtilities.isDocumentMode(this)) {
             if (sDocumentTabModelSelector != null) {
@@ -365,9 +364,9 @@ public class ChromeApplication extends ContentApplication {
     }
 
     /**
-     * Returns factory for installing WebAPKs.
+     * Returns factory for building WebAPKs.
      */
-    public WebApkInstaller createWebApkInstaller() {
+    public WebApkBuilder createWebApkBuilder() {
         return null;
     }
 
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java b/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java
index fd45896..b250f78 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java
@@ -147,11 +147,6 @@ public class IntentHandler {
     public static final String EXTRA_EXTERNAL_NAV_PACKAGES = "org.chromium.chrome.browser.eenp";
 
     /**
-     * A hash code for the URL to verify intent data hasn't been modified.
-     */
-    public static final String EXTRA_DATA_HASH_CODE = "org.chromium.chrome.browser.data_hash";
-
-    /**
      * Fake ComponentName used in constructing TRUSTED_APPLICATION_CODE_EXTRA.
      */
     private static ComponentName sFakeComponentName = null;
@@ -160,7 +155,6 @@ public class IntentHandler {
 
     private static Pair<Integer, String> sPendingReferrer;
     private static int sReferrerId;
-    private static int sPendingHashCode;
 
     private static final String PACKAGE_GSA = "com.google.android.googlequicksearchbox";
     private static final String PACKAGE_GMAIL = "com.google.android.gm";
@@ -643,15 +637,7 @@ public class IntentHandler {
             if (!isInternal
                     && IntentUtils.safeGetBooleanExtra(
                                intent, EXTRA_OPEN_NEW_INCOGNITO_TAB, false)) {
-                // We also allow through intents from ExternalNavigationHandler that cannot be
-                // signed if they can be verified.
-                int hashCode = IntentUtils.safeGetIntExtra(intent, EXTRA_DATA_HASH_CODE, 0);
-                if (hashCode == 0
-                        || (intent.getData() != null && intent.getData().hashCode() != hashCode)
-                        || getPendingIncognitoIntentHashCode() != hashCode) {
-                    // Intent doesn't have EXTRA_DATA_HASH_CODE or the data field has been modified.
-                    return true;
-                }
+                return true;
             }
 
             // Now if we have an empty URL and the intent was ACTION_MAIN,
@@ -903,9 +889,6 @@ public class IntentHandler {
         return urlScheme != null && urlScheme.equals(GOOGLECHROME_SCHEME);
     }
 
-    // TODO(mariakhomenko): pending referrer and pending incognito intent could potentially
-    // not work correctly in multi-window. Store per-window information instead.
-
     /**
      * Records a pending referrer URL that we may be sending to ourselves through an intent.
      * @param intent The intent to which we add a referrer.
@@ -937,33 +920,6 @@ public class IntentHandler {
     }
 
     /**
-     * Keeps track of pending incognito intent, and verifies the URL hasn't been modified.
-     * @param intent The intent that will be sent.
-     */
-    public static void setPendingIncognitoIntent(Intent intent) {
-        if (intent.getData() != null) {
-            intent.putExtra(IntentHandler.EXTRA_OPEN_NEW_INCOGNITO_TAB, true);
-            int hashCode = intent.getData().hashCode();
-            intent.putExtra(IntentHandler.EXTRA_DATA_HASH_CODE, hashCode);
-            sPendingHashCode = hashCode;
-        }
-    }
-
-    /**
-     * Clears the pending incognito intent hash code.
-     */
-    public static void clearPendingIncognitoIntent() {
-        sPendingHashCode = 0;
-    }
-
-    /**
-     * @return Pending incognito intent hash code.
-     */
-    public static int getPendingIncognitoIntentHashCode() {
-        return sPendingHashCode;
-    }
-
-    /**
      * Some applications may request to load the URL with a particular transition type.
      * @param context The application context.
      * @param intent Intent causing the URL load, may be null.
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/KeyboardShortcuts.java b/chrome/android/java/src/org/chromium/chrome/browser/KeyboardShortcuts.java
index b1926e1..0655c4c 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/KeyboardShortcuts.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/KeyboardShortcuts.java
@@ -141,9 +141,6 @@ public class KeyboardShortcuts {
             case CTRL | SHIFT | KeyEvent.KEYCODE_N:
                 activity.onMenuOrKeyboardAction(R.id.new_incognito_tab_menu_id, false);
                 return true;
-            // Alt+E represents a special character ´ (latin code: &#180) in Android.
-            // If an EditText or ContentView has focus, Alt+E will be swallowed by
-            // the default dispatchKeyEvent and cannot open the menu.
             case ALT | KeyEvent.KEYCODE_E:
             case ALT | KeyEvent.KEYCODE_F:
             case KeyEvent.KEYCODE_F10:
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ShortcutHelper.java b/chrome/android/java/src/org/chromium/chrome/browser/ShortcutHelper.java
index 022ec47..6aef70f 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ShortcutHelper.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ShortcutHelper.java
@@ -33,12 +33,14 @@ import org.chromium.base.ThreadUtils;
 import org.chromium.base.VisibleForTesting;
 import org.chromium.base.annotations.CalledByNative;
 import org.chromium.chrome.R;
+import org.chromium.chrome.browser.webapps.WebApkBuilder;
 import org.chromium.chrome.browser.webapps.WebappAuthenticator;
 import org.chromium.chrome.browser.webapps.WebappDataStorage;
 import org.chromium.chrome.browser.webapps.WebappLauncherActivity;
 import org.chromium.chrome.browser.webapps.WebappRegistry;
 import org.chromium.chrome.browser.widget.RoundedIconGenerator;
 import org.chromium.content_public.common.ScreenOrientationConstants;
+import org.chromium.net.GURLUtils;
 import org.chromium.ui.widget.Toast;
 import org.chromium.webapk.lib.client.WebApkValidator;
 
@@ -129,6 +131,31 @@ public class ShortcutHelper {
     }
 
     /**
+     * Installs a WebAPK.
+     * This method must not be called on the UI thread.
+     */
+    @SuppressWarnings("unused")
+    @CalledByNative
+    private static void installWebApk(String url, String scopeUrl, final String name,
+            String shortName, String iconUrl, Bitmap icon, int displayMode, int orientation,
+            long themeColor, long backgroundColor, String manifestUrl) {
+        assert !ThreadUtils.runningOnUiThread();
+
+        Context context = ContextUtils.getApplicationContext();
+        WebApkBuilder apkBuilder = ((ChromeApplication) context).createWebApkBuilder();
+        if (apkBuilder == null) {
+            // TODO(pkotwicz): Figure out what to do when building WebAPK fails. (crbug.com/626950)
+            return;
+        }
+
+        if (TextUtils.isEmpty(scopeUrl)) {
+            scopeUrl = GURLUtils.getOrigin(url);
+        }
+        apkBuilder.buildWebApkAsync(url, scopeUrl, name, shortName, iconUrl, icon, displayMode,
+                orientation, themeColor, backgroundColor, manifestUrl);
+    }
+
+    /**
      * Adds home screen shortcut which opens in a {@link WebappActivity}.
      * This method must not be called on the UI thread.
      */
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkActionBar.java b/chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkActionBar.java
index 4603c88..a132253 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkActionBar.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkActionBar.java
@@ -123,13 +123,9 @@ public class BookmarkActionBar extends Toolbar implements BookmarkUIObserver,
         } else if (menuItem.getItemId() == R.id.selection_open_in_new_tab_id) {
             openBookmarksInNewTabs(mDelegate.getSelectedBookmarks(), new TabDelegate(false),
                     mDelegate.getModel());
-            mDelegate.clearSelection();
-            return true;
         } else if (menuItem.getItemId() == R.id.selection_open_in_incognito_tab_id) {
             openBookmarksInNewTabs(mDelegate.getSelectedBookmarks(), new TabDelegate(true),
                     mDelegate.getModel());
-            mDelegate.clearSelection();
-            return true;
         }
 
         assert false : "Unhandled menu click.";
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/compositor/bottombar/OverlayPanel.java b/chrome/android/java/src/org/chromium/chrome/browser/compositor/bottombar/OverlayPanel.java
index 36e994b..0e0e76f 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/compositor/bottombar/OverlayPanel.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/compositor/bottombar/OverlayPanel.java
@@ -412,13 +412,15 @@ public class OverlayPanel extends OverlayPanelAnimation implements ActivityState
                 // passing an empty implementation.
                 return new ContentVideoViewEmbedder() {
                     @Override
-                    public void enterFullscreenVideo(View view, boolean isVideoLoaded) {}
+                    public void enterFullscreenVideo(View view) {}
 
                     @Override
-                    public void fullscreenVideoLoaded() {}
+                    public void exitFullscreenVideo() {}
 
                     @Override
-                    public void exitFullscreenVideo() {}
+                    public View getVideoLoadingProgressView() {
+                        return null;
+                    }
 
                     @Override
                     public void setSystemUiVisibility(boolean enterFullscreen) {}
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/contextualsearch/TapSuppression.java b/chrome/android/java/src/org/chromium/chrome/browser/contextualsearch/TapSuppression.java
index 6892b05..07d6558 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/contextualsearch/TapSuppression.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/contextualsearch/TapSuppression.java
@@ -4,8 +4,6 @@
 
 package org.chromium.chrome.browser.contextualsearch;
 
-import org.chromium.base.metrics.RecordUserAction;
-
 /**
  * Heuristic for general Tap suppression that factors in a variety of signals.
  */
@@ -46,9 +44,6 @@ class TapSuppression extends ContextualSearchHeuristic {
                 doSuppressTap = !shouldHandle;
             } else {
                 doSuppressTap = !shouldHandleFirstTap();
-                if (doSuppressTap) {
-                    RecordUserAction.record("ContextualSearch.TapSuppressed.TapThresholdExceeded");
-                }
             }
         }
         mIsConditionSatisfied = doSuppressTap;
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/externalnav/ExternalNavigationHandler.java b/chrome/android/java/src/org/chromium/chrome/browser/externalnav/ExternalNavigationHandler.java
index d717db1..99c2a04 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/externalnav/ExternalNavigationHandler.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/externalnav/ExternalNavigationHandler.java
@@ -366,10 +366,6 @@ public class ExternalNavigationHandler {
             IntentHandler.setPendingReferrer(intent, params.getReferrerUrl());
         }
 
-        if (params.isIncognito()) {
-            IntentHandler.setPendingIncognitoIntent(intent);
-        }
-
         // Make sure webkit can handle it internally before checking for specialized
         // handlers. If webkit can't handle it internally, we need to call
         // startActivityIfNeeded or startActivity.
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/init/ChromeBrowserInitializer.java b/chrome/android/java/src/org/chromium/chrome/browser/init/ChromeBrowserInitializer.java
index f3855ea..87bc080 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/init/ChromeBrowserInitializer.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/init/ChromeBrowserInitializer.java
@@ -349,6 +349,7 @@ public class ChromeBrowserInitializer {
             BrowserStartupController.StartupCallback callback) throws ProcessInitException {
         try {
             TraceEvent.begin("ChromeBrowserInitializer.startChromeBrowserProcessesAsync");
+            mApplication.registerPolicyProviders(CombinedPolicyProvider.get());
             BrowserStartupController.get(mApplication, LibraryProcessType.PROCESS_BROWSER)
                     .startBrowserProcessesAsync(startGpuProcess, callback);
         } finally {
@@ -366,6 +367,9 @@ public class ChromeBrowserInitializer {
             libraryLoader.ensureInitialized(mApplication);
             StrictMode.setThreadPolicy(oldPolicy);
             libraryLoader.asyncPrefetchLibrariesToMemory();
+            // The policies are used by browser startup, so we need to register the policy providers
+            // before starting the browser process.
+            mApplication.registerPolicyProviders(CombinedPolicyProvider.get());
             BrowserStartupController.get(mApplication, LibraryProcessType.PROCESS_BROWSER)
                     .startBrowserProcessesSync(false);
             GoogleServicesManager.get(mApplication);
@@ -386,10 +390,6 @@ public class ChromeBrowserInitializer {
     private void onStartNativeInitialization() {
         ThreadUtils.assertOnUiThread();
         if (mNativeInitializationComplete) return;
-        // The policies are used by browser startup, so we need to register the policy providers
-        // before starting the browser process.
-        mApplication.registerPolicyProviders(CombinedPolicyProvider.get());
-
         SpeechRecognition.initialize(mApplication);
     }
 
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/AboveTheFoldListItem.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/AboveTheFoldListItem.java
index 98604a1..3e1efb8 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/AboveTheFoldListItem.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/AboveTheFoldListItem.java
@@ -13,9 +13,9 @@ package org.chromium.chrome.browser.ntp.cards;
  * Other elements coming after it and initially off-screen are just added to the RecyclerView after
  * that.
  */
-class AboveTheFoldListItem extends SingleItemGroup {
+class AboveTheFoldListItem implements NewTabPageListItem {
     @Override
     public int getType() {
         return NewTabPageListItem.VIEW_TYPE_ABOVE_THE_FOLD;
     }
-}
+}
\ No newline at end of file
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/ItemGroup.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/ItemGroup.java
deleted file mode 100644
index afa54b0..0000000
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/ItemGroup.java
+++ /dev/null
@@ -1,17 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-package org.chromium.chrome.browser.ntp.cards;
-
-import java.util.List;
-
-/**
- * A group of items.
- */
-public interface ItemGroup {
-    /**
-     * @return A list of items contained in this group. The list should not be modified.
-     */
-    List<NewTabPageListItem> getItems();
-}
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageAdapter.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageAdapter.java
index 61285b3..2f8c5ff 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageAdapter.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageAdapter.java
@@ -18,9 +18,6 @@ import org.chromium.chrome.browser.ntp.NewTabPageUma;
 import org.chromium.chrome.browser.ntp.NewTabPageView.NewTabPageManager;
 import org.chromium.chrome.browser.ntp.UiConfig;
 import org.chromium.chrome.browser.ntp.snippets.CategoryStatus;
-import org.chromium.chrome.browser.ntp.snippets.CategoryStatus.CategoryStatusEnum;
-import org.chromium.chrome.browser.ntp.snippets.KnownCategories;
-import org.chromium.chrome.browser.ntp.snippets.KnownCategories.KnownCategoriesEnum;
 import org.chromium.chrome.browser.ntp.snippets.SnippetArticleListItem;
 import org.chromium.chrome.browser.ntp.snippets.SnippetArticleViewHolder;
 import org.chromium.chrome.browser.ntp.snippets.SnippetHeaderListItem;
@@ -30,10 +27,7 @@ import org.chromium.chrome.browser.ntp.snippets.SnippetsSource;
 import org.chromium.chrome.browser.ntp.snippets.SnippetsSource.SnippetsObserver;
 
 import java.util.ArrayList;
-import java.util.Collections;
 import java.util.List;
-import java.util.Map;
-import java.util.TreeMap;
 
 /**
  * A class that handles merging above the fold elements and below the fold cards into an adapter
@@ -46,21 +40,18 @@ public class NewTabPageAdapter extends Adapter<NewTabPageViewHolder> implements
 
     private final NewTabPageManager mNewTabPageManager;
     private final NewTabPageLayout mNewTabPageLayout;
-    private SnippetsSource mSnippetsSource;
+    private final AboveTheFoldListItem mAboveTheFold;
+    private final SnippetHeaderListItem mHeader;
     private final UiConfig mUiConfig;
-    private final ItemTouchCallbacks mItemTouchCallbacks = new ItemTouchCallbacks();
+    private final ProgressListItem mProgressIndicator;
+    private StatusListItem mStatusCard;
+    private final SpacingListItem mBottomSpacer;
+    private final List<NewTabPageListItem> mItems;
+    private final ItemTouchCallbacks mItemTouchCallbacks;
     private NewTabPageRecyclerView mRecyclerView;
+    private int mProviderStatus;
 
-    /**
-     * List of all item groups (which can themselves contain multiple items. When flattened, this
-     * will be a list of all items the adapter exposes.
-     */
-    private final List<ItemGroup> mGroups = new ArrayList<>();
-    private final AboveTheFoldListItem mAboveTheFold = new AboveTheFoldListItem();
-    private final SpacingListItem mBottomSpacer = new SpacingListItem();
-
-    /** Maps suggestion categories to sections, with stable iteration ordering. */
-    private final Map<Integer, SuggestionsSection> mSections = new TreeMap<>();
+    private SnippetsSource mSnippetsSource;
 
     private class ItemTouchCallbacks extends ItemTouchHelper.Callback {
         @Override
@@ -123,14 +114,17 @@ public class NewTabPageAdapter extends Adapter<NewTabPageViewHolder> implements
             SnippetsSource snippetsSource, UiConfig uiConfig) {
         mNewTabPageManager = manager;
         mNewTabPageLayout = newTabPageLayout;
+        mAboveTheFold = new AboveTheFoldListItem();
+        mHeader = new SnippetHeaderListItem();
+        mProgressIndicator = new ProgressListItem();
+        mBottomSpacer = new SpacingListItem();
+        mItemTouchCallbacks = new ItemTouchCallbacks();
+        mItems = new ArrayList<>();
+        mProviderStatus = snippetsSource.getCategoryStatus();
         mSnippetsSource = snippetsSource;
         mUiConfig = uiConfig;
-
-        // TODO(mvanouwerkerk): Do not hard code ARTICLES. Maybe do not initialize an empty
-        // section in the constructor.
-        setSuggestions(KnownCategories.ARTICLES,
-                Collections.<SnippetArticleListItem>emptyList(),
-                snippetsSource.getCategoryStatus(KnownCategories.ARTICLES));
+        mStatusCard = StatusListItem.create(mProviderStatus, this);
+        loadSnippets(new ArrayList<SnippetArticleListItem>());
         snippetsSource.setObserver(this);
     }
 
@@ -140,50 +134,54 @@ public class NewTabPageAdapter extends Adapter<NewTabPageViewHolder> implements
     }
 
     @Override
-    public void onSuggestionsReceived(
-            @KnownCategoriesEnum int category, List<SnippetArticleListItem> suggestions) {
+    public void onSnippetsReceived(List<SnippetArticleListItem> snippets) {
         // We never want to refresh the suggestions if we already have some content.
-        if (mSections.containsKey(category) && mSections.get(category).hasSuggestions()) return;
+        if (hasSuggestions()) return;
 
-        // The status may have changed while the suggestions were loading, perhaps they should not
-        // be displayed any more.
-        if (!SnippetsBridge.isCategoryStatusInitOrAvailable(
-                    mSnippetsSource.getCategoryStatus(category))) {
+        if (!SnippetsBridge.isCategoryStatusInitOrAvailable(mProviderStatus)) {
             return;
         }
 
-        Log.d(TAG, "Received %d new suggestions for category %d.", suggestions.size(), category);
+        Log.d(TAG, "Received %d new snippets.", snippets.size());
 
-        // At first, there might be no suggestions available, we wait until they have been fetched.
-        if (suggestions.isEmpty()) return;
+        // At first, there might be no snippets available, we wait until they have been fetched.
+        if (snippets.isEmpty()) return;
 
-        setSuggestions(category, suggestions, mSnippetsSource.getCategoryStatus(category));
+        loadSnippets(snippets);
 
         NewTabPageUma.recordSnippetAction(NewTabPageUma.SNIPPETS_ACTION_SHOWN);
     }
 
     @Override
-    public void onCategoryStatusChanged(
-            @KnownCategoriesEnum int category, @CategoryStatusEnum int status) {
-        // Observers should not be registered for this state.
-        assert status != CategoryStatus.ALL_SUGGESTIONS_EXPLICITLY_DISABLED;
-
-        // If there is no section for this category there is nothing to do.
-        if (!mSections.containsKey(category)) return;
-
-        SuggestionsSection section = mSections.get(category);
-
-        // The section already has suggestions but we just got notified about the provider being
-        // enabled. Nothing to do.
-        if (SnippetsBridge.isCategoryStatusAvailable(status) && section.hasSuggestions()) return;
-
-        setSuggestions(category, Collections.<SnippetArticleListItem>emptyList(), status);
+    public void onCategoryStatusChanged(int categoryStatus) {
+        // Observers should not be registered for that state
+        assert categoryStatus != CategoryStatus.ALL_SUGGESTIONS_EXPLICITLY_DISABLED;
+
+        mProviderStatus = categoryStatus;
+        mStatusCard = StatusListItem.create(mProviderStatus, this);
+        mProgressIndicator.setVisible(SnippetsBridge.isCategoryLoading(mProviderStatus));
+
+        // We had suggestions but we just got notified about the provider being enabled. Nothing to
+        // do then.
+        if (SnippetsBridge.isCategoryStatusAvailable(mProviderStatus) && hasSuggestions()) return;
+
+        if (hasSuggestions()) {
+            // We have suggestions, this implies that the service was previously enabled and just
+            // transitioned to a disabled state. Clear them.
+            loadSnippets(new ArrayList<SnippetArticleListItem>());
+        } else {
+            // If there are no suggestions there is an old status card that must be replaced.
+            int firstCardPosition = getFirstCardPosition();
+            mItems.set(firstCardPosition, mStatusCard);
+            // Update both the status card, the progress indicator and the spacer after it.
+            notifyItemRangeChanged(firstCardPosition, 3);
+        }
     }
 
     @Override
     @NewTabPageListItem.ViewType
     public int getItemViewType(int position) {
-        return getItems().get(position).getType();
+        return mItems.get(position).getType();
     }
 
     @Override
@@ -220,36 +218,32 @@ public class NewTabPageAdapter extends Adapter<NewTabPageViewHolder> implements
 
     @Override
     public void onBindViewHolder(NewTabPageViewHolder holder, final int position) {
-        holder.onBindViewHolder(getItems().get(position));
+        holder.onBindViewHolder(mItems.get(position));
     }
 
     @Override
     public int getItemCount() {
-        return getItems().size();
+        return mItems.size();
     }
 
     public int getAboveTheFoldPosition() {
-        return getGroupPositionOffset(mAboveTheFold);
+        return mItems.indexOf(mAboveTheFold);
     }
 
-    public int getFirstHeaderPosition() {
-        List<NewTabPageListItem> items = getItems();
-        for (int i = 0; i < items.size(); i++) {
-            if (items.get(i) instanceof SnippetHeaderListItem) return i;
-        }
-        return RecyclerView.NO_POSITION;
+    public int getHeaderPosition() {
+        return mItems.indexOf(mHeader);
     }
 
     public int getFirstCardPosition() {
-        return getFirstHeaderPosition() + 1;
+        return getHeaderPosition() + 1;
     }
 
-    public int getLastContentItemPosition() {
+    public int getLastCardPosition() {
         return getBottomSpacerPosition() - 1;
     }
 
     public int getBottomSpacerPosition() {
-        return getGroupPositionOffset(mBottomSpacer);
+        return mItems.indexOf(mBottomSpacer);
     }
 
     /** Start a request for new snippets. */
@@ -257,23 +251,34 @@ public class NewTabPageAdapter extends Adapter<NewTabPageViewHolder> implements
         SnippetsBridge.fetchSnippets(/*forceRequest=*/true);
     }
 
-    private void setSuggestions(@KnownCategoriesEnum int category,
-            List<SnippetArticleListItem> suggestions, @CategoryStatusEnum int status) {
-        mGroups.clear();
-        mGroups.add(mAboveTheFold);
+    private void loadSnippets(List<SnippetArticleListItem> snippets) {
+        // Copy thumbnails over
+        for (SnippetArticleListItem snippet : snippets) {
+            int existingSnippetIdx = mItems.indexOf(snippet);
+            if (existingSnippetIdx == -1) continue;
 
-        if (!mSections.containsKey(category)) {
-            mSections.put(category,
-                    new SuggestionsSection(suggestions, status, this));
-        } else {
-            mSections.get(category).setSuggestions(suggestions, status, this);
+            snippet.setThumbnailBitmap(
+                    ((SnippetArticleListItem) mItems.get(existingSnippetIdx)).getThumbnailBitmap());
         }
 
-        mGroups.addAll(mSections.values());
+        boolean hasContentToShow = !snippets.isEmpty();
 
-        mGroups.add(mBottomSpacer);
+        // TODO(mvanouwerkerk): Make it so that the header does not need to be manipulated
+        // separately from the cards to which it belongs - crbug.com/616090.
+        mHeader.setVisible(hasContentToShow);
+
+        mItems.clear();
+        mItems.add(mAboveTheFold);
+        mItems.add(mHeader);
+        if (hasContentToShow) {
+            mItems.addAll(snippets);
+        } else {
+            mItems.add(mStatusCard);
+            mItems.add(mProgressIndicator);
+        }
+
+        mItems.add(mBottomSpacer);
 
-        // TODO(bauerb): Notify about a smaller range.
         notifyDataSetChanged();
     }
 
@@ -295,9 +300,9 @@ public class NewTabPageAdapter extends Adapter<NewTabPageViewHolder> implements
         assert itemViewHolder.getItemViewType() == NewTabPageListItem.VIEW_TYPE_SNIPPET;
 
         int position = itemViewHolder.getAdapterPosition();
-        SnippetArticleListItem suggestion = (SnippetArticleListItem) getItems().get(position);
+        SnippetArticleListItem dismissedSnippet = (SnippetArticleListItem) mItems.get(position);
 
-        mSnippetsSource.getSnippedVisited(suggestion, new Callback<Boolean>() {
+        mSnippetsSource.getSnippedVisited(dismissedSnippet, new Callback<Boolean>() {
             @Override
             public void onResult(Boolean result) {
                 NewTabPageUma.recordSnippetAction(result
@@ -306,48 +311,33 @@ public class NewTabPageAdapter extends Adapter<NewTabPageViewHolder> implements
             }
         });
 
-        mSnippetsSource.discardSnippet(suggestion);
-        SuggestionsSection section = (SuggestionsSection) getGroup(position);
-        section.dismissSuggestion(suggestion);
+        mSnippetsSource.discardSnippet(dismissedSnippet);
+        mItems.remove(position);
+        notifyItemRemoved(position);
 
-        if (section.hasSuggestions()) {
-            // If one of many suggestions was dismissed, it's a simple item removal, which can be
-            // animated smoothly by the RecyclerView.
-            notifyItemRemoved(position);
-        } else {
-            // If the last suggestion was dismissed, multiple items will have changed, so mark
-            // everything as changed.
-            notifyDataSetChanged();
-        }
+        addStatusCardIfNecessary();
     }
 
-    /**
-     * Returns an unmodifiable list containing all items in the adapter.
-     */
-    List<NewTabPageListItem> getItems() {
-        List<NewTabPageListItem> items = new ArrayList<>();
-        for (ItemGroup group : mGroups) {
-            items.addAll(group.getItems());
+    private void addStatusCardIfNecessary() {
+        if (!hasSuggestions() && !mItems.contains(mStatusCard)) {
+            mItems.add(getFirstCardPosition(), mStatusCard);
+            mItems.add(getFirstCardPosition() + 1, mProgressIndicator);
+
+            // We also want to refresh the header and the bottom padding.
+            mHeader.setVisible(false);
+            notifyDataSetChanged();
         }
-        return Collections.unmodifiableList(items);
     }
 
-    private ItemGroup getGroup(int itemPosition) {
-        int itemsSkipped = 0;
-        for (ItemGroup group : mGroups) {
-            List<NewTabPageListItem> items = group.getItems();
-            itemsSkipped += items.size();
-            if (itemPosition < itemsSkipped) return group;
+    /** Returns whether we have some suggested content to display. */
+    private boolean hasSuggestions() {
+        for (NewTabPageListItem item : mItems) {
+            if (item instanceof SnippetArticleListItem) return true;
         }
-        return null;
+        return false;
     }
 
-    private int getGroupPositionOffset(ItemGroup group) {
-        int positionOffset = 0;
-        for (ItemGroup candidateGroup : mGroups) {
-            if (candidateGroup == group) return positionOffset;
-            positionOffset += candidateGroup.getItems().size();
-        }
-        return RecyclerView.NO_POSITION;
+    List<NewTabPageListItem> getItemsForTesting() {
+        return mItems;
     }
 }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageRecyclerView.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageRecyclerView.java
index 951e988..ca9042f 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageRecyclerView.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageRecyclerView.java
@@ -147,12 +147,12 @@ public class NewTabPageRecyclerView extends RecyclerView {
         int firstVisiblePos = mLayoutManager.findFirstVisibleItemPosition();
 
         // We have enough items to fill the view, since the snap point item is not even visible.
-        if (firstVisiblePos > getNewTabPageAdapter().getFirstHeaderPosition()) {
+        if (firstVisiblePos > getNewTabPageAdapter().getHeaderPosition()) {
             return mMinBottomSpacing;
         }
 
         ViewHolder lastContentItem = findLastContentItem();
-        ViewHolder firstHeader = findFirstHeader();
+        ViewHolder firstHeader = findHeader();
 
         int bottomSpacing = getHeight() - mToolbarHeight;
         if (lastContentItem == null || firstHeader == null) {
@@ -199,7 +199,7 @@ public class NewTabPageRecyclerView extends RecyclerView {
      * top of the screen.
      */
     public void updateSnippetsHeaderDisplay() {
-        SnippetHeaderViewHolder header = findFirstHeader();
+        SnippetHeaderViewHolder header = findHeader();
         if (header == null) return;
 
         if (findAboveTheFoldView() == null) return;
@@ -219,9 +219,9 @@ public class NewTabPageRecyclerView extends RecyclerView {
      * Finds the view holder for the first header.
      * @return The {@link ViewHolder} of the header, or null if it is not present.
      */
-    private SnippetHeaderViewHolder findFirstHeader() {
+    private SnippetHeaderViewHolder findHeader() {
         ViewHolder viewHolder =
-                findViewHolderForAdapterPosition(getNewTabPageAdapter().getFirstHeaderPosition());
+                findViewHolderForAdapterPosition(getNewTabPageAdapter().getHeaderPosition());
         if (!(viewHolder instanceof SnippetHeaderViewHolder)) return null;
 
         return (SnippetHeaderViewHolder) viewHolder;
@@ -244,8 +244,8 @@ public class NewTabPageRecyclerView extends RecyclerView {
      * @return The {@link ViewHolder} of the last content item, or null if it is not present.
      */
     private ViewHolder findLastContentItem() {
-        ViewHolder viewHolder = findViewHolderForAdapterPosition(
-                getNewTabPageAdapter().getLastContentItemPosition());
+        ViewHolder viewHolder =
+                findViewHolderForAdapterPosition(getNewTabPageAdapter().getLastCardPosition());
         if (viewHolder instanceof CardViewHolder) return viewHolder;
         if (viewHolder instanceof ProgressViewHolder) return viewHolder;
 
@@ -329,13 +329,13 @@ public class NewTabPageRecyclerView extends RecyclerView {
 
         // Snap scroll to prevent resting in the middle of the peeking card transition
         // and to allow the peeking card to peek a bit before snapping back.
-        CardViewHolder peekingCardViewHolder = findFirstCard();
-        if (peekingCardViewHolder != null && isFirstItemVisible()) {
+        if (findFirstCard() != null && isFirstItemVisible()) {
+            CardViewHolder peekingCardViewHolder = findFirstCard();
 
             if (!peekingCardViewHolder.getCanPeek()) return;
 
-            View peekingCardView = peekingCardViewHolder.itemView;
-            View headerView = findFirstHeader().itemView;
+            View peekingCardView = findFirstCard().itemView;
+            View headerView = findHeader().itemView;
             final int peekingHeight = getResources().getDimensionPixelSize(
                     R.dimen.snippets_padding_and_peeking_card_height);
 
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SingleItemGroup.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SingleItemGroup.java
deleted file mode 100644
index dd93ff7..0000000
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SingleItemGroup.java
+++ /dev/null
@@ -1,21 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-package org.chromium.chrome.browser.ntp.cards;
-
-import java.util.Collections;
-import java.util.List;
-
-/**
- * A single item that represents itself as a group.
- */
-public abstract class SingleItemGroup implements ItemGroup, NewTabPageListItem {
-    private final List<NewTabPageListItem> mItems =
-            Collections.<NewTabPageListItem>singletonList(this);
-
-    @Override
-    public List<NewTabPageListItem> getItems() {
-        return mItems;
-    }
-}
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SpacingListItem.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SpacingListItem.java
index e23c0b9..2153d09 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SpacingListItem.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SpacingListItem.java
@@ -13,7 +13,7 @@ import android.view.ViewGroup;
  * contain enough of them. It is displayed as a dummy item with variable height that just occupies
  * the remaining space between the last item in the RecyclerView and the bottom of the screen.
  */
-public class SpacingListItem extends SingleItemGroup {
+public class SpacingListItem implements NewTabPageListItem {
     private static class SpacingListItemView extends View {
         public SpacingListItemView(Context context) {
             super(context);
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/StatusListItem.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/StatusListItem.java
index dac9ab5..6e05119 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/StatusListItem.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/StatusListItem.java
@@ -14,7 +14,6 @@ import org.chromium.base.Log;
 import org.chromium.chrome.R;
 import org.chromium.chrome.browser.ntp.UiConfig;
 import org.chromium.chrome.browser.ntp.snippets.CategoryStatus;
-import org.chromium.chrome.browser.ntp.snippets.CategoryStatus.CategoryStatusEnum;
 import org.chromium.chrome.browser.signin.AccountSigninActivity;
 import org.chromium.chrome.browser.signin.SigninAccessPoint;
 
@@ -136,8 +135,7 @@ public abstract class StatusListItem implements NewTabPageListItem {
     private final int mDescriptionStringId;
     private final int mActionStringId;
 
-    public static StatusListItem create(@CategoryStatusEnum int categoryStatus,
-            NewTabPageAdapter adapter) {
+    public static StatusListItem create(int categoryStatus, NewTabPageAdapter adapter) {
         switch (categoryStatus) {
             // TODO(dgn): AVAILABLE_LOADING and INITIALIZING should show a progress indicator.
             case CategoryStatus.AVAILABLE:
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SuggestionsSection.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SuggestionsSection.java
deleted file mode 100644
index f3d98d2..0000000
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/cards/SuggestionsSection.java
+++ /dev/null
@@ -1,76 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-package org.chromium.chrome.browser.ntp.cards;
-
-import org.chromium.chrome.browser.ntp.snippets.CategoryStatus.CategoryStatusEnum;
-import org.chromium.chrome.browser.ntp.snippets.SnippetArticleListItem;
-import org.chromium.chrome.browser.ntp.snippets.SnippetHeaderListItem;
-import org.chromium.chrome.browser.ntp.snippets.SnippetsBridge;
-
-import java.util.ArrayList;
-import java.util.Collections;
-import java.util.List;
-
-/**
- * A group of suggestions, with a header, a status card, and a progress indicator.
- */
-public class SuggestionsSection implements ItemGroup {
-    private final List<SnippetArticleListItem> mSuggestions = new ArrayList<>();
-    private final SnippetHeaderListItem mHeader = new SnippetHeaderListItem();
-    private StatusListItem mStatus;
-    private final ProgressListItem mProgressIndicator = new ProgressListItem();
-
-    public SuggestionsSection(List<SnippetArticleListItem> suggestions,
-            @CategoryStatusEnum int status, NewTabPageAdapter adapter) {
-        // TODO(mvanouwerkerk): Pass in the header text.
-        setSuggestions(suggestions, status, adapter);
-    }
-
-    @Override
-    public List<NewTabPageListItem> getItems() {
-        List<NewTabPageListItem> items = new ArrayList<>();
-        items.add(mHeader);
-        items.addAll(mSuggestions);
-        if (mSuggestions.isEmpty()) {
-            items.add(mStatus);
-            items.add(mProgressIndicator);
-        }
-        return Collections.unmodifiableList(items);
-    }
-
-    public void dismissSuggestion(SnippetArticleListItem suggestion) {
-        mSuggestions.remove(suggestion);
-
-        if (mSuggestions.isEmpty()) {
-            mHeader.setVisible(false);
-        }
-    }
-
-    public boolean hasSuggestions() {
-        return !mSuggestions.isEmpty();
-    }
-
-    public void setSuggestions(List<SnippetArticleListItem> suggestions,
-            @CategoryStatusEnum int status, NewTabPageAdapter adapter) {
-        copyThumbnails(suggestions);
-
-        mHeader.setVisible(!suggestions.isEmpty());
-
-        mStatus = StatusListItem.create(status, adapter);
-        mProgressIndicator.setVisible(SnippetsBridge.isCategoryLoading(status));
-
-        mSuggestions.clear();
-        mSuggestions.addAll(suggestions);
-    }
-
-    private void copyThumbnails(List<SnippetArticleListItem> suggestions) {
-        for (SnippetArticleListItem suggestion : suggestions) {
-            int index = mSuggestions.indexOf(suggestion);
-            if (index == -1) continue;
-
-            suggestion.setThumbnailBitmap(mSuggestions.get(index).getThumbnailBitmap());
-        }
-    }
-}
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetArticleListItem.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetArticleListItem.java
index e10051f..00e6715 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetArticleListItem.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetArticleListItem.java
@@ -13,31 +13,14 @@ import org.chromium.chrome.browser.ntp.cards.NewTabPageListItem;
  * Represents the data for an article card on the NTP.
  */
 public class SnippetArticleListItem implements NewTabPageListItem {
-    /** The unique identifier for this article. */
     public final String mId;
-
-    /** The title of this article. */
     public final String mTitle;
-
-    /** The canonical publisher name (e.g., New York Times). */
     public final String mPublisher;
-
-    /** The snippet preview text. */
     public final String mPreviewText;
-
-    /** The URL of this article. */
     public final String mUrl;
-
-    /** the AMP url for this article (possible for this to be empty). */
     public final String mAmpUrl;
-
-    /** The time when this article was published. */
     public final long mPublishTimestampMilliseconds;
-
-    /** The score expressing relative quality of the article for the user. */
     public final float mScore;
-
-    /** The position of this article in the whole list of snippets. */
     public final int mPosition;
 
     /** Bitmap of the thumbnail, fetched lazily, when the RecyclerView wants to show the snippet. */
@@ -51,6 +34,14 @@ public class SnippetArticleListItem implements NewTabPageListItem {
 
     /**
      * Creates a SnippetArticleListItem object that will hold the data.
+     * @param title the title of the article
+     * @param publisher the canonical publisher name (e.g., New York Times)
+     * @param previewText the snippet preview text
+     * @param url the URL of the article
+     * @param ampUrl the AMP url for the article (possible for this to be empty)
+     * @param timestamp the time in ms when this article was published
+     * @param score the score expressing relative quality of the article for the user
+     * @param position the position of this article in the list of snippets
      */
     public SnippetArticleListItem(String id, String title, String publisher, String previewText,
             String url, String ampUrl, long timestamp, float score, int position) {
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetsBridge.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetsBridge.java
index 98a8415..8e79401 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetsBridge.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetsBridge.java
@@ -8,8 +8,6 @@ import android.graphics.Bitmap;
 
 import org.chromium.base.Callback;
 import org.chromium.base.annotations.CalledByNative;
-import org.chromium.chrome.browser.ntp.snippets.CategoryStatus.CategoryStatusEnum;
-import org.chromium.chrome.browser.ntp.snippets.KnownCategories.KnownCategoriesEnum;
 import org.chromium.chrome.browser.profiles.Profile;
 
 import java.util.ArrayList;
@@ -24,17 +22,17 @@ public class SnippetsBridge implements SnippetsSource {
     private long mNativeSnippetsBridge;
     private SnippetsObserver mObserver;
 
-    public static boolean isCategoryStatusAvailable(@CategoryStatusEnum int status) {
+    public static boolean isCategoryStatusAvailable(int status) {
         // Note: This code is duplicated in content_suggestions_category_status.cc.
         return status == CategoryStatus.AVAILABLE_LOADING || status == CategoryStatus.AVAILABLE;
     }
 
-    public static boolean isCategoryStatusInitOrAvailable(@CategoryStatusEnum int status) {
+    public static boolean isCategoryStatusInitOrAvailable(int status) {
         // Note: This code is duplicated in content_suggestions_category_status.cc.
         return status == CategoryStatus.INITIALIZING || isCategoryStatusAvailable(status);
     }
 
-    public static boolean isCategoryLoading(@CategoryStatusEnum int status) {
+    public static boolean isCategoryLoading(int status) {
         return status == CategoryStatus.AVAILABLE_LOADING || status == CategoryStatus.INITIALIZING;
     }
 
@@ -120,39 +118,29 @@ public class SnippetsBridge implements SnippetsSource {
     }
 
     @Override
-    @CategoryStatusEnum
-    public int getCategoryStatus(@KnownCategoriesEnum int category) {
+    public int getCategoryStatus() {
         assert mNativeSnippetsBridge != 0;
-        return nativeGetCategoryStatus(mNativeSnippetsBridge, category);
+        return nativeGetCategoryStatus(mNativeSnippetsBridge);
     }
 
     @CalledByNative
-    private static List<SnippetArticleListItem> createSuggestionList() {
-        return new ArrayList<>();
-    }
-
-    @CalledByNative
-    private static void addSuggestion(List<SnippetArticleListItem> suggestions, String id,
-            String title, String publisher, String previewText, String url, String ampUrl,
-            long timestamp, float score) {
-        int position = suggestions.size();
-        suggestions.add(new SnippetArticleListItem(id, title, publisher, previewText, url, ampUrl,
-                timestamp, score, position));
-    }
-
-    @CalledByNative
-    private void onSuggestionsAvailable(/* @KnownCategoriesEnum */ int category,
-            List<SnippetArticleListItem> suggestions) {
+    private void onSnippetsAvailable(String[] ids, String[] titles, String[] urls, String[] ampUrls,
+            String[] previewText, long[] timestamps, String[] publishers, float[] scores) {
         assert mNativeSnippetsBridge != 0;
         assert mObserver != null;
 
-        mObserver.onSuggestionsReceived(category, suggestions);
+        List<SnippetArticleListItem> newSnippets = new ArrayList<>(ids.length);
+        for (int i = 0; i < ids.length; i++) {
+            newSnippets.add(new SnippetArticleListItem(ids[i], titles[i], publishers[i],
+                    previewText[i], urls[i], ampUrls[i], timestamps[i], scores[i], i));
+        }
+
+        mObserver.onSnippetsReceived(newSnippets);
     }
 
     @CalledByNative
-    private void onCategoryStatusChanged(/* @KnownCategoriesEnum */ int category,
-            /* @CategoryStatusEnum */ int newStatus) {
-        if (mObserver != null) mObserver.onCategoryStatusChanged(category, newStatus);
+    private void onCategoryStatusChanged(int newStatus) {
+        if (mObserver != null) mObserver.onCategoryStatusChanged(newStatus);
     }
 
     private native long nativeInit(Profile profile);
@@ -165,5 +153,5 @@ public class SnippetsBridge implements SnippetsSource {
             Callback<Boolean> callback, String url);
     private native void nativeFetchImage(
             long nativeNTPSnippetsBridge, String snippetId, Callback<Bitmap> callback);
-    private native int nativeGetCategoryStatus(long nativeNTPSnippetsBridge, int category);
+    private native int nativeGetCategoryStatus(long nativeNTPSnippetsBridge);
 }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetsSource.java b/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetsSource.java
index baab92e..5440249 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetsSource.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ntp/snippets/SnippetsSource.java
@@ -7,25 +7,22 @@ package org.chromium.chrome.browser.ntp.snippets;
 import android.graphics.Bitmap;
 
 import org.chromium.base.Callback;
-import org.chromium.chrome.browser.ntp.snippets.CategoryStatus.CategoryStatusEnum;
-import org.chromium.chrome.browser.ntp.snippets.KnownCategories.KnownCategoriesEnum;
 
 import java.util.List;
 
+
 /**
- * An interface for classes that provide snippets.
+ * An interface for classes that provide Snippets.
  */
 public interface SnippetsSource {
     /**
      * An observer for events in the snippets service.
      */
     public interface SnippetsObserver {
-        void onSuggestionsReceived(@KnownCategoriesEnum int category,
-                List<SnippetArticleListItem> snippets);
+        void onSnippetsReceived(List<SnippetArticleListItem> snippets);
 
-        /** Called when a category changed its status. */
-        void onCategoryStatusChanged(@KnownCategoriesEnum int category,
-                @CategoryStatusEnum int newStatus);
+        /** Called when the ARTICLES category changed its status. */
+        void onCategoryStatusChanged(int newStatus);
     }
 
     /**
@@ -51,5 +48,5 @@ public interface SnippetsSource {
     /**
      * Gives the reason snippets are disabled.
      */
-    public int getCategoryStatus(@KnownCategoriesEnum int category);
+    public int getCategoryStatus();
 }
\ No newline at end of file
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/payments/PaymentRequestImpl.java b/chrome/android/java/src/org/chromium/chrome/browser/payments/PaymentRequestImpl.java
index 653f20b..f96699e 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/payments/PaymentRequestImpl.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/payments/PaymentRequestImpl.java
@@ -157,7 +157,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
     private boolean mPaymentAppRunning;
     private boolean mMerchantSupportsAutofillPaymentInstruments;
     private ContactEditor mContactEditor;
-    private boolean mHasRecordedAbortReason;
 
     /**
      * Builds the PaymentRequest service implementation.
@@ -223,16 +222,12 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
 
         if (mMethodData != null) {
             disconnectFromClientWithDebugMessage("PaymentRequest.show() called more than once.");
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_INVALID_DATA_FROM_RENDERER);
             return;
         }
 
         mMethodData = getValidatedMethodData(methodData, mCardEditor);
         if (mMethodData == null) {
             disconnectFromClientWithDebugMessage("Invalid payment methods or data");
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_INVALID_DATA_FROM_RENDERER);
             return;
         }
 
@@ -242,8 +237,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
             disconnectFromClientWithDebugMessage("Requested payment methods are not supported",
                     PaymentErrorReason.NOT_SUPPORTED);
             if (sObserverForTest != null) sObserverForTest.onPaymentRequestServiceShowFailed();
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_NO_SUPPORTED_PAYMENT_METHOD);
             return;
         }
 
@@ -434,8 +427,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
         if (mUI == null) {
             disconnectFromClientWithDebugMessage(
                     "PaymentRequestUpdateEvent.updateWith() called without PaymentRequest.show()");
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_INVALID_DATA_FROM_RENDERER);
             return;
         }
 
@@ -446,7 +437,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
         if (mUiShippingOptions.isEmpty() && !mMerchantNeedsShippingAddress) {
             disconnectFromClientWithDebugMessage("Merchant indicates inability to ship although "
                     + "originally indicated that can ship anywhere");
-            recordAbortReasonHistogram(PaymentRequestMetrics.ABORT_REASON_OTHER);
             return;
         }
 
@@ -475,15 +465,11 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
     private boolean parseAndValidateDetailsOrDisconnectFromClient(PaymentDetails details) {
         if (details == null) {
             disconnectFromClientWithDebugMessage("Payment details required");
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_INVALID_DATA_FROM_RENDERER);
             return false;
         }
 
         if (!hasAllPaymentItemFields(details.total)) {
             disconnectFromClientWithDebugMessage("Invalid total");
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_INVALID_DATA_FROM_RENDERER);
             return false;
         }
 
@@ -493,16 +479,12 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
 
         if (!formatter.isValidAmountCurrencyCode(details.total.amount.currency)) {
             disconnectFromClientWithDebugMessage("Invalid total amount currency");
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_INVALID_DATA_FROM_RENDERER);
             return false;
         }
 
         if (!formatter.isValidAmountValue(details.total.amount.value)
                 || details.total.amount.value.startsWith("-")) {
             disconnectFromClientWithDebugMessage("Invalid total amount value");
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_INVALID_DATA_FROM_RENDERER);
             return false;
         }
 
@@ -513,8 +495,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
                 formatter);
         if (uiLineItems == null) {
             disconnectFromClientWithDebugMessage("Invalid line items");
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_INVALID_DATA_FROM_RENDERER);
             return false;
         }
 
@@ -526,8 +506,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
                 formatter);
         if (mUiShippingOptions == null) {
             disconnectFromClientWithDebugMessage("Invalid shipping options");
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_INVALID_DATA_FROM_RENDERER);
             return false;
         }
 
@@ -833,8 +811,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
     @Override
     public void onDismiss() {
         disconnectFromClientWithDebugMessage("Dialog dismissed");
-        closeUI(false);
-        recordAbortReasonHistogram(PaymentRequestMetrics.ABORT_REASON_ABORTED_BY_USER);
     }
 
     private void disconnectFromClientWithDebugMessage(String debugMessage) {
@@ -865,7 +841,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
         } else {
             closeClient();
             closeUI(false);
-            recordAbortReasonHistogram(PaymentRequestMetrics.ABORT_REASON_ABORTED_BY_MERCHANT);
         }
     }
 
@@ -887,7 +862,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
         if (mClient == null) return;
         closeClient();
         closeUI(false);
-        recordAbortReasonHistogram(PaymentRequestMetrics.ABORT_REASON_MOJO_RENDERER_CLOSING);
     }
 
     /**
@@ -898,7 +872,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
         if (mClient == null) return;
         closeClient();
         closeUI(false);
-        recordAbortReasonHistogram(PaymentRequestMetrics.ABORT_REASON_MOJO_CONNECTION_ERROR);
     }
 
     /**
@@ -932,8 +905,6 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
             disconnectFromClientWithDebugMessage("Requested payment methods have no instruments",
                     PaymentErrorReason.NOT_SUPPORTED);
             if (sObserverForTest != null) sObserverForTest.onPaymentRequestServiceShowFailed();
-            recordAbortReasonHistogram(
-                    PaymentRequestMetrics.ABORT_REASON_NO_MATCHING_PAYMENT_METHOD);
             return;
         }
 
@@ -1096,19 +1067,4 @@ public class PaymentRequestImpl implements PaymentRequest, PaymentRequestUI.Clie
     private void recordSuccessFunnelHistograms(String funnelPart) {
         RecordHistogram.recordBooleanHistogram("PaymentRequest.CheckoutFunnel." + funnelPart, true);
     }
-
-    /**
-     * Adds an entry to the aborted Payment Request histogram in the bucket corresponding to the
-     * reason for aborting. Only records the initial reason for aborting, as some closing code calls
-     * other closing code that can log too.
-     */
-    private void recordAbortReasonHistogram(int abortReason) {
-        assert abortReason < PaymentRequestMetrics.ABORT_REASON_MAX;
-        if (mHasRecordedAbortReason) return;
-
-        mHasRecordedAbortReason = true;
-        RecordHistogram.recordEnumeratedHistogram(
-                "PaymentRequest.CheckoutFunnel.Aborted", abortReason,
-                PaymentRequestMetrics.ABORT_REASON_MAX);
-    }
 }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/payments/PaymentRequestMetrics.java b/chrome/android/java/src/org/chromium/chrome/browser/payments/PaymentRequestMetrics.java
index 6aa7e3f..0d312e9 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/payments/PaymentRequestMetrics.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/payments/PaymentRequestMetrics.java
@@ -24,28 +24,6 @@ public final class PaymentRequestMetrics {
     @VisibleForTesting
     public static final int REQUESTED_INFORMATION_MAX = 8;
 
-    // PaymentRequestAbortReason defined in tools/metrics/histograms/histograms.xml.
-    @VisibleForTesting
-    public static final int ABORT_REASON_ABORTED_BY_USER = 0;
-    @VisibleForTesting
-    public static final int ABORT_REASON_ABORTED_BY_MERCHANT = 1;
-    @VisibleForTesting
-    public static final int ABORT_REASON_INVALID_DATA_FROM_RENDERER = 2;
-    @VisibleForTesting
-    public static final int ABORT_REASON_MOJO_CONNECTION_ERROR = 3;
-    @VisibleForTesting
-    public static final int ABORT_REASON_MOJO_RENDERER_CLOSING = 4;
-    @VisibleForTesting
-    public static final int ABORT_REASON_INSTRUMENT_DETAILS_ERROR = 5;
-    @VisibleForTesting
-    public static final int ABORT_REASON_NO_MATCHING_PAYMENT_METHOD = 6;
-    @VisibleForTesting
-    public static final int ABORT_REASON_NO_SUPPORTED_PAYMENT_METHOD = 7;
-    @VisibleForTesting
-    public static final int ABORT_REASON_OTHER = 8;
-    @VisibleForTesting
-    public static final int ABORT_REASON_MAX = 9;
-
     // There should be no instance of PaymentRequestMetrics created.
     private PaymentRequestMetrics() {}
 
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tab/Tab.java b/chrome/android/java/src/org/chromium/chrome/browser/tab/Tab.java
index 8f75bc1..7b182a1 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/tab/Tab.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tab/Tab.java
@@ -503,8 +503,8 @@ public class Tab implements ViewGroup.OnHierarchyChangeListener,
         public ContentVideoViewEmbedder getContentVideoViewEmbedder() {
             return new ActivityContentVideoViewEmbedder(getActivity()) {
                 @Override
-                public void enterFullscreenVideo(View view, boolean isVideoLoaded) {
-                    super.enterFullscreenVideo(view, isVideoLoaded);
+                public void enterFullscreenVideo(View view) {
+                    super.enterFullscreenVideo(view);
                     FullscreenManager fullscreenManager = getFullscreenManager();
                     if (fullscreenManager != null) {
                         fullscreenManager.setOverlayVideoMode(true);
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/webapps/WebApkBuilder.java b/chrome/android/java/src/org/chromium/chrome/browser/webapps/WebApkBuilder.java
new file mode 100644
index 0000000..4151436
--- /dev/null
+++ b/chrome/android/java/src/org/chromium/chrome/browser/webapps/WebApkBuilder.java
@@ -0,0 +1,34 @@
+// Copyright 2016 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+package org.chromium.chrome.browser.webapps;
+
+import android.graphics.Bitmap;
+
+/**
+ * Interface for building WebAPKs.
+ */
+public interface WebApkBuilder {
+    /**
+     * Asynchronously build WebAPK.
+     * @param startUrl        The url that the WebAPK should navigate to when launched from the app
+     *                        list.
+     * @param scope           Navigations from the WebAPK to URLs with sub-origin {@link scope} will
+     *                        stay within the WebAPK.
+     * @param name            "name" from the Web Manifest.
+     * @param shortName       "short_name" from the Web Manifest.
+     * @param iconUrl         Url of the icon for the app list. Url of the favicon if the Web
+     *                        Manifest does not specify an icon.
+     * @param icon            Icon for the app list. Generated icon or favicon if the Web Manifest
+     *                        does not specify an icon.
+     * @param displayMode     "display" from the Web Manifest.
+     * @param orientation     "orientation" from the Web Manifest.
+     * @param themeColor      "theme_color" from the Web Manifest.
+     * @param backgroundColor "background_color" from the Web Manifest.
+     * @param manifestUrl     The URL of the Web Manifest.
+     */
+    void buildWebApkAsync(String startUrl, String scope, String name, String shortName,
+            String iconUrl, Bitmap icon, int displayMode, int orientation, long themeColor,
+            long backgroundColor, String manifestUrl);
+}
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/webapps/WebApkInstaller.java b/chrome/android/java/src/org/chromium/chrome/browser/webapps/WebApkInstaller.java
deleted file mode 100644
index 86aa4f5..0000000
--- a/chrome/android/java/src/org/chromium/chrome/browser/webapps/WebApkInstaller.java
+++ /dev/null
@@ -1,37 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-package org.chromium.chrome.browser.webapps;
-
-import android.content.Context;
-
-import org.chromium.base.ContextUtils;
-import org.chromium.base.annotations.CalledByNative;
-import org.chromium.chrome.browser.ChromeApplication;
-
-/**
- * Java counterpart to webapk_installer.h
- * Contains functionality to install WebAPKs.
- */
-public abstract class WebApkInstaller {
-    /**
-     * Installs a WebAPK.
-     * @param filePath File to install.
-     * @param packageName Package name to install WebAPK at.
-     * @return True if the install was started. A "true" return value does not guarantee that the
-     *         install succeeds.
-     */
-    public abstract boolean installAsync(String filePath, String packageName);
-
-    @CalledByNative
-    static boolean installAsyncFromNative(String filePath, String packageName) {
-        Context context = ContextUtils.getApplicationContext();
-        WebApkInstaller apkInstaller = ((ChromeApplication) context).createWebApkInstaller();
-        if (apkInstaller == null) {
-            return false;
-        }
-        apkInstaller.installAsync(filePath, packageName);
-        return true;
-    }
-}
diff --git a/chrome/android/java_sources.gni b/chrome/android/java_sources.gni
index da0846e..f945f16 100644
--- a/chrome/android/java_sources.gni
+++ b/chrome/android/java_sources.gni
@@ -528,8 +528,8 @@ chrome_java_sources = [
   "java/src/org/chromium/chrome/browser/ntp/RecentTabsRowAdapter.java",
   "java/src/org/chromium/chrome/browser/ntp/RecentlyClosedBridge.java",
   "java/src/org/chromium/chrome/browser/ntp/TitleUtil.java",
-  "java/src/org/chromium/chrome/browser/ntp/UiConfig.java",
   "java/src/org/chromium/chrome/browser/ntp/snippets/SnippetArticleListItem.java",
+  "java/src/org/chromium/chrome/browser/ntp/UiConfig.java",
   "java/src/org/chromium/chrome/browser/ntp/snippets/SnippetArticleViewHolder.java",
   "java/src/org/chromium/chrome/browser/ntp/snippets/SnippetHeaderListItem.java",
   "java/src/org/chromium/chrome/browser/ntp/snippets/SnippetHeaderViewHolder.java",
@@ -540,7 +540,6 @@ chrome_java_sources = [
   "java/src/org/chromium/chrome/browser/ntp/cards/AboveTheFoldListItem.java",
   "java/src/org/chromium/chrome/browser/ntp/cards/CardViewHolder.java",
   "java/src/org/chromium/chrome/browser/ntp/cards/DisplayStyleObserverAdapter.java",
-  "java/src/org/chromium/chrome/browser/ntp/cards/ItemGroup.java",
   "java/src/org/chromium/chrome/browser/ntp/cards/MarginResizer.java",
   "java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageAdapter.java",
   "java/src/org/chromium/chrome/browser/ntp/cards/NewTabPageListItem.java",
@@ -549,10 +548,8 @@ chrome_java_sources = [
   "java/src/org/chromium/chrome/browser/ntp/cards/ProgressIndicatorView.java",
   "java/src/org/chromium/chrome/browser/ntp/cards/ProgressViewHolder.java",
   "java/src/org/chromium/chrome/browser/ntp/cards/ProgressListItem.java",
-  "java/src/org/chromium/chrome/browser/ntp/cards/SingleItemGroup.java",
   "java/src/org/chromium/chrome/browser/ntp/cards/SpacingListItem.java",
   "java/src/org/chromium/chrome/browser/ntp/cards/StatusListItem.java",
-  "java/src/org/chromium/chrome/browser/ntp/cards/SuggestionsSection.java",
   "java/src/org/chromium/chrome/browser/offlinepages/DeviceConditions.java",
   "java/src/org/chromium/chrome/browser/offlinepages/BackgroundOfflinerTask.java",
   "java/src/org/chromium/chrome/browser/offlinepages/BackgroundScheduler.java",
@@ -957,7 +954,7 @@ chrome_java_sources = [
   "java/src/org/chromium/chrome/browser/webapps/WebApkActivity7.java",
   "java/src/org/chromium/chrome/browser/webapps/WebApkActivity8.java",
   "java/src/org/chromium/chrome/browser/webapps/WebApkActivity9.java",
-  "java/src/org/chromium/chrome/browser/webapps/WebApkInstaller.java",
+  "java/src/org/chromium/chrome/browser/webapps/WebApkBuilder.java",
   "java/src/org/chromium/chrome/browser/webapps/WebApkManagedActivity.java",
   "java/src/org/chromium/chrome/browser/webapps/WebApkVersionManager.java",
   "java/src/org/chromium/chrome/browser/webapps/WebappActivity.java",
@@ -1227,7 +1224,6 @@ chrome_test_java_sources = [
   "javatests/src/org/chromium/chrome/browser/payments/PaymentRequestIncompleteServerCardTest.java",
   "javatests/src/org/chromium/chrome/browser/payments/PaymentRequestMetricsUnitTest.java",
   "javatests/src/org/chromium/chrome/browser/payments/PaymentRequestMultipleContactDetailsTest.java",
-  "javatests/src/org/chromium/chrome/browser/payments/PaymentRequestMetricsTest.java",
   "javatests/src/org/chromium/chrome/browser/payments/PaymentRequestNoShippingTest.java",
   "javatests/src/org/chromium/chrome/browser/payments/PaymentRequestPaymentAppAndCardsTest.java",
   "javatests/src/org/chromium/chrome/browser/payments/PaymentRequestPaymentAppTest.java",
diff --git a/chrome/android/javatests/src/org/chromium/chrome/browser/payments/PaymentRequestMetricsTest.java b/chrome/android/javatests/src/org/chromium/chrome/browser/payments/PaymentRequestMetricsTest.java
index 207d3bd..60db794 100644
--- a/chrome/android/javatests/src/org/chromium/chrome/browser/payments/PaymentRequestMetricsTest.java
+++ b/chrome/android/javatests/src/org/chromium/chrome/browser/payments/PaymentRequestMetricsTest.java
@@ -7,13 +7,11 @@ package org.chromium.chrome.browser.payments;
 import android.content.DialogInterface;
 import android.test.suitebuilder.annotation.MediumTest;
 
-import org.chromium.base.ThreadUtils;
 import org.chromium.base.metrics.RecordHistogram;
 import org.chromium.chrome.R;
 import org.chromium.chrome.browser.autofill.AutofillTestHelper;
 import org.chromium.chrome.browser.autofill.PersonalDataManager.AutofillProfile;
 import org.chromium.chrome.browser.autofill.PersonalDataManager.CreditCard;
-import org.chromium.chrome.test.util.ChromeTabUtils;
 
 import java.util.concurrent.ExecutionException;
 import java.util.concurrent.TimeoutException;
@@ -23,7 +21,7 @@ import java.util.concurrent.TimeoutException;
  */
 public class PaymentRequestMetricsTest extends PaymentRequestTestBase {
     public PaymentRequestMetricsTest() {
-        super("payment_request_metrics_test.html");
+        super("payment_request_free_shipping_test.html");
     }
 
     @Override
@@ -71,151 +69,4 @@ public class PaymentRequestMetricsTest extends PaymentRequestTestBase {
         assertEquals(1, RecordHistogram.getHistogramValueCountForTesting(
                 "PaymentRequest.CheckoutFunnel.Completed", 1));
     }
-
-    /**
-     * Expect only the ABORT_REASON_ABORTED_BY_USER enum value gets logged when a user cancels a
-     * Payment Request.
-     */
-    @MediumTest
-    public void testAbortMetrics_AbortedByUser_CancelButton() throws InterruptedException,
-            ExecutionException, TimeoutException {
-        triggerUIAndWait(mReadyToPay);
-        clickInShippingSummaryAndWait(R.id.payments_section, mReadyForInput);
-
-        // Cancel the Payment Request.
-        int callCount = mDismissed.getCallCount();
-        ThreadUtils.runOnUiThreadBlocking(new Runnable() {
-            @Override
-            public void run() {
-                mUI.getDialogForTest().findViewById(R.id.button_secondary).performClick();
-            }
-        });
-        mDismissed.waitForCallback(callCount);
-        expectResultContains(new String[] {"Request cancelled"});
-
-        assertOnlySpecificAbortMetricLogged(
-                PaymentRequestMetrics.ABORT_REASON_ABORTED_BY_USER);
-    }
-
-    /**
-     * Expect only the ABORT_REASON_ABORTED_BY_USER enum value gets logged when a user presses on
-     * the [X] button in the Payment Request dialog.
-     */
-    @MediumTest
-    public void testAbortMetrics_AbortedByUser_XButton() throws InterruptedException,
-            ExecutionException, TimeoutException {
-        triggerUIAndWait(mReadyToPay);
-        clickInShippingSummaryAndWait(R.id.payments_section, mReadyForInput);
-
-        // Press the [X] button.
-        clickAndWait(R.id.close_button, mDismissed);
-        expectResultContains(new String[] {"Request cancelled"});
-
-        assertOnlySpecificAbortMetricLogged(
-                PaymentRequestMetrics.ABORT_REASON_ABORTED_BY_USER);
-    }
-
-    /**
-     * Expect only the ABORT_REASON_ABORTED_BY_USER enum value gets logged when a user presses on
-     * the back button on their phone during a Payment Request.
-     */
-    @MediumTest
-    public void testAbortMetrics_AbortedByUser_BackButton() throws InterruptedException,
-            ExecutionException, TimeoutException {
-        triggerUIAndWait(mReadyToPay);
-        clickInShippingSummaryAndWait(R.id.payments_section, mReadyForInput);
-
-        // Press the back button.
-        int callCount = mDismissed.getCallCount();
-        ThreadUtils.runOnUiThreadBlocking(new Runnable() {
-            @Override
-            public void run() {
-                mUI.getDialogForTest().onBackPressed();
-            }
-        });
-        mDismissed.waitForCallback(callCount);
-        expectResultContains(new String[] {"Request cancelled"});
-
-        assertOnlySpecificAbortMetricLogged(
-                PaymentRequestMetrics.ABORT_REASON_ABORTED_BY_USER);
-    }
-
-    /**
-     * Expect only the ABORT_REASON_MOJO_RENDERER_CLOSING enum value gets logged when a user closes
-     * the tab during a Payment Request.
-     */
-    @MediumTest
-    public void testAbortMetrics_AbortedByUser_TabClosed() throws InterruptedException,
-            ExecutionException, TimeoutException {
-        triggerUIAndWait(mReadyToPay);
-        clickInShippingSummaryAndWait(R.id.payments_section, mReadyForInput);
-
-        // Press the back button.
-        ChromeTabUtils.closeCurrentTab(getInstrumentation(), getActivity());
-
-        assertOnlySpecificAbortMetricLogged(
-                PaymentRequestMetrics.ABORT_REASON_MOJO_RENDERER_CLOSING);
-    }
-
-    /**
-     * Expect only the ABORT_REASON_ABORTED_BY_MERCHANT enum value gets logged when a Payment
-     * Request gets cancelled by the merchant.
-     */
-    @MediumTest
-    public void testAbortMetrics_AbortedByMerchant() throws InterruptedException,
-            ExecutionException, TimeoutException {
-        triggerUIAndWait(mReadyToPay);
-
-        // Simulate an abort by the merchant.
-        clickNodeAndWait("abort", mDismissed);
-        expectResultContains(new String[] {"Abort"});
-
-        assertOnlySpecificAbortMetricLogged(
-                PaymentRequestMetrics.ABORT_REASON_ABORTED_BY_MERCHANT);
-    }
-
-    /**
-     * Expect only the ABORT_REASON_NO_MATCHING_PAYMENT_METHOD enum value gets logged when a Payment
-     * Request gets cancelled because the user does not have any of the payment methods accepted by
-     * the merchant and the merchant does not accept credit cards.
-     */
-    @MediumTest
-    public void testAbortMetrics_NoMatchingPaymentMethod() throws InterruptedException,
-            ExecutionException, TimeoutException {
-        // Bob pay is supported but no instruments are present.
-        installPaymentApp(NO_INSTRUMENTS, DELAYED_RESPONSE);
-        triggerUIAndWait("noMatching", mShowFailed);
-        expectResultContains(new String[] {"The payment method is not supported"});
-
-        assertOnlySpecificAbortMetricLogged(
-                PaymentRequestMetrics.ABORT_REASON_NO_MATCHING_PAYMENT_METHOD);
-    }
-
-    /**
-     * Expect only the ABORT_REASON_NO_SUPPORTED_PAYMENT_METHOD enum value gets logged when a
-     * Payment Request gets cancelled because the merchant only accepts payment methods we don't
-     * support.
-     */
-    @MediumTest
-    public void testAbortMetrics_NoSupportedPaymentMethod() throws InterruptedException,
-            ExecutionException, TimeoutException {
-        triggerUIAndWait("noSupported", mShowFailed);
-        expectResultContains(new String[] {"The payment method is not supported"});
-
-        assertOnlySpecificAbortMetricLogged(
-                PaymentRequestMetrics.ABORT_REASON_NO_SUPPORTED_PAYMENT_METHOD);
-    }
-
-    /**
-     * Asserts that only the specified reason for abort is logged.
-     *
-     * @param abortReason The only bucket in the abort histogram that should have a record.
-     */
-    private void assertOnlySpecificAbortMetricLogged(int abortReason) {
-        for (int i = 0; i < PaymentRequestMetrics.ABORT_REASON_MAX; ++i) {
-            assertEquals((i == abortReason ? 1 : 0),
-                    RecordHistogram.getHistogramValueCountForTesting(
-                            "PaymentRequest.CheckoutFunnel.Aborted", i));
-        }
-    }
 }
diff --git a/chrome/android/javatests/src/org/chromium/chrome/browser/payments/PaymentRequestTestBase.java b/chrome/android/javatests/src/org/chromium/chrome/browser/payments/PaymentRequestTestBase.java
index 242b7b4..6f6187f 100644
--- a/chrome/android/javatests/src/org/chromium/chrome/browser/payments/PaymentRequestTestBase.java
+++ b/chrome/android/javatests/src/org/chromium/chrome/browser/payments/PaymentRequestTestBase.java
@@ -14,7 +14,7 @@ import android.widget.Spinner;
 import org.chromium.base.ThreadUtils;
 import org.chromium.base.test.util.UrlUtils;
 import org.chromium.chrome.R;
-import org.chromium.chrome.browser.ChromeTabbedActivity;
+import org.chromium.chrome.browser.ChromeActivity;
 import org.chromium.chrome.browser.autofill.CardUnmaskPrompt;
 import org.chromium.chrome.browser.autofill.CardUnmaskPrompt.CardUnmaskObserverForTest;
 import org.chromium.chrome.browser.payments.PaymentAppFactory.PaymentAppFactoryAddition;
@@ -46,7 +46,7 @@ import java.util.concurrent.atomic.AtomicReference;
 /**
  * A base integration test for payments.
  */
-abstract class PaymentRequestTestBase extends ChromeActivityTestCaseBase<ChromeTabbedActivity>
+abstract class PaymentRequestTestBase extends ChromeActivityTestCaseBase<ChromeActivity>
         implements PaymentRequestObserverForTest, PaymentRequestServiceObserverForTest,
         CardUnmaskObserverForTest {
     /** Flag for installing a payment app without instruments. */
@@ -82,7 +82,7 @@ abstract class PaymentRequestTestBase extends ChromeActivityTestCaseBase<ChromeT
     private CardUnmaskPrompt mCardUnmaskPrompt;
 
     protected PaymentRequestTestBase(String testFileName) {
-        super(ChromeTabbedActivity.class);
+        super(ChromeActivity.class);
         mReadyForInput = new PaymentsCallbackHelper<>();
         mReadyToPay = new PaymentsCallbackHelper<>();
         mSelectionChecked = new PaymentsCallbackHelper<>();
@@ -110,17 +110,12 @@ abstract class PaymentRequestTestBase extends ChromeActivityTestCaseBase<ChromeT
 
     protected void triggerUIAndWait(PaymentsCallbackHelper<PaymentRequestUI> helper)
             throws InterruptedException, ExecutionException, TimeoutException {
-        triggerUIAndWait("buy", (CallbackHelper) helper);
+        triggerUIAndWait((CallbackHelper) helper);
         mUI = helper.getTarget();
     }
 
     protected void triggerUIAndWait(CallbackHelper helper)
             throws InterruptedException, ExecutionException, TimeoutException {
-        triggerUIAndWait("buy", helper);
-    }
-
-    protected void triggerUIAndWait(String nodeId, CallbackHelper helper)
-            throws InterruptedException, ExecutionException, TimeoutException {
         startMainActivityWithURL(mTestFilePath);
         onMainActivityStarted();
         ThreadUtils.runOnUiThreadBlocking(new Runnable() {
@@ -134,7 +129,7 @@ abstract class PaymentRequestTestBase extends ChromeActivityTestCaseBase<ChromeT
             }
         });
         assertWaitForPageScaleFactorMatch(1);
-        clickNodeAndWait(nodeId, helper);
+        clickNodeAndWait("buy", helper);
     }
 
     /** Clicks on an HTML node. */
diff --git a/chrome/android/javatests/src/org/chromium/chrome/browser/tabmodel/TabModelMergingTest.java b/chrome/android/javatests/src/org/chromium/chrome/browser/tabmodel/TabModelMergingTest.java
index 96b1901..5cdd551 100644
--- a/chrome/android/javatests/src/org/chromium/chrome/browser/tabmodel/TabModelMergingTest.java
+++ b/chrome/android/javatests/src/org/chromium/chrome/browser/tabmodel/TabModelMergingTest.java
@@ -4,8 +4,6 @@
 
 package org.chromium.chrome.browser.tabmodel;
 
-import static org.chromium.base.test.util.Restriction.RESTRICTION_TYPE_NON_LOW_END_DEVICE;
-
 import android.annotation.TargetApi;
 import android.app.Activity;
 import android.content.Context;
@@ -21,18 +19,15 @@ import org.chromium.base.ThreadUtils;
 import org.chromium.base.test.util.CommandLineFlags;
 import org.chromium.base.test.util.Feature;
 import org.chromium.base.test.util.MinAndroidSdkLevel;
-import org.chromium.base.test.util.Restriction;
 import org.chromium.base.test.util.UrlUtils;
 import org.chromium.chrome.browser.ChromeTabbedActivity;
 import org.chromium.chrome.browser.multiwindow.MultiWindowUtils;
 import org.chromium.chrome.browser.multiwindow.MultiWindowUtilsTest;
+import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.tabmodel.TabModel.TabLaunchType;
 import org.chromium.chrome.browser.tabmodel.TabPersistentStoreTest.MockTabPersistentStoreObserver;
 import org.chromium.chrome.browser.util.FeatureUtilities;
 import org.chromium.chrome.test.ChromeTabbedActivityTestBase;
-import org.chromium.chrome.test.util.ChromeRestriction;
-import org.chromium.chrome.test.util.ChromeTabUtils;
-import org.chromium.chrome.test.util.OverviewModeBehaviorWatcher;
 import org.chromium.content.browser.test.util.Criteria;
 import org.chromium.content.browser.test.util.CriteriaHelper;
 import org.chromium.content_public.browser.LoadUrlParams;
@@ -50,15 +45,17 @@ public class TabModelMergingTest extends ChromeTabbedActivityTestBase {
     private static final String TEST_URL_2 = UrlUtils.encodeHtmlDataUri("<html>test_url_2.</html>");
     private static final String TEST_URL_3 = UrlUtils.encodeHtmlDataUri("<html>test_url_3.</html>");
     private static final String TEST_URL_4 = UrlUtils.encodeHtmlDataUri("<html>test_url_4.</html>");
-    private static final String TEST_URL_5 = UrlUtils.encodeHtmlDataUri("<html>test_url_5.</html>");
-    private static final String TEST_URL_6 = UrlUtils.encodeHtmlDataUri("<html>test_url_6.</html>");
 
     private ChromeTabbedActivity mActivity1;
     private ChromeTabbedActivity mActivity2;
     private int mActivity1State;
     private int mActivity2State;
-    private String[] mMergeIntoActivity1ExpectedTabs;
-    private String[] mMergeIntoActivity2ExpectedTabs;
+    private String[] mMergeIntoActivity1ExpectedTabs = {
+            "about:blank", TEST_URL_0, TEST_URL_1, TEST_URL_2, "about:blank", TEST_URL_3,
+            TEST_URL_4};
+    private String[] mMergeIntoActivity2ExpectedTabs = {
+            "about:blank", TEST_URL_3, TEST_URL_4, "about:blank", TEST_URL_0, TEST_URL_1,
+            TEST_URL_2};
 
     @Override
     public void startMainActivity() throws InterruptedException {
@@ -126,6 +123,9 @@ public class TabModelMergingTest extends ChromeTabbedActivityTestBase {
                         TabLaunchType.FROM_CHROME_UI, null);
                 mActivity2.getTabCreator(false).createNewTab(new LoadUrlParams(TEST_URL_4),
                         TabLaunchType.FROM_CHROME_UI, null);
+
+                // TODO(twellington): Add tests for incognito tabs. Merging incognito tabs works
+                // but the tests currently crash; need to debug.
             }
         });
 
@@ -138,40 +138,17 @@ public class TabModelMergingTest extends ChromeTabbedActivityTestBase {
         // just created.
         assertEquals("Wrong number of tabs in ChromeTabbedActivity2", 3,
                 mActivity2.getTabModelSelector().getModel(false).getCount());
-
-        // Construct expected tabs.
-        mMergeIntoActivity1ExpectedTabs = new String[7];
-        mMergeIntoActivity2ExpectedTabs = new String[7];
-        for (int i = 0; i < 4; i++) {
-            mMergeIntoActivity1ExpectedTabs[i] =
-                    mActivity1.getTabModelSelector().getModel(false).getTabAt(i).getUrl();
-            mMergeIntoActivity2ExpectedTabs[i + 3] =
-                    mActivity1.getTabModelSelector().getModel(false).getTabAt(i).getUrl();
-        }
-        for (int i = 0; i < 3; i++) {
-            mMergeIntoActivity2ExpectedTabs[i] =
-                    mActivity2.getTabModelSelector().getModel(false).getTabAt(i).getUrl();
-            mMergeIntoActivity1ExpectedTabs[i + 4] =
-                    mActivity2.getTabModelSelector().getModel(false).getTabAt(i).getUrl();
-        }
-    }
-
-    private void mergeTabsAndAssert(final ChromeTabbedActivity activity,
-            final String[] expectedTabUrls) throws InterruptedException {
-        String selectedTabUrl = activity.getTabModelSelector().getCurrentTab().getUrl();
-        mergeTabsAndAssert(activity, expectedTabUrls, expectedTabUrls.length, selectedTabUrl);
     }
 
     /**
      * Merges tabs into the provided activity and asserts that the tab model looks as expected.
      * @param activity The activity to merge into.
-     * @param expectedTabUrls The expected ordering of normal tab URLs after the merge.
-     * @param expectedNumberOfTabs The expected number of tabs after the merge.
-     * @param expectedSelectedTabUrl The expected URL of the selected tab after the merge.
+     * @param expectedTabUrls The expected ordering of tab URLs after the merge.
      */
     private void mergeTabsAndAssert(final ChromeTabbedActivity activity,
-            final String[] expectedTabUrls, final int expectedNumberOfTabs,
-            String expectedSelectedTabUrl) throws InterruptedException {
+            final String[] expectedTabUrls) throws InterruptedException {
+        Tab expectedSelectedTab = activity.getTabModelSelector().getCurrentTab();
+
         // Merge tabs into the activity.
         ThreadUtils.runOnUiThreadBlocking(new Runnable() {
             @Override
@@ -184,11 +161,11 @@ public class TabModelMergingTest extends ChromeTabbedActivityTestBase {
         CriteriaHelper.pollUiThread(new Criteria() {
             @Override
             public boolean isSatisfied() {
-                return activity.getTabModelSelector().getTotalTabCount() == expectedNumberOfTabs;
+                return activity.getTabModelSelector().getTotalTabCount() == expectedTabUrls.length;
             }
         });
 
-        assertTabModelMatchesExpectations(activity, expectedSelectedTabUrl, expectedTabUrls);
+        assertTabModelMatchesExpectations(activity, expectedSelectedTab.getUrl(), expectedTabUrls);
     }
 
     /**
@@ -231,8 +208,8 @@ public class TabModelMergingTest extends ChromeTabbedActivityTestBase {
     private void assertTabModelMatchesExpectations(final ChromeTabbedActivity activity,
             String expectedSelectedTabUrl, final String[] expectedTabUrls) {
         // Assert there are the correct number of tabs.
-        assertEquals("Wrong number of normal tabs", expectedTabUrls.length,
-                activity.getTabModelSelector().getModel(false).getCount());
+        assertEquals("Wrong number of tabs", expectedTabUrls.length,
+                activity.getTabModelSelector().getTotalTabCount());
 
         // Assert that the correct tab is selected.
         assertEquals("Wrong tab selected", expectedSelectedTabUrl,
@@ -332,68 +309,4 @@ public class TabModelMergingTest extends ChromeTabbedActivityTestBase {
         // Clean up.
         newActivity.finishAndRemoveTask();
     }
-
-    @LargeTest
-    @Feature({"TabPersistentStore", "MultiWindow"})
-    @Restriction({ChromeRestriction.RESTRICTION_TYPE_PHONE, RESTRICTION_TYPE_NON_LOW_END_DEVICE})
-    public void testMergeWhileInTabSwitcher() throws Exception {
-        OverviewModeBehaviorWatcher overviewModeWatcher = new OverviewModeBehaviorWatcher(
-                mActivity1.getLayoutManager(), true, false);
-        ThreadUtils.runOnUiThreadBlocking(new Runnable() {
-            @Override
-            public void run() {
-                mActivity1.getLayoutManager().showOverview(false);
-            }
-        });
-        overviewModeWatcher.waitForBehavior();
-
-        mergeTabsAndAssert(mActivity1, mMergeIntoActivity1ExpectedTabs);
-        assertTrue("Overview mode should still be showing", mActivity1.isInOverviewMode());
-        mActivity1.finishAndRemoveTask();
-    }
-
-    @LargeTest
-    @Feature({"TabPersistentStore", "MultiWindow"})
-    public void testMergeWithNoTabs() throws Exception {
-        // Close all tabs and wait for the callback.
-        ChromeTabUtils.closeAllTabs(getInstrumentation(), mActivity1);
-
-        String[] expectedTabUrls = new String[3];
-        for (int i = 0; i < 3; i++) {
-            expectedTabUrls[i] = mMergeIntoActivity2ExpectedTabs[i];
-        }
-
-        // The first tab should be selected after the merge.
-        mergeTabsAndAssert(mActivity1, expectedTabUrls, 3, expectedTabUrls[0]);
-        mActivity1.finishAndRemoveTask();
-    }
-
-    @LargeTest
-    @Feature({"TabPersistentStore", "MultiWindow"})
-    public void testMergingIncognitoTabs() throws InterruptedException {
-        // Incognito tabs must be fully loaded so that their tab states are written out.
-        ChromeTabUtils.fullyLoadUrlInNewTab(getInstrumentation(), mActivity1, TEST_URL_5, true);
-        ChromeTabUtils.fullyLoadUrlInNewTab(getInstrumentation(), mActivity2, TEST_URL_6, true);
-
-        // Save state.
-        ThreadUtils.runOnUiThreadBlocking(new Runnable() {
-            @Override
-            public void run() {
-                mActivity1.saveState();
-                mActivity2.saveState();
-            }
-        });
-
-        assertEquals("Wrong number of incognito tabs in ChromeTabbedActivity",
-                1, mActivity1.getTabModelSelector().getModel(true).getCount());
-        assertEquals("Wrong number of tabs in ChromeTabbedActivity",
-                5, mActivity1.getTabModelSelector().getTotalTabCount());
-        assertEquals("Wrong number of incognito tabs in ChromeTabbedActivity2",
-                1, mActivity2.getTabModelSelector().getModel(true).getCount());
-        assertEquals("Wrong number of tabs in ChromeTabbedActivity2",
-                4, mActivity2.getTabModelSelector().getTotalTabCount());
-
-        String selectedUrl = mActivity1.getTabModelSelector().getCurrentTab().getUrl();
-        mergeTabsAndAssert(mActivity1, mMergeIntoActivity1ExpectedTabs, 9, selectedUrl);
-    }
 }
diff --git a/chrome/android/javatests/src/org/chromium/chrome/browser/tabmodel/UndoTabModelTest.java b/chrome/android/javatests/src/org/chromium/chrome/browser/tabmodel/UndoTabModelTest.java
index f8346cd..60392f6 100644
--- a/chrome/android/javatests/src/org/chromium/chrome/browser/tabmodel/UndoTabModelTest.java
+++ b/chrome/android/javatests/src/org/chromium/chrome/browser/tabmodel/UndoTabModelTest.java
@@ -15,14 +15,15 @@ import org.chromium.base.test.util.FlakyTest;
 import org.chromium.base.test.util.MinAndroidSdkLevel;
 import org.chromium.base.test.util.Restriction;
 import org.chromium.base.test.util.UrlUtils;
+import org.chromium.chrome.browser.ChromeTabbedActivity;
 import org.chromium.chrome.browser.ChromeTabbedActivity2;
 import org.chromium.chrome.browser.multiwindow.MultiWindowUtilsTest;
+import org.chromium.chrome.browser.tab.EmptyTabObserver;
 import org.chromium.chrome.browser.tab.Tab;
 import org.chromium.chrome.browser.tabmodel.TabModel.TabLaunchType;
 import org.chromium.chrome.browser.tabmodel.TabModel.TabSelectionType;
 import org.chromium.chrome.test.ChromeTabbedActivityTestBase;
 import org.chromium.chrome.test.util.ChromeRestriction;
-import org.chromium.chrome.test.util.ChromeTabUtils;
 import org.chromium.content.browser.test.util.CallbackHelper;
 import org.chromium.content.browser.test.util.Criteria;
 import org.chromium.content.browser.test.util.CriteriaHelper;
@@ -89,6 +90,27 @@ public class UndoTabModelTest extends ChromeTabbedActivityTestBase {
         });
     }
 
+    private void createFullyLoadedTabOnUiThread(final ChromeTabbedActivity activity,
+            final String url) {
+        final CallbackHelper tabCallbackHelper = new CallbackHelper();
+        final TabLoadedObserver observer = new TabLoadedObserver(tabCallbackHelper);
+
+        ThreadUtils.runOnUiThreadBlocking(new Runnable() {
+            @Override
+            public void run() {
+                activity.getTabCreator(false).createNewTab(new LoadUrlParams(url),
+                        TabLaunchType.FROM_CHROME_UI, null).addObserver(observer);
+            }
+        });
+
+        // Must wait for the page to be fully loaded.
+        try {
+            tabCallbackHelper.waitForCallback(0);
+        } catch (TimeoutException | InterruptedException e) {
+            fail("Failed to load the tab.");
+        }
+    }
+
     private void selectTabOnUiThread(final TabModel model, final Tab tab) {
         ThreadUtils.runOnUiThreadBlocking(new Runnable() {
             @Override
@@ -344,6 +366,20 @@ public class UndoTabModelTest extends ChromeTabbedActivityTestBase {
         });
     }
 
+    // Helper class that notifies when a page load is finished.
+    private static class TabLoadedObserver extends EmptyTabObserver {
+        private CallbackHelper mLoadedCallback;
+
+        public TabLoadedObserver(CallbackHelper loadCallback) {
+            super();
+            mLoadedCallback = loadCallback;
+        }
+        @Override
+        public void onPageLoadFinished(Tab tab) {
+            mLoadedCallback.notifyCalled();
+        }
+    }
+
     // Helper class that notifies after the tab is closed, and a tab restore service entry has been
     // created in tab restore service.
     private static class TabClosedObserver extends EmptyTabModelObserver {
@@ -1483,10 +1519,10 @@ public class UndoTabModelTest extends ChromeTabbedActivityTestBase {
         final TabModelSelector selector = getActivity().getTabModelSelector();
         final TabModel model = selector.getModel(false);
 
-        // Create new tab and wait until it's loaded.
+        // Create new tab and attach observer to listen to loaded event.
         // Native can only successfully recover the tab after a page load has finished and
         // it has navigation history.
-        ChromeTabUtils.fullyLoadUrlInNewTab(getInstrumentation(), getActivity(), TEST_URL_0, false);
+        createFullyLoadedTabOnUiThread(getActivity(), TEST_URL_0);
 
         // Close the tab, and commit pending closure.
         assertEquals(model.getCount(), 2);
@@ -1541,9 +1577,8 @@ public class UndoTabModelTest extends ChromeTabbedActivityTestBase {
         final TabModel secondModel = secondActivity.getTabModelSelector().getModel(false);
 
         // Create tabs.
-        ChromeTabUtils.fullyLoadUrlInNewTab(getInstrumentation(), getActivity(), TEST_URL_0, false);
-        ChromeTabUtils.fullyLoadUrlInNewTab(
-                getInstrumentation(), secondActivity, TEST_URL_1, false);
+        createFullyLoadedTabOnUiThread(getActivity(), TEST_URL_0);
+        createFullyLoadedTabOnUiThread(secondActivity, TEST_URL_1);
 
         assertEquals("Unexpected number of tabs in first window.", 2, firstModel.getCount());
         assertEquals("Unexpected number of tabs in second window.", 2, secondModel.getCount());
@@ -1613,8 +1648,7 @@ public class UndoTabModelTest extends ChromeTabbedActivityTestBase {
         final TabModel secondModel = secondActivity.getTabModelSelector().getModel(false);
 
         // Create tab on second window.
-        ChromeTabUtils.fullyLoadUrlInNewTab(
-                getInstrumentation(), secondActivity, TEST_URL_1, false);
+        createFullyLoadedTabOnUiThread(secondActivity, TEST_URL_1);
         assertEquals("Window 2 should have 2 tab.", 2, secondModel.getCount());
 
         // Close tab in second window, wait until tab restore service history is created.
diff --git a/chrome/android/junit/src/org/chromium/chrome/browser/ntp/cards/NewTabPageAdapterTest.java b/chrome/android/junit/src/org/chromium/chrome/browser/ntp/cards/NewTabPageAdapterTest.java
index 7797074..c2e8c06 100644
--- a/chrome/android/junit/src/org/chromium/chrome/browser/ntp/cards/NewTabPageAdapterTest.java
+++ b/chrome/android/junit/src/org/chromium/chrome/browser/ntp/cards/NewTabPageAdapterTest.java
@@ -7,29 +7,28 @@ package org.chromium.chrome.browser.ntp.cards;
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertFalse;
 import static org.junit.Assert.assertTrue;
+import static org.mockito.Matchers.any;
+import static org.mockito.Mockito.doAnswer;
+import static org.mockito.Mockito.mock;
 
-import android.graphics.Bitmap;
-
-import org.chromium.base.Callback;
 import org.chromium.base.metrics.RecordHistogram;
 import org.chromium.base.test.util.Feature;
+import org.chromium.chrome.browser.ntp.NewTabPageView.NewTabPageManager;
 import org.chromium.chrome.browser.ntp.snippets.CategoryStatus;
-import org.chromium.chrome.browser.ntp.snippets.CategoryStatus.CategoryStatusEnum;
-import org.chromium.chrome.browser.ntp.snippets.KnownCategories;
-import org.chromium.chrome.browser.ntp.snippets.KnownCategories.KnownCategoriesEnum;
 import org.chromium.chrome.browser.ntp.snippets.SnippetArticleListItem;
-import org.chromium.chrome.browser.ntp.snippets.SnippetsSource;
+import org.chromium.chrome.browser.ntp.snippets.SnippetsBridge;
+import org.chromium.chrome.browser.ntp.snippets.SnippetsSource.SnippetsObserver;
 import org.chromium.testing.local.LocalRobolectricTestRunner;
 import org.junit.Before;
 import org.junit.Test;
 import org.junit.runner.RunWith;
+import org.mockito.invocation.InvocationOnMock;
+import org.mockito.stubbing.Answer;
 import org.robolectric.annotation.Config;
 
 import java.util.ArrayList;
 import java.util.Arrays;
-import java.util.HashMap;
 import java.util.List;
-import java.util.Map;
 
 
 /**
@@ -38,58 +37,25 @@ import java.util.Map;
 @RunWith(LocalRobolectricTestRunner.class)
 @Config(manifest = Config.NONE)
 public class NewTabPageAdapterTest {
-    private static class FakeSnippetsSource implements SnippetsSource {
-        private SnippetsSource.SnippetsObserver mObserver;
-        private final Map<Integer, Integer> mCategoryStatus = new HashMap<>();
-
-        public void setStatusForCategory(@KnownCategoriesEnum int category,
-                @CategoryStatusEnum int status) {
-            mCategoryStatus.put(category, status);
-            if (mObserver != null) mObserver.onCategoryStatusChanged(category, status);
-        }
-
-        public void setSnippetsForCategory(@KnownCategoriesEnum int category,
-                List<SnippetArticleListItem> snippets) {
-            mObserver.onSuggestionsReceived(category, snippets);
-        }
-
-        @Override
-        public void discardSnippet(SnippetArticleListItem snippet) {
-            throw new UnsupportedOperationException();
-        }
-
-        @Override
-        public void fetchSnippetImage(SnippetArticleListItem snippet, Callback<Bitmap> callback) {
-            throw new UnsupportedOperationException();
-        }
-
-        @Override
-        public void getSnippedVisited(SnippetArticleListItem snippet, Callback<Boolean> callback) {
-            throw new UnsupportedOperationException();
-        }
-
-        @Override
-        public void setObserver(SnippetsObserver observer) {
-            mObserver = observer;
-        }
-
-        @CategoryStatusEnum
-        @Override
-        public int getCategoryStatus(@KnownCategoriesEnum int category) {
-            return mCategoryStatus.get(category);
-        }
-    }
 
-    private FakeSnippetsSource mSnippetsSource = new FakeSnippetsSource();
-    private NewTabPageAdapter mNtpAdapter;
+    private NewTabPageManager mNewTabPageManager;
+    private SnippetsObserver mSnippetsObserver;
+    private SnippetsBridge mSnippetsBridge;
 
     @Before
     public void setUp() {
         RecordHistogram.disableForTests();
-
-        mSnippetsSource = new FakeSnippetsSource();
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES, CategoryStatus.INITIALIZING);
-        mNtpAdapter = new NewTabPageAdapter(null, null, mSnippetsSource, null);
+        mNewTabPageManager = mock(NewTabPageManager.class);
+        mSnippetsObserver = null;
+        mSnippetsBridge = mock(SnippetsBridge.class);
+
+        // Intercept the observers so that we can mock invocations.
+        doAnswer(new Answer<Void>() {
+            @Override
+            public Void answer(InvocationOnMock invocation) throws Throwable {
+                mSnippetsObserver = invocation.getArgumentAt(0, SnippetsObserver.class);
+                return null;
+            }}).when(mSnippetsBridge).setObserver(any(SnippetsObserver.class));
     }
 
     /**
@@ -99,28 +65,31 @@ public class NewTabPageAdapterTest {
     @Test
     @Feature({"Ntp"})
     public void testSnippetLoading() {
-        assertEquals(5, mNtpAdapter.getItemCount());
-        assertEquals(NewTabPageListItem.VIEW_TYPE_ABOVE_THE_FOLD, mNtpAdapter.getItemViewType(0));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_HEADER, mNtpAdapter.getItemViewType(1));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_STATUS, mNtpAdapter.getItemViewType(2));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_PROGRESS, mNtpAdapter.getItemViewType(3));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_SPACING, mNtpAdapter.getItemViewType(4));
+        NewTabPageAdapter ntpa =
+                new NewTabPageAdapter(mNewTabPageManager, null, mSnippetsBridge, null);
+
+        assertEquals(5, ntpa.getItemCount());
+        assertEquals(NewTabPageListItem.VIEW_TYPE_ABOVE_THE_FOLD, ntpa.getItemViewType(0));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_HEADER, ntpa.getItemViewType(1));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_STATUS, ntpa.getItemViewType(2));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_PROGRESS, ntpa.getItemViewType(3));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_SPACING, ntpa.getItemViewType(4));
 
         List<SnippetArticleListItem> snippets = createDummySnippets();
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES, snippets);
+        mSnippetsObserver.onSnippetsReceived(snippets);
 
-        List<NewTabPageListItem> loadedItems = new ArrayList<>(mNtpAdapter.getItems());
-        assertEquals(NewTabPageListItem.VIEW_TYPE_ABOVE_THE_FOLD, mNtpAdapter.getItemViewType(0));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_HEADER, mNtpAdapter.getItemViewType(1));
+        List<NewTabPageListItem> loadedItems = new ArrayList<>(ntpa.getItemsForTesting());
+        assertEquals(NewTabPageListItem.VIEW_TYPE_ABOVE_THE_FOLD, ntpa.getItemViewType(0));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_HEADER, ntpa.getItemViewType(1));
         assertEquals(snippets, loadedItems.subList(2, loadedItems.size() - 1));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_SPACING,
-                mNtpAdapter.getItemViewType(loadedItems.size() - 1));
+        assertEquals(
+                NewTabPageListItem.VIEW_TYPE_SPACING, ntpa.getItemViewType(loadedItems.size() - 1));
 
         // The adapter should ignore any new incoming data.
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES,
-                Arrays.asList(new SnippetArticleListItem[] { new SnippetArticleListItem(
-                        "foo", "title1", "pub1", "txt1", "foo", "bar", 0, 0, 0) }));
-        assertEquals(loadedItems, mNtpAdapter.getItems());
+        mSnippetsObserver.onSnippetsReceived(
+                Arrays.asList(new SnippetArticleListItem[] {new SnippetArticleListItem(
+                        "foo", "title1", "pub1", "txt1", "foo", "bar", 0, 0, 0)}));
+        assertEquals(loadedItems, ntpa.getItemsForTesting());
     }
 
     /**
@@ -130,32 +99,33 @@ public class NewTabPageAdapterTest {
     @Test
     @Feature({"Ntp"})
     public void testSnippetLoadingInitiallyEmpty() {
+        NewTabPageAdapter ntpa =
+                new NewTabPageAdapter(mNewTabPageManager, null, mSnippetsBridge, null);
+
         // If we don't get anything, we should be in the same situation as the initial one.
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES,
-                new ArrayList<SnippetArticleListItem>());
-        assertEquals(5, mNtpAdapter.getItemCount());
-        assertEquals(NewTabPageListItem.VIEW_TYPE_ABOVE_THE_FOLD, mNtpAdapter.getItemViewType(0));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_HEADER, mNtpAdapter.getItemViewType(1));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_STATUS, mNtpAdapter.getItemViewType(2));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_PROGRESS, mNtpAdapter.getItemViewType(3));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_SPACING, mNtpAdapter.getItemViewType(4));
+        mSnippetsObserver.onSnippetsReceived(new ArrayList<SnippetArticleListItem>());
+        assertEquals(5, ntpa.getItemCount());
+        assertEquals(NewTabPageListItem.VIEW_TYPE_ABOVE_THE_FOLD, ntpa.getItemViewType(0));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_HEADER, ntpa.getItemViewType(1));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_STATUS, ntpa.getItemViewType(2));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_PROGRESS, ntpa.getItemViewType(3));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_SPACING, ntpa.getItemViewType(4));
 
         // We should load new snippets when we get notified about them.
         List<SnippetArticleListItem> snippets = createDummySnippets();
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES, snippets);
-        List<NewTabPageListItem> loadedItems = new ArrayList<>(mNtpAdapter.getItems());
-        assertEquals(NewTabPageListItem.VIEW_TYPE_ABOVE_THE_FOLD, mNtpAdapter.getItemViewType(0));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_HEADER, mNtpAdapter.getItemViewType(1));
+        mSnippetsObserver.onSnippetsReceived(snippets);
+        List<NewTabPageListItem> loadedItems = new ArrayList<>(ntpa.getItemsForTesting());
+        assertEquals(NewTabPageListItem.VIEW_TYPE_ABOVE_THE_FOLD, ntpa.getItemViewType(0));
+        assertEquals(NewTabPageListItem.VIEW_TYPE_HEADER, ntpa.getItemViewType(1));
         assertEquals(snippets, loadedItems.subList(2, loadedItems.size() - 1));
-        assertEquals(NewTabPageListItem.VIEW_TYPE_SPACING,
-                mNtpAdapter.getItemViewType(loadedItems.size() - 1));
+        assertEquals(
+                NewTabPageListItem.VIEW_TYPE_SPACING, ntpa.getItemViewType(loadedItems.size() - 1));
 
         // The adapter should ignore any new incoming data.
-        mSnippetsSource.setSnippetsForCategory(
-                KnownCategories.ARTICLES,
+        mSnippetsObserver.onSnippetsReceived(
                 Arrays.asList(new SnippetArticleListItem[] {new SnippetArticleListItem(
                         "foo", "title1", "pub1", "txt1", "foo", "bar", 0, 0, 0)}));
-        assertEquals(loadedItems, mNtpAdapter.getItems());
+        assertEquals(loadedItems, ntpa.getItemsForTesting());
     }
 
     /**
@@ -164,27 +134,27 @@ public class NewTabPageAdapterTest {
     @Test
     @Feature({"Ntp"})
     public void testSnippetClearing() {
+        NewTabPageAdapter ntpa =
+                new NewTabPageAdapter(mNewTabPageManager, null, mSnippetsBridge, null);
+
         List<SnippetArticleListItem> snippets = createDummySnippets();
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES, snippets);
-        assertEquals(3 + snippets.size(), mNtpAdapter.getItemCount());
+        mSnippetsObserver.onSnippetsReceived(snippets);
+        assertEquals(3 + snippets.size(), ntpa.getItemCount());
 
         // If we get told that snippets are enabled, we just leave the current
         // ones there and not clear.
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.AVAILABLE);
-        assertEquals(3 + snippets.size(), mNtpAdapter.getItemCount());
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.AVAILABLE);
+        assertEquals(3 + snippets.size(), ntpa.getItemCount());
 
         // When snippets are disabled, we clear them and we should go back to
         // the situation with the status card.
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.SIGNED_OUT);
-        assertEquals(5, mNtpAdapter.getItemCount());
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.SIGNED_OUT);
+        assertEquals(5, ntpa.getItemCount());
 
         // The adapter should now be waiting for new snippets.
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.AVAILABLE);
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES, snippets);
-        assertEquals(3 + snippets.size(), mNtpAdapter.getItemCount());
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.AVAILABLE);
+        mSnippetsObserver.onSnippetsReceived(snippets);
+        assertEquals(3 + snippets.size(), ntpa.getItemCount());
     }
 
     /**
@@ -193,35 +163,35 @@ public class NewTabPageAdapterTest {
     @Test
     @Feature({"Ntp"})
     public void testSnippetLoadingBlock() {
+        NewTabPageAdapter ntpa =
+                new NewTabPageAdapter(mNewTabPageManager, null, mSnippetsBridge, null);
+
         List<SnippetArticleListItem> snippets = createDummySnippets();
 
         // By default, status is INITIALIZING, so we can load snippets
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES, snippets);
-        assertEquals(3 + snippets.size(), mNtpAdapter.getItemCount());
+        mSnippetsObserver.onSnippetsReceived(snippets);
+        assertEquals(3 + snippets.size(), ntpa.getItemCount());
 
         // If we have snippets, we should not load the new list.
         snippets.add(new SnippetArticleListItem("https://site.com/url1", "title1", "pub1", "txt1",
                 "https://site.com/url1", "https://amp.site.com/url1", 0, 0, 0));
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES, snippets);
-        assertEquals(3 + snippets.size() - 1, mNtpAdapter.getItemCount());
+        mSnippetsObserver.onSnippetsReceived(snippets);
+        assertEquals(3 + snippets.size() - 1, ntpa.getItemCount());
 
         // When snippets are disabled, we should not be able to load them
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.SIGNED_OUT);
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES, snippets);
-        assertEquals(5, mNtpAdapter.getItemCount());
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.SIGNED_OUT);
+        mSnippetsObserver.onSnippetsReceived(snippets);
+        assertEquals(5, ntpa.getItemCount());
 
         // INITIALIZING lets us load snippets still.
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.INITIALIZING);
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES, snippets);
-        assertEquals(3 + snippets.size(), mNtpAdapter.getItemCount());
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.INITIALIZING);
+        mSnippetsObserver.onSnippetsReceived(snippets);
+        assertEquals(3 + snippets.size(), ntpa.getItemCount());
 
         // The adapter should now be waiting for new snippets.
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.AVAILABLE);
-        mSnippetsSource.setSnippetsForCategory(KnownCategories.ARTICLES, snippets);
-        assertEquals(3 + snippets.size(), mNtpAdapter.getItemCount());
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.AVAILABLE);
+        mSnippetsObserver.onSnippetsReceived(snippets);
+        assertEquals(3 + snippets.size(), ntpa.getItemCount());
     }
 
     /**
@@ -230,35 +200,30 @@ public class NewTabPageAdapterTest {
     @Test
     @Feature({"Ntp"})
     public void testProgressIndicatorDisplay() {
-        int progressPos = mNtpAdapter.getBottomSpacerPosition() - 1;
-        ProgressListItem progress = (ProgressListItem) mNtpAdapter.getItems().get(progressPos);
+        NewTabPageAdapter ntpa =
+                new NewTabPageAdapter(mNewTabPageManager, null, mSnippetsBridge, null);
+        int progressPos = ntpa.getBottomSpacerPosition() - 1;
+        ProgressListItem progress = (ProgressListItem) ntpa.getItemsForTesting().get(progressPos);
 
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.INITIALIZING);
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.INITIALIZING);
         assertTrue(progress.isVisible());
 
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.AVAILABLE);
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.AVAILABLE);
         assertFalse(progress.isVisible());
 
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.AVAILABLE_LOADING);
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.AVAILABLE_LOADING);
         assertTrue(progress.isVisible());
 
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.NOT_PROVIDED);
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.NOT_PROVIDED);
         assertFalse(progress.isVisible());
 
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.CATEGORY_EXPLICITLY_DISABLED);
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.CATEGORY_EXPLICITLY_DISABLED);
         assertFalse(progress.isVisible());
 
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.SIGNED_OUT);
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.SIGNED_OUT);
         assertFalse(progress.isVisible());
 
-        mSnippetsSource.setStatusForCategory(KnownCategories.ARTICLES,
-                CategoryStatus.LOADING_ERROR);
+        mSnippetsObserver.onCategoryStatusChanged(CategoryStatus.LOADING_ERROR);
         assertFalse(progress.isVisible());
     }
 
diff --git a/chrome/android/webapk/libs/runtime_library/javatests/src/org/chromium/webapk/lib/runtime_library/WebApkServiceImplTest.java b/chrome/android/webapk/libs/runtime_library/javatests/src/org/chromium/webapk/lib/runtime_library/WebApkServiceImplTest.java
index 59718df..916c9b2 100644
--- a/chrome/android/webapk/libs/runtime_library/javatests/src/org/chromium/webapk/lib/runtime_library/WebApkServiceImplTest.java
+++ b/chrome/android/webapk/libs/runtime_library/javatests/src/org/chromium/webapk/lib/runtime_library/WebApkServiceImplTest.java
@@ -66,7 +66,7 @@ public class WebApkServiceImplTest extends InstrumentationTestCase {
      * @SmallTest
      * crbug.com/634390
      */
-    @DisabledTest(message = "crbug.com/634390")
+    @DisabledTest
     public void testApiFailsIfNoPermission() throws Exception {
         IWebApkApi api = bindService(mContext, mTargetUid + 1, SMALL_ICON_ID);
         try {
@@ -83,7 +83,7 @@ public class WebApkServiceImplTest extends InstrumentationTestCase {
      * @SmallTest
      * crbug.com/634390
      */
-    @DisabledTest(message = "crbug.com/634390")
+    @DisabledTest
     public void testApiWorksIfHasPermission() throws Exception {
         IWebApkApi api = bindService(mContext, mTargetUid, SMALL_ICON_ID);
         try {
diff --git a/chrome/app/chrome_main_delegate.cc b/chrome/app/chrome_main_delegate.cc
index 7cf7a91..5397903 100644
--- a/chrome/app/chrome_main_delegate.cc
+++ b/chrome/app/chrome_main_delegate.cc
@@ -490,7 +490,11 @@ bool ChromeMainDelegate::BasicStartupComplete(int* exit_code) {
   ObjcEvilDoers::ZombieEnable(true, is_browser ? 10000 : 1000);
 
   SetUpBundleOverrides();
-  chrome::common::mac::EnableCFBundleBlocker();
+
+  // Only enable the CFBundleBlocker in the browser. In child processes,
+  // the sandbox will block access to loadable bundle locations.
+  if (is_browser)
+    chrome::common::mac::EnableCFBundleBlocker();
 #endif
 
   Profiling::ProcessStarted();
diff --git a/chrome/app/chromeos_strings.grdp b/chrome/app/chromeos_strings.grdp
index 4ee80e0..0cbfdfe 100644
--- a/chrome/app/chromeos_strings.grdp
+++ b/chrome/app/chromeos_strings.grdp
@@ -1632,19 +1632,7 @@ Press any key to continue exploring.
   <message name="IDS_NETWORK_ENABLE_DEV_FEATURES_LINK" desc="Text shown on continue button" meaning="Link shown on OOBE screens that opens enable debugging features dialog">
     Enable debugging features
   </message>
-  <message name="IDS_LANGUAGE_DROPDOWN_TITLE" desc="Title of language selection dropdown menu" meaning="Small title near language dropdown menu suggesting that this is a language selector.">
-    Language
-  </message>
-  <message name="IDS_KEYBOARD_DROPDOWN_TITLE" desc="Title of keyboard selection dropdown menu" meaning="Small title near keyboard dropdown menu suggesting that this is a keyboard layout selector.">
-    Keyboard
-  </message>
-  <message name="IDS_OOBE_OK_BUTTON_TEXT" desc="Text on 'OK' button" meaning="This is 'OK' text for all 'OK' buttons on ChromeOS initial device setup screens.">
-    OK
-  </message>
-  <message name="IDS_LANGUAGE_SECTION_TITLE" desc="Title of language selection screen" meaning="A title of the dialog where user should select ChromeOS UI language and default keyboard layout during initial device setup.">
-    Choose your language &amp; keyboard
-  </message>
-  <message name="IDS_NETWORK_SECTION_TITLE" desc="Title of network selection screen" meaning="A title of the dialog where user should select network to connect to Internet">
+  <message name="IDS_NETWORK_SECTION_TITE" desc="Tile of newtork selection screen" meaning="A title of the dialog where user should select network to connect to Internet">
     Connect to network
   </message>
   <message name="IDS_NETWORK_SECTION_HINT" desc="Under-title line on the network selection screen" meaning="A hint to the user why device should be connected to the network">
diff --git a/chrome/app/generated_resources.grd b/chrome/app/generated_resources.grd
index 7129b38..919656a 100644
--- a/chrome/app/generated_resources.grd
+++ b/chrome/app/generated_resources.grd
@@ -7085,7 +7085,7 @@ Keep your key file in a safe place. You will need it to create new versions of y
         Install
       </message>
       <message name="IDS_PLUGIN_DISABLED" desc="The placeholder text for a disabled plugin.">
-        Visit <ph name="CHROME_PLUGINS_LINK">chrome://plugins</ph> to re-enable <ph name="PLUGIN_NAME">$1<ex>Flash</ex></ph>.
+        <ph name="PLUGIN_NAME">$1<ex>Flash</ex></ph> has been disabled. To re-enable it, please go to <ph name="CHROME_PLUGINS_LINK">chrome://plugins</ph>.
       </message>
 
       <!-- Session Crashed Info Bar/Bubble-->
@@ -11408,22 +11408,15 @@ The following application will be launched if you accept this request:
       </if>
 
       <!-- General app failure messages -->
-      <message name="IDS_PROFILE_ERROR_DIALOG_TITLE" desc="The title of the dialog shown when there's an error page">
-        Profile error occurred
-      </message>
       <message name="IDS_COULDNT_OPEN_PROFILE_ERROR" desc="Error displayed on startup when the profile cannot be opened correctly due to problems reading or writing files in it.">
-        Something went wrong when opening your profile. Some features may be unavailable.
-      </message>
-      <message name="IDS_PROFILE_ERROR_DIALOG_CHECKBOX" desc="The label of the checkbox on the profile error dialog asking the user whether to send a feedback report or not">
-        Send feedback to help us fix this issue.
-      </message>
-      <message name="IDS_PROFILE_ERROR_FEEDBACK_DESCRIPTION" desc="The prepopulated text filled in the feedback report reporting a profile error">
-Tell us what happened exactly before you got the profile error message:
+Your profile could not be opened correctly.
 
-****DO NOT CHANGE BELOW THIS LINE****
+Some features may be unavailable.  Please check that the profile exists and you have permission to read and write its contents.
       </message>
       <message name="IDS_COULDNT_STARTUP_PROFILE_ERROR" desc="Error displayed when Chrome cannot start because profiles were not opened correctly.">
-        Cannot start Chrome because something went wrong when opening your profile. Try to restart Chrome.
+Cannot start Chrome because your profile could not be opened correctly.
+
+Please check that the profile exists and you have permission to read and write its contents.
       </message>
       <message name="IDS_REFUSE_TO_RUN_AS_ROOT" desc="Short error message displayed in an error dialog on startup if the user tries to run Chrome as root.">
         <ph name="PRODUCT_NAME">$1<ex>Google Chrome</ex></ph> can not be run as root.
@@ -11939,118 +11932,60 @@ Tell us what happened exactly before you got the profile error message:
 
       <!-- Translate Bubble -->
       <if expr="toolkit_views or is_macosx">
-        <if expr="not use_titlecase">
-          <message name="IDS_TRANSLATE_BUBBLE_BEFORE_TRANSLATE" desc="Text to show for the translate bubble label when that page is in specified language and ask if should translate.">
-            Would you like to translate this page?
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_BEFORE_TRANSLATE_NEW" desc="Text to show for the translate bubble label when that page is in specified language and ask if should translate.">
-            Do you want Google to translate this page from <ph name="source_language">$1<ex>Spanish</ex></ph> to <ph name="target_language">$2<ex>English</ex></ph>?
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_ADVANCED" desc="Text to show for the translate bubble link label to jump to the advanced panel.">
-            Options
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_ACCEPT" desc="Text to show for the translate bubble button to accept translation.">
-            Translate
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_DENY" desc="Text to show for the translate bubble menu item to deny translation.">
-            Nope
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_NEVER_TRANSLATE_LANG" desc="Text to show for the translate bubble menu item to never translate the specified language">
-            Never translate <ph name="language">$1<ex>French</ex></ph>
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_NEVER_TRANSLATE_SITE" desc="Text to show for the translate bubble menu item to never translate the current site">
-            Never translate this site
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_TRANSLATING" desc="Text to show for the translate bubble label when page is currently being translated by servers">
-            This page is being translated...
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_TRANSLATED" desc="Text to show for the translate bubble label when the page has been translated from one language to another">
-            This page has been translated.
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_REVERT" desc="Text to show for the translate bubble button to revert translation of translated page">
-            Show original
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_TRY_AGAIN" desc="Text to show for the translate bubble button to try to translate the page again">
-            Try again
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_ALWAYS" desc="Text to show for the translate bubble checkbox to always translate from one language to another">
-            Always translate
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_ALWAYS_DO_THIS" desc="Text to show for the translate bubble checkbox to always translate from one language to another in 2016Q2 UI">
-            Always do this
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_OPTIONS_MENU_BUTTON" desc="Text to show for the translate bubble 'Options' menu button">
-            Options
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_COULD_NOT_TRANSLATE" desc="Text to show for the translate bubble label when the page could not be translated.">
-            This page could not be translated.
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_PAGE_LANGUAGE" desc="Text to show for the translate bubble label next to the combobox of the page language">
-            Page language:
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_TRANSLATION_LANGUAGE" desc="Text to show for the translate bubble label next to the combobox of the target language for Translate">
-            Translation language:
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_LANGUAGE_SETTINGS" desc="Text to show for the translate bubble link label next to jump to the language setting page.">
-            Language settings
-          </message>
-        </if>
-        <if expr="use_titlecase">
-          <message name="IDS_TRANSLATE_BUBBLE_BEFORE_TRANSLATE" desc="In Title Case: Text to show for the translate bubble label when that page is in specified language and ask if should translate.">
-            Would You Like To Translate This Page?
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_BEFORE_TRANSLATE_NEW" desc="In Title Case: Text to show for the translate bubble label when that page is in specified language and ask if should translate.">
-            Do You Want Google To Translate This Page From <ph name="source_language">$1<ex>Spanish</ex></ph> To <ph name="target_language">$2<ex>English</ex></ph>?
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_ADVANCED" desc="In Title Case: Text to show for the translate bubble link label to jump to the advanced panel.">
-            Options
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_ACCEPT" desc="In Title Case: Text to show for the translate bubble button to accept translation.">
-            Translate
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_DENY" desc="In Title Case: Text to show for the translate bubble menu item to deny translation.">
-            Nope
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_NEVER_TRANSLATE_LANG" desc="In Title Case: Text to show for the translate bubble menu item to never translate the specified language">
-            Never Translate <ph name="language">$1<ex>French</ex></ph>
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_NEVER_TRANSLATE_SITE" desc="In Title Case: Text to show for the translate bubble menu item to never translate the current site">
-            Never Translate This Site
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_TRANSLATING" desc="In Title Case: Text to show for the translate bubble label when page is currently being translated by servers">
-            This Page Is Being Translated...
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_TRANSLATED" desc="In Title Case: Text to show for the translate bubble label when the page has been translated from one language to another">
-            This Page Has Been Translated.
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_REVERT" desc="In Title Case: Text to show for the translate bubble button to revert translation of translated page">
-            Show Original
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_TRY_AGAIN" desc="In Title Case: Text to show for the translate bubble button to try to translate the page again">
-            Try Again
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_ALWAYS" desc="In Title Case: Text to show for the translate bubble checkbox to always translate from one language to another">
-            Always Translate
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_ALWAYS_DO_THIS" desc="In Title Case: Text to show for the translate bubble checkbox to always translate from one language to another in 2016Q2 UI">
-            Always Do This
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_OPTIONS_MENU_BUTTON" desc="In Title Case: Text to show for the translate bubble 'Options' menu button">
-            Options
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_COULD_NOT_TRANSLATE" desc="In Title Case: Text to show for the translate bubble label when the page could not be translated.">
-            This Page Could Not Be Translated.
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_PAGE_LANGUAGE" desc="In Title Case: Text to show for the translate bubble label next to the combobox of the page language">
-            Page Language:
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_TRANSLATION_LANGUAGE" desc="In Title Case: Text to show for the translate bubble label next to the combobox of the target language for Translate">
-            Translation Language:
-          </message>
-          <message name="IDS_TRANSLATE_BUBBLE_LANGUAGE_SETTINGS" desc="In Title Case: Text to show for the translate bubble link label next to jump to the language setting page.">
-            Language Settings
-          </message>
-        </if>
+        <message name="IDS_TRANSLATE_BUBBLE_BEFORE_TRANSLATE" desc="Text to show for the translate bubble label when that page is in specified language and ask if should translate.">
+          Would you like to translate this page?
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_BEFORE_TRANSLATE_NEW" desc="Text to show for the translate bubble label when that page is in specified language and ask if should translate.">
+          Do you want Google to translate this page from <ph name="source_language">$1<ex>Spanish</ex></ph> to <ph name="target_language">$2<ex>English</ex></ph>?
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_ADVANCED" desc="Text to show for the translate bubble link label to jump to the advanced panel.">
+          Options
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_ACCEPT" desc="Text to show for the translate bubble button to accept translation.">
+          Translate
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_DENY" desc="Text to show for the translate bubble menu item to deny translation.">
+          Nope
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_NEVER_TRANSLATE_LANG" desc="Text to show for the translate bubble menu item to never translate the specified language">
+          Never translate <ph name="language">$1<ex>French</ex></ph>
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_NEVER_TRANSLATE_SITE" desc="Text to show for the translate bubble menu item to never translate the current site">
+          Never translate this site
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_TRANSLATING" desc="Text to show for the translate bubble label when page is currently being translated by servers">
+          This page is being translated...
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_TRANSLATED" desc="Text to show for the translate bubble label when the page has been translated from one language to another">
+          This page has been translated.
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_REVERT" desc="Text to show for the translate bubble button to revert translation of translated page">
+          Show original
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_TRY_AGAIN" desc="Text to show for the translate bubble button to try to translate the page again">
+          Try again
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_ALWAYS" desc="Text to show for the translate bubble checkbox to always translate from one language to another">
+          Always translate
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_ALWAYS_DO_THIS" desc="Text to show for the translate bubble checkbox to always translate from one language to another in 2016Q2 UI">
+          Always do this
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_OPTIONS_MENU_BUTTON" desc="Text to show for the translate bubble 'Options' menu button">
+          Options
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_COULD_NOT_TRANSLATE" desc="Text to show for the translate bubble label when the page could not be translated.">
+          This page could not be translated.
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_PAGE_LANGUAGE" desc="Text to show for the translate bubble label next to the combobox of the page language">
+          Page language:
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_TRANSLATION_LANGUAGE" desc="Text to show for the translate bubble label next to the combobox of the target language for Translate">
+          Translation language:
+        </message>
+        <message name="IDS_TRANSLATE_BUBBLE_LANGUAGE_SETTINGS" desc="Text to show for the translate bubble link label next to jump to the language setting page.">
+          Language settings
+        </message>
       </if>
 
       <!-- Web and message center notifications -->
@@ -15134,12 +15069,6 @@ Please check your email at <ph name="ACCOUNT_EMAIL">$2<ex>jane.doe@gmail.com</ex
       <message name="IDS_FLAGS_ENABLE_NTP_OFFLINE_PAGE_SUGGESTIONS_DESCRIPTION" desc="Description for the flag to enable offline page suggestions on the New Tab page." translateable="false">
         If enabled, the list of content suggestions on the New Tab page (see #enable-ntp-snippets) will contain pages that were captured offline during browsing (see #offlining-recent-pages)
       </message>
-      <message name="IDS_FLAGS_ENABLE_NTP_BOOKMARK_SUGGESTIONS_NAME" desc="Name for the flag to enable bookmark suggestions on the New Tab page." translateable="false">
-        Show recently visited bookmarks on the New Tab page
-      </message>
-      <message name="IDS_FLAGS_ENABLE_NTP_BOOKMARK_SUGGESTIONS_DESCRIPTION" desc="Description for the flag to enable bookmark suggestions on the New Tab page." translateable="false">
-        If enabled, the list of content suggestions on the New Tab page (see #enable-ntp-snippets) will contain recently visited bookmarks.
-      </message>
     </if>
 
     <if expr="is_android">
diff --git a/chrome/app/settings_strings.grdp b/chrome/app/settings_strings.grdp
index 8f5f434..414ab0c 100644
--- a/chrome/app/settings_strings.grdp
+++ b/chrome/app/settings_strings.grdp
@@ -876,21 +876,6 @@
     <message name="IDS_SETTINGS_THIRD_PARTY_VPN_NAME_TEMPLATE" desc="Template for constructing the name of a VPN network that is handled by a third-party VPN provider from the provider name and the network name.">
       <ph name="PROVIDER_NAME">$1<ex>OpenVPN</ex></ph>: <ph name="NETWORK_NAME">$2<ex>Work Network</ex></ph>
     </message>
-    <message name="IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_BUTTON" desc="Text for button that opens the known networks subpage.">
-      Known networks
-    </message>
-    <message name="IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_PREFFERED" desc="Title for list of preferred networks.">
-      Preferred networks
-    </message>
-    <message name="IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_NO_PREFERRED" desc="Entry when there are no preferred networks in the known networks page.">
-      None
-    </message>
-    <message name="IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_MESSAGE" desc="Message describing the behavior of the known networks page.">
-      Preferred networks will be preferred over other known networks if more than one is available.
-    </message>
-    <message name="IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_ALL" desc="Title for list of all other (non preferred) networks.">
-      All networks
-    </message>
   </if>
 
   <!-- On Startup Page -->
diff --git a/chrome/app/theme/BUILD.gn b/chrome/app/theme/BUILD.gn
index 4081000..7c0a62f 100644
--- a/chrome/app/theme/BUILD.gn
+++ b/chrome/app/theme/BUILD.gn
@@ -21,6 +21,13 @@ grit("theme_resources") {
     "//ui/resources",
   ]
 
+  if (is_mac) {
+    outputs += [
+      "theme_resources_material_100_percent.pak",
+      "theme_resources_material_200_percent.pak",
+    ]
+  }
+
   output_dir = "$root_gen_dir/chrome"
 }
 
diff --git a/chrome/app/theme/default_100_percent/common/blocked_mixed_content.png b/chrome/app/theme/default_100_percent/common/blocked_mixed_content.png
new file mode 100644
index 0000000..9d651c6
Binary files /dev/null and b/chrome/app/theme/default_100_percent/common/blocked_mixed_content.png differ
diff --git a/chrome/app/theme/default_100_percent/common/blocked_pepper_broker.png b/chrome/app/theme/default_100_percent/common/blocked_pepper_broker.png
new file mode 100644
index 0000000..4dca4ef
Binary files /dev/null and b/chrome/app/theme/default_100_percent/common/blocked_pepper_broker.png differ
diff --git a/chrome/app/theme/default_100_percent/cros/downloads/copy_to_clipboard.png b/chrome/app/theme/default_100_percent/cros/downloads/copy_to_clipboard.png
index 125bd11..6679ab4 100644
Binary files a/chrome/app/theme/default_100_percent/cros/downloads/copy_to_clipboard.png and b/chrome/app/theme/default_100_percent/cros/downloads/copy_to_clipboard.png differ
diff --git a/chrome/app/theme/default_100_percent/cros/notification_screenshot_copy_to_clipboard.png b/chrome/app/theme/default_100_percent/cros/notification_screenshot_copy_to_clipboard.png
index 125bd11..6679ab4 100644
Binary files a/chrome/app/theme/default_100_percent/cros/notification_screenshot_copy_to_clipboard.png and b/chrome/app/theme/default_100_percent/cros/notification_screenshot_copy_to_clipboard.png differ
diff --git a/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder.png b/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder.png
index 37350eb..9c0045c 100644
Binary files a/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder.png and b/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder.png differ
diff --git a/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder_managed.png b/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder_managed.png
index e8c80f7..6d759cd 100644
Binary files a/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder_managed.png and b/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder_managed.png differ
diff --git a/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder_supervised.png b/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder_supervised.png
index 9987f32..e12b6e9 100644
Binary files a/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder_supervised.png and b/chrome/app/theme/default_100_percent/mac/bookmark_bar_folder_supervised.png differ
diff --git a/chrome/app/theme/default_200_percent/common/blocked_mixed_content.png b/chrome/app/theme/default_200_percent/common/blocked_mixed_content.png
new file mode 100644
index 0000000..4d529f1
Binary files /dev/null and b/chrome/app/theme/default_200_percent/common/blocked_mixed_content.png differ
diff --git a/chrome/app/theme/default_200_percent/common/blocked_pepper_broker.png b/chrome/app/theme/default_200_percent/common/blocked_pepper_broker.png
new file mode 100644
index 0000000..79455c7
Binary files /dev/null and b/chrome/app/theme/default_200_percent/common/blocked_pepper_broker.png differ
diff --git a/chrome/app/theme/default_200_percent/cros/downloads/copy_to_clipboard.png b/chrome/app/theme/default_200_percent/cros/downloads/copy_to_clipboard.png
index 5c4bd06..8043513 100644
Binary files a/chrome/app/theme/default_200_percent/cros/downloads/copy_to_clipboard.png and b/chrome/app/theme/default_200_percent/cros/downloads/copy_to_clipboard.png differ
diff --git a/chrome/app/theme/default_200_percent/cros/notification_screenshot_copy_to_clipboard.png b/chrome/app/theme/default_200_percent/cros/notification_screenshot_copy_to_clipboard.png
index 5c4bd06..8043513 100644
Binary files a/chrome/app/theme/default_200_percent/cros/notification_screenshot_copy_to_clipboard.png and b/chrome/app/theme/default_200_percent/cros/notification_screenshot_copy_to_clipboard.png differ
diff --git a/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder.png b/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder.png
index 813652f..b8c9fb1 100644
Binary files a/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder.png and b/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder.png differ
diff --git a/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder_managed.png b/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder_managed.png
index 9a9a899..a1b3b5b 100644
Binary files a/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder_managed.png and b/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder_managed.png differ
diff --git a/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder_supervised.png b/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder_supervised.png
index 68cc3f5..440ad71 100644
Binary files a/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder_supervised.png and b/chrome/app/theme/default_200_percent/mac/bookmark_bar_folder_supervised.png differ
diff --git a/chrome/app/theme/material_100_percent/mac/bookmark_bar_folder.png b/chrome/app/theme/material_100_percent/mac/bookmark_bar_folder.png
new file mode 100644
index 0000000..37350eb
Binary files /dev/null and b/chrome/app/theme/material_100_percent/mac/bookmark_bar_folder.png differ
diff --git a/chrome/app/theme/material_100_percent/mac/bookmark_bar_folder_managed.png b/chrome/app/theme/material_100_percent/mac/bookmark_bar_folder_managed.png
new file mode 100644
index 0000000..e8c80f7
Binary files /dev/null and b/chrome/app/theme/material_100_percent/mac/bookmark_bar_folder_managed.png differ
diff --git a/chrome/app/theme/material_100_percent/mac/bookmark_bar_folder_supervised.png b/chrome/app/theme/material_100_percent/mac/bookmark_bar_folder_supervised.png
new file mode 100644
index 0000000..9987f32
Binary files /dev/null and b/chrome/app/theme/material_100_percent/mac/bookmark_bar_folder_supervised.png differ
diff --git a/chrome/app/theme/material_200_percent/mac/bookmark_bar_folder.png b/chrome/app/theme/material_200_percent/mac/bookmark_bar_folder.png
new file mode 100644
index 0000000..813652f
Binary files /dev/null and b/chrome/app/theme/material_200_percent/mac/bookmark_bar_folder.png differ
diff --git a/chrome/app/theme/material_200_percent/mac/bookmark_bar_folder_managed.png b/chrome/app/theme/material_200_percent/mac/bookmark_bar_folder_managed.png
new file mode 100644
index 0000000..9a9a899
Binary files /dev/null and b/chrome/app/theme/material_200_percent/mac/bookmark_bar_folder_managed.png differ
diff --git a/chrome/app/theme/material_200_percent/mac/bookmark_bar_folder_supervised.png b/chrome/app/theme/material_200_percent/mac/bookmark_bar_folder_supervised.png
new file mode 100644
index 0000000..68cc3f5
Binary files /dev/null and b/chrome/app/theme/material_200_percent/mac/bookmark_bar_folder_supervised.png differ
diff --git a/chrome/app/theme/theme_resources.grd b/chrome/app/theme/theme_resources.grd
index cf5be0f..cff32e2 100644
--- a/chrome/app/theme/theme_resources.grd
+++ b/chrome/app/theme/theme_resources.grd
@@ -19,6 +19,10 @@
     <output filename="theme_resources_100_percent.pak" type="data_package" context="default_100_percent" />
     <output filename="theme_resources_200_percent.pak" type="data_package" context="default_200_percent" />
     <output filename="theme_resources_300_percent.pak" type="data_package" context="default_300_percent" />
+    <if expr="is_macosx">
+      <output filename="theme_resources_material_100_percent.pak" type="data_package" context="material_100_percent" fallback_to_default_layout="false" />
+      <output filename="theme_resources_material_200_percent.pak" type="data_package" context="material_200_percent" fallback_to_default_layout="false" />
+    </if>
   </outputs>
   <release seq="1">
     <structures fallback_to_low_resolution="true">
@@ -98,12 +102,14 @@
       <structure type="chrome_scaled_image" name="IDR_BLOCKED_LOCATION" file="common/blocked_location.png" />
       <structure type="chrome_scaled_image" name="IDR_BLOCKED_MIC" file="common/blocked_mic.png" />
       <structure type="chrome_scaled_image" name="IDR_BLOCKED_MIDI_SYSEX" file="common/blocked_midi.png" />
+      <structure type="chrome_scaled_image" name="IDR_BLOCKED_MIXED_CONTENT" file="common/blocked_mixed_content.png" />
       <structure type="chrome_scaled_image" name="IDR_BLOCKED_MOUSE_CURSOR" file="common/blocked_mouse_cursor.png" />
       <structure type="chrome_scaled_image" name="IDR_BLOCKED_NOTIFICATION" file="common/blocked_notifications.png" />
       <if expr="enable_plugins">
         <structure type="chrome_scaled_image" name="IDR_BLOCKED_PLUGINS" file="common/blocked_plugins.png" />
       </if>
       <structure type="chrome_scaled_image" name="IDR_BLOCKED_POPUPS" file="common/blocked_popups.png" />
+      <structure type="chrome_scaled_image" name="IDR_BLOCKED_PPAPI_BROKER" file="common/blocked_pepper_broker.png" />
       <structure type="chrome_scaled_image" name="IDR_BLOCKED_USB" file="common/blocked_usb.png" />
       <if expr="chromeos">
         <structure type="chrome_scaled_image" name="IDR_BLUETOOTH_KEYBOARD" file="cros/bluetooth_pairing_keyboard.png" />
diff --git a/chrome/browser/BUILD.gn b/chrome/browser/BUILD.gn
index 93c0bd8..f31f319 100644
--- a/chrome/browser/BUILD.gn
+++ b/chrome/browser/BUILD.gn
@@ -18,6 +18,9 @@ if (is_android) {
 } else {
   import("//tools/grit/grit_rule.gni")
 }
+if (is_desktop_linux) {
+  import("//build/config/linux/pkg_config.gni")
+}
 
 additional_modules_list_file =
     "$root_gen_dir/chrome/browser/internal/additional_modules_list.txt"
@@ -46,6 +49,25 @@ if (is_win) {
   }
 }
 
+if (is_desktop_linux) {
+  # Gnome-keyring is normally dynamically loaded. The gnome_keyring config
+  # will set this up.
+  pkg_config("gnome_keyring") {
+    packages = [ "gnome-keyring-1" ]
+    defines = [ "USE_GNOME_KEYRING" ]
+    ignore_libs = true
+  }
+
+  # If you want to link gnome-keyring directly (use only for unit tests)
+  # ADDITIONALLY add this config on top of ":gnome_keyring". pkg-config is a
+  # bit slow, so prefer not to run it again. In practice, gnome-keyring's libs
+  # are just itself and common gnome ones we link already, so we can get away
+  # with additionally just coding the library name here.
+  config("gnome_keyring_direct") {
+    libs = [ "gnome-keyring" ]
+  }
+}
+
 # Use a static library here because many test binaries depend on this but don't
 # require many files from it. This makes linking more efficient.
 split_static_library("browser") {
@@ -569,7 +591,7 @@ split_static_library("browser") {
     sources += rebase_path(gypi_values.chrome_browser_gnome_keyring_sources,
                            ".",
                            "//chrome")
-    configs += [ "//components/os_crypt:gnome_keyring" ]
+    configs += [ ":gnome_keyring" ]
   }
   if (is_desktop_linux) {
     sources += rebase_path(gypi_values.chrome_browser_libsecret_sources,
@@ -744,14 +766,12 @@ split_static_library("browser") {
       ":delta_file_proto",
       ":jni_headers",
       "//blimp/client/public",
-      "//chrome/browser/android/webapk:proto",
       "//components/data_usage/android",
       "//components/precache/content",
       "//components/precache/core",
       "//components/resources:components_resources",
       "//components/toolbar",
       "//components/web_contents_delegate_android",
-      "//third_party/smhasher:murmurhash2",
     ]
   }
 
diff --git a/chrome/browser/about_flags.cc b/chrome/browser/about_flags.cc
index 74b692c..c7a5d4f 100644
--- a/chrome/browser/about_flags.cc
+++ b/chrome/browser/about_flags.cc
@@ -560,12 +560,14 @@ const FeatureEntry::FeatureParam
 
 const FeatureEntry::FeatureParam kNTPSnippetsFeatureVariationServer[] = {
     {"content_suggestions_backend",
-     ntp_snippets::kContentSuggestionsSandboxServer}};
+     "https://dev-chromecontentsuggestions-pa.sandbox.googleapis.com/v1/"
+     "snippets/list"}};
 
 const FeatureEntry::FeatureParam
     kNTPSnippetsFeatureVariationServerNonPersonalized[] = {
         {"content_suggestions_backend",
-         ntp_snippets::kContentSuggestionsSandboxServer},
+         "https://dev-chromecontentsuggestions-pa.sandbox.googleapis.com/v1/"
+         "snippets/list"},
         {"fetching_personalization", "non_personal"}};
 
 const FeatureEntry::FeatureVariation kNTPSnippetsFeatureVariations[] = {
@@ -1908,10 +1910,6 @@ const FeatureEntry kFeatureEntries[] = {
      IDS_FLAGS_ENABLE_NTP_OFFLINE_PAGE_SUGGESTIONS_NAME,
      IDS_FLAGS_ENABLE_NTP_OFFLINE_PAGE_SUGGESTIONS_DESCRIPTION, kOsAndroid,
      FEATURE_VALUE_TYPE(chrome::android::kNTPOfflinePageSuggestionsFeature)},
-    {"enable-ntp-bookmark-suggestions",
-     IDS_FLAGS_ENABLE_NTP_BOOKMARK_SUGGESTIONS_NAME,
-     IDS_FLAGS_ENABLE_NTP_BOOKMARK_SUGGESTIONS_DESCRIPTION, kOsAndroid,
-     FEATURE_VALUE_TYPE(ntp_snippets::kBookmarkSuggestionsFeature)},
 #endif  // defined(OS_ANDROID)
 #if defined(ENABLE_WEBRTC) && BUILDFLAG(RTC_USE_H264)
     {"enable-webrtc-h264-with-openh264-ffmpeg",
diff --git a/chrome/browser/android/banners/app_banner_infobar_delegate_android.cc b/chrome/browser/android/banners/app_banner_infobar_delegate_android.cc
index 643eb4c..03a1390 100644
--- a/chrome/browser/android/banners/app_banner_infobar_delegate_android.cc
+++ b/chrome/browser/android/banners/app_banner_infobar_delegate_android.cc
@@ -262,9 +262,8 @@ bool AppBannerInfoBarDelegateAndroid::Accept() {
     const std::string& uid = base::GenerateGUID();
     content::BrowserThread::PostTask(
         content::BrowserThread::IO, FROM_HERE,
-        base::Bind(&ShortcutHelper::AddToLauncherInBackgroundWithSkBitmap,
-                   web_contents->GetBrowserContext(), info, uid,
-                   *app_icon_.get(),
+        base::Bind(&ShortcutHelper::AddToLauncherInBackgroundWithSkBitmap, info,
+                   uid, *app_icon_.get(),
                    data_fetcher_->FetchWebappSplashScreenImageCallback(uid)));
 
     SendBannerAccepted(web_contents, "web");
diff --git a/chrome/browser/android/ntp/ntp_snippets_bridge.cc b/chrome/browser/android/ntp/ntp_snippets_bridge.cc
index a8d487d..d8e8110 100644
--- a/chrome/browser/android/ntp/ntp_snippets_bridge.cc
+++ b/chrome/browser/android/ntp/ntp_snippets_bridge.cc
@@ -25,9 +25,10 @@
 
 using base::android::AttachCurrentThread;
 using base::android::ConvertJavaStringToUTF8;
-using base::android::ConvertUTF8ToJavaString;
-using base::android::ConvertUTF16ToJavaString;
 using base::android::JavaParamRef;
+using base::android::ToJavaArrayOfStrings;
+using base::android::ToJavaLongArray;
+using base::android::ToJavaFloatArray;
 using base::android::ScopedJavaGlobalRef;
 using base::android::ScopedJavaLocalRef;
 using ntp_snippets::Category;
@@ -128,8 +129,7 @@ void NTPSnippetsBridge::SnippetVisited(JNIEnv* env,
 }
 
 int NTPSnippetsBridge::GetCategoryStatus(JNIEnv* env,
-                                         const JavaParamRef<jobject>& obj,
-                                         jint category) {
+                                         const JavaParamRef<jobject>& obj) {
   return static_cast<int>(content_suggestions_service_->GetCategoryStatus(
       content_suggestions_service_->category_factory()->FromKnownCategory(
           KnownCategories::ARTICLES)));
@@ -141,51 +141,62 @@ void NTPSnippetsBridge::OnNewSuggestions() {
   if (observer_.is_null())
     return;
 
+  std::vector<std::string> ids;
+  std::vector<base::string16> titles;
+  // URL for the article. This will also be used to find the favicon for the
+  // article.
+  std::vector<std::string> urls;
+  // URL for the AMP version of the article if it exists. This will be used as
+  // the URL to direct the user to on tap.
+  std::vector<std::string> amp_urls;
+  std::vector<base::string16> snippet_texts;
+  std::vector<int64_t> timestamps;
+  std::vector<base::string16> publisher_names;
+  std::vector<float> scores;
+
   // Show all suggestions from all categories, even though we currently display
   // them in a single section on the UI.
   // TODO(pke): This is only for debugging new sections and will be replaced
   // with proper multi-section UI support.
-  JNIEnv* env = base::android::AttachCurrentThread();
-  ScopedJavaLocalRef<jobject> suggestions =
-      Java_SnippetsBridge_createSuggestionList(env);
-  for (Category category :
-       content_suggestions_service_->GetCategories()) {
+  for (Category category : content_suggestions_service_->GetCategories()) {
     if (content_suggestions_service_->GetCategoryStatus(category) !=
         CategoryStatus::AVAILABLE) {
       continue;
     }
     for (const ntp_snippets::ContentSuggestion& suggestion :
          content_suggestions_service_->GetSuggestionsForCategory(category)) {
-      Java_SnippetsBridge_addSuggestion(
-          env, suggestions.obj(),
-          ConvertUTF8ToJavaString(env, suggestion.id()).obj(),
-          ConvertUTF16ToJavaString(env, suggestion.title()).obj(),
-          ConvertUTF16ToJavaString(env, suggestion.publisher_name()).obj(),
-          ConvertUTF16ToJavaString(env, suggestion.snippet_text()).obj(),
-          ConvertUTF8ToJavaString(env, suggestion.url().spec()).obj(),
-          ConvertUTF8ToJavaString(env, suggestion.amp_url().spec()).obj(),
-          suggestion.publish_date().ToJavaTime(), suggestion.score());
+      ids.push_back(suggestion.id());
+      titles.push_back(suggestion.title());
+      // The url from source_info is a url for a site that is one of the
+      // HOST_RESTRICT parameters, so this is preferred.
+      urls.push_back(suggestion.url().spec());
+      amp_urls.push_back(suggestion.amp_url().spec());
+      snippet_texts.push_back(suggestion.snippet_text());
+      timestamps.push_back(suggestion.publish_date().ToJavaTime());
+      publisher_names.push_back(suggestion.publisher_name());
+      scores.push_back(suggestion.score());
     }
   }
 
-  // TODO(mvanouwerkerk): Do not hard code ARTICLES.
-  Java_SnippetsBridge_onSuggestionsAvailable(
-      env, observer_.obj(),
-      static_cast<int>(
-          content_suggestions_service_->category_factory()->FromKnownCategory(
-              KnownCategories::ARTICLES).id()),
-      suggestions.obj());
+  JNIEnv* env = base::android::AttachCurrentThread();
+  Java_SnippetsBridge_onSnippetsAvailable(
+      env, observer_.obj(), ToJavaArrayOfStrings(env, ids).obj(),
+      ToJavaArrayOfStrings(env, titles).obj(),
+      ToJavaArrayOfStrings(env, urls).obj(),
+      ToJavaArrayOfStrings(env, amp_urls).obj(),
+      ToJavaArrayOfStrings(env, snippet_texts).obj(),
+      ToJavaLongArray(env, timestamps).obj(),
+      ToJavaArrayOfStrings(env, publisher_names).obj(),
+      ToJavaFloatArray(env, scores).obj());
 }
 
 void NTPSnippetsBridge::OnCategoryStatusChanged(Category category,
                                                 CategoryStatus new_status) {
-  // TODO(mvanouwerkerk): Do not hard code ARTICLES.
   if (!category.IsKnownCategory(KnownCategories::ARTICLES))
     return;
 
   JNIEnv* env = base::android::AttachCurrentThread();
   Java_SnippetsBridge_onCategoryStatusChanged(env, observer_.obj(),
-                                              static_cast<int>(category.id()),
                                               static_cast<int>(new_status));
 }
 
diff --git a/chrome/browser/android/ntp/ntp_snippets_bridge.h b/chrome/browser/android/ntp/ntp_snippets_bridge.h
index 5c2715d..df93620 100644
--- a/chrome/browser/android/ntp/ntp_snippets_bridge.h
+++ b/chrome/browser/android/ntp/ntp_snippets_bridge.h
@@ -49,11 +49,10 @@ class NTPSnippetsBridge
                       const base::android::JavaParamRef<jobject>& callback,
                       const base::android::JavaParamRef<jstring>& jurl);
 
-  // Returns the status of |category|.
+  // Returns the status of the ARTICLES category.
   // See CategoryStatus for more info.
   int GetCategoryStatus(JNIEnv* env,
-                        const base::android::JavaParamRef<jobject>& obj,
-                        jint category);
+                        const base::android::JavaParamRef<jobject>& obj);
 
   static bool Register(JNIEnv* env);
 
diff --git a/chrome/browser/android/preferences/pref_service_bridge.cc b/chrome/browser/android/preferences/pref_service_bridge.cc
index c83f95d..8de0770 100644
--- a/chrome/browser/android/preferences/pref_service_bridge.cc
+++ b/chrome/browser/android/preferences/pref_service_bridge.cc
@@ -605,6 +605,9 @@ static void ClearBrowsingData(
     const JavaParamRef<jobjectArray>& jexcluding_domains) {
   BrowsingDataRemover* browsing_data_remover =
       BrowsingDataRemoverFactory::GetForBrowserContext(GetOriginalProfile());
+  // ClearBrowsingDataObserver deletes itself when |browsing_data_remover| is
+  // done.
+  new ClearBrowsingDataObserver(env, obj, browsing_data_remover);
 
   std::vector<int> data_types_vector;
   base::android::JavaIntArrayToIntVector(env, data_types, &data_types_vector);
@@ -639,10 +642,10 @@ static void ClearBrowsingData(
   std::vector<std::string> excluding_domains;
   base::android::AppendJavaStringArrayToStringVector(
       env, jexcluding_domains.obj(), &excluding_domains);
-  std::unique_ptr<RegistrableDomainFilterBuilder> filter_builder(
-      new RegistrableDomainFilterBuilder(BrowsingDataFilterBuilder::BLACKLIST));
+  RegistrableDomainFilterBuilder filter_builder(
+      BrowsingDataFilterBuilder::BLACKLIST);
   for (const std::string& domain : excluding_domains) {
-    filter_builder->AddRegisterableDomain(domain);
+    filter_builder.AddRegisterableDomain(domain);
   }
 
   if (!excluding_domains.empty()) {
@@ -650,16 +653,10 @@ static void ClearBrowsingData(
                                                          excluding_domains);
   }
 
-  // ClearBrowsingDataObserver deletes itself when |browsing_data_remover| is
-  // done.
-  ClearBrowsingDataObserver* observer =
-      new ClearBrowsingDataObserver(env, obj, browsing_data_remover);
-
-  browsing_data_remover->RemoveWithFilterAndReply(
+  browsing_data_remover->RemoveWithFilter(
       BrowsingDataRemover::Period(
           static_cast<browsing_data::TimePeriod>(time_period)),
-      remove_mask, BrowsingDataHelper::UNPROTECTED_WEB,
-      std::move(filter_builder), observer);
+      remove_mask, BrowsingDataHelper::UNPROTECTED_WEB, filter_builder);
 }
 
 static jboolean CanDeleteBrowsingHistory(JNIEnv* env,
diff --git a/chrome/browser/android/shortcut_helper.cc b/chrome/browser/android/shortcut_helper.cc
index 9afc815..50c6cad 100644
--- a/chrome/browser/android/shortcut_helper.cc
+++ b/chrome/browser/android/shortcut_helper.cc
@@ -14,7 +14,6 @@
 #include "base/command_line.h"
 #include "base/strings/string16.h"
 #include "base/strings/utf_string_conversions.h"
-#include "chrome/browser/android/webapk/webapk_installer.h"
 #include "chrome/browser/manifest/manifest_icon_downloader.h"
 #include "chrome/common/chrome_switches.h"
 #include "content/public/browser/browser_thread.h"
@@ -65,7 +64,6 @@ void GetHomescreenIconAndSplashImageSizes() {
 
 // static
 void ShortcutHelper::AddToLauncherInBackgroundWithSkBitmap(
-    content::BrowserContext* browser_context,
     const ShortcutInfo& info,
     const std::string& webapp_id,
     const SkBitmap& icon_bitmap,
@@ -76,7 +74,7 @@ void ShortcutHelper::AddToLauncherInBackgroundWithSkBitmap(
       info.display == blink::WebDisplayModeFullscreen) {
     if (base::CommandLine::ForCurrentProcess()->HasSwitch(
             switches::kEnableWebApk)) {
-      InstallWebApkInBackgroundWithSkBitmap(browser_context, info, icon_bitmap);
+      InstallWebApkInBackgroundWithSkBitmap(info, webapp_id, icon_bitmap);
       return;
     }
     AddWebappInBackgroundWithSkBitmap(info, webapp_id, icon_bitmap,
@@ -88,14 +86,43 @@ void ShortcutHelper::AddToLauncherInBackgroundWithSkBitmap(
 
 // static
 void ShortcutHelper::InstallWebApkInBackgroundWithSkBitmap(
-    content::BrowserContext* browser_context,
     const ShortcutInfo& info,
+    const std::string& webapp_id,
     const SkBitmap& icon_bitmap) {
   DCHECK_CURRENTLY_ON(content::BrowserThread::IO);
-  // WebApkInstaller destroys itself when it is done.
-  WebApkInstaller* installer = new WebApkInstaller(info, icon_bitmap);
-  installer->InstallAsync(browser_context,
-                          base::Bind(&ShortcutHelper::OnBuiltWebApk));
+
+  // TODO(pkotwicz): Send request to WebAPK server to generate WebAPK.
+
+  JNIEnv* env = base::android::AttachCurrentThread();
+  ScopedJavaLocalRef<jstring> java_url =
+      base::android::ConvertUTF8ToJavaString(env, info.url.spec());
+  ScopedJavaLocalRef<jstring> java_scope_url =
+      base::android::ConvertUTF8ToJavaString(env, info.scope.spec());
+  ScopedJavaLocalRef<jstring> java_name =
+      base::android::ConvertUTF16ToJavaString(env, info.name);
+  ScopedJavaLocalRef<jstring> java_short_name =
+      base::android::ConvertUTF16ToJavaString(env, info.short_name);
+  ScopedJavaLocalRef<jstring> java_icon_url =
+      base::android::ConvertUTF8ToJavaString(env, info.icon_url.spec());
+  ScopedJavaLocalRef<jobject> java_bitmap;
+  if (icon_bitmap.getSize())
+    java_bitmap = gfx::ConvertToJavaBitmap(&icon_bitmap);
+  ScopedJavaLocalRef<jstring> java_manifest_url =
+      base::android::ConvertUTF8ToJavaString(env, info.manifest_url.spec());
+
+  Java_ShortcutHelper_installWebApk(
+      env,
+      java_url.obj(),
+      java_scope_url.obj(),
+      java_name.obj(),
+      java_short_name.obj(),
+      java_icon_url.obj(),
+      java_bitmap.obj(),
+      info.display,
+      info.orientation,
+      info.theme_color,
+      info.background_color,
+      java_manifest_url.obj());
 }
 
 // static
@@ -167,16 +194,6 @@ void ShortcutHelper::AddShortcutInBackgroundWithSkBitmap(
                                   java_bitmap.obj(), info.source);
 }
 
-void ShortcutHelper::OnBuiltWebApk(bool success) {
-  if (success) {
-    DVLOG(1) << "Sent request to install WebAPK. Seems to have worked.";
-  } else {
-    LOG(ERROR) << "WebAPK install failed.";
-  }
-  // TODO(pkotwicz): Figure out what to do when installing WebAPK fails.
-  // (crbug.com/626950)
-}
-
 int ShortcutHelper::GetIdealHomescreenIconSizeInDp() {
   if (kIdealHomescreenIconSize == -1)
     GetHomescreenIconAndSplashImageSizes();
diff --git a/chrome/browser/android/shortcut_helper.h b/chrome/browser/android/shortcut_helper.h
index 8f489d3..bd7f0c4 100644
--- a/chrome/browser/android/shortcut_helper.h
+++ b/chrome/browser/android/shortcut_helper.h
@@ -13,7 +13,6 @@
 #include "third_party/skia/include/core/SkBitmap.h"
 
 namespace content {
-class BrowserContext;
 class WebContents;
 }  // namespace content
 
@@ -30,7 +29,6 @@ class ShortcutHelper {
   // or AddShortcutInBackgroundWithSkBitmap.
   // Must not be called on the UI thread.
   static void AddToLauncherInBackgroundWithSkBitmap(
-      content::BrowserContext* browser_context,
       const ShortcutInfo& info,
       const std::string& webapp_id,
       const SkBitmap& icon_bitmap,
@@ -39,8 +37,8 @@ class ShortcutHelper {
   // Installs WebAPK and adds shortcut to the launcher.
   // Must not be called on the UI thread.
   static void InstallWebApkInBackgroundWithSkBitmap(
-      content::BrowserContext* browser_context,
       const ShortcutInfo& info,
+      const std::string& webapp_id,
       const SkBitmap& icon_bitmap);
 
   // Adds a shortcut which opens in a fullscreen window to the launcher.
@@ -61,15 +59,6 @@ class ShortcutHelper {
       const ShortcutInfo& info,
       const SkBitmap& icon_bitmap);
 
-  // Called after either:
-  // - A request to install the WebAPK has been sent.
-  // OR
-  // - WebAPK creation process fails.
-  // |success| indicates whether an installation request was sent. A "true"
-  // value of |success| does not guarantee that the WebAPK will be successfully
-  // installed.
-  static void OnBuiltWebApk(bool success);
-
   // Returns the ideal size for an icon representing a web app.
   static int GetIdealHomescreenIconSizeInDp();
 
diff --git a/chrome/browser/android/signin/signin_manager_android.cc b/chrome/browser/android/signin/signin_manager_android.cc
index f836f8d..3da8310 100644
--- a/chrome/browser/android/signin/signin_manager_android.cc
+++ b/chrome/browser/android/signin/signin_manager_android.cc
@@ -60,9 +60,8 @@ class ProfileDataRemover : public BrowsingDataRemover::Observer {
         origin_runner_(base::ThreadTaskRunnerHandle::Get()),
         remover_(BrowsingDataRemoverFactory::GetForBrowserContext(profile)) {
     remover_->AddObserver(this);
-    remover_->RemoveAndReply(BrowsingDataRemover::Unbounded(),
-                             BrowsingDataRemover::REMOVE_ALL,
-                             BrowsingDataHelper::ALL, this);
+    remover_->Remove(BrowsingDataRemover::Unbounded(),
+                     BrowsingDataRemover::REMOVE_ALL, BrowsingDataHelper::ALL);
   }
 
   ~ProfileDataRemover() override {}
diff --git a/chrome/browser/android/webapk/BUILD.gn b/chrome/browser/android/webapk/BUILD.gn
deleted file mode 100644
index 6bcd0ac..0000000
--- a/chrome/browser/android/webapk/BUILD.gn
+++ /dev/null
@@ -1,11 +0,0 @@
-# Copyright 2016 The Chromium Authors. All rights reserved.
-# Use of this source code is governed by a BSD-style license that can be
-# found in the LICENSE file.
-
-import("//third_party/protobuf/proto_library.gni")
-
-proto_library("proto") {
-  sources = [
-    "webapk.proto",
-  ]
-}
diff --git a/chrome/browser/android/webapk/webapk.proto b/chrome/browser/android/webapk/webapk.proto
deleted file mode 100644
index 773a3fd..0000000
--- a/chrome/browser/android/webapk/webapk.proto
+++ /dev/null
@@ -1,70 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-syntax = "proto2";
-
-option optimize_for = LITE_RUNTIME;
-
-package webapk;
-
-// Creates a WebAPK on the server and returns URL to download WebAPK from Google
-// Play.
-message CreateWebApkRequest {
-  optional WebApk webapk = 1;
-}
-
-// Response to CreateWebApkRequest.
-message CreateWebApkResponse {
-  // Package name to install WebAPK at.
-  optional string webapk_package_name = 1;
-
-  // URL to download WebAPK.
-  optional string signed_download_url = 2;
-}
-
-message WebApk {
-  // The URL of the Web App Manifest.
-  optional string manifest_url = 2;
-
-  // Chrome's package name.
-  optional string requester_application_package = 4;
-
-  // Chrome's version.
-  optional string requester_application_version = 5;
-
-  // The Web App Manifest.
-  optional WebAppManifest manifest = 6;
-
-  reserved 1, 3;
-}
-
-// Contains data from the Web App Manifest.
-message WebAppManifest {
-  optional string name = 1;
-  optional string short_name = 2;
-  optional string start_url = 4;
-  repeated string scopes = 5;
-  repeated Image icons = 6;
-  optional string orientation = 9;
-  optional string display_mode = 10;
-  optional string theme_color = 11;
-  optional string background_color = 12;
-
-  reserved 3, 7, 8, 13, 14;
-}
-
-message Image {
-  // Image's URL.
-  optional string src = 1;
-
-  // Murmur2 hash of the icon's bytes. There should not be any transformations
-  // applied to the icon's bytes prior to taking the Murmur2 hash.
-  optional uint64 hash = 5;
-
-  // Actual bytes of the image. This image may be re-encoded from the original
-  // image and may not match the murmur2 hash field above.
-  optional bytes image_data = 6;
-
-  reserved 2 to 4;
-}
diff --git a/chrome/browser/android/webapk/webapk_installer.cc b/chrome/browser/android/webapk/webapk_installer.cc
deleted file mode 100644
index 645f842..0000000
--- a/chrome/browser/android/webapk/webapk_installer.cc
+++ /dev/null
@@ -1,280 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/browser/android/webapk/webapk_installer.h"
-
-#include "base/android/build_info.h"
-#include "base/android/jni_android.h"
-#include "base/android/jni_string.h"
-#include "base/android/path_utils.h"
-#include "base/bind.h"
-#include "base/command_line.h"
-#include "base/files/file_path.h"
-#include "base/files/file_util.h"
-#include "base/strings/string_util.h"
-#include "base/strings/stringprintf.h"
-#include "base/strings/utf_string_conversions.h"
-#include "chrome/browser/android/shortcut_helper.h"
-#include "chrome/browser/android/webapk/webapk.pb.h"
-#include "chrome/browser/profiles/profile.h"
-#include "chrome/common/chrome_switches.h"
-#include "components/version_info/version_info.h"
-#include "content/public/browser/browser_thread.h"
-#include "jni/WebApkInstaller_jni.h"
-#include "net/http/http_status_code.h"
-#include "net/url_request/url_fetcher.h"
-#include "third_party/smhasher/src/MurmurHash2.h"
-#include "ui/gfx/codec/png_codec.h"
-#include "url/gurl.h"
-
-namespace {
-
-// The default WebAPK server URL.
-const char kDefaultWebApkServerUrl[] =
-    "https://webapk.googleapis.com/v1alpha/webApks?alt=proto";
-
-// The MIME type of the POST data sent to the server.
-const char kProtoMimeType[] = "application/x-protobuf";
-
-// The seed to use the murmur2 hash of the app icon.
-const uint32_t kMurmur2HashSeed = 0;
-
-// The number of milliseconds to wait for the WebAPK download URL from the
-// WebAPK server.
-const int kWebApkDownloadUrlTimeoutMs = 4000;
-
-// The number of milliseconds to wait for the WebAPK download to complete.
-const int kDownloadTimeoutMs = 20000;
-
-// Returns the scope from |info| if it is specified. Otherwise, returns the
-// default scope.
-GURL GetScope(const ShortcutInfo& info) {
-  return (info.scope.is_valid()) ? info.scope : info.url.GetOrigin();
-}
-
-// Computes a murmur2 hash of |bitmap|'s PNG encoded bytes.
-uint64_t ComputeBitmapHash(const SkBitmap& bitmap) {
-  std::vector<unsigned char> png_bytes;
-  gfx::PNGCodec::EncodeBGRASkBitmap(bitmap, false, &png_bytes);
-  return MurmurHash64B(&png_bytes.front(), png_bytes.size(), kMurmur2HashSeed);
-}
-
-// Converts a color from the format specified in content::Manifest to a CSS
-// string.
-std::string ColorToString(int64_t color) {
-  if (color == content::Manifest::kInvalidOrMissingColor)
-    return "";
-
-  SkColor sk_color = reinterpret_cast<uint32_t&>(color);
-  int r = SkColorGetR(sk_color);
-  int g = SkColorGetG(sk_color);
-  int b = SkColorGetB(sk_color);
-  double a = SkColorGetA(sk_color) / 255.0;
-  return base::StringPrintf("rgba(%d,%d,%d,%.2f)", r, g, b, a);
-}
-
-}  // anonymous namespace
-
-WebApkInstaller::WebApkInstaller(const ShortcutInfo& shortcut_info,
-                                 const SkBitmap& shortcut_icon)
-    : shortcut_info_(shortcut_info),
-      shortcut_icon_(shortcut_icon),
-      io_weak_ptr_factory_(this) {
-  base::CommandLine* command_line = base::CommandLine::ForCurrentProcess();
-  server_url_ =
-      GURL(command_line->HasSwitch(switches::kWebApkServerUrl)
-               ? command_line->GetSwitchValueASCII(switches::kWebApkServerUrl)
-               : kDefaultWebApkServerUrl);
-}
-
-WebApkInstaller::~WebApkInstaller() {}
-
-void WebApkInstaller::InstallAsync(content::BrowserContext* browser_context,
-                                   const FinishCallback& finish_callback) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::IO);
-  finish_callback_ = finish_callback;
-  // base::Unretained() is safe because WebApkInstaller owns itself and does not
-  // start the timeout timer till after
-  // InitializeRequestContextGetterOnUIThread() is called.
-  content::BrowserThread::PostTask(
-      content::BrowserThread::UI, FROM_HERE,
-      base::Bind(&WebApkInstaller::InitializeRequestContextGetterOnUIThread,
-                 base::Unretained(this), browser_context));
-}
-
-void WebApkInstaller::InstallAsyncWithURLRequestContextGetter(
-    net::URLRequestContextGetter* request_context_getter,
-    const FinishCallback& finish_callback) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::IO);
-  request_context_getter_ = request_context_getter;
-  finish_callback_ = finish_callback;
-
-  SendCreateWebApkRequest();
-}
-
-bool WebApkInstaller::StartDownloadedWebApkInstall(
-    JNIEnv* env,
-    const base::android::ScopedJavaLocalRef<jstring>& java_file_path,
-    const base::android::ScopedJavaLocalRef<jstring>& java_package_name) {
-  return Java_WebApkInstaller_installAsyncFromNative(env, java_file_path.obj(),
-                                                     java_package_name.obj());
-}
-
-void WebApkInstaller::OnURLFetchComplete(const net::URLFetcher* source) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::IO);
-  timer_.Stop();
-
-  if (!source->GetStatus().is_success() ||
-      source->GetResponseCode() != net::HTTP_OK) {
-    OnFailure();
-    return;
-  }
-
-  std::string response_string;
-  source->GetResponseAsString(&response_string);
-
-  std::unique_ptr<webapk::CreateWebApkResponse> response(
-      new webapk::CreateWebApkResponse);
-  if (!response->ParseFromString(response_string)) {
-    OnFailure();
-    return;
-  }
-
-  if (response->signed_download_url().empty() ||
-      response->webapk_package_name().empty()) {
-    OnFailure();
-    return;
-  }
-  OnGotWebApkDownloadUrl(response->signed_download_url(),
-                         response->webapk_package_name());
-}
-
-void WebApkInstaller::InitializeRequestContextGetterOnUIThread(
-    content::BrowserContext* browser_context) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
-  // Profile::GetRequestContext() must be called on UI thread.
-  request_context_getter_ =
-      Profile::FromBrowserContext(browser_context)->GetRequestContext();
-
-  content::BrowserThread::PostTask(
-      content::BrowserThread::IO, FROM_HERE,
-      base::Bind(&WebApkInstaller::SendCreateWebApkRequest,
-                 io_weak_ptr_factory_.GetWeakPtr()));
-}
-
-void WebApkInstaller::SendCreateWebApkRequest() {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::IO);
-  std::unique_ptr<webapk::CreateWebApkRequest> request =
-      BuildCreateWebApkRequest();
-
-  timer_.Start(FROM_HERE,
-               base::TimeDelta::FromMilliseconds(kWebApkDownloadUrlTimeoutMs),
-               base::Bind(&WebApkInstaller::OnTimeout,
-                          io_weak_ptr_factory_.GetWeakPtr()));
-
-  url_fetcher_ =
-      net::URLFetcher::Create(server_url_, net::URLFetcher::POST, this);
-  url_fetcher_->SetRequestContext(request_context_getter_);
-  std::string serialized_request;
-  request->SerializeToString(&serialized_request);
-  url_fetcher_->SetUploadData(kProtoMimeType, serialized_request);
-  url_fetcher_->Start();
-}
-
-void WebApkInstaller::OnGotWebApkDownloadUrl(const std::string& download_url,
-                                             const std::string& package_name) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::IO);
-
-  base::FilePath output_dir;
-  base::android::GetCacheDirectory(&output_dir);
-  // TODO(pkotwicz): Download WebAPKs into WebAPK-specific subdirectory
-  // directory.
-  // TODO(pkotwicz): Figure out when downloaded WebAPK should be deleted.
-
-  timer_.Start(FROM_HERE, base::TimeDelta::FromMilliseconds(kDownloadTimeoutMs),
-               base::Bind(&WebApkInstaller::OnTimeout,
-                          io_weak_ptr_factory_.GetWeakPtr()));
-
-  base::FilePath output_path = output_dir.AppendASCII(package_name);
-  downloader_.reset(new FileDownloader(
-      GURL(download_url), output_path, true, request_context_getter_,
-      base::Bind(&WebApkInstaller::OnWebApkDownloaded,
-                 io_weak_ptr_factory_.GetWeakPtr(), output_path,
-                 package_name)));
-}
-
-void WebApkInstaller::OnWebApkDownloaded(const base::FilePath& file_path,
-                                         const std::string& package_name,
-                                         FileDownloader::Result result) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::IO);
-
-  timer_.Stop();
-
-  if (result != FileDownloader::DOWNLOADED) {
-    OnFailure();
-    return;
-  }
-
-  JNIEnv* env = base::android::AttachCurrentThread();
-  base::android::ScopedJavaLocalRef<jstring> java_file_path =
-      base::android::ConvertUTF8ToJavaString(env, file_path.value());
-  base::android::ScopedJavaLocalRef<jstring> java_package_name =
-      base::android::ConvertUTF8ToJavaString(env, package_name);
-  bool success =
-      StartDownloadedWebApkInstall(env, java_file_path, java_package_name);
-  if (success)
-    OnSuccess();
-  else
-    OnFailure();
-}
-
-std::unique_ptr<webapk::CreateWebApkRequest>
-WebApkInstaller::BuildCreateWebApkRequest() {
-  std::unique_ptr<webapk::CreateWebApkRequest> request(
-      new webapk::CreateWebApkRequest);
-
-  webapk::WebApk* webapk = request->mutable_webapk();
-  webapk->set_manifest_url(shortcut_info_.manifest_url.spec());
-  webapk->set_requester_application_package(
-      base::android::BuildInfo::GetInstance()->package_name());
-  webapk->set_requester_application_version(version_info::GetVersionNumber());
-
-  webapk::WebAppManifest* web_app_manifest = webapk->mutable_manifest();
-  web_app_manifest->set_name(base::UTF16ToUTF8(shortcut_info_.name));
-  web_app_manifest->set_short_name(
-      base::UTF16ToUTF8(shortcut_info_.short_name));
-  web_app_manifest->set_start_url(shortcut_info_.url.spec());
-  // TODO(pkotwicz): Add "display mode" and "orientation" to proto.
-  web_app_manifest->set_background_color(
-      ColorToString(shortcut_info_.background_color));
-  web_app_manifest->set_theme_color(ColorToString(shortcut_info_.theme_color));
-
-  std::string* scope = web_app_manifest->add_scopes();
-  scope->assign(GetScope(shortcut_info_).spec());
-  webapk::Image* image = web_app_manifest->add_icons();
-  image->set_src(shortcut_info_.icon_url.spec());
-  // TODO(pkotwicz): Get Murmur2 hash of untransformed icon's bytes (with no
-  // encoding/decoding).
-  image->set_hash(ComputeBitmapHash(shortcut_icon_));
-  std::vector<unsigned char> png_bytes;
-  gfx::PNGCodec::EncodeBGRASkBitmap(shortcut_icon_, false, &png_bytes);
-  image->set_image_data(&png_bytes.front(), png_bytes.size());
-
-  return request;
-}
-
-void WebApkInstaller::OnTimeout() {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::IO);
-  OnFailure();
-}
-
-void WebApkInstaller::OnSuccess() {
-  finish_callback_.Run(true);
-  delete this;
-}
-
-void WebApkInstaller::OnFailure() {
-  finish_callback_.Run(false);
-  delete this;
-}
diff --git a/chrome/browser/android/webapk/webapk_installer.h b/chrome/browser/android/webapk/webapk_installer.h
deleted file mode 100644
index 35046dc..0000000
--- a/chrome/browser/android/webapk/webapk_installer.h
+++ /dev/null
@@ -1,143 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_BROWSER_ANDROID_WEBAPK_WEBAPK_INSTALLER_H_
-#define CHROME_BROWSER_ANDROID_WEBAPK_WEBAPK_INSTALLER_H_
-
-#include <jni.h>
-#include <memory>
-
-#include "base/android/scoped_java_ref.h"
-#include "base/callback.h"
-#include "base/macros.h"
-#include "base/memory/weak_ptr.h"
-#include "base/timer/timer.h"
-#include "chrome/browser/android/shortcut_info.h"
-#include "chrome/browser/net/file_downloader.h"
-#include "net/url_request/url_fetcher_delegate.h"
-#include "third_party/skia/include/core/SkBitmap.h"
-
-namespace base {
-class FilePath;
-}
-
-namespace content {
-class BrowserContext;
-}
-
-namespace net {
-class URLFetcher;
-class URLRequestContextGetter;
-}
-
-namespace webapk {
-class CreateWebApkRequest;
-}
-
-// Talks to Chrome WebAPK server and Google Play to generate a WebAPK on the
-// server, download it, and install it.
-class WebApkInstaller : public net::URLFetcherDelegate {
- public:
-  using FinishCallback = base::Callback<void(bool)>;
-
-  WebApkInstaller(const ShortcutInfo& shortcut_info,
-                  const SkBitmap& shorcut_icon);
-  ~WebApkInstaller() override;
-
-  // Register JNI methods.
-  static bool Register(JNIEnv* env);
-
-  // Talks to the Chrome WebAPK server to generate a WebAPK on the server and to
-  // Google Play to install the generated WebAPK. Calls |callback| after the
-  // request to install the WebAPK is sent to Google Play.
-  void InstallAsync(content::BrowserContext* browser_context,
-                    const FinishCallback& callback);
-
-  // Same as InstallAsync() but uses the passed in |request_context_getter|.
-  void InstallAsyncWithURLRequestContextGetter(
-      net::URLRequestContextGetter* request_context_getter,
-      const FinishCallback& callback);
-
- protected:
-  // Starts installation of the downloaded WebAPK. Returns whether the install
-  // could be started. The installation may still fail if true is returned.
-  // |file_path| is the file path that the WebAPK was downloaded to.
-  // |package_name| is the package name that the WebAPK should be installed at.
-  virtual bool StartDownloadedWebApkInstall(
-      JNIEnv* env,
-      const base::android::ScopedJavaLocalRef<jstring>& java_file_path,
-      const base::android::ScopedJavaLocalRef<jstring>& java_package_name);
-
- private:
-  // net::URLFetcherDelegate:
-  void OnURLFetchComplete(const net::URLFetcher* source) override;
-
-  // Initializes |request_context_getter_| on UI thread.
-  void InitializeRequestContextGetterOnUIThread(
-      content::BrowserContext* browser_context);
-
-  // Sends request to WebAPK server to create WebAPK. During a successful
-  // request the WebAPK server responds with the URL of the generated WebAPK.
-  void SendCreateWebApkRequest();
-
-  // Called with the URL of generated WebAPK and the package name that the
-  // WebAPK should be installed at.
-  void OnGotWebApkDownloadUrl(const std::string& download_url,
-                              const std::string& package_name);
-
-  // Called once the WebAPK has been downloaded. Installs the WebAPK if the
-  // download was successful.
-  // |file_path| is the file path that the WebAPK was downloaded to.
-  // |package_name| is the package name that the WebAPK should be installed at.
-  void OnWebApkDownloaded(const base::FilePath& file_path,
-                          const std::string& package_name,
-                          FileDownloader::Result result);
-
-  // Populates webapk::CreateWebApkRequest and returns it.
-  std::unique_ptr<webapk::CreateWebApkRequest> BuildCreateWebApkRequest();
-
-  // Called when the request to the WebAPK server times out or when the WebAPK
-  // download times out.
-  void OnTimeout();
-
-  // Called when the request to install the WebAPK is sent to Google Play.
-  void OnSuccess();
-
-  // Called if a WebAPK could not be created. WebApkInstaller only tracks the
-  // WebAPK creation and the WebAPK download. It does not track the
-  // WebAPK installation. OnFailure() is not called if the WebAPK could not be
-  // installed.
-  void OnFailure();
-
-  net::URLRequestContextGetter* request_context_getter_;
-
-  // Sends HTTP request to WebAPK server.
-  std::unique_ptr<net::URLFetcher> url_fetcher_;
-
-  // Downloads WebAPK.
-  std::unique_ptr<FileDownloader> downloader_;
-
-  // Fails WebApkInstaller if WebAPK server takes too long to respond or if the
-  // download takes too long.
-  base::OneShotTimer timer_;
-
-  // Callback to call once WebApkInstaller succeeds or fails.
-  FinishCallback finish_callback_;
-
-  // Web Manifest info.
-  const ShortcutInfo shortcut_info_;
-
-  // WebAPK app icon.
-  const SkBitmap shortcut_icon_;
-
-  // WebAPK server URL.
-  GURL server_url_;
-
-  // Used to get |weak_ptr_| on the IO thread.
-  base::WeakPtrFactory<WebApkInstaller> io_weak_ptr_factory_;
-
-  DISALLOW_COPY_AND_ASSIGN(WebApkInstaller);
-};
-
-#endif  // CHROME_BROWSER_ANDROID_WEBAPK_WEBAPK_INSTALLER_H_
diff --git a/chrome/browser/android/webapk/webapk_installer_unittest.cc b/chrome/browser/android/webapk/webapk_installer_unittest.cc
deleted file mode 100644
index 97258cb..0000000
--- a/chrome/browser/android/webapk/webapk_installer_unittest.cc
+++ /dev/null
@@ -1,255 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/browser/android/webapk/webapk_installer.h"
-
-#include <jni.h>
-#include <memory>
-#include <string>
-
-#include "base/android/scoped_java_ref.h"
-#include "base/bind.h"
-#include "base/callback_forward.h"
-#include "base/command_line.h"
-#include "base/files/file_path.h"
-#include "base/memory/ref_counted.h"
-#include "base/run_loop.h"
-#include "base/single_thread_task_runner.h"
-#include "base/threading/thread_task_runner_handle.h"
-#include "chrome/browser/android/shortcut_info.h"
-#include "chrome/browser/android/webapk/webapk.pb.h"
-#include "chrome/common/chrome_switches.h"
-#include "content/public/browser/browser_thread.h"
-#include "content/public/test/test_browser_thread_bundle.h"
-#include "net/test/embedded_test_server/embedded_test_server.h"
-#include "net/test/embedded_test_server/http_request.h"
-#include "net/test/embedded_test_server/http_response.h"
-#include "net/url_request/url_request_test_util.h"
-#include "testing/gtest/include/gtest/gtest.h"
-#include "third_party/skia/include/core/SkBitmap.h"
-#include "url/gurl.h"
-
-namespace {
-
-const base::FilePath::CharType kTestDataDir[] =
-    FILE_PATH_LITERAL("chrome/test/data");
-
-// URL of mock WebAPK server.
-const std::string kServerUrl = "/webapkserver";
-
-// URL of file to download from the WebAPK server. We use a random file in the
-// test data directory.
-const std::string kDownloadUrl = "/simple.html";
-
-// The package name of the downloaded WebAPK.
-const std::string kDownloadedWebApkPackageName = "party.unicode";
-
-// WebApkInstaller subclass where
-// WebApkInstaller::StartDownloadedWebApkInstall() is stubbed out.
-class TestWebApkInstaller : public WebApkInstaller {
- public:
-  TestWebApkInstaller(const ShortcutInfo& shortcut_info,
-                      const SkBitmap& shortcut_icon)
-      : WebApkInstaller(shortcut_info, shortcut_icon) {}
-
-  bool StartDownloadedWebApkInstall(
-      JNIEnv* env,
-      const base::android::ScopedJavaLocalRef<jstring>& file_path,
-      const base::android::ScopedJavaLocalRef<jstring>& package_name) override {
-    return true;
-  }
-
- private:
-  DISALLOW_COPY_AND_ASSIGN(TestWebApkInstaller);
-};
-
-// Runs the WebApkInstaller installation process and blocks till done.
-class WebApkInstallerRunner {
- public:
-  WebApkInstallerRunner()
-      : url_request_context_getter_(new net::TestURLRequestContextGetter(
-            base::ThreadTaskRunnerHandle::Get())) {}
-  ~WebApkInstallerRunner() {}
-
-  void Run() {
-    ShortcutInfo info(GURL::EmptyGURL());
-
-    // WebApkInstaller owns itself.
-    WebApkInstaller* installer = new TestWebApkInstaller(info, SkBitmap());
-
-    installer->InstallAsyncWithURLRequestContextGetter(
-        url_request_context_getter_.get(),
-        base::Bind(&WebApkInstallerRunner::OnCompleted,
-                   base::Unretained(this)));
-
-    base::RunLoop run_loop;
-    on_completed_callback_ = run_loop.QuitClosure();
-    run_loop.Run();
-  }
-
-  bool success() { return success_; }
-
- private:
-  void OnCompleted(bool success) {
-    success_ = success;
-    on_completed_callback_.Run();
-  }
-
-  scoped_refptr<net::TestURLRequestContextGetter>
-      url_request_context_getter_;
-
-  // Called after the installation process has succeeded or failed.
-  base::Closure on_completed_callback_;
-
-  // Whether the installation process succeeded.
-  bool success_;
-
-  DISALLOW_COPY_AND_ASSIGN(WebApkInstallerRunner);
-};
-
-// Builds a webapk::CreateWebApkResponse with |download_url| as the WebAPK
-// download URL.
-std::unique_ptr<net::test_server::HttpResponse> BuildValidCreateWebApkResponse(
-    const GURL& download_url) {
-  std::unique_ptr<webapk::CreateWebApkResponse> response_proto(
-      new webapk::CreateWebApkResponse);
-  response_proto->set_webapk_package_name(kDownloadedWebApkPackageName);
-  response_proto->set_signed_download_url(download_url.spec());
-  std::string response_content;
-  response_proto->SerializeToString(&response_content);
-
-  std::unique_ptr<net::test_server::BasicHttpResponse> response(
-      new net::test_server::BasicHttpResponse());
-  response->set_code(net::HTTP_OK);
-  response->set_content(response_content);
-  return std::move(response);
-}
-
-}  // anonymous namespace
-
-class WebApkInstallerTest : public ::testing::Test {
- public:
-  typedef base::Callback<std::unique_ptr<net::test_server::HttpResponse>(void)>
-      CreateWebApkResponseBuilder;
-
-  WebApkInstallerTest()
-      : thread_bundle_(content::TestBrowserThreadBundle::IO_MAINLOOP) {}
-  ~WebApkInstallerTest() override {}
-
-  void SetUp() override {
-    test_server_.AddDefaultHandlers(base::FilePath(kTestDataDir));
-    test_server_.RegisterRequestHandler(
-        base::Bind(&WebApkInstallerTest::HandleCreateWebApkRequest,
-                   base::Unretained(this)));
-    ASSERT_TRUE(test_server_.Start());
-
-    SetDefaults();
-  }
-
-  // Sets the URL to send the webapk::CreateWebApkRequest to. WebApkInstaller
-  // should fail if the URL is not |kServerUrl|.
-  void SetWebApkServerUrl(const GURL& server_url) {
-    base::CommandLine::ForCurrentProcess()->AppendSwitchASCII(
-        switches::kWebApkServerUrl, server_url.spec());
-  }
-
-  // Sets the function that should be used to build the response to the
-  // webapk::CreateWebApkRequest.
-  void SetCreateWebApkResponseBuilder(
-      const CreateWebApkResponseBuilder& builder) {
-    create_webapk_response_builder_ = builder;
-  }
-
-  net::test_server::EmbeddedTestServer* test_server() { return &test_server_; }
-
- private:
-  // Sets default configuration for running WebApkInstaller.
-  void SetDefaults() {
-    GURL server_url = test_server_.GetURL(kServerUrl);
-    SetWebApkServerUrl(server_url);
-    GURL download_url = test_server_.GetURL(kDownloadUrl);
-    SetCreateWebApkResponseBuilder(
-        base::Bind(&BuildValidCreateWebApkResponse, download_url));
-  }
-
-  std::unique_ptr<net::test_server::HttpResponse> HandleCreateWebApkRequest(
-      const net::test_server::HttpRequest& request) {
-    return (request.relative_url == kServerUrl)
-               ? create_webapk_response_builder_.Run()
-               : std::unique_ptr<net::test_server::HttpResponse>();
-  }
-
-  content::TestBrowserThreadBundle thread_bundle_;
-  net::EmbeddedTestServer test_server_;
-
-  // Builds response to the webapk::CreateWebApkRequest.
-  CreateWebApkResponseBuilder create_webapk_response_builder_;
-
-  DISALLOW_COPY_AND_ASSIGN(WebApkInstallerTest);
-};
-
-// Test installation succeeding.
-TEST_F(WebApkInstallerTest, Success) {
-  WebApkInstallerRunner runner;
-  runner.Run();
-  EXPECT_TRUE(runner.success());
-}
-
-// Test that installation fails if the CreateWebApkRequest times out.
-TEST_F(WebApkInstallerTest, CreateWebApkRequestTimesOut) {
-  GURL server_url = test_server()->GetURL("/slow?1000");
-  SetWebApkServerUrl(server_url);
-
-  WebApkInstallerRunner runner;
-  runner.Run();
-  EXPECT_FALSE(runner.success());
-}
-
-// Test that installation fails if the WebAPK download times out.
-TEST_F(WebApkInstallerTest, WebApkDownloadTimesOut) {
-  GURL download_url = test_server()->GetURL("/slow?1000");
-  SetCreateWebApkResponseBuilder(
-      base::Bind(&BuildValidCreateWebApkResponse, download_url));
-
-  WebApkInstallerRunner runner;
-  runner.Run();
-  EXPECT_FALSE(runner.success());
-}
-
-// Test that installation fails if the WebAPK download fails.
-TEST_F(WebApkInstallerTest, WebApkDownloadFails) {
-  GURL download_url = test_server()->GetURL("/nocontent");
-  SetCreateWebApkResponseBuilder(
-      base::Bind(&BuildValidCreateWebApkResponse, download_url));
-
-  WebApkInstallerRunner runner;
-  runner.Run();
-  EXPECT_FALSE(runner.success());
-}
-
-namespace {
-
-// Returns an HttpResponse which cannot be parsed as a
-// webapk::CreateWebApkResponse.
-std::unique_ptr<net::test_server::HttpResponse>
-BuildUnparsableCreateWebApkResponse() {
-  std::unique_ptr<net::test_server::BasicHttpResponse> response(
-      new net::test_server::BasicHttpResponse());
-  response->set_code(net::HTTP_OK);
-  response->set_content("😀");
-  return std::move(response);
-}
-
-}  // anonymous namespace
-
-// Test that an HTTP response which cannot be parsed as
-// a webapk::CreateWebApkResponse is handled properly.
-TEST_F(WebApkInstallerTest, UnparsableCreateWebApkResponse) {
-  SetCreateWebApkResponseBuilder(
-      base::Bind(&BuildUnparsableCreateWebApkResponse));
-
-  WebApkInstallerRunner runner;
-  runner.Run();
-  EXPECT_FALSE(runner.success());
-}
diff --git a/chrome/browser/android/webapps/add_to_homescreen_dialog_helper.cc b/chrome/browser/android/webapps/add_to_homescreen_dialog_helper.cc
index a1e7c81..52e4549 100644
--- a/chrome/browser/android/webapps/add_to_homescreen_dialog_helper.cc
+++ b/chrome/browser/android/webapps/add_to_homescreen_dialog_helper.cc
@@ -119,17 +119,13 @@ void AddToHomescreenDialogHelper::AddShortcut(const ShortcutInfo& info,
     return;
   add_shortcut_pending_ = false;
 
-  content::WebContents* web_contents = data_fetcher_->web_contents();
-  if (!web_contents)
-    return;
-
   RecordAddToHomescreen();
 
   const std::string& uid = base::GenerateGUID();
   content::BrowserThread::PostTask(
       content::BrowserThread::IO, FROM_HERE,
-      base::Bind(&ShortcutHelper::AddToLauncherInBackgroundWithSkBitmap,
-                 web_contents->GetBrowserContext(), info, uid, icon,
+      base::Bind(&ShortcutHelper::AddToLauncherInBackgroundWithSkBitmap, info,
+                 uid, icon,
                  data_fetcher_->FetchSplashScreenImageCallback(uid)));
 }
 
diff --git a/chrome/browser/bookmarks/bookmark_model_factory.cc b/chrome/browser/bookmarks/bookmark_model_factory.cc
index 89f159f..8a6edc1 100644
--- a/chrome/browser/bookmarks/bookmark_model_factory.cc
+++ b/chrome/browser/bookmarks/bookmark_model_factory.cc
@@ -29,20 +29,6 @@
 using bookmarks::BookmarkModel;
 
 // static
-BookmarkModel* BookmarkModelFactory::GetForBrowserContext(
-    content::BrowserContext* browser_context) {
-  return static_cast<BookmarkModel*>(
-      GetInstance()->GetServiceForBrowserContext(browser_context, true));
-}
-
-// static
-BookmarkModel* BookmarkModelFactory::GetForBrowserContextIfExists(
-    content::BrowserContext* browser_context) {
-  return static_cast<BookmarkModel*>(
-      GetInstance()->GetServiceForBrowserContext(browser_context, false));
-}
-
-// static
 BookmarkModel* BookmarkModelFactory::GetForProfile(Profile* profile) {
   return static_cast<BookmarkModel*>(
       GetInstance()->GetServiceForBrowserContext(profile, true));
diff --git a/chrome/browser/bookmarks/bookmark_model_factory.h b/chrome/browser/bookmarks/bookmark_model_factory.h
index bb17bb6..b4a67bf 100644
--- a/chrome/browser/bookmarks/bookmark_model_factory.h
+++ b/chrome/browser/bookmarks/bookmark_model_factory.h
@@ -21,14 +21,6 @@ class BookmarkModel;
 // Singleton that owns all BookmarkModels and associates them with Profiles.
 class BookmarkModelFactory : public BrowserContextKeyedServiceFactory {
  public:
-  static bookmarks::BookmarkModel* GetForBrowserContext(
-      content::BrowserContext* browser_context);
-
-  static bookmarks::BookmarkModel* GetForBrowserContextIfExists(
-      content::BrowserContext* browser_context);
-
-  // TODO(pke): Remove GetForProfile and GetForProfileIfExists and use
-  // GetForBrowserContext/GetForBrowserContextIfExists everywhere.
   static bookmarks::BookmarkModel* GetForProfile(Profile* profile);
 
   static bookmarks::BookmarkModel* GetForProfileIfExists(Profile* profile);
diff --git a/chrome/browser/browser_process.h b/chrome/browser/browser_process.h
index 28a55ae..ee4b615 100644
--- a/chrome/browser/browser_process.h
+++ b/chrome/browser/browser_process.h
@@ -24,8 +24,8 @@ class BackgroundModeManager;
 class CRLSetFetcher;
 class DownloadRequestLimiter;
 class DownloadStatusUpdater;
+class GLStringManager;
 class GpuModeManager;
-class GpuProfileCache;
 class IconManager;
 class IntranetRedirectDetector;
 class IOThread;
@@ -180,9 +180,9 @@ class BrowserProcess {
 
   virtual IconManager* icon_manager() = 0;
 
-  virtual GpuModeManager* gpu_mode_manager() = 0;
+  virtual GLStringManager* gl_string_manager() = 0;
 
-  virtual GpuProfileCache* gpu_profile_cache() = 0;
+  virtual GpuModeManager* gpu_mode_manager() = 0;
 
   // Create and bind remote debugging server to a given |ip| and |port|.
   // Passing empty |ip| results in binding to localhost:
diff --git a/chrome/browser/browser_process_impl.cc b/chrome/browser/browser_process_impl.cc
index 1672f19..285c698 100644
--- a/chrome/browser/browser_process_impl.cc
+++ b/chrome/browser/browser_process_impl.cc
@@ -45,8 +45,8 @@
 #include "chrome/browser/devtools/remote_debugging_server.h"
 #include "chrome/browser/download/download_request_limiter.h"
 #include "chrome/browser/download/download_status_updater.h"
+#include "chrome/browser/gpu/gl_string_manager.h"
 #include "chrome/browser/gpu/gpu_mode_manager.h"
-#include "chrome/browser/gpu/gpu_profile_cache.h"
 #include "chrome/browser/icon_manager.h"
 #include "chrome/browser/intranet_redirect_detector.h"
 #include "chrome/browser/io_thread.h"
@@ -621,11 +621,11 @@ IconManager* BrowserProcessImpl::icon_manager() {
   return icon_manager_.get();
 }
 
-GpuProfileCache* BrowserProcessImpl::gpu_profile_cache() {
+GLStringManager* BrowserProcessImpl::gl_string_manager() {
   DCHECK(CalledOnValidThread());
-  if (!gpu_profile_cache_.get())
-    gpu_profile_cache_.reset(GpuProfileCache::Create());
-  return gpu_profile_cache_.get();
+  if (!gl_string_manager_.get())
+    gl_string_manager_.reset(new GLStringManager());
+  return gl_string_manager_.get();
 }
 
 GpuModeManager* BrowserProcessImpl::gpu_mode_manager() {
diff --git a/chrome/browser/browser_process_impl.h b/chrome/browser/browser_process_impl.h
index 885f048..3004564 100644
--- a/chrome/browser/browser_process_impl.h
+++ b/chrome/browser/browser_process_impl.h
@@ -107,8 +107,8 @@ class BrowserProcessImpl : public BrowserProcess,
   policy::BrowserPolicyConnector* browser_policy_connector() override;
   policy::PolicyService* policy_service() override;
   IconManager* icon_manager() override;
+  GLStringManager* gl_string_manager() override;
   GpuModeManager* gpu_mode_manager() override;
-  GpuProfileCache* gpu_profile_cache() override;
   void CreateDevToolsHttpProtocolHandler(const std::string& ip,
                                          uint16_t port) override;
   void CreateDevToolsAutoOpener() override;
@@ -211,7 +211,7 @@ class BrowserProcessImpl : public BrowserProcess,
   bool created_icon_manager_;
   std::unique_ptr<IconManager> icon_manager_;
 
-  std::unique_ptr<GpuProfileCache> gpu_profile_cache_;
+  std::unique_ptr<GLStringManager> gl_string_manager_;
 
   std::unique_ptr<GpuModeManager> gpu_mode_manager_;
 
diff --git a/chrome/browser/browsing_data/browsing_data_remover.cc b/chrome/browser/browsing_data/browsing_data_remover.cc
index 4b43252..dd161fd 100644
--- a/chrome/browser/browsing_data/browsing_data_remover.cc
+++ b/chrome/browser/browsing_data/browsing_data_remover.cc
@@ -299,20 +299,12 @@ BrowsingDataRemover::BrowsingDataRemover(
 }
 
 BrowsingDataRemover::~BrowsingDataRemover() {
-  if (!task_queue_.empty()) {
-    VLOG(1) << "BrowsingDataRemover shuts down with " << task_queue_.size()
-            << " pending tasks";
-  }
-
-  // If we are still removing data, notify observers that their task has been
-  // (albeit unsucessfuly) processed, so they can unregister themselves.
+  // If we are still removing data, notify observers so they can remove
+  // themselves from the observer list.
   // TODO(bauerb): If it becomes a problem that browsing data might not actually
   // be fully cleared when an observer is notified, add a success flag.
-  while (!task_queue_.empty()) {
-    if (observer_list_.HasObserver(task_queue_.front().observer))
-      task_queue_.front().observer->OnBrowsingDataRemoverDone();
-    task_queue_.pop();
-  }
+  if (is_removing_)
+    Notify();
 }
 
 void BrowsingDataRemover::Shutdown() {
@@ -330,84 +322,20 @@ void BrowsingDataRemover::SetRemoving(bool is_removing) {
 void BrowsingDataRemover::Remove(const TimeRange& time_range,
                                  int remove_mask,
                                  int origin_type_mask) {
-  RemoveInternal(time_range, remove_mask, origin_type_mask,
-                 std::unique_ptr<RegistrableDomainFilterBuilder>(), nullptr);
-}
-
-void BrowsingDataRemover::RemoveAndReply(
-    const TimeRange& time_range,
-    int remove_mask,
-    int origin_type_mask,
-    Observer* observer) {
-  DCHECK(observer);
-  RemoveInternal(time_range, remove_mask, origin_type_mask,
-                 std::unique_ptr<RegistrableDomainFilterBuilder>(), observer);
+  // Any instance of BrowsingDataFilterBuilder that |IsEmptyBlacklist()|
+  // is OK to pass here.
+  RegistrableDomainFilterBuilder builder(
+      RegistrableDomainFilterBuilder::BLACKLIST);
+  DCHECK(builder.IsEmptyBlacklist());
+  RemoveImpl(time_range, remove_mask, builder, origin_type_mask);
 }
 
 void BrowsingDataRemover::RemoveWithFilter(
     const TimeRange& time_range,
     int remove_mask,
     int origin_type_mask,
-    std::unique_ptr<BrowsingDataFilterBuilder> filter_builder) {
-  DCHECK(filter_builder);
-  RemoveInternal(time_range, remove_mask, origin_type_mask,
-                 std::move(filter_builder), nullptr);
-}
-
-void BrowsingDataRemover::RemoveWithFilterAndReply(
-    const TimeRange& time_range,
-    int remove_mask,
-    int origin_type_mask,
-    std::unique_ptr<BrowsingDataFilterBuilder> filter_builder,
-    Observer* observer) {
-  DCHECK(filter_builder);
-  DCHECK(observer);
-  RemoveInternal(time_range, remove_mask, origin_type_mask,
-                 std::move(filter_builder), observer);
-}
-
-void BrowsingDataRemover::RemoveInternal(
-    const TimeRange& time_range,
-    int remove_mask,
-    int origin_type_mask,
-    std::unique_ptr<BrowsingDataFilterBuilder> filter_builder,
-    Observer* observer) {
-  DCHECK(!observer || observer_list_.HasObserver(observer))
-      << "Every observer must register itself (by calling AddObserver()) "
-      << "before observing a removal task.";
-
-  // Remove() and RemoveAndReply() pass a null pointer to indicate no filter.
-  // No filter is equivalent to one that |IsEmptyBlacklist()|.
-  if (!filter_builder) {
-    filter_builder = base::WrapUnique(new RegistrableDomainFilterBuilder(
-        RegistrableDomainFilterBuilder::BLACKLIST));
-    DCHECK(filter_builder->IsEmptyBlacklist());
-  }
-
-  task_queue_.emplace(
-      time_range,
-      remove_mask,
-      origin_type_mask,
-      std::move(filter_builder),
-      observer);
-
-  // If this is the only scheduled task, execute it immediately. Otherwise,
-  // it will be automatically executed when all tasks scheduled before it
-  // finish.
-  if (task_queue_.size() == 1) {
-    SetRemoving(true);
-    RunNextTask();
-  }
-}
-
-void BrowsingDataRemover::RunNextTask() {
-  DCHECK(!task_queue_.empty());
-  const RemovalTask& removal_task = task_queue_.front();
-
-  RemoveImpl(removal_task.time_range,
-             removal_task.remove_mask,
-             *removal_task.filter_builder,
-             removal_task.origin_type_mask);
+    const BrowsingDataFilterBuilder& filter_builder) {
+  RemoveImpl(time_range, remove_mask, filter_builder, origin_type_mask);
 }
 
 void BrowsingDataRemover::RemoveImpl(
@@ -422,6 +350,7 @@ void BrowsingDataRemover::RemoveImpl(
   // delete_end, even though they should've used base::Time::Max().
   DCHECK_NE(base::Time(), time_range.end);
 
+  SetRemoving(true);
   delete_begin_ = time_range.begin;
   delete_end_ = time_range.end;
   remove_mask_ = remove_mask;
@@ -1121,19 +1050,6 @@ int BrowsingDataRemover::GetLastUsedOriginTypeMask() {
   return origin_type_mask_;
 }
 
-BrowsingDataRemover::RemovalTask::RemovalTask(
-    const TimeRange& time_range,
-    int remove_mask,
-    int origin_type_mask,
-    std::unique_ptr<BrowsingDataFilterBuilder> filter_builder,
-    Observer* observer)
-    : time_range(time_range),
-      remove_mask(remove_mask),
-      origin_type_mask(origin_type_mask),
-      filter_builder(std::move(filter_builder)),
-      observer(observer) {}
-
-BrowsingDataRemover::RemovalTask::~RemovalTask() {}
 
 void BrowsingDataRemover::ClearSettingsForOneTypeWithPredicate(
     HostContentSettingsMap* content_settings_map,
@@ -1193,40 +1109,8 @@ void BrowsingDataRemover::OnKeywordsLoaded() {
 }
 
 void BrowsingDataRemover::Notify() {
-  // Some tests call |RemoveImpl| directly, without using the task scheduler.
-  // TODO(msramek): Improve those tests so we don't have to do this. Tests
-  // relying on |RemoveImpl| do so because they need to pass in
-  // BrowsingDataFilterBuilder while still keeping ownership of it. Making
-  // BrowsingDataFilterBuilder copyable would solve this.
-  if (!is_removing_) {
-    DCHECK(task_queue_.empty());
-    return;
-  }
-
-  // Inform the observer of the current task unless it has unregistered
-  // itself in the meantime.
-  DCHECK(!task_queue_.empty());
-
-  if (task_queue_.front().observer != nullptr &&
-      observer_list_.HasObserver(task_queue_.front().observer)) {
-    task_queue_.front().observer->OnBrowsingDataRemoverDone();
-  }
-
-  task_queue_.pop();
-
-  if (task_queue_.empty()) {
-    // All removal tasks have finished. Inform the observers that we're idle.
-    SetRemoving(false);
-    return;
-  }
-
-  // Yield to the UI thread before executing the next removal task.
-  // TODO(msramek): Consider also adding a backoff if too many tasks
-  // are scheduled.
-  BrowserThread::PostTask(
-      BrowserThread::UI, FROM_HERE,
-      base::Bind(&BrowsingDataRemover::RunNextTask,
-                 weak_ptr_factory_.GetWeakPtr()));
+  SetRemoving(false);
+  FOR_EACH_OBSERVER(Observer, observer_list_, OnBrowsingDataRemoverDone());
 }
 
 void BrowsingDataRemover::NotifyIfDone() {
diff --git a/chrome/browser/browsing_data/browsing_data_remover.h b/chrome/browser/browsing_data/browsing_data_remover.h
index 5564dcc..7d18345 100644
--- a/chrome/browser/browsing_data/browsing_data_remover.h
+++ b/chrome/browser/browsing_data/browsing_data_remover.h
@@ -7,7 +7,6 @@
 
 #include <stdint.h>
 
-#include <queue>
 #include <set>
 
 #include "base/callback_forward.h"
@@ -64,53 +63,8 @@ class URLRequestContextGetter;
 class WebappRegistry;
 #endif
 
-////////////////////////////////////////////////////////////////////////////////
 // BrowsingDataRemover is responsible for removing data related to browsing:
 // visits in url database, downloads, cookies ...
-//
-//  USAGE:
-//
-//  0. Instantiation.
-//
-//       BrowsingDataRemover remover =
-//           BrowsingDataRemoverFactory::GetForBrowserContext(profile);
-//
-//  1. No observer.
-//
-//       remover->Remove(Unbounded(), REMOVE_COOKIES, ALL);
-//
-//  2. Using an observer to report when one's own removal task is finished.
-//
-//       class CookiesDeleter : public BrowsingDataRemover::Observer {
-//         CookiesDeleter() { remover->AddObserver(this); }
-//         ~CookiesDeleter() { remover->RemoveObserver(this); }
-//
-//         void DeleteCookies() {
-//           remover->RemoveAndReply(Unbounded(), REMOVE_COOKIES, ALL, this);
-//         }
-//
-//         void OnBrowsingDataRemoverDone() {
-//           LOG(INFO) << "Cookies were deleted.";
-//         }
-//       }
-//
-//  3. Using an observer to report when any removal task started or all removal
-//     tasks finished (i.e. when BrowsingDataRemover changes state from idle
-//     to busy and vice versa).
-//
-//       class BrowsingDataRemoverStatusObsever {
-//         BrowsingDataRemoverStatusObserver() { remover->AddObserver(this); }
-//         ~BrowsingDataRemoverStatusObserver() {
-//           remover->RemoveObserver(this);
-//         }
-//
-//         void OnBrowsingDataRemoving(bool removing) {
-//           LOG(INFO) << "Remover is now " << (removing ? "busy" : "idle");
-//         }
-//       }
-//
-////////////////////////////////////////////////////////////////////////////////
-
 class BrowsingDataRemover : public KeyedService
 #if defined(ENABLE_PLUGINS)
                             , public PepperFlashSettingsManager::Client
@@ -199,10 +153,6 @@ class BrowsingDataRemover : public KeyedService
   };
 
   // Observer is notified when the removal is active and when it's done.
-  // TODO(msramek): The semantics of the two methods are slightly different;
-  // one is called for every observer at the same time, while the other only
-  // for one observer at a time. Split the interface or deprecate
-  // OnBrowsingDataRemoving().
   class Observer {
    public:
     // NOTE: DEPRECATED; talk to dbeam/msramek before using this.
@@ -212,8 +162,8 @@ class BrowsingDataRemover : public KeyedService
     // from the done message.
     virtual void OnBrowsingDataRemoving(bool is_removing) {}
 
-    // Called when a removal task is finished. Note that every removal task can
-    // only have one observer attached to it, and only that one is called.
+    // Done means keywords have been deleted, cache cleared and all other
+    // removal tasks are scheduled.
     virtual void OnBrowsingDataRemoverDone() {}
 
    protected:
@@ -252,38 +202,22 @@ class BrowsingDataRemover : public KeyedService
     completion_inhibitor_ = inhibitor;
   }
 
-  // Removes browsing data within the given |time_range|, with datatypes being
-  // specified by |remove_mask| and origin types by |origin_type_mask|.
+  // Removes the specified items related to browsing for all origins that match
+  // the provided |origin_type_mask| (see BrowsingDataHelper::OriginTypeMask).
   void Remove(const TimeRange& time_range,
               int remove_mask,
               int origin_type_mask);
 
-  // A version of the above that in addition informs the |observer| when the
-  // removal task is finished.
-  void RemoveAndReply(const TimeRange& time_range,
-                      int remove_mask,
-                      int origin_type_mask,
-                      Observer* observer);
-
-  // Like Remove(), but in case of URL-keyed only removes data whose URL match
-  // |filter_builder| (e.g. are on certain origin or domain).
+  // Removes the specified items related to browsing for all origins that match
+  // the provided |origin_type_mask| (see BrowsingDataHelper::OriginTypeMask).
+  // The |origin_filter| is used as a final filter for clearing operations.
   // TODO(dmurph): Support all backends with filter (crbug.com/113621).
   // DO NOT USE THIS METHOD UNLESS CALLER KNOWS WHAT THEY'RE DOING. NOT ALL
   // BACKENDS ARE SUPPORTED YET, AND MORE DATA THAN EXPECTED COULD BE DELETED.
-  void RemoveWithFilter(
-      const TimeRange& time_range,
-      int remove_mask,
-      int origin_type_mask,
-      std::unique_ptr<BrowsingDataFilterBuilder> filter_builder);
-
-  // A version of the above that in addition informs the |observer| when the
-  // removal task is finished.
-  void RemoveWithFilterAndReply(
-      const TimeRange& time_range,
-      int remove_mask,
-      int origin_type_mask,
-      std::unique_ptr<BrowsingDataFilterBuilder> filter_builder,
-      Observer* observer);
+  virtual void RemoveWithFilter(const TimeRange& time_range,
+                                int remove_mask,
+                                int origin_type_mask,
+                                const BrowsingDataFilterBuilder& origin_filter);
 
   void AddObserver(Observer* observer);
   void RemoveObserver(Observer* observer);
@@ -312,22 +246,12 @@ class BrowsingDataRemover : public KeyedService
   BrowsingDataRemover(content::BrowserContext* browser_context);
   ~BrowsingDataRemover() override;
 
-  // A common reduction of all public Remove[WithFilter][AndReply] methods.
-  virtual void RemoveInternal(
-      const TimeRange& time_range,
-      int remove_mask,
-      int origin_type_mask,
-      std::unique_ptr<BrowsingDataFilterBuilder> filter_builder,
-      Observer* observer);
-
  private:
   // The clear API needs to be able to toggle removing_ in order to test that
   // only one BrowsingDataRemover instance can be called at a time.
   FRIEND_TEST_ALL_PREFIXES(ExtensionBrowsingDataTest, OneAtATime);
   // Testing our static method, ClearSettingsForOneTypeWithPredicate.
   FRIEND_TEST_ALL_PREFIXES(BrowsingDataRemoverTest, ClearWithPredicate);
-  // Testing the private RemovalTask.
-  FRIEND_TEST_ALL_PREFIXES(BrowsingDataRemoverTest, MultipleTasks);
 
   // The BrowsingDataRemover tests need to be able to access the implementation
   // of Remove(), as it exposes details that aren't yet available in the public
@@ -339,23 +263,6 @@ class BrowsingDataRemover : public KeyedService
 
   friend class BrowsingDataRemoverFactory;
 
-  // Represents a single removal task. Contains all parameters needed to execute
-  // it and a pointer to the observer that added it.
-  struct RemovalTask {
-    RemovalTask(const TimeRange& time_range,
-                int remove_mask,
-                int origin_type_mask,
-                std::unique_ptr<BrowsingDataFilterBuilder> filter_builder,
-                Observer* observer);
-    ~RemovalTask();
-
-    TimeRange time_range;
-    int remove_mask;
-    int origin_type_mask;
-    std::unique_ptr<BrowsingDataFilterBuilder> filter_builder;
-    Observer* observer;
-  };
-
   // Clears all host-specific settings for one content type that satisfy the
   // given predicate.
   //
@@ -391,10 +298,6 @@ class BrowsingDataRemover : public KeyedService
                            bool result);
 #endif
 
-  // Executes the next removal task. Called after the previous task was finished
-  // or directly from Remove() if the task queue was empty.
-  void RunNextTask();
-
   // Removes the specified items related to browsing for a specific host. If the
   // provided |remove_url| is empty, data is removed for all origins; otherwise,
   // it is restricted by the origin filter origin (where implemented yet). The
@@ -405,7 +308,7 @@ class BrowsingDataRemover : public KeyedService
   // TODO(crbug.com/589586): Support all backends w/ origin filter.
   void RemoveImpl(const TimeRange& time_range,
                   int remove_mask,
-                  const BrowsingDataFilterBuilder& filter_builder,
+                  const BrowsingDataFilterBuilder& origin_filter,
                   int origin_type_mask);
 
   // Notifies observers and transitions to the idle state.
@@ -508,9 +411,6 @@ class BrowsingDataRemover : public KeyedService
   // True if Remove has been invoked.
   bool is_removing_;
 
-  // Removal tasks to be processed.
-  std::queue<RemovalTask> task_queue_;
-
   // If non-NULL, the |completion_inhibitor_| is notified each time an instance
   // is about to complete a browsing data removal process, and has the ability
   // to artificially delay completion. Used for testing.
@@ -566,7 +466,6 @@ class BrowsingDataRemover : public KeyedService
   // From which types of origins should we remove data?
   int origin_type_mask_ = 0;
 
-  // Observers of the global state and individual tasks.
   base::ObserverList<Observer, true> observer_list_;
 
   // Used if we need to clear history.
diff --git a/chrome/browser/browsing_data/browsing_data_remover_browsertest.cc b/chrome/browser/browsing_data/browsing_data_remover_browsertest.cc
index 6536de9..fa8c8b9 100644
--- a/chrome/browser/browsing_data/browsing_data_remover_browsertest.cc
+++ b/chrome/browser/browsing_data/browsing_data_remover_browsertest.cc
@@ -115,22 +115,20 @@ class BrowsingDataRemoverBrowserTest : public InProcessBrowserTest {
     BrowsingDataRemover* remover =
         BrowsingDataRemoverFactory::GetForBrowserContext(browser()->profile());
     BrowsingDataRemoverCompletionObserver completion_observer(remover);
-    remover->RemoveAndReply(
-        BrowsingDataRemover::Period(browsing_data::LAST_HOUR), remove_mask,
-        BrowsingDataHelper::UNPROTECTED_WEB, &completion_observer);
+    remover->Remove(BrowsingDataRemover::Period(browsing_data::LAST_HOUR),
+                    remove_mask, BrowsingDataHelper::UNPROTECTED_WEB);
     completion_observer.BlockUntilCompletion();
   }
 
   void RemoveWithFilterAndWait(
       int remove_mask,
-      std::unique_ptr<BrowsingDataFilterBuilder> filter_builder) {
+      const BrowsingDataFilterBuilder& filter_builder) {
     BrowsingDataRemover* remover =
         BrowsingDataRemoverFactory::GetForBrowserContext(browser()->profile());
     BrowsingDataRemoverCompletionObserver completion_observer(remover);
-    remover->RemoveWithFilterAndReply(
+    remover->RemoveWithFilter(
         BrowsingDataRemover::Period(browsing_data::LAST_HOUR), remove_mask,
-        BrowsingDataHelper::UNPROTECTED_WEB, std::move(filter_builder),
-        &completion_observer);
+        BrowsingDataHelper::UNPROTECTED_WEB, filter_builder);
     completion_observer.BlockUntilCompletion();
   }
 
@@ -248,21 +246,16 @@ IN_PROC_BROWSER_TEST_F(BrowsingDataRemoverBrowserTest, Cache) {
 
   // Partially delete cache data. Delete data for localhost, which is the origin
   // of |url1|, but not for |kExampleHost|, which is the origin of |url2|.
-  std::unique_ptr<OriginFilterBuilder> filter_builder(
-      new OriginFilterBuilder(OriginFilterBuilder::WHITELIST));
-  filter_builder->AddOrigin(url::Origin(url1));
-  RemoveWithFilterAndWait(BrowsingDataRemover::REMOVE_CACHE,
-                          std::move(filter_builder));
+  OriginFilterBuilder filter_builder(OriginFilterBuilder::WHITELIST);
+  filter_builder.AddOrigin(url::Origin(url1));
+  RemoveWithFilterAndWait(BrowsingDataRemover::REMOVE_CACHE, filter_builder);
 
   // After the partial deletion, the cache should be smaller but still nonempty.
   browsing_data::BrowsingDataCounter::ResultInt new_size = GetCacheSize();
   EXPECT_LT(new_size, original_size);
 
   // Another partial deletion with the same filter should have no effect.
-  filter_builder.reset(new OriginFilterBuilder(OriginFilterBuilder::WHITELIST));
-  filter_builder->AddOrigin(url::Origin(url1));
-  RemoveWithFilterAndWait(BrowsingDataRemover::REMOVE_CACHE,
-                          std::move(filter_builder));
+  RemoveWithFilterAndWait(BrowsingDataRemover::REMOVE_CACHE, filter_builder);
   EXPECT_EQ(new_size, GetCacheSize());
 
   // Delete the remaining data.
diff --git a/chrome/browser/browsing_data/browsing_data_remover_unittest.cc b/chrome/browser/browsing_data/browsing_data_remover_unittest.cc
index 774f5e3..fadac64 100644
--- a/chrome/browser/browsing_data/browsing_data_remover_unittest.cc
+++ b/chrome/browser/browsing_data/browsing_data_remover_unittest.cc
@@ -7,7 +7,6 @@
 #include <stddef.h>
 #include <stdint.h>
 
-#include <list>
 #include <memory>
 #include <set>
 #include <string>
@@ -1069,8 +1068,8 @@ class BrowsingDataRemoverTest : public testing::Test {
       origin_type_mask |= BrowsingDataHelper::PROTECTED_WEB;
 
     BrowsingDataRemoverCompletionObserver completion_observer(remover);
-    remover->RemoveAndReply(BrowsingDataRemover::Period(period), remove_mask,
-                            origin_type_mask, &completion_observer);
+    remover->Remove(BrowsingDataRemover::Period(period), remove_mask,
+                    origin_type_mask);
     completion_observer.BlockUntilCompletion();
 
     // Save so we can verify later.
@@ -1087,11 +1086,10 @@ class BrowsingDataRemoverTest : public testing::Test {
     TestStoragePartition storage_partition;
     remover->OverrideStoragePartitionForTesting(&storage_partition);
 
-    BrowsingDataRemoverCompletionInhibitor completion_inhibitor;
+    BrowsingDataRemoverCompletionObserver completion_observer(remover);
     remover->RemoveImpl(BrowsingDataRemover::Period(period), remove_mask,
                         filter_builder, BrowsingDataHelper::UNPROTECTED_WEB);
-    completion_inhibitor.BlockUntilNearCompletion();
-    completion_inhibitor.ContinueToCompletion();
+    completion_observer.BlockUntilCompletion();
 
     // Save so we can verify later.
     storage_partition_removal_data_ =
@@ -2183,10 +2181,9 @@ TEST_F(BrowsingDataRemoverTest, CompletionInhibition) {
   BrowsingDataRemover* remover =
       BrowsingDataRemoverFactory::GetForBrowserContext(GetProfile());
   InspectableCompletionObserver completion_observer(remover);
-  remover->RemoveAndReply(BrowsingDataRemover::Unbounded(),
-                          BrowsingDataRemover::REMOVE_HISTORY,
-                          BrowsingDataHelper::UNPROTECTED_WEB,
-                          &completion_observer);
+  remover->Remove(BrowsingDataRemover::Unbounded(),
+                  BrowsingDataRemover::REMOVE_HISTORY,
+                  BrowsingDataHelper::UNPROTECTED_WEB);
 
   // Process messages until the inhibitor is notified, and then some, to make
   // sure we do not complete asynchronously before ContinueToCompletion() is
@@ -2213,10 +2210,9 @@ TEST_F(BrowsingDataRemoverTest, EarlyShutdown) {
       BrowsingDataRemoverFactory::GetForBrowserContext(GetProfile());
   InspectableCompletionObserver completion_observer(remover);
   BrowsingDataRemoverCompletionInhibitor completion_inhibitor;
-  remover->RemoveAndReply(BrowsingDataRemover::Unbounded(),
-                          BrowsingDataRemover::REMOVE_HISTORY,
-                          BrowsingDataHelper::UNPROTECTED_WEB,
-                          &completion_observer);
+  remover->Remove(BrowsingDataRemover::Unbounded(),
+                  BrowsingDataRemover::REMOVE_HISTORY,
+                  BrowsingDataHelper::UNPROTECTED_WEB);
 
   completion_inhibitor.BlockUntilNearCompletion();
 
@@ -2598,199 +2594,3 @@ TEST_F(BrowsingDataRemoverTest, ClearWithPredicate) {
   EXPECT_EQ(ContentSettingsPattern::FromURLNoWildcard(url1),
             host_settings[0].primary_pattern);
 }
-
-class MultipleTasksObserver {
- public:
-  // A simple implementation of BrowsingDataRemover::Observer.
-  // MultipleTasksObserver will use several instances of Target to test
-  // that completion callbacks are returned to the correct one.
-  class Target : public BrowsingDataRemover::Observer {
-   public:
-    Target(MultipleTasksObserver* parent, BrowsingDataRemover* remover)
-        : parent_(parent),
-          observer_(this) {
-      observer_.Add(remover);
-    }
-    ~Target() override {}
-
-    void OnBrowsingDataRemoverDone() override {
-      parent_->SetLastCalledTarget(this);
-    }
-
-   private:
-    MultipleTasksObserver* parent_;
-    ScopedObserver<BrowsingDataRemover, BrowsingDataRemover::Observer>
-        observer_;
-  };
-
-  explicit MultipleTasksObserver(BrowsingDataRemover* remover)
-      : target_a_(this, remover),
-        target_b_(this, remover),
-        last_called_target_(nullptr) {}
-  ~MultipleTasksObserver() {}
-
-  void ClearLastCalledTarget() {
-    last_called_target_ = nullptr;
-  }
-
-  Target* GetLastCalledTarget() {
-    return last_called_target_;
-  }
-
-  Target* target_a() { return &target_a_; }
-  Target* target_b() { return &target_b_; }
-
- private:
-  void SetLastCalledTarget(Target* target) {
-    DCHECK(!last_called_target_)
-        << "Call ClearLastCalledTarget() before every removal task.";
-    last_called_target_ = target;
-  }
-
-  Target target_a_;
-  Target target_b_;
-  Target* last_called_target_;
-};
-
-TEST_F(BrowsingDataRemoverTest, MultipleTasks) {
-  BrowsingDataRemover* remover =
-      BrowsingDataRemoverFactory::GetForBrowserContext(GetProfile());
-  EXPECT_FALSE(remover->is_removing());
-
-  std::unique_ptr<RegistrableDomainFilterBuilder> filter_builder_1(
-      new RegistrableDomainFilterBuilder(
-          RegistrableDomainFilterBuilder::WHITELIST));
-  std::unique_ptr<RegistrableDomainFilterBuilder> filter_builder_2(
-      new RegistrableDomainFilterBuilder(
-          RegistrableDomainFilterBuilder::BLACKLIST));
-  filter_builder_2->AddRegisterableDomain("example.com");
-
-  MultipleTasksObserver observer(remover);
-  BrowsingDataRemoverCompletionInhibitor completion_inhibitor;
-
-  // Test several tasks with various configuration of masks, filters, and target
-  // observers.
-  std::list<BrowsingDataRemover::RemovalTask> tasks;
-  tasks.emplace_back(
-      BrowsingDataRemover::Unbounded(),
-      BrowsingDataRemover::REMOVE_HISTORY,
-      BrowsingDataHelper::UNPROTECTED_WEB,
-      base::WrapUnique(new RegistrableDomainFilterBuilder(
-          RegistrableDomainFilterBuilder::BLACKLIST)),
-      observer.target_a());
-  tasks.emplace_back(
-      BrowsingDataRemover::Unbounded(),
-      BrowsingDataRemover::REMOVE_COOKIES,
-      BrowsingDataHelper::PROTECTED_WEB,
-      base::WrapUnique(new RegistrableDomainFilterBuilder(
-          RegistrableDomainFilterBuilder::BLACKLIST)),
-      nullptr);
-  tasks.emplace_back(
-      BrowsingDataRemover::TimeRange(base::Time::Now(), base::Time::Max()),
-      BrowsingDataRemover::REMOVE_PASSWORDS,
-      BrowsingDataHelper::ALL,
-      base::WrapUnique(new RegistrableDomainFilterBuilder(
-          RegistrableDomainFilterBuilder::BLACKLIST)),
-      observer.target_b());
-  tasks.emplace_back(
-      BrowsingDataRemover::TimeRange(base::Time(), base::Time::UnixEpoch()),
-      BrowsingDataRemover::REMOVE_PASSWORDS,
-      BrowsingDataHelper::UNPROTECTED_WEB,
-      std::move(filter_builder_1),
-      observer.target_b());
-  tasks.emplace_back(
-      BrowsingDataRemover::TimeRange(
-          base::Time::UnixEpoch(), base::Time::Now()),
-      BrowsingDataRemover::REMOVE_CHANNEL_IDS,
-      BrowsingDataHelper::ALL,
-      std::move(filter_builder_2),
-      nullptr);
-
-  for (BrowsingDataRemover::RemovalTask& task : tasks) {
-    // All tasks can be directly translated to a RemoveInternal() call. Since
-    // that is a private method, we must call the four public versions of
-    // Remove.* instead. This also serves as a test that those methods are all
-    // correctly reduced to RemoveInternal().
-    if (!task.observer && task.filter_builder->IsEmptyBlacklist()) {
-      remover->Remove(task.time_range, task.remove_mask, task.origin_type_mask);
-    } else if (task.filter_builder->IsEmptyBlacklist()) {
-      remover->RemoveAndReply(task.time_range, task.remove_mask,
-                              task.origin_type_mask, task.observer);
-    } else if (!task.observer) {
-      remover->RemoveWithFilter(task.time_range, task.remove_mask,
-                                task.origin_type_mask,
-                                std::move(task.filter_builder));
-    } else {
-      remover->RemoveWithFilterAndReply(task.time_range, task.remove_mask,
-                                        task.origin_type_mask,
-                                        std::move(task.filter_builder),
-                                        task.observer);
-    }
-  }
-
-  // Use the inhibitor to stop after every task and check the results.
-  for (BrowsingDataRemover::RemovalTask& task : tasks) {
-    EXPECT_TRUE(remover->is_removing());
-    observer.ClearLastCalledTarget();
-
-    // Finish the task execution synchronously.
-    completion_inhibitor.BlockUntilNearCompletion();
-    completion_inhibitor.ContinueToCompletion();
-
-    // Observers, if any, should have been called by now (since we call
-    // observers on the same thread).
-    EXPECT_EQ(task.observer, observer.GetLastCalledTarget());
-
-    // TODO(msramek): If BrowsingDataRemover took ownership of the last used
-    // filter builder and exposed it, we could also test it here. Make it so.
-    EXPECT_EQ(task.remove_mask, GetRemovalMask());
-    EXPECT_EQ(task.origin_type_mask, GetOriginTypeMask());
-    EXPECT_EQ(task.time_range.begin, GetBeginTime());
-  }
-
-  EXPECT_FALSE(remover->is_removing());
-}
-
-// The previous test, BrowsingDataRemoverTest.MultipleTasks, tests that the
-// tasks are not mixed up and they are executed in a correct order. However,
-// the completion inhibitor kept synchronizing the execution in order to verify
-// the parameters. This test demonstrates that even running the tasks without
-// inhibition is executed correctly and doesn't crash.
-TEST_F(BrowsingDataRemoverTest, MultipleTasksInQuickSuccession) {
-  BrowsingDataRemover* remover =
-      BrowsingDataRemoverFactory::GetForBrowserContext(GetProfile());
-  EXPECT_FALSE(remover->is_removing());
-
-  int test_removal_masks[] = {
-      BrowsingDataRemover::REMOVE_COOKIES,
-      BrowsingDataRemover::REMOVE_PASSWORDS,
-      BrowsingDataRemover::REMOVE_COOKIES,
-      BrowsingDataRemover::REMOVE_COOKIES,
-      BrowsingDataRemover::REMOVE_COOKIES,
-      BrowsingDataRemover::REMOVE_HISTORY,
-      BrowsingDataRemover::REMOVE_HISTORY,
-      BrowsingDataRemover::REMOVE_HISTORY,
-      BrowsingDataRemover::REMOVE_COOKIES | BrowsingDataRemover::REMOVE_HISTORY,
-      BrowsingDataRemover::REMOVE_COOKIES | BrowsingDataRemover::REMOVE_HISTORY,
-      BrowsingDataRemover::REMOVE_COOKIES |
-          BrowsingDataRemover::REMOVE_HISTORY |
-          BrowsingDataRemover::REMOVE_PASSWORDS,
-      BrowsingDataRemover::REMOVE_PASSWORDS,
-      BrowsingDataRemover::REMOVE_PASSWORDS,
-  };
-
-  for (int removal_mask : test_removal_masks) {
-    remover->Remove(BrowsingDataRemover::Unbounded(), removal_mask,
-                    BrowsingDataHelper::UNPROTECTED_WEB);
-  }
-
-  EXPECT_TRUE(remover->is_removing());
-
-  // Add one more deletion and wait for it.
-  BlockUntilBrowsingDataRemoved(
-      browsing_data::ALL_TIME,
-      BrowsingDataRemover::REMOVE_COOKIES,
-      BrowsingDataHelper::UNPROTECTED_WEB);
-
-  EXPECT_FALSE(remover->is_removing());
-}
diff --git a/chrome/browser/chrome_browser_main.cc b/chrome/browser/chrome_browser_main.cc
index f9bce51..d1a7a6e 100644
--- a/chrome/browser/chrome_browser_main.cc
+++ b/chrome/browser/chrome_browser_main.cc
@@ -60,7 +60,7 @@
 #include "chrome/browser/defaults.h"
 #include "chrome/browser/first_run/first_run.h"
 #include "chrome/browser/geolocation/chrome_access_token_store.h"
-#include "chrome/browser/gpu/gpu_profile_cache.h"
+#include "chrome/browser/gpu/gl_string_manager.h"
 #include "chrome/browser/gpu/three_d_api_observer.h"
 #include "chrome/browser/media/media_capture_devices_dispatcher.h"
 #include "chrome/browser/memory/tab_manager.h"
@@ -448,10 +448,7 @@ Profile* CreatePrimaryProfile(const content::MainFunctionParams& parameters,
                                   PROFILE_ERROR_CREATE_FAILURE_SPECIFIED :
                                   PROFILE_ERROR_CREATE_FAILURE_ALL;
 
-    // TODO(lwchkg): What diagnostics do you want to include in the feedback
-    // report when an error occurs?
-    ShowProfileErrorDialog(error_type, IDS_COULDNT_STARTUP_PROFILE_ERROR,
-                           "Error creating primary profile.");
+    ShowProfileErrorDialog(error_type, IDS_COULDNT_STARTUP_PROFILE_ERROR);
     return nullptr;
   }
 #endif  // defined(OS_CHROMEOS) || defined(OS_ANDROID)
@@ -951,15 +948,16 @@ int ChromeBrowserMainParts::PreCreateThreads() {
       chrome_extra_parts_[i]->PreCreateThreads();
   }
 
-  // It is important to call gpu_profile_cache()->Initialize() before
-  // starting the gpu process. Internally it properly setup the black listed
-  // features. Which it is used to decide whether to start or not the gpu
-  // process from BrowserMainLoop::BrowserThreadsStarted.
+  // It is important to call gl_string_manager()->Initialize() before starting
+  // the gpu process. Internally it properly setup the black listed features.
+  // Which it is used to decide whether to start or not the gpu process from
+  // BrowserMainLoop::BrowserThreadsStarted.
 
   // Retrieve cached GL strings from local state and use them for GPU
   // blacklist decisions.
-  if (g_browser_process->gpu_profile_cache())
-    g_browser_process->gpu_profile_cache()->Initialize();
+
+  if (g_browser_process->gl_string_manager())
+    g_browser_process->gl_string_manager()->Initialize();
 
   // Create an instance of GpuModeManager to watch gpu mode pref change.
   g_browser_process->gpu_mode_manager();
@@ -1050,6 +1048,12 @@ int ChromeBrowserMainParts::PreCreateThreadsImpl() {
   ash::MaterialDesignController::Initialize();
 #endif  // !defined(OS_CHROMEOS)
 
+#if defined(OS_MACOSX)
+  // Material Design resource packs can be loaded now that command line flags
+  // are set. See https://crbug.com/585290 .
+  ui::ResourceBundle::GetSharedInstance().LoadMaterialDesignResources();
+#endif
+
 #if defined(OS_WIN)
   // This is needed to enable ETW exporting when requested in about:flags.
   // Normally, we enable it in ContentMainRunnerImpl::Initialize when the flag
diff --git a/chrome/browser/chrome_browser_main_mac_browsertest.mm b/chrome/browser/chrome_browser_main_mac_browsertest.mm
new file mode 100644
index 0000000..13a7a62
--- /dev/null
+++ b/chrome/browser/chrome_browser_main_mac_browsertest.mm
@@ -0,0 +1,63 @@
+// Copyright 2016 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "base/command_line.h"
+#include "chrome/test/base/in_process_browser_test.h"
+#include "content/public/test/test_utils.h"
+#import "testing/gtest_mac.h"
+#include "ui/base/material_design/material_design_controller.h"
+#include "ui/base/resource/resource_bundle.h"
+#include "ui/base/resource/resource_handle.h"
+#include "ui/base/resource/scale_factor.h"
+#include "ui/base/ui_base_switches.h"
+
+namespace ui {
+
+class ChromeBrowserMainMacBrowserTest : public InProcessBrowserTest {
+ public:
+  ChromeBrowserMainMacBrowserTest() {}
+
+ protected:
+  void SetUpCommandLine(base::CommandLine* command_line) override {
+    // Activate Material Design mode by placing the MD switch on the command
+    // line.
+    command_line->AppendSwitchASCII(switches::kTopChromeMD,
+                                    switches::kTopChromeMDMaterial);
+  }
+};
+
+// Confirm that the Material Design resource packs are loaded and are the
+// first packs in the vector (so that they are searched before the regular non-
+// MD packs). TODO(shrike) - remove this test once Material Design replaces
+// the old design.
+IN_PROC_BROWSER_TEST_F(ChromeBrowserMainMacBrowserTest, MDResourceAccess) {
+  // Make sure we're running in Material Design mode.
+  ASSERT_TRUE(MaterialDesignController::IsModeMaterial());
+
+  ResourceBundle& rb = ResourceBundle::GetSharedInstance();
+  int counter = 0;
+  for (const auto& pack : rb.data_packs_) {
+    switch (counter) {
+      case 0:
+        // The first pack should be Material Design at 1x.
+        EXPECT_TRUE(pack->HasOnlyMaterialDesignAssets());
+        EXPECT_EQ(SCALE_FACTOR_100P, pack->GetScaleFactor());
+        break;
+
+      case 1:
+        // The Second pack should be Material Design at 2x.
+        EXPECT_TRUE(pack->HasOnlyMaterialDesignAssets());
+        EXPECT_EQ(SCALE_FACTOR_200P, pack->GetScaleFactor());
+        break;
+
+      default:
+        // All other packs should not be Material Design.
+        EXPECT_FALSE(pack->HasOnlyMaterialDesignAssets());
+        break;
+    }
+    counter++;
+  }
+}
+
+}  // namespace ui
diff --git a/chrome/browser/chrome_content_browser_client.cc b/chrome/browser/chrome_content_browser_client.cc
index 8a8a08e..4f0bf8e 100644
--- a/chrome/browser/chrome_content_browser_client.cc
+++ b/chrome/browser/chrome_content_browser_client.cc
@@ -205,6 +205,8 @@
 #include "chrome/browser/ui/ash/ash_util.h"
 #include "chrome/browser/ui/browser_dialogs.h"
 #include "chromeos/chromeos_switches.h"
+#include "components/arc/arc_service_manager.h"
+#include "components/arc/intent_helper/local_activity_resolver.h"
 #include "components/user_manager/user_manager.h"
 #elif defined(OS_LINUX)
 #include "chrome/browser/chrome_browser_main_linux.h"
@@ -2946,14 +2948,22 @@ ChromeContentBrowserClient::CreateThrottlesForNavigation(
     // warning that the selected app is not in incognito mode.
     if (IsIntentPickerEnabled() &&
         !handle->GetWebContents()->GetBrowserContext()->IsOffTheRecord()) {
-      prerender::PrerenderContents* prerender_contents =
-          prerender::PrerenderContents::FromWebContents(
-              handle->GetWebContents());
-      if (!prerender_contents) {
-        auto intent_picker_cb = base::Bind(ShowIntentPickerBubble());
-        auto url_to_arc_throttle = base::MakeUnique<arc::ArcNavigationThrottle>(
-            handle, intent_picker_cb);
-        throttles.push_back(std::move(url_to_arc_throttle));
+      arc::ArcServiceManager* arc_service_manager =
+          arc::ArcServiceManager::Get();
+      DCHECK(arc_service_manager);
+      scoped_refptr<arc::LocalActivityResolver> local_resolver =
+          arc_service_manager->activity_resolver();
+      if (!local_resolver->ShouldChromeHandleUrl(handle->GetURL())) {
+        prerender::PrerenderContents* prerender_contents =
+            prerender::PrerenderContents::FromWebContents(
+                handle->GetWebContents());
+        if (!prerender_contents) {
+          auto intent_picker_cb = base::Bind(ShowIntentPickerBubble());
+          auto url_to_arc_throttle =
+              base::MakeUnique<arc::ArcNavigationThrottle>(handle,
+                                                           intent_picker_cb);
+          throttles.push_back(std::move(url_to_arc_throttle));
+        }
       }
     }
   }
diff --git a/chrome/browser/chromeos/arc/arc_navigation_throttle.cc b/chrome/browser/chromeos/arc/arc_navigation_throttle.cc
index bb275cc..0275bb7 100644
--- a/chrome/browser/chromeos/arc/arc_navigation_throttle.cc
+++ b/chrome/browser/chromeos/arc/arc_navigation_throttle.cc
@@ -13,7 +13,6 @@
 #include "components/arc/arc_bridge_service.h"
 #include "components/arc/arc_service_manager.h"
 #include "components/arc/intent_helper/arc_intent_helper_bridge.h"
-#include "components/arc/intent_helper/local_activity_resolver.h"
 #include "content/public/browser/browser_thread.h"
 #include "content/public/browser/navigation_handle.h"
 #include "net/base/registry_controlled_domains/registry_controlled_domain.h"
@@ -55,10 +54,9 @@ mojom::IntentHelperInstance* GetIntentHelper() {
 
 ArcNavigationThrottle::ArcNavigationThrottle(
     content::NavigationHandle* navigation_handle,
-    const ShowIntentPickerCallback& show_intent_picker_cb)
+    const ShowDisambigDialogCallback& show_disambig_dialog_cb)
     : content::NavigationThrottle(navigation_handle),
-      show_intent_picker_callback_(show_intent_picker_cb),
-      previous_user_action_(CloseReason::INVALID),
+      show_disambig_dialog_callback_(show_disambig_dialog_cb),
       weak_ptr_factory_(this) {}
 
 ArcNavigationThrottle::~ArcNavigationThrottle() = default;
@@ -66,71 +64,27 @@ ArcNavigationThrottle::~ArcNavigationThrottle() = default;
 content::NavigationThrottle::ThrottleCheckResult
 ArcNavigationThrottle::WillStartRequest() {
   DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
-  return HandleRequest();
-}
-
-content::NavigationThrottle::ThrottleCheckResult
-ArcNavigationThrottle::WillRedirectRequest() {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
-
-  switch (previous_user_action_) {
-    case CloseReason::ERROR:
-    case CloseReason::DIALOG_DEACTIVATED:
-      // User dismissed the dialog, or some error occurred before.  Don't
-      // repeatedly pop up the dialog.
-      return content::NavigationThrottle::PROCEED;
-
-    case CloseReason::ALWAYS_PRESSED:
-    case CloseReason::JUST_ONCE_PRESSED:
-    case CloseReason::PREFERRED_ACTIVITY_FOUND:
-      // Should never get here - if the user selected one of these previously,
-      // Chrome should not see a redirect.
-      NOTREACHED();
-
-    case CloseReason::INVALID:
-      // No picker has previously been popped up for this - continue.
-      break;
-  }
-  return HandleRequest();
-}
 
-content::NavigationThrottle::ThrottleCheckResult
-ArcNavigationThrottle::HandleRequest() {
-  const GURL& url = navigation_handle()->GetURL();
-
-  // Mask out any redirect qualifiers - this method handles navigation from
-  // redirect and non-redirect navigations equivalently.
   const ui::PageTransition transition =
-      ui::PageTransitionFromInt(navigation_handle()->GetPageTransition() &
-                                ~ui::PAGE_TRANSITION_IS_REDIRECT_MASK);
+      navigation_handle()->GetPageTransition();
 
   if (!ui::PageTransitionCoreTypeIs(transition, ui::PAGE_TRANSITION_LINK)) {
-    // Allow navigation to proceed if this event wasn't spawned by the user
-    // clicking on a link.
+    // If this navigation event wasn't spawned by the user clicking on a link.
     return content::NavigationThrottle::PROCEED;
   }
 
   if (ui::PageTransitionGetQualifier(transition) != 0) {
     // Qualifiers indicate that this navigation was the result of a click on a
-    // forward/back button, or typing in the URL bar, etc.  Don't pass any of
-    // those types of navigations to the intent helper (see crbug.com/630072).
-    // Note that redirects, which we do pass on, are masked out above.
+    // forward/back button, or a redirect, or typing in the URL bar, etc.  Don't
+    // pass any of those types of navigations to the intent helper (see
+    // crbug.com/630072).
     return content::NavigationThrottle::PROCEED;
   }
 
   if (!ShouldOverrideUrlLoading(navigation_handle()))
     return content::NavigationThrottle::PROCEED;
 
-  arc::ArcServiceManager* arc_service_manager = arc::ArcServiceManager::Get();
-  DCHECK(arc_service_manager);
-  scoped_refptr<arc::LocalActivityResolver> local_resolver =
-      arc_service_manager->activity_resolver();
-  if (local_resolver->ShouldChromeHandleUrl(url)) {
-    // Allow navigation to proceed if there isn't an android app that handles
-    // the given URL.
-    return content::NavigationThrottle::PROCEED;
-  }
-
+  const GURL& url = navigation_handle()->GetURL();
   mojom::IntentHelperInstance* bridge_instance = GetIntentHelper();
   if (!bridge_instance)
     return content::NavigationThrottle::PROCEED;
@@ -140,6 +94,12 @@ ArcNavigationThrottle::HandleRequest() {
   return content::NavigationThrottle::DEFER;
 }
 
+content::NavigationThrottle::ThrottleCheckResult
+ArcNavigationThrottle::WillRedirectRequest() {
+  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
+  return content::NavigationThrottle::PROCEED;
+}
+
 // We received the array of app candidates to handle this URL (even the Chrome
 // app is included).
 void ArcNavigationThrottle::OnAppCandidatesReceived(
@@ -169,8 +129,8 @@ void ArcNavigationThrottle::OnAppCandidatesReceived(
           << "Chrome browser is selected as the preferred app for this URL: "
           << navigation_handle()->GetURL().spec();
     }
-    OnIntentPickerClosed(std::move(handlers), i,
-                         CloseReason::PREFERRED_ACTIVITY_FOUND);
+    OnDisambigDialogClosed(std::move(handlers), i,
+                           CloseReason::PREFERRED_ACTIVITY_FOUND);
     return;
   }
 
@@ -220,13 +180,13 @@ void ArcNavigationThrottle::OnAppIconsReceived(
         handler->name, it != icons->end() ? it->second.icon20 : gfx::Image());
   }
 
-  show_intent_picker_callback_.Run(
+  show_disambig_dialog_callback_.Run(
       navigation_handle(), app_info,
-      base::Bind(&ArcNavigationThrottle::OnIntentPickerClosed,
+      base::Bind(&ArcNavigationThrottle::OnDisambigDialogClosed,
                  weak_ptr_factory_.GetWeakPtr(), base::Passed(&handlers)));
 }
 
-void ArcNavigationThrottle::OnIntentPickerClosed(
+void ArcNavigationThrottle::OnDisambigDialogClosed(
     mojo::Array<mojom::UrlHandlerInfoPtr> handlers,
     size_t selected_app_index,
     CloseReason close_reason) {
@@ -234,8 +194,6 @@ void ArcNavigationThrottle::OnIntentPickerClosed(
   const GURL& url = navigation_handle()->GetURL();
   content::NavigationHandle* handle = navigation_handle();
 
-  previous_user_action_ = close_reason;
-
   mojom::IntentHelperInstance* bridge = GetIntentHelper();
   if (!bridge || selected_app_index >= handlers.size()) {
     close_reason = CloseReason::ERROR;
@@ -268,7 +226,7 @@ void ArcNavigationThrottle::OnIntentPickerClosed(
       }
       break;
     }
-    case CloseReason::INVALID: {
+    case CloseReason::SIZE: {
       NOTREACHED();
       return;
     }
diff --git a/chrome/browser/chromeos/arc/arc_navigation_throttle.h b/chrome/browser/chromeos/arc/arc_navigation_throttle.h
index 7a9fba3..0690af2 100644
--- a/chrome/browser/chromeos/arc/arc_navigation_throttle.h
+++ b/chrome/browser/chromeos/arc/arc_navigation_throttle.h
@@ -37,7 +37,6 @@ class ArcNavigationThrottle : public content::NavigationThrottle {
     JUST_ONCE_PRESSED = 3,
     PREFERRED_ACTIVITY_FOUND = 4,
     SIZE,
-    INVALID = SIZE,
   };
 
   // Restricts the amount of apps displayed to the user without the need of a
@@ -45,12 +44,13 @@ class ArcNavigationThrottle : public content::NavigationThrottle {
   enum { kMaxAppResults = 3 };
 
   using NameAndIcon = std::pair<std::string, gfx::Image>;
-  using ShowIntentPickerCallback =
+  using ShowDisambigDialogCallback =
       base::Callback<void(content::NavigationHandle* handle,
                           const std::vector<NameAndIcon>& app_info,
                           const base::Callback<void(size_t, CloseReason)>& cb)>;
-  ArcNavigationThrottle(content::NavigationHandle* navigation_handle,
-                        const ShowIntentPickerCallback& show_intent_picker_cb);
+  ArcNavigationThrottle(
+      content::NavigationHandle* navigation_handle,
+      const ShowDisambigDialogCallback& show_disambig_dialog_cb);
   ~ArcNavigationThrottle() override;
 
  private:
@@ -58,30 +58,22 @@ class ArcNavigationThrottle : public content::NavigationThrottle {
   NavigationThrottle::ThrottleCheckResult WillStartRequest() override;
   NavigationThrottle::ThrottleCheckResult WillRedirectRequest() override;
 
-  NavigationThrottle::ThrottleCheckResult HandleRequest();
   void OnAppCandidatesReceived(mojo::Array<mojom::UrlHandlerInfoPtr> handlers);
   void OnAppIconsReceived(
       mojo::Array<mojom::UrlHandlerInfoPtr> handlers,
       std::unique_ptr<ActivityIconLoader::ActivityToIconsMap> icons);
-  void OnIntentPickerClosed(mojo::Array<mojom::UrlHandlerInfoPtr> handlers,
-                            size_t selected_app_index,
-                            CloseReason close_reason);
+  void OnDisambigDialogClosed(mojo::Array<mojom::UrlHandlerInfoPtr> handlers,
+                              size_t selected_app_index,
+                              CloseReason close_reason);
   // Compares the host name of the referrer and target URL to decide whether
   // the navigation needs to be overriden.
   bool ShouldOverrideUrlLoading(content::NavigationHandle* navigation_handle);
 
   // A callback object that allow us to display an IntentPicker when Run() is
   // executed, it also allow us to report the user's selection back to
-  // OnIntentPickerClosed().
-  ShowIntentPickerCallback show_intent_picker_callback_;
+  // OnDisambigDialogClosed().
+  ShowDisambigDialogCallback show_disambig_dialog_callback_;
 
-  // A cache of the action the user took the last time this navigation throttle
-  // popped up the intent picker dialog.  If the dialog has never been popped up
-  // before, this will have a value of CloseReason::INVALID.  Used to avoid
-  // popping up the dialog multiple times on chains of multiple redirects.
-  CloseReason previous_user_action_;
-
-  // This has to be the last member of the class.
   base::WeakPtrFactory<ArcNavigationThrottle> weak_ptr_factory_;
 
   DISALLOW_COPY_AND_ASSIGN(ArcNavigationThrottle);
diff --git a/chrome/browser/chromeos/display/display_preferences.cc b/chrome/browser/chromeos/display/display_preferences.cc
index 2ae8131..a05e367 100644
--- a/chrome/browser/chromeos/display/display_preferences.cc
+++ b/chrome/browser/chromeos/display/display_preferences.cc
@@ -266,14 +266,15 @@ void StoreCurrentDisplayProperties() {
     property_value->SetInteger(
         "ui-scale", static_cast<int>(info.configured_ui_scale() * 1000));
 
-    scoped_refptr<ash::DisplayMode> mode =
-        display_manager->GetSelectedModeForDisplayId(id);
-    if (!display.IsInternal() && mode && !mode->native()) {
-      property_value->SetInteger("width", mode->size().width());
-      property_value->SetInteger("height", mode->size().height());
+    ash::DisplayMode mode;
+    if (!display.IsInternal() &&
+        display_manager->GetSelectedModeForDisplayId(id, &mode) &&
+        !mode.native) {
+      property_value->SetInteger("width", mode.size.width());
+      property_value->SetInteger("height", mode.size.height());
       property_value->SetInteger(
           "device-scale-factor",
-          static_cast<int>(mode->device_scale_factor() * 1000));
+          static_cast<int>(mode.device_scale_factor * 1000));
     }
     if (!info.overscan_insets_in_dip().IsEmpty())
       InsetsToValue(info.overscan_insets_in_dip(), property_value.get());
diff --git a/chrome/browser/chromeos/display/display_preferences_unittest.cc b/chrome/browser/chromeos/display/display_preferences_unittest.cc
index 7f29b8f..f2fa535 100644
--- a/chrome/browser/chromeos/display/display_preferences_unittest.cc
+++ b/chrome/browser/chromeos/display/display_preferences_unittest.cc
@@ -378,9 +378,8 @@ TEST_F(DisplayPreferencesTest, BasicStores) {
   EXPECT_FALSE(property->GetInteger("width", &width));
   EXPECT_FALSE(property->GetInteger("height", &height));
 
-  scoped_refptr<ash::DisplayMode> mode(new ash::DisplayMode(
-      gfx::Size(300, 200), 60.0f, false, true, 1.0 /* ui_scale */,
-      1.25f /* device_scale_factor */));
+  ash::DisplayMode mode(gfx::Size(300, 200), 60.0f, false, true);
+  mode.device_scale_factor = 1.25f;
   display_manager->SetDisplayMode(id2, mode);
 
   window_tree_host_manager->SetPrimaryDisplayId(id2);
@@ -528,11 +527,10 @@ TEST_F(DisplayPreferencesTest, PreventStore) {
   // Set display's resolution in single display. It creates the notification and
   // display preferences should not stored meanwhile.
   ash::Shell* shell = ash::Shell::GetInstance();
-
-  scoped_refptr<ash::DisplayMode> old_mode(
-      new ash::DisplayMode(gfx::Size(400, 300)));
-  scoped_refptr<ash::DisplayMode> new_mode(
-      new ash::DisplayMode(gfx::Size(500, 400)));
+  ash::DisplayMode old_mode;
+  ash::DisplayMode new_mode;
+  old_mode.size = gfx::Size(400, 300);
+  new_mode.size = gfx::Size(500, 400);
   if (shell->display_manager()->SetDisplayMode(id, new_mode)) {
     shell->resolution_notification_controller()->PrepareNotification(
         id, old_mode, new_mode, base::Closure());
@@ -558,8 +556,7 @@ TEST_F(DisplayPreferencesTest, PreventStore) {
   // Once the notification is removed, the specified resolution will be stored
   // by SetDisplayMode.
   ash::Shell::GetInstance()->display_manager()->SetDisplayMode(
-      id, make_scoped_refptr(
-              new ash::DisplayMode(gfx::Size(300, 200), 60.0f, false, true)));
+      id, ash::DisplayMode(gfx::Size(300, 200), 60.0f, false, true));
   UpdateDisplay("300x200#500x400|400x300|300x200");
 
   property = nullptr;
diff --git a/chrome/browser/chromeos/login/oobe_localization_browsertest.cc b/chrome/browser/chromeos/login/oobe_localization_browsertest.cc
index d04ff58..c055ef7 100644
--- a/chrome/browser/chromeos/login/oobe_localization_browsertest.cc
+++ b/chrome/browser/chromeos/login/oobe_localization_browsertest.cc
@@ -8,8 +8,6 @@
 #include "base/message_loop/message_loop.h"
 #include "base/strings/stringprintf.h"
 #include "base/task_runner.h"
-#include "base/time/time.h"
-#include "base/timer/timer.h"
 #include "chrome/browser/browser_process.h"
 #include "chrome/browser/chrome_notification_types.h"
 #include "chrome/browser/chromeos/customization/customization_document.h"
@@ -42,60 +40,18 @@ namespace chromeos {
 
 namespace {
 
-// Timeout for RunLoop::Run() in this test.
-const int kTimeoutSeconds = 2;
-
 // OOBE constants.
 const char kLocaleSelect[] = "language-select";
 const char kKeyboardSelect[] = "keyboard-select";
 
 const char kUSLayout[] = "xkb:us::eng";
-class TimedRunLoop {
- public:
-  TimedRunLoop(const base::TimeDelta& timeout,
-               const std::string& failure_message)
-      : timeout_(timeout), message_(failure_message) {}
-
-  // Returns true if Run() successfully finished,
-  // Returns false on timeout.
-  bool Run() {
-    base::OneShotTimer timer;
-    timer.Start(FROM_HERE, timeout_,
-                base::Bind(&TimedRunLoop::OnTimeout, base::Unretained(this)));
-    loop_.Run();
-    return result_;
-  }
-
-  void Quit() {
-    result_ = true;
-    loop_.Quit();
-  }
-
-  base::Closure QuitClosure() {
-    return base::Bind(&TimedRunLoop::Quit, base::Unretained(this));
-  }
-
- private:
-  void OnTimeout() {
-    LOG(ERROR) << "Timeout waiting for: " << message_;
-    result_ = false;
-    loop_.Quit();
-  }
-
-  bool result_ = false;
-  const base::TimeDelta timeout_;
-  const std::string message_;
-  base::RunLoop loop_;
-
-  DISALLOW_COPY_AND_ASSIGN(TimedRunLoop);
-};
 
 class LanguageListWaiter : public NetworkScreen::Observer {
  public:
-  LanguageListWaiter()
+  explicit LanguageListWaiter(base::RunLoop& loop)
       : network_screen_(
             NetworkScreen::Get(WizardController::default_controller())),
-        loop_(base::TimeDelta::FromSeconds(kTimeoutSeconds), "LanguageList") {
+        loop_(loop) {
     network_screen_->AddObserver(this);
     CheckLanguageList();
   }
@@ -105,26 +61,14 @@ class LanguageListWaiter : public NetworkScreen::Observer {
   // NetworkScreen::Observer implementation:
   void OnLanguageListReloaded() override { CheckLanguageList(); }
 
-  // Returns true on success, false on timeout.
-  bool Wait() {
-    if (LanguageListReady())
-      return true;
-
-    return loop_.Run();
-  }
-
  private:
-  bool LanguageListReady() const {
-    return network_screen_->GetLanguageList();
-  }
-
   void CheckLanguageList() {
-    if (LanguageListReady())
+    if (network_screen_->GetLanguageList())
       loop_.Quit();
   }
 
   NetworkScreen* network_screen_;
-  TimedRunLoop loop_;
+  base::RunLoop& loop_;
 };
 
 }  // namespace
@@ -210,23 +154,17 @@ class OobeLocalizationTest
   // Runs the test for the given locale and keyboard layout.
   void RunLocalizationTest();
 
-  // Returns true on success, false on error.
-  bool WaitUntilJSIsReady() {
+  void WaitUntilJSIsReady() {
     LoginDisplayHost* host = LoginDisplayHost::default_host();
     if (!host)
-      return false;
-
+      return;
     OobeUI* oobe_ui = host->GetOobeUI();
     if (!oobe_ui)
-      return false;
-
-    TimedRunLoop run_loop(base::TimeDelta::FromSeconds(kTimeoutSeconds),
-                          "WaitUntilJSIsReady()");
+      return;
+    base::RunLoop run_loop;
     const bool oobe_ui_ready = oobe_ui->IsJSReady(run_loop.QuitClosure());
-    if (oobe_ui_ready)
-      return true;
-
-    return run_loop.Run();
+    if (!oobe_ui_ready)
+      run_loop.Run();
   }
 
  private:
@@ -359,9 +297,13 @@ void OobeLocalizationTest::RunLocalizationTest() {
   const std::string expected_keyboard_select =
       TranslateXKB2Extension(expected_keyboard_select_control);
 
-  ASSERT_TRUE(LanguageListWaiter().Wait());
+  {
+    base::RunLoop loop;
+    LanguageListWaiter waiter(loop);
+    loop.Run();
+  }
 
-  ASSERT_TRUE(WaitUntilJSIsReady());
+  WaitUntilJSIsReady();
 
   const std::string first_language =
       expected_locale.substr(0, expected_locale.find(','));
diff --git a/chrome/browser/chromeos/profiles/profile_helper.cc b/chrome/browser/chromeos/profiles/profile_helper.cc
index e442bff..91ff48c 100644
--- a/chrome/browser/chromeos/profiles/profile_helper.cc
+++ b/chrome/browser/chromeos/profiles/profile_helper.cc
@@ -262,9 +262,9 @@ void ProfileHelper::ClearSigninProfile(const base::Closure& on_clear_callback) {
     browsing_data_remover_ =
         BrowsingDataRemoverFactory::GetForBrowserContext(GetSigninProfile());
     browsing_data_remover_->AddObserver(this);
-    browsing_data_remover_->RemoveAndReply(
-        BrowsingDataRemover::Unbounded(), BrowsingDataRemover::REMOVE_SITE_DATA,
-        BrowsingDataHelper::ALL, this);
+    browsing_data_remover_->Remove(BrowsingDataRemover::Unbounded(),
+                                   BrowsingDataRemover::REMOVE_SITE_DATA,
+                                   BrowsingDataHelper::ALL);
   } else {
     on_clear_profile_stage_finished_.Run();
   }
diff --git a/chrome/browser/component_updater/subresource_filter_component_installer.cc b/chrome/browser/component_updater/subresource_filter_component_installer.cc
index 57db6ed..10f6f76 100644
--- a/chrome/browser/component_updater/subresource_filter_component_installer.cc
+++ b/chrome/browser/component_updater/subresource_filter_component_installer.cc
@@ -55,14 +55,6 @@ const base::FilePath::CharType
     SubresourceFilterComponentInstallerTraits::kLicenseFileName[] =
         FILE_PATH_LITERAL("LICENSE");
 
-// static
-const char
-    SubresourceFilterComponentInstallerTraits::kManifestRulesetFormatKey[] =
-        "ruleset_format";
-
-// static
-const int SubresourceFilterComponentInstallerTraits::kCurrentRulesetFormat = 1;
-
 SubresourceFilterComponentInstallerTraits::
     SubresourceFilterComponentInstallerTraits() {}
 
@@ -92,12 +84,6 @@ void SubresourceFilterComponentInstallerTraits::ComponentReady(
     std::unique_ptr<base::DictionaryValue> manifest) {
   DCHECK(!install_dir.empty());
   DVLOG(1) << "Subresource Filter Version Ready: " << install_dir.value();
-  int ruleset_format = 0;
-  if (!manifest->GetInteger(kManifestRulesetFormatKey, &ruleset_format) ||
-      ruleset_format != kCurrentRulesetFormat) {
-    DVLOG(1) << "Bailing out. Future ruleset version: " << ruleset_format;
-    return;
-  }
   subresource_filter::UnindexedRulesetInfo ruleset_info;
   ruleset_info.content_version = version.GetString();
   ruleset_info.ruleset_path = install_dir.Append(kRulesetDataFileName);
diff --git a/chrome/browser/component_updater/subresource_filter_component_installer.h b/chrome/browser/component_updater/subresource_filter_component_installer.h
index dcc8e6d..b1c9db7 100644
--- a/chrome/browser/component_updater/subresource_filter_component_installer.h
+++ b/chrome/browser/component_updater/subresource_filter_component_installer.h
@@ -22,8 +22,6 @@ class SubresourceFilterComponentInstallerTraits
  public:
   static const base::FilePath::CharType kRulesetDataFileName[];
   static const base::FilePath::CharType kLicenseFileName[];
-  static const char kManifestRulesetFormatKey[];
-  static const int kCurrentRulesetFormat;
 
   SubresourceFilterComponentInstallerTraits();
   ~SubresourceFilterComponentInstallerTraits() override;
diff --git a/chrome/browser/component_updater/subresource_filter_component_installer_unittest.cc b/chrome/browser/component_updater/subresource_filter_component_installer_unittest.cc
index 3d30c40..c740f9a 100644
--- a/chrome/browser/component_updater/subresource_filter_component_installer_unittest.cc
+++ b/chrome/browser/component_updater/subresource_filter_component_installer_unittest.cc
@@ -30,8 +30,6 @@
 
 namespace {
 
-static const char kTestRulesetVersion[] = "1.2.3.4";
-
 class TestRulesetService : public subresource_filter::RulesetService {
  public:
   TestRulesetService(PrefService* local_state,
@@ -138,17 +136,15 @@ class SubresourceFilterComponentInstallerTest : public PlatformTest {
     }
   }
 
-  void LoadSubresourceFilterRuleset(int ruleset_format) {
+  void LoadSubresourceFilterRuleset() {
     std::unique_ptr<base::DictionaryValue> manifest(new base::DictionaryValue);
-    manifest->SetInteger(
-        SubresourceFilterComponentInstallerTraits::kManifestRulesetFormatKey,
-        ruleset_format);
     ASSERT_TRUE(
         traits_->VerifyInstallation(*manifest, component_install_dir()));
-    const base::Version expected_version(kTestRulesetVersion);
+    const base::Version expected_version("1.2.3.4");
     traits_->ComponentReady(expected_version, component_install_dir(),
                             std::move(manifest));
     base::RunLoop().RunUntilIdle();
+    EXPECT_EQ(expected_version.GetString(), service()->content_version());
   }
 
  private:
@@ -167,8 +163,7 @@ TEST_F(SubresourceFilterComponentInstallerTest,
   base::FieldTrialList field_trial_list(nullptr);
   subresource_filter::testing::ScopedSubresourceFilterFeatureToggle
       scoped_feature_toggle(base::FeatureList::OVERRIDE_DISABLE_FEATURE,
-                            subresource_filter::kActivationStateEnabled,
-                            subresource_filter::kActivationScopeNoSites);
+                            subresource_filter::kActivationStateEnabled);
   std::unique_ptr<SubresourceFilterMockComponentUpdateService>
       component_updater(new SubresourceFilterMockComponentUpdateService());
   EXPECT_CALL(*component_updater, RegisterComponent(testing::_)).Times(0);
@@ -181,8 +176,7 @@ TEST_F(SubresourceFilterComponentInstallerTest,
   base::FieldTrialList field_trial_list(nullptr);
   subresource_filter::testing::ScopedSubresourceFilterFeatureToggle
       scoped_feature_toggle(base::FeatureList::OVERRIDE_ENABLE_FEATURE,
-                            subresource_filter::kActivationStateDisabled,
-                            subresource_filter::kActivationScopeNoSites);
+                            subresource_filter::kActivationStateDisabled);
   std::unique_ptr<SubresourceFilterMockComponentUpdateService>
       component_updater(new SubresourceFilterMockComponentUpdateService());
   EXPECT_CALL(*component_updater, RegisterComponent(testing::_)).Times(1);
@@ -194,9 +188,7 @@ TEST_F(SubresourceFilterComponentInstallerTest, LoadEmptyRuleset) {
   ASSERT_TRUE(service());
   ASSERT_NO_FATAL_FAILURE(
       CreateTestSubresourceFilterRuleset(std::string(), nullptr));
-  ASSERT_NO_FATAL_FAILURE(LoadSubresourceFilterRuleset(
-      SubresourceFilterComponentInstallerTraits::kCurrentRulesetFormat));
-  EXPECT_EQ(kTestRulesetVersion, service()->content_version());
+  ASSERT_NO_FATAL_FAILURE(LoadSubresourceFilterRuleset());
   std::string actual_ruleset_contents;
   ASSERT_TRUE(base::ReadFileToString(service()->ruleset_path(),
                                      &actual_ruleset_contents));
@@ -204,27 +196,13 @@ TEST_F(SubresourceFilterComponentInstallerTest, LoadEmptyRuleset) {
   EXPECT_FALSE(base::PathExists(service()->license_path()));
 }
 
-TEST_F(SubresourceFilterComponentInstallerTest, FutureVersionIgnored) {
-  ASSERT_TRUE(service());
-  const std::string expected_ruleset_contents = "future stuff";
-  ASSERT_NO_FATAL_FAILURE(
-      CreateTestSubresourceFilterRuleset(expected_ruleset_contents, nullptr));
-  ASSERT_NO_FATAL_FAILURE(LoadSubresourceFilterRuleset(
-      SubresourceFilterComponentInstallerTraits::kCurrentRulesetFormat + 1));
-  EXPECT_EQ(std::string(), service()->content_version());
-  EXPECT_TRUE(service()->ruleset_path().empty());
-  EXPECT_TRUE(service()->license_path().empty());
-}
-
 TEST_F(SubresourceFilterComponentInstallerTest, LoadFileWithData) {
   ASSERT_TRUE(service());
   const std::string expected_ruleset_contents = "foobar";
   const std::string expected_license_contents = "license";
   ASSERT_NO_FATAL_FAILURE(CreateTestSubresourceFilterRuleset(
       expected_ruleset_contents, &expected_license_contents));
-  ASSERT_NO_FATAL_FAILURE(LoadSubresourceFilterRuleset(
-      SubresourceFilterComponentInstallerTraits::kCurrentRulesetFormat));
-  EXPECT_EQ(kTestRulesetVersion, service()->content_version());
+  ASSERT_NO_FATAL_FAILURE(LoadSubresourceFilterRuleset());
   std::string actual_ruleset_contents;
   std::string actual_license_contents;
   ASSERT_TRUE(base::ReadFileToString(service()->ruleset_path(),
diff --git a/chrome/browser/content_settings/host_content_settings_map_unittest.cc b/chrome/browser/content_settings/host_content_settings_map_unittest.cc
index 2d501d0..9823dfe 100644
--- a/chrome/browser/content_settings/host_content_settings_map_unittest.cc
+++ b/chrome/browser/content_settings/host_content_settings_map_unittest.cc
@@ -1369,29 +1369,29 @@ TEST_F(HostContentSettingsMapTest, MigrateDomainScopedSettings) {
 
   // Change default setting to BLOCK.
   host_content_settings_map->SetDefaultContentSetting(
-      CONTENT_SETTINGS_TYPE_POPUPS, CONTENT_SETTING_BLOCK);
+      CONTENT_SETTINGS_TYPE_COOKIES, CONTENT_SETTING_BLOCK);
   EXPECT_EQ(
       CONTENT_SETTING_BLOCK,
       host_content_settings_map->GetContentSetting(
-          http_host, http_host, CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+          http_host, http_host, CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
   // Patterns generated for cookies used to be domain scoped.
   host_content_settings_map->SetContentSettingCustomScope(
       ContentSettingsPattern::FromURL(http_host),
-      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_POPUPS,
+      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_COOKIES,
       std::string(), CONTENT_SETTING_ALLOW);
   EXPECT_EQ(
       CONTENT_SETTING_ALLOW,
       host_content_settings_map->GetContentSetting(
-          http_host, http_host, CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+          http_host, http_host, CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
   // Settings also apply to subdomains.
   EXPECT_EQ(CONTENT_SETTING_ALLOW,
             host_content_settings_map->GetContentSetting(
                 http_host_narrower, http_host_narrower,
-                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
 
   ContentSettingsForOneType settings;
-  host_content_settings_map->GetSettingsForOneType(CONTENT_SETTINGS_TYPE_POPUPS,
-                                                   std::string(), &settings);
+  host_content_settings_map->GetSettingsForOneType(
+      CONTENT_SETTINGS_TYPE_COOKIES, std::string(), &settings);
   // |host_content_settings_map| contains default setting and a domain scoped
   // setting.
   EXPECT_EQ(2U, settings.size());
@@ -1404,28 +1404,28 @@ TEST_F(HostContentSettingsMapTest, MigrateDomainScopedSettings) {
 
   // Change default setting to BLOCK.
   host_content_settings_map->SetDefaultContentSetting(
-      CONTENT_SETTINGS_TYPE_JAVASCRIPT, CONTENT_SETTING_BLOCK);
-  EXPECT_EQ(CONTENT_SETTING_BLOCK,
-            host_content_settings_map->GetContentSetting(
-                https_host, https_host, CONTENT_SETTINGS_TYPE_JAVASCRIPT,
-                std::string()));
+      CONTENT_SETTINGS_TYPE_POPUPS, CONTENT_SETTING_BLOCK);
+  EXPECT_EQ(
+      CONTENT_SETTING_BLOCK,
+      host_content_settings_map->GetContentSetting(
+          https_host, https_host, CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
   // Patterns generated for popups used to be domain scoped.
   host_content_settings_map->SetContentSettingCustomScope(
       ContentSettingsPattern::FromURL(https_host),
-      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_JAVASCRIPT,
+      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_POPUPS,
       std::string(), CONTENT_SETTING_ALLOW);
-  EXPECT_EQ(CONTENT_SETTING_ALLOW,
-            host_content_settings_map->GetContentSetting(
-                https_host, https_host, CONTENT_SETTINGS_TYPE_JAVASCRIPT,
-                std::string()));
+  EXPECT_EQ(
+      CONTENT_SETTING_ALLOW,
+      host_content_settings_map->GetContentSetting(
+          https_host, https_host, CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
   // Settings also apply to subdomains.
   EXPECT_EQ(CONTENT_SETTING_ALLOW,
             host_content_settings_map->GetContentSetting(
                 https_host_narrower, https_host_narrower,
-                CONTENT_SETTINGS_TYPE_JAVASCRIPT, std::string()));
+                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
 
-  host_content_settings_map->GetSettingsForOneType(
-      CONTENT_SETTINGS_TYPE_JAVASCRIPT, std::string(), &settings);
+  host_content_settings_map->GetSettingsForOneType(CONTENT_SETTINGS_TYPE_POPUPS,
+                                                   std::string(), &settings);
   // |host_content_settings_map| contains default setting and a domain scoped
   // setting.
   EXPECT_EQ(2U, settings.size());
@@ -1433,52 +1433,19 @@ TEST_F(HostContentSettingsMapTest, MigrateDomainScopedSettings) {
               "https://[*.]example.com:443");
   EXPECT_TRUE(settings[1].primary_pattern.ToString() == "*");
 
-  // Set domain scoped settings for cookies.
-  host_content_settings_map->SetDefaultContentSetting(
-      CONTENT_SETTINGS_TYPE_COOKIES, CONTENT_SETTING_BLOCK);
-  EXPECT_EQ(
-      CONTENT_SETTING_BLOCK,
-      host_content_settings_map->GetContentSetting(
-          http_host, http_host, CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
-  host_content_settings_map->SetContentSettingCustomScope(
-      ContentSettingsPattern::FromURL(http_host),
-      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_COOKIES,
-      std::string(), CONTENT_SETTING_ALLOW);
-  EXPECT_EQ(
-      CONTENT_SETTING_ALLOW,
-      host_content_settings_map->GetContentSetting(
-          http_host, http_host, CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
-  EXPECT_EQ(CONTENT_SETTING_ALLOW,
-            host_content_settings_map->GetContentSetting(
-                http_host_narrower, http_host_narrower,
-                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
-  host_content_settings_map->SetContentSettingCustomScope(
-      ContentSettingsPattern::FromURL(https_host),
-      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_COOKIES,
-      std::string(), CONTENT_SETTING_ALLOW);
-  EXPECT_EQ(CONTENT_SETTING_ALLOW,
-            host_content_settings_map->GetContentSetting(
-                https_host, https_host, CONTENT_SETTINGS_TYPE_COOKIES,
-                std::string()));
-  // Settings also apply to subdomains.
-  EXPECT_EQ(CONTENT_SETTING_ALLOW,
-            host_content_settings_map->GetContentSetting(
-                https_host_narrower, https_host_narrower,
-                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
-
   host_content_settings_map->MigrateDomainScopedSettings(false);
 
   // After migration, settings only affect origins.
   EXPECT_EQ(
       CONTENT_SETTING_ALLOW,
       host_content_settings_map->GetContentSetting(
-          http_host, http_host, CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+          http_host, http_host, CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
   EXPECT_EQ(CONTENT_SETTING_BLOCK,
             host_content_settings_map->GetContentSetting(
                 http_host_narrower, http_host_narrower,
-                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
-  host_content_settings_map->GetSettingsForOneType(CONTENT_SETTINGS_TYPE_POPUPS,
-                                                   std::string(), &settings);
+                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
+  host_content_settings_map->GetSettingsForOneType(
+      CONTENT_SETTINGS_TYPE_COOKIES, std::string(), &settings);
   // |host_content_settings_map| contains default setting and a origin scoped
   // setting.
   EXPECT_EQ(2U, settings.size());
@@ -1486,40 +1453,22 @@ TEST_F(HostContentSettingsMapTest, MigrateDomainScopedSettings) {
               "http://example.com:80");
   EXPECT_TRUE(settings[1].primary_pattern.ToString() == "*");
 
-  EXPECT_EQ(CONTENT_SETTING_ALLOW,
-            host_content_settings_map->GetContentSetting(
-                https_host, https_host, CONTENT_SETTINGS_TYPE_JAVASCRIPT,
-                std::string()));
+  EXPECT_EQ(
+      CONTENT_SETTING_ALLOW,
+      host_content_settings_map->GetContentSetting(
+          https_host, https_host, CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
   EXPECT_EQ(CONTENT_SETTING_BLOCK,
             host_content_settings_map->GetContentSetting(
                 https_host_narrower, https_host_narrower,
-                CONTENT_SETTINGS_TYPE_JAVASCRIPT, std::string()));
-  host_content_settings_map->GetSettingsForOneType(
-      CONTENT_SETTINGS_TYPE_JAVASCRIPT, std::string(), &settings);
+                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+  host_content_settings_map->GetSettingsForOneType(CONTENT_SETTINGS_TYPE_POPUPS,
+                                                   std::string(), &settings);
   // |host_content_settings_map| contains default setting and a origin scoped
   // setting.
   EXPECT_EQ(2U, settings.size());
   EXPECT_TRUE(settings[0].primary_pattern.ToString() ==
               "https://example.com:443");
   EXPECT_TRUE(settings[1].primary_pattern.ToString() == "*");
-
-  // Cookie settings didn't get migrated.
-  EXPECT_EQ(
-      CONTENT_SETTING_ALLOW,
-      host_content_settings_map->GetContentSetting(
-          http_host, http_host, CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
-  EXPECT_EQ(CONTENT_SETTING_ALLOW,
-            host_content_settings_map->GetContentSetting(
-                http_host_narrower, http_host_narrower,
-                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
-  EXPECT_EQ(CONTENT_SETTING_ALLOW,
-            host_content_settings_map->GetContentSetting(
-                https_host, https_host, CONTENT_SETTINGS_TYPE_COOKIES,
-                std::string()));
-  EXPECT_EQ(CONTENT_SETTING_ALLOW,
-            host_content_settings_map->GetContentSetting(
-                https_host_narrower, https_host_narrower,
-                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
 }
 
 // Ensure that migration only happens once upon construction of the HCSM and
@@ -1535,7 +1484,7 @@ TEST_F(HostContentSettingsMapTest, DomainToOriginMigrationStatus) {
 
   {
     DictionaryPrefUpdate update(prefs,
-                                GetPrefName(CONTENT_SETTINGS_TYPE_POPUPS));
+                                GetPrefName(CONTENT_SETTINGS_TYPE_COOKIES));
     base::DictionaryValue* all_settings_dictionary = update.Get();
     ASSERT_TRUE(NULL != all_settings_dictionary);
 
@@ -1546,7 +1495,7 @@ TEST_F(HostContentSettingsMapTest, DomainToOriginMigrationStatus) {
   }
 
   const base::DictionaryValue* all_settings_dictionary =
-      prefs->GetDictionary(GetPrefName(CONTENT_SETTINGS_TYPE_POPUPS));
+      prefs->GetDictionary(GetPrefName(CONTENT_SETTINGS_TYPE_COOKIES));
   const base::DictionaryValue* result = NULL;
   EXPECT_TRUE(all_settings_dictionary->GetDictionaryWithoutPathExpansion(
       "[*.]example.com,*", &result));
@@ -1557,33 +1506,33 @@ TEST_F(HostContentSettingsMapTest, DomainToOriginMigrationStatus) {
 
   // Change default setting to BLOCK.
   host_content_settings_map->SetDefaultContentSetting(
-      CONTENT_SETTINGS_TYPE_POPUPS, CONTENT_SETTING_BLOCK);
+      CONTENT_SETTINGS_TYPE_COOKIES, CONTENT_SETTING_BLOCK);
   EXPECT_EQ(
       CONTENT_SETTING_ALLOW,
       host_content_settings_map->GetContentSetting(
-          http_host, http_host, CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+          http_host, http_host, CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
   // Settings only apply to origins. Migration got executed.
   EXPECT_EQ(CONTENT_SETTING_BLOCK,
             host_content_settings_map->GetContentSetting(
                 http_host_narrower, http_host_narrower,
-                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
 
   GURL https_host("https://example.com/");
   GURL https_host_narrower("https://a.example.com/");
 
   host_content_settings_map->SetContentSettingCustomScope(
       ContentSettingsPattern::FromURL(https_host),
-      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_POPUPS,
+      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_COOKIES,
       std::string(), CONTENT_SETTING_ALLOW);
-  EXPECT_EQ(
-      CONTENT_SETTING_ALLOW,
-      host_content_settings_map->GetContentSetting(
-          https_host, https_host, CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+  EXPECT_EQ(CONTENT_SETTING_ALLOW,
+            host_content_settings_map->GetContentSetting(
+                https_host, https_host, CONTENT_SETTINGS_TYPE_COOKIES,
+                std::string()));
   // Settings apply to subdomains.
   EXPECT_EQ(CONTENT_SETTING_ALLOW,
             host_content_settings_map->GetContentSetting(
                 https_host_narrower, https_host_narrower,
-                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
 
   // Try to do migration again before sync.
   host_content_settings_map->MigrateDomainScopedSettings(false);
@@ -1592,7 +1541,7 @@ TEST_F(HostContentSettingsMapTest, DomainToOriginMigrationStatus) {
   EXPECT_EQ(CONTENT_SETTING_ALLOW,
             host_content_settings_map->GetContentSetting(
                 https_host_narrower, https_host_narrower,
-                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
 
   // Do migration after sync.
   host_content_settings_map->MigrateDomainScopedSettings(true);
@@ -1601,24 +1550,24 @@ TEST_F(HostContentSettingsMapTest, DomainToOriginMigrationStatus) {
   EXPECT_EQ(CONTENT_SETTING_BLOCK,
             host_content_settings_map->GetContentSetting(
                 https_host_narrower, https_host_narrower,
-                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
 
   GURL http1_host("http://google.com/");
   GURL http1_host_narrower("http://a.google.com/");
 
   host_content_settings_map->SetContentSettingCustomScope(
       ContentSettingsPattern::FromURL(http1_host),
-      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_POPUPS,
+      ContentSettingsPattern::Wildcard(), CONTENT_SETTINGS_TYPE_COOKIES,
       std::string(), CONTENT_SETTING_ALLOW);
-  EXPECT_EQ(
-      CONTENT_SETTING_ALLOW,
-      host_content_settings_map->GetContentSetting(
-          http1_host, http1_host, CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+  EXPECT_EQ(CONTENT_SETTING_ALLOW,
+            host_content_settings_map->GetContentSetting(
+                http1_host, http1_host, CONTENT_SETTINGS_TYPE_COOKIES,
+                std::string()));
   // Settings apply to subdomains.
   EXPECT_EQ(CONTENT_SETTING_ALLOW,
             host_content_settings_map->GetContentSetting(
                 http1_host_narrower, http1_host_narrower,
-                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
 
   // Try to do migration again after sync.
   host_content_settings_map->MigrateDomainScopedSettings(true);
@@ -1627,7 +1576,7 @@ TEST_F(HostContentSettingsMapTest, DomainToOriginMigrationStatus) {
   EXPECT_EQ(CONTENT_SETTING_ALLOW,
             host_content_settings_map->GetContentSetting(
                 http1_host_narrower, http1_host_narrower,
-                CONTENT_SETTINGS_TYPE_POPUPS, std::string()));
+                CONTENT_SETTINGS_TYPE_COOKIES, std::string()));
 }
 
 TEST_F(HostContentSettingsMapTest, InvalidPattern) {
diff --git a/chrome/browser/extensions/api/browsing_data/browsing_data_api.cc b/chrome/browser/extensions/api/browsing_data/browsing_data_api.cc
index f32aa58..38e7b50 100644
--- a/chrome/browser/extensions/api/browsing_data/browsing_data_api.cc
+++ b/chrome/browser/extensions/api/browsing_data/browsing_data_api.cc
@@ -315,7 +315,6 @@ void BrowsingDataRemoverFunction::CheckRemovingPluginDataSupported(
 void BrowsingDataRemoverFunction::StartRemoving() {
   BrowsingDataRemover* remover =
       BrowsingDataRemoverFactory::GetForBrowserContext(GetProfile());
-  // TODO(msramek): This restriction is no longer needed. Remove it.
   if (remover->is_removing()) {
     error_ = extension_browsing_data_api_constants::kOneAtATimeError;
     SendResponse(false);
@@ -330,9 +329,9 @@ void BrowsingDataRemoverFunction::StartRemoving() {
   // we've generated above. We can use a raw pointer here, as the browsing data
   // remover is responsible for deleting itself once data removal is complete.
   observer_.Add(remover);
-  remover->RemoveAndReply(
+  remover->Remove(
       BrowsingDataRemover::TimeRange(remove_since_, base::Time::Max()),
-      removal_mask_, origin_type_mask_, this);
+      removal_mask_, origin_type_mask_);
 }
 
 int BrowsingDataRemoverFunction::ParseOriginTypeMask(
diff --git a/chrome/browser/extensions/api/feedback_private/feedback_private_api.cc b/chrome/browser/extensions/api/feedback_private/feedback_private_api.cc
index 8ab8fa9..b9fedd1 100644
--- a/chrome/browser/extensions/api/feedback_private/feedback_private_api.cc
+++ b/chrome/browser/extensions/api/feedback_private/feedback_private_api.cc
@@ -238,6 +238,18 @@ bool FeedbackPrivateSendFeedbackFunction::RunAsync() {
 
   const FeedbackInfo &feedback_info = params->feedback;
 
+  std::string attached_file_uuid;
+  if (feedback_info.attached_file_blob_uuid &&
+      !feedback_info.attached_file_blob_uuid->empty()) {
+    attached_file_uuid = *feedback_info.attached_file_blob_uuid;
+  }
+
+  std::string screenshot_uuid;
+  if (feedback_info.screenshot_blob_uuid &&
+      !feedback_info.screenshot_blob_uuid->empty()) {
+    screenshot_uuid = *feedback_info.screenshot_blob_uuid;
+  }
+
   // Populate feedback data.
   scoped_refptr<FeedbackData> feedback_data(new FeedbackData());
   feedback_data->set_context(GetProfile());
@@ -251,20 +263,18 @@ bool FeedbackPrivateSendFeedbackFunction::RunAsync() {
     feedback_data->set_page_url(*feedback_info.page_url);
   if (feedback_info.email)
     feedback_data->set_user_email(*feedback_info.email);
-  if (feedback_info.trace_id)
-    feedback_data->set_trace_id(*feedback_info.trace_id);
 
-  if (feedback_info.attached_file_blob_uuid &&
-      !feedback_info.attached_file_blob_uuid->empty()) {
+  if (!attached_file_uuid.empty()) {
     feedback_data->set_attached_filename(
         StripFakepath((*feedback_info.attached_file).name));
-    feedback_data->set_attached_file_uuid(
-        *feedback_info.attached_file_blob_uuid);
+    feedback_data->set_attached_file_uuid(attached_file_uuid);
   }
 
-  if (feedback_info.screenshot_blob_uuid &&
-      !feedback_info.screenshot_blob_uuid->empty()) {
-    feedback_data->set_screenshot_uuid(*feedback_info.screenshot_blob_uuid);
+  if (!screenshot_uuid.empty())
+    feedback_data->set_screenshot_uuid(screenshot_uuid);
+
+  if (feedback_info.trace_id) {
+    feedback_data->set_trace_id(*feedback_info.trace_id);
   }
 
   std::unique_ptr<FeedbackData::SystemLogsMap> sys_logs(
diff --git a/chrome/browser/extensions/display_info_provider_chromeos.cc b/chrome/browser/extensions/display_info_provider_chromeos.cc
index c91eb26..bce654e 100644
--- a/chrome/browser/extensions/display_info_provider_chromeos.cc
+++ b/chrome/browser/extensions/display_info_provider_chromeos.cc
@@ -317,21 +317,21 @@ bool ValidateParamsForDisplay(const system_display::DisplayProperties& info,
 
   // Set the display mode.
   if (info.display_mode) {
-    scoped_refptr<ash::DisplayMode> current_mode =
+    ash::DisplayMode current_mode =
         display_manager->GetActiveModeForDisplayId(id);
+    ash::DisplayMode new_mode;
     // Copy properties not set in the UI from the current mode.
-    gfx::Size size(info.display_mode->width_in_native_pixels,
-                   info.display_mode->height_in_native_pixels);
-
-    // NB: info.display_mode is neither an ash::DisplayMode or a
-    // ui::DisplayMode.
-    scoped_refptr<ash::DisplayMode> new_mode(new ash::DisplayMode(
-        size, current_mode->refresh_rate(), current_mode->is_interlaced(),
-        info.display_mode->is_native, info.display_mode->ui_scale,
-        info.display_mode->device_scale_factor));
-
-    if (new_mode->IsEquivalent(current_mode)) {
-      *error = "Display mode matches current mode.";
+    new_mode.refresh_rate = current_mode.refresh_rate;
+    new_mode.interlaced = current_mode.interlaced;
+    // Set properties from the UI properties.
+    new_mode.size.SetSize(info.display_mode->width_in_native_pixels,
+                          info.display_mode->height_in_native_pixels);
+    new_mode.ui_scale = info.display_mode->ui_scale;
+    new_mode.device_scale_factor = info.display_mode->device_scale_factor;
+    new_mode.native = info.display_mode->is_native;
+
+    if (new_mode.IsEquivalent(current_mode)) {
+      *error = "Display mode mataches crrent mode.";
       return false;
     }
 
@@ -355,20 +355,20 @@ bool ValidateParamsForDisplay(const system_display::DisplayProperties& info,
 system_display::DisplayMode GetDisplayMode(
     ash::DisplayManager* display_manager,
     const ash::DisplayInfo& display_info,
-    const scoped_refptr<ash::DisplayMode>& display_mode) {
+    const ash::DisplayMode& display_mode) {
   system_display::DisplayMode result;
 
   bool is_internal = display::Display::HasInternalDisplay() &&
                      display::Display::InternalDisplayId() == display_info.id();
-  gfx::Size size_dip = display_mode->GetSizeInDIP(is_internal);
+  gfx::Size size_dip = display_mode.GetSizeInDIP(is_internal);
   result.width = size_dip.width();
   result.height = size_dip.height();
-  result.width_in_native_pixels = display_mode->size().width();
-  result.height_in_native_pixels = display_mode->size().height();
-  result.ui_scale = display_mode->ui_scale();
-  result.device_scale_factor = display_mode->device_scale_factor();
-  result.is_native = display_mode->native();
-  result.is_selected = display_mode->IsEquivalent(
+  result.width_in_native_pixels = display_mode.size.width();
+  result.height_in_native_pixels = display_mode.size.height();
+  result.ui_scale = display_mode.ui_scale;
+  result.device_scale_factor = display_mode.device_scale_factor;
+  result.is_native = display_mode.native;
+  result.is_selected = display_mode.IsEquivalent(
       display_manager->GetActiveModeForDisplayId(display_info.id()));
   return result;
 }
@@ -516,8 +516,7 @@ void DisplayInfoProviderChromeOS::UpdateDisplayUnitInfoForPlatform(
   unit->overscan.right = overscan_insets.right();
   unit->overscan.bottom = overscan_insets.bottom();
 
-  for (const scoped_refptr<ash::DisplayMode>& display_mode :
-       display_info.display_modes()) {
+  for (const ash::DisplayMode& display_mode : display_info.display_modes()) {
     unit->modes.push_back(
         GetDisplayMode(display_manager, display_info, display_mode));
   }
diff --git a/chrome/browser/extensions/display_info_provider_chromeos_unittest.cc b/chrome/browser/extensions/display_info_provider_chromeos_unittest.cc
index a73993b..757a1c9 100644
--- a/chrome/browser/extensions/display_info_provider_chromeos_unittest.cc
+++ b/chrome/browser/extensions/display_info_provider_chromeos_unittest.cc
@@ -1150,7 +1150,7 @@ TEST_F(DisplayInfoProviderChromeosTest, DisplayMode) {
   // Get the currently active mode and one other mode to switch to.
   int64_t id;
   base::StringToInt64(primary_info.id, &id);
-  scoped_refptr<ash::DisplayMode> active_mode =
+  ash::DisplayMode active_mode =
       GetDisplayManager()->GetActiveModeForDisplayId(id);
   const api::system_display::DisplayMode* cur_mode = nullptr;
   const api::system_display::DisplayMode* other_mode = nullptr;
@@ -1167,13 +1167,12 @@ TEST_F(DisplayInfoProviderChromeosTest, DisplayMode) {
   ASSERT_NE(other_mode, cur_mode);
 
   // Verify that other_mode differs from the active mode.
-  scoped_refptr<ash::DisplayMode> other_mode_ash(new ash::DisplayMode(
-      gfx::Size(other_mode->width_in_native_pixels,
-                other_mode->height_in_native_pixels),
-      active_mode->refresh_rate(), active_mode->is_interlaced(),
-      active_mode->native(), other_mode->ui_scale,
-      other_mode->device_scale_factor));
-  EXPECT_FALSE(active_mode->IsEquivalent(other_mode_ash));
+  ash::DisplayMode other_mode_ash;
+  other_mode_ash.size.SetSize(other_mode->width_in_native_pixels,
+                              other_mode->height_in_native_pixels);
+  other_mode_ash.ui_scale = other_mode->ui_scale;
+  other_mode_ash.device_scale_factor = other_mode->device_scale_factor;
+  EXPECT_FALSE(active_mode.IsEquivalent(other_mode_ash));
 
   // Switch modes.
   api::system_display::DisplayProperties info;
@@ -1187,7 +1186,7 @@ TEST_F(DisplayInfoProviderChromeosTest, DisplayMode) {
 
   // Verify that other_mode now matches the active mode.
   active_mode = GetDisplayManager()->GetActiveModeForDisplayId(id);
-  EXPECT_TRUE(active_mode->IsEquivalent(other_mode_ash));
+  EXPECT_TRUE(active_mode.IsEquivalent(other_mode_ash));
 }
 
 }  // namespace
diff --git a/chrome/browser/google/google_brand.cc b/chrome/browser/google/google_brand.cc
index 073a900..7e07284 100644
--- a/chrome/browser/google/google_brand.cc
+++ b/chrome/browser/google/google_brand.cc
@@ -90,8 +90,6 @@ bool IsOrganic(const std::string& brand) {
   }
 #endif
 
-  // Changes to this list must be mirrored in
-  // chrome/tools/disable_outdated_build_detector/google_update_integration.cc.
   const char* const kBrands[] = {
       "CHCA", "CHCB", "CHCG", "CHCH", "CHCI", "CHCJ", "CHCK", "CHCL",
       "CHFO", "CHFT", "CHHS", "CHHM", "CHMA", "CHMB", "CHME", "CHMF",
diff --git a/chrome/browser/gpu/gl_string_manager.cc b/chrome/browser/gpu/gl_string_manager.cc
index 9df794c..5b8ce27 100644
--- a/chrome/browser/gpu/gl_string_manager.cc
+++ b/chrome/browser/gpu/gl_string_manager.cc
@@ -14,17 +14,12 @@
 #include "gpu/config/gpu_switches.h"
 
 // static
-void GpuProfileCache::RegisterPrefs(PrefRegistrySimple* registry) {
+void GLStringManager::RegisterPrefs(PrefRegistrySimple* registry) {
   registry->RegisterStringPref(prefs::kGLVendorString, std::string());
   registry->RegisterStringPref(prefs::kGLRendererString, std::string());
   registry->RegisterStringPref(prefs::kGLVersionString, std::string());
 }
 
-// static
-GpuProfileCache* GpuProfileCache::Create() {
-  return new GLStringManager();
-}
-
 GLStringManager::GLStringManager() {
 }
 
diff --git a/chrome/browser/gpu/gl_string_manager.h b/chrome/browser/gpu/gl_string_manager.h
index c7ddb13..23d5d47 100644
--- a/chrome/browser/gpu/gl_string_manager.h
+++ b/chrome/browser/gpu/gl_string_manager.h
@@ -9,17 +9,19 @@
 
 #include "base/compiler_specific.h"
 #include "base/macros.h"
-#include "chrome/browser/gpu/gpu_profile_cache.h"
 #include "content/public/browser/gpu_data_manager_observer.h"
 
-class GLStringManager : public GpuProfileCache,
-                        public content::GpuDataManagerObserver {
+class PrefRegistrySimple;
+
+class GLStringManager : public content::GpuDataManagerObserver {
  public:
+  static void RegisterPrefs(PrefRegistrySimple* registry);
+
   GLStringManager();
   ~GLStringManager() override;
 
-  // GpuProfileCache.
-  void Initialize() override;
+  // Get cached GL strings in local state and send them to GpuDataManager.
+  void Initialize();
 
   // content::GpuDataManagerObserver
   void OnGpuInfoUpdate() override;
diff --git a/chrome/browser/gpu/gpu_driver_info_manager_android.cc b/chrome/browser/gpu/gpu_driver_info_manager_android.cc
deleted file mode 100644
index d8f64ac..0000000
--- a/chrome/browser/gpu/gpu_driver_info_manager_android.cc
+++ /dev/null
@@ -1,100 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/browser/gpu/gpu_driver_info_manager_android.h"
-
-#include "base/android/build_info.h"
-#include "base/command_line.h"
-#include "build/build_config.h"
-#include "chrome/browser/browser_process.h"
-#include "chrome/common/pref_names.h"
-#include "components/prefs/pref_registry_simple.h"
-#include "components/prefs/pref_service.h"
-#include "content/public/browser/gpu_data_manager.h"
-#include "gpu/config/gpu_info_collector.h"
-
-using base::android::BuildInfo;
-
-// static
-void GpuProfileCache::RegisterPrefs(PrefRegistrySimple* registry) {
-  registry->RegisterStringPref(prefs::kGLVendorString, std::string());
-  registry->RegisterStringPref(prefs::kGLVersionString, std::string());
-  registry->RegisterStringPref(prefs::kGLRendererString, std::string());
-  registry->RegisterStringPref(prefs::kGLExtensionsString, std::string());
-  registry->RegisterStringPref(prefs::kGpuDriverInfoMaxSamples, std::string());
-  registry->RegisterIntegerPref(
-      prefs::kGpuDriverInfoResetNotificationStrategy, 0);
-  registry->RegisterStringPref(
-      prefs::kGpuDriverInfoShaderVersion, std::string());
-  registry->RegisterStringPref(
-      prefs::kGpuDriverInfoBuildFingerPrint, std::string());
-}
-
-// static
-GpuProfileCache* GpuProfileCache::Create() {
-  return new GpuDriverInfoManager();
-}
-
-GpuDriverInfoManager::GpuDriverInfoManager() {}
-
-GpuDriverInfoManager::~GpuDriverInfoManager() {}
-
-void GpuDriverInfoManager::Initialize() {
-  PrefService* local_state = g_browser_process->local_state();
-  if (!local_state)
-    return;
-
-  std::string build_finger_print =
-      local_state->GetString(prefs::kGpuDriverInfoBuildFingerPrint);
-  if (build_finger_print.empty() || build_finger_print !=
-      BuildInfo::GetInstance()->android_build_fp()) {
-    content::GpuDataManager::GetInstance()->AddObserver(this);
-    return;
-  }
-
-  gpu::GPUInfo gpu_info;
-  gpu_info.gl_vendor = local_state->GetString(prefs::kGLVendorString);
-  gpu_info.gl_version = local_state->GetString(prefs::kGLVersionString);
-  gpu_info.gl_renderer = local_state->GetString(prefs::kGLRendererString);
-  gpu_info.gl_extensions = local_state->GetString(
-      prefs::kGLExtensionsString);
-  gpu_info.max_msaa_samples = local_state->GetString(
-      prefs::kGpuDriverInfoMaxSamples);
-  gpu_info.gl_reset_notification_strategy = local_state->GetInteger(
-      prefs::kGpuDriverInfoResetNotificationStrategy);
-  std::string shader_version = local_state->GetString(
-      prefs::kGpuDriverInfoShaderVersion);
-  gpu_info.pixel_shader_version = shader_version;
-  gpu_info.vertex_shader_version = shader_version;
-  gpu_info.can_lose_context = false;
-  gpu_info.machine_model_name = BuildInfo::GetInstance()->model();
-
-  gpu::CollectInfoResult result = gpu::CollectDriverInfoGL(&gpu_info);
-  gpu_info.basic_info_state = result;
-  gpu_info.context_info_state = result;
-  content::GpuDataManager::GetInstance()->SetGpuInfo(gpu_info);
-}
-
-void GpuDriverInfoManager::OnGpuInfoUpdate() {
-  PrefService* local_state = g_browser_process->local_state();
-  if (!local_state)
-    return;
-
-  gpu::GPUInfo gpu_info = content::GpuDataManager::GetInstance()->GetGPUInfo();
-  local_state->SetString(prefs::kGLVendorString, gpu_info.gl_vendor);
-  local_state->SetString(prefs::kGLVersionString, gpu_info.gl_version);
-  local_state->SetString(prefs::kGLRendererString, gpu_info.gl_renderer);
-  local_state->SetString(
-      prefs::kGLExtensionsString, gpu_info.gl_extensions);
-  local_state->SetString(
-      prefs::kGpuDriverInfoMaxSamples, gpu_info.max_msaa_samples);
-  local_state->SetInteger(prefs::kGpuDriverInfoResetNotificationStrategy,
-                          gpu_info.gl_reset_notification_strategy);
-  local_state->SetString(prefs::kGpuDriverInfoShaderVersion,
-                         gpu_info.pixel_shader_version);
-  local_state->SetString(prefs::kGpuDriverInfoBuildFingerPrint,
-                         BuildInfo::GetInstance()->android_build_fp());
-  content::GpuDataManager::GetInstance()->RemoveObserver(this);
-}
-
diff --git a/chrome/browser/gpu/gpu_driver_info_manager_android.h b/chrome/browser/gpu/gpu_driver_info_manager_android.h
deleted file mode 100644
index 66e17c3..0000000
--- a/chrome/browser/gpu/gpu_driver_info_manager_android.h
+++ /dev/null
@@ -1,35 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_BROWSER_GPU_GPU_DRIVER_INFO_MANAGER_ANDROID_H_
-#define CHROME_BROWSER_GPU_GPU_DRIVER_INFO_MANAGER_ANDROID_H_
-
-#include <string>
-
-#include "base/compiler_specific.h"
-#include "base/macros.h"
-#include "chrome/browser/gpu/gpu_profile_cache.h"
-#include "content/public/browser/gpu_data_manager_observer.h"
-
-// Class for managing the GPU driver information stored in profile.
-// On Android, collecting GPU driver information is very expensive as it needs
-// to create a temporary context. Caching the information in profile saves a lot
-// of start up cost.
-class GpuDriverInfoManager : public GpuProfileCache,
-                             public content::GpuDataManagerObserver {
- public:
-  GpuDriverInfoManager();
-  ~GpuDriverInfoManager() override;
-
-  // GpuProfileCache.
-  void Initialize() override;
-
-  // content::GpuDataManagerObserver
-  void OnGpuInfoUpdate() override;
-
- private:
-  DISALLOW_COPY_AND_ASSIGN(GpuDriverInfoManager);
-};
-
-#endif  // CHROME_BROWSER_GPU_GPU_DRIVER_INFO_MANAGER_ANDROID_H_
diff --git a/chrome/browser/gpu/gpu_profile_cache.h b/chrome/browser/gpu/gpu_profile_cache.h
deleted file mode 100644
index d272b06..0000000
--- a/chrome/browser/gpu/gpu_profile_cache.h
+++ /dev/null
@@ -1,24 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_BROWSER_GPU_GPU_PROFILE_CACHE_H_
-#define CHROME_BROWSER_GPU_GPU_PROFILE_CACHE_H_
-
-class PrefRegistrySimple;
-
-// Class for caching and initializing GPU data by storing them in local state.
-class GpuProfileCache {
- public:
-  static void RegisterPrefs(PrefRegistrySimple* registry);
-
-  static GpuProfileCache* Create();
-
-  virtual ~GpuProfileCache() {}
-
-  // Get cached gpu data in local state and send them to GpuDataManager.
-  virtual void Initialize() = 0;
-};
-
-#endif  // CHROME_BROWSER_GPU_GPU_PROFILE_CACHE_H_
-
diff --git a/chrome/browser/history/android/android_provider_backend_unittest.cc b/chrome/browser/history/android/android_provider_backend_unittest.cc
index c00d7c3..e572ad0 100644
--- a/chrome/browser/history/android/android_provider_backend_unittest.cc
+++ b/chrome/browser/history/android/android_provider_backend_unittest.cc
@@ -74,8 +74,7 @@ class AndroidProviderBackendDelegate : public HistoryBackend::Delegate {
  public:
   AndroidProviderBackendDelegate() {}
 
-  void NotifyProfileError(sql::InitStatus init_status,
-                          const std::string& diagnostics) override {}
+  void NotifyProfileError(sql::InitStatus init_status) override {}
   void SetInMemoryBackend(
       std::unique_ptr<InMemoryHistoryBackend> backend) override {}
   void NotifyFaviconsChanged(const std::set<GURL>& page_urls,
diff --git a/chrome/browser/history/chrome_history_client.cc b/chrome/browser/history/chrome_history_client.cc
index 378853d..32cafc1 100644
--- a/chrome/browser/history/chrome_history_client.cc
+++ b/chrome/browser/history/chrome_history_client.cc
@@ -63,13 +63,11 @@ bool ChromeHistoryClient::CanAddURL(const GURL& url) {
   return CanAddURLToHistory(url);
 }
 
-void ChromeHistoryClient::NotifyProfileError(sql::InitStatus init_status,
-                                             const std::string& diagnostics) {
-  ShowProfileErrorDialog(PROFILE_ERROR_HISTORY,
-                         (init_status == sql::INIT_FAILURE)
-                             ? IDS_COULDNT_OPEN_PROFILE_ERROR
-                             : IDS_PROFILE_TOO_NEW_ERROR,
-                         diagnostics);
+void ChromeHistoryClient::NotifyProfileError(sql::InitStatus init_status) {
+  ShowProfileErrorDialog(
+      PROFILE_ERROR_HISTORY,
+      (init_status == sql::INIT_FAILURE) ?
+      IDS_COULDNT_OPEN_PROFILE_ERROR : IDS_PROFILE_TOO_NEW_ERROR);
 }
 
 std::unique_ptr<history::HistoryBackendClient>
diff --git a/chrome/browser/history/chrome_history_client.h b/chrome/browser/history/chrome_history_client.h
index e274eca..66c0da3 100644
--- a/chrome/browser/history/chrome_history_client.h
+++ b/chrome/browser/history/chrome_history_client.h
@@ -34,8 +34,7 @@ class ChromeHistoryClient : public history::HistoryClient,
       history::HistoryService* history_service) override;
   void Shutdown() override;
   bool CanAddURL(const GURL& url) override;
-  void NotifyProfileError(sql::InitStatus init_status,
-                          const std::string& diagnostics) override;
+  void NotifyProfileError(sql::InitStatus init_status) override;
   std::unique_ptr<history::HistoryBackendClient> CreateBackendClient() override;
 
  private:
diff --git a/chrome/browser/net/sdch_browsertest.cc b/chrome/browser/net/sdch_browsertest.cc
index 6a0c05c..eda2f9f 100644
--- a/chrome/browser/net/sdch_browsertest.cc
+++ b/chrome/browser/net/sdch_browsertest.cc
@@ -408,9 +408,8 @@ class SdchBrowserTest : public InProcessBrowserTest,
     BrowsingDataRemover* remover =
         BrowsingDataRemoverFactory::GetForBrowserContext(browser()->profile());
     BrowsingDataRemoverCompletionObserver completion_observer(remover);
-    remover->RemoveAndReply(
-        BrowsingDataRemover::Period(browsing_data::LAST_HOUR), remove_mask,
-        BrowsingDataHelper::UNPROTECTED_WEB, &completion_observer);
+    remover->Remove(BrowsingDataRemover::Period(browsing_data::LAST_HOUR),
+                    remove_mask, BrowsingDataHelper::UNPROTECTED_WEB);
     completion_observer.BlockUntilCompletion();
   }
 
diff --git a/chrome/browser/ntp_snippets/bookmark_last_visit_updater.cc b/chrome/browser/ntp_snippets/bookmark_last_visit_updater.cc
deleted file mode 100644
index 001e8e2..0000000
--- a/chrome/browser/ntp_snippets/bookmark_last_visit_updater.cc
+++ /dev/null
@@ -1,34 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/browser/ntp_snippets/bookmark_last_visit_updater.h"
-
-#include "components/ntp_snippets/bookmarks/bookmark_last_visit_utils.h"
-#include "content/public/browser/navigation_handle.h"
-
-DEFINE_WEB_CONTENTS_USER_DATA_KEY(BookmarkLastVisitUpdater);
-
-BookmarkLastVisitUpdater::~BookmarkLastVisitUpdater() {}
-
-// static
-void BookmarkLastVisitUpdater::CreateForWebContentsWithBookmarkModel(
-    content::WebContents* web_contents,
-    bookmarks::BookmarkModel* bookmark_model) {
-  web_contents->SetUserData(UserDataKey(), new BookmarkLastVisitUpdater(
-                                               web_contents, bookmark_model));
-}
-
-BookmarkLastVisitUpdater::BookmarkLastVisitUpdater(
-    content::WebContents* web_contents,
-    bookmarks::BookmarkModel* bookmark_model)
-    : content::WebContentsObserver(web_contents),
-      bookmark_model_(bookmark_model) {}
-
-void BookmarkLastVisitUpdater::DidStartNavigation(
-    content::NavigationHandle* navigation_handle) {
-  if (!navigation_handle->IsInMainFrame() || navigation_handle->IsErrorPage())
-    return;
-  ntp_snippets::UpdateBookmarkOnURLVisitedInMainFrame(
-      bookmark_model_, navigation_handle->GetURL());
-}
diff --git a/chrome/browser/ntp_snippets/bookmark_last_visit_updater.h b/chrome/browser/ntp_snippets/bookmark_last_visit_updater.h
deleted file mode 100644
index ff9aa9b..0000000
--- a/chrome/browser/ntp_snippets/bookmark_last_visit_updater.h
+++ /dev/null
@@ -1,50 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_BROWSER_NTP_SNIPPETS_BOOKMARK_LAST_VISIT_UPDATER_H_
-#define CHROME_BROWSER_NTP_SNIPPETS_BOOKMARK_LAST_VISIT_UPDATER_H_
-
-#include <memory>
-
-#include "base/macros.h"
-#include "content/public/browser/web_contents_observer.h"
-#include "content/public/browser/web_contents_user_data.h"
-
-namespace bookmarks {
-class BookmarkModel;
-}  // namespace bookmarks
-
-namespace content {
-class NavigationHandle;
-class WebContents;
-}  // namespace content
-
-// A bridge class between platform-specific content::WebContentsObserver and the
-// generic function ntp_snippets::UpdateBookmarkOnURLVisitedInMainFrame().
-class BookmarkLastVisitUpdater
-    : public content::WebContentsObserver,
-      public content::WebContentsUserData<BookmarkLastVisitUpdater> {
- public:
-  ~BookmarkLastVisitUpdater() override;
-
-  static void CreateForWebContentsWithBookmarkModel(
-      content::WebContents* web_contents,
-      bookmarks::BookmarkModel* bookmark_model);
-
- private:
-  friend class content::WebContentsUserData<BookmarkLastVisitUpdater>;
-
-  BookmarkLastVisitUpdater(content::WebContents* web_contents,
-                           bookmarks::BookmarkModel* bookmark_model);
-
-  // Overridden from content::WebContentsObserver:
-  void DidStartNavigation(
-      content::NavigationHandle* navigation_handle) override;
-
-  bookmarks::BookmarkModel* bookmark_model_;
-
-  DISALLOW_COPY_AND_ASSIGN(BookmarkLastVisitUpdater);
-};
-
-#endif  // CHROME_BROWSER_NTP_SNIPPETS_BOOKMARK_LAST_VISIT_UPDATER_H_
diff --git a/chrome/browser/ntp_snippets/content_suggestions_service_factory.cc b/chrome/browser/ntp_snippets/content_suggestions_service_factory.cc
index 0dc8e0a..cdb2895 100644
--- a/chrome/browser/ntp_snippets/content_suggestions_service_factory.cc
+++ b/chrome/browser/ntp_snippets/content_suggestions_service_factory.cc
@@ -8,7 +8,6 @@
 #include "base/files/file_path.h"
 #include "base/memory/ptr_util.h"
 #include "base/memory/singleton.h"
-#include "chrome/browser/bookmarks/bookmark_model_factory.h"
 #include "chrome/browser/browser_process.h"
 #include "chrome/browser/profiles/profile.h"
 #include "chrome/browser/search/suggestions/image_decoder_impl.h"
@@ -16,12 +15,11 @@
 #include "chrome/browser/signin/profile_oauth2_token_service_factory.h"
 #include "chrome/browser/signin/signin_manager_factory.h"
 #include "chrome/common/channel_info.h"
-#include "components/bookmarks/browser/bookmark_model.h"
+#include "chrome/common/pref_names.h"
 #include "components/image_fetcher/image_decoder.h"
 #include "components/image_fetcher/image_fetcher.h"
 #include "components/image_fetcher/image_fetcher_impl.h"
 #include "components/keyed_service/content/browser_context_dependency_manager.h"
-#include "components/ntp_snippets/bookmarks/bookmark_suggestions_provider.h"
 #include "components/ntp_snippets/content_suggestions_service.h"
 #include "components/ntp_snippets/features.h"
 #include "components/ntp_snippets/ntp_snippets_constants.h"
@@ -52,10 +50,8 @@ using offline_pages::OfflinePageModel;
 using offline_pages::OfflinePageModelFactory;
 #endif  // OS_ANDROID
 
-using bookmarks::BookmarkModel;
 using content::BrowserThread;
 using image_fetcher::ImageFetcherImpl;
-using ntp_snippets::BookmarkSuggestionsProvider;
 using ntp_snippets::ContentSuggestionsService;
 using ntp_snippets::NTPSnippetsDatabase;
 using ntp_snippets::NTPSnippetsFetcher;
@@ -84,7 +80,6 @@ ContentSuggestionsServiceFactory::ContentSuggestionsServiceFactory()
     : BrowserContextKeyedServiceFactory(
           "ContentSuggestionsService",
           BrowserContextDependencyManager::GetInstance()) {
-  DependsOn(BookmarkModelFactory::GetInstance());
 #if defined(OS_ANDROID)
   DependsOn(OfflinePageModelFactory::GetInstance());
 #endif  // OS_ANDROID
@@ -109,8 +104,8 @@ KeyedService* ContentSuggestionsServiceFactory::BuildServiceInstanceFor(
   if (state == State::DISABLED)
     return service;
 
+// Create the OfflinePageSuggestionsProvider.
 #if defined(OS_ANDROID)
-  // Create the OfflinePageSuggestionsProvider.
   if (base::FeatureList::IsEnabled(
           chrome::android::kNTPOfflinePageSuggestionsFeature)) {
     OfflinePageModel* offline_page_model =
@@ -124,18 +119,6 @@ KeyedService* ContentSuggestionsServiceFactory::BuildServiceInstanceFor(
   }
 #endif  // OS_ANDROID
 
-  // Create the BookmarkSuggestionsProvider.
-  if (base::FeatureList::IsEnabled(
-          ntp_snippets::kBookmarkSuggestionsFeature)) {
-    // TODO(pke): GetForBrowserContext
-    BookmarkModel* bookmark_model =
-        BookmarkModelFactory::GetForProfile(profile);
-    std::unique_ptr<BookmarkSuggestionsProvider> bookmark_suggestions_provider =
-        base::MakeUnique<BookmarkSuggestionsProvider>(
-            service, service->category_factory(), bookmark_model);
-    service->RegisterProvider(std::move(bookmark_suggestions_provider));
-  }
-
   // Create the NTPSnippetsService (articles provider).
   SigninManagerBase* signin_manager =
       SigninManagerFactory::GetForProfile(profile);
diff --git a/chrome/browser/password_manager/native_backend_gnome_x.cc b/chrome/browser/password_manager/native_backend_gnome_x.cc
index 0199311..9d26285 100644
--- a/chrome/browser/password_manager/native_backend_gnome_x.cc
+++ b/chrome/browser/password_manager/native_backend_gnome_x.cc
@@ -4,6 +4,11 @@
 
 #include "chrome/browser/password_manager/native_backend_gnome_x.h"
 
+#include <dlfcn.h>
+#include <gnome-keyring.h>
+#include <stddef.h>
+#include <stdint.h>
+
 #include <limits>
 #include <map>
 #include <memory>
@@ -37,6 +42,79 @@ namespace {
 const int kMaxPossibleTimeTValue = std::numeric_limits<int>::max();
 }
 
+decltype(&::gnome_keyring_is_available)
+    GnomeKeyringLoader::gnome_keyring_is_available_ptr;
+decltype(&::gnome_keyring_store_password)
+    GnomeKeyringLoader::gnome_keyring_store_password_ptr;
+decltype(&::gnome_keyring_delete_password)
+    GnomeKeyringLoader::gnome_keyring_delete_password_ptr;
+decltype(&::gnome_keyring_find_items)
+    GnomeKeyringLoader::gnome_keyring_find_items_ptr;
+decltype(&::gnome_keyring_result_to_message)
+    GnomeKeyringLoader::gnome_keyring_result_to_message_ptr;
+decltype(&::gnome_keyring_attribute_list_free)
+    GnomeKeyringLoader::gnome_keyring_attribute_list_free_ptr;
+decltype(&::gnome_keyring_attribute_list_new)
+    GnomeKeyringLoader::gnome_keyring_attribute_list_new_ptr;
+decltype(&::gnome_keyring_attribute_list_append_string)
+    GnomeKeyringLoader::gnome_keyring_attribute_list_append_string_ptr;
+decltype(&::gnome_keyring_attribute_list_append_uint32)
+    GnomeKeyringLoader::gnome_keyring_attribute_list_append_uint32_ptr;
+
+bool GnomeKeyringLoader::keyring_loaded = false;
+
+const GnomeKeyringLoader::FunctionInfo GnomeKeyringLoader::functions[] = {
+    {"gnome_keyring_is_available",
+     reinterpret_cast<void**>(&gnome_keyring_is_available_ptr)},
+    {"gnome_keyring_store_password",
+     reinterpret_cast<void**>(&gnome_keyring_store_password_ptr)},
+    {"gnome_keyring_delete_password",
+     reinterpret_cast<void**>(&gnome_keyring_delete_password_ptr)},
+    {"gnome_keyring_find_items",
+     reinterpret_cast<void**>(&gnome_keyring_find_items_ptr)},
+    {"gnome_keyring_result_to_message",
+     reinterpret_cast<void**>(&gnome_keyring_result_to_message_ptr)},
+    {"gnome_keyring_attribute_list_free",
+     reinterpret_cast<void**>(&gnome_keyring_attribute_list_free_ptr)},
+    {"gnome_keyring_attribute_list_new",
+     reinterpret_cast<void**>(&gnome_keyring_attribute_list_new_ptr)},
+    {"gnome_keyring_attribute_list_append_string",
+     reinterpret_cast<void**>(&gnome_keyring_attribute_list_append_string_ptr)},
+    {"gnome_keyring_attribute_list_append_uint32",
+     reinterpret_cast<void**>(
+         &gnome_keyring_attribute_list_append_uint32_ptr)}};
+
+/* Load the library and initialize the function pointers. */
+bool GnomeKeyringLoader::LoadGnomeKeyring() {
+  if (keyring_loaded)
+    return true;
+
+  void* handle = dlopen("libgnome-keyring.so.0", RTLD_NOW | RTLD_GLOBAL);
+  if (!handle) {
+    // We wanted to use GNOME Keyring, but we couldn't load it. Warn, because
+    // either the user asked for this, or we autodetected it incorrectly. (Or
+    // the system has broken libraries, which is also good to warn about.)
+    LOG(WARNING) << "Could not load libgnome-keyring.so.0: " << dlerror();
+    return false;
+  }
+
+  for (size_t i = 0; i < arraysize(functions); ++i) {
+    dlerror();
+    *functions[i].pointer = dlsym(handle, functions[i].name);
+    const char* error = dlerror();
+    if (error) {
+      LOG(ERROR) << "Unable to load symbol "
+                 << functions[i].name << ": " << error;
+      dlclose(handle);
+      return false;
+    }
+  }
+
+  keyring_loaded = true;
+  // We leak the library handle. That's OK: this function is called only once.
+  return true;
+}
+
 namespace {
 
 const char kGnomeKeyringAppString[] = "chrome";
diff --git a/chrome/browser/password_manager/native_backend_gnome_x.h b/chrome/browser/password_manager/native_backend_gnome_x.h
index 63edd8b..5d28693 100644
--- a/chrome/browser/password_manager/native_backend_gnome_x.h
+++ b/chrome/browser/password_manager/native_backend_gnome_x.h
@@ -5,6 +5,18 @@
 #ifndef CHROME_BROWSER_PASSWORD_MANAGER_NATIVE_BACKEND_GNOME_X_H_
 #define CHROME_BROWSER_PASSWORD_MANAGER_NATIVE_BACKEND_GNOME_X_H_
 
+// libgnome-keyring has been deprecated in favor of libsecret.
+// See: https://mail.gnome.org/archives/commits-list/2013-October/msg08876.html
+//
+// The define below turns off the deprecations, in order to avoid build
+// failures with Gnome 3.12. When we move to libsecret, the define can be
+// removed, together with the include below it.
+//
+// The porting is tracked in http://crbug.com/355223
+#define GNOME_KEYRING_DEPRECATED
+#define GNOME_KEYRING_DEPRECATED_FOR(x)
+#include <gnome-keyring.h>
+
 #include <string>
 
 #include "base/compiler_specific.h"
@@ -14,12 +26,55 @@
 #include "chrome/browser/password_manager/password_store_factory.h"
 #include "chrome/browser/password_manager/password_store_x.h"
 #include "chrome/browser/profiles/profile.h"
-#include "components/os_crypt/keyring_util_linux.h"
 
 namespace autofill {
 struct PasswordForm;
 }
 
+// Many of the gnome_keyring_* functions use variable arguments, which makes
+// them difficult if not impossible to truly wrap in C. Therefore, we use
+// appropriately-typed function pointers and scoping to make the fact that we
+// might be dynamically loading the library almost invisible. As a bonus, we
+// also get a simple way to mock the library for testing. Classes that inherit
+// from GnomeKeyringLoader will use its versions of the gnome_keyring_*
+// functions. Note that it has only static fields.
+class GnomeKeyringLoader {
+ protected:
+  static bool LoadGnomeKeyring();
+
+  // Declare the actual function pointers that we'll use in client code.
+  static decltype(&::gnome_keyring_is_available) gnome_keyring_is_available_ptr;
+  static decltype(
+      &::gnome_keyring_store_password) gnome_keyring_store_password_ptr;
+  static decltype(
+      &::gnome_keyring_delete_password) gnome_keyring_delete_password_ptr;
+  static decltype(&::gnome_keyring_find_items) gnome_keyring_find_items_ptr;
+  static decltype(
+      &::gnome_keyring_result_to_message) gnome_keyring_result_to_message_ptr;
+  static decltype(&::gnome_keyring_attribute_list_free)
+      gnome_keyring_attribute_list_free_ptr;
+  static decltype(
+      &::gnome_keyring_attribute_list_new) gnome_keyring_attribute_list_new_ptr;
+  static decltype(&::gnome_keyring_attribute_list_append_string)
+      gnome_keyring_attribute_list_append_string_ptr;
+  static decltype(&::gnome_keyring_attribute_list_append_uint32)
+      gnome_keyring_attribute_list_append_uint32_ptr;
+  // We also use gnome_keyring_attribute_list_index(), which is a macro and
+  // can't be referenced.
+
+  // Set to true if LoadGnomeKeyring() has already succeeded.
+  static bool keyring_loaded;
+
+ private:
+  struct FunctionInfo {
+    const char* name;
+    void** pointer;
+  };
+
+  // Make it easy to initialize the function pointers in LoadGnomeKeyring().
+  static const FunctionInfo functions[];
+};
+
 // NativeBackend implementation using GNOME Keyring.
 class NativeBackendGnome : public PasswordStoreX::NativeBackend,
                            public GnomeKeyringLoader {
diff --git a/chrome/browser/prefs/browser_prefs.cc b/chrome/browser/prefs/browser_prefs.cc
index 4e445d4..06723d0 100644
--- a/chrome/browser/prefs/browser_prefs.cc
+++ b/chrome/browser/prefs/browser_prefs.cc
@@ -24,8 +24,8 @@
 #include "chrome/browser/external_protocol/external_protocol_handler.h"
 #include "chrome/browser/first_run/first_run.h"
 #include "chrome/browser/geolocation/geolocation_prefs.h"
+#include "chrome/browser/gpu/gl_string_manager.h"
 #include "chrome/browser/gpu/gpu_mode_manager.h"
-#include "chrome/browser/gpu/gpu_profile_cache.h"
 #include "chrome/browser/intranet_redirect_detector.h"
 #include "chrome/browser/io_thread.h"
 #include "chrome/browser/media/media_capture_devices_dispatcher.h"
@@ -334,8 +334,8 @@ void RegisterLocalState(PrefRegistrySimple* registry) {
   ExternalProtocolHandler::RegisterPrefs(registry);
   flags_ui::PrefServiceFlagsStorage::RegisterPrefs(registry);
   geolocation::RegisterPrefs(registry);
+  GLStringManager::RegisterPrefs(registry);
   GpuModeManager::RegisterPrefs(registry);
-  GpuProfileCache::RegisterPrefs(registry);
   IntranetRedirectDetector::RegisterPrefs(registry);
   IOThread::RegisterPrefs(registry);
   network_time::NetworkTimeTracker::RegisterPrefs(registry);
diff --git a/chrome/browser/prefs/chrome_pref_service_factory.cc b/chrome/browser/prefs/chrome_pref_service_factory.cc
index d984a44..66d0f59 100644
--- a/chrome/browser/prefs/chrome_pref_service_factory.cc
+++ b/chrome/browser/prefs/chrome_pref_service_factory.cc
@@ -57,7 +57,6 @@
 #include "content/public/browser/browser_context.h"
 #include "content/public/browser/browser_thread.h"
 #include "grit/browser_resources.h"
-#include "sql/error_delegate_util.h"
 #include "ui/base/resource/resource_bundle.h"
 
 #if defined(ENABLE_EXTENSIONS)
@@ -354,8 +353,7 @@ GetTrackingConfiguration() {
 }
 
 // Shows notifications which correspond to PersistentPrefStore's reading errors.
-void HandleReadError(const base::FilePath& pref_filename,
-                     PersistentPrefStore::PrefReadError error) {
+void HandleReadError(PersistentPrefStore::PrefReadError error) {
   // Sample the histogram also for the successful case in order to get a
   // baseline on the success rate in addition to the error distribution.
   UMA_HISTOGRAM_ENUMERATION("PrefService.ReadError", error,
@@ -374,11 +372,10 @@ void HandleReadError(const base::FilePath& pref_filename,
     }
 
     if (message_id) {
-      BrowserThread::PostTask(
-          BrowserThread::UI, FROM_HERE,
-          base::Bind(&ShowProfileErrorDialog, PROFILE_ERROR_PREFERENCES,
-                     message_id,
-                     sql::GetCorruptFileDiagnosticsInfo(pref_filename)));
+      BrowserThread::PostTask(BrowserThread::UI, FROM_HERE,
+                              base::Bind(&ShowProfileErrorDialog,
+                                         PROFILE_ERROR_PREFERENCES,
+                                         message_id));
     }
 #else
     // On ChromeOS error screen with message about broken local state
@@ -416,13 +413,13 @@ std::unique_ptr<ProfilePrefStoreManager> CreateProfilePrefStoreManager(
       seed, device_id, g_browser_process->local_state()));
 }
 
-void PrepareFactory(syncable_prefs::PrefServiceSyncableFactory* factory,
-                    const base::FilePath& pref_filename,
-                    policy::PolicyService* policy_service,
-                    SupervisedUserSettingsService* supervised_user_settings,
-                    scoped_refptr<PersistentPrefStore> user_pref_store,
-                    const scoped_refptr<PrefStore>& extension_prefs,
-                    bool async) {
+void PrepareFactory(
+    syncable_prefs::PrefServiceSyncableFactory* factory,
+    policy::PolicyService* policy_service,
+    SupervisedUserSettingsService* supervised_user_settings,
+    scoped_refptr<PersistentPrefStore> user_pref_store,
+    const scoped_refptr<PrefStore>& extension_prefs,
+    bool async) {
   policy::BrowserPolicyConnector* policy_connector =
       g_browser_process->browser_policy_connector();
   factory->SetManagedPolicies(policy_service, policy_connector);
@@ -441,7 +438,7 @@ void PrepareFactory(syncable_prefs::PrefServiceSyncableFactory* factory,
   factory->set_extension_prefs(extension_prefs);
   factory->set_command_line_prefs(make_scoped_refptr(
       new CommandLinePrefStore(base::CommandLine::ForCurrentProcess())));
-  factory->set_read_error_callback(base::Bind(&HandleReadError, pref_filename));
+  factory->set_read_error_callback(base::Bind(&HandleReadError));
   factory->set_user_prefs(user_pref_store);
   factory->SetPrefModelAssociatorClient(
       ChromePrefModelAssociatorClient::GetInstance());
@@ -472,7 +469,7 @@ std::unique_ptr<PrefService> CreateLocalState(
     const scoped_refptr<PrefRegistry>& pref_registry,
     bool async) {
   syncable_prefs::PrefServiceSyncableFactory factory;
-  PrepareFactory(&factory, pref_filename, policy_service,
+  PrepareFactory(&factory, policy_service,
                  NULL,  // supervised_user_settings
                  new JsonPrefStore(pref_filename, pref_io_task_runner,
                                    std::unique_ptr<PrefFilter>()),
@@ -509,8 +506,11 @@ std::unique_ptr<syncable_prefs::PrefServiceSyncable> CreateProfilePrefs(
           ->CreateProfilePrefStore(pref_io_task_runner,
                                    start_sync_flare_for_prefs,
                                    validation_delegate));
-  PrepareFactory(&factory, profile_path, policy_service,
-                 supervised_user_settings, user_pref_store, extension_prefs,
+  PrepareFactory(&factory,
+                 policy_service,
+                 supervised_user_settings,
+                 user_pref_store,
+                 extension_prefs,
                  async);
   std::unique_ptr<syncable_prefs::PrefServiceSyncable> pref_service =
       factory.CreateSyncable(pref_registry.get());
diff --git a/chrome/browser/prerender/prerender_browsertest.cc b/chrome/browser/prerender/prerender_browsertest.cc
index eac7cc0..eac49bf 100644
--- a/chrome/browser/prerender/prerender_browsertest.cc
+++ b/chrome/browser/prerender/prerender_browsertest.cc
@@ -231,8 +231,8 @@ void ClearBrowsingData(Browser* browser, int remove_mask) {
   BrowsingDataRemover* remover =
       BrowsingDataRemoverFactory::GetForBrowserContext(browser->profile());
   BrowsingDataRemoverCompletionObserver observer(remover);
-  remover->RemoveAndReply(BrowsingDataRemover::Unbounded(), remove_mask,
-                          BrowsingDataHelper::UNPROTECTED_WEB, &observer);
+  remover->Remove(BrowsingDataRemover::Unbounded(), remove_mask,
+                  BrowsingDataHelper::UNPROTECTED_WEB);
   observer.BlockUntilCompletion();
   // BrowsingDataRemover deletes itself.
 }
diff --git a/chrome/browser/profile_resetter/profile_resetter.cc b/chrome/browser/profile_resetter/profile_resetter.cc
index c0cab53..84a667d 100644
--- a/chrome/browser/profile_resetter/profile_resetter.cc
+++ b/chrome/browser/profile_resetter/profile_resetter.cc
@@ -257,9 +257,8 @@ void ProfileResetter::ResetCookiesAndSiteData() {
   // Don't try to clear LSO data if it's not supported.
   if (!prefs->GetBoolean(prefs::kClearPluginLSODataEnabled))
     remove_mask &= ~BrowsingDataRemover::REMOVE_PLUGIN_DATA;
-  cookies_remover_->RemoveAndReply(BrowsingDataRemover::Unbounded(),
-                                   remove_mask,
-                                   BrowsingDataHelper::UNPROTECTED_WEB, this);
+  cookies_remover_->Remove(BrowsingDataRemover::Unbounded(), remove_mask,
+                           BrowsingDataHelper::UNPROTECTED_WEB);
 }
 
 void ProfileResetter::ResetExtensions() {
diff --git a/chrome/browser/push_messaging/push_messaging_browsertest.cc b/chrome/browser/push_messaging/push_messaging_browsertest.cc
index 68df46d..4202175 100644
--- a/chrome/browser/push_messaging/push_messaging_browsertest.cc
+++ b/chrome/browser/push_messaging/push_messaging_browsertest.cc
@@ -1417,9 +1417,9 @@ IN_PROC_BROWSER_TEST_F(PushMessagingBrowserTest,
   BrowsingDataRemover* remover =
       BrowsingDataRemoverFactory::GetForBrowserContext(GetBrowser()->profile());
   BrowsingDataRemoverCompletionObserver observer(remover);
-  remover->RemoveAndReply(BrowsingDataRemover::Unbounded(),
-                          BrowsingDataRemover::REMOVE_SITE_DATA,
-                          BrowsingDataHelper::UNPROTECTED_WEB, &observer);
+  remover->Remove(BrowsingDataRemover::Unbounded(),
+                  BrowsingDataRemover::REMOVE_SITE_DATA,
+                  BrowsingDataHelper::UNPROTECTED_WEB);
   observer.BlockUntilCompletion();
 
   base::RunLoop run_loop;
diff --git a/chrome/browser/resources/chromeos/login/custom_elements_oobe.html b/chrome/browser/resources/chromeos/login/custom_elements_oobe.html
index 680f38a..69db270 100644
--- a/chrome/browser/resources/chromeos/login/custom_elements_oobe.html
+++ b/chrome/browser/resources/chromeos/login/custom_elements_oobe.html
@@ -17,7 +17,6 @@
 <include src="oobe_buttons.html">
 <include src="oobe_card.html">
 <include src="oobe_dialog.html">
-<include src="oobe_i18n_dropdown.html">
 <include src="oobe_welcome.html">
 
 <script src="chrome://oobe/custom_elements.js"></script>
diff --git a/chrome/browser/resources/chromeos/login/custom_elements_oobe.js b/chrome/browser/resources/chromeos/login/custom_elements_oobe.js
index 5ba20e4..347df43 100644
--- a/chrome/browser/resources/chromeos/login/custom_elements_oobe.js
+++ b/chrome/browser/resources/chromeos/login/custom_elements_oobe.js
@@ -2,11 +2,8 @@
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
-// This inclusion is types-only. No actual code to execute.
-<include src="oobe_types.js">
-
-// This inclusion should go before other non-trivial includes, as
-// <{controller,host}-paring-screen> depend of it.
+// This inclusion should go first, as <{controller,host}-paring-screen> depend
+// of it.
 <include src="oobe-screen.js">
 
 <include src="controller-pairing-screen.js">
@@ -27,5 +24,4 @@
 <include src="oobe_buttons.js">
 <include src="oobe_card.js">
 <include src="oobe_dialog.js">
-<include src="oobe_i18n_dropdown.js">
 <include src="oobe_welcome.js">
diff --git a/chrome/browser/resources/chromeos/login/oobe.js b/chrome/browser/resources/chromeos/login/oobe.js
index 3a9a4bc..729a695 100644
--- a/chrome/browser/resources/chromeos/login/oobe.js
+++ b/chrome/browser/resources/chromeos/login/oobe.js
@@ -305,17 +305,12 @@ cr.define('cr.ui.Oobe', function() {
       Oobe.setupSelect($('timezone-select'), data.timezoneList);
 
       // ---------- Welcome screen
-      if (data.newOobeUI == 'on') {
-        var welcomeScreen = $('oobe-welcome-md');
-        welcomeScreen.currentLanguage =
-            Oobe.getSelectedTitle(data.languageList);
-        welcomeScreen.languages = data.languageList;
-
-        welcomeScreen.keyboards = data.inputMethodsList;
+      $('oobe-welcome-md').currentLanguage =
+          Oobe.getSelectedTitle(data.languageList);
 
+      if (data.newOobeUI == 'on') {
         $('oobe-connect').hidden = true;
-        welcomeScreen.hidden = false;
-        welcomeScreen.enabled = true;
+        $('oobe-welcome-md').hidden = false;
       } else {
         $('oobe-connect').hidden = false;
         $('oobe-welcome-md').hidden = true;
diff --git a/chrome/browser/resources/chromeos/login/oobe_buttons.html b/chrome/browser/resources/chromeos/login/oobe_buttons.html
index 657f88b..e3d1cf9 100644
--- a/chrome/browser/resources/chromeos/login/oobe_buttons.html
+++ b/chrome/browser/resources/chromeos/login/oobe_buttons.html
@@ -47,30 +47,3 @@
   </template>
 </dom-module>
 
-<!--
-  Material design square button for text-labelled buttons.
-  By default, text is blue, background is white.
-  |inverse| makes text white on a blue background.
-
-  Example:
-    <oobe-icon-button label="OK" inverse></oobe-icon-button>
-    <oobe-icon-button label="CANCEL"></oobe-icon-button>
-
-  Attributes:
-    'label' - text on a button
-    'disabled' - button is disabled when the attribute is set.
-    'inverse' - makes text white and background blue
--->
-<dom-module id="oobe-text-button">
-  <link rel="stylesheet" href="oobe_text_button.css">
-  <template>
-    <div on-click="onClick_" on-tap="onClick_">
-      <paper-button id="textButton" disabled="[[disabled]]"
-          inverse$="[[inverse]]">
-        [[label]]
-        <content></content>
-      </paper-button>
-    </div>
-  </template>
-</dom-module>
-
diff --git a/chrome/browser/resources/chromeos/login/oobe_buttons.js b/chrome/browser/resources/chromeos/login/oobe_buttons.js
index 9b3238d..eff0ba8 100644
--- a/chrome/browser/resources/chromeos/login/oobe_buttons.js
+++ b/chrome/browser/resources/chromeos/login/oobe_buttons.js
@@ -38,24 +38,3 @@ Polymer({
       e.stopPropagation();
   }
 });
-
-Polymer({
-  is: 'oobe-text-button',
-
-  properties: {
-    disabled: {type: Boolean, value: false, reflectToAttribute: true},
-
-    label: String,
-
-    inverse: Boolean,
-  },
-
-  focus: function() {
-    this.$.textButton.focus();
-  },
-
-  onClick_: function(e) {
-    if (this.disabled)
-      e.stopPropagation();
-  }
-});
diff --git a/chrome/browser/resources/chromeos/login/oobe_dialog.css b/chrome/browser/resources/chromeos/login/oobe_dialog.css
index 2599245..4b4e495 100644
--- a/chrome/browser/resources/chromeos/login/oobe_dialog.css
+++ b/chrome/browser/resources/chromeos/login/oobe_dialog.css
@@ -33,12 +33,6 @@
   padding: 24px 40px 34px;
 }
 
-#oobe-bottom {
-  box-shadow: 0 -1px 1px rgba(0, 0, 0, 0.14);
-  padding: 24px 40px 34px;
-  z-index: 1;
-}
-
 ::content div.oobe-body-text {
   margin-bottom: 24px;
 }
@@ -64,4 +58,17 @@
   margin-bottom: 0;
 }
 
+.overlay {
+  background-color: rgba(0, 0, 0, 0.5);
+  display: none;
+  height: 100%;
+  position: absolute;
+  right: 0;
+  top: 0;
+  width: 100%;
+  z-index: 11;
+}
+
+:host(.full-disabled) #full-overlay,
+:host(.disabled) #bottom-overlay,
 
diff --git a/chrome/browser/resources/chromeos/login/oobe_dialog.html b/chrome/browser/resources/chromeos/login/oobe_dialog.html
index cd0985a..80b000c 100644
--- a/chrome/browser/resources/chromeos/login/oobe_dialog.html
+++ b/chrome/browser/resources/chromeos/login/oobe_dialog.html
@@ -17,8 +17,6 @@
       </div>
       <oobe-input-form class="footer" ...>
       </oobe-input-form>
-      <oobe-text-button class="footer" label="OK" ...>
-      </oobe-text-button>
     </oobe-dialog>
 
   Add class |header| to all which you want to go inside the header.  Similar
@@ -39,12 +37,9 @@
       <div class="footer-container flex vertical layout">
         <content select=".footer"></content>
       </div>
+      <div id="bottom-overlay" class="overlay"></div>
     </div>
-    <template is="dom-if" if="[[hasButtons]]">
-      <div id="oobe-bottom" class="layout horizontal end-justified">
-        <content select=".bottom-buttons"></content>
-      </div>
-    </template>
+    <div id="full-overlay" class="overlay"></div>
   </template>
 </dom-module>
 
diff --git a/chrome/browser/resources/chromeos/login/oobe_dialog.js b/chrome/browser/resources/chromeos/login/oobe_dialog.js
index 2a1e083..8dd5bc3 100644
--- a/chrome/browser/resources/chromeos/login/oobe_dialog.js
+++ b/chrome/browser/resources/chromeos/login/oobe_dialog.js
@@ -2,16 +2,4 @@
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
-Polymer({
-  is: 'oobe-dialog',
-
-  properties: {
-    /**
-     * Controls visibility of the bottom-buttons element.
-     */
-    hasButtons: {
-      type: Boolean,
-      value: false,
-    },
-  },
-});
+Polymer({is: 'oobe-dialog'});
diff --git a/chrome/browser/resources/chromeos/login/oobe_i18n_dropdown.html b/chrome/browser/resources/chromeos/login/oobe_i18n_dropdown.html
deleted file mode 100644
index 55dd811..0000000
--- a/chrome/browser/resources/chromeos/login/oobe_i18n_dropdown.html
+++ /dev/null
@@ -1,51 +0,0 @@
-<link rel="import" href="chrome://resources/html/polymer.html">
-<link rel="import" href="chrome://resources/polymer/v1_0/iron-flex-layout/classes/iron-flex-layout.html">
-<link rel="import" href="chrome://resources/polymer/v1_0/iron-icon/iron-icon.html">
-<link rel="import" href="chrome://resources/polymer/v1_0/iron-iconset-svg/iron-iconset-svg.html">
-<link rel="import" href="chrome://resources/polymer/v1_0/paper-dropdown-menu/paper-dropdown-menu.html">
-<link rel="import" href="chrome://resources/polymer/v1_0/paper-listbox/paper-listbox.html">
-<link rel="import" href="chrome://resources/polymer/v1_0/paper-styles/color.html">
-
-<iron-iconset-svg name="oobe-i18n-dropdown" size="24">
-  <svg>
-    <defs>
-      <!--
-      These icons are copied from Polymer's iron-icons and kept in sorted order.
-      See http://goo.gl/Y1OdAq for instructions on adding additional icons.
-      -->
-      <g id="check">
-        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z">
-        </path>
-      </g>
-    </defs>
-  </svg>
-</iron-iconset-svg>
-
-<dom-module id="oobe-i18n-dropdown">
-  <template>
-    <style>
-      .selected-icon {
-        color: var(--google-blue-500);
-      } 
-    </style>
-    <paper-dropdown-menu no-label-float>
-      <paper-listbox id="listboxDropdown" class="dropdown-content"
-          on-iron-select="onSelect_"
-          on-iron-deselect="onDeselect_">
-        <template is="dom-repeat" id="domRepeat" items="[[items]]">
-          <paper-item item="[[item]]" disabled="[[item.optionGroupName]]">
-            <div class="flex horizontal layout justified">
-              <div hidden="[[item.optionGroupName]]">
-                [[item.title]]
-              </div>
-              <iron-icon icon="oobe-i18n-dropdown:check" class="selected-icon"
-                  hidden="[[!item.selected]]">
-              </iron-icon>
-            </div>
-            <hr hidden="[[!item.optionGroupName]]">
-          </paper-item>
-        </template>
-      </paper-listbox>
-    </paper-dropdown-menu>
-  </template>
-</dom-module>
diff --git a/chrome/browser/resources/chromeos/login/oobe_i18n_dropdown.js b/chrome/browser/resources/chromeos/login/oobe_i18n_dropdown.js
deleted file mode 100644
index 0d3d1c7..0000000
--- a/chrome/browser/resources/chromeos/login/oobe_i18n_dropdown.js
+++ /dev/null
@@ -1,97 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-/**
- * Polymer class definition for 'oobe-i18n-dropdown'.
- */
-(function() {
-
-
-/**
- * Languages/keyboard descriptor to display
- * @type {!OobeTypes.LanguageDsc|!OobeTypes.IMEDsc}
- */
-var I18nMenuItem;
-
-Polymer({
-  is: 'oobe-i18n-dropdown',
-
-  properties: {
-    /**
-     * List of languages/keyboards to display
-     * @type {!Array<I18nMenuItem>}
-     */
-    items: {
-      type: Array,
-      observer: 'onItemsChanged_',
-    },
-
-    /**
-     * Accessibility label.
-     * @type {!string}
-     */
-    label: {
-      type: String,
-    },
-  },
-
-  /**
-   * This flag prevents recursive calls of observers and callbacks.
-   */
-  observersDisabled_: false,
-
-  /**
-   * @param {!{detail: !{item: { item: {!I18nMenuItem}}}}} event
-   * @private
-   */
-  onSelect_: function(event) {
-    if (this.observersDisabled_)
-      return;
-
-    var selectedModel = this.$.domRepeat.modelForElement(event.detail.item);
-    if (!selectedModel.item)
-      return;
-
-    selectedModel.set('item.selected', true);
-    this.fire('select-item', selectedModel.item);
-  },
-
-  onDeselect_: function(event) {
-    if (this.observersDisabled_)
-      return;
-
-    var deSelectedModel = this.$.domRepeat.modelForElement(event.detail.item);
-    if (!deSelectedModel.item)
-      return;
-
-    deSelectedModel.set('item.selected', false);
-  },
-
-  onItemsChanged_: function(items) {
-    if (this.observersDisabled_)
-      return;
-
-    if (!items)
-      return;
-
-    this.observersDisabled_ = true;
-
-    var index = items.findIndex(function(item) { return item.selected; });
-    if (index != -1) {
-      // This is needed for selectIndex() to pick up values from updated
-      // this.items (for example, translated into other language).
-      Polymer.dom.flush();
-
-      if (this.$.listboxDropdown.selected == index) {
-        // This is to force update real <input> element value even if selection
-        // index has not changed.
-        this.$.listboxDropdown.selectIndex(null);
-      }
-      this.$.listboxDropdown.selectIndex(index);
-    }
-
-    this.observersDisabled_ = false;
-  },
-});
-})();
diff --git a/chrome/browser/resources/chromeos/login/oobe_screen_network.html b/chrome/browser/resources/chromeos/login/oobe_screen_network.html
index a43a700..982daee 100644
--- a/chrome/browser/resources/chromeos/login/oobe_screen_network.html
+++ b/chrome/browser/resources/chromeos/login/oobe_screen_network.html
@@ -5,8 +5,7 @@
 <div class="step hidden animated" id="connect" role="group" hidden>
   <div id="oobe-poly-connect">
     <div class="step-contents">
-      <oobe-welcome-md id="oobe-welcome-md" class="fit" hidden>
-      </oobe-welcome-md>
+      <oobe-welcome-md id="oobe-welcome-md" class="fit"></oobe-welcome-md>
     </div>
   </div>
   <div id="oobe-connect">
diff --git a/chrome/browser/resources/chromeos/login/oobe_screen_network.js b/chrome/browser/resources/chromeos/login/oobe_screen_network.js
index 3977d51..bba9c38 100644
--- a/chrome/browser/resources/chromeos/login/oobe_screen_network.js
+++ b/chrome/browser/resources/chromeos/login/oobe_screen_network.js
@@ -27,27 +27,27 @@ login.createScreen('NetworkScreen', 'connect', function() {
 
     /** @override */
     decorate: function() {
+      var self = this;
+
       Oobe.setupSelect($('language-select'),
                        loadTimeData.getValue('languageList'),
-                       this.onLanguageSelected_.bind(this));
+                       function(languageId) {
+                         self.context.set(CONTEXT_KEY_LOCALE, languageId);
+                         self.commitContextChanges();
+                       });
       Oobe.setupSelect($('keyboard-select'),
                        loadTimeData.getValue('inputMethodsList'),
-                       this.onKeyboardSelected_.bind(this));
+                       function(inputMethodId) {
+                         self.context.set(CONTEXT_KEY_INPUT_METHOD,
+                                          inputMethodId);
+                         self.commitContextChanges();
+                       });
       Oobe.setupSelect($('timezone-select'),
                        loadTimeData.getValue('timezoneList'),
-                       this.onTimezoneSelected_.bind(this));
-
-      // ---------- Welcome screen
-      var welcomeScreen = $('oobe-welcome-md');
-      welcomeScreen.screen = this;
-
-      var languageList = loadTimeData.getValue('languageList');
-      welcomeScreen.languages = languageList;
-      welcomeScreen.currentLanguage = Oobe.getSelectedTitle(languageList);
-
-      var inputMethodsList = loadTimeData.getValue('inputMethodsList');
-      welcomeScreen.keyboards = inputMethodsList;
-      // -------------------------
+                       function(timezoneId) {
+                         self.context.set(CONTEXT_KEY_TIMEZONE, timezoneId);
+                         self.commitContextChanges();
+                       });
 
       this.dropdown_ = $('networks-list');
       cr.ui.DropDown.decorate(this.dropdown_);
@@ -81,21 +81,6 @@ login.createScreen('NetworkScreen', 'connect', function() {
       });
     },
 
-    onLanguageSelected_: function(languageId) {
-      this.context.set(CONTEXT_KEY_LOCALE, languageId);
-      this.commitContextChanges();
-    },
-
-    onKeyboardSelected_: function(inputMethodId) {
-      this.context.set(CONTEXT_KEY_INPUT_METHOD, inputMethodId);
-      this.commitContextChanges();
-    },
-
-    onTimezoneSelected_: function(timezoneId) {
-      this.context.set(CONTEXT_KEY_TIMEZONE, timezoneId);
-      this.commitContextChanges();
-    },
-
     onBeforeShow: function(data) {
       cr.ui.DropDown.show('networks-list', true, -1);
       this.classList.toggle('connect-debugging-view',
diff --git a/chrome/browser/resources/chromeos/login/oobe_text_button.css b/chrome/browser/resources/chromeos/login/oobe_text_button.css
deleted file mode 100644
index 42b10d1..0000000
--- a/chrome/browser/resources/chromeos/login/oobe_text_button.css
+++ /dev/null
@@ -1,18 +0,0 @@
-/* Copyright 2016 The Chromium Authors. All rights reserved.
-   Use of this source code is governed by a BSD-style license that can be
-   found in the LICENSE file. */
-
-#textButton {
-  font-size: 18px;
-  height: 24px;
-}
-
-#textButton:not([inverse]) {
-  background-color: white
-  color: var(--google-blue-500);
-}
-
-#textButton[inverse] {
-  background-color: var(--google-blue-500);
-  color: white;
-}
diff --git a/chrome/browser/resources/chromeos/login/oobe_types.js b/chrome/browser/resources/chromeos/login/oobe_types.js
deleted file mode 100644
index 826941b..0000000
--- a/chrome/browser/resources/chromeos/login/oobe_types.js
+++ /dev/null
@@ -1,33 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-/**
- * @fileoverview
- *
- * This file contains typedefs for chromeOS OOBE properties.
- */
-
-var OobeTypes = {};
-
-/**
- * ChromeOS OOBE language descriptor.
- * @typedef {{
- *   code: (String|undefined),
- *   displayName: (String|undefined),
- *   textDirection: (String|undefined),
- *   nativeDisplayName: (String|undefined),
- * }}
- */
-OobeTypes.LanguageDsc;
-
-/**
- * ChromeOS OOBE input method descriptor.
- * @typedef {{
- *   value: (String|undefined),
- *   title: (String|undefined),
- *   selected: (Boolean|undefined),
- * }}
- */
-OobeTypes.IMEDsc;
-
diff --git a/chrome/browser/resources/chromeos/login/oobe_welcome.css b/chrome/browser/resources/chromeos/login/oobe_welcome.css
index 4e63b01..2dcf4b1 100644
--- a/chrome/browser/resources/chromeos/login/oobe_welcome.css
+++ b/chrome/browser/resources/chromeos/login/oobe_welcome.css
@@ -24,11 +24,3 @@
     --iron-icon-height: 32px;
     --iron-icon-width: 32px;
 }
-
-.language-selection-entry {
-  border-top: 1px solid lightgrey;
-}
-
-.language-selection-entry:last-of-type {
-  border-bottom: 1px solid lightgrey;
-}
diff --git a/chrome/browser/resources/chromeos/login/oobe_welcome.html b/chrome/browser/resources/chromeos/login/oobe_welcome.html
index a9c55a5..d4a2e85 100644
--- a/chrome/browser/resources/chromeos/login/oobe_welcome.html
+++ b/chrome/browser/resources/chromeos/login/oobe_welcome.html
@@ -21,76 +21,33 @@
 <dom-module name="oobe-welcome-md">
   <link rel="stylesheet" href="oobe_welcome.css">
   <template>
-    <oobe-card id="welcomeSection" class="fit" hidden="[[!welcomeScreenShown]]">
+    <oobe-card id="welcomeSection" class="fit" hidden="[[networkSelectionScreenShown]]">
       <div class="header flex vertical layout end-justified start">
         <h1 class="welcome-message" i18n-content="networkScreenGreeting"></h1>
       </div>
       <div class="footer flex vertical layout justified">
         <div class="welcome-next flex vertical layout center">
-          <oobe-next-button id="welcomeNextButton"
-              on-tap="onWelcomeNextButtonClicked_">
-          </oobe-next-button>
+          <oobe-next-button id="welcomeNextButton" on-tap="onWelcomeNextButtonClicked_"></oobe-next-button>
         </div>
         <div class="flex horizontal layout justified">
-          <div class="buttonbox layout vertical"
-              on-tap="onWelcomeSelectLanguageButtonClicked_">
-            <iron-icon icon="icons:language" class="bottom-button self-center">
-            </iron-icon>
+          <div class="buttonbox layout vertical">
+            <iron-icon icon="icons:language" class="bottom-button self-center"></iron-icon>
             <div id="currentLanguage">[[currentLanguage]]</div>
           </div>
           <div class="buttonbox layout vertical">
-            <iron-icon icon="icons:accessibility"
-                class="bottom-button self-center">
-            </iron-icon>
+            <iron-icon icon="icons:accessibility" class="bottom-button self-center"></iron-icon>
             <div id="accessibilityLabel" i18n-content="accessibilityLink"></div>
           </div>
         </div>
       </div>
     </oobe-card>
-    <oobe-dialog class="fit" hidden="[[!languageSelectionScreenShown]]"
-        has-buttons>
-      <iron-icon icon="icons:language" class="oobe-icon"></iron-icon>
-      <div class="header flex layout vertical end-justified start">
-        <h1 class="welcome-message" i18n-content="languageSectionTitle"></h1>
-      </div>
-      <div class="footer layout vertical">
-        <template is="dom-if" if="[[enabled]]">
-          <div id="languageDropdownContainer"
-              class="flex layout horizontal justified language-selection-entry">
-            <div class="layout vertical center-justified"
-                i18n-content="languageDropdownTitle">
-            </div>
-            <oobe-i18n-dropdown id="languageSelect" items="[[languages]]"
-                on-select-item="onLanguageSelected_"
-                label="$i18n{languageDropdownTitle}">
-            </oobe-i18n-dropdown>
-          </div>
-          <div id="keyboardDropdownContainer"
-              class="flex layout horizontal justified language-selection-entry">
-            <div class="layout vertical center-justified"
-                i18n-content="keyboardDropdownTitle">
-            </div>
-            <oobe-i18n-dropdown id="keyboardSelect" items="[[keyboards]]"
-                on-select-item="onKeyboardSelected_"
-                label="$i18n{keyboardDropdownTitle}">
-            </oobe-i18n-dropdown>
-          </div>
-        </template>
-      </div>
-      <div class="bottom-buttons layout horizontal">
-        <oobe-text-button inverse on-tap="closeLanguageSection_"
-          i18n-content="oobeOKButtonText">
-        </oobe-text-button>
-      </div>
-    </oobe-dialog>
-    <oobe-dialog id="networkSection" class="fit"
-        hidden="[[!networkSelectionScreenShown]]">
+    <oobe-dialog id="networkSection" class="fit" hidden="[[!networkSelectionScreenShown]]">
       <iron-icon icon="oobe-welcome:wifi" class="oobe-icon"></iron-icon>
-      <div class="header flex layout vertical end-justified start">
+      <div class="header flex vertical layout end-justified start">
         <h1 class="welcome-message" i18n-content="networkSectionTitle"></h1>
         <h1 class="welcome-message-hint" i18n-content="networkSectionHint"></h1>
       </div>
-      <div class="footer flex layout vertical justified">
+      <div class="footer flex vertical layout justified">
         <cr-network-select id="networkSelect"
             on-network-connected="onNetworkConnected_"
             on-network-item-selected="onNetworkListNetworkItemSelected_"
diff --git a/chrome/browser/resources/chromeos/login/oobe_welcome.js b/chrome/browser/resources/chromeos/login/oobe_welcome.js
index 52cb4f9..5b48931 100644
--- a/chrome/browser/resources/chromeos/login/oobe_welcome.js
+++ b/chrome/browser/resources/chromeos/login/oobe_welcome.js
@@ -11,69 +11,20 @@ Polymer({
 
   properties: {
     /**
-     * Currently selected system language (display name).
+     * Currently selected system language.
      */
     currentLanguage: {
       type: String,
-      value: '',
+      value: 'English (US)',
     },
 
     /**
-     * List of languages for language selector dropdown.
-     * @type {!Array<OobeTypes.LanguageDsc>}
-     */
-    languages: {
-      type: Array,
-    },
-
-    /**
-     * List of keyboards for keyboard selector dropdown.
-     * @type {!Array<OobeTypes.IMEDsc>}
-     */
-    keyboards: {
-      type: Array,
-    },
-
-    /**
-     * Flag that shows Welcome screen.
-     */
-    welcomeScreenShown: {
-      type: Boolean,
-      value: true,
-    },
-
-    /**
-     * Flag that shows Language Selection screen.
-     */
-    languageSelectionScreenShown: {
-      type: Boolean,
-      value: false,
-    },
-
-    /**
-     * Flag that shows Network Selection screen.
+     * Flag that switches Welcome screen to Network Selection screen.
      */
     networkSelectionScreenShown: {
       type: Boolean,
       value: false,
     },
-
-    /**
-     * Flag that enables MD-OOBE.
-     */
-    enabled: {
-      type: Boolean,
-      value: false,
-    },
-  },
-
-  /**
-   * Hides all screens to help switching from one screen to another.
-   */
-  hideAllScreens_: function() {
-    this.welcomeScreenShown = false;
-    this.networkSelectionScreenShown = false;
-    this.languageSelectionScreenShown = false;
   },
 
   /**
@@ -134,21 +85,10 @@ Polymer({
    * @private
    */
   onWelcomeNextButtonClicked_: function() {
-    this.hideAllScreens_();
     this.networkSelectionScreenShown = true;
   },
 
   /**
-   * Handle "Language" button for "Welcome" screen.
-   *
-   * @private
-   */
-  onWelcomeSelectLanguageButtonClicked_: function() {
-    this.hideAllScreens_();
-    this.languageSelectionScreenShown = true;
-  },
-
-  /**
    * Handle Networwork Setup screen "Proxy settings" button.
    *
    * @private
@@ -240,44 +180,9 @@ Polymer({
 
   /**
    * @param {!Event} event
-   * @private
    */
   onNetworkListCustomItemSelected_: function(e) {
     var itemState = e.detail;
     itemState.customData.onTap();
   },
-
-  /**
-   * Handle language selection.
-   *
-   * @param {!{detail: {!OobeTypes.LanguageDsc}}} event
-   * @private
-   */
-  onLanguageSelected_: function(event) {
-    var item = event.detail;
-    var languageId = item.value;
-    this.screen.onLanguageSelected_(languageId);
-  },
-
-  /**
-   * Handle keyboard layout selection.
-   *
-   * @param {!{detail: {!OobeTypes.IMEDsc}}} event
-   * @private
-   */
-  onKeyboardSelected_: function(event) {
-    var item = event.detail;
-    var inputMethodId = item.value;
-    this.screen.onKeyboardSelected_(inputMethodId);
-  },
-
-  /**
-   * Handle "OK" button for "LanguageSelection" screen.
-   *
-   * @private
-   */
-  closeLanguageSection_: function() {
-    this.hideAllScreens_();
-    this.welcomeScreenShown = true;
-  },
 });
diff --git a/chrome/browser/resources/md_user_manager/error_dialog.html b/chrome/browser/resources/md_user_manager/error_dialog.html
index 6c403d3..e92564e 100644
--- a/chrome/browser/resources/md_user_manager/error_dialog.html
+++ b/chrome/browser/resources/md_user_manager/error_dialog.html
@@ -7,14 +7,13 @@
     <style include="shared-styles">
       #dialog {
         --user-manager-dialog-title-bar: {
-          border-bottom: 0;
+          border-bottom-width: 0;
         };
       }
-
       #message {
-        margin-bottom: 52px;
         white-space: pre-wrap;
         word-wrap: break-word;
+        margin-bottom: 52px;
       }
     </style>
     <user-manager-dialog id="dialog">
diff --git a/chrome/browser/resources/md_user_manager/import_supervised_user.html b/chrome/browser/resources/md_user_manager/import_supervised_user.html
index 116f7ae..94111d9 100644
--- a/chrome/browser/resources/md_user_manager/import_supervised_user.html
+++ b/chrome/browser/resources/md_user_manager/import_supervised_user.html
@@ -32,6 +32,7 @@
           font-size: inherit;
           height: var(--item-height);
           line-height: inherit;
+          padding: 0 16px;
         };
         --paper-item-disabled: {
           color: inherit;
diff --git a/chrome/browser/resources/md_user_manager/shared_styles.html b/chrome/browser/resources/md_user_manager/shared_styles.html
index 698f0d8..7c9d1aa 100644
--- a/chrome/browser/resources/md_user_manager/shared_styles.html
+++ b/chrome/browser/resources/md_user_manager/shared_styles.html
@@ -69,15 +69,6 @@
         --iron-overlay-backdrop-opacity: .8;
       }
 
-      /* TODO(mahmadi): Move this back to user_manager_dialog.html when it does
-       * not break the dialog */
-      user-manager-dialog {
-        --paper-dialog: {
-          font-size: inherit;
-          line-height: initial;
-        };
-      }
-
       .product-logo {
         content: -webkit-image-set(
             url(../../../app/theme/default_100_percent/%DISTRIBUTION%/product_logo_name_22.png) 1x,
diff --git a/chrome/browser/resources/md_user_manager/user_manager_dialog.html b/chrome/browser/resources/md_user_manager/user_manager_dialog.html
index ee48a85..f5d897a 100644
--- a/chrome/browser/resources/md_user_manager/user_manager_dialog.html
+++ b/chrome/browser/resources/md_user_manager/user_manager_dialog.html
@@ -10,11 +10,16 @@
   <template>
     <style include="shared-styles paper-dialog-shared-styles iron-flex iron-flex-alignment iron-positioning">
       :host {
-        border-radius: 2px;
-        width: 512px;
+        --paper-dialog: {
+          border-radius: 2px;
+          color: var(--primary-text-color);
+          font-size: inherit;
+          line-height: initial;
+          width: 512px;
+        };
       }
 
-      :host > ::content > *,
+      :host ::content > *,
       :host > ::content > *:first-child,
       :host > ::content > *:last-child {
         /* Overrides paper-dialog-shared-styles. */
diff --git a/chrome/browser/resources/settings/about_page/about_page.html b/chrome/browser/resources/settings/about_page/about_page.html
index 544ff45..3056163 100644
--- a/chrome/browser/resources/settings/about_page/about_page.html
+++ b/chrome/browser/resources/settings/about_page/about_page.html
@@ -66,8 +66,10 @@
       }
     </style>
     <div>
-      <settings-section page-title="$i18n{aboutPageTitle}" section="about">
-        <settings-animated-pages id="pages" section="about">
+      <settings-section page-title="$i18n{aboutPageTitle}"
+          current-route="[[currentRoute]]" section="about">
+        <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+            section="about">
           <neon-animatable id="main">
             <div class="settings-box">
               <img id="product-logo"
@@ -85,14 +87,13 @@
               <div class="start">
                 <div id="updateStatusMessage"
                     hidden="[[!shouldShowUpdateStatusMessage_(
-                        currentUpdateStatusEvent_)]]"
-<if expr="not chromeos">
-                    inner-h-t-m-l="[[getUpdateStatusMessage_(
                         currentUpdateStatusEvent_)]]">
+<if expr="not chromeos">
+                  [[getUpdateStatusMessage_(currentUpdateStatusEvent_)]]
 </if>
 <if expr="chromeos">
-                    inner-h-t-m-l="[[getUpdateStatusMessage_(
-                        currentUpdateStatusEvent_, targetChannel_)]]">
+                  [[getUpdateStatusMessage_(
+                      currentUpdateStatusEvent_, targetChannel_)]]
 </if>
                 </div>
                 <span id="deprecationWarning"
diff --git a/chrome/browser/resources/settings/about_page/about_page.js b/chrome/browser/resources/settings/about_page/about_page.js
index e7e8ca7..07d8eaa 100644
--- a/chrome/browser/resources/settings/about_page/about_page.js
+++ b/chrome/browser/resources/settings/about_page/about_page.js
@@ -12,6 +12,14 @@ Polymer({
   behaviors: [WebUIListenerBehavior, RoutableBehavior, I18nBehavior],
 
   properties: {
+    /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
     /** @private {?UpdateStatusChangedEvent} */
     currentUpdateStatusEvent_: Object,
 
@@ -168,10 +176,7 @@ Polymer({
 </if>
         return this.i18n('aboutUpgradeUpdating');
       default:
-        var message = this.currentUpdateStatusEvent_.message;
-        return message ?
-            parseHtmlSubset('<b>' + message + '</b>').firstChild.innerHTML :
-            '';
+        return this.currentUpdateStatusEvent_.message || '';
     }
   },
 
diff --git a/chrome/browser/resources/settings/about_page/compiled_resources2.gyp b/chrome/browser/resources/settings/about_page/compiled_resources2.gyp
index 949ff70..77c1da4 100644
--- a/chrome/browser/resources/settings/about_page/compiled_resources2.gyp
+++ b/chrome/browser/resources/settings/about_page/compiled_resources2.gyp
@@ -9,7 +9,6 @@
         'about_page_browser_proxy',
         '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:assert',
         '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:i18n_behavior',
-        '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:parse_html_subset',
         '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:web_ui_listener_behavior',
         '../compiled_resources2.gyp:lifetime_browser_proxy',
         '../compiled_resources2.gyp:route',
diff --git a/chrome/browser/resources/settings/about_page/detailed_build_info.html b/chrome/browser/resources/settings/about_page/detailed_build_info.html
index caf104a..d013e3f 100644
--- a/chrome/browser/resources/settings/about_page/detailed_build_info.html
+++ b/chrome/browser/resources/settings/about_page/detailed_build_info.html
@@ -14,13 +14,6 @@
       .secondary {
         -webkit-user-select: text;
       }
-
-      /* The command line string can contain very long substrings that
-       * don't have any spaces, need to force a line break in such cases. */
-      #command-line {
-        overflow-wrap: break-word;
-        width: 100%;
-      }
     </style>
     <div class="settings-box two-line single-column">
       <div>$i18n{aboutPlatformLabel}</div>
@@ -66,7 +59,7 @@
     </div>
     <div class="settings-box two-line single-column">
       <div>$i18n{aboutCommandLineLabel}</div>
-      <div id="command-line" class="secondary">$i18n{aboutCommandLine}</div>
+      <div class="secondary">$i18n{aboutCommandLine}</div>
     </div>
     <div class="settings-box two-line single-column">
       <div>$i18n{aboutBuildDateLabel}</div>
diff --git a/chrome/browser/resources/settings/advanced_page/advanced_page.html b/chrome/browser/resources/settings/advanced_page/advanced_page.html
index d1c9a18..c65c24a 100644
--- a/chrome/browser/resources/settings/advanced_page/advanced_page.html
+++ b/chrome/browser/resources/settings/advanced_page/advanced_page.html
@@ -8,6 +8,7 @@
 <link rel="import" href="/reset_page/reset_page.html">
 <link rel="import" href="/settings_page/main_page_behavior.html">
 <link rel="import" href="/settings_page/settings_page_visibility.html">
+<link rel="import" href="/settings_page/settings_router.html">
 <link rel="import" href="/settings_page/settings_section.html">
 <link rel="import" href="/settings_page_css.html">
 <link rel="import" href="/site_settings/constants.html">
@@ -29,7 +30,7 @@
 <if expr="chromeos">
       <template is="dom-if" if="[[showPage(pageVisibility.dateTime)]]" restamp>
         <settings-section page-title="$i18n{dateTimePageTitle}"
-            section="dateTime">
+            current-route="[[currentRoute]]" section="dateTime">
           <settings-date-time-page prefs="{{prefs}}"
               page-visibility="[[pageVisibility.dateTime]]">
           </settings-date-time-page>
@@ -38,8 +39,9 @@
 </if>
       <template is="dom-if" if="[[showPage(pageVisibility.privacy)]]" restamp>
         <settings-section page-title="$i18n{privacyPageTitle}"
-            section="privacy">
+            current-route="[[currentRoute]]" section="privacy">
           <settings-privacy-page prefs="{{prefs}}"
+              current-route="{{currentRoute}}"
               page-visibility="[[pageVisibility.privacy]]">
           </settings-privacy-page>
         </settings-section>
@@ -47,8 +49,10 @@
 <if expr="chromeos">
       <template is="dom-if" if="[[showPage(pageVisibility.bluetooth)]]" restamp>
         <settings-section page-title="$i18n{bluetoothPageTitle}"
-            section="bluetooth">
-          <settings-bluetooth-page prefs="{{prefs}}"></settings-bluetooth-page>
+            current-route="[[currentRoute]]" section="bluetooth">
+          <settings-bluetooth-page prefs="{{prefs}}"
+              current-route="{{currentRoute}}">
+          </settings-bluetooth-page>
         </settings-section>
       </template>
 </if>
@@ -56,20 +60,23 @@
           restamp>
         <settings-section
             page-title="$i18n{passwordsAndAutofillPageTitle}"
-            section="passwordsAndForms">
-          <settings-passwords-and-forms-page prefs="{{prefs}}">
+            current-route="[[currentRoute]]" section="passwordsAndForms">
+          <settings-passwords-and-forms-page prefs="{{prefs}}"
+              current-route="{{currentRoute}}">
           </settings-passwords-and-forms-page>
         </settings-section>
       </template>
       <template is="dom-if" if="[[showPage(pageVisibility.languages)]]" restamp>
         <settings-section page-title="$i18n{languagesPageTitle}"
-            section="languages">
-          <settings-languages-page prefs="{{prefs}}"></settings-languages-page>
+            current-route="[[currentRoute]]" section="languages">
+          <settings-languages-page prefs="{{prefs}}"
+              current-route="{{currentRoute}}">
+          </settings-languages-page>
         </settings-section>
       </template>
       <template is="dom-if" if="[[showPage(pageVisibility.downloads)]]" restamp>
         <settings-section page-title="$i18n{downloadsPageTitle}"
-            section="downloads">
+            current-route="[[currentRoute]]" section="downloads">
           <settings-downloads-page prefs="{{prefs}}"
               page-visibility="[[pageVisibility.downloads]]">
           </settings-downloads-page>
@@ -77,12 +84,15 @@
       </template>
       <template is="dom-if" if="[[showPage(pageVisibility.printing)]]" restamp>
         <settings-section page-title="$i18n{printingPageTitle}"
-            section="printing">
-          <settings-printing-page prefs="{{prefs}}"></settings-printing-page>
+            current-route="[[currentRoute]]" section="printing">
+          <settings-printing-page prefs="{{prefs}}"
+              current-route="{{currentRoute}}">
+          </settings-printing-page>
         </settings-section>
       </template>
       <template is="dom-if" if="[[showPage(pageVisibility.a11y)]]" restamp>
-        <settings-section page-title="$i18n{a11yPageTitle}" section="a11y">
+        <settings-section page-title="$i18n{a11yPageTitle}"
+            current-route="[[currentRoute]]" section="a11y">
           <settings-a11y-page prefs="{{prefs}}"
               current-route="{{currentRoute}}">
           </settings-a11y-page>
@@ -90,13 +100,15 @@
       </template>
 <if expr="not chromeos">
       <template is="dom-if" if="[[showPage(pageVisibility.system)]]" restamp>
-        <settings-section page-title="$i18n{systemPageTitle}" section="system">
+        <settings-section page-title="$i18n{systemPageTitle}"
+            current-route="[[currentRoute]]" section="system">
           <settings-system-page prefs="{{prefs}}"></settings-system-page>
         </settings-section>
       </template>
 </if>
       <template is="dom-if" if="[[showPage(pageVisibility.reset)]]" restamp>
-        <settings-section page-title="$i18n{resetPageTitle}" section="reset">
+        <settings-section page-title="$i18n{resetPageTitle}"
+            current-route="[[currentRoute]]" section="reset">
           <settings-reset-page></settings-reset-page>
         </settings-section>
       </template>
diff --git a/chrome/browser/resources/settings/advanced_page/advanced_page.js b/chrome/browser/resources/settings/advanced_page/advanced_page.js
index 2770234..18e7c81 100644
--- a/chrome/browser/resources/settings/advanced_page/advanced_page.js
+++ b/chrome/browser/resources/settings/advanced_page/advanced_page.js
@@ -20,5 +20,14 @@ Polymer({
       type: Object,
       notify: true,
     },
+
+    /**
+     * The current active route.
+     * @type {settings.Route}
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
   },
 });
diff --git a/chrome/browser/resources/settings/advanced_page/compiled_resources2.gyp b/chrome/browser/resources/settings/advanced_page/compiled_resources2.gyp
index 85ad36c..d09ede8 100644
--- a/chrome/browser/resources/settings/advanced_page/compiled_resources2.gyp
+++ b/chrome/browser/resources/settings/advanced_page/compiled_resources2.gyp
@@ -9,6 +9,7 @@
         '../compiled_resources2.gyp:route',
         '../settings_page/compiled_resources2.gyp:main_page_behavior',
         '../settings_page/compiled_resources2.gyp:settings_page_visibility',
+        '../settings_page/compiled_resources2.gyp:settings_router',
         '../settings_page/compiled_resources2.gyp:transition_behavior',
         '../system_page/compiled_resources2.gyp:system_page',
       ],
diff --git a/chrome/browser/resources/settings/appearance_page/appearance_page.html b/chrome/browser/resources/settings/appearance_page/appearance_page.html
index 63755ee..7c06ebd 100644
--- a/chrome/browser/resources/settings/appearance_page/appearance_page.html
+++ b/chrome/browser/resources/settings/appearance_page/appearance_page.html
@@ -24,7 +24,8 @@
         -webkit-margin-end: var(--iron-icon-spacing);
       }
     </style>
-    <settings-animated-pages id="pages" section="appearance">
+    <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+        section="appearance">
       <neon-animatable id="main">
 <if expr="chromeos">
         <div class="settings-box first two-line" id="wallpaperButton"
diff --git a/chrome/browser/resources/settings/appearance_page/appearance_page.js b/chrome/browser/resources/settings/appearance_page/appearance_page.js
index 11b8414..f5e2d83 100644
--- a/chrome/browser/resources/settings/appearance_page/appearance_page.js
+++ b/chrome/browser/resources/settings/appearance_page/appearance_page.js
@@ -20,6 +20,14 @@ Polymer({
   behaviors: [I18nBehavior],
 
   properties: {
+    /**
+     * The current active route.
+     */
+    currentRoute: {
+      notify: true,
+      type: Object,
+    },
+
     /** @private {!settings.AppearanceBrowserProxy} */
     browserProxy_: Object,
 
@@ -180,6 +188,11 @@ Polymer({
     this.browserProxy_.resetTheme();
   },
 
+  /** @private */
+  showFontsPage_: function() {
+    return this.currentRoute == settings.Route.FONTS;
+  },
+
   /**
    * @param {string} themeId The theme ID.
    * @private
diff --git a/chrome/browser/resources/settings/basic_page/basic_page.html b/chrome/browser/resources/settings/basic_page/basic_page.html
index c9db620..abb32bf 100644
--- a/chrome/browser/resources/settings/basic_page/basic_page.html
+++ b/chrome/browser/resources/settings/basic_page/basic_page.html
@@ -3,6 +3,7 @@
 <link rel="import" href="/search_page/search_page.html">
 <link rel="import" href="/settings_page/main_page_behavior.html">
 <link rel="import" href="/settings_page/settings_page_visibility.html">
+<link rel="import" href="/settings_page/settings_router.html">
 <link rel="import" href="/settings_page/settings_section.html">
 <link rel="import" href="/on_startup_page/on_startup_page.html">
 <link rel="import" href="/people_page/people_page.html">
@@ -29,50 +30,62 @@
 <if expr="chromeos">
       <template is="dom-if" if="[[showPage(pageVisibility.internet)]]" restamp>
         <settings-section page-title="$i18n{internetPageTitle}"
-            section="internet">
-          <settings-internet-page>
+            current-route="[[currentRoute]]" section="internet">
+          <settings-internet-page current-route="{{currentRoute}}">
           </settings-internet-page>
         </settings-section>
       </template>
 </if>
       <template is="dom-if" if="[[showPage(pageVisibility.people)]]" restamp>
-        <settings-section page-title="$i18n{peoplePageTitle}" section="people">
-          <settings-people-page prefs="{{prefs}}"></settings-people-page>
+        <settings-section page-title="$i18n{peoplePageTitle}"
+            current-route="[[currentRoute]]" section="people">
+          <settings-people-page prefs="{{prefs}}"
+              current-route="{{currentRoute}}">
+          </settings-people-page>
         </settings-section>
       </template>
       <template is="dom-if" if="[[showPage(pageVisibility.appearance)]]"
           restamp>
         <settings-section page-title="$i18n{appearancePageTitle}"
-            section="appearance">
+            current-route="[[currentRoute]]" section="appearance">
           <settings-appearance-page prefs="{{prefs}}"
+              current-route="{{currentRoute}}"
               page-visibility="[[pageVisibility.appearance]]">
           </settings-appearance-page>
         </settings-section>
       </template>
 <if expr="chromeos">
       <template is="dom-if" if="[[showPage(pageVisibility.device)]]" restamp>
-        <settings-section page-title="$i18n{devicePageTitle}" section="device">
-          <settings-device-page  prefs="{{prefs}}"></settings-device-page>
+        <settings-section page-title="$i18n{devicePageTitle}"
+            current-route="[[currentRoute]]" section="device">
+          <settings-device-page  prefs="{{prefs}}"
+              current-route="{{currentRoute}}">
+          </settings-device-page>
         </settings-section>
       </template>
 </if>
       <template is="dom-if" if="[[showPage(pageVisibility.search)]]" restamp>
-        <settings-section page-title="$i18n{searchPageTitle}" section="search">
-          <settings-search-page></settings-search-page>
+        <settings-section page-title="$i18n{searchPageTitle}"
+            current-route="[[currentRoute]]" section="search">
+          <settings-search-page current-route="{{currentRoute}}">
+          </settings-search-page>
         </settings-section>
       </template>
 <if expr="not chromeos">
       <template is="dom-if" if="[[showPage(pageVisibility.defaultBrowser)]]"
           restamp>
         <settings-section page-title="$i18n{defaultBrowser}"
-            section="defaultBrowser">
-          <settings-default-browser-page></settings-default-browser-page>
+            current-route="[[currentRoute]]" section="defaultBrowser">
+          <settings-default-browser-page>
+          </settings-default-browser-page>
         </settings-section>
       </template>
 </if>
       <template is="dom-if" if="[[showPage(pageVisibility.onStartup)]]" restamp>
-        <settings-section page-title="$i18n{onStartup}" section="onStartup">
-          <settings-on-startup-page prefs="{{prefs}}">
+        <settings-section page-title="$i18n{onStartup}"
+            current-route="[[currentRoute]]" section="onStartup">
+          <settings-on-startup-page prefs="{{prefs}}"
+              current-route="{{currentRoute}}">
           </settings-on-startup-page>
         </settings-section>
       </template>
diff --git a/chrome/browser/resources/settings/basic_page/basic_page.js b/chrome/browser/resources/settings/basic_page/basic_page.js
index aa8a39b..8db640c 100644
--- a/chrome/browser/resources/settings/basic_page/basic_page.js
+++ b/chrome/browser/resources/settings/basic_page/basic_page.js
@@ -21,6 +21,15 @@ Polymer({
     },
 
     /**
+     * The current active route.
+     * @type {settings.Route}
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * True if the basic page should currently display the reset profile banner.
      * @private {boolean}
      */
@@ -30,6 +39,7 @@ Polymer({
         return loadTimeData.getBoolean('showResetProfileBanner');
       },
     },
+
   },
 
   onResetDone_: function() {
diff --git a/chrome/browser/resources/settings/basic_page/compiled_resources2.gyp b/chrome/browser/resources/settings/basic_page/compiled_resources2.gyp
index 307f1b2..c2b64c9 100644
--- a/chrome/browser/resources/settings/basic_page/compiled_resources2.gyp
+++ b/chrome/browser/resources/settings/basic_page/compiled_resources2.gyp
@@ -10,6 +10,7 @@
         '../compiled_resources2.gyp:route',
         '../settings_page/compiled_resources2.gyp:main_page_behavior',
         '../settings_page/compiled_resources2.gyp:settings_page_visibility',
+        '../settings_page/compiled_resources2.gyp:settings_router',
         '../settings_page/compiled_resources2.gyp:transition_behavior',
       ],
       'includes': ['../../../../../third_party/closure_compiler/compile_js2.gypi'],
diff --git a/chrome/browser/resources/settings/bluetooth_page/bluetooth_page.html b/chrome/browser/resources/settings/bluetooth_page/bluetooth_page.html
index f27f2ac..f368bc8 100644
--- a/chrome/browser/resources/settings/bluetooth_page/bluetooth_page.html
+++ b/chrome/browser/resources/settings/bluetooth_page/bluetooth_page.html
@@ -40,7 +40,8 @@
         width: 500px;
       }
     </style>
-    <settings-animated-pages id="pages" section="bluetooth">
+    <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+        section="bluetooth">
       <neon-animatable id="main">
         <div class="settings-box first">
           <div class="layout horizontal center flex">
diff --git a/chrome/browser/resources/settings/bluetooth_page/bluetooth_page.js b/chrome/browser/resources/settings/bluetooth_page/bluetooth_page.js
index d003d99..a91d742 100644
--- a/chrome/browser/resources/settings/bluetooth_page/bluetooth_page.js
+++ b/chrome/browser/resources/settings/bluetooth_page/bluetooth_page.js
@@ -37,6 +37,12 @@ Polymer({
   ],
 
   properties: {
+    /** The current active route. */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
     /** Whether bluetooth is enabled. */
     bluetoothEnabled: {
       type: Boolean,
diff --git a/chrome/browser/resources/settings/default_browser_page/default_browser_page.js b/chrome/browser/resources/settings/default_browser_page/default_browser_page.js
index 7f10002..ec9cc54 100644
--- a/chrome/browser/resources/settings/default_browser_page/default_browser_page.js
+++ b/chrome/browser/resources/settings/default_browser_page/default_browser_page.js
@@ -12,6 +12,14 @@ Polymer({
 
   properties: {
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * A message about whether Chrome is the default browser.
      */
     message_: {
diff --git a/chrome/browser/resources/settings/device_page/device_page.html b/chrome/browser/resources/settings/device_page/device_page.html
index f910dfc..971567f 100644
--- a/chrome/browser/resources/settings/device_page/device_page.html
+++ b/chrome/browser/resources/settings/device_page/device_page.html
@@ -19,7 +19,8 @@
 <dom-module id="settings-device-page">
   <template>
     <style include="settings-shared"></style>
-    <settings-animated-pages id="pages" section="device">
+    <settings-animated-pages id="pages" section="device"
+        current-route="{{currentRoute}}">
       <neon-animatable id="main">
         <div id="pointersRow" class="settings-box first"
             on-tap="onPointersTap_" actionable>
@@ -68,7 +69,8 @@
           <settings-subpage
               associated-control="[[$$('#noteRow')]]"
               page-title="$i18n{noteTitle}">
-            <settings-note prefs="{{prefs}}"></settings-note>
+            <settings-note prefs="{{prefs}}" current-route="{{currentRoute}}">
+            </settings-note>
           </settings-subpage>
         </template>
       </template>
diff --git a/chrome/browser/resources/settings/device_page/device_page.js b/chrome/browser/resources/settings/device_page/device_page.js
index 9e4efee..c416e15 100644
--- a/chrome/browser/resources/settings/device_page/device_page.js
+++ b/chrome/browser/resources/settings/device_page/device_page.js
@@ -12,10 +12,16 @@ Polymer({
   behaviors: [
     I18nBehavior,
     WebUIListenerBehavior,
-    settings.RouteObserverBehavior,
   ],
 
   properties: {
+    /** The current active route. */
+    currentRoute: {
+      type: Object,
+      notify: true,
+      observers: 'currentRouteChanged_',
+    },
+
     /** Preferences state. */
     prefs: {
       type: Object,
@@ -113,8 +119,8 @@ Polymer({
     settings.navigateTo(settings.Route.DISPLAY);
   },
 
-  /** @protected */
-  currentRouteChanged: function() {
+  /** @private */
+  currentRouteChanged_: function() {
     this.checkPointerSubpage_();
   },
 
@@ -134,7 +140,7 @@ Polymer({
    */
   checkPointerSubpage_: function() {
     if (!this.hasMouse_ && !this.hasTouchpad_ &&
-        settings.getCurrentRoute() == settings.Route.POINTERS) {
+        this.currentRoute == settings.Route.POINTERS) {
       this.$.pages.fire('subpage-back');
     }
   },
diff --git a/chrome/browser/resources/settings/internet_page/compiled_resources2.gyp b/chrome/browser/resources/settings/internet_page/compiled_resources2.gyp
index e9d59db..d965d3a 100644
--- a/chrome/browser/resources/settings/internet_page/compiled_resources2.gyp
+++ b/chrome/browser/resources/settings/internet_page/compiled_resources2.gyp
@@ -10,7 +10,6 @@
         '../settings_page/compiled_resources2.gyp:settings_animated_pages',
         '<(DEPTH)/ui/webui/resources/cr_elements/network/compiled_resources2.gyp:cr_onc_types',
         '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:assert',
-        '<(EXTERNS_GYP):chrome_send',
         '<(INTERFACES_GYP):networking_private_interface',
       ],
       'includes': ['../../../../../third_party/closure_compiler/compile_js2.gypi'],
@@ -21,7 +20,6 @@
         '<(DEPTH)/ui/webui/resources/cr_elements/network/compiled_resources2.gyp:cr_onc_types',
         '<(DEPTH)/ui/webui/resources/cr_elements/policy/compiled_resources2.gyp:cr_policy_network_behavior',
         '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:assert',
-        '<(EXTERNS_GYP):chrome_send',
         '<(EXTERNS_GYP):networking_private',
         '<(INTERFACES_GYP):networking_private_interface',
       ],
diff --git a/chrome/browser/resources/settings/internet_page/internet_detail_page.html b/chrome/browser/resources/settings/internet_page/internet_detail_page.html
index 114d7de..0ca0b15 100644
--- a/chrome/browser/resources/settings/internet_page/internet_detail_page.html
+++ b/chrome/browser/resources/settings/internet_page/internet_detail_page.html
@@ -90,10 +90,6 @@
               hidden$="[[!showActivate_(networkProperties)]]">
             Activate
           </paper-button>
-          <paper-button class="secondary-button" on-tap="onConfigureTap_"
-              hidden$="[[!showConfigure_(networkProperties)]]">
-            Configure
-          </paper-button>
           <paper-button class="primary-button" on-tap="onConnectTap_"
               hidden$="[[!showConnect_(networkProperties)]]"
               disabled="[[!enableConnect_(networkProperties, defaultNetwork)]]">
diff --git a/chrome/browser/resources/settings/internet_page/internet_detail_page.js b/chrome/browser/resources/settings/internet_page/internet_detail_page.js
index 598a02a..de49c26 100644
--- a/chrome/browser/resources/settings/internet_page/internet_detail_page.js
+++ b/chrome/browser/resources/settings/internet_page/internet_detail_page.js
@@ -336,22 +336,6 @@ Polymer({
    * @return {boolean}
    * @private
    */
-  showConfigure_: function() {
-    var type = this.networkProperties.Type;
-    if (type == CrOnc.Type.CELLULAR || type == CrOnc.Type.WI_MAX)
-      return false;
-    if (type == CrOnc.Type.WI_FI &&
-        this.networkProperties.ConnectionState !=
-            CrOnc.ConnectionState.NOT_CONNECTED) {
-      return false;
-    }
-    return this.isRemembered_();
-  },
-
-  /**
-   * @return {boolean}
-   * @private
-   */
   showViewAccount_: function() {
     // Show either the 'Activate' or the 'View Account' button.
     if (this.showActivate_())
@@ -421,11 +405,6 @@ Polymer({
   },
 
   /** @private */
-  onConfigureTap_: function() {
-    chrome.send('configureNetwork', [this.guid]);
-  },
-
-  /** @private */
   onViewAccountTap_: function() {
     // startActivate() will show the account page for activated networks.
     this.networkingPrivate.startActivate(this.guid);
diff --git a/chrome/browser/resources/settings/internet_page/internet_known_networks_page.html b/chrome/browser/resources/settings/internet_page/internet_known_networks_page.html
index 454dc11..64cd6b5 100644
--- a/chrome/browser/resources/settings/internet_page/internet_known_networks_page.html
+++ b/chrome/browser/resources/settings/internet_page/internet_known_networks_page.html
@@ -1,42 +1,47 @@
 <link rel="import" href="chrome://resources/html/polymer.html">
-<link rel="import" href="chrome://resources/cr_elements/icons.html">
 <link rel="import" href="chrome://resources/polymer/v1_0/iron-flex-layout/classes/iron-flex-layout.html">
+<link rel="import" href="chrome://resources/cr_elements/network/cr_network_list.html">
 <link rel="import" href="/settings_shared_css.html">
 
 <dom-module id="settings-internet-known-networks-page">
   <template>
     <style include="settings-shared">
+      #outerDiv {
+        margin: 0 40px;
+      }
+
+      #headerDiv {
+        background-color: grey;
+        padding: 4px;
+      }
+
+      #headerDiv span {
+        color: white;
+        padding: 0 8px;
+      }
+
+      #headerDiv span.button {
+        text-align: center;
+        width: 60px;
+      }
     </style>
-    <div class="settings-box first single-column">
-      <div class="settings-box continuation">
-        <div>$i18n{knownNetworksMessage}</div>
-      </div>
-      <div class="settings-box first single-column self-stretch">
-        <div class="secondary">$i18n{knownNetworksPreferred}</div>
-        <div class="settings-box self-stretch start"
-            hidden$="[[havePreferred_(networkStateList)]]">
-          $i18n{knownNetworksNoPreferred}
+    <div class="layout vertical">
+      <div id="outerDiv" class="layout vertical">
+        <div id="headerDiv" class="layout horizontal">
+          <span class="flex">Network</span>
+          <span class="button">Shared</span>
+          <span class="button">Preferred</span>
+          <span class="button">Remove</span>
         </div>
-        <template is="dom-repeat" items="[[networkStateList]]"
-            filter="networkIsPreferred_">
-          <div class="settings-box self-stretch">
-            <div class="start">[[item.Name]]</div>
-            <paper-icon-button icon="cr:clear" on-tap="onRemoveTap_">
-            </paper-icon-button>
-          </div>
-        </template>
-      </div>
-      <div class="settings-box first single-column self-stretch"
-          hidden$="[[!haveNotPreferred_(networkStateList)]]">
-        <div class="secondary">$i18n{knownNetworksAll}</div>
-        <template is="dom-repeat" items="[[networkStateList]]"
-            filter="networkIsNotPreferred_">
-          <div class="settings-box self-stretch">
-            <div class="start">[[item.Name]]</div>
-            <paper-icon-button icon="cr:add" on-tap="onAddTap_">
-            </paper-icon-button>
-          </div>
-        </template>
+        <cr-network-list id="networkList" class="layout vertical"
+            list-type="known"
+            max-height="[[maxHeight]]"
+            networks="[[networkStateList]]"
+            on-remove="onRemove_"
+            on-selected="onListItemSelected_"
+            on-toggle-preferred="onTogglePreferred_"
+            show-buttons>
+        </cr-network-list>
       </div>
     </div>
   </template>
diff --git a/chrome/browser/resources/settings/internet_page/internet_known_networks_page.js b/chrome/browser/resources/settings/internet_page/internet_known_networks_page.js
index 6bfa7e6..d43f1fc 100644
--- a/chrome/browser/resources/settings/internet_page/internet_known_networks_page.js
+++ b/chrome/browser/resources/settings/internet_page/internet_known_networks_page.js
@@ -25,7 +25,7 @@ Polymer({
      */
     maxHeight: {
       type: Number,
-      value: 500,
+      value: 500
     },
 
     /**
@@ -34,9 +34,7 @@ Polymer({
      */
     networkStateList: {
       type: Array,
-      value: function() {
-        return [];
-      }
+      value: function() { return []; }
     },
 
     /**
@@ -68,7 +66,9 @@ Polymer({
         this.networksChangedListener_);
   },
 
-  /** @private */
+  /**
+   * Polymer type changed method.
+   */
   networkTypeChanged_: function() {
     this.refreshNetworks_();
   },
@@ -95,65 +95,43 @@ Polymer({
       visible: false,
       configured: true
     };
-    this.networkingPrivate.getNetworks(filter, function(states) {
-      this.networkStateList = states;
-    }.bind(this));
-  },
-
-  /**
-   * @param {!CrOnc.NetworkStateProperties} state
-   * @return {boolean}
-   * @private
-   */
-  networkIsPreferred_: function(state) {
-    // Currently we treat NetworkStateProperties.Priority as a boolean.
-    return state.Priority > 0;
+    this.networkingPrivate.getNetworks(
+        filter,
+        function(states) { this.networkStateList = states; }.bind(this));
   },
 
   /**
-   * @param {!CrOnc.NetworkStateProperties} networkState
-   * @return {boolean}
+   * Event triggered when a cr-network-list item is selected.
+   * @param {!{detail: !CrOnc.NetworkStateProperties}} event
    * @private
    */
-  networkIsNotPreferred_: function(networkState) {
-    return networkState.Priority == 0;
+  onListItemSelected_: function(event) {
+    this.fire('show-detail', event.detail);
   },
 
   /**
-   * @return {boolean}
+   * Event triggered when a cr-network-list item 'remove' button is pressed.
+   * @param {!{detail: !CrOnc.NetworkStateProperties}} event
    * @private
    */
-  havePreferred_: function() {
-    return this.networkStateList.find(function(state) {
-      return this.networkIsPreferred_(state);
-    }.bind(this)) !== undefined;
-  },
-
-  /**
-   * @return {boolean}
-   * @private
-   */
-  haveNotPreferred_: function() {
-    return this.networkStateList.find(function(state) {
-      return this.networkIsNotPreferred_(state);
-    }.bind(this)) !== undefined;
-  },
-
-  /**
-   * @param {!{model: !{item: !CrOnc.NetworkStateProperties}}} e
-   * @private
-   */
-  onRemoveTap_: function(e) {
-    var state = e.model.item;
-    this.networkingPrivate.setProperties(state.GUID, {Priority: 0});
+  onRemove_: function(event) {
+    var state = event.detail;
+    if (!state.GUID)
+      return;
+    this.networkingPrivate.forgetNetwork(state.GUID);
   },
 
   /**
-   * @param {!{model: !{item: !CrOnc.NetworkStateProperties}}} e
+   * Event triggered when a cr-network-list item 'preferred' button is toggled.
+   * @param {!{detail: !CrOnc.NetworkStateProperties}} event
    * @private
    */
-  onAddTap_: function(e) {
-    var state = e.model.item;
-    this.networkingPrivate.setProperties(state.GUID, {Priority: 1});
+  onTogglePreferred_: function(event) {
+    var state = event.detail;
+    if (!state.GUID)
+      return;
+    var preferred = state.Priority > 0;
+    var onc = {Priority: preferred ? 0 : 1};
+    this.networkingPrivate.setProperties(state.GUID, onc);
   },
 });
diff --git a/chrome/browser/resources/settings/internet_page/internet_page.html b/chrome/browser/resources/settings/internet_page/internet_page.html
index dfb7dfa..e39eb35 100644
--- a/chrome/browser/resources/settings/internet_page/internet_page.html
+++ b/chrome/browser/resources/settings/internet_page/internet_page.html
@@ -1,9 +1,7 @@
 <link rel="import" href="chrome://resources/html/polymer.html">
-<link rel="import" href="chrome://resources/cr_elements/icons.html">
+<link rel="import" href="chrome://resources/polymer/v1_0/neon-animation/neon-animatable.html">
 <link rel="import" href="chrome://resources/cr_elements/network/cr_onc_types.html">
 <link rel="import" href="/route.html">
-<link rel="import" href="chrome://resources/polymer/v1_0/iron-icon/iron-icon.html">
-<link rel="import" href="chrome://resources/polymer/v1_0/neon-animation/neon-animatable.html">
 <link rel="import" href="/settings_page/settings_animated_pages.html">
 <link rel="import" href="/settings_page/settings_subpage.html">
 <link rel="import" href="/settings_shared_css.html">
@@ -13,43 +11,15 @@
 
 <dom-module id="settings-internet-page">
   <template>
-    <style include="settings-shared">
-     iron-icon {
-       -webkit-margin-end: 12px;
-       height: 24px;
-       width: 24px;
-     }
-     div.add-no-icon {
-       margin-left: 36px
-     }
-    </style>
-    <settings-animated-pages id="pages" section="internet">
-            <neon-animatable id="main">
+    <style include="settings-shared"></style>
+    <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+        section="internet">
+      <neon-animatable id="main">
         <network-summary on-show-detail="onShowDetail_"
             default-network="{{defaultNetwork}}"
             on-show-known-networks="onShowKnownNetworks_"
             networking-private="[[networkingPrivate]]">
         </network-summary>
-        <div actionable class="settings-box two-line"
-            on-tap="onExpandAddConnectionsTap_">
-          <div class="start layout horizontal center">
-            <iron-icon icon="cr:add"></iron-icon>
-            <div>Add connection</div>
-          </div>
-          <cr-expand-button
-              id="expandAddConnections" expanded="{{addConnectionExpanded}}">
-          </cr-expand-button>
-        </div>
-        <template is="dom-if" if="[[addConnectionExpanded]]">
-          <div actionable class="settings-box continuation center"
-              on-tap="onAddWiFiTap_">
-            <div class="start add-no-icon">Add Wi-Fi...</div>
-          </div>
-          <div actionable class="settings-box continuation center"
-              on-tap="onAddVPNTap_">
-            <div class="start add-no-icon">Add OpenVPN / L2TP...</div>
-          </div>
-        </template>
       </neon-animatable>
       <template is="dom-if" name="network-detail">
         <settings-subpage no-associated-control
diff --git a/chrome/browser/resources/settings/internet_page/internet_page.js b/chrome/browser/resources/settings/internet_page/internet_page.js
index 585841e..6fa5b5d 100644
--- a/chrome/browser/resources/settings/internet_page/internet_page.js
+++ b/chrome/browser/resources/settings/internet_page/internet_page.js
@@ -11,22 +11,28 @@ Polymer({
   is: 'settings-internet-page',
 
   properties: {
-    /** The network GUID for the detail subpage. */
+    /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
+     * The network GUID for the detail subpage.
+     */
     detailGuid: {
       type: String,
     },
 
-    /** The network type for the known networks subpage. */
+    /**
+     * The network type for the known networks subpage.
+     */
     knownNetworksType: {
       type: String,
     },
 
-    /** Whether the 'Add connection' section is expanded. */
-    addConnectionExpanded: {
-      type: Boolean,
-      value: false,
-    },
-
     /**
      * Interface for networkingPrivate calls. May be overriden by tests.
      * @type {NetworkingPrivate}
@@ -55,24 +61,4 @@ Polymer({
     settings.navigateTo(settings.Route.KNOWN_NETWORKS);
   },
 
-  /**
-   * Event triggered when the 'Add connections' div is tapped.
-   * @param {Event} event
-   * @private
-   */
-  onExpandAddConnectionsTap_: function(event) {
-    if (event.target.id == 'expandAddConnections')
-      return;
-    this.addConnectionExpanded = !this.addConnectionExpanded;
-  },
-
-  /*** @private */
-  onAddWiFiTap_: function() {
-    chrome.send('addNetwork', [CrOnc.Type.WI_FI]);
-  },
-
-  /*** @private */
-  onAddVPNTap_: function() {
-    chrome.send('addNetwork', [CrOnc.Type.VPN]);
-  },
 });
diff --git a/chrome/browser/resources/settings/internet_page/network_summary_item.html b/chrome/browser/resources/settings/internet_page/network_summary_item.html
index 1d942d9..5104f83 100644
--- a/chrome/browser/resources/settings/internet_page/network_summary_item.html
+++ b/chrome/browser/resources/settings/internet_page/network_summary_item.html
@@ -86,8 +86,10 @@
         </cr-network-list>
         <template is="dom-if"
             if="[[knownNetworksIsVisible_(activeNetworkState)]]">
-          <div class="button-row" actionable on-tap="onKnownNetworksTap_">
-            <a is="action-link">$i18n{knownNetworksButton}</a>
+          <div class="button-row">
+            <paper-button on-tap="onKnownNetworksTap_">
+              Known networks
+            </paper-button>
           </div>
         </template>
       </div>
diff --git a/chrome/browser/resources/settings/languages_page/languages_page.html b/chrome/browser/resources/settings/languages_page/languages_page.html
index 71f0a7b..d3c1f93 100644
--- a/chrome/browser/resources/settings/languages_page/languages_page.html
+++ b/chrome/browser/resources/settings/languages_page/languages_page.html
@@ -33,7 +33,8 @@
       }
     </style>
     <settings-languages languages="{{languages}}"></settings-languages>
-    <settings-animated-pages id="pages" section="languages">
+    <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+        section="languages">
       <neon-animatable id="main">
         <div id="manage-languages-subpage-trigger"
             class="settings-box first two-line">
diff --git a/chrome/browser/resources/settings/languages_page/languages_page.js b/chrome/browser/resources/settings/languages_page/languages_page.js
index d88a859..ea34802 100644
--- a/chrome/browser/resources/settings/languages_page/languages_page.js
+++ b/chrome/browser/resources/settings/languages_page/languages_page.js
@@ -14,6 +14,14 @@ Polymer({
 
   properties: {
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * Preferences state.
      */
     prefs: {
diff --git a/chrome/browser/resources/settings/on_startup_page/on_startup_page.js b/chrome/browser/resources/settings/on_startup_page/on_startup_page.js
index bdce9f0..d32d6a0 100644
--- a/chrome/browser/resources/settings/on_startup_page/on_startup_page.js
+++ b/chrome/browser/resources/settings/on_startup_page/on_startup_page.js
@@ -27,6 +27,14 @@ Polymer({
     },
 
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * Enum values for the 'session.restore_on_startup' preference.
      * @private {!Object<string, number>}
      */
diff --git a/chrome/browser/resources/settings/passwords_and_forms_page/passwords_and_forms_page.html b/chrome/browser/resources/settings/passwords_and_forms_page/passwords_and_forms_page.html
index d8b1a86..71425be 100644
--- a/chrome/browser/resources/settings/passwords_and_forms_page/passwords_and_forms_page.html
+++ b/chrome/browser/resources/settings/passwords_and_forms_page/passwords_and_forms_page.html
@@ -15,7 +15,8 @@
 <dom-module id="settings-passwords-and-forms-page">
   <template>
     <style include="settings-shared"></style>
-    <settings-animated-pages id="pages" section="passwordsAndForms">
+    <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+        section="passwordsAndForms">
       <neon-animatable id="main">
         <div class="settings-box first two-line" on-tap="onAutofillTap_"
             id="autofillManagerButton"
diff --git a/chrome/browser/resources/settings/passwords_and_forms_page/passwords_and_forms_page.js b/chrome/browser/resources/settings/passwords_and_forms_page/passwords_and_forms_page.js
index 4093e99..7ee3d2a 100644
--- a/chrome/browser/resources/settings/passwords_and_forms_page/passwords_and_forms_page.js
+++ b/chrome/browser/resources/settings/passwords_and_forms_page/passwords_and_forms_page.js
@@ -313,6 +313,12 @@ Polymer({
       notify: true,
     },
 
+    /** The current active route. */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
     /**
      * An array of passwords to display.
      * @type {!Array<!PasswordManager.PasswordUiEntry>}
diff --git a/chrome/browser/resources/settings/people_page/compiled_resources2.gyp b/chrome/browser/resources/settings/people_page/compiled_resources2.gyp
index 3b5f215..c74ba51 100644
--- a/chrome/browser/resources/settings/people_page/compiled_resources2.gyp
+++ b/chrome/browser/resources/settings/people_page/compiled_resources2.gyp
@@ -117,6 +117,7 @@
       'target_name': 'quick_unlock_setup_pin',
       'dependencies': [
         '../compiled_resources2.gyp:route',
+        '../settings_page/compiled_resources2.gyp:settings_router',
         'quick_unlock_password_detect_behavior',
         '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:i18n_behavior',
         '<(EXTERNS_GYP):quick_unlock_private',
diff --git a/chrome/browser/resources/settings/people_page/people_page.html b/chrome/browser/resources/settings/people_page/people_page.html
index 9e853a1..21a121b 100644
--- a/chrome/browser/resources/settings/people_page/people_page.html
+++ b/chrome/browser/resources/settings/people_page/people_page.html
@@ -72,7 +72,8 @@
         margin: 16px 0 2px;
       }
     </style>
-    <settings-animated-pages id="pages" section="people">
+    <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+        section="people">
       <neon-animatable id="main">
         <div id="picture-subpage-trigger" class="settings-box first two-line">
           <img id="profile-icon" src="[[profileIconUrl_]]"
@@ -238,7 +239,8 @@
         <settings-subpage
             associated-control="[[$$('#customize-sync')]]"
             page-title="$i18n{syncPageTitle}">
-          <settings-sync-page></settings-sync-page>
+          <settings-sync-page current-route="[[currentRoute]]">
+          </settings-sync-page>
         </settings-subpage>
       </template>
 <if expr="chromeos">
@@ -247,8 +249,9 @@
             associated-control="[[$$('#quick-unlock-subpage-trigger')]]"
             page-title="$i18n{quickUnlockTitle}">
           <settings-quick-unlock-authenticate
-              set-modes="{{quickUnlockSetModes}}"
-              profile-name="[[profileName_]]">
+            set-modes="{{quickUnlockSetModes}}"
+            current-route="{{currentRoute}}"
+            profile-name="[[profileName_]]">
           </settings-quick-unlock-authenticate>
         </settings-subpage>
       </template>
@@ -256,14 +259,18 @@
         <settings-subpage no-associated-control
             page-title="$i18n{quickUnlockTitle}">
           <settings-quick-unlock-choose-method
-              set-modes="[[quickUnlockSetModes]]" prefs="{{prefs}}">
+            set-modes="[[quickUnlockSetModes]]"
+            current-route="{{currentRoute}}"
+            prefs="{{prefs}}">
           </settings-quick-unlock-choose-method>
         </settings-subpage>
       </template>
       <template is="dom-if" name="quick-unlock-setup-pin">
         <settings-subpage no-associated-control
             page-title="$i18n{quickUnlockTitle}">
-          <settings-quick-unlock-setup-pin set-modes="[[quickUnlockSetModes]]">
+          <settings-quick-unlock-setup-pin
+            set-modes="[[quickUnlockSetModes]]"
+            current-route="{{currentRoute}}">
           </settings-quick-unlock-setup-pin>
         </settings-subpage>
       </template>
diff --git a/chrome/browser/resources/settings/people_page/people_page.js b/chrome/browser/resources/settings/people_page/people_page.js
index cc6dcc1..3f7cef1 100644
--- a/chrome/browser/resources/settings/people_page/people_page.js
+++ b/chrome/browser/resources/settings/people_page/people_page.js
@@ -15,6 +15,14 @@ Polymer({
 
   properties: {
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * Preferences state.
      */
     prefs: {
diff --git a/chrome/browser/resources/settings/people_page/quick_unlock_authenticate.js b/chrome/browser/resources/settings/people_page/quick_unlock_authenticate.js
index 8fed447..b2bae76 100644
--- a/chrome/browser/resources/settings/people_page/quick_unlock_authenticate.js
+++ b/chrome/browser/resources/settings/people_page/quick_unlock_authenticate.js
@@ -16,8 +16,9 @@
  * Example:
  *
  * <settings-quick-unlock-authenticate
- *     set-modes="[[setModes]]"
- *     profile-name="[[profileName_]]">
+ *   set-modes="[[setModes]]"
+ *   current-route="{{currentRoute}}"
+ *   profile-name="[[profileName_]]">
  * </settings-quick-unlock-authenticate>
  */
 
@@ -45,9 +46,13 @@ function checkAccountPassword_(password, onCheck) {
 Polymer({
   is: 'settings-quick-unlock-authenticate',
 
-  behavior: [settings.RouteObserverBehavior],
-
   properties: {
+    /** @type {!settings.Route} */
+    currentRoute: {
+      type: Object,
+      observer: 'onRouteChanged_',
+    },
+
     /**
      * A wrapper around chrome.quickUnlockPrivate.setModes with the account
      * password already supplied. If this is null, the authentication screen
@@ -80,15 +85,14 @@ Polymer({
     passwordInvalid_: Boolean
   },
 
-  /** @protected */
-  currentRouteChanged: function() {
+  /** @private */
+  onRouteChanged_: function(currentRoute) {
     // Clear local state if this screen is not active so if this screen shows
     // up again the user will get a fresh UI.
-    if (settings.getCurrentRoute() == settings.Route.QUICK_UNLOCK_AUTHENTICATE)
-      return;
-
-    this.password_ = '';
-    this.passwordInvalid_ = false;
+    if (this.currentRoute != settings.Route.QUICK_UNLOCK_AUTHENTICATE) {
+      this.password_ = '';
+      this.passwordInvalid_ = false;
+    }
   },
 
   /**
diff --git a/chrome/browser/resources/settings/people_page/quick_unlock_choose_method.js b/chrome/browser/resources/settings/people_page/quick_unlock_choose_method.js
index f9680ad..c455a87 100644
--- a/chrome/browser/resources/settings/people_page/quick_unlock_choose_method.js
+++ b/chrome/browser/resources/settings/people_page/quick_unlock_choose_method.js
@@ -12,6 +12,7 @@
  *
  * <settings-quick-unlock-choose-method
  *   set-modes="[[quickUnlockSetModes]]"
+ *   current-route="{{currentRoute}}"
  *   prefs="{{prefs}}">
  * </settings-quick-unlock-choose-method>
  */
@@ -35,6 +36,12 @@ Polymer({
   behaviors: [PrefsBehavior, QuickUnlockPasswordDetectBehavior],
 
   properties: {
+    /** @type {!settings.Route} */
+    currentRoute: {
+      type: Object,
+      observer: 'onRouteChanged_',
+    },
+
     /** Preferences state. */
     prefs: {
       type: Object,
@@ -73,7 +80,7 @@ Polymer({
     chrome.quickUnlockPrivate.onActiveModesChanged.addListener(
         this.boundOnActiveModesChanged_);
 
-    if (settings.getCurrentRoute() == settings.Route.QUICK_UNLOCK_CHOOSE_METHOD)
+  if (this.currentRoute == settings.Route.QUICK_UNLOCK_CHOOSE_METHOD)
       this.askForPasswordIfUnset();
   },
 
@@ -85,15 +92,15 @@ Polymer({
         this.boundOnActiveModesChanged_);
   },
 
-  /** @protected */
-  currentRouteChanged: function() {
-    if (settings.getCurrentRoute() == settings.Route.QUICK_UNLOCK_CHOOSE_METHOD)
+  /** @private */
+  onRouteChanged_: function() {
+    if (this.currentRoute == settings.Route.QUICK_UNLOCK_CHOOSE_METHOD)
       this.askForPasswordIfUnset();
   },
 
   /** @private */
   onSetModesChanged_: function() {
-    if (settings.getCurrentRoute() == settings.Route.QUICK_UNLOCK_CHOOSE_METHOD)
+    if (this.currentRoute == settings.Route.QUICK_UNLOCK_CHOOSE_METHOD)
       this.askForPasswordIfUnset();
   },
 
diff --git a/chrome/browser/resources/settings/people_page/quick_unlock_setup_pin.js b/chrome/browser/resources/settings/people_page/quick_unlock_setup_pin.js
index e74ab32..4f28913 100644
--- a/chrome/browser/resources/settings/people_page/quick_unlock_setup_pin.js
+++ b/chrome/browser/resources/settings/people_page/quick_unlock_setup_pin.js
@@ -8,7 +8,9 @@
  *
  * Example:
  *
- * <settings-quick-unlock-setup-pin set-modes="[[quickUnlockSetModes]]">
+ * <settings-quick-unlock-setup-pin
+ *   set-modes="[[quickUnlockSetModes]]"
+ *   current-route="{{currentRoute}}">
  * </settings-quick-unlock-setup-pin>
  */
 
@@ -49,13 +51,15 @@ var WEAK_PINS = [
 Polymer({
   is: 'settings-quick-unlock-setup-pin',
 
-  behaviors: [
-    I18nBehavior,
-    QuickUnlockPasswordDetectBehavior,
-    settings.RouteObserverBehavior
-  ],
+  behaviors: [I18nBehavior, QuickUnlockPasswordDetectBehavior],
 
   properties: {
+    /** @type {!settings.Route} */
+    currentRoute: {
+      type: Object,
+      observer: 'onRouteChanged_',
+    },
+
     /**
      * The current PIN keyboard value.
      * @private
@@ -101,13 +105,16 @@ Polymer({
   attached: function() {
     this.resetState_();
 
-    if (settings.getCurrentRoute() == settings.Route.QUICK_UNLOCK_SETUP_PIN)
+    if (this.currentRoute == settings.Route.QUICK_UNLOCK_SETUP_PIN)
       this.askForPasswordIfUnset();
   },
 
-  /** @protected */
-  currentRouteChanged: function() {
-    if (settings.getCurrentRoute() == settings.Route.QUICK_UNLOCK_SETUP_PIN) {
+  /**
+   * @param {!settings.Route} currentRoute
+   * @private
+   */
+  onRouteChanged_: function(currentRoute) {
+    if (this.currentRoute == settings.Route.QUICK_UNLOCK_SETUP_PIN) {
       this.askForPasswordIfUnset();
     } else {
       // If the user hits the back button, they can leave the element
@@ -118,7 +125,7 @@ Polymer({
 
   /** @private */
   onSetModesChanged_: function() {
-    if (settings.getCurrentRoute() == settings.Route.QUICK_UNLOCK_SETUP_PIN)
+    if (this.currentRoute == settings.Route.QUICK_UNLOCK_SETUP_PIN)
       this.askForPasswordIfUnset();
   },
 
diff --git a/chrome/browser/resources/settings/people_page/sync_page.js b/chrome/browser/resources/settings/people_page/sync_page.js
index 0ef62fb..6fa8c3a 100644
--- a/chrome/browser/resources/settings/people_page/sync_page.js
+++ b/chrome/browser/resources/settings/people_page/sync_page.js
@@ -49,7 +49,6 @@ Polymer({
   behaviors: [
     I18nBehavior,
     WebUIListenerBehavior,
-    settings.RouteObserverBehavior,
   ],
 
   properties: {
@@ -70,6 +69,14 @@ Polymer({
     },
 
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      observer: 'currentRouteChanged_',
+    },
+
+    /**
      * The current sync preferences, supplied by SyncBrowserProxy.
      * @type {settings.SyncPrefs|undefined}
      */
@@ -124,22 +131,22 @@ Polymer({
     this.addWebUIListener('sync-prefs-changed',
                           this.handleSyncPrefsChanged_.bind(this));
 
-    if (settings.getCurrentRoute() == settings.Route.SYNC)
+    if (this.currentRoute == settings.Route.SYNC)
       this.onNavigateToPage_();
   },
 
   /** @override */
   detached: function() {
-    if (settings.getCurrentRoute() == settings.Route.SYNC)
+    if (this.currentRoute == settings.Route.SYNC)
       this.onNavigateAwayFromPage_();
   },
 
-  /** @protected */
-  currentRouteChanged: function() {
+  /** @private */
+  currentRouteChanged_: function() {
     if (!this.isAttached)
       return;
 
-    if (settings.getCurrentRoute() == settings.Route.SYNC)
+    if (this.currentRoute == settings.Route.SYNC)
       this.onNavigateToPage_();
     else
       this.onNavigateAwayFromPage_();
@@ -149,7 +156,7 @@ Polymer({
   onNavigateToPage_: function() {
     // The element is not ready for C++ interaction until it is attached.
     assert(this.isAttached);
-    assert(settings.getCurrentRoute() == settings.Route.SYNC);
+    assert(this.currentRoute == settings.Route.SYNC);
 
     if (this.unloadCallback_)
       return;
@@ -294,7 +301,7 @@ Polymer({
         this.selectedPage_ = pageStatus;
         return;
       case settings.PageStatus.DONE:
-        if (settings.getCurrentRoute() == settings.Route.SYNC)
+        if (this.currentRoute == settings.Route.SYNC)
           settings.navigateTo(settings.Route.PEOPLE);
         return;
       case settings.PageStatus.PASSPHRASE_FAILED:
diff --git a/chrome/browser/resources/settings/printing_page/printing_page.html b/chrome/browser/resources/settings/printing_page/printing_page.html
index b529ae6..c462976 100644
--- a/chrome/browser/resources/settings/printing_page/printing_page.html
+++ b/chrome/browser/resources/settings/printing_page/printing_page.html
@@ -15,7 +15,8 @@
 <dom-module id="settings-printing-page">
   <template>
     <style include="settings-shared"></style>
-    <settings-animated-pages id="pages" section="printing">
+    <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+        section="printing">
       <array-selector id="arraySelector" items="{{cupsPrinters}}"
           selected="{{detailPrinter_}}">
       </array-selector>
diff --git a/chrome/browser/resources/settings/printing_page/printing_page.js b/chrome/browser/resources/settings/printing_page/printing_page.js
index d839c49..4b4598e 100644
--- a/chrome/browser/resources/settings/printing_page/printing_page.js
+++ b/chrome/browser/resources/settings/printing_page/printing_page.js
@@ -12,6 +12,12 @@ Polymer({
       notify: true,
     },
 
+    /** The current active route. */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
     /** @type {!Array<!CupsPrinterInfo>} */
     cupsPrinters: {
       type: Array,
diff --git a/chrome/browser/resources/settings/privacy_page/privacy_page.html b/chrome/browser/resources/settings/privacy_page/privacy_page.html
index de00468..78dca93 100644
--- a/chrome/browser/resources/settings/privacy_page/privacy_page.html
+++ b/chrome/browser/resources/settings/privacy_page/privacy_page.html
@@ -30,7 +30,8 @@
           on-close="onDialogClosed_">
       </settings-clear-browsing-data-dialog>
     </template>
-    <settings-animated-pages id="pages" section="privacy">
+    <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+        section="privacy">
       <neon-animatable id="main">
         <div class="settings-box block first">
           <p class="privacy-explanation">
@@ -118,7 +119,8 @@
             associated-control="[[$$('#site-settings-subpage-trigger')]]"
             id="site-settings"
             page-title="$i18n{siteSettings}">
-          <settings-site-settings-page category-selected="{{categorySelected}}">
+          <settings-site-settings-page current-route="{{currentRoute}}"
+              category-selected="{{categorySelected}}">
           </settings-site-settings-page>
         </settings-subpage>
       </template>
@@ -126,7 +128,10 @@
       <template is="dom-if" name="all-sites">
         <settings-subpage no-associated-control
             page-title="$i18n{siteSettingsCategoryAllSites}">
-          <all-sites selected-site="{{selectedSite}}"></all-sites>
+          <all-sites
+              selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}">
+          </all-sites>
         </settings-subpage>
       </template>
       <template is="dom-if" name="site-settings-category-automatic-downloads">
@@ -134,6 +139,7 @@
             page-title="$i18n{siteSettingsAutomaticDownloads}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.AUTOMATIC_DOWNLOADS}}">
           </site-settings-category>
         </settings-subpage>
@@ -143,6 +149,7 @@
             page-title="$i18n{siteSettingsBackgroundSync}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.BACKGROUND_SYNC}}">
           </site-settings-category>
         </settings-subpage>
@@ -152,6 +159,7 @@
             page-title="$i18n{siteSettingsCategoryCamera}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.CAMERA}}">
             <media-picker type="camera" class="media-picker"></media-picker>
           </site-settings-category>
@@ -162,6 +170,7 @@
             page-title="$i18n{siteSettingsCategoryCookies}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.COOKIES}}">
             <div class="settings-box cookie-controls">
               <settings-checkbox class="start"
@@ -179,6 +188,7 @@
             page-title="$i18n{siteSettingsCategoryImages}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.IMAGES}}">
           </site-settings-category>
         </settings-subpage>
@@ -188,6 +198,7 @@
             page-title="$i18n{siteSettingsCategoryLocation}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.GEOLOCATION}}">
           </site-settings-category>
         </settings-subpage>
@@ -203,6 +214,7 @@
             page-title="$i18n{siteSettingsCategoryJavascript}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.JAVASCRIPT}}">
           </site-settings-category>
         </settings-subpage>
@@ -212,6 +224,7 @@
             page-title="$i18n{siteSettingsKeygen}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.KEYGEN}}">
           </site-settings-category>
         </settings-subpage>
@@ -221,6 +234,7 @@
             page-title="$i18n{siteSettingsCategoryMicrophone}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.MIC}}">
             <media-picker type="mic" class="media-picker"></media-picker>
           </site-settings-category>
@@ -231,6 +245,7 @@
             page-title="$i18n{siteSettingsCategoryNotifications}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.NOTIFICATIONS}}">
           </site-settings-category>
         </settings-subpage>
@@ -240,6 +255,7 @@
             page-title="$i18n{siteSettingsPlugins}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.PLUGINS}}">
           </site-settings-category>
         </settings-subpage>
@@ -249,6 +265,7 @@
             page-title="$i18n{siteSettingsCategoryPopups}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.POPUPS}}">
           </site-settings-category>
         </settings-subpage>
@@ -258,6 +275,7 @@
             page-title="$i18n{siteSettingsUnsandboxedPlugins}">
           <site-settings-category
               selected-site="{{selectedSite}}"
+              current-route="{{currentRoute}}"
               category="{{ContentSettingsTypes.UNSANDBOXED_PLUGINS}}">
           </site-settings-category>
         </settings-subpage>
diff --git a/chrome/browser/resources/settings/privacy_page/privacy_page.js b/chrome/browser/resources/settings/privacy_page/privacy_page.js
index 1134a53..4919fe2 100644
--- a/chrome/browser/resources/settings/privacy_page/privacy_page.js
+++ b/chrome/browser/resources/settings/privacy_page/privacy_page.js
@@ -10,8 +10,6 @@
 Polymer({
   is: 'settings-privacy-page',
 
-  behaviors: [settings.RouteObserverBehavior],
-
   properties: {
     /**
      * Preferences state.
@@ -21,8 +19,19 @@ Polymer({
       notify: true,
     },
 
+    /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
     /** @private */
-    showClearBrowsingDataDialog_: Boolean,
+    showClearBrowsingDataDialog_: {
+      computed: 'computeShowClearBrowsingDataDialog_(currentRoute)',
+      type: Boolean,
+    },
 
     /**
      * Dictionary defining page visibility.
@@ -35,10 +44,13 @@ Polymer({
     this.ContentSettingsTypes = settings.ContentSettingsTypes;
   },
 
-  /** @protected */
-  currentRouteChanged: function() {
-    this.showClearBrowsingDataDialog_ =
-        settings.getCurrentRoute().dialog == 'clear-browsing-data';
+  /**
+   * @return {boolean} Whether the Clear Browsing Data dialog should be showing.
+   * @private
+   */
+  computeShowClearBrowsingDataDialog_: function() {
+    var route = this.currentRoute;
+    return route && route.dialog == 'clear-browsing-data';
   },
 
   /** @private */
diff --git a/chrome/browser/resources/settings/route.js b/chrome/browser/resources/settings/route.js
index 096b3c1..728caf4 100644
--- a/chrome/browser/resources/settings/route.js
+++ b/chrome/browser/resources/settings/route.js
@@ -270,10 +270,6 @@ cr.define('settings', function() {
     attached: function() {
       assert(!routeObservers_.has(this));
       routeObservers_.add(this);
-
-      // Emulating Polymer data bindings, the observer is called when the
-      // element starts observing the route.
-      this.currentRouteChanged(currentRoute_, undefined);
     },
 
     /** @override */
@@ -329,11 +325,10 @@ cr.define('settings', function() {
    * @param {!URLSearchParams} queryParameters
    */
   var setCurrentRoute = function(route, queryParameters) {
-    var oldRoute = currentRoute_;
     currentRoute_ = route;
     currentQueryParameters_ = queryParameters;
     for (var observer of routeObservers_)
-      observer.currentRouteChanged(currentRoute_, oldRoute);
+      observer.currentRouteChanged();
   };
 
   /** @return {!settings.Route} */
diff --git a/chrome/browser/resources/settings/search_page/search_page.html b/chrome/browser/resources/settings/search_page/search_page.html
index c85e109..98aa02e 100644
--- a/chrome/browser/resources/settings/search_page/search_page.html
+++ b/chrome/browser/resources/settings/search_page/search_page.html
@@ -14,7 +14,8 @@
   <template>
     <style include="settings-shared">
     </style>
-    <settings-animated-pages id="pages" section="search">
+    <settings-animated-pages id="pages" current-route="{{currentRoute}}"
+        section="search">
       <neon-animatable id="main">
         <div class="settings-box first">
           <p class="start">$i18n{searchExplanation}</p>
diff --git a/chrome/browser/resources/settings/search_page/search_page.js b/chrome/browser/resources/settings/search_page/search_page.js
index 31cc04f..606618f 100644
--- a/chrome/browser/resources/settings/search_page/search_page.js
+++ b/chrome/browser/resources/settings/search_page/search_page.js
@@ -11,6 +11,14 @@ Polymer({
 
   properties: {
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * List of default search engines available.
      * @private {!Array<!SearchEngine>}
      */
diff --git a/chrome/browser/resources/settings/search_settings.js b/chrome/browser/resources/settings/search_settings.js
index bc09858..4d195ce 100644
--- a/chrome/browser/resources/settings/search_settings.js
+++ b/chrome/browser/resources/settings/search_settings.js
@@ -9,9 +9,6 @@ cr.define('settings', function() {
   /** @const {string} */
   var HIT_CSS_CLASS = 'search-highlight-hit';
 
-  /** @const {string} */
-  var SEARCH_BUBBLE_CSS_CLASS = 'search-bubble';
-
   /**
    * List of elements types that should not be searched at all.
    * The only DOM-MODULE node is in <body> which is not searched, therefore
@@ -39,8 +36,7 @@ cr.define('settings', function() {
 
   /**
    * Finds all previous highlighted nodes under |node| (both within self and
-   * children's Shadow DOM) and removes the highlights (yellow rectangle and
-   * search bubbles).
+   * children's Shadow DOM) and removes the highlight (yellow rectangle).
    * TODO(dpapad): Consider making this a private method of TopLevelSearchTask.
    * @param {!Node} node
    * @private
@@ -65,11 +61,6 @@ cr.define('settings', function() {
 
       wrapper.parentElement.replaceChild(wrapper.firstChild, wrapper);
     }
-
-    var searchBubbles = node.querySelectorAll(
-        '* /deep/ .' + SEARCH_BUBBLE_CSS_CLASS);
-    for (var searchBubble of searchBubbles)
-      searchBubble.remove();
   }
 
   /**
@@ -96,6 +87,7 @@ cr.define('settings', function() {
       } else {
         var span = document.createElement('span');
         span.classList.add(HIT_CSS_CLASS);
+        span.style.backgroundColor = 'yellow';
         span.textContent = tokens[i];
         wrapper.appendChild(span);
       }
@@ -132,7 +124,7 @@ cr.define('settings', function() {
 
         if (request.regExp.test(textContent)) {
           foundMatches = true;
-          revealParentSection_(node, request.rawQuery_);
+          revealParentSection_(node);
           highlight_(node, textContent.split(request.regExp));
         }
         // Returning early since TEXT_NODE nodes never have children.
@@ -158,62 +150,18 @@ cr.define('settings', function() {
   }
 
   /**
-   * Highlights the HTML control that triggers a subpage, by displaying a search
-   * bubble.
-   * @param {!HTMLElement} element The element to be highlighted.
-   * @param {string} rawQuery The search query.
-   * @private
-   */
-  function highlightAssociatedControl_(element, rawQuery) {
-    var searchBubble = element.querySelector('.' + SEARCH_BUBBLE_CSS_CLASS);
-    // If the associated control has already been highlighted due to another
-    // match on the same subpage, there is no need to do anything.
-    if (searchBubble)
-      return;
-
-    searchBubble = document.createElement('div');
-    searchBubble.classList.add(SEARCH_BUBBLE_CSS_CLASS);
-    var innards = document.createElement('div');
-    innards.classList.add('search-bubble-innards');
-    innards.textContent = rawQuery;
-    searchBubble.appendChild(innards);
-    element.appendChild(searchBubble);
-
-    // Dynamically position the bubble at the edge the associated controle
-    // elemnt.
-    searchBubble.style.left = '-' + searchBubble.offsetWidth + 'px';
-  }
-
-  /**
    * Finds and makes visible the <settings-section> parent of |node|.
    * @param {!Node} node
-   * @param {string} rawQuery
-   * @private
    */
-  function revealParentSection_(node, rawQuery) {
-    var associatedControl = null;
+  function revealParentSection_(node) {
     // Find corresponding SETTINGS-SECTION parent and make it visible.
     var parent = node;
     while (parent && parent.nodeName !== 'SETTINGS-SECTION') {
       parent = parent.nodeType == Node.DOCUMENT_FRAGMENT_NODE ?
           parent.host : parent.parentNode;
-      if (parent.nodeName == 'SETTINGS-SUBPAGE') {
-        // TODO(dpapad): Cast to SettingsSubpageElement here.
-        if (!parent.noAssociatedControl) {
-          associatedControl = assert(
-              parent.associatedControl,
-              'An associated control was expected for SETTINGS-SUBPAGE ' +
-                  parent.pageTitle + ', but was not found.');
-        }
-      }
     }
     if (parent)
       parent.hidden = false;
-
-    // Need to add the search bubble after the parent SETTINGS-SECTION has
-    // become visible, otherwise |offsetWidth| returns zero.
-    if (associatedControl)
-      highlightAssociatedControl_(associatedControl, rawQuery);
   }
 
   /**
diff --git a/chrome/browser/resources/settings/settings_main/compiled_resources2.gyp b/chrome/browser/resources/settings/settings_main/compiled_resources2.gyp
index a6992e5..314a56b 100644
--- a/chrome/browser/resources/settings/settings_main/compiled_resources2.gyp
+++ b/chrome/browser/resources/settings/settings_main/compiled_resources2.gyp
@@ -9,6 +9,7 @@
         '../compiled_resources2.gyp:route',
         '../compiled_resources2.gyp:search_settings',
         '../settings_page/compiled_resources2.gyp:main_page_behavior',
+        '../settings_page/compiled_resources2.gyp:settings_router',
         '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:assert',
         '../settings_page/compiled_resources2.gyp:settings_page_visibility',
         '../settings_ui/compiled_resources2.gyp:settings_ui_types',
diff --git a/chrome/browser/resources/settings/settings_main/settings_main.html b/chrome/browser/resources/settings/settings_main/settings_main.html
index 0eb24b2..5b4e489 100644
--- a/chrome/browser/resources/settings/settings_main/settings_main.html
+++ b/chrome/browser/resources/settings/settings_main/settings_main.html
@@ -58,7 +58,7 @@
       <div>$i18nRaw{searchNoResultsHelp}</div>
     </div>
     <template is="dom-if" if="[[showPages_.basic]]">
-      <settings-basic-page prefs="{{prefs}}"
+      <settings-basic-page prefs="{{prefs}}" current-route="{{currentRoute}}"
           page-visibility="[[pageVisibility]]">
       </settings-basic-page>
     </template>
@@ -76,12 +76,14 @@
       </template>
       <template is="dom-if" if="[[showPages_.advanced]]">
         <settings-advanced-page prefs="{{prefs}}"
+            current-route="{{currentRoute}}"
             page-visibility="[[pageVisibility]]">
         </settings-advanced-page>
       </template>
     </template>
     <template is="dom-if" if="[[showPages_.about]]">
-      <settings-about-page></settings-about-page>
+      <settings-about-page current-route="{{currentRoute}}">
+      </settings-about-page>
     </template>
     <div id="overscroll" style="padding-bottom: [[overscroll_]]px"></div>
   </template>
diff --git a/chrome/browser/resources/settings/settings_main/settings_main.js b/chrome/browser/resources/settings/settings_main/settings_main.js
index 676429b..30eb744 100644
--- a/chrome/browser/resources/settings/settings_main/settings_main.js
+++ b/chrome/browser/resources/settings/settings_main/settings_main.js
@@ -9,8 +9,6 @@
 Polymer({
   is: 'settings-main',
 
-  behaviors: [settings.RouteObserverBehavior],
-
   properties: {
     /**
      * Preferences state.
@@ -20,6 +18,16 @@ Polymer({
       notify: true,
     },
 
+    /**
+     * The current active route.
+     * @type {!settings.Route}
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+      observer: 'currentRouteChanged_',
+    },
+
     /** @private */
     advancedToggleExpanded_: {
       type: Boolean,
@@ -121,8 +129,10 @@ Polymer({
     return showBasicPage && !inSubpage;
   },
 
-  /** @protected */
-  currentRouteChanged: function(newRoute) {
+  /**
+   * @private
+   */
+  currentRouteChanged_: function(newRoute) {
     this.inSubpage_ = newRoute.subpage.length > 0;
     this.style.height = this.inSubpage_ ? '100%' : '';
 
@@ -161,11 +171,12 @@ Polymer({
    * @private
    */
   overscrollHeight_: function() {
-    var route = settings.getCurrentRoute();
-    if (route.subpage.length != 0 || this.showPages_.about)
+    if (!this.currentRoute || this.currentRoute.subpage.length != 0 ||
+        this.showPages_.about) {
       return 0;
+    }
 
-    var query = 'settings-section[section="' + route.section + '"]';
+    var query = 'settings-section[section="' + this.currentRoute.section + '"]';
     var topSection = this.$$('settings-basic-page').$$(query);
     if (!topSection && this.showPages_.advanced)
       topSection = this.$$('settings-advanced-page').$$(query);
diff --git a/chrome/browser/resources/settings/settings_menu/compiled_resources2.gyp b/chrome/browser/resources/settings/settings_menu/compiled_resources2.gyp
index 9a390d6..a5755bf 100644
--- a/chrome/browser/resources/settings/settings_menu/compiled_resources2.gyp
+++ b/chrome/browser/resources/settings/settings_menu/compiled_resources2.gyp
@@ -8,6 +8,7 @@
       'dependencies': [
         '<(DEPTH)/third_party/polymer/v1_0/components-chromium/paper-ripple/compiled_resources2.gyp:paper-ripple-extracted',
         '../compiled_resources2.gyp:route',
+        '../settings_page/compiled_resources2.gyp:settings_router',
         '../settings_ui/compiled_resources2.gyp:settings_ui_types',
       ],
       'includes': ['../../../../../third_party/closure_compiler/compile_js2.gypi'],
diff --git a/chrome/browser/resources/settings/settings_menu/settings_menu.js b/chrome/browser/resources/settings/settings_menu/settings_menu.js
index 494228b..e59f664 100644
--- a/chrome/browser/resources/settings/settings_menu/settings_menu.js
+++ b/chrome/browser/resources/settings/settings_menu/settings_menu.js
@@ -14,6 +14,15 @@ Polymer({
     advancedOpened_: Boolean,
 
     /**
+     * The current active route.
+     * @type {!settings.Route}
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * Dictionary defining page visibility.
      * @type {!GuestModePageVisibility}
      */
@@ -39,7 +48,7 @@ Polymer({
     }.bind(this));
 
     this.fire('toggle-advanced-page',
-              settings.Route.ADVANCED.contains(settings.getCurrentRoute()));
+              settings.Route.ADVANCED.contains(this.currentRoute));
   },
 
   /**
diff --git a/chrome/browser/resources/settings/settings_page/compiled_resources2.gyp b/chrome/browser/resources/settings/settings_page/compiled_resources2.gyp
index 5fe9919..f47f367 100644
--- a/chrome/browser/resources/settings/settings_page/compiled_resources2.gyp
+++ b/chrome/browser/resources/settings/settings_page/compiled_resources2.gyp
@@ -6,7 +6,6 @@
     {
       'target_name': 'main_page_behavior',
       'dependencies': [
-        '../compiled_resources2.gyp:route',
         'settings_section',
         'transition_behavior',
         '<(EXTERNS_GYP):settings_private',
@@ -29,13 +28,19 @@
       'includes': ['../../../../../third_party/closure_compiler/compile_js2.gypi'],
     },
     {
-      'target_name': 'settings_section',
+      'target_name': 'settings_router',
       'dependencies': [
-        '<(EXTERNS_GYP):web_animations',
+        '../compiled_resources2.gyp:route',
+        '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:assert',
+        '<(DEPTH)/ui/webui/resources/js/compiled_resources2.gyp:load_time_data',
       ],
       'includes': ['../../../../../third_party/closure_compiler/compile_js2.gypi'],
     },
     {
+      'target_name': 'settings_section',
+      'includes': ['../../../../../third_party/closure_compiler/compile_js2.gypi'],
+    },
+    {
       'target_name': 'settings_subpage',
       'dependencies': [
         'settings_subpage_search',
diff --git a/chrome/browser/resources/settings/settings_page/main_page_behavior.html b/chrome/browser/resources/settings/settings_page/main_page_behavior.html
index 90c04a7..33629c6 100644
--- a/chrome/browser/resources/settings/settings_page/main_page_behavior.html
+++ b/chrome/browser/resources/settings/settings_page/main_page_behavior.html
@@ -1,4 +1,20 @@
-<link rel="import" href="/route.html">
+<link rel="import" href="chrome://resources/html/polymer.html">
 <link rel="import" href="/settings_page/transition_behavior.html">
-
 <script src="/settings_page/main_page_behavior.js"></script>
+
+<dom-module id="main-page-styles">
+  <template>
+    <style>
+      .expanding,
+      .collapsing {
+        /* Must be lower than the paper-header-panel's z-index.
+         * See settings_ui.html. */
+        z-index: 1;
+      }
+
+      .expanded {
+        min-height: 100%;
+      }
+    </style>
+  </template>
+</dom-module>
diff --git a/chrome/browser/resources/settings/settings_page/main_page_behavior.js b/chrome/browser/resources/settings/settings_page/main_page_behavior.js
index ce711bf..da8828c 100644
--- a/chrome/browser/resources/settings/settings_page/main_page_behavior.js
+++ b/chrome/browser/resources/settings/settings_page/main_page_behavior.js
@@ -2,6 +2,10 @@
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
+// Fast out, slow in.
+var EASING_FUNCTION = 'cubic-bezier(0.4, 0, 0.2, 1)';
+var EXPAND_DURATION = 350;
+
 /**
  * Calls |readyTest| repeatedly until it returns true, then calls
  * |readyCallback|.
@@ -26,7 +30,7 @@ function doWhenReady(readyTest, readyCallback) {
  * @polymerBehavior Polymer.MainPageBehavior
  */
 var MainPageBehaviorImpl = {
-  /** @type {?HTMLElement} The scrolling container. */
+  /** @type {?Element} The scrolling container. */
   scroller: null,
 
   /** @override */
@@ -98,7 +102,7 @@ var MainPageBehaviorImpl = {
    * @param {!SettingsSectionElement} section
    */
   startExpandSection_: function(section) {
-    if (!section.canAnimateExpand())
+    if (section.classList.contains('expanded'))
       return;
 
     // Freeze the scroller and save its position.
@@ -111,7 +115,7 @@ var MainPageBehaviorImpl = {
     this.scroller.style.width = 'calc(100% - ' + scrollbarWidth + 'px)';
 
     // Freezes the section's height so its card can be removed from the flow.
-    section.setFrozen(true);
+    this.freezeSection_(section);
 
     // Expand the section's card to fill the parent.
     var animationPromise = this.playExpandSection_(section);
@@ -121,7 +125,7 @@ var MainPageBehaviorImpl = {
       this.toggleOtherSectionsHidden_(section.section, true);
     }.bind(this), function() {
       // Animation was canceled; restore the section.
-      section.setFrozen(false);
+      this.unfreezeSection_(section);
     }.bind(this)).then(function() {
       this.scroller.style.overflow = '';
       this.scroller.style.width = '';
@@ -147,7 +151,7 @@ var MainPageBehaviorImpl = {
       return;
     }
 
-    if (!section.canAnimateCollapse())
+    if (!section.classList.contains('expanded'))
       return;
 
     this.toggleOtherSectionsHidden_(section.section, false);
@@ -159,7 +163,7 @@ var MainPageBehaviorImpl = {
     this.scroller.style.width = 'calc(100% - ' + scrollbarWidth + 'px)';
 
     this.playCollapseSection_(section).then(function() {
-      section.setFrozen(false);
+      this.unfreezeSection_(section);
       this.scroller.style.overflow = '';
       this.scroller.style.width = '';
       section.classList.remove('collapsing');
@@ -167,33 +171,106 @@ var MainPageBehaviorImpl = {
   },
 
   /**
+   * Freezes a section's height so its card can be removed from the flow without
+   * affecting the layout of the surrounding sections.
+   * @param {!SettingsSectionElement} section
+   * @private
+   */
+  freezeSection_: function(section) {
+    var card = section.$.card;
+    section.style.height = section.clientHeight + 'px';
+
+    var cardHeight = card.offsetHeight;
+    var cardWidth = card.offsetWidth;
+    // If the section is not displayed yet (e.g., navigated directly to a
+    // sub-page), cardHeight and cardWidth are 0, so do not set the height or
+    // width explicitly.
+    // TODO(michaelpg): Improve this logic when refactoring
+    // settings-animated-pages.
+    if (cardHeight && cardWidth) {
+      // TODO(michaelpg): Temporary hack to store the height the section should
+      // collapse to when it closes.
+      card.origHeight_ = cardHeight;
+
+      card.style.height = cardHeight + 'px';
+      card.style.width = cardWidth + 'px';
+    } else {
+      // Set an invalid value so we don't try to use it later.
+      card.origHeight_ = NaN;
+    }
+
+    // Place the section's card at its current position but removed from the
+    // flow.
+    card.style.top = card.getBoundingClientRect().top + 'px';
+    section.classList.add('frozen');
+  },
+
+  /**
+   * After freezeSection_, restores the section to its normal height.
+   * @param {!SettingsSectionElement} section
+   * @private
+   */
+  unfreezeSection_: function(section) {
+    if (!section.classList.contains('frozen'))
+      return;
+    var card = section.$.card;
+    section.classList.remove('frozen');
+    card.style.top = '';
+    card.style.height = '';
+    card.style.width = '';
+    section.style.height = '';
+  },
+
+  /**
    * Expands the card in |section| to fill the page.
    * @param {!SettingsSectionElement} section
    * @return {!Promise}
    * @private
    */
   playExpandSection_: function(section) {
-    // We must be attached.
-    assert(this.scroller);
-
+    var card = section.$.card;
+
+    // The card should start at the top of the page.
+    var targetTop = this.scroller.getBoundingClientRect().top;
+
+    section.classList.add('expanding');
+
+    // Expand the card, using minHeight. (The card must span the container's
+    // client height, so it must be at least 100% in case the card is too short.
+    // If the card is already taller than the container's client height, we
+    // don't want to shrink the card to 100% or the content will overflow, so
+    // we can't use height, and animating height wouldn't look right anyway.)
+    var keyframes = [{
+      top: card.style.top,
+      minHeight: card.style.height,
+      easing: EASING_FUNCTION,
+    }, {
+      top: targetTop + 'px',
+      minHeight: 'calc(100% - ' + targetTop + 'px)',
+    }];
+    var options = /** @type {!KeyframeEffectOptions} */({
+      duration: EXPAND_DURATION
+    });
+    // TODO(michaelpg): Change elevation of sections.
     var promise;
-    var animationConfig = section.animateExpand(this.scroller);
-    if (animationConfig) {
-      promise = this.animateElement('section', animationConfig.card,
-          animationConfig.keyframes, animationConfig.options);
-    } else {
+    if (keyframes[0].top && keyframes[0].minHeight)
+      promise = this.animateElement('section', card, keyframes, options);
+    else
       promise = Promise.resolve();
-    }
 
-    var finished;
     promise.then(function() {
-      finished = true;
+      section.classList.add('expanded');
+      card.style.top = '';
       this.style.margin = 'auto';
+      section.$.header.hidden = true;
+      section.style.height = '';
     }.bind(this), function() {
       // The animation was canceled; catch the error and continue.
-      finished = false;
     }).then(function() {
-      section.cleanUpAnimateExpand(finished);
+      // Whether finished or canceled, clean up the animation.
+      section.classList.remove('expanding');
+      card.style.height = '';
+      card.style.width = '';
     });
 
     return promise;
@@ -206,25 +283,58 @@ var MainPageBehaviorImpl = {
    * @private
    */
   playCollapseSection_: function(section) {
-    // We must be attached.
-    assert(this.scroller);
+    var card = section.$.card;
 
     this.style.margin = '';
+    section.$.header.hidden = false;
+
+    var startingTop = this.scroller.getBoundingClientRect().top;
+
+    var cardHeightStart = card.clientHeight;
+    var cardWidthStart = card.clientWidth;
+
+    section.classList.add('collapsing');
+    section.classList.remove('expanding', 'expanded');
+
+    // If we navigated here directly, we don't know the original height of the
+    // section, so we skip the animation.
+    // TODO(michaelpg): remove this condition once sliding is implemented.
+    if (isNaN(card.origHeight_))
+      return Promise.resolve();
+
+    // Restore the section to its proper height to make room for the card.
+    section.style.height = section.clientHeight + card.origHeight_ + 'px';
+
+    // TODO(michaelpg): this should be in collapseSection(), but we need to wait
+    // until the full page height is available (setting the section height).
+    this.scroller.scrollTop = this.listScrollTop_;
+
+    // The card is unpositioned, so use its position as the ending state,
+    // but account for scroll.
+    var targetTop = card.getBoundingClientRect().top - this.scroller.scrollTop;
+
+    // Account for the section header.
+    var headerStyle = getComputedStyle(section.$.header);
+    targetTop += section.$.header.offsetHeight +
+        parseInt(headerStyle.marginBottom, 10) +
+        parseInt(headerStyle.marginTop, 10);
+
+    var keyframes = [{
+      top: startingTop + 'px',
+      minHeight: cardHeightStart + 'px',
+      easing: EASING_FUNCTION,
+    }, {
+      top: targetTop + 'px',
+      minHeight: card.origHeight_ + 'px',
+    }];
+    var options = /** @type {!KeyframeEffectOptions} */({
+      duration: EXPAND_DURATION
+    });
 
-    var promise;
-    var animationConfig =
-        section.animateCollapse(this.scroller, this.listScrollTop_);
-    if (animationConfig) {
-      promise = this.animateElement('section', animationConfig.card,
-          animationConfig.keyframes, animationConfig.options);
-    } else {
-      promise = Promise.resolve();
-    }
-
+    card.style.width = cardWidthStart + 'px';
+    var promise = this.animateElement('section', card, keyframes, options);
     promise.then(function() {
-      section.cleanUpAnimateCollapse(true);
-    }, function() {
-      section.cleanUpAnimateCollapse(false);
+      card.style.width = '';
     });
     return promise;
   },
@@ -243,6 +353,15 @@ var MainPageBehavior = [
  * @polymerBehavior RoutableBehavior
  */
 var RoutableBehaviorImpl = {
+  properties: {
+    /** Contains the current route. */
+    currentRoute: {
+      type: Object,
+      notify: true,
+      observer: 'currentRouteChanged_',
+    },
+  },
+
   /** @private */
   scrollToSection_: function() {
     doWhenReady(
@@ -252,12 +371,12 @@ var RoutableBehaviorImpl = {
         function() {
           // If the current section changes while we are waiting for the page to
           // be ready, scroll to the newest requested section.
-          this.getSection_(settings.getCurrentRoute().section).scrollIntoView();
+          this.getSection_(this.currentRoute.section).scrollIntoView();
         }.bind(this));
   },
 
   /** @private */
-  currentRouteChanged: function(newRoute, oldRoute) {
+  currentRouteChanged_: function(newRoute, oldRoute) {
     var newRouteIsSubpage = newRoute && newRoute.subpage.length;
     var oldRouteIsSubpage = oldRoute && oldRoute.subpage.length;
 
@@ -307,6 +426,5 @@ var RoutableBehaviorImpl = {
 /** @polymerBehavior */
 var RoutableBehavior = [
   MainPageBehavior,
-  settings.RouteObserverBehavior,
   RoutableBehaviorImpl
 ];
diff --git a/chrome/browser/resources/settings/settings_page/settings_animated_pages.html b/chrome/browser/resources/settings/settings_page/settings_animated_pages.html
index 60ccd27..5139868 100644
--- a/chrome/browser/resources/settings/settings_page/settings_animated_pages.html
+++ b/chrome/browser/resources/settings/settings_page/settings_animated_pages.html
@@ -19,10 +19,6 @@
         display: block;
       }
 
-      neon-animated-pages {
-        position: static;
-      }
-
       neon-animated-pages ::content > .iron-selected {
         position: static;
       }
diff --git a/chrome/browser/resources/settings/settings_page/settings_animated_pages.js b/chrome/browser/resources/settings/settings_page/settings_animated_pages.js
index 682ead2..55131d1 100644
--- a/chrome/browser/resources/settings/settings_page/settings_animated_pages.js
+++ b/chrome/browser/resources/settings/settings_page/settings_animated_pages.js
@@ -9,22 +9,30 @@
  *
  * Example:
  *
- *    <settings-animated-pages section="privacy">
+ *    <settings-animated-pages current-route="{{currentRoute}}"
+ *        section="privacy">
  *      <!-- Insert your section controls here -->
  *    </settings-animated-pages>
  */
 Polymer({
   is: 'settings-animated-pages',
 
-  behaviors: [settings.RouteObserverBehavior],
-
   properties: {
     /**
+     * Contains the current route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+      observer: 'currentRouteChanged_',
+    },
+
+    /**
      * Routes with this section activate this element. For instance, if this
      * property is 'search', and currentRoute.section is also set to 'search',
      * this element will display the subpage in currentRoute.subpage.
      *
-     * The section name must match the name specified in route.js.
+     * The section name must match the name specified in settings_router.js.
      */
     section: {
       type: String,
@@ -38,9 +46,7 @@ Polymer({
         this.lightDomChanged_.bind(this));
 
     this.addEventListener('subpage-back', function() {
-      var parent = settings.getCurrentRoute().parent;
-      assert(parent);
-      settings.navigateTo(parent);
+      settings.navigateTo(this.currentRoute.parent);
     }.bind(this));
   },
 
@@ -58,20 +64,20 @@ Polymer({
   },
 
   /**
-   * Calls currentRouteChanged with the deferred route change info.
+   * Calls currentRouteChanged_ with the deferred route change info.
    * @private
    */
   runQueuedRouteChange_: function() {
     if (!this.queuedRouteChange_)
       return;
-    this.async(this.currentRouteChanged.bind(
+    this.async(this.currentRouteChanged_.bind(
         this,
         this.queuedRouteChange_.newRoute,
         this.queuedRouteChange_.oldRoute));
   },
 
-  /** @protected */
-  currentRouteChanged: function(newRoute, oldRoute) {
+  /** @private */
+  currentRouteChanged_: function(newRoute, oldRoute) {
     if (newRoute.section == this.section && newRoute.subpage.length > 0) {
       this.switchToSubpage_(newRoute, oldRoute);
     } else {
@@ -133,7 +139,7 @@ Polymer({
    * @private
    */
   ensureSubpageInstance_: function() {
-    var id = settings.getCurrentRoute().subpage.slice(-1)[0];
+    var id = this.currentRoute.subpage.slice(-1)[0];
     var template = Polymer.dom(this).querySelector(
         'template[name="' + id + '"]');
 
diff --git a/chrome/browser/resources/settings/settings_page/settings_router.html b/chrome/browser/resources/settings/settings_page/settings_router.html
new file mode 100644
index 0000000..5133b04
--- /dev/null
+++ b/chrome/browser/resources/settings/settings_page/settings_router.html
@@ -0,0 +1,5 @@
+<link rel="import" href="chrome://resources/html/polymer.html">
+<link rel="import" href="/i18n_setup.html">
+<link rel="import" href="/route.html">
+
+<script src="settings_router.js"></script>
diff --git a/chrome/browser/resources/settings/settings_page/settings_router.js b/chrome/browser/resources/settings/settings_page/settings_router.js
new file mode 100644
index 0000000..bdde44f
--- /dev/null
+++ b/chrome/browser/resources/settings/settings_page/settings_router.js
@@ -0,0 +1,37 @@
+// Copyright 2015 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+/**
+ * @fileoverview
+ * 'settings-router' is only used to propagate route changes to bound elements.
+ * All the real routing is defined within route.js.
+ * TODO(tommycli): Remove once all elements migrated to RouteObserverBehavior.
+ *
+ * Example:
+ *    <settings-router current-route="{{currentRoute}}">
+ *    </settings-router>
+ */
+Polymer({
+  is: 'settings-router',
+
+  behaviors: [settings.RouteObserverBehavior],
+
+  properties: {
+    /**
+     * Only used to propagate settings.currentRoute to all the elements bound to
+     * settings-router.
+     * @type {!settings.Route}
+     */
+    currentRoute: {
+      notify: true,
+      type: Object,
+      value: function() { return settings.getCurrentRoute(); },
+    },
+  },
+
+  /** @protected */
+  currentRouteChanged: function() {
+    this.currentRoute = settings.getCurrentRoute();
+  },
+});
diff --git a/chrome/browser/resources/settings/settings_page/settings_section.html b/chrome/browser/resources/settings/settings_page/settings_section.html
index d475b15..2df5028 100644
--- a/chrome/browser/resources/settings/settings_page/settings_section.html
+++ b/chrome/browser/resources/settings/settings_page/settings_section.html
@@ -29,6 +29,10 @@
         overflow: hidden;
       }
 
+      :host(.expanded) {
+        margin-bottom: 0;
+      }
+
       :host(.expanded) #header {
         display: none;
       }
diff --git a/chrome/browser/resources/settings/settings_page/settings_section.js b/chrome/browser/resources/settings/settings_page/settings_section.js
index de1e420..1149e2e 100644
--- a/chrome/browser/resources/settings/settings_page/settings_section.js
+++ b/chrome/browser/resources/settings/settings_page/settings_section.js
@@ -7,227 +7,34 @@
  * 'settings-section' shows a paper material themed section with a header
  * which shows its page title.
  *
- * The section can expand vertically to fill its container's padding edge.
- *
  * Example:
  *
  *    <settings-section page-title="[[pageTitle]]" section="privacy">
  *      <!-- Insert your section controls here -->
  *    </settings-section>
  */
-
-// Fast out, slow in.
-var EASING_FUNCTION = 'cubic-bezier(0.4, 0, 0.2, 1)';
-var EXPAND_DURATION = 350;
-
-var SettingsSectionElement = Polymer({
+Polymer({
   is: 'settings-section',
 
   properties: {
     /**
-     * The section name should match a name specified in route.js. The
-     * MainPageBehavior will expand this section if this section name matches
+     * The current active route.
+     */
+    currentRoute: Object,
+
+    /**
+     * The section is expanded to a full-page view when this property matches
      * currentRoute.section.
+     *
+     * The section name must match the name specified in settings_router.js.
      */
-    section: String,
+    section: {
+      type: String,
+    },
 
-    /** Title for the section header. */
+    /**
+     * Title for the page header and navigation menu.
+     */
     pageTitle: String,
   },
-
-  /**
-   * Freezes the section's height so its card can be removed from the flow
-   * without affecting the layout of the surrounding sections.
-   * @param {boolean} frozen True to freeze, false to unfreeze.
-   * @private
-   */
-  setFrozen: function(frozen) {
-    var card = this.$.card;
-    if (frozen) {
-      this.style.height = this.clientHeight + 'px';
-
-      var cardHeight = card.offsetHeight;
-      var cardWidth = card.offsetWidth;
-      // If the section is not displayed yet (e.g., navigated directly to a
-      // sub-page), cardHeight and cardWidth are 0, so do not set the height or
-      // width explicitly.
-      // TODO(michaelpg): Improve this logic when refactoring
-      // settings-animated-pages.
-      if (cardHeight && cardWidth) {
-        // TODO(michaelpg): Temporary hack to store the height the section
-        // should collapse to when it closes.
-        card.origHeight_ = cardHeight;
-
-        card.style.height = cardHeight + 'px';
-        card.style.width = cardWidth + 'px';
-      } else {
-        // Set an invalid value so we don't try to use it later.
-        card.origHeight_ = NaN;
-      }
-
-      // Place the section's card at its current position but removed from the
-      // flow.
-      card.style.top = card.getBoundingClientRect().top + 'px';
-      this.classList.add('frozen');
-    } else {
-      // Restore the section to its normal height.
-      if (!this.classList.contains('frozen'))
-        return;
-      this.classList.remove('frozen');
-      this.$.card.style.top = '';
-      this.$.card.style.height = '';
-      this.$.card.style.width = '';
-      this.style.height = '';
-    }
-  },
-
-  /**
-   * @return {boolean} True if the section is currently rendered and not
-   *     already expanded or transitioning.
-   */
-  canAnimateExpand: function() {
-    return !this.classList.contains('expanded');
-  },
-
-  /**
-   * Animates the section expanding to fill the container. The section is fixed
-   * in the viewport during the animation. The section adds the "expanding"
-   * class while the animation plays.
-   *
-   * @param {!HTMLElement} container The scrolling container to fill.
-   * @return {?SettingsSectionElement.AnimationConfig}
-   */
-  animateExpand: function(container) {
-    var card = this.$.card;
-
-    // The card should start at the top of the page.
-    var targetTop = container.getBoundingClientRect().top;
-
-    this.classList.add('expanding');
-
-    // Nothing to animate.
-    if (!card.style.top || !card.style.height)
-      return null;
-
-    // Expand the card, using minHeight. (The card must span the container's
-    // client height, so it must be at least 100% in case the card is too short.
-    // If the card is already taller than the container's client height, we
-    // don't want to shrink the card to 100% or the content will overflow, so
-    // we can't use height, and animating height wouldn't look right anyway.)
-    var keyframes = [{
-      top: card.style.top,
-      minHeight: card.style.height,
-      easing: EASING_FUNCTION,
-    }, {
-      top: targetTop + 'px',
-      minHeight: 'calc(100% - ' + targetTop + 'px)',
-    }];
-    var options = /** @type {!KeyframeEffectOptions} */({
-      duration: EXPAND_DURATION
-    });
-    // TODO(michaelpg): Change elevation of sections.
-    return {card: card, keyframes: keyframes, options: options};
-  },
-
-  /**
-   * Cleans up after animateExpand().
-   * @param {boolean} finished Whether the animation finished successfully.
-   */
-  cleanUpAnimateExpand: function(finished) {
-    if (finished) {
-      this.classList.add('expanded');
-      this.$.card.style.top = '';
-      this.$.header.hidden = true;
-      this.style.height = '';
-    }
-
-    this.classList.remove('expanding');
-    this.$.card.style.height = '';
-    this.$.card.style.width = '';
-  },
-
-  /** @return {boolean} True if the section is currently expanded. */
-  canAnimateCollapse: function() {
-    return this.classList.contains('expanded');
-  },
-
-  /**
-   * Collapses an expanded section's card back into position in the main page.
-   * Adds the "expanding" class during the animation.
-   * @param {!HTMLElement} container The scrolling container the card fills.
-   * @param {number} prevScrollTop scrollTop of the container before this
-   *     section expanded.
-   * @return {?SettingsSectionElement.AnimationConfig}
-   */
-  animateCollapse: function(container, prevScrollTop) {
-    this.$.header.hidden = false;
-
-    var startingTop = container.getBoundingClientRect().top;
-
-    var card = this.$.card;
-    var cardHeightStart = card.clientHeight;
-    var cardWidthStart = card.clientWidth;
-
-    this.classList.add('collapsing');
-    this.classList.remove('expanding', 'expanded');
-
-    // If we navigated here directly, we don't know the original height of the
-    // section, so we skip the animation.
-    // TODO(michaelpg): remove this condition once sliding is implemented.
-    if (Number.isNaN(card.origHeight_))
-      return null;
-
-    // Restore the section to its proper height to make room for the card.
-    this.style.height = (this.clientHeight + card.origHeight_) + 'px';
-
-    // TODO(michaelpg): this should be in MainPageBehavior(), but we need to
-    // wait until the full page height is available (setting the section
-    // height).
-    container.scrollTop = prevScrollTop;
-
-    // The card is unpositioned, so use its position as the ending state,
-    // but account for scroll.
-    var targetTop = card.getBoundingClientRect().top - container.scrollTop;
-
-    // Account for the section header.
-    var headerStyle = getComputedStyle(this.$.header);
-    targetTop += this.$.header.offsetHeight +
-        parseInt(headerStyle.marginBottom, 10) +
-        parseInt(headerStyle.marginTop, 10);
-
-    var keyframes = [{
-      top: startingTop + 'px',
-      minHeight: cardHeightStart + 'px',
-      easing: EASING_FUNCTION,
-    }, {
-      top: targetTop + 'px',
-      minHeight: card.origHeight_ + 'px',
-    }];
-    var options = /** @type {!KeyframeEffectOptions} */({
-      duration: EXPAND_DURATION
-    });
-
-    card.style.width = cardWidthStart + 'px';
-
-    return {card: card, keyframes: keyframes, options: options};
-  },
-
-  /**
-   * Cleans up after animateCollapse().
-   * @param {boolean} finished Whether the animation finished successfully.
-   */
-  cleanUpAnimateCollapse: function(finished) {
-    if (finished)
-      this.$.card.style.width = '';
-  },
 });
-
-/**
- * Information needed by TransitionBehavior to schedule animations.
- * @typedef {{
- *   card: !HTMLElement,
- *   keyframes: !Array<!Object>,
- *   options: !KeyframeEffectOptions
- * }}
- */
-SettingsSectionElement.AnimationConfig;
diff --git a/chrome/browser/resources/settings/settings_page_css.html b/chrome/browser/resources/settings/settings_page_css.html
index 160470e..ccd59f5 100644
--- a/chrome/browser/resources/settings/settings_page_css.html
+++ b/chrome/browser/resources/settings/settings_page_css.html
@@ -1,9 +1,8 @@
-<link rel="import" href="chrome://resources/html/polymer.html">
 <link rel="import" href="/settings_page/main_page_behavior.html">
 
 <dom-module id="settings-page-styles">
   <template>
-    <style>
+    <style include="main-page-styles">
       :host {
         box-sizing: border-box;
         display: block;
@@ -19,24 +18,13 @@
         height: inherit;
       }
 
-      :host > div > :not(.expanded) {
+      :host > div > * {
         /* The margin and padding here are doing two things: make the total
          * separation 24px; and make scrollIntoView align the section header
          * with the top item in the side nav menu. Both things are desired
          * by Alan (bettes@). */
         margin-bottom: 3px;
       }
-
-      .expanded {
-        min-height: 100%;
-      }
-
-      .expanding,
-      .collapsing {
-        /* Must be lower than the paper-header-panel's z-index.
-         * See settings_ui.html. */
-        z-index: 1;
-      }
     </style>
   </template>
 </dom-module>
diff --git a/chrome/browser/resources/settings/settings_resources.grd b/chrome/browser/resources/settings/settings_resources.grd
index 372c49e..32734a3 100644
--- a/chrome/browser/resources/settings/settings_resources.grd
+++ b/chrome/browser/resources/settings/settings_resources.grd
@@ -739,6 +739,14 @@
                  file="route.js"
                  type="chrome_html"
                  preprocess="true" />
+      <structure name="IDR_SETTINGS_CR_SETTINGS_ROUTER_HTML"
+                 file="settings_page/settings_router.html"
+                 type="chrome_html" />
+      <structure name="IDR_SETTINGS_CR_SETTINGS_ROUTER_JS"
+                 file="settings_page/settings_router.js"
+                 type="chrome_html"
+                 flattenhtml="true"
+                 allowexternalscript="true" />
       <structure name="IDR_SETTINGS_SITE_DATA_HTML"
                  file="site_settings/site_data.html"
                  type="chrome_html" />
diff --git a/chrome/browser/resources/settings/settings_shared_css.html b/chrome/browser/resources/settings/settings_shared_css.html
index 2ffad3d..41fadea 100644
--- a/chrome/browser/resources/settings/settings_shared_css.html
+++ b/chrome/browser/resources/settings/settings_shared_css.html
@@ -97,7 +97,7 @@
       .primary-button,
       .tertiary-button {
         --paper-button-flat-keyboard-focus: {
-          background: rgba(51, 103, 214, .12);  /* --google-blue-700 */
+          background-color: rgba(51, 103, 214, .12);  /* --google-blue-700 */
         };
       }
 
@@ -125,7 +125,7 @@
           font-weight: 500;
         };
         --paper-button-flat-keyboard-focus: {
-          background: rgba(0, 0, 0, .12);
+          background-color: rgba(0, 0, 0, .12);
         };
       }
 
@@ -218,7 +218,7 @@
       }
 
       /* The middle part (horizontally) of a list item. */
-      .list-item .middle {
+      .list-item > .middle {
         flex: 1;
         margin: 8px 16px;
       }
@@ -343,36 +343,6 @@
         height: 16px;
         width: 16px;
       }
-
-      .search-bubble {
-        pointer-events: none;
-        position: absolute;
-      }
-
-      .search-bubble-innards {
-        align-items: center;
-        background-color: var(--paper-yellow-500);
-        border-radius: 2px;
-        display: flex;
-        height: 28px;
-        padding: 0 16px;
-      }
-
-      /* Provides the arrow which points at the anchor element. */
-      .search-bubble-innards::after {
-        -webkit-transform: rotate(-45deg);
-        background-color: var(--paper-yellow-500);
-        content: '';
-        height: 10px;
-        position: absolute;
-        right: -5px;
-        top: 10px;
-        width: 10px;
-      }
-
-      .search-highlight-hit {
-        background-color: var(--paper-yellow-500);
-      }
     </style>
   </template>
 </dom-module>
diff --git a/chrome/browser/resources/settings/settings_ui/settings_ui.html b/chrome/browser/resources/settings/settings_ui/settings_ui.html
index bd61243..bf140f3 100644
--- a/chrome/browser/resources/settings/settings_ui/settings_ui.html
+++ b/chrome/browser/resources/settings/settings_ui/settings_ui.html
@@ -9,6 +9,7 @@
 <link rel="import" href="/icons.html">
 <link rel="import" href="/settings_main/settings_main.html">
 <link rel="import" href="/settings_menu/settings_menu.html">
+<link rel="import" href="/settings_page/settings_router.html">
 <link rel="import" href="/settings_shared_css.html">
 
 <dom-module id="settings-ui">
@@ -110,6 +111,9 @@
         overflow: auto;
       }
     </style>
+    <settings-router current-route="{{currentRoute}}"
+        current-route-titles="{{currentRouteTitles}}">
+    </settings-router>
     <!-- TODO(dpapad): Remove "coming soon" string once crbug.com/608535 fully
       addressed -->
     <cr-toolbar page-name="$i18n{settings}"
@@ -120,12 +124,13 @@
     <app-drawer swipe-open>
       <div class="drawer-header">$i18n{settings}</div>
       <div class="drawer-content">
-        <settings-menu id="sideNav" page-visibility="[[pageVisibility_]]">
+        <settings-menu current-route="{{currentRoute}}" id="sideNav"
+            page-visibility="[[pageVisibility_]]">
         </settings-menu>
       </div>
     </app-drawer>
     <paper-header-panel mode="waterfall">
-      <settings-main prefs="{{prefs}}"
+      <settings-main prefs="{{prefs}}" current-route="{{currentRoute}}"
           toolbar-spinner-active="{{toolbarSpinnerActive_}}"
           page-visibility="[[pageVisibility_]]">
       </settings-main>
diff --git a/chrome/browser/resources/settings/site_settings/all_sites.html b/chrome/browser/resources/settings/site_settings/all_sites.html
index afae857..458ed7c 100644
--- a/chrome/browser/resources/settings/site_settings/all_sites.html
+++ b/chrome/browser/resources/settings/site_settings/all_sites.html
@@ -12,8 +12,8 @@
       }
     </style>
     <settings-site-list id="siteList" all-sites
-        category="all-sites" selected-site="{{selectedSite}}">
-    </settings-site-list>
+        category="all-sites" current-route="{{currentRoute}}"
+        selected-site="{{selectedSite}}"></settings-site-list>
   </template>
   <script src="all_sites.js"></script>
 </dom-module>
diff --git a/chrome/browser/resources/settings/site_settings/all_sites.js b/chrome/browser/resources/settings/site_settings/all_sites.js
index 33e48e9..58c8956 100644
--- a/chrome/browser/resources/settings/site_settings/all_sites.js
+++ b/chrome/browser/resources/settings/site_settings/all_sites.js
@@ -14,6 +14,14 @@ Polymer({
 
   properties: {
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * The site that was selected by the user in the dropdown list.
      * @type {SiteException}
      */
diff --git a/chrome/browser/resources/settings/site_settings/site_list.html b/chrome/browser/resources/settings/site_settings/site_list.html
index 9a2e67e..27f4bee 100644
--- a/chrome/browser/resources/settings/site_settings/site_list.html
+++ b/chrome/browser/resources/settings/site_settings/site_list.html
@@ -33,10 +33,6 @@
       .no-upper {
         text-transform: none;
       }
-
-      .selectable {
-        -webkit-user-select: text;
-      }
     </style>
     <paper-submenu id="category" hidden
         on-paper-submenu-open="onToggle_" on-paper-submenu-close="onToggle_">
@@ -50,52 +46,41 @@
       <div class="list-frame menu-content vertical-list" id="listContainer">
         <template is="dom-repeat" items="[[sites]]">
           <div class="list-item">
-            <div class="start layout horizontal center" on-tap="onOriginTap_"
-                actionable$="[[!isPolicyControlled_(item.source)]]">
-              <div class="favicon-image"
-                  style$="[[computeSiteIcon(item.originForDisplay)]]">
-              </div>
-              <div class="middle">
-                <div class="selectable">[[item.originForDisplay]]</div>
-                <div class="selectable secondary">
-                  [[item.embeddingOriginForDisplay]]
-                </div>
-              </div>
+            <div class="favicon-image"
+                style$="[[computeSiteIcon(item.originForDisplay)]]"
+                on-tap="onOriginTap_" actionable></div>
+            <div class="middle" on-tap="onOriginTap_" actionable>
+              <div>[[item.originForDisplay]]</div>
+              <div class="secondary">[[item.embeddingOriginForDisplay]]</div>
             </div>
-
-            <template is="dom-if" if="[[isPolicyControlled_(item.source)]]">
-              <iron-icon icon="cr:domain"></iron-icon>
-            </template>
-            <template is="dom-if" if="[[shouldShowMenu_(item.source)]]">
-              <paper-menu-button>
-                <paper-icon-button icon="cr:more-vert"
-                    class="dropdown-trigger">
-                </paper-icon-button>
-                <paper-menu id="actionMenu" class="dropdown-content"
-                    on-iron-activate="onActionMenuIronActivate_"
-                    attr-for-selected="menu-value">
-                  <paper-item
-                      hidden="[[!showAllowAction_]]"
-                      menu-value$="[[PermissionValues.ALLOW]]">
-                    $i18n{siteSettingsActionAllow}
-                  </paper-item>
-                  <paper-item
-                      hidden="[[!showBlockAction_]]"
-                      menu-value$="[[PermissionValues.BLOCK]]">
-                    $i18n{siteSettingsActionBlock}
-                  </paper-item>
-                  <paper-item
-                      hidden="[[!showSessionOnlyAction_]]"
-                      menu-value$="[[PermissionValues.SESSION_ONLY]]">
-                    $i18n{siteSettingsActionSessionOnly}
-                  </paper-item>
-                  <paper-item
-                      menu-value$="[[PermissionValues.DEFAULT]]">
-                    $i18n{siteSettingsActionReset}
-                  </paper-item>
-                </paper-menu>
-              </paper-menu-button>
-            </template>
+            <paper-menu-button hidden$="[[allSites]]">
+              <paper-icon-button icon="cr:more-vert"
+                  class="dropdown-trigger">
+              </paper-icon-button>
+              <paper-menu id="actionMenu" class="dropdown-content"
+                  on-iron-activate="onActionMenuIronActivate_"
+                  attr-for-selected="menu-value">
+                <paper-item
+                    hidden="[[!showAllowAction_]]"
+                    menu-value$="[[PermissionValues.ALLOW]]">
+                  $i18n{siteSettingsActionAllow}
+                </paper-item>
+                <paper-item
+                    hidden="[[!showBlockAction_]]"
+                    menu-value$="[[PermissionValues.BLOCK]]">
+                  $i18n{siteSettingsActionBlock}
+                </paper-item>
+                <paper-item
+                    hidden="[[!showSessionOnlyAction_]]"
+                    menu-value$="[[PermissionValues.SESSION_ONLY]]">
+                  $i18n{siteSettingsActionSessionOnly}
+                </paper-item>
+                <paper-item
+                    menu-value$="[[PermissionValues.DEFAULT]]">
+                  $i18n{siteSettingsActionReset}
+                </paper-item>
+              </paper-menu>
+            </paper-menu-button>
           </div>
         </template>
 
diff --git a/chrome/browser/resources/settings/site_settings/site_list.js b/chrome/browser/resources/settings/site_settings/site_list.js
index 83383b9..61ad848 100644
--- a/chrome/browser/resources/settings/site_settings/site_list.js
+++ b/chrome/browser/resources/settings/site_settings/site_list.js
@@ -15,6 +15,14 @@ Polymer({
 
   properties: {
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * The site that was selected by the user in the dropdown list.
      * @type {SiteException}
      */
@@ -161,24 +169,6 @@ Polymer({
   },
 
   /**
-   * @param {string} source Where the setting came from.
-   * @return {boolean}
-   * @private
-   */
-  isPolicyControlled_: function(source) {
-    return source == 'policy';
-  },
-
-  /**
-   * @param {string} source Where the setting came from.
-   * @return {boolean}
-   * @private
-   */
-  shouldShowMenu_: function(source) {
-    return !(this.isPolicyControlled_(source) || this.allSites);
-  },
-
-  /**
    * Makes sure the visibility is correct for this widget.
    * @private
    */
@@ -309,7 +299,7 @@ Polymer({
   /**
    * Converts an unordered site list to an ordered array, sorted by site name
    * then protocol and de-duped (by origin).
-   * @param {!Array<SiteException>} sites A list of sites to sort and de-dupe.
+   * @param {!Array<SiteException>} sites A list of sites to sort and de-dup.
    * @return {!Array<SiteException>} Sorted and de-duped list.
    * @private
    */
@@ -364,7 +354,6 @@ Polymer({
          originForDisplay: originForDisplay,
          embeddingOrigin: embeddingOrigin,
          embeddingOriginForDisplay: embeddingOriginForDisplay,
-         source: sites[i].source,
       });
 
       lastOrigin = originForDisplay;
@@ -393,9 +382,6 @@ Polymer({
    */
   onOriginTap_: function(event) {
     this.selectedSite = event.model.item;
-    if (this.isPolicyControlled_(this.selectedSite.source))
-      return;
-
     if (this.allSites)
       settings.navigateTo(settings.Route.SITE_SETTINGS_ALL_DETAILS);
     else
diff --git a/chrome/browser/resources/settings/site_settings/site_settings_category.html b/chrome/browser/resources/settings/site_settings/site_settings_category.html
index d7457b6..60842ba 100644
--- a/chrome/browser/resources/settings/site_settings/site_settings_category.html
+++ b/chrome/browser/resources/settings/site_settings/site_settings_category.html
@@ -52,18 +52,21 @@
     <settings-site-list
         category="[[category]]"
         category-subtype="[[PermissionValues.BLOCK]]"
+        current-route="{{currentRoute}}"
         category-enabled="[[categoryEnabled]]"
         selected-site="{{selectedSite}}">
     </settings-site-list>
     <settings-site-list
         category="[[category]]"
         category-subtype="[[PermissionValues.ALLOW]]"
+        current-route="{{currentRoute}}"
         category-enabled="[[categoryEnabled]]"
         selected-site="{{selectedSite}}">
     </settings-site-list>
     <settings-site-list
         category="[[category]]"
         category-subtype="[[PermissionValues.SESSION_ONLY]]"
+        current-route="{{currentRoute}}"
         category-enabled="[[categoryEnabled]]"
         selected-site="{{selectedSite}}">
     </settings-site-list>
diff --git a/chrome/browser/resources/settings/site_settings/site_settings_category.js b/chrome/browser/resources/settings/site_settings/site_settings_category.js
index c1aa1ba..81672e8 100644
--- a/chrome/browser/resources/settings/site_settings/site_settings_category.js
+++ b/chrome/browser/resources/settings/site_settings/site_settings_category.js
@@ -14,6 +14,14 @@ Polymer({
 
   properties: {
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * Represents the state of the main toggle shown for the category. For
      * example, the Location category can be set to Block/Ask so false, in that
      * case, represents Block and true represents Ask.
diff --git a/chrome/browser/resources/settings/site_settings_page/site_settings_page.js b/chrome/browser/resources/settings/site_settings_page/site_settings_page.js
index a9e9ada..9e72770 100644
--- a/chrome/browser/resources/settings/site_settings_page/site_settings_page.js
+++ b/chrome/browser/resources/settings/site_settings_page/site_settings_page.js
@@ -14,6 +14,14 @@ Polymer({
 
   properties: {
     /**
+     * The current active route.
+     */
+    currentRoute: {
+      type: Object,
+      notify: true,
+    },
+
+    /**
      * The category selected by the user.
      */
     categorySelected: {
diff --git a/chrome/browser/safe_browsing/download_protection_service.cc b/chrome/browser/safe_browsing/download_protection_service.cc
index 6bdb383..08f9149 100644
--- a/chrome/browser/safe_browsing/download_protection_service.cc
+++ b/chrome/browser/safe_browsing/download_protection_service.cc
@@ -805,12 +805,13 @@ class DownloadProtectionService::CheckClientDownloadRequest
       }
     }
 
-    if (!skipped_url_whitelist_ && signature_info_.trusted()) {
+    bool should_sample_for_certificate = ShouldSampleWhitelistedDownload();
+    if (signature_info_.trusted()) {
       for (int i = 0; i < signature_info_.certificate_chain_size(); ++i) {
         if (CertificateChainIsWhitelisted(
                 signature_info_.certificate_chain(i))) {
           RecordCountOfWhitelistedDownload(SIGNATURE_WHITELIST);
-          if (ShouldSampleWhitelistedDownload()) {
+          if (should_sample_for_certificate) {
             skipped_certificate_whitelist_ = true;
             break;
           } else {
diff --git a/chrome/browser/safe_browsing/download_protection_service_unittest.cc b/chrome/browser/safe_browsing/download_protection_service_unittest.cc
index 22c9bae..cacce40 100644
--- a/chrome/browser/safe_browsing/download_protection_service_unittest.cc
+++ b/chrome/browser/safe_browsing/download_protection_service_unittest.cc
@@ -74,11 +74,8 @@ using ::testing::StrictMock;
 using ::testing::_;
 using base::RunLoop;
 using content::BrowserThread;
-
 namespace safe_browsing {
-
 namespace {
-
 // A SafeBrowsingDatabaseManager implementation that returns a fixed result for
 // a given URL.
 class MockSafeBrowsingDatabaseManager : public TestSafeBrowsingDatabaseManager {
@@ -192,7 +189,6 @@ class TestURLFetcherWatcher : public net::TestURLFetcherDelegateForTests {
   int fetcher_id_;
   RunLoop run_loop_;
 };
-
 }  // namespace
 
 ACTION_P(SetCertificateContents, contents) {
@@ -204,15 +200,16 @@ ACTION_P(SetDosHeaderContents, contents) {
   return true;
 }
 
-ACTION_P(TrustSignature, contents) {
+ACTION_P(TrustSignature, certificate_file) {
   arg1->set_trusted(true);
   // Add a certificate chain.  Note that we add the certificate twice so that
   // it appears as its own issuer.
-
+  std::string cert_data;
+  ASSERT_TRUE(base::ReadFileToString(certificate_file, &cert_data));
   ClientDownloadRequest_CertificateChain* chain =
       arg1->add_certificate_chain();
-  chain->add_element()->set_certificate(contents.data(), contents.size());
-  chain->add_element()->set_certificate(contents.data(), contents.size());
+  chain->add_element()->set_certificate(cert_data);
+  chain->add_element()->set_certificate(cert_data);
 }
 
 // We can't call OnSafeBrowsingResult directly because SafeBrowsingCheck does
@@ -787,7 +784,7 @@ TEST_F(DownloadProtectionServiceTest,
   EXPECT_CALL(*binary_feature_extractor_.get(),
               ExtractImageFeatures(
                   tmp_path_, BinaryFeatureExtractor::kDefaultOptions, _, _))
-      .Times(6);
+      .Times(4);
   // Assume http://www.whitelist.com/a.exe is on the whitelist.
   EXPECT_CALL(*sb_service_->mock_database_manager(),
               MatchDownloadWhitelistUrl(_)).Times(0);
@@ -814,37 +811,8 @@ TEST_F(DownloadProtectionServiceTest,
     EXPECT_FALSE(HasClientDownloadRequest());
   }
   {
-    // Case (2): !is_extended_reporting && is_incognito.
-    //           ClientDownloadRequest should NOT be sent.
-    SetExtendedReportingPreference(false);
-    EXPECT_CALL(item, GetBrowserContext())
-        .WillRepeatedly(Return(profile_->GetOffTheRecordProfile()));
-    RunLoop run_loop;
-    download_service_->CheckClientDownload(
-        &item, base::Bind(&DownloadProtectionServiceTest::CheckDoneCallback,
-                          base::Unretained(this), run_loop.QuitClosure()));
-    run_loop.Run();
-    EXPECT_TRUE(IsResult(DownloadProtectionService::SAFE));
-    EXPECT_FALSE(HasClientDownloadRequest());
-  }
-  {
-    // Case (3): !is_extended_reporting && !is_incognito.
-    //           ClientDownloadRequest should NOT be sent.
-    EXPECT_CALL(item, GetBrowserContext())
-        .WillRepeatedly(Return(profile_.get()));
-    RunLoop run_loop;
-    download_service_->CheckClientDownload(
-        &item, base::Bind(&DownloadProtectionServiceTest::CheckDoneCallback,
-                          base::Unretained(this), run_loop.QuitClosure()));
-    run_loop.Run();
-    EXPECT_TRUE(IsResult(DownloadProtectionService::SAFE));
-    EXPECT_FALSE(HasClientDownloadRequest());
-  }
-  {
-    // Case (4): is_extended_reporting && !is_incognito &&
-    //           Download matches URL whitelist.
+    // Case (2): is_extended_reporting && !is_incognito.
     //           ClientDownloadRequest should be sent.
-    SetExtendedReportingPreference(true);
     EXPECT_CALL(item, GetBrowserContext())
         .WillRepeatedly(Return(profile_.get()));
     RunLoop run_loop;
@@ -855,66 +823,34 @@ TEST_F(DownloadProtectionServiceTest,
     EXPECT_TRUE(IsResult(DownloadProtectionService::SAFE));
     ASSERT_TRUE(HasClientDownloadRequest());
     EXPECT_TRUE(GetClientDownloadRequest()->skipped_url_whitelist());
-    EXPECT_FALSE(GetClientDownloadRequest()->skipped_certificate_whitelist());
     ClearClientDownloadRequest();
   }
-
-  // Setup trusted and whitelisted certificates for test cases (5) and (6).
-  scoped_refptr<net::X509Certificate> test_cert(
-      ReadTestCertificate("test_cn.pem"));
-  ASSERT_TRUE(test_cert.get());
-  std::string test_cert_der;
-  net::X509Certificate::GetDEREncoded(test_cert->os_cert_handle(),
-                                      &test_cert_der);
-  EXPECT_CALL(*binary_feature_extractor_.get(), CheckSignature(tmp_path_, _))
-        .WillRepeatedly(TrustSignature(test_cert_der));
-  EXPECT_CALL(*sb_service_->mock_database_manager(),
-              MatchDownloadWhitelistString(_))
-      .WillRepeatedly(Return(true));
-
   {
-    // Case (5): is_extended_reporting && !is_incognito &&
-    //           Download matches certificate whitelist.
-    //           ClientDownloadRequest should be sent.
+    // Case (3): !is_extended_reporting && is_incognito.
+    //           ClientDownloadRequest should NOT be sent.
+    SetExtendedReportingPreference(false);
     EXPECT_CALL(item, GetBrowserContext())
-        .WillRepeatedly(Return(profile_.get()));
-    EXPECT_CALL(
-        *sb_service_->mock_database_manager(),
-        MatchDownloadWhitelistUrl(GURL("http://www.whitelist.com/a.exe")))
-        .WillRepeatedly(Return(false));
+        .WillRepeatedly(Return(profile_->GetOffTheRecordProfile()));
     RunLoop run_loop;
     download_service_->CheckClientDownload(
         &item, base::Bind(&DownloadProtectionServiceTest::CheckDoneCallback,
                           base::Unretained(this), run_loop.QuitClosure()));
     run_loop.Run();
     EXPECT_TRUE(IsResult(DownloadProtectionService::SAFE));
-    ASSERT_TRUE(HasClientDownloadRequest());
-    EXPECT_FALSE(GetClientDownloadRequest()->skipped_url_whitelist());
-    EXPECT_TRUE(GetClientDownloadRequest()->skipped_certificate_whitelist());
-    ClearClientDownloadRequest();
+    EXPECT_FALSE(HasClientDownloadRequest());
   }
   {
-    // Case (6): is_extended_reporting && !is_incognito &&
-    //           Download matches both URL and certificate whitelists.
-    //           ClientDownloadRequest should be sent.
+    // Case (4): !is_extended_reporting && !is_incognito.
+    //           ClientDownloadRequest should NOT be sent.
     EXPECT_CALL(item, GetBrowserContext())
         .WillRepeatedly(Return(profile_.get()));
-    EXPECT_CALL(
-        *sb_service_->mock_database_manager(),
-        MatchDownloadWhitelistUrl(GURL("http://www.whitelist.com/a.exe")))
-        .WillRepeatedly(Return(true));
     RunLoop run_loop;
     download_service_->CheckClientDownload(
         &item, base::Bind(&DownloadProtectionServiceTest::CheckDoneCallback,
                           base::Unretained(this), run_loop.QuitClosure()));
     run_loop.Run();
     EXPECT_TRUE(IsResult(DownloadProtectionService::SAFE));
-    ASSERT_TRUE(HasClientDownloadRequest());
-    EXPECT_TRUE(GetClientDownloadRequest()->skipped_url_whitelist());
-    // Since download matches URL whitelist and gets sampled, no need to
-    // do certificate whitelist checking and sampling.
-    EXPECT_FALSE(GetClientDownloadRequest()->skipped_certificate_whitelist());
-    ClearClientDownloadRequest();
+    EXPECT_FALSE(HasClientDownloadRequest());
   }
 }
 
diff --git a/chrome/browser/safe_browsing/local_database_manager.cc b/chrome/browser/safe_browsing/local_database_manager.cc
index abe950d..2ec9325 100644
--- a/chrome/browser/safe_browsing/local_database_manager.cc
+++ b/chrome/browser/safe_browsing/local_database_manager.cc
@@ -34,7 +34,6 @@
 #include "chrome/common/pref_names.h"
 #include "components/prefs/pref_service.h"
 #include "components/safe_browsing_db/util.h"
-#include "components/safe_browsing_db/v4_protocol_manager_util.h"
 #include "content/public/browser/browser_thread.h"
 #include "content/public/browser/notification_service.h"
 #include "net/url_request/url_request_context_getter.h"
@@ -137,7 +136,7 @@ ListType GetUrlSeverestThreatListType(
     return INVALID;
 
   std::vector<std::string> patterns;
-  V4ProtocolManagerUtil::GeneratePatternsToCheck(url, &patterns);
+  GeneratePatternsToCheck(url, &patterns);
 
   ListType pending_threat = INVALID;
   int pending_threat_severity = GetThreatSeverity(INVALID);
diff --git a/chrome/browser/safe_browsing/safe_browsing_service_browsertest.cc b/chrome/browser/safe_browsing/safe_browsing_service_browsertest.cc
index 8662a6d..26c4a30 100644
--- a/chrome/browser/safe_browsing/safe_browsing_service_browsertest.cc
+++ b/chrome/browser/safe_browsing/safe_browsing_service_browsertest.cc
@@ -54,7 +54,6 @@
 #include "components/safe_browsing_db/metadata.pb.h"
 #include "components/safe_browsing_db/test_database_manager.h"
 #include "components/safe_browsing_db/util.h"
-#include "components/safe_browsing_db/v4_protocol_manager_util.h"
 #include "components/subresource_filter/content/browser/content_subresource_filter_driver_factory.h"
 #include "content/public/browser/interstitial_page.h"
 #include "content/public/browser/navigation_entry.h"
@@ -485,7 +484,7 @@ class SafeBrowsingServiceTest : public InProcessBrowserTest {
                                    SBFullHashResult* full_hash) {
     std::string host;
     std::string path;
-    V4ProtocolManagerUtil::CanonicalizeUrl(url, &host, &path, nullptr);
+    CanonicalizeUrl(url, &host, &path, nullptr);
     full_hash->hash = SBFullHashForString(host + path);
     full_hash->list_id = list_id;
   }
diff --git a/chrome/browser/ssl/chrome_ssl_host_state_delegate_test.cc b/chrome/browser/ssl/chrome_ssl_host_state_delegate_test.cc
index 70fa459..7f552b4 100644
--- a/chrome/browser/ssl/chrome_ssl_host_state_delegate_test.cc
+++ b/chrome/browser/ssl/chrome_ssl_host_state_delegate_test.cc
@@ -547,10 +547,9 @@ class RemoveBrowsingHistorySSLHostStateDelegateTest
     BrowsingDataRemover* remover =
         BrowsingDataRemoverFactory::GetForBrowserContext(profile);
     BrowsingDataRemoverCompletionObserver completion_observer(remover);
-    remover->RemoveAndReply(
-        BrowsingDataRemover::Period(browsing_data::LAST_HOUR),
-        BrowsingDataRemover::REMOVE_HISTORY,
-        BrowsingDataHelper::UNPROTECTED_WEB, &completion_observer);
+    remover->Remove(BrowsingDataRemover::Period(browsing_data::LAST_HOUR),
+                    BrowsingDataRemover::REMOVE_HISTORY,
+                    BrowsingDataHelper::UNPROTECTED_WEB);
     completion_observer.BlockUntilCompletion();
   }
 };
diff --git a/chrome/browser/subresource_filter/subresource_filter_browsertest.cc b/chrome/browser/subresource_filter/subresource_filter_browsertest.cc
index 7d3cdec..f9a4265 100644
--- a/chrome/browser/subresource_filter/subresource_filter_browsertest.cc
+++ b/chrome/browser/subresource_filter/subresource_filter_browsertest.cc
@@ -63,8 +63,7 @@ class SubresourceFilterBrowserTest : public InProcessBrowserTest {
  protected:
   void SetUpOnMainThread() override {
     scoped_feature_toggle_.reset(new ScopedSubresourceFilterFeatureToggle(
-        base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled,
-        kActivationScopeAllSites));
+        base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled));
   }
 
   content::WebContents* web_contents() {
diff --git a/chrome/browser/sync/chrome_sync_client.cc b/chrome/browser/sync/chrome_sync_client.cc
index 08ed031..5396628 100644
--- a/chrome/browser/sync/chrome_sync_client.cc
+++ b/chrome/browser/sync/chrome_sync_client.cc
@@ -181,6 +181,7 @@ class SyncSessionsClientImpl : public sync_sessions::SyncSessionsClient {
 ChromeSyncClient::ChromeSyncClient(Profile* profile)
     : profile_(profile),
       sync_sessions_client_(new SyncSessionsClientImpl(profile)),
+      browsing_data_remover_observer_(NULL),
       weak_ptr_factory_(this) {}
 
 ChromeSyncClient::~ChromeSyncClient() {
diff --git a/chrome/browser/sync/chrome_sync_client.h b/chrome/browser/sync/chrome_sync_client.h
index 17908fd..7ceeaf6 100644
--- a/chrome/browser/sync/chrome_sync_client.h
+++ b/chrome/browser/sync/chrome_sync_client.h
@@ -8,6 +8,7 @@
 #include <vector>
 
 #include "base/macros.h"
+#include "chrome/browser/browsing_data/browsing_data_remover.h"
 #include "chrome/browser/sync/glue/extensions_activity_monitor.h"
 #include "components/sync_driver/sync_client.h"
 
@@ -59,6 +60,8 @@ class ChromeSyncClient : public sync_driver::SyncClient {
   sync_driver::SyncApiComponentFactory* GetSyncApiComponentFactory() override;
 
   // Helpers for overriding getters in tests.
+  void SetBrowsingDataRemoverObserverForTesting(
+      BrowsingDataRemover::Observer* observer);
   void SetSyncApiComponentFactoryForTesting(
       std::unique_ptr<sync_driver::SyncApiComponentFactory> component_factory);
 
@@ -98,6 +101,9 @@ class ChromeSyncClient : public sync_driver::SyncClient {
   // Generates and monitors the ExtensionsActivity object used by sync.
   ExtensionsActivityMonitor extensions_activity_monitor_;
 
+  // Used in integration tests.
+  BrowsingDataRemover::Observer* browsing_data_remover_observer_;
+
   base::WeakPtrFactory<ChromeSyncClient> weak_ptr_factory_;
 
   DISALLOW_COPY_AND_ASSIGN(ChromeSyncClient);
diff --git a/chrome/browser/task_management/sampling/shared_sampler.h b/chrome/browser/task_management/sampling/shared_sampler.h
deleted file mode 100644
index 5210ef8..0000000
--- a/chrome/browser/task_management/sampling/shared_sampler.h
+++ /dev/null
@@ -1,144 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_BROWSER_TASK_MANAGEMENT_SAMPLING_SHARED_SAMPLER_H_
-#define CHROME_BROWSER_TASK_MANAGEMENT_SAMPLING_SHARED_SAMPLER_H_
-
-#include <map>
-#include <memory>
-#include <utility>
-#include <vector>
-
-#include "base/callback.h"
-#include "base/files/file_path.h"
-#include "base/macros.h"
-#include "base/memory/ref_counted.h"
-#include "base/process/process_handle.h"
-#include "base/sequence_checker.h"
-#include "base/sequenced_task_runner.h"
-#include "build/build_config.h"
-
-namespace task_management {
-
-struct ProcessDataSnapshot;
-
-// Defines sampler that will calculate resources for all processes all at once,
-// on the worker thread. Created by TaskManagerImpl on the UI thread, but used
-// mainly on a blocking pool thread.
-//
-// This exists because on Windows it is much faster to collect a group of
-// process metrics for all processes all at once using NtQuerySystemInformation
-// than to query the same data for for each process individually and because
-// some types like Idle Wakeups can only be collected this way.
-class SharedSampler : public base::RefCountedThreadSafe<SharedSampler> {
- public:
-  explicit SharedSampler(
-      const scoped_refptr<base::SequencedTaskRunner>& blocking_pool_runner);
-
-  // Below are the types of callbacks that are invoked on the UI thread
-  // when the refresh is done on the worker thread.
-  // These callbacks are passed via RegisterCallbacks.
-  using OnIdleWakeupsCallback = base::Callback<void(int)>;
-
-  // Returns a combination of refresh flags supported by the shared sampler.
-  int64_t GetSupportedFlags() const;
-
-  // Registers task group specific callbacks.
-  void RegisterCallbacks(base::ProcessId process_id,
-                         const OnIdleWakeupsCallback& on_idle_wakeups);
-
-  // Unregisters task group specific callbacks.
-  void UnregisterCallbacks(base::ProcessId process_id);
-
-  // Refreshes the expensive process' stats (for now only idle wakeups per
-  // second) on the worker thread.
-  void Refresh(base::ProcessId process_id, int64_t refresh_flags);
-
- private:
-  friend class base::RefCountedThreadSafe<SharedSampler>;
-  ~SharedSampler();
-
-#if defined(OS_WIN)
-  // The UI-thread callbacks in TaskGroup registered with RegisterCallbacks and
-  // to be called when refresh on the worker thread is done.
-  struct Callbacks {
-    Callbacks();
-    Callbacks(Callbacks&& other);
-    ~Callbacks();
-
-    OnIdleWakeupsCallback on_idle_wakeups;
-
-   private:
-    DISALLOW_COPY_AND_ASSIGN(Callbacks);
-  };
-
-  typedef std::map<base::ProcessId, Callbacks> CallbacksMap;
-
-  // Contains all results of refresh for a single process.
-  struct RefreshResult {
-    base::ProcessId process_id;
-    int idle_wakeups_per_second;
-  };
-
-  typedef std::vector<RefreshResult> RefreshResults;
-
-  // Posted on the worker thread to do the actual refresh.
-  std::unique_ptr<RefreshResults> RefreshOnWorkerThread();
-
-  // Called on UI thread when the refresh is done.
-  void OnRefreshDone(std::unique_ptr<RefreshResults> refresh_results);
-
-  // Clear cached data.
-  void ClearState();
-
-  // Used to filter process information.
-  static std::vector<base::FilePath> GetSupportedImageNames();
-  bool IsSupportedImageName(base::FilePath::StringPieceType image_name) const;
-
-  // Captures a snapshot of data for all chrome processes.
-  // Runs on the worker thread.
-  std::unique_ptr<ProcessDataSnapshot> CaptureSnapshot();
-
-  // Produce refresh results by diffing two snapshots.
-  static void MakeResultsFromTwoSnapshots(
-      const ProcessDataSnapshot& prev_snapshot,
-      const ProcessDataSnapshot& snapshot,
-      RefreshResults* results);
-
-  // Produce refresh results from one snapshot.
-  // This is used only the first time when only one snapshot is available.
-  static void MakeResultsFromSnapshot(
-      const ProcessDataSnapshot& snapshot,
-      RefreshResults* results);
-
-  // Accumulates callbacks passed from TaskGroup objects passed via
-  // RegisterCallbacks calls.
-  CallbacksMap callbacks_map_;
-
-  // Refresh flags passed via Refresh.
-  int64_t refresh_flags_;
-
-  // Snapshot of previously captured resources used to calculate the delta.
-  std::unique_ptr<ProcessDataSnapshot> previous_snapshot_;
-
-  // Size of the buffer previously used to query system information.
-  size_t previous_buffer_size_;
-
-  // Image names that CaptureSnapshot uses to filter processes.
-  const std::vector<base::FilePath> supported_image_names_;
-
-  // The specific blocking pool SequencedTaskRunner that will be used to post
-  // the refresh tasks onto serially.
-  scoped_refptr<base::SequencedTaskRunner> blocking_pool_runner_;
-
-  // To assert we're running on the correct thread.
-  base::SequenceChecker worker_pool_sequenced_checker_;
-#endif  // defined(OS_WIN)
-
-  DISALLOW_COPY_AND_ASSIGN(SharedSampler);
-};
-
-}  // namespace task_management
-
-#endif  // CHROME_BROWSER_TASK_MANAGEMENT_SAMPLING_SHARED_SAMPLER_H_
diff --git a/chrome/browser/task_management/sampling/shared_sampler_posix.cc b/chrome/browser/task_management/sampling/shared_sampler_posix.cc
deleted file mode 100644
index a159d7e..0000000
--- a/chrome/browser/task_management/sampling/shared_sampler_posix.cc
+++ /dev/null
@@ -1,27 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/browser/task_management/sampling/shared_sampler.h"
-
-#include "content/public/browser/browser_thread.h"
-
-namespace task_management {
-
-SharedSampler::SharedSampler(
-    const scoped_refptr<base::SequencedTaskRunner>& blocking_pool_runner) {}
-
-SharedSampler::~SharedSampler() {}
-
-int64_t SharedSampler::GetSupportedFlags() const { return 0; }
-
-void SharedSampler::RegisterCallbacks(
-    base::ProcessId process_id,
-    const OnIdleWakeupsCallback& on_idle_wakeups) {}
-
-void SharedSampler::UnregisterCallbacks(base::ProcessId process_id) {}
-
-void SharedSampler::Refresh(base::ProcessId process_id,
-                             int64_t refresh_flags) {}
-
-}  // namespace task_management
diff --git a/chrome/browser/task_management/sampling/shared_sampler_win.cc b/chrome/browser/task_management/sampling/shared_sampler_win.cc
deleted file mode 100644
index 6ed9b06..0000000
--- a/chrome/browser/task_management/sampling/shared_sampler_win.cc
+++ /dev/null
@@ -1,618 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/browser/task_management/sampling/shared_sampler.h"
-
-#include <windows.h>
-#include <winternl.h>
-
-#include <algorithm>
-
-#include "base/bind.h"
-#include "base/command_line.h"
-#include "base/path_service.h"
-#include "base/time/time.h"
-#include "chrome/browser/task_management/task_manager_observer.h"
-#include "chrome/common/chrome_constants.h"
-#include "content/public/browser/browser_thread.h"
-
-namespace task_management {
-
-namespace {
-
-// From <wdm.h>
-typedef LONG KPRIORITY;
-typedef LONG KWAIT_REASON;  // Full definition is in wdm.h
-
-// From ntddk.h
-typedef struct _VM_COUNTERS {
-  SIZE_T PeakVirtualSize;
-  SIZE_T VirtualSize;
-  ULONG PageFaultCount;
-  // Padding here in 64-bit
-  SIZE_T PeakWorkingSetSize;
-  SIZE_T WorkingSetSize;
-  SIZE_T QuotaPeakPagedPoolUsage;
-  SIZE_T QuotaPagedPoolUsage;
-  SIZE_T QuotaPeakNonPagedPoolUsage;
-  SIZE_T QuotaNonPagedPoolUsage;
-  SIZE_T PagefileUsage;
-  SIZE_T PeakPagefileUsage;
-} VM_COUNTERS;
-
-// Two possibilities available from here:
-// http://stackoverflow.com/questions/28858849/where-is-system-information-class-defined
-
-typedef enum _SYSTEM_INFORMATION_CLASS {
-  SystemProcessInformation = 5,  // This is the number that we need.
-} SYSTEM_INFORMATION_CLASS;
-
-// https://msdn.microsoft.com/en-us/library/gg750647.aspx?f=255&MSPPError=-2147217396
-typedef struct {
-  HANDLE UniqueProcess;  // Actually process ID
-  HANDLE UniqueThread;   // Actually thread ID
-} CLIENT_ID;
-
-// From http://alax.info/blog/1182, with corrections and modifications
-// Originally from
-// http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FSystem%20Information%2FStructures%2FSYSTEM_THREAD.html
-struct SYSTEM_THREAD_INFORMATION {
-  ULONGLONG KernelTime;
-  ULONGLONG UserTime;
-  ULONGLONG CreateTime;
-  ULONG WaitTime;
-  // Padding here in 64-bit
-  PVOID StartAddress;
-  CLIENT_ID ClientId;
-  KPRIORITY Priority;
-  LONG BasePriority;
-  ULONG ContextSwitchCount;
-  ULONG State;
-  KWAIT_REASON WaitReason;
-};
-#if _M_X64
-static_assert(sizeof(SYSTEM_THREAD_INFORMATION) == 80,
-              "Structure size mismatch");
-#else
-static_assert(sizeof(SYSTEM_THREAD_INFORMATION) == 64,
-              "Structure size mismatch");
-#endif
-
-// From http://alax.info/blog/1182, with corrections and modifications
-// Originally from
-// http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FSystem%20Information%2FStructures%2FSYSTEM_THREAD.html
-struct SYSTEM_PROCESS_INFORMATION {
-  ULONG NextEntryOffset;
-  ULONG NumberOfThreads;
-  // http://processhacker.sourceforge.net/doc/struct___s_y_s_t_e_m___p_r_o_c_e_s_s___i_n_f_o_r_m_a_t_i_o_n.html
-  ULONGLONG WorkingSetPrivateSize;
-  ULONG HardFaultCount;
-  ULONG Reserved1;
-  ULONGLONG CycleTime;
-  ULONGLONG CreateTime;
-  ULONGLONG UserTime;
-  ULONGLONG KernelTime;
-  UNICODE_STRING ImageName;
-  KPRIORITY BasePriority;
-  HANDLE ProcessId;
-  HANDLE ParentProcessId;
-  ULONG HandleCount;
-  ULONG Reserved2[2];
-  // Padding here in 64-bit
-  VM_COUNTERS VirtualMemoryCounters;
-  size_t Reserved3;
-  IO_COUNTERS IoCounters;
-  SYSTEM_THREAD_INFORMATION Threads[1];
-};
-#if _M_X64
-static_assert(sizeof(SYSTEM_PROCESS_INFORMATION) == 336,
-              "Structure size mismatch");
-#else
-static_assert(sizeof(SYSTEM_PROCESS_INFORMATION) == 248,
-              "Structure size mismatch");
-#endif
-
-// ntstatus.h conflicts with windows.h so define this locally.
-#define STATUS_SUCCESS              ((NTSTATUS)0x00000000L)
-#define STATUS_BUFFER_TOO_SMALL     ((NTSTATUS)0xC0000023L)
-#define STATUS_INFO_LENGTH_MISMATCH ((NTSTATUS)0xC0000004L)
-
-// Simple memory buffer wrapper for passing the data out of
-// QuerySystemProcessInformation.
-class ByteBuffer {
- public:
-  explicit ByteBuffer(size_t capacity)
-      : size_(0), capacity_(0) {
-    if (capacity > 0)
-      grow(capacity);
-  }
-
-  ~ByteBuffer() {}
-
-  BYTE* data() { return data_.get(); }
-
-  size_t size() { return size_; }
-
-  void set_size(size_t new_size) {
-    DCHECK_LE(new_size, capacity_);
-    size_ = new_size;
-  }
-
-  size_t capacity() { return capacity_; }
-
-  void grow(size_t new_capacity) {
-    DCHECK_GT(new_capacity, capacity_);
-    capacity_ = new_capacity;
-    data_.reset(new BYTE[new_capacity]);
-  }
-
- private:
-  std::unique_ptr<BYTE[]> data_;
-  size_t size_;
-  size_t capacity_;
-
-  DISALLOW_COPY_AND_ASSIGN(ByteBuffer);
-};
-
-// Wrapper for NtQuerySystemProcessInformation with buffer reallocation logic.
-bool QuerySystemProcessInformation(ByteBuffer* buffer) {
-  typedef NTSTATUS(WINAPI * NTQUERYSYSTEMINFORMATION)(
-      SYSTEM_INFORMATION_CLASS SystemInformationClass, PVOID SystemInformation,
-      ULONG SystemInformationLength, PULONG ReturnLength);
-
-  HMODULE ntdll = ::GetModuleHandle(L"ntdll.dll");
-  if (!ntdll) {
-    NOTREACHED();
-    return false;
-  }
-
-  NTQUERYSYSTEMINFORMATION nt_query_system_information_ptr =
-      reinterpret_cast<NTQUERYSYSTEMINFORMATION>(
-          ::GetProcAddress(ntdll, "NtQuerySystemInformation"));
-  if (!nt_query_system_information_ptr) {
-    NOTREACHED();
-    return false;
-  }
-
-  NTSTATUS result;
-
-  // There is a potential race condition between growing the buffer and new
-  // processes being created. Try a few times before giving up.
-  for (int i = 0; i < 10; i++) {
-    ULONG data_size = 0;
-    ULONG buffer_size = static_cast<ULONG>(buffer->capacity());
-    result = nt_query_system_information_ptr(
-        SystemProcessInformation,
-        buffer->data(), buffer_size, &data_size);
-
-    if (result == STATUS_SUCCESS) {
-      buffer->set_size(data_size);
-      break;
-    }
-
-    if (result == STATUS_INFO_LENGTH_MISMATCH ||
-        result == STATUS_BUFFER_TOO_SMALL) {
-      // Insufficient buffer. Grow to the returned |data_size| plus 10% extra
-      // to avoid frequent reallocations and try again.
-      DCHECK_GT(data_size, buffer_size);
-      buffer->grow(static_cast<ULONG>(data_size * 1.1));
-    } else {
-      // An error other than the two above.
-      break;
-    }
-  }
-
-  return result == STATUS_SUCCESS;
-}
-
-// Per-thread data extracted from SYSTEM_THREAD_INFORMATION and stored in a
-// snapshot. This structure is accessed only on the worker thread.
-struct ThreadData {
-  base::PlatformThreadId thread_id;
-  ULONG context_switches;
-};
-
-// Per-process data extracted from SYSTEM_PROCESS_INFORMATION and stored in a
-// snapshot. This structure is accessed only on the worker thread.
-struct ProcessData {
-  ProcessData() = default;
-  ProcessData(ProcessData&&) = default;
-
-  std::vector<ThreadData> threads;
-
- private:
-  DISALLOW_COPY_AND_ASSIGN(ProcessData);
-};
-
-typedef std::map<base::ProcessId, ProcessData> ProcessDataMap;
-
-ULONG CountContextSwitchesDelta(const ProcessData& prev_process_data,
-  const ProcessData& new_process_data) {
-  // This one pass algorithm relies on the threads vectors to be
-  // ordered by thread_id.
-  ULONG delta = 0;
-  size_t prev_index = 0;
-
-  for (const auto& new_thread : new_process_data.threads) {
-    ULONG prev_thread_context_switches = 0;
-
-    // Iterate over the process threads from the previous snapshot skipping
-    // threads that don't exist anymore. Please note that this iteration starts
-    // from the last known prev_index and goes until a previous snapshot's
-    // thread ID >= the current snapshot's thread ID. So the overall algorithm
-    // is linear.
-    for (; prev_index < prev_process_data.threads.size(); ++prev_index) {
-      const auto& prev_thread = prev_process_data.threads[prev_index];
-      if (prev_thread.thread_id == new_thread.thread_id) {
-        // Threads match between two snapshots. Use the previous snapshot
-        // thread's context_switches to subtract from the delta.
-        prev_thread_context_switches = prev_thread.context_switches;
-        ++prev_index;
-        break;
-      }
-
-      if (prev_thread.thread_id > new_thread.thread_id) {
-        // This is due to a new thread that didn't exist in the previous
-        // snapshot. Keep the zero value of |prev_thread_context_switches| which
-        // essentially means the entire number of context switches of the new
-        // thread will be added to the delta.
-        break;
-      }
-    }
-
-    delta += new_thread.context_switches - prev_thread_context_switches;
-  }
-
-  return delta;
-}
-
-// Seeks a matching ProcessData by Process ID in a previous snapshot.
-// This uses the fact that ProcessDataMap entries are ordered by Process ID.
-const ProcessData* SeekInPreviousSnapshot(
-  base::ProcessId process_id, ProcessDataMap::const_iterator* iter_to_advance,
-  const ProcessDataMap::const_iterator& range_end) {
-  for (; *iter_to_advance != range_end; ++(*iter_to_advance)) {
-    if ((*iter_to_advance)->first == process_id) {
-      return &((*iter_to_advance)++)->second;
-    }
-    if ((*iter_to_advance)->first > process_id)
-      break;
-  }
-
-  return nullptr;
-}
-
-}  // namespace
-
-// ProcessDataSnapshot gets created and accessed only on the worker thread.
-// This is used to calculate metrics like Idle Wakeups / sec that require
-// a delta between two snapshots.
-// Please note that ProcessDataSnapshot has to be outside of anonymous namespace
-// in order to match the declaration in shared_sampler.h.
-struct ProcessDataSnapshot {
-  ProcessDataMap processes;
-  base::TimeTicks timestamp;
-};
-
-SharedSampler::SharedSampler(
-    const scoped_refptr<base::SequencedTaskRunner>& blocking_pool_runner)
-    : refresh_flags_(0), previous_buffer_size_(0),
-      supported_image_names_(GetSupportedImageNames()),
-      blocking_pool_runner_(blocking_pool_runner) {
-  DCHECK(blocking_pool_runner.get());
-
-  // This object will be created on the UI thread, however the sequenced checker
-  // will be used to assert we're running the expensive operations on one of the
-  // blocking pool threads.
-  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
-  worker_pool_sequenced_checker_.DetachFromSequence();
-}
-
-SharedSampler::~SharedSampler() {}
-
-int64_t SharedSampler::GetSupportedFlags() const {
-  return REFRESH_TYPE_IDLE_WAKEUPS;
-}
-
-SharedSampler::Callbacks::Callbacks() {}
-
-SharedSampler::Callbacks::~Callbacks() {}
-
-SharedSampler::Callbacks::Callbacks(Callbacks&& other) {
-  on_idle_wakeups = std::move(other.on_idle_wakeups);
-}
-
-void SharedSampler::RegisterCallbacks(
-    base::ProcessId process_id,
-    const OnIdleWakeupsCallback& on_idle_wakeups) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
-
-  if (process_id == 0)
-    return;
-
-  Callbacks callbacks;
-  callbacks.on_idle_wakeups = on_idle_wakeups;
-  bool result = callbacks_map_.insert(
-      std::make_pair(process_id, std::move(callbacks))).second;
-  DCHECK(result);
-}
-
-void SharedSampler::UnregisterCallbacks(base::ProcessId process_id) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
-
-  if (process_id == 0)
-    return;
-
-  callbacks_map_.erase(process_id);
-
-  if (callbacks_map_.empty())
-    ClearState();
-}
-
-void SharedSampler::Refresh(base::ProcessId process_id, int64_t refresh_flags) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
-  DCHECK(callbacks_map_.find(process_id) != callbacks_map_.end());
-  DCHECK_NE(0, refresh_flags & GetSupportedFlags());
-
-  if (process_id == 0)
-    return;
-
-  if (refresh_flags_ == 0) {
-    base::PostTaskAndReplyWithResult(
-        blocking_pool_runner_.get(), FROM_HERE,
-        base::Bind(&SharedSampler::RefreshOnWorkerThread, this),
-        base::Bind(&SharedSampler::OnRefreshDone, this));
-  } else {
-    // A group of consecutive Refresh calls should all specify the same refresh
-    // flags.
-    DCHECK_EQ(refresh_flags, refresh_flags_);
-  }
-
-  refresh_flags_ |= refresh_flags;
-}
-
-void SharedSampler::ClearState() {
-  previous_snapshot_.reset();
-}
-
-std::unique_ptr<SharedSampler::RefreshResults>
-SharedSampler::RefreshOnWorkerThread() {
-  DCHECK(worker_pool_sequenced_checker_.CalledOnValidSequence());
-
-  std::unique_ptr<RefreshResults> results(new RefreshResults);
-
-  std::unique_ptr<ProcessDataSnapshot> snapshot = CaptureSnapshot();
-  if (snapshot) {
-    if (previous_snapshot_) {
-      MakeResultsFromTwoSnapshots(
-          *previous_snapshot_, *snapshot, results.get());
-    } else {
-      MakeResultsFromSnapshot(*snapshot, results.get());
-    }
-
-    previous_snapshot_ = std::move(snapshot);
-  } else {
-    // Failed to get snapshot. This is unlikely.
-    ClearState();
-  }
-
-  return results;
-}
-
-/* static */
-std::vector<base::FilePath> SharedSampler::GetSupportedImageNames() {
-  const wchar_t kNacl64Exe[] = L"nacl64.exe";
-
-  std::vector<base::FilePath> supported_names;
-
-  base::FilePath current_exe;
-  if (PathService::Get(base::FILE_EXE, &current_exe))
-    supported_names.push_back(current_exe.BaseName());
-
-  supported_names.push_back(
-      base::FilePath(chrome::kBrowserProcessExecutableName));
-  supported_names.push_back(base::FilePath(kNacl64Exe));
-
-  return supported_names;
-}
-
-bool SharedSampler::IsSupportedImageName(
-    base::FilePath::StringPieceType image_name) const {
-  for (const base::FilePath supported_name : supported_image_names_) {
-    if (base::FilePath::CompareEqualIgnoreCase(image_name,
-                                               supported_name.value()))
-      return true;
-  }
-
-  return false;
-}
-
-std::unique_ptr<ProcessDataSnapshot> SharedSampler::CaptureSnapshot() {
-  DCHECK(worker_pool_sequenced_checker_.CalledOnValidSequence());
-
-  // Preallocate the buffer with the size determined on the previous call to
-  // QuerySystemProcessInformation. This should be sufficient most of the time.
-  // QuerySystemProcessInformation will grow the buffer if necessary.
-  ByteBuffer data_buffer(previous_buffer_size_);
-
-  if (!QuerySystemProcessInformation(&data_buffer))
-    return std::unique_ptr<ProcessDataSnapshot>();
-
-  previous_buffer_size_ = data_buffer.capacity();
-
-  std::unique_ptr<ProcessDataSnapshot> snapshot(new ProcessDataSnapshot);
-  snapshot->timestamp = base::TimeTicks::Now();
-
-  for (size_t offset = 0; offset < data_buffer.size(); ) {
-    auto pi = reinterpret_cast<const SYSTEM_PROCESS_INFORMATION*>(
-      data_buffer.data() + offset);
-
-    // Validate that the offset is valid and all needed data is within
-    // the buffer boundary.
-    if (offset + sizeof(SYSTEM_PROCESS_INFORMATION) > data_buffer.size())
-      break;
-    if (offset + sizeof(SYSTEM_PROCESS_INFORMATION) +
-            (pi->NumberOfThreads - 1) * sizeof(SYSTEM_THREAD_INFORMATION) >
-      data_buffer.size())
-      break;
-
-    if (pi->ImageName.Buffer) {
-      // Validate that the image name is within the buffer boundary.
-      // ImageName.Length seems to be in bytes rather than characters.
-      ULONG image_name_offset =
-          reinterpret_cast<BYTE*>(pi->ImageName.Buffer) - data_buffer.data();
-      if (image_name_offset + pi->ImageName.Length > data_buffer.size())
-        break;
-
-      // Check if this is a chrome process. Ignore all other processes.
-      if (IsSupportedImageName(pi->ImageName.Buffer)) {
-        // Collect enough data to be able to do a diff between two snapshots.
-        // Some threads might stop or new threads might be created between two
-        // snapshots. If a thread with a large number of context switches gets
-        // terminated the total number of context switches for the process might
-        // go down and the delta would be negative.
-        // To avoid that we need to compare thread IDs between two snapshots and
-        // not count context switches for threads that are missing in the most
-        // recent snapshot.
-        ProcessData process_data;
-
-        // Iterate over threads and store each thread's ID and number of context
-        // switches.
-        for (ULONG thread_index = 0; thread_index < pi->NumberOfThreads;
-             ++thread_index) {
-          const SYSTEM_THREAD_INFORMATION* ti = &pi->Threads[thread_index];
-          if (ti->ClientId.UniqueProcess != pi->ProcessId)
-            continue;
-
-          ThreadData thread_data;
-          thread_data.thread_id = static_cast<base::PlatformThreadId>(
-              reinterpret_cast<uintptr_t>(ti->ClientId.UniqueThread));
-          thread_data.context_switches = ti->ContextSwitchCount;
-          process_data.threads.push_back(thread_data);
-        }
-
-        // Order thread data by thread ID to help diff two snapshots.
-        std::sort(process_data.threads.begin(), process_data.threads.end(),
-            [](const ThreadData& l, const ThreadData r) {
-              return l.thread_id < r.thread_id;
-            });
-
-        base::ProcessId process_id = static_cast<base::ProcessId>(
-            reinterpret_cast<uintptr_t>(pi->ProcessId));
-        bool inserted = snapshot->processes.insert(
-            std::make_pair(process_id, std::move(process_data))).second;
-        DCHECK(inserted);
-      }
-    }
-
-    // Check for end of the list.
-    if (!pi->NextEntryOffset)
-      break;
-
-    // Jump to the next entry.
-    offset += pi->NextEntryOffset;
-  }
-
-  return snapshot;
-}
-
-void SharedSampler::MakeResultsFromTwoSnapshots(
-    const ProcessDataSnapshot& prev_snapshot,
-    const ProcessDataSnapshot& snapshot,
-    RefreshResults* results) {
-  // Time delta in seconds.
-  double time_delta = (snapshot.timestamp - prev_snapshot.timestamp)
-      .InSecondsF();
-
-  // Iterate over processes in both snapshots in parallel. This algorithm relies
-  // on map entries being ordered by Process ID.
-  ProcessDataMap::const_iterator prev_iter = prev_snapshot.processes.begin();
-
-  for (const auto& current_entry : snapshot.processes) {
-    base::ProcessId process_id = current_entry.first;
-    const ProcessData& process = current_entry.second;
-
-    const ProcessData* prev_snapshot_process = SeekInPreviousSnapshot(
-        process_id, &prev_iter, prev_snapshot.processes.end());
-
-    // Delta between the old snapshot and the new snapshot.
-    int idle_wakeups_delta;
-
-    if (prev_snapshot_process) {
-      // Processes match between two snapshots. Diff context switches.
-      idle_wakeups_delta =
-          CountContextSwitchesDelta(*prev_snapshot_process, process);
-    } else {
-      // Process is missing in the previous snapshot.
-      // Use entire number of context switches of the current process.
-      idle_wakeups_delta = CountContextSwitchesDelta(ProcessData(), process);
-    }
-
-    RefreshResult result;
-    result.process_id = process_id;
-    result.idle_wakeups_per_second =
-        static_cast<int>(round(idle_wakeups_delta / time_delta));
-    results->push_back(result);
-  }
-}
-
-void SharedSampler::MakeResultsFromSnapshot(const ProcessDataSnapshot& snapshot,
-                                            RefreshResults* results) {
-  for (const auto& pair : snapshot.processes) {
-    RefreshResult result;
-    result.process_id = pair.first;
-    // Use 0 for Idle Wakeups / sec in this case. This is consistent with
-    // ProcessMetrics::CalculateIdleWakeupsPerSecond implementation.
-    result.idle_wakeups_per_second = 0;
-    results->push_back(result);
-  }
-}
-
-void SharedSampler::OnRefreshDone(
-    std::unique_ptr<RefreshResults> refresh_results) {
-  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
-  DCHECK_NE(0, refresh_flags_);
-
-  size_t result_index = 0;
-
-  for (const auto& callback_entry : callbacks_map_) {
-    base::ProcessId process_id = callback_entry.first;
-    // A sentinel value of -1 is used when the result isn't available.
-    // Task manager will use this to display 'N/A'.
-    int idle_wakeups_per_second = -1;
-
-    // Match refresh result by |process_id|.
-    // This relies on refresh results being ordered by Process ID.
-    // Please note that |refresh_results| might contain some extra entries that
-    // don't exist in |callbacks_map_| if there is more than one instance of
-    // Chrome. It might be missing some entries too if there is a race condition
-    // between getting process information on the worker thread and adding a
-    // corresponding TaskGroup to the task manager.
-    for (; result_index < refresh_results->size(); ++result_index) {
-      const auto& result = (*refresh_results)[result_index];
-      if (result.process_id == process_id) {
-        // Data matched in |refresh_results|.
-        idle_wakeups_per_second = result.idle_wakeups_per_second;
-        ++result_index;
-        break;
-      }
-
-      if (result.process_id > process_id) {
-        // An entry corresponding to |process_id| is missing. See above.
-        break;
-      }
-    }
-
-    if (TaskManagerObserver::IsResourceRefreshEnabled(REFRESH_TYPE_IDLE_WAKEUPS,
-                                                      refresh_flags_)) {
-      callback_entry.second.on_idle_wakeups.Run(idle_wakeups_per_second);
-    }
-  }
-
-  // Reset refresh_results_ to trigger RefreshOnWorkerThread next time Refresh
-  // is called.
-  refresh_flags_ = 0;
-}
-
-}  // namespace task_management
diff --git a/chrome/browser/task_management/sampling/task_group.cc b/chrome/browser/task_management/sampling/task_group.cc
index de41155..7178561 100644
--- a/chrome/browser/task_management/sampling/task_group.cc
+++ b/chrome/browser/task_management/sampling/task_group.cc
@@ -10,7 +10,6 @@
 #include "base/bind.h"
 #include "base/callback.h"
 #include "build/build_config.h"
-#include "chrome/browser/task_management/sampling/shared_sampler.h"
 #include "chrome/browser/task_management/task_manager_observer.h"
 #include "components/nacl/browser/nacl_browser.h"
 #include "content/public/browser/browser_thread.h"
@@ -66,13 +65,11 @@ TaskGroup::TaskGroup(
     base::ProcessHandle proc_handle,
     base::ProcessId proc_id,
     const base::Closure& on_background_calculations_done,
-    const scoped_refptr<SharedSampler>& shared_sampler,
     const scoped_refptr<base::SequencedTaskRunner>& blocking_pool_runner)
     : process_handle_(proc_handle),
       process_id_(proc_id),
       on_background_calculations_done_(on_background_calculations_done),
       worker_thread_sampler_(nullptr),
-      shared_sampler_(shared_sampler),
       expected_on_bg_done_flags_(kBackgroundRefreshTypesMask),
       current_on_bg_done_flags_(0),
       cpu_usage_(0.0),
@@ -110,14 +107,9 @@ TaskGroup::TaskGroup(
                            base::Bind(&TaskGroup::OnProcessPriorityDone,
                                       weak_ptr_factory_.GetWeakPtr())));
   worker_thread_sampler_.swap(sampler);
-
-  shared_sampler_->RegisterCallbacks(
-      process_id_, base::Bind(&TaskGroup::OnIdleWakeupsRefreshDone,
-                              weak_ptr_factory_.GetWeakPtr()));
 }
 
 TaskGroup::~TaskGroup() {
-  shared_sampler_->UnregisterCallbacks(process_id_);
 }
 
 void TaskGroup::AddTask(Task* task) {
@@ -175,24 +167,13 @@ void TaskGroup::Refresh(const gpu::VideoMemoryUsageStats& gpu_memory_stats,
   }
 #endif  // !defined(DISABLE_NACL)
 
-  int64_t shared_refresh_flags =
-      refresh_flags & shared_sampler_->GetSupportedFlags();
-
-  // 5- Refresh resources via SharedSampler if the current platform
-  // implementation supports that. The actual work is done on the worker thread.
-  // At the moment this is supported only on OS_WIN.
-  if (shared_refresh_flags != 0) {
-    shared_sampler_->Refresh(process_id_, shared_refresh_flags);
-    refresh_flags &= ~shared_refresh_flags;
-  }
-
   // The remaining resource refreshes are time consuming and cannot be done on
   // the UI thread. Do them all on the worker thread using the TaskGroupSampler.
-  // 6-  CPU usage.
-  // 7-  Memory usage.
-  // 8-  Idle Wakeups per second.
-  // 9-  (Linux and ChromeOS only) The number of file descriptors current open.
-  // 10- Process priority (foreground vs. background).
+  // 5- CPU usage.
+  // 6- Memory usage.
+  // 7- Idle Wakeups per second.
+  // 8- (Linux and ChromeOS only) The number of file descriptors current open.
+  // 9- Process priority (foreground vs. background).
   worker_thread_sampler_->Refresh(refresh_flags);
 }
 
diff --git a/chrome/browser/task_management/sampling/task_group.h b/chrome/browser/task_management/sampling/task_group.h
index 7922427..e42c9dd 100644
--- a/chrome/browser/task_management/sampling/task_group.h
+++ b/chrome/browser/task_management/sampling/task_group.h
@@ -9,7 +9,6 @@
 #include <stdint.h>
 
 #include <map>
-#include <vector>
 
 #include "base/macros.h"
 #include "base/memory/weak_ptr.h"
@@ -25,8 +24,6 @@ struct VideoMemoryUsageStats;
 
 namespace task_management {
 
-class SharedSampler;
-
 // Defines a group of tasks tracked by the task manager which belong to the same
 // process. This class lives on the UI thread.
 class TaskGroup {
@@ -35,7 +32,6 @@ class TaskGroup {
       base::ProcessHandle proc_handle,
       base::ProcessId proc_id,
       const base::Closure& on_background_calculations_done,
-      const scoped_refptr<SharedSampler>& shared_sampler,
       const scoped_refptr<base::SequencedTaskRunner>& blocking_pool_runner);
   ~TaskGroup();
 
@@ -129,8 +125,6 @@ class TaskGroup {
 
   scoped_refptr<TaskGroupSampler> worker_thread_sampler_;
 
-  scoped_refptr<SharedSampler> shared_sampler_;
-
   // Lists the Tasks in this TaskGroup.
   // Tasks are not owned by the TaskGroup. They're owned by the TaskProviders.
   std::vector<Task*> tasks_;
diff --git a/chrome/browser/task_management/sampling/task_group_sampler.h b/chrome/browser/task_management/sampling/task_group_sampler.h
index b7c5f4f..718119e 100644
--- a/chrome/browser/task_management/sampling/task_group_sampler.h
+++ b/chrome/browser/task_management/sampling/task_group_sampler.h
@@ -40,8 +40,8 @@ struct MemoryUsageStats {
 // pool thread.
 class TaskGroupSampler : public base::RefCountedThreadSafe<TaskGroupSampler> {
  public:
-  // Below are the types of callbacks that are invoked on the UI thread upon
-  // completion of corresponding refresh tasks on the worker thread.
+  // The below are the types of the callbacks to the UI thread upon their
+  // corresponding refresh are done on the worker thread.
   using OnCpuRefreshCallback = base::Callback<void(double)>;
   using OnMemoryRefreshCallback = base::Callback<void(MemoryUsageStats)>;
   using OnIdleWakeupsCallback = base::Callback<void(int)>;
diff --git a/chrome/browser/task_management/sampling/task_manager_impl.cc b/chrome/browser/task_management/sampling/task_manager_impl.cc
index de495db..4d44f14 100644
--- a/chrome/browser/task_management/sampling/task_manager_impl.cc
+++ b/chrome/browser/task_management/sampling/task_manager_impl.cc
@@ -16,7 +16,6 @@
 #include "chrome/browser/task_management/providers/browser_process_task_provider.h"
 #include "chrome/browser/task_management/providers/child_process_task_provider.h"
 #include "chrome/browser/task_management/providers/web_contents/web_contents_task_provider.h"
-#include "chrome/browser/task_management/sampling/shared_sampler.h"
 #include "content/public/browser/browser_thread.h"
 #include "content/public/browser/gpu_data_manager.h"
 #include "content/public/browser/render_frame_host.h"
@@ -45,11 +44,10 @@ base::LazyInstance<TaskManagerImpl> lazy_task_manager_instance =
 }  // namespace
 
 TaskManagerImpl::TaskManagerImpl()
-    : on_background_data_ready_callback_(
-          base::Bind(&TaskManagerImpl::OnTaskGroupBackgroundCalculationsDone,
-                     base::Unretained(this))),
+    : on_background_data_ready_callback_(base::Bind(
+          &TaskManagerImpl::OnTaskGroupBackgroundCalculationsDone,
+          base::Unretained(this))),
       blocking_pool_runner_(GetBlockingPoolRunner()),
-      shared_sampler_(new SharedSampler(blocking_pool_runner_)),
       is_running_(false) {
   DCHECK_CURRENTLY_ON(content::BrowserThread::UI);
 
@@ -386,7 +384,7 @@ void TaskManagerImpl::TaskAdded(Task* task) {
   if (!task_group)
     task_group.reset(new TaskGroup(task->process_handle(), proc_id,
                                    on_background_data_ready_callback_,
-                                   shared_sampler_, blocking_pool_runner_));
+                                   blocking_pool_runner_));
 
   task_group->AddTask(task);
 
diff --git a/chrome/browser/task_management/sampling/task_manager_impl.h b/chrome/browser/task_management/sampling/task_manager_impl.h
index 14a940a..70de512 100644
--- a/chrome/browser/task_management/sampling/task_manager_impl.h
+++ b/chrome/browser/task_management/sampling/task_manager_impl.h
@@ -9,9 +9,6 @@
 #include <stdint.h>
 
 #include <map>
-#include <memory>
-#include <string>
-#include <vector>
 
 #include "base/lazy_instance.h"
 #include "base/macros.h"
@@ -27,8 +24,6 @@
 
 namespace task_management {
 
-class SharedSampler;
-
 // Defines a concrete implementation of the TaskManagerInterface.
 class TaskManagerImpl :
     public TaskManagerInterface,
@@ -157,10 +152,6 @@ class TaskManagerImpl :
   // sure TaskGroupSampler posts their refreshes serially.
   scoped_refptr<base::SequencedTaskRunner> blocking_pool_runner_;
 
-  // A special sampler shared with all instances of TaskGroup that calculates a
-  // subset of resources for all processes at once.
-  scoped_refptr<SharedSampler> shared_sampler_;
-
   // This will be set to true while there are observers and the task manager is
   // running.
   bool is_running_;
diff --git a/chrome/browser/task_management/task_manager_browsertest.cc b/chrome/browser/task_management/task_manager_browsertest.cc
index 45bf23a..00c7318 100644
--- a/chrome/browser/task_management/task_manager_browsertest.cc
+++ b/chrome/browser/task_management/task_manager_browsertest.cc
@@ -861,34 +861,6 @@ IN_PROC_BROWSER_TEST_F(TaskManagerBrowserTest, JSHeapMemory) {
   ASSERT_NO_FATAL_FAILURE(WaitForTaskManagerRows(1, MatchTab("title1.html")));
 }
 
-// Checks that task manager counts idle wakeups.
-IN_PROC_BROWSER_TEST_F(TaskManagerBrowserTest,
-                       IdleWakeups) {
-  ShowTaskManager();
-  model()->ToggleColumnVisibility(ColumnSpecifier::IDLE_WAKEUPS);
-
-  ui_test_utils::NavigateToURL(browser(), GetTestURL());
-
-  std::string test_js =
-    "function myWait() {\n"
-    "  setTimeout(function() { myWait(); }, 1)\n"
-    "}\n"
-    "myWait();\n"
-    "window.domAutomationController.send(\"okay\");\n";
-
-  std::string ok;
-  ASSERT_TRUE(content::ExecuteScriptAndExtractString(
-      browser()->tab_strip_model()->GetActiveWebContents(), test_js, &ok));
-  ASSERT_EQ("okay", ok);
-
-  // The script above should trigger a lot of idle wakeups - up to 1000 per
-  // second. Let's make sure we get at least 100 (in case the test runs slow).
-  ASSERT_NO_FATAL_FAILURE(WaitForTaskManagerStatToExceed(
-      MatchTab("title1.html"), ColumnSpecifier::IDLE_WAKEUPS, 100));
-  ASSERT_NO_FATAL_FAILURE(WaitForTaskManagerRows(1, MatchAnyTab()));
-  ASSERT_NO_FATAL_FAILURE(WaitForTaskManagerRows(1, MatchTab("title1.html")));
-}
-
 // Checks that task manager counts utility process JS heap size.
 IN_PROC_BROWSER_TEST_F(TaskManagerUtilityProcessBrowserTest,
                        UtilityJSHeapMemory) {
diff --git a/chrome/browser/task_management/task_manager_browsertest_util.cc b/chrome/browser/task_management/task_manager_browsertest_util.cc
index e33e4a2..6d41fff 100644
--- a/chrome/browser/task_management/task_manager_browsertest_util.cc
+++ b/chrome/browser/task_management/task_manager_browsertest_util.cc
@@ -112,8 +112,6 @@ class ResourceChangeObserver {
         return "V8 Memory Used";
       case ColumnSpecifier::SQLITE_MEMORY_USED:
         return "SQLite Memory Used";
-      case ColumnSpecifier::IDLE_WAKEUPS:
-        return "Idle wake ups";
     }
     return "N/A";
   }
diff --git a/chrome/browser/task_management/task_manager_browsertest_util.h b/chrome/browser/task_management/task_manager_browsertest_util.h
index 010632d..3707b6b 100644
--- a/chrome/browser/task_management/task_manager_browsertest_util.h
+++ b/chrome/browser/task_management/task_manager_browsertest_util.h
@@ -24,7 +24,6 @@ enum class ColumnSpecifier {
   V8_MEMORY,
   V8_MEMORY_USED,
   SQLITE_MEMORY_USED,
-  IDLE_WAKEUPS,
 
   COLUMN_NONE,  // Default value.
 };
diff --git a/chrome/browser/task_management/task_manager_tester.cc b/chrome/browser/task_management/task_manager_tester.cc
index fda98e8..05c397f 100644
--- a/chrome/browser/task_management/task_manager_tester.cc
+++ b/chrome/browser/task_management/task_manager_tester.cc
@@ -106,9 +106,6 @@ void TaskManagerTester::ToggleColumnVisibility(ColumnSpecifier column) {
     case ColumnSpecifier::V8_MEMORY:
       column_id = IDS_TASK_MANAGER_JAVASCRIPT_MEMORY_ALLOCATED_COLUMN;
       break;
-    case ColumnSpecifier::IDLE_WAKEUPS:
-      column_id = IDS_TASK_MANAGER_IDLE_WAKEUPS_COLUMN;
-      break;
   }
   model_->ToggleColumnVisibility(column_id);
 }
@@ -132,10 +129,6 @@ int64_t TaskManagerTester::GetColumnValue(ColumnSpecifier column, int row) {
       value = task_manager()->GetSqliteMemoryUsed(task_id);
       success = true;
       break;
-    case ColumnSpecifier::IDLE_WAKEUPS:
-      value = task_manager()->GetIdleWakeupsPerSecond(task_id);
-      success = true;
-      break;
   }
   if (!success)
     return 0;
diff --git a/chrome/browser/ui/android/simple_message_box_android.cc b/chrome/browser/ui/android/simple_message_box_android.cc
index c155416..dd5035e 100644
--- a/chrome/browser/ui/android/simple_message_box_android.cc
+++ b/chrome/browser/ui/android/simple_message_box_android.cc
@@ -21,12 +21,4 @@ MessageBoxResult ShowQuestionMessageBox(gfx::NativeWindow parent,
   return MESSAGE_BOX_RESULT_NO;
 }
 
-bool ShowWarningMessageBoxWithCheckbox(gfx::NativeWindow parent,
-                                       const base::string16& title,
-                                       const base::string16& message,
-                                       const base::string16& checkbox_text) {
-  NOTIMPLEMENTED();
-  return false;
-}
-
 }  // namespace chrome
diff --git a/chrome/browser/ui/ash/chrome_shell_delegate.cc b/chrome/browser/ui/ash/chrome_shell_delegate.cc
index 70753a0..1ec0dbe 100644
--- a/chrome/browser/ui/ash/chrome_shell_delegate.cc
+++ b/chrome/browser/ui/ash/chrome_shell_delegate.cc
@@ -50,7 +50,6 @@
 #include "chrome/browser/ui/ash/launcher/launcher_context_menu.h"
 #include "chrome/browser/ui/ash/media_delegate_chromeos.h"
 #include "chrome/browser/ui/ash/multi_user/multi_user_util.h"
-#include "chrome/browser/ui/ash/palette_delegate_chromeos.h"
 #include "chrome/browser/ui/ash/session_state_delegate_chromeos.h"
 #include "chrome/browser/ui/ash/session_util.h"
 #include "chrome/browser/ui/ash/system_tray_delegate_chromeos.h"
@@ -508,11 +507,6 @@ ash::MediaDelegate* ChromeShellDelegate::CreateMediaDelegate() {
   return new MediaDelegateChromeOS;
 }
 
-std::unique_ptr<ash::PaletteDelegate>
-ChromeShellDelegate::CreatePaletteDelegate() {
-  return base::WrapUnique(new chromeos::PaletteDelegateChromeOS());
-}
-
 ash::SystemTrayDelegate* ChromeShellDelegate::CreateSystemTrayDelegate() {
   return chromeos::CreateSystemTrayDelegate();
 }
diff --git a/chrome/browser/ui/ash/chrome_shell_delegate.h b/chrome/browser/ui/ash/chrome_shell_delegate.h
index 15c018a..251d0ad 100644
--- a/chrome/browser/ui/ash/chrome_shell_delegate.h
+++ b/chrome/browser/ui/ash/chrome_shell_delegate.h
@@ -51,7 +51,6 @@ class ChromeShellDelegate : public ash::ShellDelegate,
   ash::AccessibilityDelegate* CreateAccessibilityDelegate() override;
   ash::NewWindowDelegate* CreateNewWindowDelegate() override;
   ash::MediaDelegate* CreateMediaDelegate() override;
-  std::unique_ptr<ash::PaletteDelegate> CreatePaletteDelegate() override;
   std::unique_ptr<ash::PointerWatcherDelegate> CreatePointerWatcherDelegate()
       override;
   ui::MenuModel* CreateContextMenu(ash::WmShelf* wm_shelf,
diff --git a/chrome/browser/ui/ash/palette_delegate_chromeos.cc b/chrome/browser/ui/ash/palette_delegate_chromeos.cc
deleted file mode 100644
index 0342a30..0000000
--- a/chrome/browser/ui/ash/palette_delegate_chromeos.cc
+++ /dev/null
@@ -1,13 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/browser/ui/ash/palette_delegate_chromeos.h"
-
-namespace chromeos {
-
-PaletteDelegateChromeOS::PaletteDelegateChromeOS() {}
-
-PaletteDelegateChromeOS::~PaletteDelegateChromeOS() {}
-
-}  // namespace chromeos
diff --git a/chrome/browser/ui/ash/palette_delegate_chromeos.h b/chrome/browser/ui/ash/palette_delegate_chromeos.h
deleted file mode 100644
index 5d314f8..0000000
--- a/chrome/browser/ui/ash/palette_delegate_chromeos.h
+++ /dev/null
@@ -1,29 +0,0 @@
-// Copyright 2015 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_BROWSER_UI_ASH_PALETTE_DELEGATE_CHROMEOS_H_
-#define CHROME_BROWSER_UI_ASH_PALETTE_DELEGATE_CHROMEOS_H_
-
-#include <string>
-
-#include "ash/common/palette_delegate.h"
-#include "base/compiler_specific.h"
-#include "base/macros.h"
-#include "base/values.h"
-
-namespace chromeos {
-
-// A class which allows the Ash palette to perform chrome actions.
-class PaletteDelegateChromeOS : public ash::PaletteDelegate {
- public:
-  PaletteDelegateChromeOS();
-  ~PaletteDelegateChromeOS() override;
-
- private:
-  DISALLOW_COPY_AND_ASSIGN(PaletteDelegateChromeOS);
-};
-
-}  // namespace chromeos
-
-#endif  // CHROME_BROWSER_UI_ASH_PALETTE_DELEGATE_CHROMEOS_H_
diff --git a/chrome/browser/ui/bookmarks/bookmark_utils.cc b/chrome/browser/ui/bookmarks/bookmark_utils.cc
index 7b2d6b1..e548b54 100644
--- a/chrome/browser/ui/bookmarks/bookmark_utils.cc
+++ b/chrome/browser/ui/bookmarks/bookmark_utils.cc
@@ -93,7 +93,7 @@ BookmarkShortcutDisposition GetBookmarkShortcutDisposition(Profile* profile) {
   return BOOKMARK_SHORTCUT_DISPOSITION_UNCHANGED;
 }
 
-#if defined(TOOLKIT_VIEWS) && !defined(OS_WIN)
+#if defined(TOOLKIT_VIEWS)
 gfx::ImageSkia GetFolderIcon(gfx::VectorIconId id, SkColor text_color) {
   return gfx::CreateVectorIcon(id,
                                color_utils::DeriveDefaultIconColor(text_color));
@@ -284,32 +284,37 @@ bool IsValidBookmarkDropLocation(Profile* profile,
 }
 
 #if defined(TOOLKIT_VIEWS)
-// TODO(bsep): vectorize the Windows versions: crbug.com/564112
 gfx::ImageSkia GetBookmarkFolderIcon(SkColor text_color) {
 #if defined(OS_WIN)
-  return *ui::ResourceBundle::GetSharedInstance().GetImageSkiaNamed(
-      IDR_BOOKMARK_BAR_FOLDER);
-#else
-  return GetFolderIcon(gfx::VectorIconId::FOLDER, text_color);
+  if (!ui::MaterialDesignController::IsModeMaterial()) {
+    return *ui::ResourceBundle::GetSharedInstance().GetImageSkiaNamed(
+        IDR_BOOKMARK_BAR_FOLDER);
+  }
 #endif
+
+  return GetFolderIcon(gfx::VectorIconId::FOLDER, text_color);
 }
 
 gfx::ImageSkia GetBookmarkSupervisedFolderIcon(SkColor text_color) {
 #if defined(OS_WIN)
-  return *ui::ResourceBundle::GetSharedInstance().GetImageSkiaNamed(
-      IDR_BOOKMARK_BAR_FOLDER_SUPERVISED);
-#else
-  return GetFolderIcon(gfx::VectorIconId::FOLDER_SUPERVISED, text_color);
+  if (!ui::MaterialDesignController::IsModeMaterial()) {
+    return *ui::ResourceBundle::GetSharedInstance().GetImageSkiaNamed(
+        IDR_BOOKMARK_BAR_FOLDER_SUPERVISED);
+  }
 #endif
+
+  return GetFolderIcon(gfx::VectorIconId::FOLDER_SUPERVISED, text_color);
 }
 
 gfx::ImageSkia GetBookmarkManagedFolderIcon(SkColor text_color) {
 #if defined(OS_WIN)
-  return *ui::ResourceBundle::GetSharedInstance().GetImageSkiaNamed(
-      IDR_BOOKMARK_BAR_FOLDER_MANAGED);
-#else
-  return GetFolderIcon(gfx::VectorIconId::FOLDER_MANAGED, text_color);
+  if (!ui::MaterialDesignController::IsModeMaterial()) {
+    return *ui::ResourceBundle::GetSharedInstance().GetImageSkiaNamed(
+        IDR_BOOKMARK_BAR_FOLDER_MANAGED);
+  }
 #endif
+
+  return GetFolderIcon(gfx::VectorIconId::FOLDER_MANAGED, text_color);
 }
 #endif
 
diff --git a/chrome/browser/ui/chrome_pages.h b/chrome/browser/ui/chrome_pages.h
index e9dcb03..8e3470b 100644
--- a/chrome/browser/ui/chrome_pages.h
+++ b/chrome/browser/ui/chrome_pages.h
@@ -18,7 +18,6 @@
 #endif
 
 class Browser;
-class Profile;
 
 namespace content {
 class WebContents;
diff --git a/chrome/browser/ui/cocoa/browser_window_cocoa.h b/chrome/browser/ui/cocoa/browser_window_cocoa.h
index 052f403..1ac02ca 100644
--- a/chrome/browser/ui/cocoa/browser_window_cocoa.h
+++ b/chrome/browser/ui/cocoa/browser_window_cocoa.h
@@ -10,6 +10,7 @@
 #include "chrome/browser/extensions/extension_keybinding_registry.h"
 #include "chrome/browser/signin/chrome_signin_helper.h"
 #include "chrome/browser/ui/browser_window.h"
+#include "chrome/browser/ui/search/search_model_observer.h"
 #include "chrome/browser/ui/tabs/tab_utils.h"
 #include "chrome/common/features.h"
 #include "components/bookmarks/browser/bookmark_model.h"
@@ -35,7 +36,8 @@ class Extension;
 
 class BrowserWindowCocoa
     : public BrowserWindow,
-      public extensions::ExtensionKeybindingRegistry::Delegate {
+      public extensions::ExtensionKeybindingRegistry::Delegate,
+      public SearchModelObserver {
  public:
   BrowserWindowCocoa(Browser* browser,
                      BrowserWindowController* controller);
@@ -160,6 +162,10 @@ class BrowserWindowCocoa
   extensions::ActiveTabPermissionGranter* GetActiveTabPermissionGranter()
       override;
 
+  // Overridden from SearchModelObserver:
+  void ModelChanged(const SearchModel::State& old_state,
+                    const SearchModel::State& new_state) override;
+
   // Adds the given FindBar cocoa controller to this browser window.
   void AddFindBar(FindBarCocoaController* find_bar_cocoa_controller);
 
diff --git a/chrome/browser/ui/cocoa/browser_window_cocoa.mm b/chrome/browser/ui/cocoa/browser_window_cocoa.mm
index c25cee6..32cb1b0 100644
--- a/chrome/browser/ui/cocoa/browser_window_cocoa.mm
+++ b/chrome/browser/ui/cocoa/browser_window_cocoa.mm
@@ -48,6 +48,7 @@
 #import "chrome/browser/ui/cocoa/website_settings/website_settings_bubble_controller.h"
 #include "chrome/browser/ui/exclusive_access/exclusive_access_context.h"
 #include "chrome/browser/ui/profile_chooser_constants.h"
+#include "chrome/browser/ui/search/search_model.h"
 #include "chrome/browser/ui/tabs/tab_strip_model.h"
 #include "chrome/browser/web_applications/web_app.h"
 #include "chrome/common/chrome_switches.h"
@@ -140,9 +141,12 @@ BrowserWindowCocoa::BrowserWindowCocoa(Browser* browser,
   chrome::GetSavedWindowBoundsAndShowState(browser_,
                                            &bounds,
                                            &initial_show_state_);
+
+  browser_->search_model()->AddObserver(this);
 }
 
 BrowserWindowCocoa::~BrowserWindowCocoa() {
+  browser_->search_model()->RemoveObserver(this);
 }
 
 void BrowserWindowCocoa::Show() {
@@ -787,6 +791,10 @@ extensions::ActiveTabPermissionGranter*
   return tab_helper ? tab_helper->active_tab_permission_granter() : NULL;
 }
 
+void BrowserWindowCocoa::ModelChanged(const SearchModel::State& old_state,
+                                      const SearchModel::State& new_state) {
+}
+
 void BrowserWindowCocoa::DestroyBrowser() {
   [controller_ destroyBrowser];
 
diff --git a/chrome/browser/ui/cocoa/browser_window_controller.h b/chrome/browser/ui/cocoa/browser_window_controller.h
index eb6235f..c143733 100644
--- a/chrome/browser/ui/cocoa/browser_window_controller.h
+++ b/chrome/browser/ui/cocoa/browser_window_controller.h
@@ -200,7 +200,7 @@ class Command;
   // The Extension Command Registry used to determine which keyboard events to
   // handle.
   std::unique_ptr<ExtensionKeybindingRegistryCocoa>
-      extensionKeybindingRegistry_;
+      extension_keybinding_registry_;
 }
 
 // A convenience class method which gets the |BrowserWindowController| for a
diff --git a/chrome/browser/ui/cocoa/browser_window_controller.mm b/chrome/browser/ui/cocoa/browser_window_controller.mm
index feba74a..69e51c3 100644
--- a/chrome/browser/ui/cocoa/browser_window_controller.mm
+++ b/chrome/browser/ui/cocoa/browser_window_controller.mm
@@ -395,7 +395,7 @@ bool IsTabDetachingInFullscreenEnabled() {
     if ([self hasToolbar])  // Do not create the buttons in popups.
       [toolbarController_ createBrowserActionButtons];
 
-    extensionKeybindingRegistry_.reset(
+    extension_keybinding_registry_.reset(
         new ExtensionKeybindingRegistryCocoa(browser_->profile(),
             [self window],
             extensions::ExtensionKeybindingRegistry::ALL_EXTENSIONS,
@@ -612,7 +612,7 @@ bool IsTabDetachingInFullscreenEnabled() {
   }];
 
   extensions::ExtensionCommandsGlobalRegistry::Get(browser_->profile())
-      ->set_registry_for_active_window(extensionKeybindingRegistry_.get());
+      ->set_registry_for_active_window(extension_keybinding_registry_.get());
 }
 
 - (void)windowDidResignMain:(NSNotification*)notification {
@@ -988,7 +988,7 @@ bool IsTabDetachingInFullscreenEnabled() {
 
 - (BOOL)handledByExtensionCommand:(NSEvent*)event
     priority:(ui::AcceleratorManager::HandlerPriority)priority {
-  return extensionKeybindingRegistry_->ProcessKeyEvent(
+  return extension_keybinding_registry_->ProcessKeyEvent(
       content::NativeWebKeyboardEvent(event), priority);
 }
 
@@ -1850,8 +1850,8 @@ willAnimateFromState:(BookmarkBar::State)oldState
   // Global commands are handled by the ExtensionCommandsGlobalRegistry
   // instance.
   DCHECK(!command.global());
-  extensionKeybindingRegistry_->ExecuteCommand(extension_id,
-                                               command.accelerator());
+  extension_keybinding_registry_->ExecuteCommand(extension_id,
+                                                 command.accelerator());
 }
 
 - (void)setAlertState:(TabAlertState)alertState {
diff --git a/chrome/browser/ui/cocoa/simple_message_box_mac.mm b/chrome/browser/ui/cocoa/simple_message_box_mac.mm
index 1c0a692..84865c0 100644
--- a/chrome/browser/ui/cocoa/simple_message_box_mac.mm
+++ b/chrome/browser/ui/cocoa/simple_message_box_mac.mm
@@ -6,7 +6,6 @@
 
 #import <Cocoa/Cocoa.h>
 
-#include "base/mac/scoped_nsobject.h"
 #include "base/strings/sys_string_conversions.h"
 #include "chrome/browser/ui/simple_message_box_internal.h"
 #include "chrome/grit/generated_resources.h"
@@ -21,7 +20,6 @@ namespace {
 MessageBoxResult ShowMessageBox(gfx::NativeWindow parent,
                                 const base::string16& title,
                                 const base::string16& message,
-                                const base::string16& checkbox_text,
                                 MessageBoxType type) {
   startup_metric_utils::SetNonBrowserUIDisplayed();
   if (internal::g_should_skip_message_box_for_test)
@@ -39,24 +37,9 @@ MessageBoxResult ShowMessageBox(gfx::NativeWindow parent,
   } else {
     [alert addButtonWithTitle:l10n_util::GetNSString(IDS_OK)];
   }
-
-  base::scoped_nsobject<NSButton> checkbox;
-  if (!checkbox_text.empty()) {
-    checkbox.reset([[NSButton alloc] initWithFrame:NSZeroRect]);
-    [checkbox setButtonType:NSSwitchButton];
-    [checkbox setTitle:base::SysUTF16ToNSString(checkbox_text)];
-    [checkbox sizeToFit];
-    [alert setAccessoryView:checkbox];
-  }
-
   NSInteger result = [alert runModal];
-  if (result == NSAlertSecondButtonReturn)
-    return MESSAGE_BOX_RESULT_NO;
-
-  if (!checkbox || ([checkbox state] == NSOnState))
-    return MESSAGE_BOX_RESULT_YES;
-
-  return MESSAGE_BOX_RESULT_NO;
+  return (result == NSAlertSecondButtonReturn) ?
+      MESSAGE_BOX_RESULT_NO : MESSAGE_BOX_RESULT_YES;
 }
 
 }  // namespace
@@ -64,24 +47,13 @@ MessageBoxResult ShowMessageBox(gfx::NativeWindow parent,
 void ShowWarningMessageBox(gfx::NativeWindow parent,
                            const base::string16& title,
                            const base::string16& message) {
-  ShowMessageBox(parent, title, message, base::string16(),
-                 MESSAGE_BOX_TYPE_WARNING);
-}
-
-bool ShowWarningMessageBoxWithCheckbox(gfx::NativeWindow parent,
-                                       const base::string16& title,
-                                       const base::string16& message,
-                                       const base::string16& checkbox_text) {
-  ShowMessageBox(parent, title, message, checkbox_text,
-                 MESSAGE_BOX_TYPE_WARNING);
-  return false;
+  ShowMessageBox(parent, title, message, MESSAGE_BOX_TYPE_WARNING);
 }
 
 MessageBoxResult ShowQuestionMessageBox(gfx::NativeWindow parent,
                                         const base::string16& title,
                                         const base::string16& message) {
-  return ShowMessageBox(parent, title, message, base::string16(),
-                        MESSAGE_BOX_TYPE_QUESTION);
+  return ShowMessageBox(parent, title, message, MESSAGE_BOX_TYPE_QUESTION);
 }
 
 }  // namespace chrome
diff --git a/chrome/browser/ui/content_settings/content_setting_image_model.cc b/chrome/browser/ui/content_settings/content_setting_image_model.cc
index b0555db..14e82c4 100644
--- a/chrome/browser/ui/content_settings/content_setting_image_model.cc
+++ b/chrome/browser/ui/content_settings/content_setting_image_model.cc
@@ -25,6 +25,14 @@
 
 using content::WebContents;
 
+namespace {
+
+bool UseVectorGraphics() {
+  return ui::MaterialDesignController::IsModeMaterial();
+}
+
+}  // namespace
+
 // The image models hierarchy:
 //
 // ContentSettingImageModel                  - base class
@@ -98,52 +106,70 @@ namespace {
 
 struct ContentSettingsImageDetails {
   ContentSettingsType type;
-  gfx::VectorIconId icon_id;
+  int blocked_icon_id;
+  gfx::VectorIconId vector_icon_id;
   int blocked_tooltip_id;
   int blocked_explanatory_text_id;
+  int accessed_icon_id;
   int accessed_tooltip_id;
 };
 
 static const ContentSettingsImageDetails kImageDetails[] = {
     {CONTENT_SETTINGS_TYPE_COOKIES,
+     IDR_BLOCKED_COOKIES,
      gfx::VectorIconId::COOKIE,
      IDS_BLOCKED_COOKIES_TITLE,
      0,
+     IDR_ACCESSED_COOKIES,
      IDS_ACCESSED_COOKIES_TITLE},
     {CONTENT_SETTINGS_TYPE_IMAGES,
+     IDR_BLOCKED_IMAGES,
      gfx::VectorIconId::IMAGE,
      IDS_BLOCKED_IMAGES_TITLE,
      0,
+     0,
      0},
     {CONTENT_SETTINGS_TYPE_JAVASCRIPT,
+     IDR_BLOCKED_JAVASCRIPT,
      gfx::VectorIconId::CODE,
      IDS_BLOCKED_JAVASCRIPT_TITLE,
      0,
+     0,
      0},
     {CONTENT_SETTINGS_TYPE_PLUGINS,
+     IDR_BLOCKED_PLUGINS,
      gfx::VectorIconId::EXTENSION,
      IDS_BLOCKED_PLUGINS_MESSAGE,
      IDS_BLOCKED_PLUGIN_EXPLANATORY_TEXT,
+     0,
      0},
     {CONTENT_SETTINGS_TYPE_POPUPS,
+     IDR_BLOCKED_POPUPS,
      gfx::VectorIconId::WEB,
      IDS_BLOCKED_POPUPS_TOOLTIP,
      IDS_BLOCKED_POPUPS_EXPLANATORY_TEXT,
+     0,
      0},
     {CONTENT_SETTINGS_TYPE_MIXEDSCRIPT,
+     IDR_BLOCKED_MIXED_CONTENT,
      gfx::VectorIconId::MIXED_CONTENT,
      IDS_BLOCKED_DISPLAYING_INSECURE_CONTENT,
      0,
+     0,
      0},
     {CONTENT_SETTINGS_TYPE_PPAPI_BROKER,
+     IDR_BLOCKED_PPAPI_BROKER,
      gfx::VectorIconId::EXTENSION,
      IDS_BLOCKED_PPAPI_BROKER_TITLE,
      0,
+     IDR_BLOCKED_PPAPI_BROKER,
      IDS_ALLOWED_PPAPI_BROKER_TITLE},
     {CONTENT_SETTINGS_TYPE_AUTOMATIC_DOWNLOADS,
+     IDR_BLOCKED_DOWNLOADS,
      gfx::VectorIconId::FILE_DOWNLOAD,
      IDS_BLOCKED_DOWNLOAD_TITLE,
      IDS_BLOCKED_DOWNLOADS_EXPLANATION,
+     IDR_ALLOWED_DOWNLOADS,
      IDS_ALLOWED_DOWNLOAD_TITLE},
 };
 
@@ -233,6 +259,7 @@ void ContentSettingBlockedImageModel::UpdateFromWebContents(
   const ContentSettingsImageDetails* image_details = GetImageDetails(type);
   DCHECK(image_details) << "No entry for " << type << " in kImageDetails[].";
 
+  int icon_id = image_details->blocked_icon_id;
   int tooltip_id = image_details->blocked_tooltip_id;
   int explanation_id = image_details->blocked_explanatory_text_id;
 
@@ -266,17 +293,23 @@ void ContentSettingBlockedImageModel::UpdateFromWebContents(
         (map->GetDefaultContentSetting(type, NULL) != CONTENT_SETTING_BLOCK))
       return;
 
+    icon_id = image_details->accessed_icon_id;
     tooltip_id = image_details->accessed_tooltip_id;
     explanation_id = 0;
   }
   set_visible(true);
-  gfx::VectorIconId badge_id = gfx::VectorIconId::VECTOR_ICON_NONE;
-  if (type == CONTENT_SETTINGS_TYPE_PPAPI_BROKER)
-    badge_id = gfx::VectorIconId::WARNING_BADGE;
-  else if (content_settings->IsContentBlocked(type))
-    badge_id = gfx::VectorIconId::BLOCKED_BADGE;
+  if (!UseVectorGraphics()) {
+    DCHECK(icon_id);
+    SetIconByResourceId(icon_id);
+  } else {
+    gfx::VectorIconId badge_id = gfx::VectorIconId::VECTOR_ICON_NONE;
+    if (type == CONTENT_SETTINGS_TYPE_PPAPI_BROKER)
+      badge_id = gfx::VectorIconId::WARNING_BADGE;
+    else if (content_settings->IsContentBlocked(type))
+      badge_id = gfx::VectorIconId::BLOCKED_BADGE;
 
-  set_icon_by_vector_id(image_details->icon_id, badge_id);
+    set_icon_by_vector_id(image_details->vector_icon_id, badge_id);
+  }
   set_explanatory_string_id(explanation_id);
   DCHECK(tooltip_id);
   set_tooltip(l10n_util::GetStringUTF16(tooltip_id));
@@ -309,9 +342,13 @@ void ContentSettingGeolocationImageModel::UpdateFromWebContents(
   usages_state.GetDetailedInfo(NULL, &state_flags);
   bool allowed =
       !!(state_flags & ContentSettingsUsagesState::TABSTATE_HAS_ANY_ALLOWED);
-  set_icon_by_vector_id(gfx::VectorIconId::MY_LOCATION,
-                        allowed ? gfx::VectorIconId::VECTOR_ICON_NONE
-                                : gfx::VectorIconId::BLOCKED_BADGE);
+  if (!UseVectorGraphics()) {
+    SetIconByResourceId(allowed ? IDR_ALLOWED_LOCATION : IDR_BLOCKED_LOCATION);
+  } else {
+    set_icon_by_vector_id(gfx::VectorIconId::MY_LOCATION,
+                          allowed ? gfx::VectorIconId::VECTOR_ICON_NONE
+                                  : gfx::VectorIconId::BLOCKED_BADGE);
+  }
   set_tooltip(l10n_util::GetStringUTF16(allowed
                                             ? IDS_GEOLOCATION_ALLOWED_TOOLTIP
                                             : IDS_GEOLOCATION_BLOCKED_TOOLTIP));
@@ -349,13 +386,21 @@ void ContentSettingMediaImageModel::UpdateFromWebContents(
   int id = IDS_CAMERA_BLOCKED;
   if (state & (TabSpecificContentSettings::MICROPHONE_BLOCKED |
                TabSpecificContentSettings::CAMERA_BLOCKED)) {
-    set_icon_by_vector_id(gfx::VectorIconId::VIDEOCAM,
-                          gfx::VectorIconId::BLOCKED_BADGE);
+    if (!UseVectorGraphics()) {
+      SetIconByResourceId(IDR_BLOCKED_CAMERA);
+    } else {
+      set_icon_by_vector_id(gfx::VectorIconId::VIDEOCAM,
+                            gfx::VectorIconId::BLOCKED_BADGE);
+    }
     if (is_mic)
       id = is_cam ? IDS_MICROPHONE_CAMERA_BLOCKED : IDS_MICROPHONE_BLOCKED;
   } else {
-    set_icon_by_vector_id(gfx::VectorIconId::VIDEOCAM,
-                          gfx::VectorIconId::VECTOR_ICON_NONE);
+    if (!UseVectorGraphics()) {
+      SetIconByResourceId(IDR_ALLOWED_CAMERA);
+    } else {
+      set_icon_by_vector_id(gfx::VectorIconId::VIDEOCAM,
+                            gfx::VectorIconId::VECTOR_ICON_NONE);
+    }
     id = IDS_CAMERA_ACCESSED;
     if (is_mic)
       id = is_cam ? IDS_MICROPHONE_CAMERA_ALLOWED : IDS_MICROPHONE_ACCESSED;
@@ -459,8 +504,12 @@ void ContentSettingSubresourceFilterImageModel::SetAnimationHasRun(
 
 ContentSettingRPHImageModel::ContentSettingRPHImageModel()
     : ContentSettingSimpleImageModel(CONTENT_SETTINGS_TYPE_PROTOCOL_HANDLERS) {
-  set_icon_by_vector_id(gfx::VectorIconId::PROTOCOL_HANDLER,
-                        gfx::VectorIconId::VECTOR_ICON_NONE);
+  if (!UseVectorGraphics()) {
+    SetIconByResourceId(IDR_REGISTER_PROTOCOL_HANDLER);
+  } else {
+    set_icon_by_vector_id(gfx::VectorIconId::PROTOCOL_HANDLER,
+                          gfx::VectorIconId::VECTOR_ICON_NONE);
+  }
   set_tooltip(l10n_util::GetStringUTF16(IDS_REGISTER_PROTOCOL_HANDLER_TOOLTIP));
 }
 
@@ -507,9 +556,14 @@ void ContentSettingMIDISysExImageModel::UpdateFromWebContents(
   usages_state.GetDetailedInfo(NULL, &state_flags);
   bool allowed =
       !!(state_flags & ContentSettingsUsagesState::TABSTATE_HAS_ANY_ALLOWED);
-  set_icon_by_vector_id(gfx::VectorIconId::MIDI,
-                        allowed ? gfx::VectorIconId::VECTOR_ICON_NONE
-                                : gfx::VectorIconId::BLOCKED_BADGE);
+  if (!UseVectorGraphics()) {
+    SetIconByResourceId(allowed ? IDR_ALLOWED_MIDI_SYSEX
+                                : IDR_BLOCKED_MIDI_SYSEX);
+  } else {
+    set_icon_by_vector_id(gfx::VectorIconId::MIDI,
+                          allowed ? gfx::VectorIconId::VECTOR_ICON_NONE
+                                  : gfx::VectorIconId::BLOCKED_BADGE);
+  }
   set_tooltip(l10n_util::GetStringUTF16(allowed
                                             ? IDS_MIDI_SYSEX_ALLOWED_TOOLTIP
                                             : IDS_MIDI_SYSEX_BLOCKED_TOOLTIP));
@@ -518,20 +572,22 @@ void ContentSettingMIDISysExImageModel::UpdateFromWebContents(
 // Base class ------------------------------------------------------------------
 
 gfx::Image ContentSettingImageModel::GetIcon(SkColor nearby_text_color) const {
-#if defined(OS_MACOSX)
   SkColor icon_color = nearby_text_color;
-#else
-  SkColor icon_color = color_utils::DeriveDefaultIconColor(nearby_text_color);
+#if !defined(OS_MACOSX)
+  icon_color = color_utils::DeriveDefaultIconColor(nearby_text_color);
 #endif
 
-  return gfx::Image(
-      gfx::CreateVectorIconWithBadge(icon_id_, 16, icon_color, icon_badge_id_));
+  return UseVectorGraphics()
+             ? gfx::Image(gfx::CreateVectorIconWithBadge(
+                   vector_icon_id_, 16, icon_color, vector_icon_badge_id_))
+             : raster_icon_;
 }
 
 ContentSettingImageModel::ContentSettingImageModel()
     : is_visible_(false),
-      icon_id_(gfx::VectorIconId::VECTOR_ICON_NONE),
-      icon_badge_id_(gfx::VectorIconId::VECTOR_ICON_NONE),
+      raster_icon_id_(0),
+      vector_icon_id_(gfx::VectorIconId::VECTOR_ICON_NONE),
+      vector_icon_badge_id_(gfx::VectorIconId::VECTOR_ICON_NONE),
       explanatory_string_id_(0) {}
 
 // static
@@ -567,12 +623,25 @@ ScopedVector<ContentSettingImageModel>
   return result;
 }
 
+void ContentSettingImageModel::SetIconByResourceId(int id) {
+  raster_icon_id_ = id;
+  raster_icon_ =
+      ui::ResourceBundle::GetSharedInstance().GetNativeImageNamed(id);
+}
+
 #if defined(OS_MACOSX)
 bool ContentSettingImageModel::UpdateFromWebContentsAndCheckIfIconChanged(
     content::WebContents* web_contents) {
-  gfx::VectorIconId old_icon = icon_id_;
-  gfx::VectorIconId old_badge_icon = icon_badge_id_;
-  UpdateFromWebContents(web_contents);
-  return old_icon != icon_id_ && old_badge_icon != icon_badge_id_;
+  if (UseVectorGraphics()) {
+    gfx::VectorIconId old_vector_icon = vector_icon_id_;
+    gfx::VectorIconId old_badge_icon = vector_icon_badge_id_;
+    UpdateFromWebContents(web_contents);
+    return old_vector_icon != vector_icon_id_ &&
+           old_badge_icon != vector_icon_badge_id_;
+  } else {
+    int old_icon = raster_icon_id_;
+    UpdateFromWebContents(web_contents);
+    return old_icon != raster_icon_id_;
+  }
 }
 #endif
diff --git a/chrome/browser/ui/content_settings/content_setting_image_model.h b/chrome/browser/ui/content_settings/content_setting_image_model.h
index 436a85b..d6601e6 100644
--- a/chrome/browser/ui/content_settings/content_setting_image_model.h
+++ b/chrome/browser/ui/content_settings/content_setting_image_model.h
@@ -67,10 +67,11 @@ class ContentSettingImageModel {
 
  protected:
   ContentSettingImageModel();
+  void SetIconByResourceId(int id);
 
   void set_icon_by_vector_id(gfx::VectorIconId id, gfx::VectorIconId badge_id) {
-    icon_id_ = id;
-    icon_badge_id_ = badge_id;
+    vector_icon_id_ = id;
+    vector_icon_badge_id_ = badge_id;
   }
 
   void set_visible(bool visible) { is_visible_ = visible; }
@@ -82,8 +83,13 @@ class ContentSettingImageModel {
  private:
   bool is_visible_;
 
-  gfx::VectorIconId icon_id_;
-  gfx::VectorIconId icon_badge_id_;
+  // |raster_icon_id_| and |raster_icon_| are only used for pre-MD.
+  int raster_icon_id_;
+  gfx::Image raster_icon_;
+
+  // Vector icons are used for MD.
+  gfx::VectorIconId vector_icon_id_;
+  gfx::VectorIconId vector_icon_badge_id_;
   int explanatory_string_id_;
   base::string16 tooltip_;
 
diff --git a/chrome/browser/ui/omnibox/chrome_omnibox_client.cc b/chrome/browser/ui/omnibox/chrome_omnibox_client.cc
index 8ded01b..25dbccf 100644
--- a/chrome/browser/ui/omnibox/chrome_omnibox_client.cc
+++ b/chrome/browser/ui/omnibox/chrome_omnibox_client.cc
@@ -60,13 +60,22 @@ namespace {
 //
 // The SearchProvider may mark some suggestions to be prefetched based on
 // instructions from the suggest server. If such a match ranks sufficiently
-// highly, we'll return it.
+// highly or if kAllowPrefetchNonDefaultMatch field trial is enabled, we'll
+// return it.
 //
-// We only care about matches that are the default or the second entry in the
-// dropdown (which can happen for non-default matches when a top verbatim match
-// is shown); for other matches, we think the likelihood of the user selecting
+// If the kAllowPrefetchNonDefaultMatch field trial is enabled we return the
+// prefetch suggestion even if it is not the default match. Otherwise we only
+// care about matches that are the default or the second entry in the dropdown
+// (which can happen for non-default matches when a top verbatim match is
+// shown); for other matches, we think the likelihood of the user selecting
 // them is low enough that prefetching isn't worth doing.
 const AutocompleteMatch* GetMatchToPrefetch(const AutocompleteResult& result) {
+  if (search::ShouldAllowPrefetchNonDefaultMatch()) {
+    const AutocompleteResult::const_iterator prefetch_match = std::find_if(
+        result.begin(), result.end(), SearchProvider::ShouldPrefetch);
+    return prefetch_match != result.end() ? &(*prefetch_match) : NULL;
+  }
+
   // If the default match should be prefetched, do that.
   const auto default_match = result.default_match();
   if ((default_match != result.end()) &&
@@ -265,7 +274,8 @@ void ChromeOmniboxClient::OnResultChanged(
     bool default_match_changed,
     const base::Callback<void(const SkBitmap& bitmap)>& on_bitmap_fetched) {
   if (search::IsInstantExtendedAPIEnabled() &&
-      (default_match_changed && result.default_match() != result.end())) {
+      ((default_match_changed && result.default_match() != result.end()) ||
+       (search::ShouldAllowPrefetchNonDefaultMatch() && !result.empty()))) {
     InstantSuggestion prefetch_suggestion;
     const AutocompleteMatch* match_to_prefetch = GetMatchToPrefetch(result);
     if (match_to_prefetch) {
diff --git a/chrome/browser/ui/profile_error_dialog.cc b/chrome/browser/ui/profile_error_dialog.cc
index d518454..39eb774 100644
--- a/chrome/browser/ui/profile_error_dialog.cc
+++ b/chrome/browser/ui/profile_error_dialog.cc
@@ -9,47 +9,25 @@
 #include "base/command_line.h"
 #include "base/metrics/histogram.h"
 #include "build/build_config.h"
-#include "chrome/browser/ui/chrome_pages.h"
 #include "chrome/browser/ui/simple_message_box.h"
 #include "chrome/grit/chromium_strings.h"
-#include "chrome/grit/generated_resources.h"
 #include "ui/base/l10n/l10n_util.h"
 
-namespace {
-
-#if !defined(OS_ANDROID)
-constexpr char kProfileErrorFeedbackCategory[] = "FEEDBACK_PROFILE_ERROR";
-#endif  // !defined(OS_ANDROID)
-
-}  // namespace
-
-void ShowProfileErrorDialog(ProfileErrorType type,
-                            int message_id,
-                            const std::string& diagnostics) {
+void ShowProfileErrorDialog(ProfileErrorType type, int message_id) {
 #if defined(OS_ANDROID)
   NOTIMPLEMENTED();
 #else
   UMA_HISTOGRAM_ENUMERATION("Profile.ProfileError", type, PROFILE_ERROR_END);
   if (base::CommandLine::ForCurrentProcess()->HasSwitch(
-          switches::kNoErrorDialogs)) {
+          switches::kNoErrorDialogs))
     return;
-  }
 
   static bool is_showing_profile_error_dialog = false;
-  if (is_showing_profile_error_dialog)
-    return;
-
-  base::AutoReset<bool> resetter(&is_showing_profile_error_dialog, true);
-  if (chrome::ShowWarningMessageBoxWithCheckbox(
-          nullptr, l10n_util::GetStringUTF16(IDS_PROFILE_ERROR_DIALOG_TITLE),
-          l10n_util::GetStringUTF16(message_id),
-          l10n_util::GetStringUTF16(IDS_PROFILE_ERROR_DIALOG_CHECKBOX))) {
-    std::string feedback_description =
-        l10n_util::GetStringUTF8(IDS_PROFILE_ERROR_FEEDBACK_DESCRIPTION);
-    feedback_description += "\n" + diagnostics;
-
-    chrome::ShowFeedbackPage(nullptr, feedback_description,
-                             kProfileErrorFeedbackCategory);
+  if (!is_showing_profile_error_dialog) {
+    base::AutoReset<bool> resetter(&is_showing_profile_error_dialog, true);
+    chrome::ShowWarningMessageBox(NULL,
+                                  l10n_util::GetStringUTF16(IDS_PRODUCT_NAME),
+                                  l10n_util::GetStringUTF16(message_id));
   }
 #endif
 }
diff --git a/chrome/browser/ui/profile_error_dialog.h b/chrome/browser/ui/profile_error_dialog.h
index a3d325f..e9d1d52 100644
--- a/chrome/browser/ui/profile_error_dialog.h
+++ b/chrome/browser/ui/profile_error_dialog.h
@@ -5,8 +5,6 @@
 #ifndef CHROME_BROWSER_UI_PROFILE_ERROR_DIALOG_H_
 #define CHROME_BROWSER_UI_PROFILE_ERROR_DIALOG_H_
 
-#include <string>
-
 // Be very careful while modifying this enum. Do NOT remove any elements from
 // this enum. If you need to add one, add them to the end, right before
 // PROFILE_ERROR_END. PROFILE_ERROR_END should ALWAYS be the last element in
@@ -26,16 +24,11 @@ enum ProfileErrorType {
 };
 
 // Shows an error dialog corresponding to the inability to open some portion of
-// the profile.
-// The ProfileErrorType |type| needs to correspond to one of the profile error
+// the profile. |message_id| is a string id corresponding to the message to
+// show. The ProfileErrorType needs to correspond to one of the profile error
 // types in the enum above. If your use case doesn't fit any of the ones listed
-// above, please add your type to the enum and modify the enum definition in
-// tools/metrics/histograms/histograms.xml accordingly.
-// |message_id| is a string id corresponding to the message to show.
-// |diagnostics| contains diagnostic information about the database file that
-// might have caused a profile error.
-void ShowProfileErrorDialog(ProfileErrorType type,
-                            int message_id,
-                            const std::string& diagnostics);
+// above, please add your type to the enum and modify the enum
+// definition in tools/metrics/histograms/histograms.xml accordingly.
+void ShowProfileErrorDialog(ProfileErrorType type, int message_id);
 
 #endif  // CHROME_BROWSER_UI_PROFILE_ERROR_DIALOG_H_
diff --git a/chrome/browser/ui/simple_message_box.h b/chrome/browser/ui/simple_message_box.h
index 4918861..d6f57db 100644
--- a/chrome/browser/ui/simple_message_box.h
+++ b/chrome/browser/ui/simple_message_box.h
@@ -11,12 +11,8 @@
 namespace chrome {
 
 enum MessageBoxResult {
-  // User chose NO or CANCEL. If there's a checkbox, then the checkbox was
-  // unchecked.
-  MESSAGE_BOX_RESULT_NO = 0,
-
-  // User chose YES or OK. If there's a checkbox, then the checkbox was checked.
-  MESSAGE_BOX_RESULT_YES = 1,
+  MESSAGE_BOX_RESULT_NO = 0,  // User chose NO or CANCEL.
+  MESSAGE_BOX_RESULT_YES = 1, // User chose YES or OK.
 };
 
 enum MessageBoxType {
@@ -35,13 +31,6 @@ void ShowWarningMessageBox(gfx::NativeWindow parent,
                            const base::string16& title,
                            const base::string16& message);
 
-// As above, but with a checkbox. Returns true if the checkbox was checked when
-// the dialog was dismissed, false otherwise.
-bool ShowWarningMessageBoxWithCheckbox(gfx::NativeWindow parent,
-                                       const base::string16& title,
-                                       const base::string16& message,
-                                       const base::string16& checkbox_text);
-
 // As above, but two buttons are displayed and the return value indicates which
 // is chosen.
 MessageBoxResult ShowQuestionMessageBox(gfx::NativeWindow parent,
diff --git a/chrome/browser/ui/tab_helpers.cc b/chrome/browser/ui/tab_helpers.cc
index d46da69..b8653db 100644
--- a/chrome/browser/ui/tab_helpers.cc
+++ b/chrome/browser/ui/tab_helpers.cc
@@ -60,8 +60,6 @@
 #include "chrome/browser/android/offline_pages/recent_tab_helper.h"
 #include "chrome/browser/android/voice_search_tab_helper.h"
 #include "chrome/browser/android/webapps/single_tab_mode_tab_helper.h"
-#include "chrome/browser/bookmarks/bookmark_model_factory.h"
-#include "chrome/browser/ntp_snippets/bookmark_last_visit_updater.h"
 #include "chrome/browser/ui/android/context_menu_helper.h"
 #include "chrome/browser/ui/android/view_android_helper.h"
 #include "components/offline_pages/offline_page_feature.h"
@@ -187,10 +185,6 @@ void TabHelpers::AttachTabHelpers(WebContents* web_contents) {
 
 #if BUILDFLAG(ANDROID_JAVA_UI)
   banners::AppBannerManagerAndroid::CreateForWebContents(web_contents);
-  BookmarkLastVisitUpdater::CreateForWebContentsWithBookmarkModel(
-      web_contents,
-      BookmarkModelFactory::GetForProfile(
-          Profile::FromBrowserContext(web_contents->GetBrowserContext())));
   ContextMenuHelper::CreateForWebContents(web_contents);
   DataUseTabHelper::CreateForWebContents(web_contents);
 
diff --git a/chrome/browser/ui/task_manager/task_manager_columns.cc b/chrome/browser/ui/task_manager/task_manager_columns.cc
index 492606a..4016f0b 100644
--- a/chrome/browser/ui/task_manager/task_manager_columns.cc
+++ b/chrome/browser/ui/task_manager/task_manager_columns.cc
@@ -71,8 +71,13 @@ const TableColumnData kColumns[] = {
   { IDS_TASK_MANAGER_JAVASCRIPT_MEMORY_ALLOCATED_COLUMN, ui::TableColumn::RIGHT,
     -1, 0, arraysize("2000.0K (2000.0 live)") * kCharWidth, -1, true, false,
     false },
+
+#if defined(OS_MACOSX) || defined(OS_LINUX)
+  // TODO(port): Port the idle wakeups per second to platforms other than Linux
+  // and MacOS (http://crbug.com/120488).
   { IDS_TASK_MANAGER_IDLE_WAKEUPS_COLUMN, ui::TableColumn::RIGHT, -1, 0,
     arraysize("idlewakeups") * kCharWidth, -1, true, false, false },
+#endif  // defined(OS_MACOSX) || defined(OS_LINUX)
 
 #if defined(OS_LINUX)
   { IDS_TASK_MANAGER_OPEN_FD_COUNT_COLUMN, ui::TableColumn::RIGHT, -1, 0,
diff --git a/chrome/browser/ui/toolbar/chrome_toolbar_model_delegate.cc b/chrome/browser/ui/toolbar/chrome_toolbar_model_delegate.cc
index 391fab4..81f438b 100644
--- a/chrome/browser/ui/toolbar/chrome_toolbar_model_delegate.cc
+++ b/chrome/browser/ui/toolbar/chrome_toolbar_model_delegate.cc
@@ -80,6 +80,26 @@ ChromeToolbarModelDelegate::GetSecurityLevel() const {
   return client->GetSecurityInfo().security_level;
 }
 
+int
+ChromeToolbarModelDelegate::GetIronframeStatus() const {
+  content::WebContents* web_contents = GetActiveWebContents();
+  // If there is no active WebContents (which can happen during toolbar
+  // initialization), assume no security style.
+  if (!web_contents)
+      return 0;
+  return web_contents->IronframeStatus();
+  //auto* client = ChromeSecurityStateModelClient::FromWebContents(web_contents);
+  //return client->GetSecurityInfo().security_level;
+}
+
+std::string
+ChromeToolbarModelDelegate::GetIronframeOrigin() const {
+  content::WebContents* web_contents = GetActiveWebContents();
+  if (!web_contents)
+      return std::string();
+  return web_contents->IronframeOrigin();
+}
+
 base::string16 ChromeToolbarModelDelegate::GetSearchTerms(
     security_state::SecurityStateModel::SecurityLevel security_level) const {
   content::WebContents* web_contents = GetActiveWebContents();
diff --git a/chrome/browser/ui/toolbar/chrome_toolbar_model_delegate.h b/chrome/browser/ui/toolbar/chrome_toolbar_model_delegate.h
index c9fc6e6..8577307 100644
--- a/chrome/browser/ui/toolbar/chrome_toolbar_model_delegate.h
+++ b/chrome/browser/ui/toolbar/chrome_toolbar_model_delegate.h
@@ -34,6 +34,8 @@ class ChromeToolbarModelDelegate : public ToolbarModelDelegate {
   bool GetURL(GURL* url) const override;
   bool ShouldDisplayURL() const override;
   SecurityLevel GetSecurityLevel() const override;
+  int GetIronframeStatus() const override;
+  std::string GetIronframeOrigin() const override;
   base::string16 GetSearchTerms(SecurityLevel security_level) const override;
   scoped_refptr<net::X509Certificate> GetCertificate() const override;
 
diff --git a/chrome/browser/ui/views/chooser_content_view.cc b/chrome/browser/ui/views/chooser_content_view.cc
index 6ae3d32..06a7e9d 100644
--- a/chrome/browser/ui/views/chooser_content_view.cc
+++ b/chrome/browser/ui/views/chooser_content_view.cc
@@ -169,9 +169,6 @@ views::Link* ChooserContentView::CreateExtraView() {
   discovery_state_ = new views::Link(chooser_controller_->GetStatus());
   discovery_state_->SetHandlesTooltips(false);
   discovery_state_->SetUnderline(false);
-  discovery_state_->SetMultiLine(true);
-  discovery_state_->SizeToFit(kChooserWidth / 2);
-  discovery_state_->SetHorizontalAlignment(gfx::ALIGN_LEFT);
   discovery_state_->set_listener(this);
   return discovery_state_;
 }
diff --git a/chrome/browser/ui/views/frame/browser_header_painter_ash.cc b/chrome/browser/ui/views/frame/browser_header_painter_ash.cc
index d294eec..d2a7316 100644
--- a/chrome/browser/ui/views/frame/browser_header_painter_ash.cc
+++ b/chrome/browser/ui/views/frame/browser_header_painter_ash.cc
@@ -5,8 +5,8 @@
 #include "chrome/browser/ui/views/frame/browser_header_painter_ash.h"
 
 #include "ash/common/ash_layout_constants.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-#include "ash/common/frame/header_painter_util.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
+#include "ash/frame/header_painter_util.h"
 #include "base/logging.h"  // DCHECK
 #include "chrome/browser/themes/theme_properties.h"
 #include "chrome/browser/ui/browser.h"
diff --git a/chrome/browser/ui/views/frame/browser_header_painter_ash.h b/chrome/browser/ui/views/frame/browser_header_painter_ash.h
index b0cec82..3ec6e8d 100644
--- a/chrome/browser/ui/views/frame/browser_header_painter_ash.h
+++ b/chrome/browser/ui/views/frame/browser_header_painter_ash.h
@@ -7,7 +7,7 @@
 
 #include <memory>
 
-#include "ash/common/frame/header_painter.h"
+#include "ash/frame/header_painter.h"
 #include "base/compiler_specific.h"  // override
 #include "base/macros.h"
 #include "third_party/skia/include/core/SkColor.h"
diff --git a/chrome/browser/ui/views/frame/browser_non_client_frame_view_ash.cc b/chrome/browser/ui/views/frame/browser_non_client_frame_view_ash.cc
index 36a5e4f..2f2b9ba 100644
--- a/chrome/browser/ui/views/frame/browser_non_client_frame_view_ash.cc
+++ b/chrome/browser/ui/views/frame/browser_non_client_frame_view_ash.cc
@@ -7,13 +7,12 @@
 #include <algorithm>
 
 #include "ash/common/ash_layout_constants.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-#include "ash/common/frame/default_header_painter.h"
-#include "ash/common/frame/frame_border_hit_test.h"
-#include "ash/common/frame/header_painter_util.h"
 #include "ash/common/material_design/material_design_controller.h"
 #include "ash/common/wm_shell.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
+#include "ash/frame/default_header_painter.h"
 #include "ash/frame/frame_border_hit_test_controller.h"
+#include "ash/frame/header_painter_util.h"
 #include "build/build_config.h"
 #include "chrome/app/chrome_command_ids.h"
 #include "chrome/browser/extensions/extension_util.h"
@@ -216,8 +215,8 @@ gfx::Rect BrowserNonClientFrameViewAsh::GetWindowBoundsForClientBounds(
 }
 
 int BrowserNonClientFrameViewAsh::NonClientHitTest(const gfx::Point& point) {
-  const int hit_test =
-      ash::FrameBorderNonClientHitTest(this, caption_button_container_, point);
+  const int hit_test = ash::FrameBorderHitTestController::NonClientHitTest(
+      this, caption_button_container_, point);
 
   // See if the point is actually within the web app back button.
   if (hit_test == HTCAPTION && web_app_left_header_view_ &&
diff --git a/chrome/browser/ui/views/frame/browser_non_client_frame_view_ash_browsertest.cc b/chrome/browser/ui/views/frame/browser_non_client_frame_view_ash_browsertest.cc
index 6021499..850d659 100644
--- a/chrome/browser/ui/views/frame/browser_non_client_frame_view_ash_browsertest.cc
+++ b/chrome/browser/ui/views/frame/browser_non_client_frame_view_ash_browsertest.cc
@@ -6,11 +6,11 @@
 
 #include "ash/common/ash_constants.h"
 #include "ash/common/ash_switches.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
-#include "ash/common/frame/header_painter.h"
 #include "ash/common/material_design/material_design_controller.h"
 #include "ash/common/wm/maximize_mode/maximize_mode_controller.h"
 #include "ash/common/wm_shell.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
+#include "ash/frame/header_painter.h"
 #include "ash/shell.h"
 #include "base/command_line.h"
 #include "build/build_config.h"
diff --git a/chrome/browser/ui/views/frame/web_app_left_header_view_ash.cc b/chrome/browser/ui/views/frame/web_app_left_header_view_ash.cc
index 21714dc..82b7e89 100644
--- a/chrome/browser/ui/views/frame/web_app_left_header_view_ash.cc
+++ b/chrome/browser/ui/views/frame/web_app_left_header_view_ash.cc
@@ -4,8 +4,8 @@
 
 #include "chrome/browser/ui/views/frame/web_app_left_header_view_ash.h"
 
-#include "ash/common/frame/caption_buttons/frame_caption_button.h"
-#include "ash/common/frame/caption_buttons/frame_caption_button_container_view.h"
+#include "ash/frame/caption_buttons/frame_caption_button.h"
+#include "ash/frame/caption_buttons/frame_caption_button_container_view.h"
 #include "chrome/app/chrome_command_ids.h"
 #include "chrome/browser/ssl/chrome_security_state_model_client.h"
 #include "chrome/browser/ui/browser_commands.h"
diff --git a/chrome/browser/ui/views/frame/web_app_left_header_view_ash_unittest.cc b/chrome/browser/ui/views/frame/web_app_left_header_view_ash_unittest.cc
index 3c2eecf..b322915 100644
--- a/chrome/browser/ui/views/frame/web_app_left_header_view_ash_unittest.cc
+++ b/chrome/browser/ui/views/frame/web_app_left_header_view_ash_unittest.cc
@@ -4,7 +4,7 @@
 
 #include "chrome/browser/ui/views/frame/web_app_left_header_view_ash.h"
 
-#include "ash/common/frame/caption_buttons/frame_caption_button.h"
+#include "ash/frame/caption_buttons/frame_caption_button.h"
 #include "base/command_line.h"
 #include "base/macros.h"
 #include "base/values.h"
diff --git a/chrome/browser/ui/views/location_bar/location_bar_view.cc b/chrome/browser/ui/views/location_bar/location_bar_view.cc
index a219ea3..3e2e36a 100644
--- a/chrome/browser/ui/views/location_bar/location_bar_view.cc
+++ b/chrome/browser/ui/views/location_bar/location_bar_view.cc
@@ -567,7 +567,7 @@ void LocationBarView::Layout() {
     return;
 
   selected_keyword_view_->SetVisible(false);
-  location_icon_view_->SetVisible(false);
+  //location_icon_view_->SetVisible(false);
   keyword_hint_view_->SetVisible(false);
 
   const int item_padding = GetLayoutConstant(LOCATION_BAR_HORIZONTAL_PADDING);
@@ -590,7 +590,7 @@ void LocationBarView::Layout() {
   const int vertical_padding = GetVerticalEdgeThicknessWithPadding();
   const int location_height = std::max(height() - (vertical_padding * 2), 0);
 
-  location_icon_view_->SetLabel(base::string16());
+  //location_icon_view_->SetLabel(base::string16(base::ASCIIToUTF16("ironframe")));
   location_icon_view_->SetBackground(false);
   if (ShouldShowKeywordBubble()) {
     leading_decorations.AddDecoration(vertical_padding, location_height, true,
@@ -613,7 +613,7 @@ void LocationBarView::Layout() {
       }
     }
   } else if (ShouldShowEVBubble()) {
-    location_icon_view_->SetLabel(GetToolbarModel()->GetEVCertName());
+      //GetToolbarModel()->GetEVCertName());
     location_icon_view_->SetBackground(true);
     // The largest fraction of the omnibox that can be taken by the EV bubble.
     const double kMaxBubbleFraction = 0.5;
@@ -860,8 +860,21 @@ void LocationBarView::RefreshLocationIcon() {
     return;
 
   if (ui::MaterialDesignController::IsModeMaterial()) {
-    security_state::SecurityStateModel::SecurityLevel security_level =
-        GetToolbarModel()->GetSecurityLevel(false);
+      int ironframe_status = GetToolbarModel()->GetIronframeStatus();
+
+      security_state::SecurityStateModel::SecurityLevel security_level =
+          GetToolbarModel()->GetSecurityLevel(false);
+
+      if (ironframe_status != 0) {
+          //security_level = security_state::SecurityStateModel::SECURE;
+          if (ironframe_status == 1) {
+              security_level = security_state::SecurityStateModel::SECURE;
+              location_icon_view_->SetLabel(base::ASCIIToUTF16(GetToolbarModel()->GetIronframeOrigin()));
+          } else if (ironframe_status == 2) {
+              security_level = security_state::SecurityStateModel::SECURITY_ERROR;
+          }
+      }
+      
     SkColor icon_color =
         (security_level == security_state::SecurityStateModel::NONE)
             ? color_utils::DeriveDefaultIconColor(GetColor(TEXT))
@@ -1044,8 +1057,14 @@ bool LocationBarView::ShouldShowKeywordBubble() const {
 }
 
 bool LocationBarView::ShouldShowEVBubble() const {
-  return (GetToolbarModel()->GetSecurityLevel(false) ==
-          security_state::SecurityStateModel::EV_SECURE);
+    int ironframe_status = GetToolbarModel()->GetIronframeStatus();
+
+    if (ironframe_status == 1) {
+        return security_state::SecurityStateModel::EV_SECURE;
+    }
+      
+    return (GetToolbarModel()->GetSecurityLevel(false) ==
+            security_state::SecurityStateModel::EV_SECURE);
 }
 
 ////////////////////////////////////////////////////////////////////////////////
diff --git a/chrome/browser/ui/views/simple_message_box_views.cc b/chrome/browser/ui/views/simple_message_box_views.cc
index 9703da7..fc3f026 100644
--- a/chrome/browser/ui/views/simple_message_box_views.cc
+++ b/chrome/browser/ui/views/simple_message_box_views.cc
@@ -37,7 +37,6 @@ class SimpleMessageBoxViews : public views::DialogDelegate {
                         MessageBoxType type,
                         const base::string16& yes_text,
                         const base::string16& no_text,
-                        const base::string16& checkbox_text,
                         bool is_system_modal);
   ~SimpleMessageBoxViews() override;
 
@@ -66,9 +65,9 @@ class SimpleMessageBoxViews : public views::DialogDelegate {
   base::string16 yes_text_;
   base::string16 no_text_;
   MessageBoxResult* result_;
+  bool is_system_modal_;
   views::MessageBoxView* message_box_view_;
   base::Closure quit_runloop_;
-  bool is_system_modal_;
 
   DISALLOW_COPY_AND_ASSIGN(SimpleMessageBoxViews);
 };
@@ -76,22 +75,20 @@ class SimpleMessageBoxViews : public views::DialogDelegate {
 ////////////////////////////////////////////////////////////////////////////////
 // SimpleMessageBoxViews, public:
 
-SimpleMessageBoxViews::SimpleMessageBoxViews(
-    const base::string16& title,
-    const base::string16& message,
-    MessageBoxType type,
-    const base::string16& yes_text,
-    const base::string16& no_text,
-    const base::string16& checkbox_text,
-    bool is_system_modal)
+SimpleMessageBoxViews::SimpleMessageBoxViews(const base::string16& title,
+                                             const base::string16& message,
+                                             MessageBoxType type,
+                                             const base::string16& yes_text,
+                                             const base::string16& no_text,
+                                             bool is_system_modal)
     : window_title_(title),
       type_(type),
       yes_text_(yes_text),
       no_text_(no_text),
       result_(NULL),
+      is_system_modal_(is_system_modal),
       message_box_view_(new views::MessageBoxView(
-          views::MessageBoxView::InitParams(message))),
-      is_system_modal_(is_system_modal) {
+          views::MessageBoxView::InitParams(message))) {
   if (yes_text_.empty()) {
     yes_text_ =
         type_ == MESSAGE_BOX_TYPE_QUESTION
@@ -101,11 +98,6 @@ SimpleMessageBoxViews::SimpleMessageBoxViews(
 
   if (no_text_.empty() && type_ == MESSAGE_BOX_TYPE_QUESTION)
     no_text_ = l10n_util::GetStringUTF16(IDS_CANCEL);
-
-  if (!checkbox_text.empty()) {
-    message_box_view_->SetCheckBoxLabel(checkbox_text);
-    message_box_view_->SetCheckBoxSelected(true);
-  }
 }
 
 SimpleMessageBoxViews::~SimpleMessageBoxViews() {
@@ -145,13 +137,7 @@ bool SimpleMessageBoxViews::Cancel() {
 }
 
 bool SimpleMessageBoxViews::Accept() {
-  if (!message_box_view_->HasCheckBox() ||
-      message_box_view_->IsCheckBoxSelected()) {
-    *result_ = MESSAGE_BOX_RESULT_YES;
-  } else {
-    *result_ = MESSAGE_BOX_RESULT_NO;
-  }
-
+  *result_ = MESSAGE_BOX_RESULT_YES;
   Done();
   return true;
 }
@@ -207,8 +193,7 @@ MessageBoxResult ShowMessageBoxImpl(gfx::NativeWindow parent,
                                     const base::string16& message,
                                     MessageBoxType type,
                                     const base::string16& yes_text,
-                                    const base::string16& no_text,
-                                    const base::string16& checkbox_text) {
+                                    const base::string16& no_text) {
   startup_metric_utils::SetNonBrowserUIDisplayed();
   if (internal::g_should_skip_message_box_for_test)
     return MESSAGE_BOX_RESULT_YES;
@@ -220,7 +205,6 @@ MessageBoxResult ShowMessageBoxImpl(gfx::NativeWindow parent,
   if (!base::MessageLoopForUI::IsCurrent() ||
       !base::MessageLoopForUI::current()->is_running() ||
       !ResourceBundle::HasSharedInstance()) {
-    LOG_IF(ERROR, !checkbox_text.empty()) << "Dialog checkbox won't be shown";
     int result = ui::MessageBox(views::HWNDForNativeWindow(parent), message,
                                 title, GetMessageBoxFlagsFromType(type));
     return (result == IDYES || result == IDOK) ?
@@ -236,8 +220,13 @@ MessageBoxResult ShowMessageBoxImpl(gfx::NativeWindow parent,
 #endif
 
   SimpleMessageBoxViews* dialog =
-      new SimpleMessageBoxViews(title, message, type, yes_text, no_text,
-                                checkbox_text, !parent /* is_system_modal */);
+      new SimpleMessageBoxViews(title,
+                                message,
+                                type,
+                                yes_text,
+                                no_text,
+                                parent == NULL  // is_system_modal
+                                );
   constrained_window::CreateBrowserModalDialogViews(dialog, parent)->Show();
 
   // NOTE: |dialog| may have been deleted by the time |RunDialogAndGetResult()|
@@ -251,24 +240,14 @@ void ShowWarningMessageBox(gfx::NativeWindow parent,
                            const base::string16& title,
                            const base::string16& message) {
   ShowMessageBoxImpl(parent, title, message, MESSAGE_BOX_TYPE_WARNING,
-                     base::string16(), base::string16(), base::string16());
-}
-
-bool ShowWarningMessageBoxWithCheckbox(gfx::NativeWindow parent,
-                                       const base::string16& title,
-                                       const base::string16& message,
-                                       const base::string16& checkbox_text) {
-  return ShowMessageBoxImpl(parent, title, message, MESSAGE_BOX_TYPE_WARNING,
-                            base::string16(), base::string16(),
-                            checkbox_text) == MESSAGE_BOX_RESULT_YES;
+                     base::string16(), base::string16());
 }
 
 MessageBoxResult ShowQuestionMessageBox(gfx::NativeWindow parent,
                                         const base::string16& title,
                                         const base::string16& message) {
   return ShowMessageBoxImpl(parent, title, message, MESSAGE_BOX_TYPE_QUESTION,
-                            base::string16(), base::string16(),
-                            base::string16());
+                            base::string16(), base::string16());
 }
 
 MessageBoxResult ShowMessageBoxWithButtonText(gfx::NativeWindow parent,
@@ -276,8 +255,8 @@ MessageBoxResult ShowMessageBoxWithButtonText(gfx::NativeWindow parent,
                                               const base::string16& message,
                                               const base::string16& yes_text,
                                               const base::string16& no_text) {
-  return ShowMessageBoxImpl(parent, title, message, MESSAGE_BOX_TYPE_QUESTION,
-                            yes_text, no_text, base::string16());
+  return ShowMessageBoxImpl(
+      parent, title, message, MESSAGE_BOX_TYPE_QUESTION, yes_text, no_text);
 }
 
 }  // namespace chrome
diff --git a/chrome/browser/ui/views/touch_uma/touch_uma_ash.cc b/chrome/browser/ui/views/touch_uma/touch_uma_ash.cc
index 3b4b56f..14fc5d3 100644
--- a/chrome/browser/ui/views/touch_uma/touch_uma_ash.cc
+++ b/chrome/browser/ui/views/touch_uma/touch_uma_ash.cc
@@ -8,22 +8,22 @@
 
 // static
 void TouchUMA::RecordGestureAction(GestureActionType action) {
-  ash::GestureActionType type = ash::GESTURE_UNKNOWN;
+  ash::TouchUMA::GestureActionType type = ash::TouchUMA::GESTURE_UNKNOWN;
   switch (action) {
     case GESTURE_TABSWITCH_TAP:
-      type = ash::GESTURE_TABSWITCH_TAP;
+      type = ash::TouchUMA::GESTURE_TABSWITCH_TAP;
       break;
     case GESTURE_TABNOSWITCH_TAP:
-      type = ash::GESTURE_TABNOSWITCH_TAP;
+      type = ash::TouchUMA::GESTURE_TABNOSWITCH_TAP;
       break;
     case GESTURE_TABCLOSE_TAP:
-      type = ash::GESTURE_TABCLOSE_TAP;
+      type = ash::TouchUMA::GESTURE_TABCLOSE_TAP;
       break;
     case GESTURE_NEWTAB_TAP:
-      type = ash::GESTURE_NEWTAB_TAP;
+      type = ash::TouchUMA::GESTURE_NEWTAB_TAP;
       break;
     case GESTURE_ROOTVIEWTOP_TAP:
-      type = ash::GESTURE_ROOTVIEWTOP_TAP;
+      type = ash::TouchUMA::GESTURE_ROOTVIEWTOP_TAP;
       break;
   }
   ash::TouchUMA::GetInstance()->RecordGestureAction(type);
diff --git a/chrome/browser/ui/webui/chromeos/login/network_screen_handler.cc b/chrome/browser/ui/webui/chromeos/login/network_screen_handler.cc
index 6e31d3c..483fc906 100644
--- a/chrome/browser/ui/webui/chromeos/login/network_screen_handler.cc
+++ b/chrome/browser/ui/webui/chromeos/login/network_screen_handler.cc
@@ -164,13 +164,8 @@ void NetworkScreenHandler::DeclareLocalizedValues(
   builder->Add("debuggingFeaturesLink", IDS_NETWORK_ENABLE_DEV_FEATURES_LINK);
 
   // MD-OOBE
-  builder->Add("oobeOKButtonText", IDS_OOBE_OK_BUTTON_TEXT);
-  builder->Add("languageSectionTitle", IDS_LANGUAGE_SECTION_TITLE);
-  builder->Add("networkSectionTitle", IDS_NETWORK_SECTION_TITLE);
+  builder->Add("networkSectionTitle", IDS_NETWORK_SECTION_TITE);
   builder->Add("networkSectionHint", IDS_NETWORK_SECTION_HINT);
-
-  builder->Add("languageDropdownTitle", IDS_LANGUAGE_DROPDOWN_TITLE);
-  builder->Add("keyboardDropdownTitle", IDS_KEYBOARD_DROPDOWN_TITLE);
   builder->Add("proxySettingsMenuName", IDS_PROXY_SETTINGS_MENU_NAME);
   builder->Add("addWiFiNetworkMenuName", IDS_ADD_WI_FI_NETWORK_MENU_NAME);
   builder->Add("addMobileNetworkMenuName", IDS_ADD_MOBILE_NETWORK_MENU_NAME);
diff --git a/chrome/browser/ui/webui/offline_internals_ui.cc b/chrome/browser/ui/webui/offline_internals_ui.cc
index 08c49c4..5ba90f0 100644
--- a/chrome/browser/ui/webui/offline_internals_ui.cc
+++ b/chrome/browser/ui/webui/offline_internals_ui.cc
@@ -92,7 +92,8 @@ class OfflineInternalsUIMessageHandler : public content::WebUIMessageHandler {
       offline_pages::DeletePageResult value);
 
   // Turns a SavePageRequest::Status into logical string.
-  std::string GetStringFromSavePageStatus();
+  std::string GetStringFromSavePageStatus(
+      offline_pages::SavePageRequest::Status status);
 
   // Offline page model to call methods on.
   offline_pages::OfflinePageModel* offline_page_model_;
@@ -133,8 +134,22 @@ std::string OfflineInternalsUIMessageHandler::GetStringFromDeletePageResult(
   return "Unknown";
 }
 
-std::string OfflineInternalsUIMessageHandler::GetStringFromSavePageStatus() {
-  return "Available";
+std::string OfflineInternalsUIMessageHandler::GetStringFromSavePageStatus(
+    offline_pages::SavePageRequest::Status status) {
+  switch (status) {
+    case offline_pages::SavePageRequest::Status::NOT_READY:
+      return "Not ready";
+    case offline_pages::SavePageRequest::Status::PENDING:
+      return "Pending";
+    case offline_pages::SavePageRequest::Status::STARTED:
+      return "Started";
+    case offline_pages::SavePageRequest::Status::FAILED:
+      return "Failed";
+    case offline_pages::SavePageRequest::Status::EXPIRED:
+      return "Expired";
+  }
+  NOTREACHED();
+  return "Unknown";
 }
 
 void OfflineInternalsUIMessageHandler::HandleDeleteAllPages(
@@ -216,7 +231,7 @@ void OfflineInternalsUIMessageHandler::HandleRequestQueueCallback(
                                    request.creation_time().ToJsTime());
       save_page_request->SetString(
           "status",
-          GetStringFromSavePageStatus());
+          GetStringFromSavePageStatus(request.GetStatus(base::Time::Now())));
       save_page_request->SetString("namespace", request.client_id().name_space);
       save_page_request->SetDouble("lastAttempt",
                                    request.last_attempt_time().ToJsTime());
diff --git a/chrome/browser/ui/webui/options/chromeos/bluetooth_options_browsertest.js b/chrome/browser/ui/webui/options/chromeos/bluetooth_options_browsertest.js
index 924b461..428016b 100644
--- a/chrome/browser/ui/webui/options/chromeos/bluetooth_options_browsertest.js
+++ b/chrome/browser/ui/webui/options/chromeos/bluetooth_options_browsertest.js
@@ -24,7 +24,7 @@ BluetoothWebUITestAsync.prototype = {
     address: '00:11:22:33:44:55',
     connectable: true,
     connected: false,
-    name: 'Fake Device (alias)',
+    name: 'Fake Device',
     paired: true
   },
 
@@ -32,7 +32,7 @@ BluetoothWebUITestAsync.prototype = {
     address: '20:7D:74:00:00:04',
     connectable: false,
     connected: false,
-    name: 'Paired Unconnectable Device (alias)',
+    name: 'Paired Unconnectable Device',
     paired: true
   },
 
diff --git a/chrome/browser/ui/webui/options/chromeos/display_options_handler.cc b/chrome/browser/ui/webui/options/chromeos/display_options_handler.cc
index 584a7e2..ce287d7 100644
--- a/chrome/browser/ui/webui/options/chromeos/display_options_handler.cc
+++ b/chrome/browser/ui/webui/options/chromeos/display_options_handler.cc
@@ -121,60 +121,47 @@ bool GetFloat(const base::DictionaryValue* dict,
   return false;
 }
 
-scoped_refptr<ash::DisplayMode> ConvertValueToDisplayMode(
-    const base::DictionaryValue* dict) {
-  scoped_refptr<ash::DisplayMode> mode;
-
-  gfx::Size size;
-  size.set_width(GetIntOrDouble(dict, "originalWidth"));
-  size.set_height(GetIntOrDouble(dict, "originalHeight"));
-
-  if (size.IsEmpty()) {
+bool ConvertValueToDisplayMode(const base::DictionaryValue* dict,
+                               ash::DisplayMode* mode) {
+  mode->size.set_width(GetIntOrDouble(dict, "originalWidth"));
+  mode->size.set_height(GetIntOrDouble(dict, "originalHeight"));
+  if (mode->size.IsEmpty()) {
     LOG(ERROR) << "missing width or height.";
-    return mode;
+    return false;
   }
-
-  float refresh_rate, ui_scale, device_scale_factor;
-  if (!GetFloat(dict, "refreshRate", &refresh_rate)) {
+  if (!GetFloat(dict, "refreshRate", &mode->refresh_rate)) {
     LOG(ERROR) << "missing refreshRate.";
-    return mode;
+    return false;
   }
-  if (!GetFloat(dict, "scale", &ui_scale)) {
+  if (!GetFloat(dict, "scale", &mode->ui_scale)) {
     LOG(ERROR) << "missing ui-scale.";
-    return mode;
+    return false;
   }
-  if (!GetFloat(dict, "deviceScaleFactor", &device_scale_factor)) {
+  if (!GetFloat(dict, "deviceScaleFactor", &mode->device_scale_factor)) {
     LOG(ERROR) << "missing deviceScaleFactor.";
-    return mode;
+    return false;
   }
-
-  // Used to select the actual mode.
-  mode =
-      new ash::DisplayMode(size, refresh_rate, false /* interlaced */,
-                           false /* native */, ui_scale, device_scale_factor);
-  return mode;
+  return true;
 }
 
-base::DictionaryValue* ConvertDisplayModeToValue(
-    int64_t display_id,
-    const scoped_refptr<ash::DisplayMode>& mode) {
+base::DictionaryValue* ConvertDisplayModeToValue(int64_t display_id,
+                                                 const ash::DisplayMode& mode) {
   bool is_internal = display::Display::HasInternalDisplay() &&
                      display::Display::InternalDisplayId() == display_id;
   base::DictionaryValue* result = new base::DictionaryValue();
-  gfx::Size size_dip = mode->GetSizeInDIP(is_internal);
+  gfx::Size size_dip = mode.GetSizeInDIP(is_internal);
   result->SetInteger("width", size_dip.width());
   result->SetInteger("height", size_dip.height());
-  result->SetInteger("originalWidth", mode->size().width());
-  result->SetInteger("originalHeight", mode->size().height());
-  result->SetDouble("deviceScaleFactor", mode->device_scale_factor());
-  result->SetDouble("scale", mode->ui_scale());
-  result->SetDouble("refreshRate", mode->refresh_rate());
-  result->SetBoolean("isBest",
-                     is_internal ? (mode->ui_scale() == 1.0f) : mode->native());
-  result->SetBoolean("isNative", mode->native());
+  result->SetInteger("originalWidth", mode.size.width());
+  result->SetInteger("originalHeight", mode.size.height());
+  result->SetDouble("deviceScaleFactor", mode.device_scale_factor);
+  result->SetDouble("scale", mode.ui_scale);
+  result->SetDouble("refreshRate", mode.refresh_rate);
+  result->SetBoolean(
+      "isBest", is_internal ? (mode.ui_scale == 1.0f) : mode.native);
+  result->SetBoolean("isNative", mode.native);
   result->SetBoolean(
-      "selected",
-      mode->IsEquivalent(
+      "selected", mode.IsEquivalent(
           GetDisplayManager()->GetActiveModeForDisplayId(display_id)));
   return result;
 }
@@ -333,8 +320,7 @@ void DisplayOptionsHandler::SendAllDisplayInfo() {
     js_display->SetInteger("rotation", display.RotationAsDegree());
 
     base::ListValue* js_resolutions = new base::ListValue();
-    for (const scoped_refptr<ash::DisplayMode>& display_mode :
-         display_info.display_modes()) {
+    for (const ash::DisplayMode& display_mode : display_info.display_modes()) {
       js_resolutions->Append(
           ConvertDisplayModeToValue(display.id(), display_mode));
     }
@@ -478,14 +464,14 @@ void DisplayOptionsHandler::HandleSetDisplayMode(const base::ListValue* args) {
     return;
   }
 
-  scoped_refptr<ash::DisplayMode> mode = ConvertValueToDisplayMode(mode_data);
-  if (!mode)
+  ash::DisplayMode mode;
+  if (!ConvertValueToDisplayMode(mode_data, &mode))
     return;
 
   content::RecordAction(
       base::UserMetricsAction("Options_DisplaySetResolution"));
   ash::DisplayManager* display_manager = GetDisplayManager();
-  scoped_refptr<ash::DisplayMode> current_mode =
+  ash::DisplayMode current_mode =
       display_manager->GetActiveModeForDisplayId(display_id);
   if (!display_manager->SetDisplayMode(display_id, mode)) {
     LOG(ERROR) << "Unable to set display mode for: " << display_id
diff --git a/chrome/browser/ui/webui/options/clear_browser_data_handler.cc b/chrome/browser/ui/webui/options/clear_browser_data_handler.cc
index 15bf8b3..55509e2 100644
--- a/chrome/browser/ui/webui/options/clear_browser_data_handler.cc
+++ b/chrome/browser/ui/webui/options/clear_browser_data_handler.cc
@@ -318,10 +318,9 @@ void ClearBrowserDataHandler::HandleClearBrowserData(
   remover_->AddObserver(this);
   int period_selected =
       prefs->GetInteger(browsing_data::prefs::kDeleteTimePeriod);
-  remover_->RemoveAndReply(
-      BrowsingDataRemover::Period(
-          static_cast<browsing_data::TimePeriod>(period_selected)),
-      remove_mask, origin_mask, this);
+  remover_->Remove(BrowsingDataRemover::Period(
+                       static_cast<browsing_data::TimePeriod>(period_selected)),
+                   remove_mask, origin_mask);
 
   // Store the clear browsing data time. Next time the clear browsing data
   // dialog is open, this time is used to decide whether to display an info
diff --git a/chrome/browser/ui/webui/settings/chromeos/internet_handler.cc b/chrome/browser/ui/webui/settings/chromeos/internet_handler.cc
deleted file mode 100644
index 8d29c20..0000000
--- a/chrome/browser/ui/webui/settings/chromeos/internet_handler.cc
+++ /dev/null
@@ -1,132 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/browser/ui/webui/settings/chromeos/internet_handler.h"
-
-#include "base/bind.h"
-#include "base/values.h"
-#include "chrome/browser/chromeos/options/network_config_view.h"
-#include "chrome/browser/chromeos/profiles/profile_helper.h"
-#include "chrome/browser/chromeos/ui/choose_mobile_network_dialog.h"
-#include "chrome/browser/profiles/profile.h"
-#include "chromeos/network/network_state.h"
-#include "chromeos/network/network_state_handler.h"
-#include "components/onc/onc_constants.h"
-#include "content/public/browser/web_contents.h"
-#include "content/public/browser/web_ui.h"
-#include "extensions/browser/api/vpn_provider/vpn_service.h"
-#include "extensions/browser/api/vpn_provider/vpn_service_factory.h"
-#include "third_party/cros_system_api/dbus/service_constants.h"
-
-namespace chromeos {
-
-namespace {
-
-const char kAddNetworkMessage[] = "addNetwork";
-const char kConfigureNetworkMessage[] = "configureNetwork";
-
-std::string ServicePathFromGuid(const std::string& guid) {
-  const NetworkState* network =
-      NetworkHandler::Get()->network_state_handler()->GetNetworkStateFromGuid(
-          guid);
-  return network ? network->path() : "";
-}
-
-Profile* GetProfileForPrimaryUser() {
-  return ProfileHelper::Get()->GetProfileByUser(
-      user_manager::UserManager::Get()->GetPrimaryUser());
-}
-
-}  // namespace
-
-namespace settings {
-
-InternetHandler::InternetHandler() {}
-
-InternetHandler::~InternetHandler() {}
-
-void InternetHandler::RegisterMessages() {
-  // TODO(stevenjb): Eliminate once network configuration UI is integrated
-  // into settings.
-  web_ui()->RegisterMessageCallback(
-      kAddNetworkMessage,
-      base::Bind(&InternetHandler::AddNetwork, base::Unretained(this)));
-  web_ui()->RegisterMessageCallback(
-      kConfigureNetworkMessage,
-      base::Bind(&InternetHandler::ConfigureNetwork, base::Unretained(this)));
-}
-
-void InternetHandler::OnJavascriptAllowed() {}
-
-void InternetHandler::OnJavascriptDisallowed() {}
-
-void InternetHandler::AddNetwork(const base::ListValue* args) {
-  std::string onc_type;
-  if (args->GetSize() < 1 || !args->GetString(0, &onc_type)) {
-    NOTREACHED() << "Invalid args for: " << kAddNetworkMessage;
-    return;
-  }
-
-  if (onc_type == ::onc::network_type::kVPN) {
-    std::string extension_id;
-    if (args->GetSize() >= 2)
-      args->GetString(1, &extension_id);
-    if (extension_id.empty()) {
-      // Show the "add network" dialog for the built-in OpenVPN/L2TP provider.
-      NetworkConfigView::ShowForType(shill::kTypeVPN, GetNativeWindow());
-      return;
-    }
-    // Request that the third-party VPN provider identified by |provider_id|
-    // show its "add network" dialog.
-    VpnServiceFactory::GetForBrowserContext(GetProfileForPrimaryUser())
-        ->SendShowAddDialogToExtension(extension_id);
-  } else if (onc_type == ::onc::network_type::kWiFi) {
-    NetworkConfigView::ShowForType(shill::kTypeWifi, GetNativeWindow());
-  } else if (onc_type == ::onc::network_type::kCellular) {
-    ChooseMobileNetworkDialog::ShowDialog(GetNativeWindow());
-  } else {
-    LOG(ERROR) << "Unsupported type for: " << kAddNetworkMessage;
-  }
-}
-
-void InternetHandler::ConfigureNetwork(const base::ListValue* args) {
-  std::string guid;
-  if (args->GetSize() < 1 || !args->GetString(0, &guid)) {
-    NOTREACHED() << "Invalid args for: " << kConfigureNetworkMessage;
-    return;
-  }
-
-  const std::string service_path = ServicePathFromGuid(guid);
-  if (service_path.empty()) {
-    LOG(ERROR) << "Network not found: " << guid;
-    return;
-  }
-
-  const NetworkState* network =
-      NetworkHandler::Get()->network_state_handler()->GetNetworkState(
-          service_path);
-  if (!network) {
-    LOG(ERROR) << "Network not found with service_path: " << service_path;
-    return;
-  }
-
-  if (network->type() == shill::kTypeVPN &&
-      network->vpn_provider_type() == shill::kProviderThirdPartyVpn) {
-    // Request that the third-party VPN provider used by the |network| show a
-    // configuration dialog for it.
-    VpnServiceFactory::GetForBrowserContext(GetProfileForPrimaryUser())
-        ->SendShowConfigureDialogToExtension(
-            network->third_party_vpn_provider_extension_id(), network->name());
-    return;
-  }
-
-  NetworkConfigView::Show(service_path, GetNativeWindow());
-}
-
-gfx::NativeWindow InternetHandler::GetNativeWindow() const {
-  return web_ui()->GetWebContents()->GetTopLevelNativeWindow();
-}
-
-}  // namespace settings
-}  // namespace chromeos
diff --git a/chrome/browser/ui/webui/settings/chromeos/internet_handler.h b/chrome/browser/ui/webui/settings/chromeos/internet_handler.h
deleted file mode 100644
index 64ceabf..0000000
--- a/chrome/browser/ui/webui/settings/chromeos/internet_handler.h
+++ /dev/null
@@ -1,41 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_BROWSER_UI_WEBUI_SETTINGS_CHROMEOS_INTERNET_HANDLER_H_
-#define CHROME_BROWSER_UI_WEBUI_SETTINGS_CHROMEOS_INTERNET_HANDLER_H_
-
-#include <memory>
-
-#include "base/macros.h"
-#include "chrome/browser/ui/webui/settings/settings_page_ui_handler.h"
-#include "ui/gfx/native_widget_types.h"
-
-namespace chromeos {
-namespace settings {
-
-// Chrome OS Internet settings page UI handler.
-class InternetHandler : public ::settings::SettingsPageUIHandler {
- public:
-  InternetHandler();
-  ~InternetHandler() override;
-
-  // SettingsPageUIHandler implementation.
-  void RegisterMessages() override;
-  void OnJavascriptAllowed() override;
-  void OnJavascriptDisallowed() override;
-
- private:
-  // Settings JS handlers.
-  void AddNetwork(const base::ListValue* args);
-  void ConfigureNetwork(const base::ListValue* args);
-
-  gfx::NativeWindow GetNativeWindow() const;
-
-  DISALLOW_COPY_AND_ASSIGN(InternetHandler);
-};
-
-}  // namespace settings
-}  // namespace chromeos
-
-#endif  // CHROME_BROWSER_UI_WEBUI_SETTINGS_CHROMEOS_INTERNET_HANDLER_H_
diff --git a/chrome/browser/ui/webui/settings/md_settings_localized_strings_provider.cc b/chrome/browser/ui/webui/settings/md_settings_localized_strings_provider.cc
index 5cc0624..111a125 100644
--- a/chrome/browser/ui/webui/settings/md_settings_localized_strings_provider.cc
+++ b/chrome/browser/ui/webui/settings/md_settings_localized_strings_provider.cc
@@ -671,13 +671,6 @@ void AddInternetStrings(content::WebUIDataSource* html_source) {
       {"internetPageTitle", IDS_SETTINGS_INTERNET},
       {"internetDetailPageTitle", IDS_SETTINGS_INTERNET_DETAIL},
       {"internetKnownNetworksPageTitle", IDS_SETTINGS_INTERNET_KNOWN_NETWORKS},
-      {"knownNetworksButton", IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_BUTTON},
-      {"knownNetworksMessage", IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_MESSAGE},
-      {"knownNetworksPreferred",
-       IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_PREFFERED},
-      {"knownNetworksNoPreferred",
-       IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_NO_PREFERRED},
-      {"knownNetworksAll", IDS_SETTINGS_INTERNET_KNOWN_NETWORKS_ALL},
   };
   AddLocalizedStringsBulk(html_source, localized_strings,
                           arraysize(localized_strings));
diff --git a/chrome/browser/ui/webui/settings/md_settings_ui.cc b/chrome/browser/ui/webui/settings/md_settings_ui.cc
index 43de40b..256485f 100644
--- a/chrome/browser/ui/webui/settings/md_settings_ui.cc
+++ b/chrome/browser/ui/webui/settings/md_settings_ui.cc
@@ -44,7 +44,6 @@
 #include "chrome/browser/ui/webui/settings/chromeos/device_keyboard_handler.h"
 #include "chrome/browser/ui/webui/settings/chromeos/device_pointer_handler.h"
 #include "chrome/browser/ui/webui/settings/chromeos/easy_unlock_settings_handler.h"
-#include "chrome/browser/ui/webui/settings/chromeos/internet_handler.h"
 #else  // !defined(OS_CHROMEOS)
 #include "chrome/browser/ui/webui/settings/settings_default_browser_handler.h"
 #include "chrome/browser/ui/webui/settings/settings_manage_profile_handler.h"
@@ -92,7 +91,6 @@ MdSettingsUI::MdSettingsUI(content::WebUI* web_ui, const GURL& url)
   AddSettingsPageUIHandler(new chromeos::settings::CupsPrintersHandler());
   AddSettingsPageUIHandler(new chromeos::settings::KeyboardHandler(web_ui));
   AddSettingsPageUIHandler(new chromeos::settings::PointerHandler());
-  AddSettingsPageUIHandler(new chromeos::settings::InternetHandler());
 #else
   AddSettingsPageUIHandler(new DefaultBrowserHandler(web_ui));
   AddSettingsPageUIHandler(new ManageProfileHandler(profile));
diff --git a/chrome/browser/ui/webui/signin/user_manager_screen_handler.cc b/chrome/browser/ui/webui/signin/user_manager_screen_handler.cc
index 68de49c..420c883 100644
--- a/chrome/browser/ui/webui/signin/user_manager_screen_handler.cc
+++ b/chrome/browser/ui/webui/signin/user_manager_screen_handler.cc
@@ -10,7 +10,6 @@
 #include <vector>
 
 #include "base/bind.h"
-#include "base/feature_list.h"
 #include "base/location.h"
 #include "base/macros.h"
 #include "base/profiler/scoped_tracker.h"
@@ -43,7 +42,6 @@
 #include "chrome/browser/ui/singleton_tabs.h"
 #include "chrome/browser/ui/user_manager.h"
 #include "chrome/browser/ui/webui/profile_helper.h"
-#include "chrome/common/chrome_features.h"
 #include "chrome/common/pref_names.h"
 #include "chrome/common/url_constants.h"
 #include "chrome/grit/chromium_strings.h"
@@ -54,7 +52,6 @@
 #include "components/signin/core/common/profile_management_switches.h"
 #include "content/public/browser/notification_service.h"
 #include "content/public/browser/storage_partition.h"
-#include "content/public/browser/user_metrics.h"
 #include "content/public/browser/web_contents.h"
 #include "content/public/browser/web_ui.h"
 #include "google_apis/gaia/gaia_auth_fetcher.h"
@@ -294,24 +291,6 @@ UserManagerScreenHandler::UserManagerScreenHandler() : weak_ptr_factory_(this) {
   profile_attributes_storage_observer_.reset(
       new UserManagerScreenHandler::ProfileUpdateObserver(
           g_browser_process->profile_manager(), this));
-
-  // TODO(mahmadi): Remove the following once prefs are cleared for everyone.
-  PrefService* service = g_browser_process->local_state();
-  DCHECK(service);
-
-  const PrefService::Preference* guest_mode_enabled_pref =
-      service->FindPreference(prefs::kBrowserGuestModeEnabled);
-  const PrefService::Preference* add_person_enabled_pref =
-      service->FindPreference(prefs::kBrowserAddPersonEnabled);
-
-  if (base::FeatureList::IsEnabled(features::kMaterialDesignSettings) &&
-      (guest_mode_enabled_pref->HasUserSetting() ||
-       add_person_enabled_pref->HasUserSetting())) {
-    service->ClearPref(guest_mode_enabled_pref->name());
-    service->ClearPref(add_person_enabled_pref->name());
-    content::RecordAction(
-        base::UserMetricsAction("UserManager_Cleared_Legacy_User_Prefs"));
-  }
 }
 
 UserManagerScreenHandler::~UserManagerScreenHandler() {
diff --git a/chrome/browser/ui/webui/snippets_internals_message_handler.cc b/chrome/browser/ui/webui/snippets_internals_message_handler.cc
index 2b0d34c..f7980ea 100644
--- a/chrome/browser/ui/webui/snippets_internals_message_handler.cc
+++ b/chrome/browser/ui/webui/snippets_internals_message_handler.cc
@@ -83,9 +83,6 @@ std::string GetCategoryTitle(Category category) {
   if (category.IsKnownCategory(KnownCategories::OFFLINE_PAGES)) {
     return "Offline pages (continue browsing)";
   }
-  if (category.IsKnownCategory(KnownCategories::BOOKMARKS)) {
-    return "Recently visited bookmarks";
-  }
   return std::string();
 }
 
diff --git a/chrome/browser/web_data_service_factory.cc b/chrome/browser/web_data_service_factory.cc
index 827aee8..8cac57d 100644
--- a/chrome/browser/web_data_service_factory.cc
+++ b/chrome/browser/web_data_service_factory.cc
@@ -55,13 +55,11 @@ ProfileErrorType ProfileErrorFromWebDataServiceWrapperError(
 
 // Callback to show error dialog on profile load error.
 void ProfileErrorCallback(WebDataServiceWrapper::ErrorType error_type,
-                          sql::InitStatus status,
-                          const std::string& diagnostics) {
-  ShowProfileErrorDialog(ProfileErrorFromWebDataServiceWrapperError(error_type),
-                         (status == sql::INIT_FAILURE)
-                             ? IDS_COULDNT_OPEN_PROFILE_ERROR
-                             : IDS_PROFILE_TOO_NEW_ERROR,
-                         diagnostics);
+                          sql::InitStatus status) {
+  ShowProfileErrorDialog(
+      ProfileErrorFromWebDataServiceWrapperError(error_type),
+      (status == sql::INIT_FAILURE) ?
+          IDS_COULDNT_OPEN_PROFILE_ERROR : IDS_PROFILE_TOO_NEW_ERROR);
 }
 
 }  // namespace
diff --git a/chrome/browser/web_dev_style/css_checker.py b/chrome/browser/web_dev_style/css_checker.py
index 93897e9..930e6aa 100644
--- a/chrome/browser/web_dev_style/css_checker.py
+++ b/chrome/browser/web_dev_style/css_checker.py
@@ -41,8 +41,7 @@ class CSSChecker(object):
 
     def _remove_ats(s):
       at_reg = re.compile(r"""
-          @(?!apply)(?!\d+x\b)    # @at-keyword, not (apply|2x)
-          \w+[^'"]*?{             # selector junk {
+          @(?!\d+x\b)\w+[^'"]*?{  # @at-keyword selector junk {, not @2x
           (.*{.*?})+              # inner { curly } blocks, rules, and selector
           .*?}                    # stuff up to the first end curly }
           """,
diff --git a/chrome/browser/web_dev_style/css_checker_test.py b/chrome/browser/web_dev_style/css_checker_test.py
index 461cc2b..77fd421 100755
--- a/chrome/browser/web_dev_style/css_checker_test.py
+++ b/chrome/browser/web_dev_style/css_checker_test.py
@@ -105,11 +105,6 @@ class CssCheckerTest(SuperMoxTestBase):
 body.alternate-logo #logo {
   -webkit-mask-image: url(images/google_logo.png@2x);
   background: none;
-  @apply(--some-variable);
-}
-
-div {
-  -webkit-margin-start: 5px;
 }
 
 .stuff1 {
diff --git a/chrome/chrome_browser.gypi b/chrome/chrome_browser.gypi
index 348ed2c..0de83b5 100644
--- a/chrome/chrome_browser.gypi
+++ b/chrome/chrome_browser.gypi
@@ -265,11 +265,12 @@
       'browser/geolocation/geolocation_prefs.h',
       'browser/global_keyboard_shortcuts_mac.h',
       'browser/global_keyboard_shortcuts_mac.mm',
+      'browser/gpu/gl_string_manager.cc',
+      'browser/gpu/gl_string_manager.h',
       'browser/gpu/gpu_feature_checker.cc',
       'browser/gpu/gpu_feature_checker.h',
       'browser/gpu/gpu_mode_manager.cc',
       'browser/gpu/gpu_mode_manager.h',
-      'browser/gpu/gpu_profile_cache.h',
       'browser/gpu/three_d_api_observer.cc',
       'browser/gpu/three_d_api_observer.h',
       'browser/icon_loader.cc',
@@ -393,8 +394,6 @@
       'browser/net/predictor_tab_helper.h',
       'browser/ntp_snippets/content_suggestions_service_factory.cc',
       'browser/ntp_snippets/content_suggestions_service_factory.h',
-      'browser/ntp_snippets/bookmark_last_visit_updater.cc',
-      'browser/ntp_snippets/bookmark_last_visit_updater.h',
       'browser/page_load_metrics/metrics_navigation_throttle.cc',
       'browser/page_load_metrics/metrics_navigation_throttle.h',
       'browser/page_load_metrics/metrics_web_contents_observer.cc',
@@ -696,8 +695,6 @@
     ],
     # Android sources included regardless of android_java_ui.
     'chrome_browser_android_sources': [
-      'browser/gpu/gpu_driver_info_manager_android.cc',
-      'browser/gpu/gpu_driver_info_manager_android.h',
       'browser/media/protected_media_identifier_permission_context.cc',
       'browser/media/protected_media_identifier_permission_context.h',
     ],
@@ -1017,8 +1014,6 @@
       'browser/android/webapps/single_tab_mode_tab_helper.h',
       'browser/android/webapps/webapp_registry.cc',
       'browser/android/webapps/webapp_registry.h',
-      'browser/android/webapk/webapk_installer.cc',
-      'browser/android/webapk/webapk_installer.h',
       'browser/autofill/android/personal_data_manager_android.cc',
       'browser/autofill/android/personal_data_manager_android.h',
       'browser/dom_distiller/dom_distiller_service_factory_android.cc',
@@ -1315,8 +1310,6 @@
       'browser/first_run/upgrade_util_win.h',
       'browser/font_family_cache.cc',
       'browser/font_family_cache.h',
-      'browser/gpu/gl_string_manager.cc',
-      'browser/gpu/gl_string_manager.h',
       'browser/importer/external_process_importer_client.cc',
       'browser/importer/external_process_importer_client.h',
       'browser/importer/external_process_importer_host.cc',
@@ -2116,7 +2109,6 @@
       'android/java/src/org/chromium/chrome/browser/tab/TabWebContentsDelegateAndroid.java',
       'android/java/src/org/chromium/chrome/browser/tabmodel/SingleTabModel.java',
       'android/java/src/org/chromium/chrome/browser/tabmodel/TabModelJniBridge.java',
-      'android/java/src/org/chromium/chrome/browser/webapps/WebApkInstaller.java',
       'android/java/src/org/chromium/chrome/browser/TabState.java',
       'android/java/src/org/chromium/chrome/browser/TtsPlatformImpl.java',
       'android/java/src/org/chromium/chrome/browser/UsbChooserDialog.java',
@@ -3194,9 +3186,6 @@
       'browser/task_management/providers/web_contents/web_contents_tags_manager.h',
       'browser/task_management/providers/web_contents/web_contents_task_provider.cc',
       'browser/task_management/providers/web_contents/web_contents_task_provider.h',
-      'browser/task_management/sampling/shared_sampler.h',
-      'browser/task_management/sampling/shared_sampler_posix.cc',
-      'browser/task_management/sampling/shared_sampler_win.cc',
       'browser/task_management/sampling/task_group.cc',
       'browser/task_management/sampling/task_group.h',
       'browser/task_management/sampling/task_group_sampler.cc',
diff --git a/chrome/chrome_browser_ui.gypi b/chrome/chrome_browser_ui.gypi
index 23f3d83..6e6c0ad 100644
--- a/chrome/chrome_browser_ui.gypi
+++ b/chrome/chrome_browser_ui.gypi
@@ -615,8 +615,6 @@
       'browser/ui/ash/network_connect_delegate_chromeos.h',
       'browser/ui/ash/networking_config_delegate_chromeos.cc',
       'browser/ui/ash/networking_config_delegate_chromeos.h',
-      'browser/ui/ash/palette_delegate_chromeos.cc',
-      'browser/ui/ash/palette_delegate_chromeos.h',
       'browser/ui/ash/session_state_delegate_chromeos.cc',
       'browser/ui/ash/session_state_delegate_chromeos.h',
       'browser/ui/ash/session_util.cc',
@@ -2059,8 +2057,6 @@
       'browser/ui/webui/settings/chromeos/device_pointer_handler.h',
       'browser/ui/webui/settings/chromeos/easy_unlock_settings_handler.cc',
       'browser/ui/webui/settings/chromeos/easy_unlock_settings_handler.h',
-      'browser/ui/webui/settings/chromeos/internet_handler.cc',
-      'browser/ui/webui/settings/chromeos/internet_handler.h',
       'browser/ui/webui/settings/downloads_handler.cc',
       'browser/ui/webui/settings/downloads_handler.h',
       'browser/ui/webui/settings/font_handler.cc',
diff --git a/chrome/chrome_dll_bundle.gypi b/chrome/chrome_dll_bundle.gypi
index 827589e..5b49c21 100644
--- a/chrome/chrome_dll_bundle.gypi
+++ b/chrome/chrome_dll_bundle.gypi
@@ -59,6 +59,7 @@
     '<@(mac_all_xibs)',
     'browser/mac/install.sh',
     '<(SHARED_INTERMEDIATE_DIR)/repack/chrome_100_percent.pak',
+    '<(SHARED_INTERMEDIATE_DIR)/repack/chrome_material_100_percent.pak',
     '<(SHARED_INTERMEDIATE_DIR)/repack/resources.pak',
     '<!@pymod_do_main(repack_locales -o -p <(OS) -g <(grit_out_dir) -s <(SHARED_INTERMEDIATE_DIR) -x <(SHARED_INTERMEDIATE_DIR) <(locales))',
     # Note: pseudo_locales are generated via the packed_resources
@@ -244,6 +245,7 @@
     ['enable_hidpi==1', {
       'mac_bundle_resources': [
         '<(SHARED_INTERMEDIATE_DIR)/repack/chrome_200_percent.pak',
+        '<(SHARED_INTERMEDIATE_DIR)/repack/chrome_material_200_percent.pak',
       ],
     }],
     ['icu_use_data_file_flag==1', {
diff --git a/chrome/chrome_public_test_apk.isolate b/chrome/chrome_public_test_apk.isolate
new file mode 100644
index 0000000..b18a35a
--- /dev/null
+++ b/chrome/chrome_public_test_apk.isolate
@@ -0,0 +1,27 @@
+# Copyright 2015 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+
+{
+  'variables': {
+    'files': [
+      '<(DEPTH)/chrome/test/data/android/',
+      '<(DEPTH)/chrome/test/data/banners/',
+      '<(DEPTH)/chrome/test/data/encoding_tests/auto_detect/Big5_with_no_encoding_specified.html',
+      '<(DEPTH)/chrome/test/data/geolocation/',
+      '<(DEPTH)/chrome/test/data/google/',
+      '<(DEPTH)/chrome/test/data/image_search/valid.png',
+      '<(DEPTH)/chrome/test/data/navigation_interception/',
+      '<(DEPTH)/chrome/test/data/notifications/',
+      '<(DEPTH)/chrome/test/data/popup_blocker/',
+      '<(DEPTH)/chrome/test/data/push_messaging/',
+      '<(DEPTH)/chrome/test/data/translate/',
+      '<(DEPTH)/chrome/test/data/webapps/',
+      '<(DEPTH)/chrome/test/media_router/resources/',
+      '<(DEPTH)/content/test/data/android/geolocation.html',
+      '<(DEPTH)/content/test/data/media/getusermedia.html',
+      '<(DEPTH)/content/test/data/media/session/',
+      '<(DEPTH)/content/test/data/media/webrtc_test_utilities.js',
+    ],
+  },
+}
diff --git a/chrome/chrome_repack_chrome_material_100_percent.gypi b/chrome/chrome_repack_chrome_material_100_percent.gypi
new file mode 100644
index 0000000..0d4e9cb
--- /dev/null
+++ b/chrome/chrome_repack_chrome_material_100_percent.gypi
@@ -0,0 +1,14 @@
+# Copyright 2015 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+{
+  # GN version: //chrome:repack_chrome_material_100_percent
+  'action_name': 'repack_chrome_resources_material_100_percent',
+  'variables': {
+    'pak_inputs': [
+      '<(grit_out_dir)/theme_resources_material_100_percent.pak',
+    ],
+    'pak_output': '<(SHARED_INTERMEDIATE_DIR)/repack/chrome_material_100_percent.pak',
+  },
+  'includes': [ '../build/repack_action.gypi' ],
+}
diff --git a/chrome/chrome_repack_chrome_material_200_percent.gypi b/chrome/chrome_repack_chrome_material_200_percent.gypi
new file mode 100644
index 0000000..2ab1c3b
--- /dev/null
+++ b/chrome/chrome_repack_chrome_material_200_percent.gypi
@@ -0,0 +1,14 @@
+# Copyright 2015 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+{
+  # GN version: //chrome:repack_chrome_material_200_percent
+  'action_name': 'repack_chrome_resources_material_200_percent',
+  'variables': {
+    'pak_inputs': [
+      '<(grit_out_dir)/theme_resources_material_200_percent.pak',
+    ],
+    'pak_output': '<(SHARED_INTERMEDIATE_DIR)/repack/chrome_material_200_percent.pak',
+  },
+  'includes': [ '../build/repack_action.gypi' ],
+}
diff --git a/chrome/chrome_resources.gyp b/chrome/chrome_resources.gyp
index ba40b73..e1de779 100644
--- a/chrome/chrome_resources.gyp
+++ b/chrome/chrome_resources.gyp
@@ -567,6 +567,16 @@
              '<(DEPTH)/ui/app_list/resources/app_list_resources.gyp:app_list_resources',
           ],
         }],
+        ['OS == "mac"', {
+          'actions': [
+            {
+              'includes': ['chrome_repack_chrome_material_100_percent.gypi']
+            },
+            {
+              'includes': ['chrome_repack_chrome_material_200_percent.gypi']
+            },
+          ],
+        }],
         ['OS != "mac" and OS != "ios"', {
           # Copy pak files to the product directory. These files will be picked
           # up by the following installer scripts:
diff --git a/chrome/chrome_tests.gypi b/chrome/chrome_tests.gypi
index d7a0a7e..c4ddfc9 100644
--- a/chrome/chrome_tests.gypi
+++ b/chrome/chrome_tests.gypi
@@ -95,6 +95,7 @@
       'browser/browsing_data/history_counter_browsertest.cc',
       'browser/browsing_data/media_licenses_counter_browsertest.cc',
       'browser/browsing_data/passwords_counter_browsertest.cc',
+      'browser/chrome_browser_main_mac_browsertest.mm',
       'browser/chrome_content_browser_client_browsertest.cc',
       'browser/chrome_main_browsertest.cc',
       'browser/chrome_navigation_browsertest.cc',
diff --git a/chrome/chrome_tests_unit.gypi b/chrome/chrome_tests_unit.gypi
index 7e884f2..0190250 100644
--- a/chrome/chrome_tests_unit.gypi
+++ b/chrome/chrome_tests_unit.gypi
@@ -33,7 +33,6 @@
       'browser/android/preferences/pref_service_bridge_unittest.cc',
       'browser/android/shortcut_info_unittest.cc',
       'browser/android/thumbnail/scoped_ptr_expiring_cache_unittest.cc',
-      'browser/android/webapk/webapk_installer_unittest.cc',
       'browser/app_controller_mac_unittest.mm',
       'browser/autocomplete/search_provider_unittest.cc',
       'browser/autocomplete/shortcuts_provider_extension_unittest.cc',
diff --git a/chrome/common/chrome_switches.cc b/chrome/common/chrome_switches.cc
index 5267c37..c41e603 100644
--- a/chrome/common/chrome_switches.cc
+++ b/chrome/common/chrome_switches.cc
@@ -1106,9 +1106,6 @@ const char kTabManagementExperimentTypeDisabled[] =
     "tab-management-experiment-type-disabled";
 const char kTabManagementExperimentTypeElderberry[] =
     "tab-management-experiment-type-elderberry";
-
-// Custom WebAPK server URL for the sake of testing.
-const char kWebApkServerUrl[] = "webapk-server-url";
 #endif  // defined(OS_ANDROID)
 
 #if defined(OS_CHROMEOS)
diff --git a/chrome/common/chrome_switches.h b/chrome/common/chrome_switches.h
index 06999e1..b81ebbe 100644
--- a/chrome/common/chrome_switches.h
+++ b/chrome/common/chrome_switches.h
@@ -310,7 +310,6 @@ extern const char kTabManagementExperimentTypeChive[];
 extern const char kTabManagementExperimentTypeDill[];
 extern const char kTabManagementExperimentTypeDisabled[];
 extern const char kTabManagementExperimentTypeElderberry[];
-extern const char kWebApkServerUrl[];
 #endif  // defined(OS_ANDROID)
 
 #if defined(OS_CHROMEOS)
diff --git a/chrome/common/extensions/docs/examples/api/fontSettings/options.js b/chrome/common/extensions/docs/examples/api/fontSettings/options.js
index 6c57f16..c6c978d 100644
--- a/chrome/common/extensions/docs/examples/api/fontSettings/options.js
+++ b/chrome/common/extensions/docs/examples/api/fontSettings/options.js
@@ -218,7 +218,7 @@ advancedFonts.pendingChanges = new PendingChanges();
 advancedFonts.fontSettings = null;
 
 /**
- * Map from |fontSizeKey| to UI controls and data for its font size setting.
+ * Map from |fontSizeKey| to UI contols and data for its font size setting.
  */
 advancedFonts.fontSizeSettings = null;
 
diff --git a/chrome/common/pref_names.cc b/chrome/common/pref_names.cc
index e55a3fd..6c581ac 100644
--- a/chrome/common/pref_names.cc
+++ b/chrome/common/pref_names.cc
@@ -1215,15 +1215,6 @@ const char kLocalDiscoveryNotificationsEnabled[] =
 #if defined(OS_ANDROID)
 // Enable vibration for web notifications.
 const char kNotificationsVibrateEnabled[] = "notifications.vibrate_enabled";
-
-// Cached information about GPU driver.
-const char kGLExtensionsString[] = "gl_extensions_string";
-const char kGpuDriverInfoMaxSamples[] = "gpu_driver_info_max_samples";
-const char kGpuDriverInfoResetNotificationStrategy[] =
-    "gpu_driver_info_reset_notification_strategy";
-const char kGpuDriverInfoShaderVersion[] = "gpu_driver_info_shader_version";
-const char kGpuDriverInfoBuildFingerPrint[] =
-    "gpu_driver_info_build_finder_print";
 #endif
 
 // Maps from app ids to origin + Service Worker registration ID.
diff --git a/chrome/common/pref_names.h b/chrome/common/pref_names.h
index 4f95e3d..a11d462 100644
--- a/chrome/common/pref_names.h
+++ b/chrome/common/pref_names.h
@@ -439,14 +439,6 @@ extern const char kGLVendorString[];
 extern const char kGLRendererString[];
 extern const char kGLVersionString[];
 
-#if defined(OS_ANDROID)
-extern const char kGLExtensionsString[];
-extern const char kGpuDriverInfoMaxSamples[];
-extern const char kGpuDriverInfoResetNotificationStrategy[];
-extern const char kGpuDriverInfoShaderVersion[];
-extern const char kGpuDriverInfoBuildFingerPrint[];
-#endif
-
 // Android has it's own metric / crash reporting implemented in Android
 // Java code so kMetricsReportingEnabled doesn't make sense. We use this
 // to inform crashes_ui that we have enabled crash reporting.
diff --git a/chrome/installer/util/channel_info_unittest.cc b/chrome/installer/util/channel_info_unittest.cc
index 239f4a7..078ba49 100644
--- a/chrome/installer/util/channel_info_unittest.cc
+++ b/chrome/installer/util/channel_info_unittest.cc
@@ -237,43 +237,40 @@ TEST(ChannelInfoTest, GetStage) {
 }
 
 TEST(ChannelInfoTest, GetStatsDefault) {
-  struct {
-    const base::string16 base_value;
-    const base::string16& expected_channel;
-  } test_cases[] = {
-    {L"", kChannelStable},
-    {L"x64-stable", kChannelStable},
-    {L"1.1-beta", kChannelBeta},
-    {L"x64-beta", kChannelBeta},
-    {L"2.0-dev", kChannelDev},
-    {L"x64-dev", kChannelDev},
-  };
-  const base::string16 suffixes[] = {L"", L"-multi", L"-multi-chrome"};
-
-  for (const auto& test_case : test_cases) {
-    const base::string16& base_value = test_case.base_value;
-    const base::string16& expected_channel = test_case.expected_channel;
-
-    for (const auto& suffix : suffixes) {
-      ChannelInfo ci;
-      base::string16 channel;
-
-      ci.set_value(base_value + suffix);
-      EXPECT_EQ(L"", ci.GetStatsDefault());
-      ci.set_value(base_value + L"-statsdef" + suffix);
-      EXPECT_EQ(L"", ci.GetStatsDefault());
-      ci.set_value(base_value + L"-statsdef_" + suffix);
-      EXPECT_EQ(L"", ci.GetStatsDefault());
-      ci.set_value(base_value + L"-statsdef_0" + suffix);
-      EXPECT_EQ(L"0", ci.GetStatsDefault());
-      EXPECT_TRUE(ci.GetChannelName(&channel));
-      EXPECT_EQ(expected_channel, channel);
-      ci.set_value(base_value + L"-statsdef_1" + suffix);
-      EXPECT_EQ(L"1", ci.GetStatsDefault());
-      EXPECT_TRUE(ci.GetChannelName(&channel));
-      EXPECT_EQ(expected_channel, channel);
-    }
-  }
+  ChannelInfo ci;
+
+  ci.set_value(L"");
+  EXPECT_EQ(L"", ci.GetStatsDefault());
+  ci.set_value(L"-statsdef");
+  EXPECT_EQ(L"", ci.GetStatsDefault());
+  ci.set_value(L"-statsdef_");
+  EXPECT_EQ(L"", ci.GetStatsDefault());
+  ci.set_value(L"-statsdef_0");
+  EXPECT_EQ(L"0", ci.GetStatsDefault());
+  ci.set_value(L"-statsdef_1");
+  EXPECT_EQ(L"1", ci.GetStatsDefault());
+
+  ci.set_value(L"-multi");
+  EXPECT_EQ(L"", ci.GetStatsDefault());
+  ci.set_value(L"-statsdef-multi");
+  EXPECT_EQ(L"", ci.GetStatsDefault());
+  ci.set_value(L"-statsdef_-multi");
+  EXPECT_EQ(L"", ci.GetStatsDefault());
+  ci.set_value(L"-statsdef_0-multi");
+  EXPECT_EQ(L"0", ci.GetStatsDefault());
+  ci.set_value(L"-statsdef_1-multi");
+  EXPECT_EQ(L"1", ci.GetStatsDefault());
+
+  ci.set_value(L"2.0-beta-multi");
+  EXPECT_EQ(L"", ci.GetStatsDefault());
+  ci.set_value(L"2.0-beta-statsdef-multi");
+  EXPECT_EQ(L"", ci.GetStatsDefault());
+  ci.set_value(L"2.0-beta-statsdef_-multi");
+  EXPECT_EQ(L"", ci.GetStatsDefault());
+  ci.set_value(L"2.0-beta-statsdef_0-multi");
+  EXPECT_EQ(L"0", ci.GetStatsDefault());
+  ci.set_value(L"2.0-beta-statsdef_1-multi");
+  EXPECT_EQ(L"1", ci.GetStatsDefault());
 }
 
 TEST(ChannelInfoTest, SetStage) {
diff --git a/chrome/renderer/resources/plugins/blocked_plugin.html b/chrome/renderer/resources/plugins/blocked_plugin.html
index 72dbb1a..94313a1 100644
--- a/chrome/renderer/resources/plugins/blocked_plugin.html
+++ b/chrome/renderer/resources/plugins/blocked_plugin.html
@@ -1,34 +1,53 @@
 <!doctype html>
 <html>
-  <head>
-    <meta charset="utf-8">
-    <meta name="viewport" content="width=device-width, user-scalable=no">
-    <if expr="not is_android">
-      <script>
-        function setMessage(msg) {
-          document.getElementById('message').textContent = msg;
-        }
-        function notifyDidFinishLoading() {
-          if (plugin.didFinishLoading)
-            plugin.didFinishLoading();
+<head>
+<meta charset="utf-8">
+<meta name="viewport" content="width=device-width, user-scalable=no">
+<if expr="not is_android">
+<script>
+function setMessage(msg) {
+  document.getElementById('message').textContent = msg;
+}
+function notifyDidFinishLoading() {
+  if (plugin.didFinishLoading)
+    plugin.didFinishLoading();
 
-          if (plugin.didFinishIconRepositionForTesting)
-            plugin.didFinishIconRepositionForTesting();
-        }
-      </script>
-    </if>
-    <if expr="is_android">
-      <script>
-        function notifyDidFinishLoading() {}
-      </script>
-    </if>
-    <link rel="stylesheet" href="plugin_placeholders.css"></link>
-  </head>
-  <body id="t" onload="notifyDidFinishLoading();">
-    <div i18n-values="title:name" id="outer">
-      <img class="icon"
-           src="../../../../ui/webui/resources/images/extension.svg">
-      <h1 id="message" i18n-content="message"></h1>
-    </div>
-  </body>
+  if (plugin.didFinishIconRepositionForTesting)
+    plugin.didFinishIconRepositionForTesting();
+}
+</script>
+</if>
+<if expr="is_android">
+<script>
+function notifyDidFinishLoading() {}
+</script>
+</if>
+<link rel="stylesheet" href="plugin_placeholders.css"></link>
+<style>
+body {
+  background-color: rgb(187, 187, 187);
+}
+
+#plugin_icon {
+  opacity: .6;
+}
+</style>
+</head>
+
+<body id="t" onload="notifyDidFinishLoading();">
+<div i18n-values="title:name" id="outer">
+  <div id="inner">
+<if expr="not is_android">
+    <div><img id="plugin_icon" src="plugin_blocked.png"></div>
+</if>
+<if expr="is_android">
+    <img id="plugin_icon" src="plugin_blocked_android.png">
+</if>
+    <h1 id="message" i18n-content="message"></h1>
+  </div>
+  <div id="close" i18n-values="title:hide;data-plugin-type:pluginType"
+      onclick="plugin.hide();">
+  </div>
+</div>
+</body>
 </html>
diff --git a/chrome/renderer/resources/plugins/disabled_plugin.html b/chrome/renderer/resources/plugins/disabled_plugin.html
index 649b211..4fc035d 100644
--- a/chrome/renderer/resources/plugins/disabled_plugin.html
+++ b/chrome/renderer/resources/plugins/disabled_plugin.html
@@ -1,30 +1,44 @@
 <!doctype html>
 <html>
-  <head>
-    <meta charset="utf-8">
-    <meta name="viewport" content="width=device-width, user-scalable=no">
-    <script>
-      function insertLink() {
-        // Replace the chrome://plugins text with a working link (i18n_template
-        // doesn't allow raw HTML in template data).
-        var link = document.getElementById("enable_link");
-        var link_html = link.innerHTML;
-        link.parentNode.removeChild(link);
-        var message = document.getElementById("message");
-        var message_html = message.innerHTML;
-        message.innerHTML = message_html.replace('chrome://plugins', link_html);
-      }
-    </script>
-    <link rel="stylesheet" href="plugin_placeholders.css"></link>
-  </head>
-  <body id="t" onLoad="insertLink()">
-    <div i18n-values="title:name" id="outer">
-      <img class="icon"
-           src="../../../../ui/webui/resources/images/extension.svg">
-      <h1 id="message" i18n-content="message"></h1>
-      <div id="enable_link">
-        <a href="#" onclick="plugin.openAboutPlugins();">chrome://plugins</a>
-      </div>
+<head>
+<meta charset="utf-8">
+<meta name="viewport" content="width=device-width, user-scalable=no">
+<script>
+function insertLink() {
+  // Replace the chrome://plugins text with a working link (i18n_template
+  // doesn't allow raw HTML in template data).
+  var link = document.getElementById("enable_link");
+  var link_html = link.innerHTML;
+  link.parentNode.removeChild(link);
+  var message = document.getElementById("message");
+  var message_html = message.innerHTML;
+  message.innerHTML = message_html.replace('chrome://plugins', link_html);
+}
+</script>
+<link rel="stylesheet" href="plugin_placeholders.css"></link>
+<style>
+body {
+  background-color: rgb(187, 187, 187);
+}
+
+#plugin_icon {
+  opacity: .6;
+}
+</style>
+</head>
+
+<body id="t" onLoad="insertLink()">
+<div i18n-values="title:name" id="outer">
+  <div id="inner">
+    <div><img id="plugin_icon" src="plugin_blocked.png" /></div>
+    <h1 id="message" i18n-content="message"></h1>
+    <div id="enable_link">
+      <a href="#" onclick="plugin.openAboutPlugins();">chrome://plugins</a>
     </div>
-  </body>
+  </div>
+  <div id="close" i18n-values="title:hide;data-plugin-type:pluginType"
+      onclick="plugin.hide();">
+  </div>
+</div>
+</body>
 </html>
diff --git a/chrome/renderer/resources/plugins/plugin_blocked.png b/chrome/renderer/resources/plugins/plugin_blocked.png
new file mode 100644
index 0000000..07a516a
Binary files /dev/null and b/chrome/renderer/resources/plugins/plugin_blocked.png differ
diff --git a/chrome/renderer/resources/plugins/plugin_blocked_android.png b/chrome/renderer/resources/plugins/plugin_blocked_android.png
new file mode 100644
index 0000000..fbf6b41
Binary files /dev/null and b/chrome/renderer/resources/plugins/plugin_blocked_android.png differ
diff --git a/chrome/renderer/resources/plugins/plugin_placeholders.css b/chrome/renderer/resources/plugins/plugin_placeholders.css
index 09ea3ee..345ef67 100644
--- a/chrome/renderer/resources/plugins/plugin_placeholders.css
+++ b/chrome/renderer/resources/plugins/plugin_placeholders.css
@@ -13,10 +13,16 @@ html, body {
 }
 
 h1 {
-  display: none;
   font-size: 10pt;
   font-weight: normal;
   padding: 0pt 10pt;
+<if expr="not is_android and not chromeos">
+  visibility: hidden;
+</if>
+}
+
+#outer:hover h1, #outer:hover #close {
+  visibility: visible;
 }
 
 p {
@@ -24,50 +30,46 @@ p {
   padding: 0pt 14pt;
 }
 
-#t {
-  background-color: #f7f7f7;
-  color: #646464;
-}
-
 #outer {
   align-items: center;
+  border: 1px black solid;
   box-sizing: border-box;
   display: flex;
   height: 100%;
   justify-content: center;
   position: absolute;
   width: 100%;
-  flex-direction: column;
 }
 
-.icon {
-  max-height: 100%;
-  max-width: 100%;
-  opacity: .3;
+#close {
+  background-image: -webkit-image-set(
+      url(../../../../ui/resources/default_100_percent/close_2.png) 1x,
+      url(../../../../ui/resources/default_200_percent/close_2.png) 2x);
+  background-position: right top;
+  background-repeat: no-repeat;
+  cursor: pointer;
+  height: 14px;
+  position: absolute;
+  right: 3px;
+  top: 3px;
+<if expr="not is_android">
+  visibility: hidden;
+</if>
+  width: 14px;
+}
+
+#close[data-plugin-type='document'] {
+  display: none;
 }
 
-@media (orientation: landscape) and (min-height: 2em) and (min-width: 14em) {
-  #outer {
-    flex-direction: row;
-  }
-  .icon {
-    max-height: 100%;
-    max-width: 50%;
-  }
-  h1 {
-    display: block;
-  }
+#close:hover {
+  background-image: -webkit-image-set(
+      url(../../../../ui/resources/default_100_percent/close_2_hover.png) 1x,
+      url(../../../../ui/resources/default_200_percent/close_2_hover.png) 2x);
 }
 
-@media (min-height: 7em) and (min-width: 6em) {
-  #outer {
-    flex-direction: column;
-  }
-  .icon {
-    max-height: 50%;
-    max-width: 100%;
-  }
-  h1 {
-    display: block;
-  }
+#close:active {
+  background-image: -webkit-image-set(
+      url(../../../../ui/resources/default_100_percent/close_2_pressed.png) 1x,
+      url(../../../../ui/resources/default_200_percent/close_2_pressed.png) 2x);
 }
diff --git a/chrome/renderer/resources/plugins/plugin_poster.html b/chrome/renderer/resources/plugins/plugin_poster.html
index 085c960..5448b2c 100644
--- a/chrome/renderer/resources/plugins/plugin_poster.html
+++ b/chrome/renderer/resources/plugins/plugin_poster.html
@@ -20,7 +20,6 @@
 <style>
 #outer {
   border: none;
-  flex-direction: row;
   cursor: pointer;
 }
 
diff --git a/chrome/test/BUILD.gn b/chrome/test/BUILD.gn
index b1c07cc..1e99e3a 100644
--- a/chrome/test/BUILD.gn
+++ b/chrome/test/BUILD.gn
@@ -929,6 +929,12 @@ test("browser_tests") {
   if (is_win) {
     data += [ "$root_out_dir/chrome_200_percent.pak" ]
   }
+  if (is_mac) {
+    data += [
+      "$root_out_dir/chrome_material_100_percent.pak",
+      "$root_out_dir/chrome_material_200_percent.pak",
+    ]
+  }
   if (is_chromeos) {
     data += [
       # TODO(GYP): figure out which of these things are
@@ -2144,8 +2150,8 @@ test("unit_tests") {
     sources +=
         [ "../browser/password_manager/native_backend_gnome_x_unittest.cc" ]
     configs += [
-      "//components/os_crypt:gnome_keyring",
-      "//components/os_crypt:gnome_keyring_direct",
+      "//chrome/browser:gnome_keyring",
+      "//chrome/browser:gnome_keyring_direct",
     ]
   }
   if (is_linux && !is_chromeos) {
diff --git a/chrome/test/android/javatests/src/org/chromium/chrome/test/util/ChromeTabUtils.java b/chrome/test/android/javatests/src/org/chromium/chrome/test/util/ChromeTabUtils.java
index f974901..3db694c 100644
--- a/chrome/test/android/javatests/src/org/chromium/chrome/test/util/ChromeTabUtils.java
+++ b/chrome/test/android/javatests/src/org/chromium/chrome/test/util/ChromeTabUtils.java
@@ -7,10 +7,10 @@ package org.chromium.chrome.test.util;
 import android.app.Instrumentation;
 import android.test.InstrumentationTestCase;
 import android.text.TextUtils;
+import android.util.Log;
 
 import junit.framework.Assert;
 
-import org.chromium.base.Log;
 import org.chromium.base.ThreadUtils;
 import org.chromium.chrome.R;
 import org.chromium.chrome.browser.ChromeActivity;
@@ -28,10 +28,8 @@ import org.chromium.chrome.browser.tabmodel.TabModelSelector;
 import org.chromium.chrome.browser.tabmodel.TabModelUtils;
 import org.chromium.chrome.test.ChromeTabbedActivityTestBase;
 import org.chromium.content.browser.test.util.CallbackHelper;
-import org.chromium.content_public.browser.LoadUrlParams;
 import org.chromium.ui.base.DeviceFormFactor;
 
-import java.util.List;
 import java.util.concurrent.Callable;
 import java.util.concurrent.TimeUnit;
 import java.util.concurrent.TimeoutException;
@@ -217,28 +215,17 @@ public class ChromeTabUtils {
     }
 
     /**
-     * Creates a new tab by invoking the 'New Tab' menu item.
+     * New a tab by invoking the 'New Tab' menu item.
      * <p>
      * Returns when the tab has been created and has finished navigating.
      */
     public static void newTabFromMenu(Instrumentation instrumentation,
             final ChromeTabbedActivity activity)
             throws InterruptedException {
-        newTabFromMenu(instrumentation, activity, false, true);
-    }
-
-    /**
-     * Creates a new tab by invoking the 'New Tab' or 'New Incognito Tab' menu item.
-     * <p>
-     * Returns when the tab has been created and has finished navigating.
-     */
-    public static void newTabFromMenu(Instrumentation instrumentation,
-            final ChromeTabbedActivity activity, boolean incognito, boolean waitForNtpLoad)
-            throws InterruptedException {
         final CallbackHelper createdCallback = new CallbackHelper();
         final CallbackHelper selectedCallback = new CallbackHelper();
 
-        TabModel tabModel = activity.getTabModelSelector().getModel(incognito);
+        TabModel tabModel = activity.getTabModelSelector().getModel(false);
         TabModelObserver observer = new EmptyTabModelObserver() {
             @Override
             public void didAddTab(Tab tab, TabLaunchType type) {
@@ -253,7 +240,7 @@ public class ChromeTabUtils {
         tabModel.addObserver(observer);
 
         MenuUtils.invokeCustomMenuActionSync(instrumentation, activity,
-                incognito ? R.id.new_incognito_tab_menu_id : R.id.new_tab_menu_id);
+                R.id.new_tab_menu_id);
 
         try {
             createdCallback.waitForCallback(0);
@@ -269,7 +256,7 @@ public class ChromeTabUtils {
 
         Tab tab = activity.getActivityTab();
         waitForTabPageLoaded(tab, (String) null);
-        if (waitForNtpLoad) NewTabPageTestUtils.waitForNtpLoaded(tab);
+        NewTabPageTestUtils.waitForNtpLoaded(tab);
         instrumentation.waitForIdleSync();
         Log.d(TAG, "newTabFromMenu <<");
     }
@@ -288,35 +275,6 @@ public class ChromeTabUtils {
     }
 
     /**
-     * Creates a new tab in the specified model then waits for it to load.
-     * <p>
-     * Returns when the tab has been created and finishes loading.
-     */
-    public static void fullyLoadUrlInNewTab(Instrumentation instrumentation,
-            final ChromeTabbedActivity activity, final String url, final boolean incognito)
-            throws InterruptedException {
-        newTabFromMenu(instrumentation, activity, incognito, false);
-
-        final Tab tab = activity.getActivityTab();
-        waitForTabPageLoaded(tab, new Runnable(){
-            @Override
-            public void run() {
-                loadUrlOnUiThread(tab, url);
-            }
-        });
-        instrumentation.waitForIdleSync();
-    }
-
-    private static void loadUrlOnUiThread(final Tab tab, final String url) {
-        ThreadUtils.runOnUiThreadBlocking(new Runnable() {
-            @Override
-            public void run() {
-                tab.loadUrl(new LoadUrlParams(url));
-            }
-        });
-    }
-
-    /**
      * Ensure that at least some given number of tabs are open.
      */
     public static void ensureNumOpenTabs(Instrumentation instrumentation,
@@ -404,52 +362,6 @@ public class ChromeTabUtils {
     }
 
     /**
-     * Close all tabs and waits for all tabs pending closure to be observed.
-     */
-    public static void closeAllTabs(Instrumentation instrumentation,
-            final ChromeTabbedActivity activity) throws InterruptedException {
-        final CallbackHelper closeCallback = new CallbackHelper();
-        final TabModelObserver observer = new EmptyTabModelObserver() {
-            @Override
-            public void allTabsPendingClosure(List<Integer> tabIds) {
-                closeCallback.notifyCalled();
-            }
-        };
-        instrumentation.runOnMainSync(new Runnable() {
-            @Override
-            public void run() {
-                TabModelSelector selector = activity.getTabModelSelector();
-                for (TabModel tabModel : selector.getModels()) {
-                    tabModel.addObserver(observer);
-                }
-            }
-        });
-
-        ThreadUtils.runOnUiThreadBlocking(new Runnable() {
-            @Override
-            public void run() {
-                activity.getTabModelSelector().closeAllTabs();
-            }
-        });
-
-        try {
-            closeCallback.waitForCallback(0);
-        } catch (TimeoutException e) {
-            Assert.fail("All tabs pending closure event was never received");
-        }
-        instrumentation.runOnMainSync(new Runnable() {
-            @Override
-            public void run() {
-                TabModelSelector selector = activity.getTabModelSelector();
-                for (TabModel tabModel : selector.getModels()) {
-                    tabModel.removeObserver(observer);
-                }
-            }
-        });
-        instrumentation.waitForIdleSync();
-    }
-
-    /**
      * Selects a tab with the given action and waits for the selection event to be observed.
      */
     public static void selectTabWithAction(Instrumentation instrumentation,
diff --git a/chrome/test/base/testing_browser_process.cc b/chrome/test/base/testing_browser_process.cc
index 843c65a..609bdd5 100644
--- a/chrome/test/base/testing_browser_process.cc
+++ b/chrome/test/base/testing_browser_process.cc
@@ -168,7 +168,7 @@ IconManager* TestingBrowserProcess::icon_manager() {
   return nullptr;
 }
 
-GpuProfileCache* TestingBrowserProcess::gpu_profile_cache() {
+GLStringManager* TestingBrowserProcess::gl_string_manager() {
   return nullptr;
 }
 
diff --git a/chrome/test/base/testing_browser_process.h b/chrome/test/base/testing_browser_process.h
index f56401a..043eaaa 100644
--- a/chrome/test/base/testing_browser_process.h
+++ b/chrome/test/base/testing_browser_process.h
@@ -73,7 +73,7 @@ class TestingBrowserProcess : public BrowserProcess {
   policy::BrowserPolicyConnector* browser_policy_connector() override;
   policy::PolicyService* policy_service() override;
   IconManager* icon_manager() override;
-  GpuProfileCache* gpu_profile_cache() override;
+  GLStringManager* gl_string_manager() override;
   GpuModeManager* gpu_mode_manager() override;
   BackgroundModeManager* background_mode_manager() override;
   void set_background_mode_manager_for_test(
diff --git a/chrome/test/base/testing_profile.cc b/chrome/test/base/testing_profile.cc
index eadc236..8d46b49 100644
--- a/chrome/test/base/testing_profile.cc
+++ b/chrome/test/base/testing_profile.cc
@@ -229,8 +229,7 @@ std::unique_ptr<KeyedService> BuildBookmarkModel(
 }
 
 void TestProfileErrorCallback(WebDataServiceWrapper::ErrorType error_type,
-                              sql::InitStatus status,
-                              const std::string& diagnostics) {
+                              sql::InitStatus status) {
   NOTREACHED();
 }
 
diff --git a/chrome/test/chromedriver/chrome/frame_tracker.cc b/chrome/test/chromedriver/chrome/frame_tracker.cc
index 4bcdfb7..a899d1c 100644
--- a/chrome/test/chromedriver/chrome/frame_tracker.cc
+++ b/chrome/test/chromedriver/chrome/frame_tracker.cc
@@ -49,48 +49,30 @@ Status FrameTracker::OnEvent(DevToolsClient* client,
 
     int context_id;
     std::string frame_id;
-    bool is_default = true;
-
-    if (!context->GetInteger("id", &context_id)) {
+    if (!context->GetInteger("id", &context_id) ||
+        !context->GetString("frameId", &frame_id)) {
       std::string json;
       base::JSONWriter::Write(*context, &json);
       return Status(kUnknownError, method + " has invalid 'context': " + json);
     }
 
-    if (context->HasKey("auxData")) {
-      const base::DictionaryValue* auxData;
-      if (!context->GetDictionary("auxData", &auxData))
-        return Status(kUnknownError, method + " has invalid 'auxData' value");
-      if (!auxData->GetBoolean("isDefault", &is_default))
-        return Status(kUnknownError, method + " has invalid 'isDefault' value");
-      if (!auxData->GetString("frameId", &frame_id))
-        return Status(kUnknownError, method + " has invalid 'frameId' value");
-    }
-
     if (context->HasKey("isDefault")) {
-      // TODO(samuong): remove this when we stop supporting Chrome 53.
+      bool is_default = false;
       if (!context->GetBoolean("isDefault", &is_default))
         return Status(kUnknownError, method + " has invalid 'isDefault' value");
-    }
-
-    if (context->HasKey("frameId")) {
-      // TODO(samuong): remove this when we stop supporting Chrome 53.
-      if (!context->GetString("frameId", &frame_id))
-        return Status(kUnknownError, method + " has invalid 'frameId' value");
-    }
-
-    if (context->HasKey("type")) {
+      if (is_default)
+        frame_to_context_map_[frame_id] = context_id;
+    } else {
       // Before crrev.com/381172, the optional |type| field can be used to
       // determine whether we're looking at the default context.
       // TODO(samuong): remove this when we stop supporting Chrome 50.
       std::string type;
-      if (!context->GetString("type", &type))
+      if (context->HasKey("type") && !context->GetString("type", &type))
         return Status(kUnknownError, method + " has invalid 'context.type'");
-      is_default = type != "Extension";  // exclude content scripts
+      if (type != "Extension")  // exclude content scripts
+        frame_to_context_map_[frame_id] = context_id;
     }
 
-    if (is_default && !frame_id.empty())
-      frame_to_context_map_[frame_id] = context_id;
   } else if (method == "Runtime.executionContextDestroyed") {
     int execution_context_id;
     if (!params.GetInteger("executionContextId", &execution_context_id))
diff --git a/chrome/test/chromedriver/chrome/frame_tracker_unittest.cc b/chrome/test/chromedriver/chrome/frame_tracker_unittest.cc
index d5cce7d..8fc33e7 100644
--- a/chrome/test/chromedriver/chrome/frame_tracker_unittest.cc
+++ b/chrome/test/chromedriver/chrome/frame_tracker_unittest.cc
@@ -42,28 +42,6 @@ TEST(FrameTracker, GetContextIdForFrame) {
             tracker.GetContextIdForFrame("f", &context_id).code());
 }
 
-TEST(FrameTracker, AuxData) {
-  StubDevToolsClient client;
-  FrameTracker tracker(&client);
-  int context_id = -1;
-  ASSERT_TRUE(tracker.GetContextIdForFrame("f", &context_id).IsError());
-  ASSERT_EQ(-1, context_id);
-
-  const char context[] = "{\"id\":100,\"auxData\":{}}";
-  base::DictionaryValue params;
-  params.Set("context", base::JSONReader::Read(context));
-  params.SetString("context.auxData.frameId", "f");
-  params.SetBoolean("context.auxData.isDefault", true);
-  ASSERT_EQ(kOk,
-            tracker.OnEvent(&client, "Runtime.executionContextCreated", params)
-                .code());
-  ASSERT_EQ(kNoSuchExecutionContext,
-            tracker.GetContextIdForFrame("foo", &context_id).code());
-  ASSERT_EQ(-1, context_id);
-  ASSERT_TRUE(tracker.GetContextIdForFrame("f", &context_id).IsOk());
-  ASSERT_EQ(100, context_id);
-}
-
 TEST(FrameTracker, CanUpdateFrameContextId) {
   StubDevToolsClient client;
   FrameTracker tracker(&client);
diff --git a/chrome/test/chromedriver/chrome/navigation_tracker.cc b/chrome/test/chromedriver/chrome/navigation_tracker.cc
index 2089f98..351f881 100644
--- a/chrome/test/chromedriver/chrome/navigation_tracker.cc
+++ b/chrome/test/chromedriver/chrome/navigation_tracker.cc
@@ -329,11 +329,8 @@ Status NavigationTracker::OnEvent(DevToolsClient* client,
       if (!params.GetInteger("context.id", &execution_context_id))
         return Status(kUnknownError, "missing or invalid 'context.id'");
       std::string frame_id;
-      if (!params.GetString("context.auxData.frameId", &frame_id)) {
-        // TODO(samuong): remove this when we stop supporting Chrome 53.
-        if (!params.GetString("context.frameId", &frame_id))
-          return Status(kUnknownError, "missing or invalid 'context.frameId'");
-      }
+      if (!params.GetString("context.frameId", &frame_id))
+        return Status(kUnknownError, "missing or invalid 'context.frameId'");
       if (frame_id == dummy_frame_id_)
         dummy_execution_context_id_ = execution_context_id;
       else
diff --git a/chrome/test/chromedriver/chrome_launcher.cc b/chrome/test/chromedriver/chrome_launcher.cc
index 1a74e44..9470a32 100644
--- a/chrome/test/chromedriver/chrome_launcher.cc
+++ b/chrome/test/chromedriver/chrome_launcher.cc
@@ -204,29 +204,13 @@ Status WaitForDevToolsAndCheckVersion(
   if (status.IsError())
     return status;
 
-  const BrowserInfo* browser_info = client->browser_info();
-  if (browser_info->is_android &&
-      browser_info->android_package != capabilities->android_package) {
-    // DevTools from Chrome 30 and earlier did not provide an Android-Package
-    // key, so skip the package check for WebView on KitKat and older.
-    // TODO(samuong): Make this unconditional once we stop supporting Android
-    // KitKat WebView apps.
-    if (!(browser_info->browser_name == "webview" &&
-          browser_info->major_version <= 30 &&
-          browser_info->android_package.empty())) {
-      return Status(
-          kSessionNotCreatedException,
-          base::StringPrintf("please close '%s' and try again",
-                             browser_info->android_package.c_str()));
-    }
-  }
-
   base::CommandLine* cmd_line = base::CommandLine::ForCurrentProcess();
   if (cmd_line->HasSwitch("disable-build-check")) {
     LOG(WARNING) << "You are using an unsupported command-line switch: "
                     "--disable-build-check. Please don't report bugs that "
                     "cannot be reproduced with this switch removed.";
-  } else if (browser_info->build_no < kMinimumSupportedChromeBuildNo) {
+  } else if (client->browser_info()->build_no <
+             kMinimumSupportedChromeBuildNo) {
     return Status(kUnknownError, "Chrome version must be >= " +
         GetMinimumSupportedChromeVersion());
   }
@@ -511,6 +495,23 @@ Status LaunchAndroidChrome(
     return status;
   }
 
+  const BrowserInfo* browser_info = devtools_http_client->browser_info();
+  if (browser_info->android_package != capabilities.android_package) {
+    // DevTools from Chrome 30 and earlier did not provide an Android-Package
+    // key, so skip the package check for WebView on KitKat and older.
+    // TODO(samuong): Make this unconditional once we stop supporting Android
+    // KitKat WebView apps.
+    if (!(browser_info->browser_name == "webview" &&
+          browser_info->major_version <= 30 &&
+          browser_info->android_package.empty())) {
+      device->TearDown();
+      return Status(
+          kSessionNotCreatedException,
+          base::StringPrintf("please close '%s' and try again",
+                             browser_info->android_package.c_str()));
+    }
+  }
+
   std::unique_ptr<DevToolsClient> devtools_websocket_client;
   status = CreateBrowserwideDevToolsClientAndConnect(
       NetAddress(port), capabilities.perf_logging_prefs, socket_factory,
diff --git a/chrome/test/data/android/payments/metrics.js b/chrome/test/data/android/payments/metrics.js
deleted file mode 100644
index 3f12883..0000000
--- a/chrome/test/data/android/payments/metrics.js
+++ /dev/null
@@ -1,129 +0,0 @@
-/*
- * Copyright 2016 The Chromium Authors. All rights reserved.
- * Use of this source code is governed by a BSD-style license that can be
- * found in the LICENSE file.
- */
-
-/* global PaymentRequest:false */
-/* global toDictionary:false */
-
-var request;
-
-/**
- * Launches the PaymentRequest UI that accepts credit cards.
- */
-function buy() {  // eslint-disable-line no-unused-vars
-  try {
-    request = new PaymentRequest(
-        [{supportedMethods: ['visa']}], {
-          total: {label: 'Total', amount: {currency: 'USD', value: '5.00'}},
-          shippingOptions: [{
-            id: 'freeShippingOption',
-            label: 'Free global shipping',
-            amount: {currency: 'USD', value: '0'},
-            selected: true
-          }]
-        },
-        {requestShipping: true});
-    request.show()
-        .then(function(resp) {
-          return resp.complete('success')
-        }).then(function() {
-          print(
-              resp.shippingOption + '<br>' +
-              JSON.stringify(
-                  toDictionary(resp.shippingAddress), undefined, 2) +
-                  '<br>' + resp.methodName + '<br>' +
-                  JSON.stringify(resp.details, undefined, 2));
-        }).catch(function(error) {
-          print(error);
-        });
-  } catch (error) {
-    print(error.message);
-  }
-}
-
-/**
- * Launches the PaymentRequest UI which accepts a supported payment method but
- * does not accept credit cards.
- */
-function noMatching() {  // eslint-disable-line no-unused-vars
-  try {
-    request = new PaymentRequest(
-        [{supportedMethods: ['https://bobpay.com']}], {
-          total: {label: 'Total', amount: {currency: 'USD', value: '5.00'}},
-          shippingOptions: [{
-            id: 'freeShippingOption',
-            label: 'Free global shipping',
-            amount: {currency: 'USD', value: '0'},
-            selected: true
-          }]
-        },
-        {requestShipping: true});
-    request.show()
-        .then(function(resp) {
-          return resp.complete('success');
-        }).then(function() {
-          print(
-              resp.shippingOption + '<br>' +
-              JSON.stringify(
-                  toDictionary(resp.shippingAddress), undefined, 2) +
-              '<br>' + resp.methodName + '<br>' +
-              JSON.stringify(resp.details, undefined, 2));
-        }).catch(function(error) {
-          print(error);
-        });
-  } catch (error) {
-    print(error.message);
-  }
-}
-
-/**
- * Launches the PaymentRequest UI which accepts only an unsupported payment
- * method.
- */
-function noSupported() {  // eslint-disable-line no-unused-vars
-  try {
-    request = new PaymentRequest(
-        [{supportedMethods: ['https://randompay.com']}], {
-          total: {label: 'Total', amount: {currency: 'USD', value: '5.00'}},
-          shippingOptions: [{
-            id: 'freeShippingOption',
-            label: 'Free global shipping',
-            amount: {currency: 'USD', value: '0'},
-            selected: true
-          }]
-        },
-        {requestShipping: true});
-    request.show()
-        .then(function(resp) {
-          return resp.complete('success');
-        }).then(function() {
-          print(
-              resp.shippingOption + '<br>' +
-              JSON.stringify(
-                  toDictionary(resp.shippingAddress), undefined, 2) +
-              '<br>' + resp.methodName + '<br>' +
-              JSON.stringify(resp.details, undefined, 2));
-        }).catch(function(error) {
-          print(error);
-        });
-  } catch (error) {
-    print(error.message);
-  }
-}
-
-/**
- * Aborts the current PaymentRequest.
- */
-function abort() {  // eslint-disable-line no-unused-vars
-  try {
-    request.abort().then(function() {
-      print('Aborted');
-    }).catch(function() {
-      print('Cannot abort');
-    });
-  } catch (error) {
-    print(error.message);
-  }
-}
\ No newline at end of file
diff --git a/chrome/test/data/android/payments/payment_request_metrics_test.html b/chrome/test/data/android/payments/payment_request_metrics_test.html
deleted file mode 100644
index 00f6ea7..0000000
--- a/chrome/test/data/android/payments/payment_request_metrics_test.html
+++ /dev/null
@@ -1,22 +0,0 @@
-<!DOCTYPE html>
-<!--
-Copyright 2016 The Chromium Authors. All rights reserved.
-Use of this source code is governed by a BSD-style license that can be
-found in the LICENSE file.
--->
-<html>
-<head>
-<title>Metrics Test</title>
-<meta charset="utf-8">
-<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
-</head>
-<body>
-<button onclick="buy()" id="buy">Metrics Test</button><br>
-<button onclick="noMatching()" id="noMatching">No Matching Method Test</button><br>
-<button onclick="noSupported()" id="noSupported">No Supported Method Test</button><br>
-<button onclick="abort()" id="abort">Abort</button>
-<pre id="result"></pre>
-<script src="util.js"></script>
-<script src="metrics.js"></script>
-</body>
-</html>
diff --git a/chrome/test/data/webui/settings/basic_page_browsertest.js b/chrome/test/data/webui/settings/basic_page_browsertest.js
index 78715fc..4a9c9fe 100644
--- a/chrome/test/data/webui/settings/basic_page_browsertest.js
+++ b/chrome/test/data/webui/settings/basic_page_browsertest.js
@@ -56,12 +56,16 @@ TEST_F('SettingsBasicPageBrowserTest', 'MAYBE_Load', function() {
     // failing to find its host element.
     test('scroll to section', function() {
       // Setting the page and section will cause a scrollToSection_.
-      settings.navigateTo(settings.Route.ON_STARTUP);
+      self.getPage('basic').currentRoute = {
+        page: 'basic',
+        section: 'onStartup',
+        subpage: [],
+      };
 
       return new Promise(function(resolve, reject) {
         var intervalId = window.setInterval(function() {
           var page = self.getPage('basic');
-          if (self.getSection(page, settings.getCurrentRoute().section)) {
+          if (self.getSection(page, page.currentRoute.section)) {
             window.clearInterval(intervalId);
             resolve();
           }
diff --git a/chrome/test/data/webui/settings/device_page_tests.js b/chrome/test/data/webui/settings/device_page_tests.js
index 93ed9f4..bb77b3a 100644
--- a/chrome/test/data/webui/settings/device_page_tests.js
+++ b/chrome/test/data/webui/settings/device_page_tests.js
@@ -142,6 +142,12 @@ cr.define('device_page_tests', function() {
     suiteSetup(function() {
       // Disable animations so sub-pages open within one event loop.
       testing.Test.disableAnimationsAndTransitions();
+
+      // Update the device page route for navigations.
+      // TODO(tommycli): Remove once settings.navigateTo is no longer a stub.
+      settings.navigateTo = function(route) {
+        devicePage.currentRoute = route;
+      };
     });
 
     setup(function(done) {
@@ -150,6 +156,7 @@ cr.define('device_page_tests', function() {
 
       PolymerTest.clearBody();
       devicePage = document.createElement('settings-device-page');
+      devicePage.currentRoute = settings.Route.BASIC;
       devicePage.prefs = getFakePrefs();
       settings.DevicePageBrowserProxyImpl.instance_ =
           new TestDevicePageBrowserProxy();
@@ -171,8 +178,8 @@ cr.define('device_page_tests', function() {
         devicePage.$.pages.addEventListener('neon-animation-finish', resolve);
         MockInteractions.tap(row);
       }).then(function() {
-        assertEquals('device', settings.getCurrentRoute().section);
-        assertEquals(subpage, settings.getCurrentRoute().subpage[0]);
+        assertEquals('device', devicePage.currentRoute.section);
+        assertEquals(subpage, devicePage.currentRoute.subpage[0]);
         var page = devicePage.$$('#' + subpage + ' settings-' + subpage);
         return assert(page);
       });
@@ -219,15 +226,15 @@ cr.define('device_page_tests', function() {
       });
 
       test('subpage responds to pointer attach/detach', function() {
-        assertEquals('pointers', settings.getCurrentRoute().subpage[0]);
-        assertTrue(settings.getCurrentRoute() == settings.Route.POINTERS);
+        assertEquals('pointers', devicePage.currentRoute.subpage[0]);
+        assertTrue(devicePage.currentRoute == settings.Route.POINTERS);
         assertLT(0, pointersPage.$.mouse.offsetHeight);
         assertLT(0, pointersPage.$.touchpad.offsetHeight);
         assertLT(0, pointersPage.$$('#mouse h2').offsetHeight);
         assertLT(0, pointersPage.$$('#touchpad h2').offsetHeight);
 
         cr.webUIListenerCallback('has-touchpad-changed', false);
-        assertEquals('pointers', settings.getCurrentRoute().subpage[0]);
+        assertEquals('pointers', devicePage.currentRoute.subpage[0]);
         assertLT(0, pointersPage.$.mouse.offsetHeight);
         assertEquals(0, pointersPage.$.touchpad.offsetHeight);
         assertEquals(0, pointersPage.$$('#mouse h2').offsetHeight);
@@ -239,7 +246,7 @@ cr.define('device_page_tests', function() {
 
           cr.webUIListenerCallback('has-mouse-changed', false);
         }).then(function() {
-          assertEquals(0, settings.getCurrentRoute().subpage.length);
+          assertEquals(0, devicePage.currentRoute.subpage.length);
           assertEquals(0, devicePage.$$('#main #pointersRow').offsetHeight);
 
           cr.webUIListenerCallback('has-touchpad-changed', true);
@@ -252,7 +259,7 @@ cr.define('device_page_tests', function() {
           assertEquals(0, pointersPage.$$('#touchpad h2').offsetHeight);
 
           cr.webUIListenerCallback('has-mouse-changed', true);
-          assertEquals('pointers', settings.getCurrentRoute().subpage[0]);
+          assertEquals('pointers', devicePage.currentRoute.subpage[0]);
           assertLT(0, pointersPage.$.mouse.offsetHeight);
           assertLT(0, pointersPage.$.touchpad.offsetHeight);
           assertLT(0, pointersPage.$$('#mouse h2').offsetHeight);
diff --git a/chrome/test/data/webui/settings/languages_page_browsertest.js b/chrome/test/data/webui/settings/languages_page_browsertest.js
index e327fcd..6568a06 100644
--- a/chrome/test/data/webui/settings/languages_page_browsertest.js
+++ b/chrome/test/data/webui/settings/languages_page_browsertest.js
@@ -68,10 +68,14 @@ TEST_F('SettingsLanguagesPageBrowserTest', 'MAYBE_LanguagesPage', function() {
 
     teardown(function(done) {
       // Close the section if we're in a sub-page.
-      if (settings.getCurrentRoute().subpage.length == 0) {
+      if (advanced.currentRoute.subpage.length == 0) {
         done();
       } else {
-        settings.navigateTo(settings.Route.ADVANCED);
+        advanced.currentRoute = {
+          page: 'advanced',
+          section: '',
+          subpage: [],
+        };
         setTimeout(done);
       }
     });
diff --git a/chrome/test/data/webui/settings/people_page_sync_page_test.js b/chrome/test/data/webui/settings/people_page_sync_page_test.js
index 87a04af..7b7adb6 100644
--- a/chrome/test/data/webui/settings/people_page_sync_page_test.js
+++ b/chrome/test/data/webui/settings/people_page_sync_page_test.js
@@ -104,6 +104,11 @@ cr.define('settings_people_page_sync_page', function() {
         browserProxy = new TestSyncBrowserProxy();
         settings.SyncBrowserProxyImpl.instance_ = browserProxy;
 
+        // TODO(tommycli): Remove once settings.navigateTo is no longer a stub.
+        settings.navigateTo = function(route) {
+          syncPage.currentRoute = route;
+        };
+
         PolymerTest.clearBody();
         syncPage = document.createElement('settings-sync-page');
         settings.navigateTo(settings.Route.SYNC);
diff --git a/chrome/test/data/webui/settings/site_list_tests.js b/chrome/test/data/webui/settings/site_list_tests.js
index 8e48d95..dcb276b 100644
--- a/chrome/test/data/webui/settings/site_list_tests.js
+++ b/chrome/test/data/webui/settings/site_list_tests.js
@@ -250,6 +250,9 @@ cr.define('site_list', function() {
       // Import necessary html before running suite.
       suiteSetup(function() {
         CrSettingsPrefs.setInitialized();
+        // Add a no-op stub to catch navigations during the test.
+        // TODO(tommycli): Remove once settings.navigateTo is no longer a stub.
+        settings.navigateTo = function(route) {};
         return PolymerTest.importHtml(
             'chrome://md-settings/site_settings/site_list.html');
       });
diff --git a/chrome/tools/disable_outdated_build_detector/BUILD.gn b/chrome/tools/disable_outdated_build_detector/BUILD.gn
deleted file mode 100644
index 4b4415b..0000000
--- a/chrome/tools/disable_outdated_build_detector/BUILD.gn
+++ /dev/null
@@ -1,61 +0,0 @@
-# Copyright (c) 2016 The Chromium Authors. All rights reserved.
-# Use of this source code is governed by a BSD-style license that can be
-# found in the LICENSE file.
-
-import("//chrome/version.gni")
-import("//testing/test.gni")
-
-if (is_win) {
-  executable("disable_outdated_build_detector") {
-    sources = [
-      "disable_outdated_build_detector_main.cc",
-    ]
-
-    configs -= [ "//build/config/win:console" ]
-    configs += [ "//build/config/win:windowed" ]
-
-    deps = [
-      ":disable_outdated_build_detector_exe_version",
-      ":lib",
-      "//base",
-      "//build/win:default_exe_manifest",
-    ]
-  }
-
-  process_version("disable_outdated_build_detector_exe_version") {
-    template_file = "disable_outdated_build_detector_exe_version.rc.version"
-    output = "$target_gen_dir/disable_outdated_build_detector_exe_version.rc"
-  }
-
-  source_set("lib") {
-    sources = [
-      "constants.cc",
-      "constants.h",
-      "disable_outdated_build_detector.cc",
-      "disable_outdated_build_detector.h",
-      "google_update_integration.cc",
-      "google_update_integration.h",
-    ]
-
-    public_deps = [
-      "//base",
-    ]
-  }
-
-  test("disable_outdated_build_detector_unittests") {
-    sources = [
-      "disable_outdated_build_detector_unittest.cc",
-      "google_update_integration_unittest.cc",
-      "run_all_unittests.cc",
-    ]
-
-    deps = [
-      ":lib",
-      "//base",
-      "//base/test:test_support",
-      "//chrome/installer/util:with_no_strings",
-      "//testing/gmock",
-      "//testing/gtest",
-    ]
-  }
-}
diff --git a/chrome/tools/disable_outdated_build_detector/DEPS b/chrome/tools/disable_outdated_build_detector/DEPS
deleted file mode 100644
index 52cee07..0000000
--- a/chrome/tools/disable_outdated_build_detector/DEPS
+++ /dev/null
@@ -1,3 +0,0 @@
-include_rules = [
-  "+chrome/installer/util",
-]
diff --git a/chrome/tools/disable_outdated_build_detector/OWNERS b/chrome/tools/disable_outdated_build_detector/OWNERS
deleted file mode 100644
index 3bf0299..0000000
--- a/chrome/tools/disable_outdated_build_detector/OWNERS
+++ /dev/null
@@ -1,2 +0,0 @@
-ganesh@chromium.org
-grt@chromium.org
diff --git a/chrome/tools/disable_outdated_build_detector/constants.cc b/chrome/tools/disable_outdated_build_detector/constants.cc
deleted file mode 100644
index 7d69c82..0000000
--- a/chrome/tools/disable_outdated_build_detector/constants.cc
+++ /dev/null
@@ -1,40 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/tools/disable_outdated_build_detector/constants.h"
-
-namespace switches {
-
-const char kMultiInstall[] = "multi-install";
-const char kSystemLevel[] = "system-level";
-
-}  // namespace switches
-
-namespace env {
-
-// The presence of this environment variable with a value of 1 implies that the
-// tool should run as a system installation regardless of what is on the command
-// line.
-const char kGoogleUpdateIsMachine[] = "GoogleUpdateIsMachine";
-
-}  // namespace env
-
-// App GUIDs for Google Chrome and the Google Chrome binaries.
-#if defined(GOOGLE_CHROME_BUILD)
-const wchar_t kChromeAppGuid[] = L"{8A69D345-D564-463c-AFF1-A69D9E530F96}";
-const wchar_t kBinariesAppGuid[] = L"{4DC8B4CA-1BDA-483e-B5FA-D3C12E15B62D}";
-#else
-const wchar_t kChromeAppGuid[] = L"";
-const wchar_t kBinariesAppGuid[] = L"";
-#endif
-
-// The new brand to which organic installs will be switched.
-const wchar_t kAOHY[] = L"AOHY";
-
-// The names of registry values within a product's ClientState key.
-const wchar_t kBrand[] = L"brand";
-const wchar_t kInstallerResult[] = L"InstallerResult";
-const wchar_t kInstallerError[] = L"InstallerError";
-const wchar_t kInstallerExtraCode1[] = L"InstallerExtraCode1";
-const wchar_t kUninstallArguments[] = L"UninstallArguments";
diff --git a/chrome/tools/disable_outdated_build_detector/constants.h b/chrome/tools/disable_outdated_build_detector/constants.h
deleted file mode 100644
index 30b6eac..0000000
--- a/chrome/tools/disable_outdated_build_detector/constants.h
+++ /dev/null
@@ -1,61 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_TOOLS_DISABLE_OUTDATED_BUILD_DETECTOR_CONSTANTS_H_
-#define CHROME_TOOLS_DISABLE_OUTDATED_BUILD_DETECTOR_CONSTANTS_H_
-
-#include <stdint.h>
-
-namespace switches {
-
-extern const char kMultiInstall[];
-extern const char kSystemLevel[];
-
-}  // namespace switches
-
-namespace env {
-
-extern const char kGoogleUpdateIsMachine[];
-
-}  // namespace env
-
-extern const wchar_t kChromeAppGuid[];
-extern const wchar_t kBinariesAppGuid[];
-
-extern const wchar_t kAOHY[];
-extern const wchar_t kBrand[];
-extern const wchar_t kInstallerResult[];
-extern const wchar_t kInstallerError[];
-extern const wchar_t kInstallerExtraCode1[];
-extern const wchar_t kUninstallArguments[];
-
-// Values for the process exit code and for Google Update's InstallerError,
-// both of which are of type DWORD (a 32-bit unsigned int). The codes start at
-// 1000 so as to not collide with existing setup.exe and mini_installer.exe
-// exit codes (found in chrome/installer/util/util_constants.h and
-// chrome/installer/mini_installer/exit_code.h, respectively).
-enum class ExitCode : uint32_t {
-  // Success exit codes.
-  BOTH_BRANDS_UPDATED = 1000,   // Both Chrome and the Binaries were updated.
-  CHROME_BRAND_UPDATED = 1001,  // Only Chrome's brand was updated.
-  NO_CHROME = 1002,             // Chrome's ClientState key was not found.
-  NON_ORGANIC_BRAND = 1003,     // A non-organic brand was found, no update.
-
-  // Failure exit codes.
-  UNKNOWN_FAILURE = 1010,  // Never reported.
-  UNSUPPORTED_OS = 1011,   // Client OS is Windows 7 or newer.
-
-  // For these failure modes, Google Update's ExtraCode1 field is populated with
-  // the Windows error code corresponding to the failed operation.
-  FAILED_OPENING_KEY = 1012,    // RegOpenKeyEx failed.
-  FAILED_READING_BRAND = 1013,  // RegQueryValueEx failed.
-  FAILED_WRITING_BRAND = 1014,  // RegSetValueEx failed.
-};
-
-// Values defined by Google Update.
-enum class InstallerResult : uint32_t {
-  FAILED_CUSTOM_ERROR = 1,
-};
-
-#endif  // CHROME_TOOLS_DISABLE_OUTDATED_BUILD_DETECTOR_CONSTANTS_H_
diff --git a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.cc b/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.cc
deleted file mode 100644
index 01d2f16..0000000
--- a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.cc
+++ /dev/null
@@ -1,110 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.h"
-
-#include "base/command_line.h"
-#include "base/environment.h"
-#include "base/strings/string16.h"
-#include "base/win/registry.h"
-#include "chrome/tools/disable_outdated_build_detector/google_update_integration.h"
-
-namespace {
-
-// Returns true if the tool is to operate on a system-level Chrome on the basis
-// of either the --system-level command line switch or the GoogleUpdateIsMachine
-// environment variable.
-bool IsSystemLevel(const base::CommandLine& command_line) {
-  if (command_line.HasSwitch(switches::kSystemLevel))
-    return true;
-
-  std::string is_machine;
-  return base::Environment::Create()->GetVar(env::kGoogleUpdateIsMachine,
-                                             &is_machine) &&
-         is_machine.size() == 1 && is_machine[0] == '1';
-}
-
-// Returns true if Chrome is multi-install.
-bool IsChromeMultiInstall(bool system_level) {
-  base::win::RegKey key;
-
-  LONG result = OpenClientStateKey(system_level, kChromeAppGuid, &key);
-  if (result != ERROR_SUCCESS)
-    return false;
-  base::string16 uninstall_arguments;
-  result = key.ReadValue(kUninstallArguments, &uninstall_arguments);
-  if (result != ERROR_SUCCESS)
-    return false;
-  base::CommandLine command_line =
-      base::CommandLine::FromString(L"\"foo\" " + uninstall_arguments);
-  return command_line.HasSwitch(switches::kMultiInstall);
-}
-
-// Disables the outdated build detector for |app_guid|. On failures, |detail|
-// will be populated with a Windows error code corresponding to the failure
-// mode. Returns the exit code for the operation.
-ExitCode DisableForApp(bool system_level,
-                       const wchar_t* app_guid,
-                       uint32_t* detail) {
-  base::win::RegKey key;
-
-  *detail = OpenClientStateKey(system_level, app_guid, &key);
-  if (*detail == ERROR_FILE_NOT_FOUND)
-    return ExitCode::NO_CHROME;
-  if (*detail != ERROR_SUCCESS)
-    return ExitCode::FAILED_OPENING_KEY;
-
-  base::string16 brand;
-  *detail = key.ReadValue(kBrand, &brand);
-  if (*detail != ERROR_SUCCESS && *detail != ERROR_FILE_NOT_FOUND)
-    return ExitCode::FAILED_READING_BRAND;
-
-  if (!IsOrganic(brand))
-    return ExitCode::NON_ORGANIC_BRAND;
-
-  *detail = key.WriteValue(kBrand, kAOHY);
-  if (*detail != ERROR_SUCCESS)
-    return ExitCode::FAILED_WRITING_BRAND;
-
-  return ExitCode::CHROME_BRAND_UPDATED;
-}
-
-// Disables the outdated build detector for organic installs of Chrome by
-// switching the install to the AOHY non-organic brand code. If Chrome's brand
-// is modified and it is a multi-install Chrome, the binaries' brand code will
-// likewise be modified. On failures, |detail| will be populated with a Windows
-// error code corresponding to the failure mode. Returns the process exit code
-// for the operation.
-ExitCode DisableOutdatedBuildDetectorImpl(bool system_level, uint32_t* detail) {
-  // Update Chrome's brand code.
-  ExitCode exit_code = DisableForApp(system_level, kChromeAppGuid, detail);
-
-  // If that succeeded and Chrome is multi-install, make a best-effort attempt
-  // to update the binaries' brand code.
-  if (exit_code == ExitCode::CHROME_BRAND_UPDATED &&
-      IsChromeMultiInstall(system_level)) {
-    ExitCode secondary_code =
-        DisableForApp(system_level, kBinariesAppGuid, detail);
-    if (secondary_code == ExitCode::CHROME_BRAND_UPDATED)
-      exit_code = ExitCode::BOTH_BRANDS_UPDATED;
-  }
-  return exit_code;
-}
-
-}  // namespace
-
-ExitCode DisableOutdatedBuildDetector(const base::CommandLine& command_line) {
-  const bool system_level = IsSystemLevel(command_line);
-  ResultInfo result_info = {
-      InstallerResult::FAILED_CUSTOM_ERROR,  // installer_result
-      ExitCode::UNKNOWN_FAILURE,             // installer_error
-      0                                      // installer_extra_code1
-  };
-
-  result_info.installer_error = DisableOutdatedBuildDetectorImpl(
-      system_level, &result_info.installer_extra_code1);
-
-  WriteResultInfo(system_level, result_info);
-  return result_info.installer_error;
-}
diff --git a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.exe.manifest b/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.exe.manifest
deleted file mode 100644
index afb780f..0000000
--- a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.exe.manifest
+++ /dev/null
@@ -1,11 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0">
-  <!--The compatibility section will be merged from build/win/compatibility.manifest -->
-  <ms_asmv2:trustInfo xmlns:ms_asmv2="urn:schemas-microsoft-com:asm.v2">
-    <ms_asmv2:security>
-      <ms_asmv2:requestedPrivileges>
-        <ms_asmv2:requestedExecutionLevel level="asInvoker" />
-      </ms_asmv2:requestedPrivileges>
-    </ms_asmv2:security>
-  </ms_asmv2:trustInfo>
-</assembly>
diff --git a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.gyp b/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.gyp
deleted file mode 100644
index 2dadd0f..0000000
--- a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.gyp
+++ /dev/null
@@ -1,123 +0,0 @@
-# Copyright (c) 2016 The Chromium Authors. All rights reserved.
-# Use of this source code is governed by a BSD-style license that can be
-# found in the LICENSE file.
-{
-  'variables': {
-    'chromium_code': 1,
-    'branding_dir': '../../../chrome/app/theme/<(branding_path_component)',
-  },
-  'includes': [
-    '../../../build/util/version.gypi',
-  ],
-  'targets': [{
-    'target_name': 'disable_outdated_build_detector_lib',
-    'type': 'static_library',
-    'dependencies': [
-      '../../../base/base.gyp:base',
-    ],
-    'include_dirs': [
-      '../../..',
-    ],
-    'sources': [
-      'constants.cc',
-      'constants.h',
-      'disable_outdated_build_detector.cc',
-      'disable_outdated_build_detector.h',
-      'google_update_integration.cc',
-      'google_update_integration.h',
-    ],
-  },{
-    'target_name': 'disable_outdated_build_detector',
-    'type': 'executable',
-    'dependencies': [
-      '../../../base/base.gyp:base',
-      'disable_outdated_build_detector_lib',
-    ],
-    'include_dirs': [
-      '../../..',
-    ],
-    'sources': [
-      'disable_outdated_build_detector_exe_version.rc.version',
-      'disable_outdated_build_detector_main.cc',
-    ],
-    'msvs_settings': {
-      'VCLinkerTool': {
-        'SubSystem': '2',     # Set /SUBSYSTEM:WINDOWS
-      },
-      'VCManifestTool': {
-        'AdditionalManifestFiles': [
-          '$(ProjectDir)\\disable_outdated_build_detector.exe.manifest',
-        ],
-      },
-    },
-    'rules': [
-      {
-        'rule_name': 'disable_outdated_build_detector_version',
-        'extension': 'version',
-        'variables': {
-          'version_py_path': '<(DEPTH)/build/util/version.py',
-          'template_input_path': '../../../chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_exe_version.rc.version',
-        },
-        'inputs': [
-          '<(template_input_path)',
-          '<(version_path)',
-          '<(lastchange_path)',
-          '<(branding_dir)/BRANDING',
-        ],
-        'outputs': [
-          '<(SHARED_INTERMEDIATE_DIR)/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_exe_version.rc',
-        ],
-        'action': [
-          'python', '<(version_py_path)',
-          '-f', '<(version_path)',
-          '-f', '<(lastchange_path)',
-          '-f', '<(branding_dir)/BRANDING',
-          '<(template_input_path)',
-          '<@(_outputs)',
-        ],
-        'process_outputs_as_sources': 1,
-        'message': 'Generating version information'
-      },
-    ],
-    'conditions': [
-      ['target_arch=="ia32"', {
-        'msvs_settings': {
-          'VCCLCompilerTool': {
-            'EnableEnhancedInstructionSet': '4',  # NoExtensions
-          },
-        },
-      }],
-    ],
-  },{
-    'target_name': 'disable_outdated_build_detector_unittests',
-    'type': '<(gtest_target_type)',
-    'dependencies': [
-      'disable_outdated_build_detector_lib',
-      '../../../base/base.gyp:base',
-      '../../../base/base.gyp:test_support_base',
-      '../../../chrome/chrome.gyp:installer_util',
-      '../../../testing/gmock.gyp:gmock',
-      '../../../testing/gtest.gyp:gtest',
-    ],
-    'include_dirs': [
-      '../../..',
-    ],
-    'sources': [
-      'disable_outdated_build_detector_unittest.cc',
-      'google_update_integration_unittest.cc',
-      'run_all_unittests.cc',
-    ],
-  },{
-    'target_name': 'disable_outdated_build_detector_unittests_run',
-    'type': 'none',
-    'dependencies': [
-      'disable_outdated_build_detector_unittests',
-    ],
-    'includes': [
-      '../../../build/isolate.gypi',
-    ],
-    'sources': [
-      'disable_outdated_build_detector_unittests.isolate',
-    ],
-  }],
-}
diff --git a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.h b/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.h
deleted file mode 100644
index a2045d2..0000000
--- a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.h
+++ /dev/null
@@ -1,25 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_TOOLS_DISABLE_OUTDATED_BUILD_DETECTOR_DISABLE_OUTDATED_BUILD_DETECTOR_H_
-#define CHROME_TOOLS_DISABLE_OUTDATED_BUILD_DETECTOR_DISABLE_OUTDATED_BUILD_DETECTOR_H_
-
-#include <stdint.h>
-
-#include "chrome/tools/disable_outdated_build_detector/constants.h"
-
-namespace base {
-class CommandLine;
-}
-
-// Disables the outdated build detector for organic installs of Chrome by
-// switching the install to the AOHY non-organic brand code. Operates on
-// per-user Chrome unless |command_line| contains the "--system-level" switch,
-// in which case it operates on per-machine Chrome. The result of the operation
-// is written to the registry in Chrome's ClientState key in accordance with the
-// Google Update installer result API. Returns the process exit code for the
-// operation.
-ExitCode DisableOutdatedBuildDetector(const base::CommandLine& command_line);
-
-#endif  // CHROME_TOOLS_DISABLE_OUTDATED_BUILD_DETECTOR_DISABLE_OUTDATED_BUILD_DETECTOR_H_
diff --git a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_exe_version.rc.version b/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_exe_version.rc.version
deleted file mode 100644
index a45cb2f..0000000
--- a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_exe_version.rc.version
+++ /dev/null
@@ -1,46 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include <verrsrc.h>
-
-/////////////////////////////////////////////////////////////////////////////
-//
-// Version
-//
-
-VS_VERSION_INFO VERSIONINFO
- FILEVERSION @MAJOR@,@MINOR@,@BUILD@,@PATCH@
- PRODUCTVERSION @MAJOR@,@MINOR@,@BUILD@,@PATCH@
- FILEFLAGSMASK 0x17L
-#ifdef _DEBUG
- FILEFLAGS 0x1L
-#else
- FILEFLAGS 0x0L
-#endif
- FILEOS 0x4L
- FILETYPE 0x1L
- FILESUBTYPE 0x0L
-BEGIN
-    BLOCK "StringFileInfo"
-    BEGIN
-        BLOCK "040904b0"
-        BEGIN
-            VALUE "CompanyName", "@COMPANY_FULLNAME@"
-            VALUE "FileDescription", "disable_outdated_build_detector"
-            VALUE "FileVersion", "@MAJOR@.@MINOR@.@BUILD@.@PATCH@"
-            VALUE "InternalName", "disable_outdated_build_detector"
-            VALUE "LegalCopyright", "@COPYRIGHT@"
-            VALUE "ProductName", "disable_outdated_build_detector"
-            VALUE "ProductVersion", "@MAJOR@.@MINOR@.@BUILD@.@PATCH@"
-            VALUE "CompanyShortName", "@COMPANY_SHORTNAME@"
-            VALUE "ProductShortName", "disable_outdated_build_detector"
-            VALUE "LastChange", "@LASTCHANGE@"
-            VALUE "Official Build", "@OFFICIAL_BUILD@"
-        END
-    END
-    BLOCK "VarFileInfo"
-    BEGIN
-        VALUE "Translation", 0x409, 1200
-    END
-END
diff --git a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_main.cc b/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_main.cc
deleted file mode 100644
index aa1253a..0000000
--- a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_main.cc
+++ /dev/null
@@ -1,38 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-// The main entrypoint for the tool that disables the outdated build detector
-// for organic installs of Chrome on Windows XP and Vista. See
-// disable_outdated_build_detector.h for more information.
-
-#include <windows.h>
-#include <stdint.h>
-
-#include "base/at_exit.h"
-#include "base/command_line.h"
-#include "base/logging.h"
-#include "base/win/windows_version.h"
-#include "chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.h"
-
-int WINAPI wWinMain(HINSTANCE /* instance */,
-                    HINSTANCE /* unused */,
-                    wchar_t* /* command_line */,
-                    int /* command_show */) {
-  if (base::win::GetVersion() >= base::win::VERSION_WIN7)
-    return static_cast<int>(ExitCode::UNSUPPORTED_OS);
-
-  base::AtExitManager at_exit_manager;
-  base::CommandLine::Init(0, nullptr);
-
-  // Don't generate any log files.
-  logging::LoggingSettings logging_settings;
-  logging_settings.logging_dest = logging::LOG_TO_SYSTEM_DEBUG_LOG;
-  logging::InitLogging(logging_settings);
-
-  // For reasons, wWinMain returns an int rather than a DWORD. This value
-  // eventually makes its way to ExitProcess, which indeed takes an unsigned
-  // int.
-  return static_cast<int>(
-      DisableOutdatedBuildDetector(*base::CommandLine::ForCurrentProcess()));
-}
diff --git a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_unittest.cc b/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_unittest.cc
deleted file mode 100644
index 4e83f42..0000000
--- a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_unittest.cc
+++ /dev/null
@@ -1,185 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector.h"
-
-#include "base/command_line.h"
-#include "base/environment.h"
-#include "base/strings/string16.h"
-#include "base/test/test_reg_util_win.h"
-#include "chrome/installer/util/browser_distribution.h"
-#include "chrome/installer/util/util_constants.h"
-#include "chrome/tools/disable_outdated_build_detector/constants.h"
-#include "testing/gtest/include/gtest/gtest.h"
-
-enum class ExecutionMode {
-  USER_LEVEL,
-  SYSTEM_LEVEL_SWITCH,
-  IS_MACHINE_ENV,
-};
-
-class DisableOutdatedBuildDetectorTest
-    : public ::testing::TestWithParam<ExecutionMode> {
- protected:
-  DisableOutdatedBuildDetectorTest()
-      : command_line_(base::CommandLine::NO_PROGRAM),
-        chrome_distribution_(BrowserDistribution::GetSpecificDistribution(
-            BrowserDistribution::CHROME_BROWSER)),
-        binaries_distribution_(BrowserDistribution::GetSpecificDistribution(
-            BrowserDistribution::CHROME_BINARIES)),
-        execution_mode_(GetParam()),
-        root_(execution_mode_ == ExecutionMode::USER_LEVEL
-                  ? HKEY_CURRENT_USER
-                  : HKEY_LOCAL_MACHINE) {
-    registry_override_manager_.OverrideRegistry(root_);
-    if (execution_mode_ == ExecutionMode::SYSTEM_LEVEL_SWITCH)
-      command_line_.AppendSwitch("system-level");
-    base::Environment::Create()->SetVar(
-        "GoogleUpdateIsMachine",
-        execution_mode_ == ExecutionMode::IS_MACHINE_ENV ? "1" : "0");
-  }
-
-  void FakeChrome(bool multi_install, const wchar_t* brand) {
-    base::win::RegKey key;
-    ASSERT_EQ(ERROR_SUCCESS,
-              key.Create(root_, chrome_distribution_->GetStateKey().c_str(),
-                         KEY_ALL_ACCESS | KEY_WOW64_32KEY));
-    base::string16 uninstall_arguments(L"--uninstall");
-    if (multi_install)
-      uninstall_arguments += L"--chrome --multi-install";
-    ASSERT_EQ(ERROR_SUCCESS, key.WriteValue(L"brand", brand));
-    ASSERT_EQ(ERROR_SUCCESS, key.WriteValue(L"UninstallArguments",
-                                            uninstall_arguments.c_str()));
-    if (!multi_install)
-      return;
-    uninstall_arguments = L"--uninstall --multi-install";
-    ASSERT_EQ(ERROR_SUCCESS,
-              key.Create(root_, binaries_distribution_->GetStateKey().c_str(),
-                         KEY_ALL_ACCESS | KEY_WOW64_32KEY));
-    ASSERT_EQ(ERROR_SUCCESS, key.WriteValue(L"brand", brand));
-    ASSERT_EQ(ERROR_SUCCESS, key.WriteValue(L"UninstallArguments",
-                                            uninstall_arguments.c_str()));
-  }
-
-  bool HasBrand(BrowserDistribution* dist) {
-    base::win::RegKey key(root_, dist->GetStateKey().c_str(),
-                          KEY_QUERY_VALUE | KEY_WOW64_32KEY);
-    return key.Valid() && key.HasValue(L"brand");
-  }
-
-  base::string16 ReadBrand(BrowserDistribution* dist) {
-    base::win::RegKey key(root_, dist->GetStateKey().c_str(),
-                          KEY_QUERY_VALUE | KEY_WOW64_32KEY);
-    base::string16 brand;
-    if (!key.Valid() || key.ReadValue(L"brand", &brand) != ERROR_SUCCESS)
-      return base::string16();
-    return brand;
-  }
-
-  // Verifies that |result| and |exit_code| are found in Chrome's ClientStateKey
-  // in the InstallerResult and InstallerError values, respectively.
-  void ExpectResult(InstallerResult result, ExitCode exit_code) {
-    base::win::RegKey key(root_, chrome_distribution_->GetStateKey().c_str(),
-                          KEY_QUERY_VALUE | KEY_WOW64_32KEY);
-    ASSERT_TRUE(key.Valid());
-    DWORD value = 0;
-    ASSERT_EQ(ERROR_SUCCESS,
-              key.ReadValueDW(installer::kInstallerResult, &value));
-    EXPECT_EQ(result, static_cast<InstallerResult>(value));
-    ASSERT_EQ(ERROR_SUCCESS,
-              key.ReadValueDW(installer::kInstallerError, &value));
-    EXPECT_EQ(exit_code, static_cast<ExitCode>(value));
-  }
-
-  base::CommandLine command_line_;
-  BrowserDistribution* chrome_distribution_;
-  BrowserDistribution* binaries_distribution_;
-
- private:
-  const ExecutionMode execution_mode_;
-  const HKEY root_;
-  registry_util::RegistryOverrideManager registry_override_manager_;
-};
-
-TEST_P(DisableOutdatedBuildDetectorTest, NoChrome) {
-  EXPECT_EQ(ExitCode::NO_CHROME, DisableOutdatedBuildDetector(command_line_));
-}
-
-TEST_P(DisableOutdatedBuildDetectorTest, SingleOrganicChrome) {
-  // Fake single-install Chrome's ClientState key with an organic brand.
-  FakeChrome(false /* single-install */, L"GGLS");
-
-  // Switch the brand.
-  EXPECT_EQ(ExitCode::CHROME_BRAND_UPDATED,
-            DisableOutdatedBuildDetector(command_line_));
-  ExpectResult(InstallerResult::FAILED_CUSTOM_ERROR,
-               ExitCode::CHROME_BRAND_UPDATED);
-
-  // Verify the new brand.
-  EXPECT_STREQ(L"AOHY", ReadBrand(chrome_distribution_).c_str());
-
-  // And the binaries' ClientState key should not have been created.
-  EXPECT_FALSE(HasBrand(binaries_distribution_));
-}
-
-TEST_P(DisableOutdatedBuildDetectorTest, SingleInOrganicChrome) {
-  static const wchar_t kBlorBrand[] = L"BLOR";
-
-  // Fake single-install Chrome's ClientState key with an inorganic brand.
-  FakeChrome(false /* single-install */, kBlorBrand);
-
-  // Switch the brand.
-  EXPECT_EQ(ExitCode::NON_ORGANIC_BRAND,
-            DisableOutdatedBuildDetector(command_line_));
-  ExpectResult(InstallerResult::FAILED_CUSTOM_ERROR,
-               ExitCode::NON_ORGANIC_BRAND);
-
-  // Verify that the brand is unchanged.
-  EXPECT_STREQ(kBlorBrand, ReadBrand(chrome_distribution_).c_str());
-
-  // And the binaries' ClientState key should not have been created.
-  EXPECT_FALSE(HasBrand(binaries_distribution_));
-}
-
-TEST_P(DisableOutdatedBuildDetectorTest, MultiOrganicChrome) {
-  // Fake multi-install Chrome's ClientState key with an organic brand.
-  FakeChrome(true /* multi-install */, L"GGLS");
-
-  // Switch the brand.
-  EXPECT_EQ(ExitCode::BOTH_BRANDS_UPDATED,
-            DisableOutdatedBuildDetector(command_line_));
-  ExpectResult(InstallerResult::FAILED_CUSTOM_ERROR,
-               ExitCode::BOTH_BRANDS_UPDATED);
-
-  // Verify the new brand in Chrome and the binaries.
-  EXPECT_STREQ(L"AOHY", ReadBrand(chrome_distribution_).c_str());
-  EXPECT_STREQ(L"AOHY", ReadBrand(binaries_distribution_).c_str());
-}
-
-TEST_P(DisableOutdatedBuildDetectorTest, MultiInOrganicChrome) {
-  static const wchar_t kBlorBrand[] = L"BLOR";
-
-  // Fake multi-install Chrome's ClientState key with an inorganic brand.
-  FakeChrome(true /* multi-install */, kBlorBrand);
-
-  // Switch the brand.
-  EXPECT_EQ(ExitCode::NON_ORGANIC_BRAND,
-            DisableOutdatedBuildDetector(command_line_));
-  ExpectResult(InstallerResult::FAILED_CUSTOM_ERROR,
-               ExitCode::NON_ORGANIC_BRAND);
-
-  // Verify that the brand is unchanged in both apps.
-  EXPECT_STREQ(kBlorBrand, ReadBrand(chrome_distribution_).c_str());
-  EXPECT_STREQ(kBlorBrand, ReadBrand(binaries_distribution_).c_str());
-}
-
-INSTANTIATE_TEST_CASE_P(UserLevel,
-                        DisableOutdatedBuildDetectorTest,
-                        ::testing::Values(ExecutionMode::USER_LEVEL));
-INSTANTIATE_TEST_CASE_P(SystemLevelSwitch,
-                        DisableOutdatedBuildDetectorTest,
-                        ::testing::Values(ExecutionMode::SYSTEM_LEVEL_SWITCH));
-INSTANTIATE_TEST_CASE_P(IsMachineEnv,
-                        DisableOutdatedBuildDetectorTest,
-                        ::testing::Values(ExecutionMode::IS_MACHINE_ENV));
diff --git a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_unittests.isolate b/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_unittests.isolate
deleted file mode 100644
index cd55c27..0000000
--- a/chrome/tools/disable_outdated_build_detector/disable_outdated_build_detector_unittests.isolate
+++ /dev/null
@@ -1,19 +0,0 @@
-# Copyright 2016 The Chromium Authors. All rights reserved.
-# Use of this source code is governed by a BSD-style license that can be
-# found in the LICENSE file.
-{
-  'conditions': [
-    ['OS=="win"', {
-      'variables': {
-        'command': [
-          '<(PRODUCT_DIR)/disable_outdated_build_detector_unittests.exe',
-        ],
-        'files': [
-        ],
-      },
-    }],
-  ],
-  'includes': [
-    '../../../base/base.isolate',
-  ],
-}
diff --git a/chrome/tools/disable_outdated_build_detector/google_update_integration.cc b/chrome/tools/disable_outdated_build_detector/google_update_integration.cc
deleted file mode 100644
index 604f682..0000000
--- a/chrome/tools/disable_outdated_build_detector/google_update_integration.cc
+++ /dev/null
@@ -1,63 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/tools/disable_outdated_build_detector/google_update_integration.h"
-
-#include "base/strings/string_util.h"
-#include "base/strings/stringprintf.h"
-#include "base/win/registry.h"
-
-uint32_t OpenClientStateKey(bool system_level,
-                            const wchar_t* app_guid,
-                            base::win::RegKey* key) {
-#if defined(GOOGLE_CHROME_BUILD)
-  base::string16 path(base::StringPrintf(
-      L"Software\\Google\\Update\\ClientState\\%ls", app_guid));
-#else
-  base::string16 path(app_guid == kBinariesAppGuid
-                          ? L"Software\\Chromium Binaries"
-                          : L"Software\\Chromium");
-#endif
-  return key->Open(system_level ? HKEY_LOCAL_MACHINE : HKEY_CURRENT_USER,
-                   path.c_str(),
-                   KEY_QUERY_VALUE | KEY_SET_VALUE | KEY_WOW64_32KEY);
-}
-
-void WriteResultInfo(bool system_level, const ResultInfo& result_info) {
-  base::win::RegKey key;
-  uint32_t result = OpenClientStateKey(system_level, kChromeAppGuid, &key);
-  if (result != ERROR_SUCCESS)
-    return;
-  key.WriteValue(kInstallerResult,
-                 static_cast<uint32_t>(result_info.installer_result));
-  key.WriteValue(kInstallerError,
-                 static_cast<uint32_t>(result_info.installer_error));
-  if (result_info.installer_extra_code1) {
-    key.WriteValue(kInstallerExtraCode1,
-                   static_cast<uint32_t>(result_info.installer_error));
-  } else {
-    key.DeleteValue(kInstallerExtraCode1);
-  }
-}
-
-// Copied from chrome/browser/google/google_brand.cc.
-bool IsOrganic(const base::string16& brand) {
-  static const wchar_t* const kBrands[] = {
-      L"CHCA", L"CHCB", L"CHCG", L"CHCH", L"CHCI", L"CHCJ", L"CHCK", L"CHCL",
-      L"CHFO", L"CHFT", L"CHHS", L"CHHM", L"CHMA", L"CHMB", L"CHME", L"CHMF",
-      L"CHMG", L"CHMH", L"CHMI", L"CHMQ", L"CHMV", L"CHNB", L"CHNC", L"CHNG",
-      L"CHNH", L"CHNI", L"CHOA", L"CHOB", L"CHOC", L"CHON", L"CHOO", L"CHOP",
-      L"CHOQ", L"CHOR", L"CHOS", L"CHOT", L"CHOU", L"CHOX", L"CHOY", L"CHOZ",
-      L"CHPD", L"CHPE", L"CHPF", L"CHPG", L"ECBA", L"ECBB", L"ECDA", L"ECDB",
-      L"ECSA", L"ECSB", L"ECVA", L"ECVB", L"ECWA", L"ECWB", L"ECWC", L"ECWD",
-      L"ECWE", L"ECWF", L"EUBB", L"EUBC", L"GGLA", L"GGLS"};
-  const wchar_t* const* end = &kBrands[arraysize(kBrands)];
-  const wchar_t* const* found = std::find(&kBrands[0], end, brand);
-  if (found != end)
-    return true;
-
-  return base::StartsWith(brand, L"EUB", base::CompareCase::SENSITIVE) ||
-         base::StartsWith(brand, L"EUC", base::CompareCase::SENSITIVE) ||
-         base::StartsWith(brand, L"GGR", base::CompareCase::SENSITIVE);
-}
diff --git a/chrome/tools/disable_outdated_build_detector/google_update_integration.h b/chrome/tools/disable_outdated_build_detector/google_update_integration.h
deleted file mode 100644
index 7651354..0000000
--- a/chrome/tools/disable_outdated_build_detector/google_update_integration.h
+++ /dev/null
@@ -1,38 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CHROME_TOOLS_DISABLE_OUTDATED_BUILD_DETECTOR_GOOGLE_UPDATE_INTEGRATION_H_
-#define CHROME_TOOLS_DISABLE_OUTDATED_BUILD_DETECTOR_GOOGLE_UPDATE_INTEGRATION_H_
-
-#include "base/strings/string16.h"
-#include "chrome/tools/disable_outdated_build_detector/constants.h"
-
-namespace base {
-namespace win {
-class RegKey;
-}
-}
-
-// A structure containing the values that comprise the Google Update installer
-// result API.
-struct ResultInfo {
-  InstallerResult installer_result;
-  ExitCode installer_error;
-  uint32_t installer_extra_code1;
-};
-
-// Opens the Google Update ClientState key in the registry for the app
-// identified by |app_guid| at |system_level|. Returns ERROR_SUCCESS or another
-// Windows error value.
-uint32_t OpenClientStateKey(bool system_level,
-                            const wchar_t* app_guid,
-                            base::win::RegKey* key);
-
-// Writes the data in |result_info| into Chrome's ClientState key.
-void WriteResultInfo(bool system_level, const ResultInfo& result_info);
-
-// Returns |true| if |brand| represents an organic brand code.
-bool IsOrganic(const base::string16& brand);
-
-#endif  // CHROME_TOOLS_DISABLE_OUTDATED_BUILD_DETECTOR_GOOGLE_UPDATE_INTEGRATION_H_
diff --git a/chrome/tools/disable_outdated_build_detector/google_update_integration_unittest.cc b/chrome/tools/disable_outdated_build_detector/google_update_integration_unittest.cc
deleted file mode 100644
index 7905259..0000000
--- a/chrome/tools/disable_outdated_build_detector/google_update_integration_unittest.cc
+++ /dev/null
@@ -1,54 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "chrome/tools/disable_outdated_build_detector/google_update_integration.h"
-
-#include "testing/gtest/include/gtest/gtest.h"
-
-namespace {
-
-// Copied from chrome/browser/google/google_brand.cc.
-const wchar_t* const kOrganicBrands[] = {
-    L"CHCA", L"CHCB", L"CHCG", L"CHCH", L"CHCI", L"CHCJ", L"CHCK", L"CHCL",
-    L"CHFO", L"CHFT", L"CHHS", L"CHHM", L"CHMA", L"CHMB", L"CHME", L"CHMF",
-    L"CHMG", L"CHMH", L"CHMI", L"CHMQ", L"CHMV", L"CHNB", L"CHNC", L"CHNG",
-    L"CHNH", L"CHNI", L"CHOA", L"CHOB", L"CHOC", L"CHON", L"CHOO", L"CHOP",
-    L"CHOQ", L"CHOR", L"CHOS", L"CHOT", L"CHOU", L"CHOX", L"CHOY", L"CHOZ",
-    L"CHPD", L"CHPE", L"CHPF", L"CHPG", L"ECBA", L"ECBB", L"ECDA", L"ECDB",
-    L"ECSA", L"ECSB", L"ECVA", L"ECVB", L"ECWA", L"ECWB", L"ECWC", L"ECWD",
-    L"ECWE", L"ECWF", L"EUBB", L"EUBC", L"GGLA", L"GGLS",
-
-    // EUB*
-    L"EUBQ",
-
-    // EUC*
-    L"EUCQ",
-
-    // GGR*
-    L"GGRQ",
-};
-
-}  // namespace
-
-// Test that all expected brands are considered organic.
-class IsOrganicTest : public ::testing::TestWithParam<const wchar_t*> {};
-
-TEST_P(IsOrganicTest, IsOrganicBrand) {
-  EXPECT_TRUE(IsOrganic(GetParam()));
-}
-
-INSTANTIATE_TEST_CASE_P(OrganicBrands,
-                        IsOrganicTest,
-                        ::testing::ValuesIn(kOrganicBrands));
-
-// Test that a smattering of non-organic brands are not considered organic.
-class IsNotOrganicTest : public ::testing::TestWithParam<const wchar_t*> {};
-
-TEST_P(IsNotOrganicTest, IsNotOrganicBrand) {
-  EXPECT_FALSE(IsOrganic(GetParam()));
-}
-
-INSTANTIATE_TEST_CASE_P(NonOrganicBrands,
-                        IsNotOrganicTest,
-                        ::testing::Values(L"AOHY", L"YAKS", L""));
diff --git a/chrome/tools/disable_outdated_build_detector/run_all_unittests.cc b/chrome/tools/disable_outdated_build_detector/run_all_unittests.cc
deleted file mode 100644
index da52310..0000000
--- a/chrome/tools/disable_outdated_build_detector/run_all_unittests.cc
+++ /dev/null
@@ -1,15 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "base/bind.h"
-#include "base/test/launcher/unit_test_launcher.h"
-#include "base/test/test_suite.h"
-#include "build/build_config.h"
-
-int main(int argc, char** argv) {
-  base::TestSuite test_suite(argc, argv);
-  return base::LaunchUnitTests(
-      argc, argv,
-      base::Bind(&base::TestSuite::Run, base::Unretained(&test_suite)));
-}
diff --git a/chrome_elf/chrome_elf_main.cc b/chrome_elf/chrome_elf_main.cc
index 718bd8d..46e6e15 100644
--- a/chrome_elf/chrome_elf_main.cc
+++ b/chrome_elf/chrome_elf_main.cc
@@ -50,7 +50,6 @@ void InitializeCrashReportingForProcess() {
   ChromeCrashReporterClient::InitializeCrashReportingForProcess();
 }
 
-#if !defined(ADDRESS_SANITIZER)
 // chrome_elf loads early in the process and initializes Crashpad. That in turn
 // uses the SetUnhandledExceptionFilter API to set a top level exception
 // handler for the process. When the process eventually initializes, CRT sets
@@ -81,7 +80,6 @@ void DisableSetUnhandledExceptionFilter() {
       SetUnhandledExceptionFilterPatch);
   CHECK(patched == 0);
 }
-#endif // !defined(ADDRESS_SANITIZER)
 
 }  // namespace
 
@@ -114,11 +112,8 @@ BOOL APIENTRY DllMain(HMODULE module, DWORD reason, LPVOID reserved) {
     InitializeCrashReportingForProcess();
     // CRT on initialization installs an exception filter which calls
     // TerminateProcess. We need to hook CRT's attempt to set an exception
-    // handler and ignore it. Don't do this when ASan is present, or ASan will
-    // fail to install its own unhandled exception filter.
-#if !defined(ADDRESS_SANITIZER)
+    // handler and ignore it.
     DisableSetUnhandledExceptionFilter();
-#endif
 
     install_static::InitializeProcessType();
     if (install_static::g_process_type ==
diff --git a/chromecast/android/DEPS b/chromecast/android/DEPS
index e9202c5..d4af4bd 100644
--- a/chromecast/android/DEPS
+++ b/chromecast/android/DEPS
@@ -1,4 +1,5 @@
 include_rules = [
+  # Includes for JNI.
   "+chromecast/android",
   "+chromecast/app/android",
   "+chromecast/browser/android",
diff --git a/chromecast/app/DEPS b/chromecast/app/DEPS
index 8381e5e..cf20d48 100644
--- a/chromecast/app/DEPS
+++ b/chromecast/app/DEPS
@@ -1,9 +1,5 @@
 include_rules = [
-  "+chromecast/browser",
-  "+chromecast/common",
-  "+chromecast/crash",
-  "+chromecast/renderer",
-  "+chromecast/utility",
+  "+chromecast",
   "+components/crash",
   "+content/public/app",
   "+content/public/browser",
diff --git a/chromecast/base/cast_sys_info_dummy.cc b/chromecast/base/cast_sys_info_dummy.cc
index a013128..f675dfd 100644
--- a/chromecast/base/cast_sys_info_dummy.cc
+++ b/chromecast/base/cast_sys_info_dummy.cc
@@ -9,8 +9,6 @@ namespace chromecast {
 CastSysInfoDummy::CastSysInfoDummy()
     : build_type_(BUILD_ENG),
       serial_number_("dummy.serial.number"),
-      product_name_("dummy product"),
-      device_model_("dummy model"),
       factory_country_("US"),
       factory_locale_("en-US") {
 }
diff --git a/chromecast/browser/DEPS b/chromecast/browser/DEPS
index 1d07025..c5ba172 100644
--- a/chromecast/browser/DEPS
+++ b/chromecast/browser/DEPS
@@ -1,10 +1,8 @@
 include_rules = [
+  # chromecast/browser/ is the top-level main directory for the Chromecast
+  # embedder and can include from all other chromecast/ directories.
   "+cc/base/switches.h",
-  "+chromecast/common",
-  "+chromecast/graphics",
-  "+chromecast/media",
-  "+chromecast/net",
-  "+chromecast/service",
+  "+chromecast",
   "+components/crash",
   "+components/devtools_discovery",
   "+components/devtools_http_handler",
@@ -30,7 +28,4 @@ include_rules = [
   "+ui/gl",
   "+ui/display",
   "+ui/ozone/platform/cast/overlay_manager_cast.h",
-
-  # TODO(sanfin): Remove this by fixing the crash handler on android.
-  "!chromecast/app",
 ]
diff --git a/chromecast/browser/test/DEPS b/chromecast/browser/test/DEPS
index 21e63a3..b969a40 100644
--- a/chromecast/browser/test/DEPS
+++ b/chromecast/browser/test/DEPS
@@ -1,4 +1,3 @@
 include_rules = [
-  "+chromecast/app",
   "+content/public/test",
 ]
diff --git a/chromecast/media/DEPS b/chromecast/media/DEPS
index 1e5aef8..4ebcd9e 100644
--- a/chromecast/media/DEPS
+++ b/chromecast/media/DEPS
@@ -1,6 +1,10 @@
 include_rules = [
   "+crypto",
+  "+gpu",
   "+media/audio",
   "+media/base",
   "+media/cdm",
+  "+media/media_features.h",
+  "+media/mojo",
+  "+media/renderers",
 ]
diff --git a/chromecast/media/cma/DEPS b/chromecast/media/cma/DEPS
index 2304ef4..9a1b90e 100644
--- a/chromecast/media/cma/DEPS
+++ b/chromecast/media/cma/DEPS
@@ -1,4 +1,5 @@
 include_rules = [
+  "-chromecast/media/cdm",
   "+chromecast/media/cdm/cast_cdm_context.h",
-  "+ui/gfx/geometry",
+  "+ui/gfx",
 ]
diff --git a/chromecast/media/cma/backend/BUILD.gn b/chromecast/media/cma/backend/BUILD.gn
index 359e67b..fafba44 100644
--- a/chromecast/media/cma/backend/BUILD.gn
+++ b/chromecast/media/cma/backend/BUILD.gn
@@ -25,6 +25,5 @@ source_set("backend") {
 
   deps = [
     "//base",
-    "//chromecast:chromecast_features",
   ]
 }
diff --git a/chromecast/media/cma/backend/alsa/stream_mixer_alsa.cc b/chromecast/media/cma/backend/alsa/stream_mixer_alsa.cc
index 7085eac..67ecc98 100644
--- a/chromecast/media/cma/backend/alsa/stream_mixer_alsa.cc
+++ b/chromecast/media/cma/backend/alsa/stream_mixer_alsa.cc
@@ -895,7 +895,7 @@ void StreamMixerAlsa::UpdateRenderingDelay(int newly_pushed_frames) {
     return;
   }
 
-  snd_htimestamp_t status_timestamp = {};
+  snd_htimestamp_t status_timestamp;
   alsa_->PcmStatusGetHtstamp(pcm_status_, &status_timestamp);
   rendering_delay_.timestamp_microseconds =
       TimespecToMicroseconds(status_timestamp);
diff --git a/chromecast/media/cma/backend/media_pipeline_backend_manager.cc b/chromecast/media/cma/backend/media_pipeline_backend_manager.cc
index aedcf92..c8e1b22 100644
--- a/chromecast/media/cma/backend/media_pipeline_backend_manager.cc
+++ b/chromecast/media/cma/backend/media_pipeline_backend_manager.cc
@@ -5,22 +5,13 @@
 #include "chromecast/media/cma/backend/media_pipeline_backend_manager.h"
 
 #include <algorithm>
-#include <limits>
 
 #include "base/memory/ptr_util.h"
-#include "chromecast/chromecast_features.h"
 #include "chromecast/media/cma/backend/media_pipeline_backend_wrapper.h"
 #include "chromecast/public/cast_media_shlib.h"
 
 namespace chromecast {
 namespace media {
-namespace {
-#if BUILDFLAG(DISABLE_DISPLAY)
-constexpr int kAudioDecoderLimit = std::numeric_limits<int>::max();
-#else
-constexpr int kAudioDecoderLimit = 2;
-#endif
-}  // namespace
 
 MediaPipelineBackendManager::MediaPipelineBackendManager(
     scoped_refptr<base::SingleThreadTaskRunner> media_task_runner)
@@ -57,7 +48,7 @@ MediaPipelineBackendManager::CreateMediaPipelineBackend(
 bool MediaPipelineBackendManager::IncrementDecoderCount(DecoderType type) {
   DCHECK(media_task_runner_->BelongsToCurrentThread());
   DCHECK(type < NUM_DECODER_TYPES);
-  const int limit = (type == AUDIO_DECODER) ? kAudioDecoderLimit : 1;
+  const int limit = (type == AUDIO_DECODER) ? 2 : 1;
   if (decoder_count_[type] >= limit) {
     LOG(WARNING) << "Decoder limit reached for type " << type;
     return false;
diff --git a/chromecast/media/cma/decoder/DEPS b/chromecast/media/cma/decoder/DEPS
index d17e221..343deac 100644
--- a/chromecast/media/cma/decoder/DEPS
+++ b/chromecast/media/cma/decoder/DEPS
@@ -1,3 +1,4 @@
 include_rules = [
+  "+chromecast/media/cma/base",
   "+media/filters",
 ]
diff --git a/chromecast/public/DEPS b/chromecast/public/DEPS
index 8169095..30d9ea2 100644
--- a/chromecast/public/DEPS
+++ b/chromecast/public/DEPS
@@ -1,9 +1,8 @@
 include_rules = [
    # chromecast/public should not depend on anything Chromium specific
-   # Disallow all chromium-wide dependencies listed in chromium/src/DEPS.
+   "-chromecast",
    "-base",
-   "-build",
-   "-ipc",
-   "-testing",
-   "-url",
+   "-content",
+   "-net",
+   "-ui",
 ]
diff --git a/chromecast/renderer/media/DEPS b/chromecast/renderer/media/DEPS
index 194be1c..af70664 100644
--- a/chromecast/renderer/media/DEPS
+++ b/chromecast/renderer/media/DEPS
@@ -1,3 +1,4 @@
 include_rules = [
-  "+ui/gfx/geometry",
+  "+gpu",
+  "+ui/gfx",
 ]
diff --git a/chromeos/audio/cras_audio_handler.cc b/chromeos/audio/cras_audio_handler.cc
index 8a2f887..6a12d34 100644
--- a/chromeos/audio/cras_audio_handler.cc
+++ b/chromeos/audio/cras_audio_handler.cc
@@ -376,13 +376,6 @@ void CrasAudioHandler::SetOutputVolumePercent(int volume_percent) {
   }
 }
 
-void CrasAudioHandler::SetOutputVolumePercentWithoutNotifyingObservers(
-    int volume_percent,
-    AutomatedVolumeChangeReason reason) {
-  automated_volume_change_reasons_.push_back(reason);
-  SetOutputVolumePercent(volume_percent);
-}
-
 // TODO: Rename the 'Percent' to something more meaningful.
 void CrasAudioHandler::SetInputGainPercent(int gain_percent) {
   // TODO(jennyz): Should we set all input devices' gain to the same level?
@@ -620,36 +613,27 @@ void CrasAudioHandler::OutputNodeVolumeChanged(uint64_t node_id, int volume) {
   output_volume_ = volume;
   audio_pref_handler_->SetVolumeGainValue(*device, volume);
 
-  bool should_notify = true;
-  if (!automated_volume_change_reasons_.empty()) {
-    AutomatedVolumeChangeReason reason =
-        automated_volume_change_reasons_.front();
-    if (reason == VOLUME_CHANGE_INITIALIZING_AUDIO_STATE &&
-        (init_node_id_ != node_id || init_volume_ != volume)) {
-      // A SetOutputNodeVolume request may be dropped if cras isn't ready
-      // during initialization. In this case, we clear the pending automated
-      // volume change reasons as they might also be dropped by cras.
-      LOG(WARNING) << "OutputNodeVolumeChanged signal dropped during the "
-                      "initialization.";
-      automated_volume_change_reasons_.clear();
+  if (initializing_audio_state_) {
+    // Do not notify the observers for volume changed event if CrasAudioHandler
+    // is initializing its state, i.e., the volume change event is in responding
+    // to SetOutputNodeVolume request from intializaing audio state, not
+    // from user action, no need to notify UI to pop uo the volume slider bar.
+    if (init_node_id_ == node_id && init_volume_ == volume) {
+      init_volume_count_--;
+      if (!init_volume_count_)
+        initializing_audio_state_ = false;
+      return;
     } else {
-      // In other cases, sequential AutomatedVolumeChangeReason corresponds to
-      // sequential avoiding notifying observers.
-      should_notify = false;
-      automated_volume_change_reasons_.pop_front();
+      // Reset the initializing_audio_state_ in case SetOutputNodeVolume request
+      // is lost by cras due to cras is not ready when CrasAudioHandler is being
+      // initialized.
+      initializing_audio_state_ = false;
+      init_volume_count_ = 0;
     }
   }
 
-  if (std::find(automated_volume_change_reasons_.begin(),
-                automated_volume_change_reasons_.end(),
-                VOLUME_CHANGE_INITIALIZING_AUDIO_STATE) ==
-      automated_volume_change_reasons_.end())
-    initializing_audio_state_ = false;
-
-  if (should_notify) {
-    FOR_EACH_OBSERVER(AudioObserver, observers_,
-                      OnOutputNodeVolumeChanged(node_id, volume));
-  }
+  FOR_EACH_OBSERVER(AudioObserver, observers_,
+                    OnOutputNodeVolumeChanged(node_id, volume));
 }
 
 void CrasAudioHandler::ActiveOutputNodeChanged(uint64_t node_id) {
@@ -759,11 +743,9 @@ void CrasAudioHandler::SetupAudioOutputState() {
     // by CrasAudioHandler constructor, then by cras server restarting signal,
     // both sending SetOutputNodeVolume requests, and could lead to two
     // OutputNodeVolumeChanged signals.
+    init_volume_count_++;
     init_node_id_ = active_output_node_id_;
     init_volume_ = output_volume_;
-    SetOutputVolumePercentWithoutNotifyingObservers(
-        output_volume_, VOLUME_CHANGE_INITIALIZING_AUDIO_STATE);
-    return;
   }
   SetOutputNodeVolume(active_output_node_id_, output_volume_);
 }
diff --git a/chromeos/audio/cras_audio_handler.h b/chromeos/audio/cras_audio_handler.h
index fbc8114..c911071 100644
--- a/chromeos/audio/cras_audio_handler.h
+++ b/chromeos/audio/cras_audio_handler.h
@@ -38,15 +38,6 @@ class CHROMEOS_EXPORT CrasAudioHandler : public CrasAudioClient::Observer,
                               AudioDeviceCompare> AudioDevicePriorityQueue;
   typedef std::vector<uint64_t> NodeIdList;
 
-  // Volume change reasons that are not user-initiated.
-  enum AutomatedVolumeChangeReason {
-    // Indicates it is from initializing audio state.
-    VOLUME_CHANGE_INITIALIZING_AUDIO_STATE,
-
-    // Indicates it is from restoring volume in maximimize mode screenshot.
-    VOLUME_CHANGE_MAXIMIZE_MODE_SCREENSHOT,
-  };
-
   class AudioObserver {
    public:
     // Called when an active output volume changed.
@@ -164,16 +155,10 @@ class CHROMEOS_EXPORT CrasAudioHandler : public CrasAudioClient::Observer,
   virtual bool has_alternative_input() const;
   virtual bool has_alternative_output() const;
 
-  // Sets all active output devices' volume levels to |volume_percent|, whose
+  // Sets all active output devices' volume level to |volume_percent|, whose
   // range is from 0-100%.
   virtual void SetOutputVolumePercent(int volume_percent);
 
-  // Sets all active output devices' volume levels to |volume_percent|, whose
-  // range is from 0-100%, without notifying observers.
-  virtual void SetOutputVolumePercentWithoutNotifyingObservers(
-      int volume_percent,
-      AutomatedVolumeChangeReason reason);
-
   // Sets all active input devices' gain level to |gain_percent|, whose range is
   // from 0-100%.
   virtual void SetInputGainPercent(int gain_percent);
@@ -447,15 +432,10 @@ class CHROMEOS_EXPORT CrasAudioHandler : public CrasAudioClient::Observer,
 
   bool cras_service_available_ = false;
 
-  // FIFO list of reasons passed to
-  // SetOutputVolumePercentWithoutNotifyingObservers() for which we're still
-  // waiting for OutputNodeVolumeChanged() calls. These are used to suppress
-  // notifications for those changes.
-  std::deque<AutomatedVolumeChangeReason> automated_volume_change_reasons_;
-
   bool initializing_audio_state_ = false;
   int init_volume_;
   uint64_t init_node_id_;
+  int init_volume_count_ = 0;
 
   base::WeakPtrFactory<CrasAudioHandler> weak_ptr_factory_;
 
diff --git a/chromeos/audio/cras_audio_handler_unittest.cc b/chromeos/audio/cras_audio_handler_unittest.cc
index a949bf0..7ec72df 100644
--- a/chromeos/audio/cras_audio_handler_unittest.cc
+++ b/chromeos/audio/cras_audio_handler_unittest.cc
@@ -421,11 +421,6 @@ class CrasAudioHandlerTest : public testing::Test {
     return cras_audio_handler_->hdmi_rediscovering();
   }
 
-  void RestartAudioClient() {
-    cras_audio_handler_->AudioClientRestarted();
-    message_loop_.RunUntilIdle();
-  }
-
  protected:
   base::MessageLoopForUI message_loop_;
   CrasAudioHandler* cras_audio_handler_;  // Not owned.
@@ -1977,12 +1972,12 @@ TEST_F(CrasAudioHandlerTest, SetOutputVolumePercent) {
   SetUpCrasAudioHandler(audio_nodes);
   EXPECT_EQ(0, test_observer_->output_volume_changed_count());
 
-  const int kVolume = 60;
-  cras_audio_handler_->SetOutputVolumePercent(kVolume);
+  cras_audio_handler_->SetOutputVolumePercent(60);
 
   // Verify the output volume is changed to the designated value,
   // OnOutputNodeVolumeChanged event is fired, and the device volume value
-  // is saved in the preferences.
+  // is saved the preferences.
+  const int kVolume = 60;
   EXPECT_EQ(kVolume, cras_audio_handler_->GetOutputVolumePercent());
   EXPECT_EQ(1, test_observer_->output_volume_changed_count());
   AudioDevice device;
@@ -1991,111 +1986,6 @@ TEST_F(CrasAudioHandlerTest, SetOutputVolumePercent) {
   EXPECT_EQ(kVolume, audio_pref_handler_->GetOutputVolumeValue(&device));
 }
 
-TEST_F(CrasAudioHandlerTest, SetOutputVolumePercentWithoutNotifyingObservers) {
-  AudioNodeList audio_nodes;
-  audio_nodes.push_back(kInternalSpeaker);
-  SetUpCrasAudioHandler(audio_nodes);
-  EXPECT_EQ(0, test_observer_->output_volume_changed_count());
-
-  const int kVolume1 = 60;
-  const int kVolume2 = 80;
-  cras_audio_handler_->SetOutputVolumePercentWithoutNotifyingObservers(
-      kVolume1, CrasAudioHandler::VOLUME_CHANGE_MAXIMIZE_MODE_SCREENSHOT);
-  // Verify the output volume is changed to the designated value,
-  // OnOutputNodeVolumeChanged event is not fired, and the device volume value
-  // is saved in the preferences.
-  EXPECT_EQ(kVolume1, cras_audio_handler_->GetOutputVolumePercent());
-  EXPECT_EQ(0, test_observer_->output_volume_changed_count());
-  AudioDevice device;
-  EXPECT_TRUE(cras_audio_handler_->GetPrimaryActiveOutputDevice(&device));
-  EXPECT_EQ(device.id, kInternalSpeaker.id);
-  EXPECT_EQ(kVolume1, audio_pref_handler_->GetOutputVolumeValue(&device));
-
-  // Make another SetOutputVolumePercentWithoutNotifyingObservers call to make
-  // sure everything is right.
-  cras_audio_handler_->SetOutputVolumePercentWithoutNotifyingObservers(
-      kVolume2, CrasAudioHandler::VOLUME_CHANGE_MAXIMIZE_MODE_SCREENSHOT);
-  EXPECT_EQ(kVolume2, cras_audio_handler_->GetOutputVolumePercent());
-  EXPECT_EQ(0, test_observer_->output_volume_changed_count());
-  EXPECT_TRUE(cras_audio_handler_->GetPrimaryActiveOutputDevice(&device));
-  EXPECT_EQ(device.id, kInternalSpeaker.id);
-  EXPECT_EQ(kVolume2, audio_pref_handler_->GetOutputVolumeValue(&device));
-
-  // Make a final SetOutputVolumePercent call to check if
-  // SetOutputVolumePercentWithoutNotifyingObservers may block subsequent
-  // notifying observers.
-  cras_audio_handler_->SetOutputVolumePercent(kVolume1);
-  EXPECT_EQ(kVolume1, cras_audio_handler_->GetOutputVolumePercent());
-  EXPECT_EQ(1, test_observer_->output_volume_changed_count());
-  EXPECT_TRUE(cras_audio_handler_->GetPrimaryActiveOutputDevice(&device));
-  EXPECT_EQ(device.id, kInternalSpeaker.id);
-  EXPECT_EQ(kVolume1, audio_pref_handler_->GetOutputVolumeValue(&device));
-}
-
-TEST_F(CrasAudioHandlerTest, RestartAudioClientWithCrasReady) {
-  AudioNodeList audio_nodes;
-  audio_nodes.push_back(kInternalSpeaker);
-  SetUpCrasAudioHandler(audio_nodes);
-  EXPECT_EQ(0, test_observer_->output_volume_changed_count());
-
-  const int kDefaultVolume = cras_audio_handler_->GetOutputVolumePercent();
-  // Disable the auto OutputNodeVolumeChanged signal.
-  fake_cras_audio_client_->set_notify_volume_change_with_delay(true);
-
-  fake_cras_audio_client_->SetAudioNodesForTesting(audio_nodes);
-  RestartAudioClient();
-  EXPECT_EQ(0, test_observer_->output_volume_changed_count());
-  EXPECT_EQ(kDefaultVolume, cras_audio_handler_->GetOutputVolumePercent());
-
-  // The correct initialization OutputNodeVolumeChanged event is fired. We
-  // should avoid notifying observers.
-  fake_cras_audio_client_->NotifyOutputNodeVolumeChangedForTesting(
-      kInternalSpeaker.id, kDefaultVolume);
-  EXPECT_EQ(0, test_observer_->output_volume_changed_count());
-  EXPECT_EQ(kDefaultVolume, cras_audio_handler_->GetOutputVolumePercent());
-
-  // The later OutputNodeVolumeChanged event after initialization should notify
-  // observers.
-  const int kVolume = 60;
-  fake_cras_audio_client_->NotifyOutputNodeVolumeChangedForTesting(
-      kInternalSpeaker.id, kVolume);
-  EXPECT_EQ(1, test_observer_->output_volume_changed_count());
-  EXPECT_EQ(kVolume, cras_audio_handler_->GetOutputVolumePercent());
-}
-
-TEST_F(CrasAudioHandlerTest, RestartAudioClientWithCrasDropRequest) {
-  AudioNodeList audio_nodes;
-  audio_nodes.push_back(kInternalSpeaker);
-  SetUpCrasAudioHandler(audio_nodes);
-  EXPECT_EQ(0, test_observer_->output_volume_changed_count());
-
-  const int kDefaultVolume = cras_audio_handler_->GetOutputVolumePercent();
-  // Disable the auto OutputNodeVolumeChanged signal.
-  fake_cras_audio_client_->set_notify_volume_change_with_delay(true);
-
-  fake_cras_audio_client_->SetAudioNodesForTesting(audio_nodes);
-  RestartAudioClient();
-  EXPECT_EQ(0, test_observer_->output_volume_changed_count());
-  EXPECT_EQ(kDefaultVolume, cras_audio_handler_->GetOutputVolumePercent());
-
-  // A wrong initialization OutputNodeVolumeChanged event is fired. This may
-  // happen when Cras is not ready and drops request. The approach we use is
-  // to log warning message, clear the pending automated volume change reasons,
-  // and notify observers about this change.
-  const int kVolume1 = 30;
-  fake_cras_audio_client_->NotifyOutputNodeVolumeChangedForTesting(
-      kInternalSpeaker.id, kVolume1);
-  EXPECT_EQ(1, test_observer_->output_volume_changed_count());
-  EXPECT_EQ(kVolume1, cras_audio_handler_->GetOutputVolumePercent());
-
-  // The later OutputNodeVolumeChanged event should notify observers.
-  const int kVolume2 = 60;
-  fake_cras_audio_client_->NotifyOutputNodeVolumeChangedForTesting(
-      kInternalSpeaker.id, kVolume2);
-  EXPECT_EQ(2, test_observer_->output_volume_changed_count());
-  EXPECT_EQ(kVolume2, cras_audio_handler_->GetOutputVolumePercent());
-}
-
 TEST_F(CrasAudioHandlerTest, SetOutputVolumeWithDelayedSignal) {
   AudioNodeList audio_nodes;
   audio_nodes.push_back(kInternalSpeaker);
diff --git a/chromeos/chromeos_switches.cc b/chromeos/chromeos_switches.cc
index 3eed80f..5d4c3eb 100644
--- a/chromeos/chromeos_switches.cc
+++ b/chromeos/chromeos_switches.cc
@@ -9,34 +9,12 @@
 #include "base/command_line.h"
 #include "base/metrics/field_trial.h"
 
+// TODO(rsorokin): alphabetize all of these switches so they
+// match the order from the .h file
+
 namespace chromeos {
 namespace switches {
 
-namespace {
-
-// The memory pressure thresholds selection which is used to decide whether and
-// when a memory pressure event needs to get fired.
-const char kMemoryPressureExperimentName[] = "ChromeOSMemoryPressureHandling";
-const char kMemoryPressureHandlingOff[] = "memory-pressure-off";
-
-// Controls CrOS GaiaId migration for tests ("" is default).
-const char kTestCrosGaiaIdMigration[] = "test-cros-gaia-id-migration";
-
-// Value for kTestCrosGaiaIdMigration indicating that migration is started (i.e.
-// all stored user keys will be converted to GaiaId)
-const char kTestCrosGaiaIdMigrationStarted[] = "started";
-
-}  // namespace
-
-// Please keep the order of these switches synchronized with the header file
-// (i.e. in alphabetical order).
-
-const char kAggressiveCacheDiscardThreshold[] = "aggressive-cache-discard";
-
-const char kAggressiveTabDiscardThreshold[] = "aggressive-tab-discard";
-
-const char kAggressiveThreshold[] = "aggressive";
-
 // If this flag is set, enable data roaming in the cellular network by default
 // upon system start if it's an unmanaged device. This flag is used by Rialto
 // device to obtain device policy during OOBE since the Rialto device has no
@@ -58,42 +36,19 @@ const char kAllowRAInDevMode[] = "allow-ra-in-dev-mode";
 // Path for app's OEM manifest file.
 const char kAppOemManifestFile[] = "app-mode-oem-manifest";
 
-// Screenshot testing: specifies the directoru where artifacts will be stored.
-const char kArtifactsDir[] = "artifacts-dir";
-
 // When wallpaper boot animation is not disabled this switch
 // is used to override OOBE/sign in WebUI init type.
 // Possible values: parallel|postpone. Default: parallel.
 const char kAshWebUIInit[] = "ash-webui-init";
 
-// Default large wallpaper to use for kids accounts (as path to trusted,
-// non-user-writable JPEG file).
+// Default wallpaper to use for kids accounts
+// (as paths to trusted, non-user-writable JPEG files).
 const char kChildWallpaperLarge[] = "child-wallpaper-large";
-
-// Default small wallpaper to use for kids accounts (as path to trusted,
-// non-user-writable JPEG file).
 const char kChildWallpaperSmall[] = "child-wallpaper-small";
 
-const char kConservativeThreshold[] = "conservative";
-
 // Specifies the URL of the consumer device management backend.
 const char kConsumerDeviceManagementUrl[] = "consumer-device-management-url";
 
-// Forces CrOS region value.
-const char kCrosRegion[] = "cros-region";
-
-// Control regions data load ("" is default).
-const char kCrosRegionsMode[] = "cros-regions-mode";
-
-// "Override" value for kCrosRegionsMode (region's data is read first).
-const char kCrosRegionsModeOverride[] = "override";
-
-// "Hide" value for kCrosRegionsMode (VPD values are hidden).
-const char kCrosRegionsModeHide[] = "hide";
-
-// Optional value for Data Saver prompt on cellular networks.
-const char kDataSaverPromptDemoMode[] = "demo";
-
 // Forces the stub implementation of dbus clients.
 const char kDbusStub[] = "dbus-stub";
 
@@ -106,12 +61,8 @@ const char kDbusUnstubClients[] = "dbus-unstub-clients";
 // downloadable from Google).
 const char kDefaultWallpaperIsOem[] = "default-wallpaper-is-oem";
 
-// Default large wallpaper to use (as path to trusted, non-user-writable JPEG
-// file).
+// Default wallpaper to use (as paths to trusted, non-user-writable JPEG files).
 const char kDefaultWallpaperLarge[] = "default-wallpaper-large";
-
-// Default small wallpaper to use (as path to trusted, non-user-writable JPEG
-// file).
 const char kDefaultWallpaperSmall[] = "default-wallpaper-small";
 
 // Time in seconds before a machine at OOBE is considered derelict.
@@ -129,95 +80,55 @@ const char kDisableArcOptInVerification[] = "disable-arc-opt-in-verification";
 // Disables wallpaper boot animation (except of OOBE case).
 const char kDisableBootAnimation[] = "disable-boot-animation";
 
-// Disables bypass proxy for captive portal authorization.
-const char kDisableCaptivePortalBypassProxy[] =
-    "disable-captive-portal-bypass-proxy";
-
 // Disables cloud backup feature.
 const char kDisableCloudImport[] = "disable-cloud-import";
 
-// Disables Data Saver prompt on cellular networks.
-const char kDisableDataSaverPrompt[] = "disable-datasaver-prompt";
-
-// Disables the Chrome OS demo.
+// Disables the ChromeOS demo.
 const char kDisableDemoMode[] = "disable-demo-mode";
 
-// If this switch is set, the device cannot be remotely disabled by its owner.
-const char kDisableDeviceDisabling[] = "disable-device-disabling";
-
-// Disables notification when device is in end of life status.
-const char kDisableEolNotification[] = "disable-eol-notification";
-
 // Disables quick view in Files app.
 const char kDisableFilesQuickView[] = "disable-files-quick-view";
 
-// Disables GAIA services such as enrollment and OAuth session restore. Used by
-// 'fake' telemetry login.
-const char kDisableGaiaServices[] = "disable-gaia-services";
-
-// Disables HID-detection OOBE screen.
+// Disable HID-detection OOBE screen.
 const char kDisableHIDDetectionOnOOBE[] = "disable-hid-detection-on-oobe";
 
 // Avoid doing expensive animations upon login.
 const char kDisableLoginAnimations[] = "disable-login-animations";
 
-// Disables mtp write support.
-const char kDisableMtpWriteSupport[] = "disable-mtp-write-support";
-
-// Disables the multiple display layout UI.
-const char kDisableMultiDisplayLayout[] = "disable-multi-display-layout";
-
-// Disables notifications about captive portals in session.
-const char kDisableNetworkPortalNotification[] =
-    "disable-network-portal-notification";
-
-// Disables new channel switcher UI.
+// Disable new channel switcher UI.
 const char kDisableNewChannelSwitcherUI[] = "disable-new-channel-switcher-ui";
 
 // Disables new Kiosk UI when kiosk apps are represented as user pods.
 const char kDisableNewKioskUI[] = "disable-new-kiosk-ui";
 
-// Disables the new Korean IME in chrome://settings/languages.
-const char kDisableNewKoreanIme[] = "disable-new-korean-ime";
-
 // Disables the new File System Provider API based ZIP unpacker.
 const char kDisableNewZIPUnpacker[] = "disable-new-zip-unpacker";
 
-// Disables Office Editing for Docs, Sheets & Slides component app so handlers
+// Disable Office Editing for Docs, Sheets & Slides component app so handlers
 // won't be registered, making it possible to install another version for
 // testing.
 const char kDisableOfficeEditingComponentApp[] =
     "disable-office-editing-component-extension";
 
-// Disables suggestions while typing on a physical keyboard.
-const char kDisablePhysicalKeyboardAutocorrect[] =
-    "disable-physical-keyboard-autocorrect";
-
 // Disables rollback option on reset screen.
 const char kDisableRollbackOption[] = "disable-rollback-option";
 
 // Disables experimental storage manager to manage local storage.
 const char kDisableStorageManager[] = "disable-storage-manager";
 
-// Disables SystemTimezoneAutomaticDetection policy.
-const char kDisableSystemTimezoneAutomaticDetectionPolicy[] =
-    "disable-system-timezone-automatic-detection";
-
-// Disables automatic timezone update.
-const char kDisableTimeZoneTrackingOption[] =
-    "disable-timezone-tracking-option";
-
 // Disables volume adjust sound.
 const char kDisableVolumeAdjustSound[] = "disable-volume-adjust-sound";
 
 // Disables wake on wifi features.
 const char kDisableWakeOnWifi[] = "disable-wake-on-wifi";
 
-// EAFE path to use for Easy bootstrapping.
-const char kEafePath[] = "eafe-path";
+// Disables notifications about captive portals in session.
+const char kDisableNetworkPortalNotification[] =
+    "disable-network-portal-notification";
 
-// EAFE URL to use for Easy bootstrapping.
+// EAFE url and path to use for Easy bootstrapping.
 const char kEafeUrl[] = "eafe-url";
+const char kEafePath[] = "eafe-path";
 
 // Enables starting the ARC instance upon session start.
 const char kEnableArc[] = "enable-arc";
@@ -226,43 +137,53 @@ const char kEnableArc[] = "enable-arc";
 // locate the device.
 const char kEnableConsumerManagement[] = "enable-consumer-management";
 
-// Enables Data Saver prompt on cellular networks.
-const char kEnableDataSaverPrompt[] = "enable-datasaver-prompt";
-
-// Shows additional checkboxes in Settings to enable Chrome OS accessibility
-// features that haven't launched yet.
-const char kEnableExperimentalAccessibilityFeatures[] =
-    "enable-experimental-accessibility-features";
-
-// Enables sharing assets for installed default apps.
-const char kEnableExtensionAssetsSharing[] = "enable-extension-assets-sharing";
-
 // Enables details panel in Files app.
 const char kEnableFilesDetailsPanel[] = "enable-files-details-panel";
 
 // Enables quick view in Files app.
 const char kEnableFilesQuickView[] = "enable-files-quick-view";
 
-// Enables animated transitions during first-run tutorial.
-const char kEnableFirstRunUITransitions[] = "enable-first-run-ui-transitions";
+// Disables notification when device is in end of life status.
+const char kDisableEolNotification[] = "disable-eol-notification";
 
-// Enables Kiosk mode for Chrome OS. Note this switch refers to retail mode
-// rather than the kiosk app mode.
-const char kEnableKioskMode[] = "enable-kiosk-mode";
+// If this switch is set, the device cannot be remotely disabled by its owner.
+const char kDisableDeviceDisabling[] = "disable-device-disabling";
 
-// Enables material design OOBE UI.
-const char kEnableMdOobe[] = "enable-md-oobe";
+// If this switch is set, the new Korean IME will not be available in
+// chrome://settings/languages.
+const char kDisableNewKoreanIme[] = "disable-new-korean-ime";
 
-// Enables notifications about captive portals in session.
-const char kEnableNetworkPortalNotification[] =
-    "enable-network-portal-notification";
+// Disables mtp write support.
+const char kDisableMtpWriteSupport[] = "disable-mtp-write-support";
+
+// Enable the multiple display layout UI.
+const char kDisableMultiDisplayLayout[] = "disable-multi-display-layout";
 
-// Enables suggestions while typing on a physical keyboard.
+// If this switch is set, the options for suggestions as typing on physical
+// keyboard will be enabled.
 const char kEnablePhysicalKeyboardAutocorrect[] =
     "enable-physical-keyboard-autocorrect";
 
-// Enables request of tablet site (via user agent override).
-const char kEnableRequestTabletSite[] = "enable-request-tablet-site";
+// If this switch is set, the options for suggestions as typing on physical
+// keyboard will be disabled.
+const char kDisablePhysicalKeyboardAutocorrect[] =
+    "disable-physical-keyboard-autocorrect";
+
+// Shows additional checkboxes in Settings to enable Chrome OS accessibility
+// features that haven't launched yet.
+const char kEnableExperimentalAccessibilityFeatures[] =
+    "enable-experimental-accessibility-features";
+
+// Enabled sharing assets for installed default apps.
+const char kEnableExtensionAssetsSharing[]  = "enable-extension-assets-sharing";
+
+// Enables notifications about captive portals in session.
+const char kEnableNetworkPortalNotification[] =
+    "enable-network-portal-notification";
+
+// Enables touchpad three-finger-click as middle button.
+const char kEnableTouchpadThreeFingerClick[]
+    = "enable-touchpad-three-finger-click";
 
 // Enables using screenshots in tests and seets mode.
 const char kEnableScreenshotTestingWithMode[] =
@@ -271,13 +192,12 @@ const char kEnableScreenshotTestingWithMode[] =
 // Enables experimental storage manager to manage local storage.
 const char kEnableStorageManager[] = "enable-storage-manager";
 
-// Enables touchpad three-finger-click as middle button.
-const char kEnableTouchpadThreeFingerClick[] =
-    "enable-touchpad-three-finger-click";
+// Enable Kiosk mode for ChromeOS. Note this switch refers to retail mode rather
+// than the kiosk app mode.
+const char kEnableKioskMode[] = "enable-kiosk-mode";
 
-// Enables the chromecast support for video player app.
-const char kEnableVideoPlayerChromecastSupport[] =
-    "enable-video-player-chromecast-support";
+// Enables request of tablet site (via user agent override).
+const char kEnableRequestTabletSite[] = "enable-request-tablet-site";
 
 // Disables ARC for managed accounts.
 const char kEnterpriseDisableArc[] = "enterprise-disable-arc";
@@ -286,10 +206,6 @@ const char kEnterpriseDisableArc[] = "enterprise-disable-arc";
 const char kEnterpriseEnableForcedReEnrollment[] =
     "enterprise-enable-forced-re-enrollment";
 
-// Enables the zero-touch enterprise enrollment flow.
-const char kEnterpriseEnableZeroTouchEnrollment[] =
-    "enterprise-enable-zero-touch-enrollment";
-
 // Power of the power-of-2 initial modulus that will be used by the
 // auto-enrollment client. E.g. "4" means the modulus will be 2^4 = 16.
 const char kEnterpriseEnrollmentInitialModulus[] =
@@ -300,38 +216,36 @@ const char kEnterpriseEnrollmentInitialModulus[] =
 const char kEnterpriseEnrollmentModulusLimit[] =
     "enterprise-enrollment-modulus-limit";
 
+// Enables the zero-touch enterprise enrollment flow.
+const char kEnterpriseEnableZeroTouchEnrollment[] =
+    "enterprise-enable-zero-touch-enrollment";
+
+// Enables the chromecast support for video player app.
+const char kEnableVideoPlayerChromecastSupport[] =
+    "enable-video-player-chromecast-support";
+
 // Passed to Chrome the first time that it's run after the system boots.
 // Not passed on restart after sign out.
 const char kFirstExecAfterBoot[] = "first-exec-after-boot";
 
-// Forces first-run UI to be shown for every login.
-const char kForceFirstRunUI[] = "force-first-run-ui";
-
 // Usually in browser tests the usual login manager bringup is skipped so that
 // tests can change how it's brought up. This flag disables that.
 const char kForceLoginManagerInTests[] = "force-login-manager-in-tests";
 
-// Screenshot testing: specifies the directory where the golden screenshots are
-// stored.
-const char kGoldenScreenshotsDir[] = "golden-screenshots-dir";
-
 // Indicates that the browser is in "browse without sign-in" (Guest session)
 // mode. Should completely disable extensions, sync and bookmarks.
 const char kGuestSession[] = "bwsi";
 
-// Large wallpaper to use in guest mode (as path to trusted, non-user-writable
-// JPEG file).
+// Wallpaper to use in guest mode (as paths to trusted, non-user-writable JPEG
+// files).
 const char kGuestWallpaperLarge[] = "guest-wallpaper-large";
-
-// Small wallpaper to use in guest mode (as path to trusted, non-user-writable
-// JPEG file).
 const char kGuestWallpaperSmall[] = "guest-wallpaper-small";
 
 // If true, the Chromebook has a keyboard with a diamond key.
 const char kHasChromeOSDiamondKey[] = "has-chromeos-diamond-key";
 
 // Defines user homedir. This defaults to primary user homedir.
-const char kHomedir[] = "homedir";
+const char kHomedir[]           = "homedir";
 
 // With this switch, start remora OOBE with the pairing screen.
 const char kHostPairingOobe[] = "host-pairing-oobe";
@@ -356,25 +270,35 @@ const char kLoginProfile[] = "login-profile";
 // Specifies the user which is already logged in.
 const char kLoginUser[] = "login-user";
 
-// The memory pressure threshold selection which is used to decide whether and
+// The memory pressure thresholds selection which is used to decide whether and
 // when a memory pressure event needs to get fired.
+const char kMemoryPressureExperimentName[] = "ChromeOSMemoryPressureHandling";
+const char kMemoryPressureHandlingOff[] = "memory-pressure-off";
 const char kMemoryPressureThresholds[] = "memory-pressure-thresholds";
+const char kConservativeThreshold[] = "conservative";
+const char kAggressiveCacheDiscardThreshold[] = "aggressive-cache-discard";
+const char kAggressiveTabDiscardThreshold[] = "aggressive-tab-discard";
+const char kAggressiveThreshold[] = "aggressive";
 
 // Enables natural scroll by default.
 const char kNaturalScrollDefault[] = "enable-natural-scroll-default";
 
-// Indicates that if we should start bootstrapping Master OOBE.
-const char kOobeBootstrappingMaster[] = "oobe-bootstrapping-master";
-
-// Indicates that a guest session has been started before OOBE completion.
-const char kOobeGuestSession[] = "oobe-guest-session";
-
 // Skips all other OOBE pages after user login.
 const char kOobeSkipPostLogin[] = "oobe-skip-postlogin";
 
+// Disable GAIA services such as enrollment and OAuth session restore. Used by
+// 'fake' telemetry login.
+const char kDisableGaiaServices[] = "disable-gaia-services";
+
 // Interval at which we check for total time on OOBE.
 const char kOobeTimerInterval[] = "oobe-timer-interval";
 
+// Indicates that a guest session has been started before OOBE completion.
+const char kOobeGuestSession[] = "oobe-guest-session";
+
+// Indicates that if we should start bootstrapping Master OOBE.
+const char kOobeBootstrappingMaster[] = "oobe-bootstrapping-master";
+
 // Specifies power stub behavior:
 //  'cycle=2' - Cycles power states every 2 seconds.
 // See FakeDBusThreadManager::ParsePowerCommandLineSwitch for full details.
@@ -411,6 +335,12 @@ const char kStubCrosSettings[] = "stub-cros-settings";
 // done by session manager.
 const char kSystemDevMode[] = "system-developer-mode";
 
+// Enables animated transitions during first-run tutorial.
+const char kEnableFirstRunUITransitions[] = "enable-first-run-ui-transitions";
+
+// Forces first-run UI to be shown for every login.
+const char kForceFirstRunUI[] = "force-first-run-ui";
+
 // Enables testing for auto update UI.
 const char kTestAutoUpdateUI[] = "test-auto-update-ui";
 
@@ -418,6 +348,51 @@ const char kTestAutoUpdateUI[] = "test-auto-update-ui";
 // of network packets from whitelisted sources.
 const char kWakeOnWifiPacket[] = "wake-on-wifi-packet";
 
+// Screenshot testing: specifies the directory where the golden screenshots are
+// stored.
+const char kGoldenScreenshotsDir[] = "golden-screenshots-dir";
+
+// Screenshot testing: specifies the directoru where artifacts will be stored.
+const char kArtifactsDir[] = "artifacts-dir";
+
+// Disable bypass proxy for captive portal authorization.
+const char kDisableCaptivePortalBypassProxy[] =
+    "disable-captive-portal-bypass-proxy";
+
+// Disable automatic timezone update.
+const char kDisableTimeZoneTrackingOption[] =
+    "disable-timezone-tracking-option";
+
+// Switches and optional value for Data Saver prompt on cellular networks.
+const char kDisableDataSaverPrompt[] = "disable-datasaver-prompt";
+const char kEnableDataSaverPrompt[] = "enable-datasaver-prompt";
+const char kDataSaverPromptDemoMode[] = "demo";
+
+// Control regions data load:
+// ""         - default
+// "override" - regions data is read first
+// "hide"     - VPD values are hidden
+const char kCrosRegionsMode[] = "cros-regions-mode";
+const char kCrosRegionsModeOverride[] = "override";
+const char kCrosRegionsModeHide[] = "hide";
+
+// Forces CrOS region value.
+const char kCrosRegion[] = "cros-region";
+
+// Controls CrOS GaiaId migration for tests:
+// ""        - default,
+// "started" - migration started (i.e. all stored user keys will be converted
+//             to GaiaId).
+const char kTestCrosGaiaIdMigration[] = "test-cros-gaia-id-migration";
+const char kTestCrosGaiaIdMigrationStarted[] = "started";
+
+// This flag disables SystemTimezoneAutomaticDetection policy.
+const char kDisableSystemTimezoneAutomaticDetectionPolicy[] =
+    "disable-system-timezone-automatic-detection";
+
+// This flag enables material design OOBE UI.
+const char kEnableMdOobe[] = "enable-md-oobe";
+
 bool WakeOnWifiEnabled() {
   return !base::CommandLine::ForCurrentProcess()->HasSwitch(kDisableWakeOnWifi);
 }
diff --git a/chromeos/chromeos_switches.h b/chromeos/chromeos_switches.h
index 90991a0..7421302 100644
--- a/chromeos/chromeos_switches.h
+++ b/chromeos/chromeos_switches.h
@@ -21,9 +21,6 @@ namespace switches {
 // see chromeos::LoginUtil::GetOffTheRecordCommandLine().)
 
 // Please keep alphabetized.
-CHROMEOS_EXPORT extern const char kAggressiveCacheDiscardThreshold[];
-CHROMEOS_EXPORT extern const char kAggressiveTabDiscardThreshold[];
-CHROMEOS_EXPORT extern const char kAggressiveThreshold[];
 CHROMEOS_EXPORT extern const char kAllowDataRoamingByDefault[];
 CHROMEOS_EXPORT extern const char kAllowFailedPolicyFetchForTest[];
 CHROMEOS_EXPORT extern const char kAllowRAInDevMode[];
@@ -32,26 +29,18 @@ CHROMEOS_EXPORT extern const char kArtifactsDir[];
 CHROMEOS_EXPORT extern const char kAshWebUIInit[];
 CHROMEOS_EXPORT extern const char kChildWallpaperLarge[];
 CHROMEOS_EXPORT extern const char kChildWallpaperSmall[];
-CHROMEOS_EXPORT extern const char kConservativeThreshold[];
 CHROMEOS_EXPORT extern const char kConsumerDeviceManagementUrl[];
-CHROMEOS_EXPORT extern const char kCrosRegion[];
-CHROMEOS_EXPORT extern const char kCrosRegionsMode[];
-CHROMEOS_EXPORT extern const char kCrosRegionsModeHide[];
-CHROMEOS_EXPORT extern const char kCrosRegionsModeOverride[];
-CHROMEOS_EXPORT extern const char kDataSaverPromptDemoMode[];
-CHROMEOS_EXPORT extern const char kDbusStub[];
-CHROMEOS_EXPORT extern const char kDbusUnstubClients[];
 CHROMEOS_EXPORT extern const char kDefaultWallpaperIsOem[];
 CHROMEOS_EXPORT extern const char kDefaultWallpaperLarge[];
 CHROMEOS_EXPORT extern const char kDefaultWallpaperSmall[];
+CHROMEOS_EXPORT extern const char kDbusStub[];
+CHROMEOS_EXPORT extern const char kDbusUnstubClients[];
 CHROMEOS_EXPORT extern const char kDerelictDetectionTimeout[];
 CHROMEOS_EXPORT extern const char kDerelictIdleTimeout[];
 CHROMEOS_EXPORT extern const char kDisableArcDataWipe[];
 CHROMEOS_EXPORT extern const char kDisableArcOptInVerification[];
 CHROMEOS_EXPORT extern const char kDisableBootAnimation[];
-CHROMEOS_EXPORT extern const char kDisableCaptivePortalBypassProxy[];
 CHROMEOS_EXPORT extern const char kDisableCloudImport[];
-CHROMEOS_EXPORT extern const char kDisableDataSaverPrompt[];
 CHROMEOS_EXPORT extern const char kDisableDemoMode[];
 CHROMEOS_EXPORT extern const char kDisableDeviceDisabling[];
 CHROMEOS_EXPORT extern const char kDisableEolNotification[];
@@ -59,35 +48,31 @@ CHROMEOS_EXPORT extern const char kDisableFilesQuickView[];
 CHROMEOS_EXPORT extern const char kDisableGaiaServices[];
 CHROMEOS_EXPORT extern const char kDisableHIDDetectionOnOOBE[];
 CHROMEOS_EXPORT extern const char kDisableLoginAnimations[];
+CHROMEOS_EXPORT extern const char kDisableMemoryPressureSystemChromeOS[];
 CHROMEOS_EXPORT extern const char kDisableMtpWriteSupport[];
 CHROMEOS_EXPORT extern const char kDisableMultiDisplayLayout[];
 CHROMEOS_EXPORT extern const char kDisableNetworkPortalNotification[];
 CHROMEOS_EXPORT extern const char kDisableNewChannelSwitcherUI[];
 CHROMEOS_EXPORT extern const char kDisableNewKioskUI[];
-CHROMEOS_EXPORT extern const char kDisableNewKoreanIme[];
 CHROMEOS_EXPORT extern const char kDisableNewZIPUnpacker[];
 CHROMEOS_EXPORT extern const char kDisableOfficeEditingComponentApp[];
 CHROMEOS_EXPORT extern const char kDisablePhysicalKeyboardAutocorrect[];
 CHROMEOS_EXPORT extern const char kDisableRollbackOption[];
 CHROMEOS_EXPORT extern const char kDisableStorageManager[];
-CHROMEOS_EXPORT extern const char
-    kDisableSystemTimezoneAutomaticDetectionPolicy[];
-CHROMEOS_EXPORT extern const char kDisableTimeZoneTrackingOption[];
 CHROMEOS_EXPORT extern const char kDisableVolumeAdjustSound[];
 CHROMEOS_EXPORT extern const char kDisableWakeOnWifi[];
-CHROMEOS_EXPORT extern const char kEafePath[];
 CHROMEOS_EXPORT extern const char kEafeUrl[];
+CHROMEOS_EXPORT extern const char kEafePath[];
 CHROMEOS_EXPORT extern const char kEnableArc[];
 CHROMEOS_EXPORT extern const char kEnableConsumerManagement[];
-CHROMEOS_EXPORT extern const char kEnableDataSaverPrompt[];
 CHROMEOS_EXPORT extern const char kEnableExperimentalAccessibilityFeatures[];
 CHROMEOS_EXPORT extern const char kEnableExtensionAssetsSharing[];
 CHROMEOS_EXPORT extern const char kEnableFilesDetailsPanel[];
 CHROMEOS_EXPORT extern const char kEnableFilesQuickView[];
 CHROMEOS_EXPORT extern const char kEnableFirstRunUITransitions[];
 CHROMEOS_EXPORT extern const char kEnableKioskMode[];
-CHROMEOS_EXPORT extern const char kEnableMdOobe[];
 CHROMEOS_EXPORT extern const char kEnableNetworkPortalNotification[];
+CHROMEOS_EXPORT extern const char kDisableNewKoreanIme[];
 CHROMEOS_EXPORT extern const char kEnablePhysicalKeyboardAutocorrect[];
 CHROMEOS_EXPORT extern const char kEnableRequestTabletSite[];
 CHROMEOS_EXPORT extern const char kEnableScreenshotTestingWithMode[];
@@ -96,9 +81,9 @@ CHROMEOS_EXPORT extern const char kEnableTouchpadThreeFingerClick[];
 CHROMEOS_EXPORT extern const char kEnableVideoPlayerChromecastSupport[];
 CHROMEOS_EXPORT extern const char kEnterpriseDisableArc[];
 CHROMEOS_EXPORT extern const char kEnterpriseEnableForcedReEnrollment[];
-CHROMEOS_EXPORT extern const char kEnterpriseEnableZeroTouchEnrollment[];
 CHROMEOS_EXPORT extern const char kEnterpriseEnrollmentInitialModulus[];
 CHROMEOS_EXPORT extern const char kEnterpriseEnrollmentModulusLimit[];
+CHROMEOS_EXPORT extern const char kEnterpriseEnableZeroTouchEnrollment[];
 CHROMEOS_EXPORT extern const char kFirstExecAfterBoot[];
 CHROMEOS_EXPORT extern const char kForceFirstRunUI[];
 CHROMEOS_EXPORT extern const char kForceLoginManagerInTests[];
@@ -114,6 +99,10 @@ CHROMEOS_EXPORT extern const char kLoginManager[];
 CHROMEOS_EXPORT extern const char kLoginProfile[];
 CHROMEOS_EXPORT extern const char kLoginUser[];
 CHROMEOS_EXPORT extern const char kMemoryPressureThresholds[];
+CHROMEOS_EXPORT extern const char kConservativeThreshold[];
+CHROMEOS_EXPORT extern const char kAggressiveCacheDiscardThreshold[];
+CHROMEOS_EXPORT extern const char kAggressiveTabDiscardThreshold[];
+CHROMEOS_EXPORT extern const char kAggressiveThreshold[];
 CHROMEOS_EXPORT extern const char kNaturalScrollDefault[];
 CHROMEOS_EXPORT extern const char kOobeBootstrappingMaster[];
 CHROMEOS_EXPORT extern const char kOobeGuestSession[];
@@ -126,21 +115,28 @@ CHROMEOS_EXPORT extern const char kStubCrosSettings[];
 CHROMEOS_EXPORT extern const char kSystemDevMode[];
 CHROMEOS_EXPORT extern const char kTestAutoUpdateUI[];
 CHROMEOS_EXPORT extern const char kWakeOnWifiPacket[];
+CHROMEOS_EXPORT extern const char kDisableCaptivePortalBypassProxy[];
+CHROMEOS_EXPORT extern const char kDisableTimeZoneTrackingOption[];
+CHROMEOS_EXPORT extern const char kDisableDataSaverPrompt[];
+CHROMEOS_EXPORT extern const char kEnableDataSaverPrompt[];
+CHROMEOS_EXPORT extern const char kDataSaverPromptDemoMode[];
+CHROMEOS_EXPORT extern const char kCrosRegionsMode[];
+CHROMEOS_EXPORT extern const char kCrosRegionsModeOverride[];
+CHROMEOS_EXPORT extern const char kCrosRegionsModeHide[];
+CHROMEOS_EXPORT extern const char kCrosRegion[];
+CHROMEOS_EXPORT extern const char kTestCrosGaiaIdMigration[];
+CHROMEOS_EXPORT extern const char kTestCrosGaiaIdMigrationStarted[];
+CHROMEOS_EXPORT extern const char
+    kDisableSystemTimezoneAutomaticDetectionPolicy[];
+CHROMEOS_EXPORT extern const char kEnableMdOobe[];
 
-// Returns true if the system should wake in response to wifi traffic.
 CHROMEOS_EXPORT bool WakeOnWifiEnabled();
 
-// Returns true if memory pressure handling is enabled.
 CHROMEOS_EXPORT bool MemoryPressureHandlingEnabled();
-
-// Returns thresholds for determining if the system is under memory pressure.
 CHROMEOS_EXPORT base::chromeos::MemoryPressureMonitor::MemoryPressureThresholds
 GetMemoryPressureThresholds();
 
-// Returns true if flags are set indicating that stored user keys are being
-// converted to GAIA IDs.
 CHROMEOS_EXPORT bool IsGaiaIdMigrationStarted();
-
 }  // namespace switches
 }  // namespace chromeos
 
diff --git a/components/arc/test/fake_bluetooth_instance.cc b/components/arc/test/fake_bluetooth_instance.cc
index 3d221fb..4db55a2 100644
--- a/components/arc/test/fake_bluetooth_instance.cc
+++ b/components/arc/test/fake_bluetooth_instance.cc
@@ -59,8 +59,8 @@ void FakeBluetoothInstance::OnLEDeviceFound(
     mojom::BluetoothAddressPtr addr,
     int32_t rssi,
     mojo::Array<mojom::BluetoothAdvertisingDataPtr> adv_data) {
-  le_device_found_data_.push_back(base::MakeUnique<LEDeviceFoundData>(
-      std::move(addr), rssi, std::move(adv_data)));
+  le_device_found_data_.push_back(
+      new LEDeviceFoundData(std::move(addr), rssi, std::move(adv_data)));
 }
 
 void FakeBluetoothInstance::OnLEConnectionStateChange(
@@ -75,7 +75,7 @@ void FakeBluetoothInstance::OnGetGattDB(
     mojom::BluetoothAddressPtr remote_addr,
     mojo::Array<mojom::BluetoothGattDBElementPtr> db) {
   gatt_db_result_.push_back(
-      base::MakeUnique<GattDBResult>(std::move(remote_addr), std::move(db)));
+      new GattDBResult(std::move(remote_addr), std::move(db)));
 }
 
 void FakeBluetoothInstance::OnServicesRemoved(
diff --git a/components/arc/test/fake_bluetooth_instance.h b/components/arc/test/fake_bluetooth_instance.h
index d4a5756..336d0b2 100644
--- a/components/arc/test/fake_bluetooth_instance.h
+++ b/components/arc/test/fake_bluetooth_instance.h
@@ -5,7 +5,6 @@
 #ifndef COMPONENTS_ARC_TEST_FAKE_BLUETOOTH_INSTANCE_H_
 #define COMPONENTS_ARC_TEST_FAKE_BLUETOOTH_INSTANCE_H_
 
-#include <memory>
 #include <vector>
 
 #include "base/macros.h"
@@ -123,19 +122,18 @@ class FakeBluetoothInstance : public mojom::BluetoothInstance {
     return device_found_data_;
   }
 
-  const std::vector<std::unique_ptr<LEDeviceFoundData>>& le_device_found_data()
-      const {
+  const std::vector<LEDeviceFoundData*>& le_device_found_data() const {
     return le_device_found_data_;
   }
 
-  const std::vector<std::unique_ptr<GattDBResult>>& gatt_db_result() const {
+  const std::vector<GattDBResult*>& gatt_db_result() const {
     return gatt_db_result_;
   }
 
  private:
   std::vector<mojo::Array<mojom::BluetoothPropertyPtr>> device_found_data_;
-  std::vector<std::unique_ptr<LEDeviceFoundData>> le_device_found_data_;
-  std::vector<std::unique_ptr<GattDBResult>> gatt_db_result_;
+  std::vector<LEDeviceFoundData*> le_device_found_data_;
+  std::vector<GattDBResult*> gatt_db_result_;
 
   DISALLOW_COPY_AND_ASSIGN(FakeBluetoothInstance);
 };
diff --git a/components/autofill/core/browser/BUILD.gn b/components/autofill/core/browser/BUILD.gn
index 994095b..6643319 100644
--- a/components/autofill/core/browser/BUILD.gn
+++ b/components/autofill/core/browser/BUILD.gn
@@ -152,12 +152,17 @@ static_library("browser") {
     ]
   }
 
-  if (is_ios || is_android) {
+  if (is_android) {
     sources += [
       "autofill_assistant.cc",
       "autofill_assistant.h",
       "autofill_credit_card_filling_infobar_delegate_mobile.cc",
       "autofill_credit_card_filling_infobar_delegate_mobile.h",
+    ]
+  }
+
+  if (is_ios || is_android) {
+    sources += [
       "autofill_save_card_infobar_delegate_mobile.cc",
       "autofill_save_card_infobar_delegate_mobile.h",
       "autofill_save_card_infobar_mobile.h",
@@ -325,7 +330,7 @@ source_set("unit_tests") {
     "webdata/web_data_service_unittest.cc",
   ]
 
-  if (is_ios || is_android) {
+  if (is_android) {
     sources += [ "autofill_assistant_unittest.cc" ]
   }
 
diff --git a/components/autofill/core/browser/autofill_assistant.cc b/components/autofill/core/browser/autofill_assistant.cc
index 982dd05..c74776f 100644
--- a/components/autofill/core/browser/autofill_assistant.cc
+++ b/components/autofill/core/browser/autofill_assistant.cc
@@ -27,6 +27,9 @@ void AutofillAssistant::Reset() {
 
 bool AutofillAssistant::CanShowCreditCardAssist(
     const std::vector<FormStructure*>& form_structures) {
+#if !defined(OS_ANDROID)
+  return false;
+#else
   if (!IsAutofillCreditCardAssistEnabled() || credit_card_form_data_)
     return false;
 
@@ -37,6 +40,7 @@ bool AutofillAssistant::CanShowCreditCardAssist(
     }
   }
   return !!credit_card_form_data_;
+#endif
 }
 
 void AutofillAssistant::ShowAssistForCreditCard(const CreditCard& card) {
diff --git a/components/autofill/core/browser/autofill_credit_card_filling_infobar_delegate_mobile.cc b/components/autofill/core/browser/autofill_credit_card_filling_infobar_delegate_mobile.cc
index c79d465..432bb26 100644
--- a/components/autofill/core/browser/autofill_credit_card_filling_infobar_delegate_mobile.cc
+++ b/components/autofill/core/browser/autofill_credit_card_filling_infobar_delegate_mobile.cc
@@ -23,13 +23,8 @@ AutofillCreditCardFillingInfoBarDelegateMobile::
       had_user_interaction_(false),
       was_shown_(false),
       issuer_icon_id_(CreditCard::IconResourceId(card.type())),
-#if defined(OS_IOS)
-      card_label_(card.TypeAndLastFourDigits()),
-#else
       card_label_(base::string16(kMidlineEllipsis) + card.LastFourDigits()),
-#endif
-      card_sub_label_(card.AbbreviatedExpirationDateForDisplay()) {
-}
+      card_sub_label_(card.AbbreviatedExpirationDateForDisplay()) {}
 
 AutofillCreditCardFillingInfoBarDelegateMobile::
     ~AutofillCreditCardFillingInfoBarDelegateMobile() {
@@ -47,14 +42,8 @@ int AutofillCreditCardFillingInfoBarDelegateMobile::GetIconId() const {
 
 base::string16 AutofillCreditCardFillingInfoBarDelegateMobile::GetMessageText()
     const {
-#if defined(OS_ANDROID)
   return l10n_util::GetStringUTF16(
       IDS_AUTOFILL_CREDIT_CARD_FILLING_INFOBAR_TITLE);
-#elif defined(OS_IOS)
-  // On iOS the card details are in the title of the infobar.
-  return l10n_util::GetStringFUTF16(
-      IDS_AUTOFILL_CREDIT_CARD_FILLING_INFOBAR_FORMATTED_TITLE, card_label_);
-#endif
 }
 
 void AutofillCreditCardFillingInfoBarDelegateMobile::InfoBarDismissed() {
diff --git a/components/autofill/core/browser/autofill_experiments.cc b/components/autofill/core/browser/autofill_experiments.cc
index 102af86..03731e9 100644
--- a/components/autofill/core/browser/autofill_experiments.cc
+++ b/components/autofill/core/browser/autofill_experiments.cc
@@ -46,11 +46,7 @@ bool IsAutofillCreditCardSigninPromoEnabled() {
 }
 
 bool IsAutofillCreditCardAssistEnabled() {
-#if !defined(OS_ANDROID) && !defined(OS_IOS)
-  return false;
-#else
   return base::FeatureList::IsEnabled(kAutofillCreditCardAssist);
-#endif
 }
 
 int GetCreditCardSigninPromoImpressionLimit() {
diff --git a/components/autofill/core/browser/autofill_manager.cc b/components/autofill/core/browser/autofill_manager.cc
index 711ffb4..d8c306c 100644
--- a/components/autofill/core/browser/autofill_manager.cc
+++ b/components/autofill/core/browser/autofill_manager.cc
@@ -208,7 +208,7 @@ AutofillManager::AutofillManager(
       user_did_accept_upload_prompt_(false),
       external_delegate_(NULL),
       test_delegate_(NULL),
-#if defined(OS_ANDROID) || defined(OS_IOS)
+#if defined(OS_ANDROID)
       autofill_assistant_(this),
 #endif
       weak_ptr_factory_(this) {
@@ -1289,7 +1289,7 @@ void AutofillManager::Reset() {
       new AutofillMetrics::FormEventLogger(false /* is_for_credit_card */));
   credit_card_form_event_logger_.reset(
       new AutofillMetrics::FormEventLogger(true /* is_for_credit_card */));
-#if defined(OS_ANDROID) || defined(OS_IOS)
+#if defined(OS_ANDROID)
   autofill_assistant_.Reset();
 #endif
   has_logged_autofill_enabled_ = false;
@@ -1331,7 +1331,7 @@ AutofillManager::AutofillManager(AutofillDriver* driver,
       unmasking_query_id_(-1),
       external_delegate_(NULL),
       test_delegate_(NULL),
-#if defined(OS_ANDROID) || defined(OS_IOS)
+#if defined(OS_ANDROID)
       autofill_assistant_(this),
 #endif
       weak_ptr_factory_(this) {
@@ -1782,7 +1782,7 @@ void AutofillManager::ParseForms(const std::vector<FormData>& forms) {
 #endif
   }
 
-#if defined(OS_ANDROID) || defined(OS_IOS)
+#if defined(OS_ANDROID)
   // When a credit card form is parsed and conditions are met, show an infobar
   // prompt for credit card assisted filling. Upon accepting the infobar, the
   // form will automatically be filled with the user's information through this
diff --git a/components/autofill/core/browser/autofill_manager.h b/components/autofill/core/browser/autofill_manager.h
index aacd40e..03026c9 100644
--- a/components/autofill/core/browser/autofill_manager.h
+++ b/components/autofill/core/browser/autofill_manager.h
@@ -32,7 +32,7 @@
 #include "components/autofill/core/browser/personal_data_manager.h"
 #include "components/autofill/core/common/form_data.h"
 
-#if defined(OS_ANDROID) || defined(OS_IOS)
+#if defined(OS_ANDROID)
 #include "components/autofill/core/browser/autofill_assistant.h"
 #endif
 
@@ -538,7 +538,7 @@ class AutofillManager : public AutofillDownloadManager::Observer,
   // Delegate used in test to get notifications on certain events.
   AutofillManagerTestDelegate* test_delegate_;
 
-#if defined(OS_ANDROID) || defined(OS_IOS)
+#if defined(OS_ANDROID)
   AutofillAssistant autofill_assistant_;
 #endif
 
diff --git a/components/autofill/core/browser/credit_card.cc b/components/autofill/core/browser/credit_card.cc
index 9cf49dc..a37f16f 100644
--- a/components/autofill/core/browser/credit_card.cc
+++ b/components/autofill/core/browser/credit_card.cc
@@ -134,6 +134,9 @@ base::string16 CreditCard::TypeForDisplay(const std::string& type) {
   return ::autofill::TypeForFill(type);
 }
 
+// This method is not compiled on iOS because the resources are not used and
+// should not be shipped.
+#if !defined(OS_IOS)
 // static
 int CreditCard::IconResourceId(const std::string& type) {
   if (type == kAmericanExpressCard)
@@ -156,6 +159,7 @@ int CreditCard::IconResourceId(const std::string& type) {
   DCHECK_EQ(kGenericCard, type);
   return IDR_AUTOFILL_CC_GENERIC;
 }
+#endif  // #if !defined(OS_IOS)
 
 // static
 const char* CreditCard::GetCreditCardType(const base::string16& number) {
diff --git a/components/autofill/core/browser/credit_card.h b/components/autofill/core/browser/credit_card.h
index db9712a..3a73533 100644
--- a/components/autofill/core/browser/credit_card.h
+++ b/components/autofill/core/browser/credit_card.h
@@ -65,8 +65,14 @@ class CreditCard : public AutofillDataModel {
   // The user-visible type of the card, e.g. 'Mastercard'.
   static base::string16 TypeForDisplay(const std::string& type);
 
+// This method is not compiled on iOS because the resources are not used and
+// should not be shipped.
+// TODO(jdonnelly): Use credit card issuer images on iOS.
+// http://crbug.com/535784
+#if !defined(OS_IOS)
   // The ResourceBundle ID for the appropriate credit card image.
   static int IconResourceId(const std::string& type);
+#endif  // #if !defined(OS_IOS)
 
   // Returns the internal representation of credit card type corresponding to
   // the given |number|.  The credit card type is determined purely according to
diff --git a/components/autofill_strings.grdp b/components/autofill_strings.grdp
index 6251dad..1c8fef8 100644
--- a/components/autofill_strings.grdp
+++ b/components/autofill_strings.grdp
@@ -175,21 +175,12 @@
   </message>
 
   <!-- Autofill Credit Card Assisted Filling Infobar -->
-  <if expr="is_android">
-    <message name="IDS_AUTOFILL_CREDIT_CARD_FILLING_INFOBAR_TITLE" desc="Title text for the Autofill Credit Card Assisted Filling Infobar">
-      Do you want to fill in your card info?
-    </message>
-  </if>
-  <if expr="is_ios">
-    <message name="IDS_AUTOFILL_CREDIT_CARD_FILLING_INFOBAR_FORMATTED_TITLE" desc="Title text for the Autofill Credit Card Assisted Filling Infobar, which contains the card description in it.">
-      Do you want to fill in your <ph name="CARD_DETAIL">$1<ex>Visa - 1234</ex></ph>?
-    </message>
-  </if>
-  <if expr="is_android or is_ios">
-    <message name="IDS_AUTOFILL_CREDIT_CARD_FILLING_INFOBAR_ACCEPT" desc="Text to show for the Autofill credit card Assisted Filling infobar accept button.">
-      Fill in
-    </message>
-  </if>
+  <message name="IDS_AUTOFILL_CREDIT_CARD_FILLING_INFOBAR_TITLE" desc="Title text for the Autofill Credit Card Assisted Filling Infobar">
+    Do you want to fill in your card info?
+  </message>
+  <message name="IDS_AUTOFILL_CREDIT_CARD_FILLING_INFOBAR_ACCEPT" desc="Text to show for the Autofill credit card Assisted Filling infobar accept button.">
+    Fill in
+  </message>
 
   <!-- Autofill save credit card bubble or infobar prompt -->
   <message name="IDS_AUTOFILL_SAVE_CARD_PROMPT_ACCEPT" desc="Text to show for the Autofill save credit card prompt accept button. The prompt can be either a bubble or an infobar.">
diff --git a/components/components_tests.gyp b/components/components_tests.gyp
index 44a6c44..0ebb2f0 100644
--- a/components/components_tests.gyp
+++ b/components/components_tests.gyp
@@ -822,7 +822,6 @@
       'subresource_filter/core/common/knuth_morris_pratt_unittest.cc',
       'subresource_filter/core/common/ngram_extractor_unittest.cc',
       'subresource_filter/core/common/string_splitter_unittest.cc',
-      'subresource_filter/core/common/unindexed_ruleset_unittest.cc',
       'subresource_filter/core/common/url_pattern_matching_unittest.cc',
     ],
     'suggestions_unittest_sources': [
diff --git a/components/content_settings/core/browser/host_content_settings_map.cc b/components/content_settings/core/browser/host_content_settings_map.cc
index 1805e9c..5167543 100644
--- a/components/content_settings/core/browser/host_content_settings_map.cc
+++ b/components/content_settings/core/browser/host_content_settings_map.cc
@@ -524,6 +524,7 @@ void HostContentSettingsMap::MigrateDomainScopedSettings(bool after_sync) {
   DCHECK(status != NOT_MIGRATED || !after_sync);
 
   const ContentSettingsType kDomainScopedTypes[] = {
+      CONTENT_SETTINGS_TYPE_COOKIES,
       CONTENT_SETTINGS_TYPE_IMAGES,
       CONTENT_SETTINGS_TYPE_PLUGINS,
       CONTENT_SETTINGS_TYPE_JAVASCRIPT,
diff --git a/components/cronet/android/BUILD.gn b/components/cronet/android/BUILD.gn
index 5789189..3f3ed4b 100644
--- a/components/cronet/android/BUILD.gn
+++ b/components/cronet/android/BUILD.gn
@@ -666,10 +666,16 @@ instrumentation_test_apk("cronet_test_instrumentation_apk") {
   ]
   additional_apks = [ "//net/android:net_test_support_apk" ]
 
-  data_deps = [
-    "//net:test_support",
+  data = [
+    "//net/data/ssl/certificates/quic_test.example.com.crt",
+    "//net/data/ssl/certificates/quic_test.example.com.key",
+    "//net/data/ssl/certificates/quic_test.example.com.key.pkcs8",
+    "//net/data/ssl/certificates/quic_test.example.com.key.sct",
   ]
 
+  # TODO(jbudorick): Remove this once GN uses the generated .isolate files.
+  isolate_file = "cronet_test_instrumentation_apk.isolate"
+
   run_findbugs_override = true
 }
 
diff --git a/components/cronet/android/chromium_url_request.cc b/components/cronet/android/chromium_url_request.cc
index 178307b..e52d6f4 100644
--- a/components/cronet/android/chromium_url_request.cc
+++ b/components/cronet/android/chromium_url_request.cc
@@ -16,8 +16,6 @@
 
 using base::android::ConvertUTF8ToJavaString;
 using base::android::ConvertJavaStringToUTF8;
-using base::android::JavaParamRef;
-using base::android::ScopedJavaLocalRef;
 
 namespace cronet {
 namespace {
diff --git a/components/cronet/android/chromium_url_request_context.cc b/components/cronet/android/chromium_url_request_context.cc
index 6d6bc16..b14f547 100644
--- a/components/cronet/android/chromium_url_request_context.cc
+++ b/components/cronet/android/chromium_url_request_context.cc
@@ -22,8 +22,6 @@
 
 using base::android::ConvertUTF8ToJavaString;
 using base::android::ConvertJavaStringToUTF8;
-using base::android::JavaParamRef;
-using base::android::ScopedJavaLocalRef;
 
 namespace {
 
diff --git a/components/cronet/android/cronet_bidirectional_stream_adapter.cc b/components/cronet/android/cronet_bidirectional_stream_adapter.cc
index d4a75ed..90ccb4c 100644
--- a/components/cronet/android/cronet_bidirectional_stream_adapter.cc
+++ b/components/cronet/android/cronet_bidirectional_stream_adapter.cc
@@ -32,7 +32,6 @@
 
 using base::android::ConvertUTF8ToJavaString;
 using base::android::ConvertJavaStringToUTF8;
-using base::android::ScopedJavaLocalRef;
 
 namespace cronet {
 
diff --git a/components/cronet/android/cronet_library_loader.cc b/components/cronet/android/cronet_library_loader.cc
index 79d6939..55929ef 100644
--- a/components/cronet/android/cronet_library_loader.cc
+++ b/components/cronet/android/cronet_library_loader.cc
@@ -36,9 +36,6 @@
 #include "base/i18n/icu_util.h"  // nogncheck
 #endif
 
-using base::android::JavaParamRef;
-using base::android::ScopedJavaLocalRef;
-
 namespace cronet {
 namespace {
 
diff --git a/components/cronet/android/cronet_test_instrumentation_apk.isolate b/components/cronet/android/cronet_test_instrumentation_apk.isolate
new file mode 100644
index 0000000..984c8fb
--- /dev/null
+++ b/components/cronet/android/cronet_test_instrumentation_apk.isolate
@@ -0,0 +1,14 @@
+# Copyright 2016 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+
+{
+  'variables': {
+    'files': [
+      '<(DEPTH)/net/data/ssl/certificates/quic_test.example.com.crt',
+      '<(DEPTH)/net/data/ssl/certificates/quic_test.example.com.key',
+      '<(DEPTH)/net/data/ssl/certificates/quic_test.example.com.key.pkcs8',
+      '<(DEPTH)/net/data/ssl/certificates/quic_test.example.com.key.sct',
+    ],
+  },
+}
diff --git a/components/cronet/android/cronet_upload_data_stream_adapter.cc b/components/cronet/android/cronet_upload_data_stream_adapter.cc
index dabcfbb..351c42c 100644
--- a/components/cronet/android/cronet_upload_data_stream_adapter.cc
+++ b/components/cronet/android/cronet_upload_data_stream_adapter.cc
@@ -16,8 +16,6 @@
 #include "components/cronet/android/cronet_url_request_adapter.h"
 #include "jni/CronetUploadDataStream_jni.h"
 
-using base::android::JavaParamRef;
-
 namespace cronet {
 
 CronetUploadDataStreamAdapter::CronetUploadDataStreamAdapter(
diff --git a/components/cronet/android/cronet_url_request_adapter.cc b/components/cronet/android/cronet_url_request_adapter.cc
index 2e7d84d..97f336e 100644
--- a/components/cronet/android/cronet_url_request_adapter.cc
+++ b/components/cronet/android/cronet_url_request_adapter.cc
@@ -29,7 +29,6 @@
 #include "net/url_request/url_request_context.h"
 
 using base::android::ConvertUTF8ToJavaString;
-using base::android::JavaParamRef;
 
 namespace cronet {
 
diff --git a/components/cronet/android/cronet_url_request_context_adapter.cc b/components/cronet/android/cronet_url_request_context_adapter.cc
index b189fc4..f9908ae 100644
--- a/components/cronet/android/cronet_url_request_context_adapter.cc
+++ b/components/cronet/android/cronet_url_request_context_adapter.cc
@@ -64,9 +64,6 @@
 #include "components/cronet/android/cronet_data_reduction_proxy.h"
 #endif
 
-using base::android::JavaParamRef;
-using base::android::ScopedJavaLocalRef;
-
 namespace {
 
 // This class wraps a NetLog that also contains network change events.
diff --git a/components/cronet/android/test/cronet_test_util.cc b/components/cronet/android/test/cronet_test_util.cc
index a4b50c5..2434eb9 100644
--- a/components/cronet/android/test/cronet_test_util.cc
+++ b/components/cronet/android/test/cronet_test_util.cc
@@ -15,8 +15,6 @@
 #include "net/dns/mock_host_resolver.h"
 #include "net/url_request/url_request.h"
 
-using base::android::JavaParamRef;
-
 namespace cronet {
 
 const char kFakeSdchDomain[] = "fake.sdch.domain";
diff --git a/components/cronet/android/test/cronet_url_request_context_config_test.cc b/components/cronet/android/test/cronet_url_request_context_config_test.cc
index c804345..2112077 100644
--- a/components/cronet/android/test/cronet_url_request_context_config_test.cc
+++ b/components/cronet/android/test/cronet_url_request_context_config_test.cc
@@ -14,8 +14,6 @@
 #include "components/cronet/version.h"
 #include "jni/CronetUrlRequestContextTest_jni.h"
 
-using base::android::JavaParamRef;
-
 namespace cronet {
 
 // Verifies that all the configuration options set by
diff --git a/components/cronet/android/test/javatests/src/org/chromium/net/QuicTest.java b/components/cronet/android/test/javatests/src/org/chromium/net/QuicTest.java
index 6088f25..59e134e 100644
--- a/components/cronet/android/test/javatests/src/org/chromium/net/QuicTest.java
+++ b/components/cronet/android/test/javatests/src/org/chromium/net/QuicTest.java
@@ -41,7 +41,6 @@ public class QuicTest extends CronetTestBase {
         mBuilder.addQuicHint(QuicTestServer.getServerHost(), QuicTestServer.getServerPort(),
                 QuicTestServer.getServerPort());
 
-        // TODO(mgersh): Enable connection migration once it works, see http://crbug.com/634910
         JSONObject quicParams = new JSONObject()
                                         .put("connection_options", "PACE,IW10,FOO,DEADBEEF")
                                         .put("host_whitelist", "test.example.com")
@@ -51,8 +50,8 @@ public class QuicTest extends CronetTestBase {
                                         .put("packet_loss_threshold", 0.5)
                                         .put("idle_connection_timeout_seconds", 300)
                                         .put("close_sessions_on_ip_change", false)
-                                        .put("migrate_sessions_on_network_change", false)
-                                        .put("migrate_sessions_early", false)
+                                        .put("migrate_sessions_on_network_change", true)
+                                        .put("migrate_sessions_early", true)
                                         .put("race_cert_verification", true);
         JSONObject experimentalOptions = new JSONObject().put("QUIC", quicParams);
         mBuilder.setExperimentalOptions(experimentalOptions.toString());
diff --git a/components/cronet/android/test/mock_cert_verifier.cc b/components/cronet/android/test/mock_cert_verifier.cc
index d6f7d96..588f340 100644
--- a/components/cronet/android/test/mock_cert_verifier.cc
+++ b/components/cronet/android/test/mock_cert_verifier.cc
@@ -21,8 +21,6 @@
 #include "net/test/cert_test_util.h"
 #include "net/test/test_data_directory.h"
 
-using base::android::JavaParamRef;
-
 namespace cronet {
 
 namespace {
diff --git a/components/cronet/android/test/mock_url_request_job_factory.cc b/components/cronet/android/test/mock_url_request_job_factory.cc
index 092df0a..7602ce8 100644
--- a/components/cronet/android/test/mock_url_request_job_factory.cc
+++ b/components/cronet/android/test/mock_url_request_job_factory.cc
@@ -13,9 +13,6 @@
 #include "net/test/url_request/url_request_mock_data_job.h"
 #include "url/gurl.h"
 
-using base::android::JavaParamRef;
-using base::android::ScopedJavaLocalRef;
-
 namespace cronet {
 
 void AddUrlInterceptors(JNIEnv* env, const JavaParamRef<jclass>& jcaller) {
diff --git a/components/cronet/android/test/native_test_server.cc b/components/cronet/android/test/native_test_server.cc
index 68b9524..34e868b 100644
--- a/components/cronet/android/test/native_test_server.cc
+++ b/components/cronet/android/test/native_test_server.cc
@@ -32,9 +32,6 @@
 #include "net/test/embedded_test_server/request_handler_util.h"
 #include "url/gurl.h"
 
-using base::android::JavaParamRef;
-using base::android::ScopedJavaLocalRef;
-
 namespace cronet {
 
 namespace {
diff --git a/components/cronet/android/test/network_change_notifier_util.cc b/components/cronet/android/test/network_change_notifier_util.cc
index a13afa1..b6444aa 100644
--- a/components/cronet/android/test/network_change_notifier_util.cc
+++ b/components/cronet/android/test/network_change_notifier_util.cc
@@ -11,8 +11,6 @@
 #include "jni/NetworkChangeNotifierUtil_jni.h"
 #include "net/base/network_change_notifier.h"
 
-using base::android::JavaParamRef;
-
 namespace cronet {
 
 namespace {
diff --git a/components/cronet/android/test/quic_test_server.cc b/components/cronet/android/test/quic_test_server.cc
index cbcf2cc..bf09d92 100644
--- a/components/cronet/android/test/quic_test_server.cc
+++ b/components/cronet/android/test/quic_test_server.cc
@@ -21,9 +21,6 @@
 #include "net/tools/quic/quic_in_memory_cache.h"
 #include "net/tools/quic/quic_simple_server.h"
 
-using base::android::JavaParamRef;
-using base::android::ScopedJavaLocalRef;
-
 namespace cronet {
 
 namespace {
diff --git a/components/cronet/android/test/sdch_test_util.cc b/components/cronet/android/test/sdch_test_util.cc
index d6016c9..1aef480 100644
--- a/components/cronet/android/test/sdch_test_util.cc
+++ b/components/cronet/android/test/sdch_test_util.cc
@@ -19,8 +19,6 @@
 #include "net/url_request/url_request_context.h"
 #include "url/gurl.h"
 
-using base::android::JavaParamRef;
-
 namespace cronet {
 
 namespace {
diff --git a/components/cronet/android/test/test_upload_data_stream_handler.cc b/components/cronet/android/test/test_upload_data_stream_handler.cc
index 92de649..7cc6af4 100644
--- a/components/cronet/android/test/test_upload_data_stream_handler.cc
+++ b/components/cronet/android/test/test_upload_data_stream_handler.cc
@@ -14,8 +14,6 @@
 #include "jni/TestUploadDataStreamHandler_jni.h"
 #include "net/base/net_errors.h"
 
-using base::android::JavaParamRef;
-
 namespace cronet {
 
 static const size_t kReadBufferSize = 32768;
diff --git a/components/cronet/tools/cr_cronet.py b/components/cronet/tools/cr_cronet.py
index 75cc5ea..185c43f 100755
--- a/components/cronet/tools/cr_cronet.py
+++ b/components/cronet/tools/cr_cronet.py
@@ -99,7 +99,7 @@ def main():
   gn_args += 'target_os="' + target_os + '" enable_websockets=false '+ \
       'disable_file_support=true disable_ftp_support=true '+ \
       'use_platform_icu_alternatives=true '+ \
-      'disable_brotli_filter=true is_component_build=false'
+      'disable_brotli_filter=true'
 
   extra_options = ' '.join(extra_options_list)
   if options.gn:
diff --git a/components/exo/wayland/server.cc b/components/exo/wayland/server.cc
index ed5ec02..98781a4 100644
--- a/components/exo/wayland/server.cc
+++ b/components/exo/wayland/server.cc
@@ -30,7 +30,6 @@
 #include "ash/common/display/display_info.h"
 #include "ash/common/shell_observer.h"
 #include "ash/common/shell_window_ids.h"
-#include "ash/common/wm/maximize_mode/maximize_mode_controller.h"
 #include "ash/common/wm_shell.h"
 #include "ash/display/display_manager.h"
 #include "ash/shell.h"
@@ -1586,13 +1585,6 @@ class WaylandRemoteShell : public ash::ShellObserver,
     ash::Shell* shell = ash::Shell::GetInstance();
     shell->activation_client()->AddObserver(this);
     display::Screen::GetScreen()->AddObserver(this);
-
-    layout_mode_ = ash::WmShell::Get()
-                           ->maximize_mode_controller()
-                           ->IsMaximizeModeWindowManagerEnabled()
-                       ? ZWP_REMOTE_SHELL_V1_LAYOUT_MODE_TABLET
-                       : ZWP_REMOTE_SHELL_V1_LAYOUT_MODE_WINDOWED;
-
     SendPrimaryDisplayMetrics();
     SendActivated(shell->activation_client()->GetActiveWindow(), nullptr);
   }
diff --git a/components/feedback/feedback_common.cc b/components/feedback/feedback_common.cc
index ef41a27..3fea0b7 100644
--- a/components/feedback/feedback_common.cc
+++ b/components/feedback/feedback_common.cc
@@ -8,7 +8,6 @@
 
 #include "base/memory/ptr_util.h"
 #include "base/strings/string_util.h"
-#include "components/feedback/feedback_util.h"
 #include "components/feedback/proto/common.pb.h"
 #include "components/feedback/proto/dom.pb.h"
 #include "components/feedback/proto/extension.pb.h"
@@ -26,9 +25,6 @@ const char kMultilineIndicatorString[] = "<multiline>\n";
 const char kMultilineStartString[] = "---------- START ----------\n";
 const char kMultilineEndString[] = "---------- END ----------\n\n";
 
-// The below thresholds were chosen arbitrarily to conveniently show small data
-// as part of the report itself without having to look into the system_logs.zip
-// file.
 const size_t kFeedbackMaxLength = 4 * 1024;
 const size_t kFeedbackMaxLineCount = 40;
 
@@ -41,17 +37,6 @@ const char kZipExt[] = ".zip";
 const char kPngMimeType[] = "image/png";
 const char kArbitraryMimeType[] = "application/octet-stream";
 
-// Determine if the given feedback value is small enough to not need to
-// be compressed.
-bool BelowCompressionThreshold(const std::string& content) {
-  if (content.length() > kFeedbackMaxLength)
-    return false;
-  const size_t line_count = std::count(content.begin(), content.end(), '\n');
-  if (line_count > kFeedbackMaxLineCount)
-    return false;
-  return true;
-}
-
 // Converts the system logs into a string that we can compress and send
 // with the report. This method only converts those logs that we want in
 // the compressed zip file sent with the report, hence it ignores any logs
@@ -61,11 +46,13 @@ bool BelowCompressionThreshold(const std::string& content) {
 std::unique_ptr<std::string> LogsToString(
     const FeedbackCommon::SystemLogsMap& sys_info) {
   std::unique_ptr<std::string> syslogs_string(new std::string);
-  for (const auto& iter : sys_info) {
-    std::string key = iter.first;
-    std::string value = iter.second;
+  for (FeedbackCommon::SystemLogsMap::const_iterator it = sys_info.begin();
+       it != sys_info.end();
+       ++it) {
+    std::string key = it->first;
+    std::string value = it->second;
 
-    if (BelowCompressionThreshold(value))
+    if (FeedbackCommon::BelowCompressionThreshold(value))
       continue;
 
     base::TrimString(key, "\n ", &key);
@@ -112,39 +99,88 @@ void AddAttachment(userfeedback::ExtensionSubmit* feedback_data,
 
 }  // namespace
 
-////////////////////////////////////////////////////////////////////////////////
-// FeedbackCommon::AttachedFile::
-////////////////////////////////////////////////////////////////////////////////
-
 FeedbackCommon::AttachedFile::AttachedFile(const std::string& filename,
                                            std::unique_ptr<std::string> data)
     : name(filename), data(std::move(data)) {}
 
 FeedbackCommon::AttachedFile::~AttachedFile() {}
 
-////////////////////////////////////////////////////////////////////////////////
-// FeedbackCommon::
-////////////////////////////////////////////////////////////////////////////////
-
 FeedbackCommon::FeedbackCommon() : product_id_(-1) {}
 
+FeedbackCommon::~FeedbackCommon() {}
+
+// static
+bool FeedbackCommon::BelowCompressionThreshold(const std::string& content) {
+  if (content.length() > kFeedbackMaxLength)
+    return false;
+  const size_t line_count = std::count(content.begin(), content.end(), '\n');
+  if (line_count > kFeedbackMaxLineCount)
+    return false;
+  return true;
+}
+
+void FeedbackCommon::CompressFile(const base::FilePath& filename,
+                                  const std::string& zipname,
+                                  std::unique_ptr<std::string> data) {
+  std::unique_ptr<AttachedFile> file(
+      new AttachedFile(zipname, base::WrapUnique(new std::string())));
+  if (file->name.empty()) {
+    // We need to use the UTF8Unsafe methods here to accomodate Windows, which
+    // uses wide strings to store filepaths.
+    file->name = filename.BaseName().AsUTF8Unsafe();
+    file->name.append(kZipExt);
+  }
+  if (feedback_util::ZipString(filename, *data, file->data.get())) {
+    base::AutoLock lock(attachments_lock_);
+    attachments_.push_back(file.release());
+  }
+}
+
 void FeedbackCommon::AddFile(const std::string& filename,
                              std::unique_ptr<std::string> data) {
   base::AutoLock lock(attachments_lock_);
-  attachments_.emplace_back(new AttachedFile(filename, std::move(data)));
+  attachments_.push_back(new AttachedFile(filename, std::move(data)));
 }
 
 void FeedbackCommon::AddLog(const std::string& name, const std::string& value) {
-  if (!logs_)
+  if (!logs_.get())
     logs_ = base::WrapUnique(new SystemLogsMap);
   (*logs_)[name] = value;
 }
 
 void FeedbackCommon::AddLogs(std::unique_ptr<SystemLogsMap> logs) {
-  if (logs_)
+  if (logs_) {
     logs_->insert(logs->begin(), logs->end());
-  else
+  } else {
     logs_ = std::move(logs);
+  }
+}
+
+void FeedbackCommon::CompressLogs() {
+  if (!logs_)
+    return;
+  std::unique_ptr<std::string> logs = LogsToString(*logs_);
+  if (!logs->empty()) {
+    CompressFile(base::FilePath(kLogsFilename), kLogsAttachmentName,
+                 std::move(logs));
+  }
+}
+
+void FeedbackCommon::AddFilesAndLogsToReport(
+    userfeedback::ExtensionSubmit* feedback_data) const {
+  if (sys_info()) {
+    for (FeedbackCommon::SystemLogsMap::const_iterator i = sys_info()->begin();
+         i != sys_info()->end();
+         ++i) {
+      if (BelowCompressionThreshold(i->second))
+        AddFeedbackData(feedback_data, i->first, i->second);
+    }
+  }
+
+  for (size_t i = 0; i < attachments(); i++) {
+    const AttachedFile* file = attachment(i);
+    AddAttachment(feedback_data, file->name.c_str(), *file->data.get());
+  }
 }
 
 void FeedbackCommon::PrepareReport(
@@ -209,51 +245,3 @@ void FeedbackCommon::PrepareReport(
   if (category_tag().size())
     feedback_data->set_bucket(category_tag());
 }
-
-FeedbackCommon::~FeedbackCommon() {}
-
-void FeedbackCommon::CompressFile(
-    const base::FilePath& filename,
-    const std::string& zipname,
-    std::unique_ptr<std::string> data_to_be_compressed) {
-  std::unique_ptr<std::string> compressed_data(new std::string());
-  if (feedback_util::ZipString(filename, *data_to_be_compressed,
-                               compressed_data.get())) {
-    std::string attachment_file_name = zipname;
-    if (attachment_file_name.empty()) {
-      // We need to use the UTF8Unsafe methods here to accommodate Windows,
-      // which uses wide strings to store file paths.
-      attachment_file_name = filename.BaseName().AsUTF8Unsafe().append(kZipExt);
-    }
-
-    AddFile(attachment_file_name, std::move(compressed_data));
-  }
-}
-
-void FeedbackCommon::CompressLogs() {
-  if (!logs_)
-    return;
-  std::unique_ptr<std::string> logs = LogsToString(*logs_);
-  if (!logs->empty()) {
-    CompressFile(base::FilePath(kLogsFilename), kLogsAttachmentName,
-                 std::move(logs));
-  }
-}
-void FeedbackCommon::AddFilesAndLogsToReport(
-    userfeedback::ExtensionSubmit* feedback_data) const {
-  for (size_t i = 0; i < attachments(); ++i) {
-    const AttachedFile* file = attachment(i);
-    AddAttachment(feedback_data, file->name.c_str(), *file->data);
-  }
-
-  if (!logs_)
-    return;
-
-  for (const auto& iter : *logs_) {
-    if (BelowCompressionThreshold(iter.second)) {
-      // Small enough logs should end up in the report data itself. However,
-      // they're still added as part of the system_logs.zip file.
-      AddFeedbackData(feedback_data, iter.first, iter.second);
-    }
-  }
-}
diff --git a/components/feedback/feedback_common.h b/components/feedback/feedback_common.h
index 2f4016e..7c6d56d 100644
--- a/components/feedback/feedback_common.h
+++ b/components/feedback/feedback_common.h
@@ -12,21 +12,27 @@
 #include <memory>
 #include <string>
 #include <utility>
-#include <vector>
 
 #include "base/files/file_util.h"
 #include "base/memory/ref_counted.h"
+#include "base/memory/scoped_vector.h"
 #include "base/synchronization/lock.h"
 
 namespace userfeedback {
 class ExtensionSubmit;
 }
 
+namespace feedback_util {
+bool ZipString(const base::FilePath& filename,
+               const std::string& data,
+               std::string* compressed_data);
+}
+
 // This is the base class for FeedbackData. It primarily knows about
 // data common to all feedback reports and how to zip things.
 class FeedbackCommon : public base::RefCountedThreadSafe<FeedbackCommon> {
  public:
-  using SystemLogsMap = std::map<std::string, std::string>;
+  typedef std::map<std::string, std::string> SystemLogsMap;
 
   struct AttachedFile {
     explicit AttachedFile(const std::string& filename,
@@ -37,12 +43,23 @@ class FeedbackCommon : public base::RefCountedThreadSafe<FeedbackCommon> {
     std::unique_ptr<std::string> data;
   };
 
+  // Determine if the given feedback value is small enough to not need to
+  // be compressed.
+  static bool BelowCompressionThreshold(const std::string& content);
+
   FeedbackCommon();
 
+  void CompressFile(const base::FilePath& filename,
+                    const std::string& zipname,
+                    std::unique_ptr<std::string> data);
   void AddFile(const std::string& filename, std::unique_ptr<std::string> data);
 
   void AddLog(const std::string& name, const std::string& value);
   void AddLogs(std::unique_ptr<SystemLogsMap> logs);
+  void CompressLogs();
+
+  void AddFilesAndLogsToReport(
+      userfeedback::ExtensionSubmit* feedback_data) const;
 
   // Fill in |feedback_data| with all the data that we have collected.
   // CompressLogs() must have already been called.
@@ -59,9 +76,7 @@ class FeedbackCommon : public base::RefCountedThreadSafe<FeedbackCommon> {
   std::string user_agent() const { return user_agent_; }
   std::string locale() const { return locale_; }
 
-  const AttachedFile* attachment(size_t i) const {
-    return attachments_[i].get();
-  }
+  const AttachedFile* attachment(size_t i) const { return attachments_[i]; }
   size_t attachments() const { return attachments_.size(); }
 
   // Setters
@@ -87,22 +102,10 @@ class FeedbackCommon : public base::RefCountedThreadSafe<FeedbackCommon> {
  protected:
   virtual ~FeedbackCommon();
 
-  // Compresses the |data_to_be_compressed| to an attachment file to this
-  // feedback data with name |zipname|. If |zipname| is empty, the |filename|
-  // will be used and appended a ".zip" extension.
-  void CompressFile(const base::FilePath& filename,
-                    const std::string& zipname,
-                    std::unique_ptr<std::string> data_to_be_compressed);
-
-  void CompressLogs();
-
  private:
   friend class base::RefCountedThreadSafe<FeedbackCommon>;
   friend class FeedbackCommonTest;
 
-  void AddFilesAndLogsToReport(
-      userfeedback::ExtensionSubmit* feedback_data) const;
-
   // Returns true if a product ID was set in the feedback report.
   bool HasProductId() const { return product_id_ != -1; }
 
@@ -119,7 +122,7 @@ class FeedbackCommon : public base::RefCountedThreadSafe<FeedbackCommon> {
   // It is possible that multiple attachment add calls are running in
   // parallel, so synchronize access.
   base::Lock attachments_lock_;
-  std::vector<std::unique_ptr<AttachedFile>> attachments_;
+  ScopedVector<AttachedFile> attachments_;
 
   std::unique_ptr<SystemLogsMap> logs_;
 };
diff --git a/components/feedback/feedback_common_unittest.cc b/components/feedback/feedback_common_unittest.cc
index 539bd8f..5a4f99d 100644
--- a/components/feedback/feedback_common_unittest.cc
+++ b/components/feedback/feedback_common_unittest.cc
@@ -37,8 +37,6 @@ class FeedbackCommonTest : public testing::Test {
 
   ~FeedbackCommonTest() override {}
 
-  void CompressLogs() { feedback_->CompressLogs(); }
-
   bool FeedbackHasProductId() const { return feedback_->HasProductId(); }
 
   scoped_refptr<FeedbackCommon> feedback_;
@@ -94,7 +92,7 @@ TEST_F(FeedbackCommonTest, TestCompression) {
   // added with the right name.
   feedback_->AddLog(kOne, kTwo);
   feedback_->AddLog(kThree, kLongLog);
-  CompressLogs();
+  feedback_->CompressLogs();
   feedback_->PrepareReport(&report_);
 
   EXPECT_EQ(1, report_.product_specific_binary_data_size());
diff --git a/components/feedback/feedback_data.cc b/components/feedback/feedback_data.cc
index 215e07d..f465f6c 100644
--- a/components/feedback/feedback_data.cc
+++ b/components/feedback/feedback_data.cc
@@ -60,11 +60,12 @@ void FeedbackData::SetAndCompressSystemInfo(
     }
   }
 
-  if (sys_info) {
+  if (sys_info.get()) {
     ++pending_op_count_;
     AddLogs(std::move(sys_info));
     BrowserThread::PostBlockingPoolTaskAndReply(
-        FROM_HERE, base::Bind(&FeedbackData::CompressLogs, this),
+        FROM_HERE,
+        base::Bind(&FeedbackCommon::CompressLogs, this),
         base::Bind(&FeedbackData::OnCompressComplete, this));
   }
 }
@@ -73,13 +74,15 @@ void FeedbackData::SetAndCompressHistograms(
     std::unique_ptr<std::string> histograms) {
   DCHECK_CURRENTLY_ON(BrowserThread::UI);
 
-  if (!histograms)
+  if (!histograms.get())
     return;
   ++pending_op_count_;
   BrowserThread::PostBlockingPoolTaskAndReply(
       FROM_HERE,
-      base::Bind(&FeedbackData::CompressFile, this,
-                 base::FilePath(kHistogramsFilename), kHistogramsAttachmentName,
+      base::Bind(&FeedbackCommon::CompressFile,
+                 this,
+                 base::FilePath(kHistogramsFilename),
+                 kHistogramsAttachmentName,
                  base::Passed(&histograms)),
       base::Bind(&FeedbackData::OnCompressComplete, this));
 }
@@ -88,14 +91,18 @@ void FeedbackData::AttachAndCompressFileData(
     std::unique_ptr<std::string> attached_filedata) {
   DCHECK_CURRENTLY_ON(BrowserThread::UI);
 
-  if (!attached_filedata || attached_filedata->empty())
+  if (!attached_filedata.get() || attached_filedata->empty())
     return;
   ++pending_op_count_;
   base::FilePath attached_file =
                   base::FilePath::FromUTF8Unsafe(attached_filename_);
   BrowserThread::PostBlockingPoolTaskAndReply(
-      FROM_HERE, base::Bind(&FeedbackData::CompressFile, this, attached_file,
-                            std::string(), base::Passed(&attached_filedata)),
+      FROM_HERE,
+      base::Bind(&FeedbackCommon::CompressFile,
+                 this,
+                 attached_file,
+                 std::string(),
+                 base::Passed(&attached_filedata)),
       base::Bind(&FeedbackData::OnCompressComplete, this));
 }
 
diff --git a/components/feedback/feedback_data.h b/components/feedback/feedback_data.h
index a56bfcd..ad7a76d 100644
--- a/components/feedback/feedback_data.h
+++ b/components/feedback/feedback_data.h
@@ -42,6 +42,12 @@ class FeedbackData : public FeedbackCommon {
   void AttachAndCompressFileData(
       std::unique_ptr<std::string> attached_filedata);
 
+  // Called once we have compressed our system logs.
+  void OnCompressLogsComplete(std::unique_ptr<std::string> compressed_logs);
+
+  // Called once we have compressed our attached file.
+  void OnCompressFileComplete(std::unique_ptr<std::string> compressed_file);
+
   // Returns true if we've completed all the tasks needed before we can send
   // feedback - at this time this is includes getting the feedback page data
   // and compressing the system logs.
diff --git a/components/history/core/browser/history_backend.cc b/components/history/core/browser/history_backend.cc
index 5b45020..30d8961 100644
--- a/components/history/core/browser/history_backend.cc
+++ b/components/history/core/browser/history_backend.cc
@@ -68,14 +68,12 @@ using base::TimeTicks;
 namespace history {
 
 namespace {
-
 void RunUnlessCanceled(
     const base::Closure& closure,
     const base::CancelableTaskTracker::IsCanceledCallback& is_canceled) {
   if (!is_canceled.Run())
     closure.Run();
 }
-
 }  // namespace
 
 // How long we'll wait to do a commit, so that things are batched together.
@@ -654,11 +652,14 @@ void HistoryBackend::InitImpl(
   db_->set_error_callback(base::Bind(&HistoryBackend::DatabaseErrorCallback,
                                      base::Unretained(this)));
 
-  db_diagnostics_.clear();
   sql::InitStatus status = db_->Init(history_name);
   switch (status) {
     case sql::INIT_OK:
       break;
+    case sql::INIT_TOO_NEW:
+      delegate_->NotifyProfileError(status);
+      db_.reset();
+      return;
     case sql::INIT_FAILURE: {
       // A null db_ will cause all calls on this object to notice this error
       // and to not continue. If the error callback scheduled killing the
@@ -668,10 +669,7 @@ void HistoryBackend::InitImpl(
       if (kill_db)
         KillHistoryDatabase();
       UMA_HISTOGRAM_BOOLEAN("History.AttemptedToFixProfileError", kill_db);
-    }  // Falls through.
-    case sql::INIT_TOO_NEW: {
-      db_diagnostics_ += sql::GetCorruptFileDiagnosticsInfo(history_name);
-      delegate_->NotifyProfileError(status, db_diagnostics_);
+      delegate_->NotifyProfileError(status);
       db_.reset();
       return;
     }
@@ -2413,9 +2411,6 @@ void HistoryBackend::URLsNoLongerBookmarked(const std::set<GURL>& urls) {
 void HistoryBackend::DatabaseErrorCallback(int error, sql::Statement* stmt) {
   if (!scheduled_kill_db_ && sql::IsErrorCatastrophic(error)) {
     scheduled_kill_db_ = true;
-
-    db_diagnostics_ = db_->GetDiagnosticInfo(error, stmt);
-
     // Don't just do the close/delete here, as we are being called by |db| and
     // that seems dangerous.
     // TODO(shess): Consider changing KillHistoryDatabase() to use
diff --git a/components/history/core/browser/history_backend.h b/components/history/core/browser/history_backend.h
index aeecc96..0b952b4 100644
--- a/components/history/core/browser/history_backend.h
+++ b/components/history/core/browser/history_backend.h
@@ -113,10 +113,7 @@ class HistoryBackend : public base::RefCountedThreadSafe<HistoryBackend>,
     virtual ~Delegate() {}
 
     // Called when the database cannot be read correctly for some reason.
-    // |diagnostics| contains information about the underlying database
-    // which can help in identifying the cause of the profile error.
-    virtual void NotifyProfileError(sql::InitStatus init_status,
-                                    const std::string& diagnostics) = 0;
+    virtual void NotifyProfileError(sql::InitStatus init_status) = 0;
 
     // Sets the in-memory history backend. The in-memory backend is created by
     // the main backend. For non-unit tests, this happens on the background
@@ -882,10 +879,6 @@ class HistoryBackend : public base::RefCountedThreadSafe<HistoryBackend>,
   // Listens for the system being under memory pressure.
   std::unique_ptr<base::MemoryPressureListener> memory_pressure_listener_;
 
-  // Contains diagnostic information about the sql database that is non-empty
-  // when a catastrophic error occurs.
-  std::string db_diagnostics_;
-
   // Map from host to index in the TopHosts list. It is updated only by
   // TopHosts(), so it's usually stale.
   mutable base::hash_map<std::string, int> host_ranks_;
diff --git a/components/history/core/browser/history_backend_unittest.cc b/components/history/core/browser/history_backend_unittest.cc
index 767e4dc..0612d6a 100644
--- a/components/history/core/browser/history_backend_unittest.cc
+++ b/components/history/core/browser/history_backend_unittest.cc
@@ -121,8 +121,7 @@ class HistoryBackendTestDelegate : public HistoryBackend::Delegate {
   explicit HistoryBackendTestDelegate(HistoryBackendTestBase* test)
       : test_(test) {}
 
-  void NotifyProfileError(sql::InitStatus init_status,
-                          const std::string& diagnostics) override {}
+  void NotifyProfileError(sql::InitStatus init_status) override {}
   void SetInMemoryBackend(
       std::unique_ptr<InMemoryHistoryBackend> backend) override;
   void NotifyFaviconsChanged(const std::set<GURL>& page_urls,
diff --git a/components/history/core/browser/history_client.h b/components/history/core/browser/history_client.h
index 4d6b7e5..d4dc3cf 100644
--- a/components/history/core/browser/history_client.h
+++ b/components/history/core/browser/history_client.h
@@ -42,8 +42,7 @@ class HistoryClient {
   virtual bool CanAddURL(const GURL& url) = 0;
 
   // Notifies the embedder that there was a problem reading the database.
-  virtual void NotifyProfileError(sql::InitStatus init_status,
-                                  const std::string& diagnostics) = 0;
+  virtual void NotifyProfileError(sql::InitStatus init_status) = 0;
 
   // Returns a new HistoryBackendClient instance.
   virtual std::unique_ptr<HistoryBackendClient> CreateBackendClient() = 0;
diff --git a/components/history/core/browser/history_database.cc b/components/history/core/browser/history_database.cc
index 0c0859d..a11edaf 100644
--- a/components/history/core/browser/history_database.cc
+++ b/components/history/core/browser/history_database.cc
@@ -56,6 +56,9 @@ HistoryDatabase::~HistoryDatabase() {
 sql::InitStatus HistoryDatabase::Init(const base::FilePath& history_name) {
   db_.set_histogram_tag("History");
 
+  // Set the exceptional sqlite error handler.
+  db_.set_error_callback(error_callback_);
+
   // Set the database page size to something a little larger to give us
   // better performance (we're typically seek rather than bandwidth limited).
   // This only has an effect before any tables have been created, otherwise
@@ -256,13 +259,7 @@ void HistoryDatabase::CommitTransaction() {
 }
 
 void HistoryDatabase::RollbackTransaction() {
-  // If Init() returns with a failure status, the Transaction created there will
-  // be destructed and rolled back. HistoryBackend might try to kill the
-  // database after that, at which point it will try to roll back a non-existing
-  // transaction. This will crash on a DCHECK. So transaction_nesting() is
-  // checked first.
-  if (db_.transaction_nesting())
-    db_.RollbackTransaction();
+  db_.RollbackTransaction();
 }
 
 bool HistoryDatabase::RecreateAllTablesButURL() {
@@ -299,11 +296,6 @@ bool HistoryDatabase::Raze() {
   return db_.Raze();
 }
 
-std::string HistoryDatabase::GetDiagnosticInfo(int extended_error,
-                                               sql::Statement* statement) {
-  return db_.GetDiagnosticInfo(extended_error, statement);
-}
-
 bool HistoryDatabase::SetSegmentID(VisitID visit_id, SegmentID segment_id) {
   sql::Statement s(db_.GetCachedStatement(SQL_FROM_HERE,
       "UPDATE visits SET segment_id = ? WHERE id = ?"));
diff --git a/components/history/core/browser/history_database.h b/components/history/core/browser/history_database.h
index 0eb74a5..cf6b1c0 100644
--- a/components/history/core/browser/history_database.h
+++ b/components/history/core/browser/history_database.h
@@ -75,7 +75,7 @@ class HistoryDatabase : public DownloadDatabase,
   // underlying database connection.
   void set_error_callback(
       const sql::Connection::ErrorCallback& error_callback) {
-    db_.set_error_callback(error_callback);
+    error_callback_ = error_callback;
   }
 
   // Must call this function to complete initialization. Will return
@@ -145,8 +145,6 @@ class HistoryDatabase : public DownloadDatabase,
   // Razes the database. Returns true if successful.
   bool Raze();
 
-  std::string GetDiagnosticInfo(int extended_error, sql::Statement* statement);
-
   // Visit table functions ----------------------------------------------------
 
   // Update the segment id of a visit. Return true on success.
@@ -192,6 +190,7 @@ class HistoryDatabase : public DownloadDatabase,
 
   // ---------------------------------------------------------------------------
 
+  sql::Connection::ErrorCallback error_callback_;
   sql::Connection db_;
   sql::MetaTable meta_table_;
 
diff --git a/components/history/core/browser/history_service.cc b/components/history/core/browser/history_service.cc
index 284d3ea..f47d435 100644
--- a/components/history/core/browser/history_service.cc
+++ b/components/history/core/browser/history_service.cc
@@ -107,12 +107,11 @@ class HistoryService::BackendDelegate : public HistoryBackend::Delegate {
       : history_service_(history_service),
         service_task_runner_(service_task_runner) {}
 
-  void NotifyProfileError(sql::InitStatus init_status,
-                          const std::string& diagnostics) override {
+  void NotifyProfileError(sql::InitStatus init_status) override {
     // Send to the history service on the main thread.
     service_task_runner_->PostTask(
         FROM_HERE, base::Bind(&HistoryService::NotifyProfileError,
-                              history_service_, init_status, diagnostics));
+                              history_service_, init_status));
   }
 
   void SetInMemoryBackend(
@@ -967,11 +966,10 @@ void HistoryService::SetInMemoryBackend(
   in_memory_backend_->AttachToHistoryService(this);
 }
 
-void HistoryService::NotifyProfileError(sql::InitStatus init_status,
-                                        const std::string& diagnostics) {
+void HistoryService::NotifyProfileError(sql::InitStatus init_status) {
   DCHECK(thread_checker_.CalledOnValidThread());
   if (history_client_)
-    history_client_->NotifyProfileError(init_status, diagnostics);
+    history_client_->NotifyProfileError(init_status);
 }
 
 void HistoryService::DeleteURL(const GURL& url) {
diff --git a/components/history/core/browser/history_service.h b/components/history/core/browser/history_service.h
index 5e10f4b..a7417db 100644
--- a/components/history/core/browser/history_service.h
+++ b/components/history/core/browser/history_service.h
@@ -777,8 +777,7 @@ class HistoryService : public syncer::SyncableService, public KeyedService {
   void SetInMemoryBackend(std::unique_ptr<InMemoryHistoryBackend> mem_backend);
 
   // Called by our BackendDelegate when there is a problem reading the database.
-  void NotifyProfileError(sql::InitStatus init_status,
-                          const std::string& diagnostics);
+  void NotifyProfileError(sql::InitStatus init_status);
 
   // Call to schedule a given task for running on the history thread with the
   // specified priority. The task will have ownership taken.
diff --git a/components/history/core/browser/typed_url_syncable_service_unittest.cc b/components/history/core/browser/typed_url_syncable_service_unittest.cc
index d08433a..7b46403 100644
--- a/components/history/core/browser/typed_url_syncable_service_unittest.cc
+++ b/components/history/core/browser/typed_url_syncable_service_unittest.cc
@@ -151,8 +151,7 @@ class TestHistoryBackendDelegate : public HistoryBackend::Delegate {
  public:
   TestHistoryBackendDelegate() {}
 
-  void NotifyProfileError(sql::InitStatus init_status,
-                          const std::string& diagnostics) override {}
+  void NotifyProfileError(sql::InitStatus init_status) override {}
   void SetInMemoryBackend(
       std::unique_ptr<InMemoryHistoryBackend> backend) override{};
   void NotifyFaviconsChanged(const std::set<GURL>& page_urls,
diff --git a/components/history/core/test/history_backend_db_base_test.cc b/components/history/core/test/history_backend_db_base_test.cc
index 8189159..9950fc7 100644
--- a/components/history/core/test/history_backend_db_base_test.cc
+++ b/components/history/core/test/history_backend_db_base_test.cc
@@ -30,8 +30,7 @@ class BackendDelegate : public HistoryBackend::Delegate {
       : history_test_(history_test) {}
 
   // HistoryBackend::Delegate implementation.
-  void NotifyProfileError(sql::InitStatus init_status,
-                          const std::string& diagnostics) override {
+  void NotifyProfileError(sql::InitStatus init_status) override {
     history_test_->last_profile_error_ = init_status;
   }
   void SetInMemoryBackend(
diff --git a/components/history/core/test/history_client_fake_bookmarks.cc b/components/history/core/test/history_client_fake_bookmarks.cc
index e14ee32..2572f4a 100644
--- a/components/history/core/test/history_client_fake_bookmarks.cc
+++ b/components/history/core/test/history_client_fake_bookmarks.cc
@@ -179,8 +179,8 @@ bool HistoryClientFakeBookmarks::CanAddURL(const GURL& url) {
 }
 
 void HistoryClientFakeBookmarks::NotifyProfileError(
-    sql::InitStatus init_status,
-    const std::string& diagnostics) {}
+    sql::InitStatus init_status) {
+}
 
 std::unique_ptr<HistoryBackendClient>
 HistoryClientFakeBookmarks::CreateBackendClient() {
diff --git a/components/history/core/test/history_client_fake_bookmarks.h b/components/history/core/test/history_client_fake_bookmarks.h
index fed5f45..f2e2192 100644
--- a/components/history/core/test/history_client_fake_bookmarks.h
+++ b/components/history/core/test/history_client_fake_bookmarks.h
@@ -34,8 +34,7 @@ class HistoryClientFakeBookmarks : public HistoryClient {
   void OnHistoryServiceCreated(HistoryService* history_service) override;
   void Shutdown() override;
   bool CanAddURL(const GURL& url) override;
-  void NotifyProfileError(sql::InitStatus init_status,
-                          const std::string& diagnostics) override;
+  void NotifyProfileError(sql::InitStatus init_status) override;
   std::unique_ptr<HistoryBackendClient> CreateBackendClient() override;
 
  private:
diff --git a/components/infobars/core/infobar_delegate.h b/components/infobars/core/infobar_delegate.h
index 0a651d8..7ab41b6 100644
--- a/components/infobars/core/infobar_delegate.h
+++ b/components/infobars/core/infobar_delegate.h
@@ -124,9 +124,9 @@ class InfoBarDelegate {
     NATIVE_APP_OPEN_POLICY_INFOBAR_DELEGATE = 54,
     RE_SIGN_IN_INFOBAR_DELEGATE = 55,
     SHOW_PASSKIT_INFOBAR_ERROR_DELEGATE = 56,
-    READER_MODE_INFOBAR_DELEGATE_IOS = 57,
+    READER_MODE_INFOBAR_DELEGATE = 57,  // Used on iOS.
     SYNC_ERROR_INFOBAR_DELEGATE = 58,
-    UPGRADE_INFOBAR_DELEGATE_IOS = 59,
+    UPGRADE_INFOBAR_DELEGATE = 59,  // Used on iOS.
     CHROME_WINDOW_ERROR = 60,
     CONFIRM_DANGEROUS_DOWNLOAD = 61,
     // Removed: DESKTOP_SEARCH_REDIRECTION_INFOBAR_DELEGATE = 62,
diff --git a/components/metrics/proto/cast_logs.proto b/components/metrics/proto/cast_logs.proto
index a812de3..951dfb2 100644
--- a/components/metrics/proto/cast_logs.proto
+++ b/components/metrics/proto/cast_logs.proto
@@ -50,7 +50,7 @@ message CastLogsProto {
 
     // This message describes a detail sender device and sdk. Those are
     // parsed from the user agent string sent from sender sdk during connection.
-    // Next tag: 10
+    // Next tag: 9
     message SenderInfo {
       // The identifier for the sender device, that is not tied any kind of
       // device id outside of UMA, and this id is reset when user resets sender
@@ -107,11 +107,6 @@ message CastLogsProto {
 
       // Sender device model.
       optional string model = 8;
-
-      // Last 2 bytes of the sender’s local IP addresses (both IP4/IP6) when
-      // the sender connected. This field stores ip fragment to last 2 bytes and
-      // first 2 bytes won't be used.
-      optional int32 sender_local_ip_fragment = 9;
     }
     optional SenderInfo sender_info = 3;
   }
diff --git a/components/ntp_snippets.gypi b/components/ntp_snippets.gypi
index f82920e..2edb308 100644
--- a/components/ntp_snippets.gypi
+++ b/components/ntp_snippets.gypi
@@ -17,7 +17,6 @@
         '../net/net.gyp:net',
         '../url/url.gyp:url_lib',
         '../third_party/icu/icu.gyp:icuuc',
-        'bookmarks_browser',
         'data_use_measurement_core',
         'image_fetcher',
         'keyed_service_core',
@@ -31,10 +30,6 @@
         'variations_net',
       ],
       'sources': [
-        'ntp_snippets/bookmarks/bookmark_last_visit_utils.cc',
-        'ntp_snippets/bookmarks/bookmark_last_visit_utils.h',
-        'ntp_snippets/bookmarks/bookmark_suggestions_provider.cc',
-        'ntp_snippets/bookmarks/bookmark_suggestions_provider.h',
         'ntp_snippets/category_factory.cc',
         'ntp_snippets/category_factory.h',
         'ntp_snippets/category_status.cc',
diff --git a/components/ntp_snippets/BUILD.gn b/components/ntp_snippets/BUILD.gn
index 79449b7..d601cdd 100644
--- a/components/ntp_snippets/BUILD.gn
+++ b/components/ntp_snippets/BUILD.gn
@@ -12,10 +12,6 @@ if (is_android) {
 # GYP version: components/ntp_snippets.gypi:ntp_snippets
 static_library("ntp_snippets") {
   sources = [
-    "bookmarks/bookmark_last_visit_utils.cc",
-    "bookmarks/bookmark_last_visit_utils.h",
-    "bookmarks/bookmark_suggestions_provider.cc",
-    "bookmarks/bookmark_suggestions_provider.h",
     "category.cc",
     "category.h",
     "category_factory.cc",
@@ -67,7 +63,6 @@ static_library("ntp_snippets") {
   ]
 
   deps = [
-    "//components/bookmarks/browser",
     "//components/data_use_measurement/core",
     "//components/image_fetcher",
     "//components/metrics",
@@ -83,7 +78,6 @@ static_library("ntp_snippets") {
 if (is_android) {
   java_cpp_enum("ntp_snippets_java_enums_srcjar") {
     sources = [
-      "category.h",
       "category_status.h",
     ]
   }
diff --git a/components/ntp_snippets/bookmarks/DEPS b/components/ntp_snippets/bookmarks/DEPS
deleted file mode 100644
index 8fa1a6b..0000000
--- a/components/ntp_snippets/bookmarks/DEPS
+++ /dev/null
@@ -1,3 +0,0 @@
-include_rules = [
-  "+components/bookmarks/browser"
-]
diff --git a/components/ntp_snippets/bookmarks/bookmark_last_visit_utils.cc b/components/ntp_snippets/bookmarks/bookmark_last_visit_utils.cc
deleted file mode 100644
index 2fd0195..0000000
--- a/components/ntp_snippets/bookmarks/bookmark_last_visit_utils.cc
+++ /dev/null
@@ -1,120 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "components/ntp_snippets/bookmarks/bookmark_last_visit_utils.h"
-
-#include <algorithm>
-#include <string>
-#include <utility>
-
-#include "base/strings/string_number_conversions.h"
-#include "base/time/time.h"
-#include "components/bookmarks/browser/bookmark_model.h"
-#include "components/bookmarks/browser/bookmark_node.h"
-#include "url/gurl.h"
-
-using bookmarks::BookmarkModel;
-using bookmarks::BookmarkNode;
-
-namespace ntp_snippets {
-
-namespace {
-
-const char kBookmarkLastVisitDateKey[] = "last_visited";
-
-base::Time ParseLastVisitDate(const std::string& date_string) {
-  int64_t date = 0;
-  if (!base::StringToInt64(date_string, &date))
-    return base::Time::UnixEpoch();
-  return base::Time::FromInternalValue(date);
-}
-
-std::string FormatLastVisitDate(const base::Time& date) {
-  return base::Int64ToString(date.ToInternalValue());
-}
-
-bool CompareBookmarksByLastVisitDate(const BookmarkNode* a,
-                                     const BookmarkNode* b) {
-  return GetLastVisitDateForBookmark(a) > GetLastVisitDateForBookmark(b);
-}
-
-}  // namespace
-
-void UpdateBookmarkOnURLVisitedInMainFrame(BookmarkModel* bookmark_model,
-                                           const GURL& url) {
-  std::vector<const BookmarkNode*> bookmarks_for_url;
-  bookmark_model->GetNodesByURL(url, &bookmarks_for_url);
-  if (bookmarks_for_url.empty())
-    return;
-
-  // If there are bookmarks for |url|, set their last visit date to now.
-  std::string now = FormatLastVisitDate(base::Time::Now());
-  for (auto* node : bookmarks_for_url) {
-    bookmark_model->SetNodeMetaInfo(node, kBookmarkLastVisitDateKey, now);
-  }
-}
-
-base::Time GetLastVisitDateForBookmark(const BookmarkNode* node) {
-  if (!node)
-    return base::Time::UnixEpoch();
-
-  std::string last_visit_date_string;
-  node->GetMetaInfo(kBookmarkLastVisitDateKey, &last_visit_date_string);
-
-  if (last_visit_date_string.empty()) {
-    // Use creation date if no last visit info present.
-    return node->date_added();
-  }
-
-  return ParseLastVisitDate(last_visit_date_string);
-}
-
-std::vector<const BookmarkNode*> GetRecentlyVisitedBookmarks(
-    BookmarkModel* bookmark_model,
-    int max_count,
-    const base::Time& min_visit_time) {
-  // Get all the bookmarks.
-  std::vector<BookmarkModel::URLAndTitle> bookmarks;
-  bookmark_model->GetBookmarks(&bookmarks);
-
-  // Remove bookmarks that have not been visited after |min_visit_time|.
-  bookmarks.erase(
-      std::remove_if(bookmarks.begin(), bookmarks.end(),
-                     [&bookmark_model, &min_visit_time](
-                         const BookmarkModel::URLAndTitle& bookmark) {
-                       // Get all bookmarks for the given URL.
-                       std::vector<const BookmarkNode*> bookmarks_for_url;
-                       bookmark_model->GetNodesByURL(bookmark.url,
-                                                     &bookmarks_for_url);
-
-                       // Return false if there is a more recent visit time.
-                       for (const auto* node : bookmarks_for_url) {
-                         if (GetLastVisitDateForBookmark(node) > min_visit_time)
-                           return false;
-                       }
-                       return true;
-                     }),
-      bookmarks.end());
-
-  // Sort the remaining bookmarks by date.
-  std::sort(bookmarks.begin(), bookmarks.end(),
-            [&bookmark_model](const BookmarkModel::URLAndTitle& a,
-                              const BookmarkModel::URLAndTitle& b) {
-              return CompareBookmarksByLastVisitDate(
-                  bookmark_model->GetMostRecentlyAddedUserNodeForURL(a.url),
-                  bookmark_model->GetMostRecentlyAddedUserNodeForURL(b.url));
-            });
-
-  // Insert the first |max_count| items from |bookmarks| into |result|.
-  std::vector<const BookmarkNode*> result;
-  for (const BookmarkModel::URLAndTitle& bookmark : bookmarks) {
-    result.push_back(
-        bookmark_model->GetMostRecentlyAddedUserNodeForURL(bookmark.url));
-    if (result.size() >= static_cast<size_t>(max_count))
-      break;
-  }
-  return result;
-}
-
-}  // namespace ntp_snippets
diff --git a/components/ntp_snippets/bookmarks/bookmark_last_visit_utils.h b/components/ntp_snippets/bookmarks/bookmark_last_visit_utils.h
deleted file mode 100644
index f5d9172..0000000
--- a/components/ntp_snippets/bookmarks/bookmark_last_visit_utils.h
+++ /dev/null
@@ -1,45 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef COMPONENTS_NTP_SNIPPETS_BOOKMARKS_BOOKMARK_LAST_VISIT_UTILS_H_
-#define COMPONENTS_NTP_SNIPPETS_BOOKMARKS_BOOKMARK_LAST_VISIT_UTILS_H_
-
-#include <vector>
-
-class GURL;
-
-namespace base {
-class Time;
-}  // namespace base
-
-namespace bookmarks {
-class BookmarkModel;
-class BookmarkNode;
-}  // namespace bookmarks
-
-namespace ntp_snippets {
-
-// If there is a bookmark for |url|, this function updates its last visit date
-// to now. If there are multiple bookmarks for a given URL, it updates all of
-// them.
-void UpdateBookmarkOnURLVisitedInMainFrame(
-    bookmarks::BookmarkModel* bookmark_model,
-    const GURL& url);
-
-// Gets the last visit date for a given bookmark |node|. If the bookmark lacks
-// this info, it returns it creation date.
-base::Time GetLastVisitDateForBookmark(const bookmarks::BookmarkNode* node);
-
-// Returns the list of most recently visited bookmarks. For each bookmarked URL,
-// it returns the most recently created bookmark. The result is ordered by visit
-// time (the most recent first). Only bookmarks visited after
-// |min_visit_time| are considered, at most |max_count| bookmarks are returned.
-std::vector<const bookmarks::BookmarkNode*> GetRecentlyVisitedBookmarks(
-    bookmarks::BookmarkModel* bookmark_model,
-    int max_count,
-    const base::Time& min_visit_time);
-
-}  // namespace ntp_snippets
-
-#endif  // COMPONENTS_NTP_SNIPPETS_BOOKMARKS_BOOKMARK_LAST_VISIT_UTILS_H_
diff --git a/components/ntp_snippets/bookmarks/bookmark_suggestions_provider.cc b/components/ntp_snippets/bookmarks/bookmark_suggestions_provider.cc
deleted file mode 100644
index 85457d2..0000000
--- a/components/ntp_snippets/bookmarks/bookmark_suggestions_provider.cc
+++ /dev/null
@@ -1,163 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "components/ntp_snippets/bookmarks/bookmark_suggestions_provider.h"
-
-#include <utility>
-#include <vector>
-
-#include "base/bind.h"
-#include "base/location.h"
-#include "base/strings/utf_string_conversions.h"
-#include "base/threading/thread_task_runner_handle.h"
-#include "components/bookmarks/browser/bookmark_model.h"
-#include "components/ntp_snippets/bookmarks/bookmark_last_visit_utils.h"
-#include "components/ntp_snippets/category_factory.h"
-#include "components/ntp_snippets/content_suggestion.h"
-#include "ui/gfx/image/image.h"
-
-using bookmarks::BookmarkModel;
-using bookmarks::BookmarkNode;
-
-namespace {
-
-const int kMaxBookmarks = 10;
-const int kMaxBookmarkAgeInDays = 42;
-
-base::Time GetThresholdTime() {
-  return base::Time::Now() - base::TimeDelta::FromDays(kMaxBookmarkAgeInDays);
-}
-
-}  // namespace
-
-namespace ntp_snippets {
-
-BookmarkSuggestionsProvider::BookmarkSuggestionsProvider(
-    ContentSuggestionsProvider::Observer* observer,
-    CategoryFactory* category_factory,
-    bookmarks::BookmarkModel* bookmark_model)
-    : ContentSuggestionsProvider(observer, category_factory),
-      category_status_(CategoryStatus::AVAILABLE_LOADING),
-      provided_category_(
-          category_factory->FromKnownCategory(KnownCategories::BOOKMARKS)),
-      bookmark_model_(bookmark_model),
-      fetch_requested_(false),
-      end_of_list_last_visit_date_(GetThresholdTime()) {
-  bookmark_model_->AddObserver(this);
-  FetchBookmarks();
-}
-
-BookmarkSuggestionsProvider::~BookmarkSuggestionsProvider() {
-  bookmark_model_->RemoveObserver(this);
-}
-
-////////////////////////////////////////////////////////////////////////////////
-// Private methods
-
-std::vector<Category> BookmarkSuggestionsProvider::GetProvidedCategories() {
-  return std::vector<Category>({provided_category_});
-}
-
-CategoryStatus BookmarkSuggestionsProvider::GetCategoryStatus(
-    Category category) {
-  return category_status_;
-}
-
-void BookmarkSuggestionsProvider::DismissSuggestion(
-    const std::string& suggestion_id) {
-  // TODO(jkrcal): Implement blacklisting bookmarks until they are next visited.
-  // Then also implement ClearDismissedSuggestionsForDebugging.
-}
-
-void BookmarkSuggestionsProvider::FetchSuggestionImage(
-    const std::string& suggestion_id,
-    const ImageFetchedCallback& callback) {
-  base::ThreadTaskRunnerHandle::Get()->PostTask(
-      FROM_HERE, base::Bind(callback, suggestion_id, gfx::Image()));
-}
-
-void BookmarkSuggestionsProvider::ClearCachedSuggestionsForDebugging() {
-  // Ignored.
-}
-
-void BookmarkSuggestionsProvider::ClearDismissedSuggestionsForDebugging() {
-  // TODO(jkrcal): Implement when discarded suggestions are supported.
-}
-
-void BookmarkSuggestionsProvider::BookmarkModelLoaded(
-    bookmarks::BookmarkModel* model,
-    bool ids_reassigned) {
-  DCHECK_EQ(bookmark_model_, model);
-  if (fetch_requested_) {
-    fetch_requested_ = false;
-    FetchBookmarksInternal();
-  }
-}
-
-void BookmarkSuggestionsProvider::OnWillChangeBookmarkMetaInfo(
-    BookmarkModel* model,
-    const BookmarkNode* node) {
-  // Store the last visit date of the node that is about to change.
-  node_to_change_last_visit_date_ = GetLastVisitDateForBookmark(node);
-}
-
-void BookmarkSuggestionsProvider::BookmarkMetaInfoChanged(
-    BookmarkModel* model,
-    const BookmarkNode* node) {
-  base::Time time = GetLastVisitDateForBookmark(node);
-  if (time == node_to_change_last_visit_date_ ||
-      time < end_of_list_last_visit_date_)
-    return;
-
-  // Last visit date of a node has changed (and is relevant for the list), we
-  // should update the suggestions.
-  FetchBookmarks();
-}
-
-void BookmarkSuggestionsProvider::FetchBookmarksInternal() {
-  DCHECK(bookmark_model_->loaded());
-
-  NotifyStatusChanged(CategoryStatus::AVAILABLE);
-
-  std::vector<const BookmarkNode*> bookmarks = GetRecentlyVisitedBookmarks(
-      bookmark_model_, kMaxBookmarks, GetThresholdTime());
-
-  std::vector<ContentSuggestion> suggestions;
-  for (const BookmarkNode* bookmark : bookmarks) {
-    ContentSuggestion suggestion(
-        MakeUniqueID(provided_category_, bookmark->url().spec()),
-        bookmark->url());
-
-    suggestion.set_title(bookmark->GetTitle());
-    suggestion.set_snippet_text(base::string16());
-    suggestion.set_publish_date(GetLastVisitDateForBookmark(bookmark));
-    suggestion.set_publisher_name(base::UTF8ToUTF16(bookmark->url().host()));
-    suggestions.emplace_back(std::move(suggestion));
-  }
-
-  if (suggestions.empty())
-    end_of_list_last_visit_date_ = GetThresholdTime();
-  else
-    end_of_list_last_visit_date_ = suggestions.back().publish_date();
-
-  observer()->OnNewSuggestions(this, provided_category_,
-                               std::move(suggestions));
-}
-
-void BookmarkSuggestionsProvider::FetchBookmarks() {
-  if (bookmark_model_->loaded())
-    FetchBookmarksInternal();
-  else
-    fetch_requested_ = true;
-}
-
-void BookmarkSuggestionsProvider::NotifyStatusChanged(
-    CategoryStatus new_status) {
-  if (category_status_ == new_status)
-    return;
-  category_status_ = new_status;
-  observer()->OnCategoryStatusChanged(this, provided_category_, new_status);
-}
-
-}  // namespace ntp_snippets
diff --git a/components/ntp_snippets/bookmarks/bookmark_suggestions_provider.h b/components/ntp_snippets/bookmarks/bookmark_suggestions_provider.h
deleted file mode 100644
index 667dad6..0000000
--- a/components/ntp_snippets/bookmarks/bookmark_suggestions_provider.h
+++ /dev/null
@@ -1,102 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef COMPONENTS_NTP_SNIPPETS_BOOKMARKS_BOOKMARK_SUGGESTIONS_PROVIDER_H_
-#define COMPONENTS_NTP_SNIPPETS_BOOKMARKS_BOOKMARK_SUGGESTIONS_PROVIDER_H_
-
-#include <set>
-#include <string>
-
-#include "components/bookmarks/browser/bookmark_model_observer.h"
-#include "components/keyed_service/core/keyed_service.h"
-#include "components/ntp_snippets/category.h"
-#include "components/ntp_snippets/category_status.h"
-#include "components/ntp_snippets/content_suggestions_provider.h"
-
-namespace gfx {
-class Image;
-}
-
-namespace ntp_snippets {
-
-// Provides content suggestions from the bookmarks model.
-class BookmarkSuggestionsProvider : public ContentSuggestionsProvider,
-                                    public bookmarks::BookmarkModelObserver {
- public:
-  BookmarkSuggestionsProvider(ContentSuggestionsProvider::Observer* observer,
-                              CategoryFactory* category_factory,
-                              bookmarks::BookmarkModel* bookmark_model);
-  ~BookmarkSuggestionsProvider() override;
-
- private:
-  // ContentSuggestionsProvider implementation.
-  std::vector<Category> GetProvidedCategories() override;
-  CategoryStatus GetCategoryStatus(Category category) override;
-  void DismissSuggestion(const std::string& suggestion_id) override;
-  void FetchSuggestionImage(const std::string& suggestion_id,
-                            const ImageFetchedCallback& callback) override;
-  void ClearCachedSuggestionsForDebugging() override;
-  void ClearDismissedSuggestionsForDebugging() override;
-
-  // bookmarks::BookmarkModelObserver implementation.
-  void BookmarkModelLoaded(bookmarks::BookmarkModel* model,
-                           bool ids_reassigned) override;
-  void OnWillChangeBookmarkMetaInfo(
-      bookmarks::BookmarkModel* model,
-      const bookmarks::BookmarkNode* node) override;
-  void BookmarkMetaInfoChanged(bookmarks::BookmarkModel* model,
-                               const bookmarks::BookmarkNode* node) override;
-
-  void BookmarkNodeMoved(bookmarks::BookmarkModel* model,
-                         const bookmarks::BookmarkNode* old_parent,
-                         int old_index,
-                         const bookmarks::BookmarkNode* new_parent,
-                         int new_index) override {}
-  void BookmarkNodeAdded(bookmarks::BookmarkModel* model,
-                         const bookmarks::BookmarkNode* parent,
-                         int index) override {}
-  void BookmarkNodeRemoved(
-      bookmarks::BookmarkModel* model,
-      const bookmarks::BookmarkNode* parent,
-      int old_index,
-      const bookmarks::BookmarkNode* node,
-      const std::set<GURL>& no_longer_bookmarked) override {}
-  void BookmarkNodeChanged(bookmarks::BookmarkModel* model,
-                           const bookmarks::BookmarkNode* node) override {}
-  void BookmarkNodeFaviconChanged(
-      bookmarks::BookmarkModel* model,
-      const bookmarks::BookmarkNode* node) override {}
-  void BookmarkNodeChildrenReordered(
-      bookmarks::BookmarkModel* model,
-      const bookmarks::BookmarkNode* node) override {}
-  void BookmarkAllUserNodesRemoved(
-      bookmarks::BookmarkModel* model,
-      const std::set<GURL>& removed_urls) override {}
-
-  // The actual method to fetch bookmarks - follows each call to FetchBookmarks
-  // but not sooner than the BookmarkModel gets loaded.
-  void FetchBookmarksInternal();
-
-  // Queries the BookmarkModel for recently visited bookmarks and pushes the
-  // results to the ContentSuggestionService. The actual fetching does not
-  // happen before the Bookmark model gets loaded.
-  void FetchBookmarks();
-
-  // Updates the |category_status_| and notifies the |observer_|, if necessary.
-  void NotifyStatusChanged(CategoryStatus new_status);
-
-  CategoryStatus category_status_;
-  const Category provided_category_;
-  bookmarks::BookmarkModel* bookmark_model_;
-  bool fetch_requested_;
-
-  base::Time node_to_change_last_visit_date_;
-  base::Time end_of_list_last_visit_date_;
-
-  DISALLOW_COPY_AND_ASSIGN(BookmarkSuggestionsProvider);
-};
-
-}  // namespace ntp_snippets
-
-#endif  // COMPONENTS_NTP_SNIPPETS_BOOKMARKS_BOOKMARK_SUGGESTIONS_PROVIDER_H_
diff --git a/components/ntp_snippets/category.h b/components/ntp_snippets/category.h
index 0991ab2..89b52d5 100644
--- a/components/ntp_snippets/category.h
+++ b/components/ntp_snippets/category.h
@@ -16,22 +16,12 @@ class CategoryFactory;
 // locally on the device. Categories provided by the server (IDs strictly larger
 // than REMOTE_CATEGORIES_OFFSET) only need to be hard-coded here if they need
 // to be recognized by the client implementation.
-// On Android builds, a Java counterpart will be generated for this enum.
-// GENERATED_JAVA_ENUM_PACKAGE: org.chromium.chrome.browser.ntp.snippets
 enum class KnownCategories {
-  // Pages downloaded for offline consumption.
   OFFLINE_PAGES,
-
-  // Recently used bookmarks.
-  BOOKMARKS,
-
-  // Follows the last local category.
   LOCAL_CATEGORIES_COUNT,
 
   REMOTE_CATEGORIES_OFFSET = 10000,
-
-  // Articles for you.
-  ARTICLES,
+  ARTICLES = REMOTE_CATEGORIES_OFFSET + 1,
 };
 
 // A category groups ContentSuggestions which belong together. Use the
diff --git a/components/ntp_snippets/category_factory.cc b/components/ntp_snippets/category_factory.cc
index fc9482c..bed07f9 100644
--- a/components/ntp_snippets/category_factory.cc
+++ b/components/ntp_snippets/category_factory.cc
@@ -13,7 +13,6 @@ namespace ntp_snippets {
 CategoryFactory::CategoryFactory() {
   // Add all local categories in a fixed order.
   AddKnownCategory(KnownCategories::OFFLINE_PAGES);
-  AddKnownCategory(KnownCategories::BOOKMARKS);
 }
 
 CategoryFactory::~CategoryFactory() {}
diff --git a/components/ntp_snippets/content_suggestions_service.cc b/components/ntp_snippets/content_suggestions_service.cc
index 43ee91e..1b9ecb8 100644
--- a/components/ntp_snippets/content_suggestions_service.cc
+++ b/components/ntp_snippets/content_suggestions_service.cc
@@ -8,9 +8,7 @@
 #include <iterator>
 
 #include "base/bind.h"
-#include "base/location.h"
 #include "base/strings/string_number_conversions.h"
-#include "base/threading/thread_task_runner_handle.h"
 #include "ui/gfx/image/image.h"
 
 namespace ntp_snippets {
@@ -63,16 +61,14 @@ void ContentSuggestionsService::FetchSuggestionImage(
     const ImageFetchedCallback& callback) {
   if (!id_category_map_.count(suggestion_id)) {
     LOG(WARNING) << "Requested image for unknown suggestion " << suggestion_id;
-    base::ThreadTaskRunnerHandle::Get()->PostTask(
-        FROM_HERE, base::Bind(callback, suggestion_id, gfx::Image()));
+    callback.Run(suggestion_id, gfx::Image());
     return;
   }
   Category category = id_category_map_.at(suggestion_id);
   if (!providers_by_category_.count(category)) {
     LOG(WARNING) << "Requested image for suggestion " << suggestion_id
                  << " for unavailable category " << category;
-    base::ThreadTaskRunnerHandle::Get()->PostTask(
-        FROM_HERE, base::Bind(callback, suggestion_id, gfx::Image()));
+    callback.Run(suggestion_id, gfx::Image());
     return;
   }
   providers_by_category_[category]->FetchSuggestionImage(suggestion_id,
diff --git a/components/ntp_snippets/content_suggestions_service_unittest.cc b/components/ntp_snippets/content_suggestions_service_unittest.cc
index 6943a36..ba95a17 100644
--- a/components/ntp_snippets/content_suggestions_service_unittest.cc
+++ b/components/ntp_snippets/content_suggestions_service_unittest.cc
@@ -10,8 +10,6 @@
 #include "base/bind.h"
 #include "base/macros.h"
 #include "base/memory/ptr_util.h"
-#include "base/message_loop/message_loop.h"
-#include "base/run_loop.h"
 #include "base/strings/string_number_conversions.h"
 #include "components/ntp_snippets/category_status.h"
 #include "components/ntp_snippets/content_suggestion.h"
@@ -20,16 +18,15 @@
 #include "testing/gtest/include/gtest/gtest.h"
 #include "ui/gfx/image/image.h"
 
-using testing::ByRef;
-using testing::Const;
-using testing::ElementsAre;
 using testing::Eq;
-using testing::InvokeWithoutArgs;
-using testing::IsEmpty;
 using testing::IsNull;
-using testing::Mock;
 using testing::NotNull;
+using testing::IsEmpty;
+using testing::ElementsAre;
 using testing::Property;
+using testing::Const;
+using testing::Mock;
+using testing::ByRef;
 using testing::_;
 
 namespace ntp_snippets {
@@ -263,18 +260,12 @@ TEST_F(ContentSuggestionsServiceTest, ShouldRedirectFetchSuggestionImage) {
 
 TEST_F(ContentSuggestionsServiceTest,
        ShouldCallbackEmptyImageForUnavailableProvider) {
-  // Setup the current thread's MessageLoop.
-  base::MessageLoop message_loop;
-
-  base::RunLoop run_loop;
   std::string suggestion_id = "TestID";
   EXPECT_CALL(*this, OnImageFetched(suggestion_id,
-                                    Property(&gfx::Image::IsEmpty, Eq(true))))
-      .WillOnce(InvokeWithoutArgs(&run_loop, &base::RunLoop::Quit));
+                                    Property(&gfx::Image::IsEmpty, Eq(true))));
   service()->FetchSuggestionImage(
       suggestion_id, base::Bind(&ContentSuggestionsServiceTest::OnImageFetched,
                                 base::Unretained(this)));
-  run_loop.Run();
 }
 
 TEST_F(ContentSuggestionsServiceTest, ShouldRedirectDismissSuggestion) {
diff --git a/components/ntp_snippets/features.cc b/components/ntp_snippets/features.cc
index 3b5d056..7645601 100644
--- a/components/ntp_snippets/features.cc
+++ b/components/ntp_snippets/features.cc
@@ -6,9 +6,6 @@
 
 namespace ntp_snippets {
 
-const base::Feature kBookmarkSuggestionsFeature{
-    "NTPBookmarkSuggestions", base::FEATURE_DISABLED_BY_DEFAULT};
-
 const base::Feature kContentSuggestionsFeature{
     "NTPSnippets", base::FEATURE_DISABLED_BY_DEFAULT};
 
diff --git a/components/ntp_snippets/features.h b/components/ntp_snippets/features.h
index 6619787..0f86f5c 100644
--- a/components/ntp_snippets/features.h
+++ b/components/ntp_snippets/features.h
@@ -9,7 +9,6 @@
 
 namespace ntp_snippets {
 
-extern const base::Feature kBookmarkSuggestionsFeature;
 extern const base::Feature kContentSuggestionsFeature;
 
 }  // namespace ntp_snippets
diff --git a/components/ntp_snippets/ntp_snippet.cc b/components/ntp_snippets/ntp_snippet.cc
index d69a77a..6e3e017 100644
--- a/components/ntp_snippets/ntp_snippet.cc
+++ b/components/ntp_snippets/ntp_snippet.cc
@@ -139,10 +139,10 @@ std::unique_ptr<NTPSnippet> NTPSnippet::CreateFromChromeReaderDictionary(
 // static
 std::unique_ptr<NTPSnippet> NTPSnippet::CreateFromContentSuggestionsDictionary(
     const base::DictionaryValue& dict) {
-  const base::ListValue* ids;
+  const base::ListValue* id_list;
   std::string id;
-  if (!(dict.GetList("ids", &ids) &&
-        ids->GetString(0, &id))) {  // TODO(sfiera): multiple IDs
+  if (!(dict.GetList("id", &id_list) &&
+        id_list->GetString(0, &id))) {  // TODO(sfiera): multiple IDs
     return nullptr;
   }
 
@@ -152,11 +152,11 @@ std::unique_ptr<NTPSnippet> NTPSnippet::CreateFromContentSuggestionsDictionary(
   snippet->best_source_index_ = 0;
 
   if (!(dict.GetString("title", &snippet->title_) &&
-        dict.GetString("snippet", &snippet->snippet_) &&
-        GetTimeValue(dict, "creationTime", &snippet->publish_date_) &&
+        dict.GetString("summaryText", &snippet->snippet_) &&
+        GetTimeValue(dict, "publishTime", &snippet->publish_date_) &&
         GetTimeValue(dict, "expirationTime", &snippet->expiry_date_) &&
         GetURLValue(dict, "imageUrl", &snippet->salient_image_url_) &&
-        dict.GetString("attribution", &source->publisher_name) &&
+        dict.GetString("publisherName", &source->publisher_name) &&
         GetURLValue(dict, "fullPageUrl", &source->url))) {
     return nullptr;
   }
diff --git a/components/ntp_snippets/ntp_snippet_unittest.cc b/components/ntp_snippets/ntp_snippet_unittest.cc
index 93304b6..6e254c6 100644
--- a/components/ntp_snippets/ntp_snippet_unittest.cc
+++ b/components/ntp_snippets/ntp_snippet_unittest.cc
@@ -15,13 +15,13 @@ namespace {
 TEST(NTPSnippetTest, FromChromeContentSuggestionsDictionary) {
   const std::string kJsonStr =
       "{"
-      "  \"ids\" : [\"http://localhost/foobar\"],"
+      "  \"id\" : [\"http://localhost/foobar\"],"
       "  \"title\" : \"Foo Barred from Baz\","
-      "  \"snippet\" : \"...\","
+      "  \"summaryText\" : \"...\","
       "  \"fullPageUrl\" : \"http://localhost/foobar\","
-      "  \"creationTime\" : \"2016-06-30T11:01:37.000Z\","
+      "  \"publishTime\" : \"2016-06-30T11:01:37.000Z\","
       "  \"expirationTime\" : \"2016-07-01T11:01:37.000Z\","
-      "  \"attribution\" : \"Foo News\","
+      "  \"publisherName\" : \"Foo News\","
       "  \"imageUrl\" : \"http://localhost/foobar.jpg\","
       "  \"ampUrl\" : \"http://localhost/amp\","
       "  \"faviconUrl\" : \"http://localhost/favicon.ico\" "
diff --git a/components/ntp_snippets/ntp_snippets_constants.cc b/components/ntp_snippets/ntp_snippets_constants.cc
index d2d33fd..5ee43fb 100644
--- a/components/ntp_snippets/ntp_snippets_constants.cc
+++ b/components/ntp_snippets/ntp_snippets_constants.cc
@@ -12,12 +12,4 @@ const char kStudyName[] = "NTPSnippets";
 const base::FilePath::CharType kDatabaseFolder[] =
     FILE_PATH_LITERAL("NTPSnippets");
 
-const char kChromeReaderServer[] =
-    "https://chromereader-pa.googleapis.com/v1/fetch";
-const char kContentSuggestionsServer[] =
-    "https://chromecontentsuggestions-pa.googleapis.com/v1/suggestions/fetch";
-const char kContentSuggestionsSandboxServer[] =
-    "https://dev-chromecontentsuggestions-pa.sandbox.googleapis.com/v1/"
-    "suggestions/fetch";
-
 }  // namespace ntp_snippets
diff --git a/components/ntp_snippets/ntp_snippets_constants.h b/components/ntp_snippets/ntp_snippets_constants.h
index 04d4ac7..0bb403c 100644
--- a/components/ntp_snippets/ntp_snippets_constants.h
+++ b/components/ntp_snippets/ntp_snippets_constants.h
@@ -17,11 +17,6 @@ extern const char kStudyName[];
 // profile path.
 extern const base::FilePath::CharType kDatabaseFolder[];
 
-// Server endpoints for fetching snippets.
-extern const char kChromeReaderServer[];               // old endpoint
-extern const char kContentSuggestionsServer[];         // new, production
-extern const char kContentSuggestionsSandboxServer[];  // new, for testing
-
 }  // namespace ntp_snippets
 
 #endif
diff --git a/components/ntp_snippets/ntp_snippets_fetcher.cc b/components/ntp_snippets/ntp_snippets_fetcher.cc
index 4f595e7..8e888ab 100644
--- a/components/ntp_snippets/ntp_snippets_fetcher.cc
+++ b/components/ntp_snippets/ntp_snippets_fetcher.cc
@@ -49,6 +49,13 @@ const char kChromeReaderApiScope[] =
     "https://www.googleapis.com/auth/webhistory";
 const char kContentSuggestionsApiScope[] =
     "https://www.googleapis.com/auth/chrome-content-suggestions";
+const char kChromeReaderServer[] =
+    "https://chromereader-pa.googleapis.com/v1/fetch";
+const char kContentSuggestionsServer[] =
+    "https://chromecontentsuggestions-pa.googleapis.com/v1/snippets/list";
+const char kContentSuggestionsSandboxServer[] =
+    "https://chromecontentsuggestions-pa.sandbox.googleapis.com/v1/snippets/"
+    "list";
 const char kSnippetsServerNonAuthorizedFormat[] = "%s?key=%s";
 const char kAuthorizationRequestHeaderFormat[] = "Bearer %s";
 
@@ -311,7 +318,7 @@ std::string NTPSnippetsFetcher::RequestParams::BuildRequest() {
     for (const auto& host : host_restricts) {
       regular_hosts->AppendString(host);
     }
-    request->Set("regularlyVisitedHostNames", std::move(regular_hosts));
+    request->Set("regularlyVisitedHostName", std::move(regular_hosts));
 
     // TODO(sfiera): support authentication and personalization
     // TODO(sfiera): support count_to_fetch
@@ -487,50 +494,23 @@ void NTPSnippetsFetcher::OnURLFetchComplete(const URLFetcher* source) {
   }
 }
 
-bool NTPSnippetsFetcher::JsonToSnippets(const base::Value& parsed,
-                                        NTPSnippet::PtrVector* snippets) {
-  const base::DictionaryValue* top_dict = nullptr;
-  if (!parsed.GetAsDictionary(&top_dict)) {
-    return false;
-  }
-
-  if (fetch_api_ == CHROME_READER_API) {
-    const base::ListValue* recos = nullptr;
-    return top_dict->GetList("recos", &recos) &&
-           AddSnippetsFromListValue(/* content_suggestions_api = */ false,
-                                    *recos, snippets);
-  } else {
-    const base::ListValue* categories = nullptr;
-    if (!top_dict->GetList("categories", &categories)) {
-      return false;
-    }
-
-    // Merge all categories together, for now.
-    // TODO(sfiera): preserve categories from server.
-    for (const auto& v : *categories) {
-      const base::DictionaryValue* category = nullptr;
-      const base::ListValue* suggestions = nullptr;
-      if (!(v->GetAsDictionary(&category) &&
-            category->GetList("suggestions", &suggestions) &&
-            AddSnippetsFromListValue(/* content_suggestions_api = */ true,
-                                     *suggestions, snippets))) {
-        return false;
-      }
-    }
-    return true;
-  }
-}
-
 void NTPSnippetsFetcher::OnJsonParsed(std::unique_ptr<base::Value> parsed) {
+  const base::DictionaryValue* top_dict = nullptr;
+  const base::ListValue* list = nullptr;
   NTPSnippet::PtrVector snippets;
-  if (JsonToSnippets(*parsed, &snippets)) {
-    FetchFinished(OptionalSnippets(std::move(snippets)), FetchResult::SUCCESS,
-                  /*extra_message=*/std::string());
-  } else {
+  const std::string list_key =
+      fetch_api_ == CHROME_CONTENT_SUGGESTIONS_API ? "snippet" : "recos";
+  if (!parsed->GetAsDictionary(&top_dict) ||
+      !top_dict->GetList(list_key, &list) ||
+      !AddSnippetsFromListValue(fetch_api_ == CHROME_CONTENT_SUGGESTIONS_API,
+                                *list, &snippets)) {
     LOG(WARNING) << "Received invalid snippets: " << last_fetch_json_;
     FetchFinished(OptionalSnippets(),
                   FetchResult::INVALID_SNIPPET_CONTENT_ERROR,
                   /*extra_message=*/std::string());
+  } else {
+    FetchFinished(OptionalSnippets(std::move(snippets)), FetchResult::SUCCESS,
+                  /*extra_message=*/std::string());
   }
 }
 
diff --git a/components/ntp_snippets/ntp_snippets_fetcher.h b/components/ntp_snippets/ntp_snippets_fetcher.h
index 11a4e40..b2b1d7f 100644
--- a/components/ntp_snippets/ntp_snippets_fetcher.h
+++ b/components/ntp_snippets/ntp_snippets_fetcher.h
@@ -174,8 +174,6 @@ class NTPSnippetsFetcher : public OAuth2TokenService::Consumer,
   // URLFetcherDelegate implementation.
   void OnURLFetchComplete(const net::URLFetcher* source) override;
 
-  bool JsonToSnippets(const base::Value& parsed,
-                      NTPSnippet::PtrVector* snippets);
   void OnJsonParsed(std::unique_ptr<base::Value> parsed);
   void OnJsonError(const std::string& error);
   void FetchFinished(OptionalSnippets snippets,
diff --git a/components/ntp_snippets/ntp_snippets_fetcher_unittest.cc b/components/ntp_snippets/ntp_snippets_fetcher_unittest.cc
index c5ba65f..c5cedcb 100644
--- a/components/ntp_snippets/ntp_snippets_fetcher_unittest.cc
+++ b/components/ntp_snippets/ntp_snippets_fetcher_unittest.cc
@@ -47,8 +47,10 @@ using testing::StartsWith;
 const char kTestChromeReaderUrlFormat[] =
     "https://chromereader-pa.googleapis.com/v1/fetch?key=%s";
 const char kTestChromeContentSuggestionsUrlFormat[] =
-    "https://chromecontentsuggestions-pa.googleapis.com/v1/suggestions/"
-    "fetch?key=%s";
+    "https://chromecontentsuggestions-pa.googleapis.com/v1/snippets/"
+    "list?key=%s";
+const char kContentSuggestionsBackend[] =
+    "https://chromecontentsuggestions-pa.googleapis.com/v1/snippets/list";
 
 // Artificial time delay for JSON parsing.
 const int64_t kTestJsonParsingLatencyMs = 20;
@@ -226,7 +228,7 @@ class NTPSnippetsContentSuggestionsFetcherTest : public NTPSnippetsFetcherTest {
   NTPSnippetsContentSuggestionsFetcherTest()
       : NTPSnippetsFetcherTest(
             GetFetcherUrl(kTestChromeContentSuggestionsUrlFormat),
-            {{"content_suggestions_backend", kContentSuggestionsServer}}) {}
+            {{"content_suggestions_backend", kContentSuggestionsBackend}}) {}
 };
 
 class NTPSnippetsFetcherHostRestrictedTest : public NTPSnippetsFetcherTest {
@@ -288,7 +290,7 @@ TEST_F(NTPSnippetsFetcherTest, BuildRequestAuthenticated) {
   EXPECT_THAT(params.BuildRequest(),
               EqualsJSON("{"
                          "  \"uiLanguage\": \"en\","
-                         "  \"regularlyVisitedHostNames\": ["
+                         "  \"regularlyVisitedHostName\": ["
                          "    \"chromium.org\""
                          "  ]"
                          "}"));
@@ -335,7 +337,7 @@ TEST_F(NTPSnippetsFetcherTest, BuildRequestUnauthenticated) {
   params.fetch_api = NTPSnippetsFetcher::CHROME_CONTENT_SUGGESTIONS_API;
   EXPECT_THAT(params.BuildRequest(),
               EqualsJSON("{"
-                         "  \"regularlyVisitedHostNames\": []"
+                         "  \"regularlyVisitedHostName\": []"
                          "}"));
 }
 
@@ -381,21 +383,17 @@ TEST_F(NTPSnippetsFetcherTest, ShouldFetchSuccessfully) {
 
 TEST_F(NTPSnippetsContentSuggestionsFetcherTest, ShouldFetchSuccessfully) {
   const std::string kJsonStr =
-      "{\"categories\" : [{"
-      "  \"id\": 1,"
-      "  \"localizedTitle\": \"Articles for You\","
-      "  \"suggestions\" : [{"
-      "    \"ids\" : [\"http://localhost/foobar\"],"
-      "    \"title\" : \"Foo Barred from Baz\","
-      "    \"snippet\" : \"...\","
-      "    \"fullPageUrl\" : \"http://localhost/foobar\","
-      "    \"creationTime\" : \"2016-06-30T11:01:37.000Z\","
-      "    \"expirationTime\" : \"2016-07-01T11:01:37.000Z\","
-      "    \"attribution\" : \"Foo News\","
-      "    \"imageUrl\" : \"http://localhost/foobar.jpg\","
-      "    \"ampUrl\" : \"http://localhost/amp\","
-      "    \"faviconUrl\" : \"http://localhost/favicon.ico\" "
-      "  }]"
+      "{\"snippet\" : [{"
+      "  \"id\" : [\"http://localhost/foobar\"],"
+      "  \"title\" : \"Foo Barred from Baz\","
+      "  \"summaryText\" : \"...\","
+      "  \"fullPageUrl\" : \"http://localhost/foobar\","
+      "  \"publishTime\" : \"2016-06-30T11:01:37.000Z\","
+      "  \"expirationTime\" : \"2016-07-01T11:01:37.000Z\","
+      "  \"publisherName\" : \"Foo News\","
+      "  \"imageUrl\" : \"http://localhost/foobar.jpg\","
+      "  \"ampUrl\" : \"http://localhost/amp\","
+      "  \"faviconUrl\" : \"http://localhost/favicon.ico\" "
       "}]}";
   SetFakeResponse(/*data=*/kJsonStr, net::HTTP_OK,
                   net::URLRequestStatus::SUCCESS);
diff --git a/components/ntp_snippets/offline_pages/offline_page_suggestions_provider.cc b/components/ntp_snippets/offline_pages/offline_page_suggestions_provider.cc
index 2d262ec..d2380c8 100644
--- a/components/ntp_snippets/offline_pages/offline_page_suggestions_provider.cc
+++ b/components/ntp_snippets/offline_pages/offline_page_suggestions_provider.cc
@@ -5,11 +5,8 @@
 #include "components/ntp_snippets/offline_pages/offline_page_suggestions_provider.h"
 
 #include "base/bind.h"
-#include "base/location.h"
 #include "base/strings/string_number_conversions.h"
 #include "base/strings/utf_string_conversions.h"
-#include "base/threading/thread_task_runner_handle.h"
-#include "ui/gfx/image/image.h"
 
 using offline_pages::MultipleOfflinePageItemResult;
 using offline_pages::OfflinePageModel;
@@ -61,10 +58,7 @@ void OfflinePageSuggestionsProvider::DismissSuggestion(
 void OfflinePageSuggestionsProvider::FetchSuggestionImage(
     const std::string& suggestion_id,
     const ImageFetchedCallback& callback) {
-  // TODO(pke): Fetch proper thumbnail from OfflinePageModel once it's available
-  // there.
-  base::ThreadTaskRunnerHandle::Get()->PostTask(
-      FROM_HERE, base::Bind(callback, suggestion_id, gfx::Image()));
+  // TODO(pke): Implement.
 }
 
 void OfflinePageSuggestionsProvider::ClearCachedSuggestionsForDebugging() {
diff --git a/components/ntp_tiles/most_visited_sites.cc b/components/ntp_tiles/most_visited_sites.cc
index bec9110..02b6776 100644
--- a/components/ntp_tiles/most_visited_sites.cc
+++ b/components/ntp_tiles/most_visited_sites.cc
@@ -157,16 +157,12 @@ MostVisitedSites::MostVisitedSites(PrefService* prefs,
       top_sites_observer_(this),
       mv_source_(NTPTileSource::SUGGESTIONS_SERVICE),
       weak_ptr_factory_(this) {
-  DCHECK(prefs_);
-  DCHECK(top_sites_);
   DCHECK(suggestions_service_);
-  if (supervisor_)
-    supervisor_->SetObserver(this);
+  supervisor_->SetObserver(this);
 }
 
 MostVisitedSites::~MostVisitedSites() {
-  if (supervisor_)
-    supervisor_->SetObserver(nullptr);
+  supervisor_->SetObserver(nullptr);
 }
 
 void MostVisitedSites::SetMostVisitedURLsObserver(Observer* observer,
@@ -295,11 +291,9 @@ void MostVisitedSites::InitiateTopSitesQuery() {
 }
 
 base::FilePath MostVisitedSites::GetWhitelistLargeIconPath(const GURL& url) {
-  if (supervisor_) {
-    for (const auto& whitelist : supervisor_->whitelists()) {
-      if (AreURLsEquivalent(whitelist.entry_point, url))
-        return whitelist.large_icon_path;
-    }
+  for (const auto& whitelist : supervisor_->whitelists()) {
+    if (AreURLsEquivalent(whitelist.entry_point, url))
+      return whitelist.large_icon_path;
   }
   return base::FilePath();
 }
@@ -315,7 +309,7 @@ void MostVisitedSites::OnMostVisitedURLsAvailable(
       num_tiles = i;
       break;  // This is the signal that there are no more real visited sites.
     }
-    if (supervisor_ && supervisor_->IsBlocked(visited.url))
+    if (supervisor_->IsBlocked(visited.url))
       continue;
 
     NTPTile tile;
@@ -349,7 +343,7 @@ void MostVisitedSites::OnSuggestionsProfileAvailable(
   for (int i = 0; i < num_tiles; ++i) {
     const ChromeSuggestion& suggestion_pb = suggestions_profile.suggestions(i);
     GURL url(suggestion_pb.url());
-    if (supervisor_ && supervisor_->IsBlocked(url))
+    if (supervisor_->IsBlocked(url))
       continue;
 
     NTPTile tile;
@@ -369,10 +363,6 @@ void MostVisitedSites::OnSuggestionsProfileAvailable(
 
 NTPTilesVector MostVisitedSites::CreateWhitelistEntryPointTiles(
     const NTPTilesVector& personal_tiles) {
-  if (!supervisor_) {
-    return NTPTilesVector();
-  }
-
   size_t num_personal_tiles = personal_tiles.size();
   DCHECK_LE(num_personal_tiles, static_cast<size_t>(num_sites_));
 
@@ -415,7 +405,7 @@ NTPTilesVector MostVisitedSites::CreatePopularSitesTiles(
     const NTPTilesVector& personal_tiles,
     const NTPTilesVector& whitelist_tiles) {
   // For child accounts popular sites tiles will not be added.
-  if (supervisor_ && supervisor_->IsChildProfile())
+  if (supervisor_->IsChildProfile())
     return NTPTilesVector();
 
   size_t num_tiles = personal_tiles.size() + whitelist_tiles.size();
diff --git a/components/ntp_tiles/most_visited_sites.h b/components/ntp_tiles/most_visited_sites.h
index 77440f4..9d2fed9 100644
--- a/components/ntp_tiles/most_visited_sites.h
+++ b/components/ntp_tiles/most_visited_sites.h
@@ -111,11 +111,6 @@ class MostVisitedSites : public history::TopSitesObserver,
     virtual ~Observer() {}
   };
 
-  // Construct a MostVisitedSites instance.
-  //
-  // |prefs|, |top_sites|, and |suggestions| are required and may not be null.
-  // |popular_sites| and |supervisor| are optional and if null the associated
-  // features will be disabled.
   MostVisitedSites(PrefService* prefs,
                    scoped_refptr<history::TopSites> top_sites,
                    suggestions::SuggestionsService* suggestions,
diff --git a/components/offline_pages/background/request_coordinator.cc b/components/offline_pages/background/request_coordinator.cc
index 426b90b..19906d7 100644
--- a/components/offline_pages/background/request_coordinator.cc
+++ b/components/offline_pages/background/request_coordinator.cc
@@ -24,24 +24,10 @@ namespace {
 
 // Records the final request status UMA for an offlining request. This should
 // only be called once per Offliner::LoadAndSave request.
-void RecordOfflinerResultUMA(const ClientId& client_id,
-                             Offliner::RequestStatus request_status) {
-  // TODO(dougarnett): Consider exposing AddHistogramSuffix from
-  // offline_page_model_impl.cc as visible utility method.
-  std::string histogram_name("OfflinePages.Background.OfflinerRequestStatus");
-  if (!client_id.name_space.empty()) {
-    histogram_name += "." + client_id.name_space;
-  }
-
-  // The histogram below is an expansion of the UMA_HISTOGRAM_ENUMERATION
-  // macro adapted to allow for a dynamically suffixed histogram name.
-  // Note: The factory creates and owns the histogram.
-  base::HistogramBase* histogram = base::LinearHistogram::FactoryGet(
-      histogram_name, 1,
-      static_cast<int>(Offliner::RequestStatus::STATUS_COUNT),
-      static_cast<int>(Offliner::RequestStatus::STATUS_COUNT) + 1,
-      base::HistogramBase::kUmaTargetedHistogramFlag);
-  histogram->Add(static_cast<int>(request_status));
+void RecordOfflinerResultUMA(Offliner::RequestStatus request_status) {
+  UMA_HISTOGRAM_ENUMERATION("OfflinePages.Background.OfflinerRequestStatus",
+                            request_status,
+                            Offliner::RequestStatus::STATUS_COUNT);
 }
 
 }  // namespace
@@ -57,7 +43,6 @@ RequestCoordinator::RequestCoordinator(std::unique_ptr<OfflinerPolicy> policy,
       factory_(std::move(factory)),
       queue_(std::move(queue)),
       scheduler_(std::move(scheduler)),
-      active_request_(nullptr),
       last_offlining_status_(Offliner::RequestStatus::UNKNOWN),
       offliner_timeout_(base::TimeDelta::FromSeconds(
           policy_->GetSinglePageTimeLimitInSeconds())),
@@ -166,12 +151,7 @@ void RequestCoordinator::StopProcessing() {
   // Stopping offliner means it will not call callback.
   last_offlining_status_ =
       Offliner::RequestStatus::REQUEST_COORDINATOR_CANCELED;
-
-  if (active_request_) {
-    RecordOfflinerResultUMA(active_request_->client_id(),
-                            last_offlining_status_);
-    active_request_.reset();
-  }
+  RecordOfflinerResultUMA(last_offlining_status_);
 
   // Let the scheduler know we are done processing.
   scheduler_callback_.Run(true);
@@ -249,7 +229,6 @@ void RequestCoordinator::SendRequestToOffliner(const SavePageRequest& request) {
 
   DCHECK(!is_busy_);
   is_busy_ = true;
-  active_request_.reset(new SavePageRequest(request));
 
   // Prepare an updated request to attempt.
   SavePageRequest updated_request(request);
@@ -285,11 +264,10 @@ void RequestCoordinator::OfflinerDoneCallback(const SavePageRequest& request,
   event_logger_.RecordSavePageRequestUpdated(request.client_id().name_space,
                                              status, request.request_id());
   last_offlining_status_ = status;
-  RecordOfflinerResultUMA(request.client_id(), last_offlining_status_);
+  RecordOfflinerResultUMA(last_offlining_status_);
   watchdog_timer_.Stop();
 
   is_busy_ = false;
-  active_request_.reset(nullptr);
 
   if (status == Offliner::RequestStatus::FOREGROUND_CANCELED) {
     // Update the request for the canceled attempt.
diff --git a/components/offline_pages/background/request_coordinator.h b/components/offline_pages/background/request_coordinator.h
index 5c6c03b..1e51f18 100644
--- a/components/offline_pages/background/request_coordinator.h
+++ b/components/offline_pages/background/request_coordinator.h
@@ -176,8 +176,6 @@ class RequestCoordinator : public KeyedService {
   std::unique_ptr<RequestQueue> queue_;
   // Scheduler. Used to request a callback when network is available.  Owned.
   std::unique_ptr<Scheduler> scheduler_;
-  // Holds copy of the active request, if any.
-  std::unique_ptr<SavePageRequest> active_request_;
   // Status of the most recent offlining.
   Offliner::RequestStatus last_offlining_status_;
   // Class to choose which request to schedule next
diff --git a/components/offline_pages/background/save_page_request.cc b/components/offline_pages/background/save_page_request.cc
index 2ed90bd..e5424d7 100644
--- a/components/offline_pages/background/save_page_request.cc
+++ b/components/offline_pages/background/save_page_request.cc
@@ -45,6 +45,26 @@ SavePageRequest::SavePageRequest(const SavePageRequest& other)
 
 SavePageRequest::~SavePageRequest() {}
 
+// TODO(fgorski): Introduce policy parameter, once policy is available.
+SavePageRequest::Status SavePageRequest::GetStatus(
+    const base::Time& now) const {
+  if (now < activation_time_)
+    return Status::NOT_READY;
+
+  // TODO(fgorski): enable check once policy available.
+  // if (attempt_count_ >= policy.max_attempt_count)
+  // return Status::FAILED;
+
+  // TODO(fgorski): enable check once policy available.
+  // if (activation_time_+ policy.page_expiration_interval < now)
+  // return Status::EXPIRED;
+
+  if (creation_time_ < last_attempt_time_)
+    return Status::STARTED;
+
+  return Status::PENDING;
+}
+
 void SavePageRequest::MarkAttemptStarted(const base::Time& start_time) {
   DCHECK_LE(activation_time_, start_time);
   // TODO(fgorski): As part of introducing policy in GetStatus, we can make a
diff --git a/components/offline_pages/background/save_page_request.h b/components/offline_pages/background/save_page_request.h
index b83b9b5..d241dea 100644
--- a/components/offline_pages/background/save_page_request.h
+++ b/components/offline_pages/background/save_page_request.h
@@ -16,6 +16,17 @@ namespace offline_pages {
 // Class representing a request to save page.
 class SavePageRequest {
  public:
+  enum class Status {
+    NOT_READY,  // Component requested a page be saved, but not until
+                // |activation_time_|.
+    PENDING,    // Page request is pending, and coordinator can attempt it
+                // when it gets a chance to.
+    STARTED,    // The request is currently being processed.
+    FAILED,     // Page request failed many times and will no longer be
+                // retried.
+    EXPIRED,    // Save page request expired without being fulfilled.
+  };
+
   SavePageRequest(int64_t request_id,
                   const GURL& url,
                   const ClientId& client_id,
@@ -30,6 +41,9 @@ class SavePageRequest {
   SavePageRequest(const SavePageRequest& other);
   ~SavePageRequest();
 
+  // Status of this request.
+  Status GetStatus(const base::Time& now) const;
+
   // Updates the |last_attempt_time_| and increments |attempt_count_|.
   void MarkAttemptStarted(const base::Time& start_time);
 
diff --git a/components/offline_pages/background/save_page_request_unittest.cc b/components/offline_pages/background/save_page_request_unittest.cc
index 1cccc24..68f12fe 100644
--- a/components/offline_pages/background/save_page_request_unittest.cc
+++ b/components/offline_pages/background/save_page_request_unittest.cc
@@ -33,6 +33,32 @@ TEST_F(SavePageRequestTest, CreatePendingReqeust) {
   ASSERT_EQ(creation_time, request.activation_time());
   ASSERT_EQ(base::Time(), request.last_attempt_time());
   ASSERT_EQ(0, request.attempt_count());
+
+  base::Time after_creation = creation_time + base::TimeDelta::FromHours(6);
+  ASSERT_EQ(SavePageRequest::Status::PENDING,
+            request.GetStatus(after_creation));
+}
+
+TEST_F(SavePageRequestTest, CreateNotReadyRequest) {
+  base::Time creation_time = base::Time::Now();
+  base::Time activation_time = creation_time + base::TimeDelta::FromHours(6);
+  SavePageRequest request(kRequestId, kUrl, kClientId, creation_time,
+                          activation_time, kUserRequested);
+
+  ASSERT_EQ(kRequestId, request.request_id());
+  ASSERT_EQ(kUrl, request.url());
+  ASSERT_EQ(kClientId, request.client_id());
+  ASSERT_EQ(creation_time, request.creation_time());
+  ASSERT_EQ(activation_time, request.activation_time());
+  ASSERT_EQ(base::Time(), request.last_attempt_time());
+  ASSERT_EQ(0, request.attempt_count());
+
+  base::Time not_ready_time = activation_time - base::TimeDelta::FromHours(3);
+  ASSERT_EQ(SavePageRequest::Status::NOT_READY,
+            request.GetStatus(not_ready_time));
+
+  base::Time ready_time = activation_time + base::TimeDelta::FromHours(3);
+  ASSERT_EQ(SavePageRequest::Status::PENDING, request.GetStatus(ready_time));
 }
 
 TEST_F(SavePageRequestTest, StartAndCompleteRequest) {
@@ -55,6 +81,8 @@ TEST_F(SavePageRequestTest, StartAndCompleteRequest) {
   ASSERT_EQ(start_time, request.last_attempt_time());
   ASSERT_EQ(1, request.attempt_count());
 
+  ASSERT_EQ(SavePageRequest::Status::STARTED, request.GetStatus(start_time));
+
   request.MarkAttemptCompleted();
 
   // Again, most things don't change about the request.
@@ -67,6 +95,7 @@ TEST_F(SavePageRequestTest, StartAndCompleteRequest) {
   // Last attempt time and status are updated.
   ASSERT_EQ(base::Time(), request.last_attempt_time());
   ASSERT_EQ(1, request.attempt_count());
+  ASSERT_EQ(SavePageRequest::Status::PENDING, request.GetStatus(start_time));
 }
 
 TEST_F(SavePageRequestTest, StartAndAbortRequest) {
diff --git a/components/os_crypt/BUILD.gn b/components/os_crypt/BUILD.gn
index 2c40d08..7ae6930 100644
--- a/components/os_crypt/BUILD.gn
+++ b/components/os_crypt/BUILD.gn
@@ -4,29 +4,6 @@
 
 import("//build/config/features.gni")
 import("//build/config/ui.gni")
-import("//build/config/linux/pkg_config.gni")
-
-if (is_desktop_linux) {
-  # Gnome-keyring is normally dynamically loaded. The gnome_keyring config
-  # will set this up.
-  pkg_config("gnome_keyring") {
-    packages = [ "gnome-keyring-1" ]
-    defines = [ "USE_GNOME_KEYRING" ]
-    ignore_libs = true
-  }
-
-  # If you want to link gnome-keyring directly (use only for unit tests)
-  # ADDITIONALLY add this config on top of ":gnome_keyring". pkg-config is a
-  # bit slow, so prefer not to run it again. In practice, gnome-keyring's libs
-  # are just itself and common gnome ones we link already, so we can get away
-  # with additionally just coding the library name here.
-  # TODO(cfroussios): This is only used by
-  # chrome/browser/password_manager/native_backend_gnome_x_unittest.cc
-  # We should deprecate both.
-  config("gnome_keyring_direct") {
-    libs = [ "gnome-keyring" ]
-  }
-}
 
 static_library("os_crypt") {
   sources = [
@@ -80,15 +57,10 @@ static_library("os_crypt") {
       sources += [
         "key_storage_libsecret.cc",
         "key_storage_libsecret.h",
-        "keyring_util_linux.cc",
-        "keyring_util_linux.h",
         "libsecret_util_linux.cc",
         "libsecret_util_linux.h",
       ]
-      configs += [
-        "//build/config/linux:glib",
-        ":gnome_keyring",
-      ]
+      configs += [ "//build/config/linux:glib" ]
       deps += [ "//third_party/libsecret" ]
       defines += [ "USE_LIBSECRET" ]
     }
diff --git a/components/os_crypt/keyring_util_linux.cc b/components/os_crypt/keyring_util_linux.cc
deleted file mode 100644
index 300a344..0000000
--- a/components/os_crypt/keyring_util_linux.cc
+++ /dev/null
@@ -1,82 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "components/os_crypt/keyring_util_linux.h"
-
-#include <dlfcn.h>
-
-#include "base/logging.h"
-
-decltype(&::gnome_keyring_is_available)
-    GnomeKeyringLoader::gnome_keyring_is_available_ptr;
-decltype(&::gnome_keyring_store_password)
-    GnomeKeyringLoader::gnome_keyring_store_password_ptr;
-decltype(&::gnome_keyring_delete_password)
-    GnomeKeyringLoader::gnome_keyring_delete_password_ptr;
-decltype(&::gnome_keyring_find_items)
-    GnomeKeyringLoader::gnome_keyring_find_items_ptr;
-decltype(&::gnome_keyring_result_to_message)
-    GnomeKeyringLoader::gnome_keyring_result_to_message_ptr;
-decltype(&::gnome_keyring_attribute_list_free)
-    GnomeKeyringLoader::gnome_keyring_attribute_list_free_ptr;
-decltype(&::gnome_keyring_attribute_list_new)
-    GnomeKeyringLoader::gnome_keyring_attribute_list_new_ptr;
-decltype(&::gnome_keyring_attribute_list_append_string)
-    GnomeKeyringLoader::gnome_keyring_attribute_list_append_string_ptr;
-decltype(&::gnome_keyring_attribute_list_append_uint32)
-    GnomeKeyringLoader::gnome_keyring_attribute_list_append_uint32_ptr;
-
-bool GnomeKeyringLoader::keyring_loaded = false;
-
-const GnomeKeyringLoader::FunctionInfo GnomeKeyringLoader::functions[] = {
-    {"gnome_keyring_is_available",
-     reinterpret_cast<void**>(&gnome_keyring_is_available_ptr)},
-    {"gnome_keyring_store_password",
-     reinterpret_cast<void**>(&gnome_keyring_store_password_ptr)},
-    {"gnome_keyring_delete_password",
-     reinterpret_cast<void**>(&gnome_keyring_delete_password_ptr)},
-    {"gnome_keyring_find_items",
-     reinterpret_cast<void**>(&gnome_keyring_find_items_ptr)},
-    {"gnome_keyring_result_to_message",
-     reinterpret_cast<void**>(&gnome_keyring_result_to_message_ptr)},
-    {"gnome_keyring_attribute_list_free",
-     reinterpret_cast<void**>(&gnome_keyring_attribute_list_free_ptr)},
-    {"gnome_keyring_attribute_list_new",
-     reinterpret_cast<void**>(&gnome_keyring_attribute_list_new_ptr)},
-    {"gnome_keyring_attribute_list_append_string",
-     reinterpret_cast<void**>(&gnome_keyring_attribute_list_append_string_ptr)},
-    {"gnome_keyring_attribute_list_append_uint32",
-     reinterpret_cast<void**>(
-         &gnome_keyring_attribute_list_append_uint32_ptr)}};
-
-/* Load the library and initialize the function pointers. */
-bool GnomeKeyringLoader::LoadGnomeKeyring() {
-  if (keyring_loaded)
-    return true;
-
-  void* handle = dlopen("libgnome-keyring.so.0", RTLD_NOW | RTLD_GLOBAL);
-  if (!handle) {
-    // We wanted to use GNOME Keyring, but we couldn't load it. Warn, because
-    // either the user asked for this, or we autodetected it incorrectly. (Or
-    // the system has broken libraries, which is also good to warn about.)
-    LOG(WARNING) << "Could not load libgnome-keyring.so.0: " << dlerror();
-    return false;
-  }
-
-  for (size_t i = 0; i < arraysize(functions); ++i) {
-    dlerror();
-    *functions[i].pointer = dlsym(handle, functions[i].name);
-    const char* error = dlerror();
-    if (error) {
-      LOG(ERROR) << "Unable to load symbol " << functions[i].name << ": "
-                 << error;
-      dlclose(handle);
-      return false;
-    }
-  }
-
-  keyring_loaded = true;
-  // We leak the library handle. That's OK: this function is called only once.
-  return true;
-}
diff --git a/components/os_crypt/keyring_util_linux.h b/components/os_crypt/keyring_util_linux.h
deleted file mode 100644
index 4302c83..0000000
--- a/components/os_crypt/keyring_util_linux.h
+++ /dev/null
@@ -1,66 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef COMPONENTS_OS_CRYPT_KEYRING_UTIL_LINUX_H_
-#define COMPONENTS_OS_CRYPT_KEYRING_UTIL_LINUX_H_
-
-// libgnome-keyring has been deprecated in favor of libsecret.
-// See: https://mail.gnome.org/archives/commits-list/2013-October/msg08876.html
-//
-// The define below turns off the deprecations, in order to avoid build
-// failures with Gnome 3.12. When we move to libsecret, the define can be
-// removed, together with the include below it.
-//
-// The porting is tracked in http://crbug.com/355223
-#define GNOME_KEYRING_DEPRECATED
-#define GNOME_KEYRING_DEPRECATED_FOR(x)
-#include <gnome-keyring.h>
-
-#include "base/macros.h"
-
-// Many of the gnome_keyring_* functions use variable arguments, which makes
-// them difficult if not impossible to truly wrap in C. Therefore, we use
-// appropriately-typed function pointers and scoping to make the fact that we
-// might be dynamically loading the library almost invisible. As a bonus, we
-// also get a simple way to mock the library for testing. Classes that inherit
-// from GnomeKeyringLoader will use its versions of the gnome_keyring_*
-// functions. Note that it has only static fields.
-class GnomeKeyringLoader {
- protected:
-  static bool LoadGnomeKeyring();
-
-  // Declare the actual function pointers that we'll use in client code.
-  static decltype(&::gnome_keyring_is_available) gnome_keyring_is_available_ptr;
-  static decltype(
-      &::gnome_keyring_store_password) gnome_keyring_store_password_ptr;
-  static decltype(
-      &::gnome_keyring_delete_password) gnome_keyring_delete_password_ptr;
-  static decltype(&::gnome_keyring_find_items) gnome_keyring_find_items_ptr;
-  static decltype(
-      &::gnome_keyring_result_to_message) gnome_keyring_result_to_message_ptr;
-  static decltype(&::gnome_keyring_attribute_list_free)
-      gnome_keyring_attribute_list_free_ptr;
-  static decltype(
-      &::gnome_keyring_attribute_list_new) gnome_keyring_attribute_list_new_ptr;
-  static decltype(&::gnome_keyring_attribute_list_append_string)
-      gnome_keyring_attribute_list_append_string_ptr;
-  static decltype(&::gnome_keyring_attribute_list_append_uint32)
-      gnome_keyring_attribute_list_append_uint32_ptr;
-  // We also use gnome_keyring_attribute_list_index(), which is a macro and
-  // can't be referenced.
-
-  // Set to true if LoadGnomeKeyring() has already succeeded.
-  static bool keyring_loaded;
-
- private:
-  struct FunctionInfo {
-    const char* name;
-    void** pointer;
-  };
-
-  // Make it easy to initialize the function pointers in LoadGnomeKeyring().
-  static const FunctionInfo functions[];
-};
-
-#endif  // COMPONENTS_OS_CRYPT_KEYRING_UTIL_LINUX_H_
diff --git a/components/plugins/renderer/loadable_plugin_placeholder.cc b/components/plugins/renderer/loadable_plugin_placeholder.cc
index a8c6d71..7d50eec 100644
--- a/components/plugins/renderer/loadable_plugin_placeholder.cc
+++ b/components/plugins/renderer/loadable_plugin_placeholder.cc
@@ -263,8 +263,7 @@ void LoadablePluginPlaceholder::OnLoadBlockedPlugins(
     return;
 
   RenderThread::Get()->RecordAction(UserMetricsAction("Plugin_Load_UI"));
-  MarkPluginEssential(
-      PluginInstanceThrottler::UNTHROTTLE_METHOD_BY_OMNIBOX_ICON);
+  MarkPluginEssential(PluginInstanceThrottler::UNTHROTTLE_METHOD_DO_NOT_RECORD);
   LoadPlugin();
 }
 
diff --git a/components/printing/renderer/print_web_view_helper.cc b/components/printing/renderer/print_web_view_helper.cc
index f566eb6..2842ca5 100644
--- a/components/printing/renderer/print_web_view_helper.cc
+++ b/components/printing/renderer/print_web_view_helper.cc
@@ -703,11 +703,11 @@ void PrepareFrameAndViewForPrint::ResizeForPrinting() {
 }
 
 void PrepareFrameAndViewForPrint::StartPrinting() {
+  ResizeForPrinting();
   blink::WebView* web_view = frame_.view();
   web_view->settings()->setShouldPrintBackgrounds(should_print_backgrounds_);
   expected_pages_count_ =
       frame()->printBegin(web_print_params_, node_to_print_);
-  ResizeForPrinting();
   is_printing_started_ = true;
 }
 
diff --git a/components/safe_browsing_db/BUILD.gn b/components/safe_browsing_db/BUILD.gn
index 1e11626..5cb1832 100644
--- a/components/safe_browsing_db/BUILD.gn
+++ b/components/safe_browsing_db/BUILD.gn
@@ -155,7 +155,6 @@ static_library("util") {
     "util.h",
   ]
   deps = [
-    ":v4_protocol_manager_util",
     "//base",
     "//base:base",
     "//crypto",
diff --git a/components/safe_browsing_db/util.cc b/components/safe_browsing_db/util.cc
index f86fc77..74eb45e 100644
--- a/components/safe_browsing_db/util.cc
+++ b/components/safe_browsing_db/util.cc
@@ -7,11 +7,12 @@
 #include <stddef.h>
 
 #include "base/macros.h"
+#include "base/strings/string_util.h"
 #include "base/trace_event/trace_event.h"
-#include "components/safe_browsing_db/v4_protocol_manager_util.h"
 #include "crypto/sha2.h"
 #include "net/base/escape.h"
 #include "url/gurl.h"
+#include "url/url_util.h"
 
 namespace safe_browsing {
 
@@ -28,6 +29,67 @@ bool IsKnownList(const std::string& name) {
   return false;
 }
 
+void GenerateHostVariantsToCheck(const std::string& host,
+                                 std::vector<std::string>* hosts) {
+  hosts->clear();
+
+  if (host.empty())
+    return;
+
+  // Per the Safe Browsing Protocol v2 spec, we try the host, and also up to 4
+  // hostnames formed by starting with the last 5 components and successively
+  // removing the leading component.  The last component isn't examined alone,
+  // since it's the TLD or a subcomponent thereof.
+  //
+  // Note that we don't need to be clever about stopping at the "real" eTLD --
+  // the data on the server side has been filtered to ensure it will not
+  // blacklist a whole TLD, and it's not significantly slower on our side to
+  // just check too much.
+  //
+  // Also note that because we have a simple blacklist, not some sort of complex
+  // whitelist-in-blacklist or vice versa, it doesn't matter what order we check
+  // these in.
+  const size_t kMaxHostsToCheck = 4;
+  bool skipped_last_component = false;
+  for (std::string::const_reverse_iterator i(host.rbegin());
+       i != host.rend() && hosts->size() < kMaxHostsToCheck; ++i) {
+    if (*i == '.') {
+      if (skipped_last_component)
+        hosts->push_back(std::string(i.base(), host.end()));
+      else
+        skipped_last_component = true;
+    }
+  }
+  hosts->push_back(host);
+}
+
+void GeneratePathVariantsToCheck(const std::string& path,
+                                 const std::string& query,
+                                 std::vector<std::string>* paths) {
+  paths->clear();
+
+  if (path.empty())
+    return;
+
+  // Per the Safe Browsing Protocol v2 spec, we try the exact path with/without
+  // the query parameters, and also up to 4 paths formed by starting at the root
+  // and adding more path components.
+  //
+  // As with the hosts above, it doesn't matter what order we check these in.
+  const size_t kMaxPathsToCheck = 4;
+  for (std::string::const_iterator i(path.begin());
+       i != path.end() && paths->size() < kMaxPathsToCheck; ++i) {
+    if (*i == '/')
+      paths->push_back(std::string(path.begin(), i + 1));
+  }
+
+  if (!paths->empty() && paths->back() != path)
+    paths->push_back(path);
+
+  if (!query.empty())
+    paths->push_back(path + "?" + query);
+}
+
 }  // namespace
 
 // ThreatMetadata ------------------------------------------------------------
@@ -154,6 +216,163 @@ std::string SBFullHashToString(const SBFullHash& hash) {
   return std::string(hash.full_hash, sizeof(hash.full_hash));
 }
 
+
+std::string Unescape(const std::string& url) {
+  std::string unescaped_str(url);
+  const int kMaxLoopIterations = 1024;
+  size_t old_size = 0;
+  int loop_var = 0;
+  do {
+    old_size = unescaped_str.size();
+    unescaped_str = net::UnescapeURLComponent(
+        unescaped_str,
+        net::UnescapeRule::SPOOFING_AND_CONTROL_CHARS |
+            net::UnescapeRule::SPACES | net::UnescapeRule::PATH_SEPARATORS |
+            net::UnescapeRule::URL_SPECIAL_CHARS_EXCEPT_PATH_SEPARATORS);
+  } while (old_size != unescaped_str.size() &&
+           ++loop_var <= kMaxLoopIterations);
+
+  return unescaped_str;
+}
+
+std::string Escape(const std::string& url) {
+  std::string escaped_str;
+  // The escaped string is larger so allocate double the length to reduce the
+  // chance of the string being grown.
+  escaped_str.reserve(url.length() * 2);
+  const char* kHexString = "0123456789ABCDEF";
+  for (size_t i = 0; i < url.length(); i++) {
+    unsigned char c = static_cast<unsigned char>(url[i]);
+    if (c <= ' ' || c > '~' || c == '#' || c == '%') {
+      escaped_str += '%';
+      escaped_str += kHexString[c >> 4];
+      escaped_str += kHexString[c & 0xf];
+    } else {
+      escaped_str += c;
+    }
+  }
+
+  return escaped_str;
+}
+
+std::string RemoveConsecutiveChars(base::StringPiece str, const char c) {
+  std::string output;
+  // Output is at most the length of the original string.
+  output.reserve(str.size());
+
+  size_t i = 0;
+  while (i < str.size()) {
+    output.append(1, str[i++]);
+    if (str[i - 1] == c) {
+      while (i < str.size() && str[i] == c) {
+        i++;
+      }
+    }
+  }
+
+  return output;
+}
+
+// Canonicalizes url as per Google Safe Browsing Specification.
+// See section 6.1 in
+// http://code.google.com/p/google-safe-browsing/wiki/Protocolv2Spec.
+void CanonicalizeUrl(const GURL& url,
+                     std::string* canonicalized_hostname,
+                     std::string* canonicalized_path,
+                     std::string* canonicalized_query) {
+  DCHECK(url.is_valid());
+
+  // We only canonicalize "normal" URLs.
+  if (!url.IsStandard())
+    return;
+
+  // Following canonicalization steps are excluded since url parsing takes care
+  // of those :-
+  // 1. Remove any tab (0x09), CR (0x0d), and LF (0x0a) chars from url.
+  //    (Exclude escaped version of these chars).
+  // 2. Normalize hostname to 4 dot-seperated decimal values.
+  // 3. Lowercase hostname.
+  // 4. Resolve path sequences "/../" and "/./".
+
+  // That leaves us with the following :-
+  // 1. Remove fragment in URL.
+  GURL url_without_fragment;
+  GURL::Replacements f_replacements;
+  f_replacements.ClearRef();
+  f_replacements.ClearUsername();
+  f_replacements.ClearPassword();
+  url_without_fragment = url.ReplaceComponents(f_replacements);
+
+  // 2. Do URL unescaping until no more hex encoded characters exist.
+  std::string url_unescaped_str(Unescape(url_without_fragment.spec()));
+  url::Parsed parsed;
+  url::ParseStandardURL(url_unescaped_str.data(), url_unescaped_str.length(),
+                        &parsed);
+
+  // 3. In hostname, remove all leading and trailing dots.
+  base::StringPiece host;
+  if (parsed.host.len > 0)
+    host.set(url_unescaped_str.data() + parsed.host.begin, parsed.host.len);
+
+  base::StringPiece host_without_end_dots =
+      base::TrimString(host, ".", base::TrimPositions::TRIM_ALL);
+
+  // 4. In hostname, replace consecutive dots with a single dot.
+  std::string host_without_consecutive_dots(RemoveConsecutiveChars(
+      host_without_end_dots, '.'));
+
+  // 5. In path, replace runs of consecutive slashes with a single slash.
+  base::StringPiece path;
+  if (parsed.path.len > 0)
+    path.set(url_unescaped_str.data() + parsed.path.begin, parsed.path.len);
+  std::string path_without_consecutive_slash(RemoveConsecutiveChars(path, '/'));
+
+  url::Replacements<char> hp_replacements;
+  hp_replacements.SetHost(
+      host_without_consecutive_dots.data(),
+      url::Component(0, host_without_consecutive_dots.length()));
+  hp_replacements.SetPath(
+      path_without_consecutive_slash.data(),
+      url::Component(0, path_without_consecutive_slash.length()));
+
+  std::string url_unescaped_with_can_hostpath;
+  url::StdStringCanonOutput output(&url_unescaped_with_can_hostpath);
+  url::Parsed temp_parsed;
+  url::ReplaceComponents(url_unescaped_str.data(),
+                         url_unescaped_str.length(),
+                         parsed,
+                         hp_replacements,
+                         NULL,
+                         &output,
+                         &temp_parsed);
+  output.Complete();
+
+  // 6. Step needed to revert escaping done in url::ReplaceComponents.
+  url_unescaped_with_can_hostpath = Unescape(url_unescaped_with_can_hostpath);
+
+  // 7. After performing all above steps, percent-escape all chars in url which
+  // are <= ASCII 32, >= 127, #, %. Escapes must be uppercase hex characters.
+  std::string escaped_canon_url_str(Escape(url_unescaped_with_can_hostpath));
+  url::Parsed final_parsed;
+  url::ParseStandardURL(escaped_canon_url_str.data(),
+                        escaped_canon_url_str.length(),
+                        &final_parsed);
+
+  if (canonicalized_hostname && final_parsed.host.len > 0) {
+    *canonicalized_hostname =
+        escaped_canon_url_str.substr(final_parsed.host.begin,
+                                     final_parsed.host.len);
+  }
+  if (canonicalized_path && final_parsed.path.len > 0) {
+    *canonicalized_path = escaped_canon_url_str.substr(final_parsed.path.begin,
+                                                       final_parsed.path.len);
+  }
+  if (canonicalized_query && final_parsed.query.len > 0) {
+    *canonicalized_query = escaped_canon_url_str.substr(
+        final_parsed.query.begin, final_parsed.query.len);
+  }
+}
+
 void UrlToFullHashes(const GURL& url,
                      bool include_whitelist_hashes,
                      std::vector<SBFullHash>* full_hashes) {
@@ -164,19 +383,17 @@ void UrlToFullHashes(const GURL& url,
   std::string canon_host;
   std::string canon_path;
   std::string canon_query;
-  V4ProtocolManagerUtil::CanonicalizeUrl(url, &canon_host, &canon_path,
-                                         &canon_query);
+  CanonicalizeUrl(url, &canon_host, &canon_path, &canon_query);
 
   std::vector<std::string> hosts;
   if (url.HostIsIPAddress()) {
     hosts.push_back(url.host());
   } else {
-    V4ProtocolManagerUtil::GenerateHostVariantsToCheck(canon_host, &hosts);
+    GenerateHostVariantsToCheck(canon_host, &hosts);
   }
 
   std::vector<std::string> paths;
-  V4ProtocolManagerUtil::GeneratePathVariantsToCheck(canon_path, canon_query,
-                                                     &paths);
+  GeneratePathVariantsToCheck(canon_path, canon_query, &paths);
 
   for (const std::string& host : hosts) {
     for (const std::string& path : paths) {
@@ -194,4 +411,33 @@ void UrlToFullHashes(const GURL& url,
   }
 }
 
+void GenerateHostsToCheck(const GURL& url, std::vector<std::string>* hosts) {
+  std::string canon_host;
+  CanonicalizeUrl(url, &canon_host, NULL, NULL);
+  GenerateHostVariantsToCheck(canon_host, hosts);
+}
+
+void GeneratePathsToCheck(const GURL& url, std::vector<std::string>* paths) {
+  std::string canon_path;
+  std::string canon_query;
+  CanonicalizeUrl(url, NULL, &canon_path, &canon_query);
+  GeneratePathVariantsToCheck(canon_path, canon_query, paths);
+}
+
+void GeneratePatternsToCheck(const GURL& url, std::vector<std::string>* urls) {
+  std::string canon_host;
+  std::string canon_path;
+  std::string canon_query;
+  CanonicalizeUrl(url, &canon_host, &canon_path, &canon_query);
+
+  std::vector<std::string> hosts, paths;
+  GenerateHostVariantsToCheck(canon_host, &hosts);
+  GeneratePathVariantsToCheck(canon_path, canon_query, &paths);
+  for (size_t h = 0; h < hosts.size(); ++h) {
+    for (size_t p = 0; p < paths.size(); ++p) {
+      urls->push_back(hosts[h] + paths[p]);
+    }
+  }
+}
+
 }  // namespace safe_browsing
diff --git a/components/safe_browsing_db/util.h b/components/safe_browsing_db/util.h
index d87d63a..2e72b25 100644
--- a/components/safe_browsing_db/util.h
+++ b/components/safe_browsing_db/util.h
@@ -191,6 +191,14 @@ ListType GetListId(const base::StringPiece& name);
 // Maps a ListId to list name. Return false if fails.
 bool GetListName(ListType list_id, std::string* list);
 
+// Canonicalizes url as per Google Safe Browsing Specification.
+// See section 6.1 in
+// http://code.google.com/p/google-safe-browsing/wiki/Protocolv2Spec.
+void CanonicalizeUrl(const GURL& url, std::string* canonicalized_hostname,
+                     std::string* canonicalized_path,
+                     std::string* canonicalized_query);
+
+
 // Generate the set of full hashes to check for |url|.  If
 // |include_whitelist_hashes| is true we will generate additional path-prefixes
 // to match against the csd whitelist.  E.g., if the path-prefix /foo is on the
@@ -198,6 +206,17 @@ bool GetListName(ListType list_id, std::string* list);
 // other lists.  We'll also always add a pattern for the empty path.
 void UrlToFullHashes(const GURL& url, bool include_whitelist_hashes,
                      std::vector<SBFullHash>* full_hashes);
+
+// Given a URL, returns all the hosts we need to check.  They are returned
+// in order of size (i.e. b.c is first, then a.b.c).
+void GenerateHostsToCheck(const GURL& url, std::vector<std::string>* hosts);
+
+// Given a URL, returns all the paths we need to check.
+void GeneratePathsToCheck(const GURL& url, std::vector<std::string>* paths);
+
+// Given a URL, returns all the patterns we need to check.
+void GeneratePatternsToCheck(const GURL& url, std::vector<std::string>* urls);
+
 }  // namespace safe_browsing
 
 #endif  // COMPONENTS_SAFE_BROWSING_DB_UTIL_H_
diff --git a/components/safe_browsing_db/util_unittest.cc b/components/safe_browsing_db/util_unittest.cc
index c105c4a..85f32a9 100644
--- a/components/safe_browsing_db/util_unittest.cc
+++ b/components/safe_browsing_db/util_unittest.cc
@@ -14,6 +14,273 @@
 
 namespace safe_browsing {
 
+namespace {
+
+bool VectorContains(const std::vector<std::string>& data,
+                    const std::string& str) {
+  return std::find(data.begin(), data.end(), str) != data.end();
+}
+
+}  // namespace
+
+// Tests that we generate the required host/path combinations for testing
+// according to the Safe Browsing spec.
+// See section 6.2 in
+// http://code.google.com/p/google-safe-browsing/wiki/Protocolv2Spec.
+TEST(SafeBrowsingDbUtilTest, UrlParsing) {
+  std::vector<std::string> hosts, paths;
+
+  GURL url("http://a.b.c/1/2.html?param=1");
+  GenerateHostsToCheck(url, &hosts);
+  GeneratePathsToCheck(url, &paths);
+  EXPECT_EQ(hosts.size(), static_cast<size_t>(2));
+  EXPECT_EQ(paths.size(), static_cast<size_t>(4));
+  EXPECT_EQ(hosts[0], "b.c");
+  EXPECT_EQ(hosts[1], "a.b.c");
+
+  EXPECT_TRUE(VectorContains(paths, "/1/2.html?param=1"));
+  EXPECT_TRUE(VectorContains(paths, "/1/2.html"));
+  EXPECT_TRUE(VectorContains(paths, "/1/"));
+  EXPECT_TRUE(VectorContains(paths, "/"));
+
+  url = GURL("http://a.b.c.d.e.f.g/1.html");
+  GenerateHostsToCheck(url, &hosts);
+  GeneratePathsToCheck(url, &paths);
+  EXPECT_EQ(hosts.size(), static_cast<size_t>(5));
+  EXPECT_EQ(paths.size(), static_cast<size_t>(2));
+  EXPECT_EQ(hosts[0], "f.g");
+  EXPECT_EQ(hosts[1], "e.f.g");
+  EXPECT_EQ(hosts[2], "d.e.f.g");
+  EXPECT_EQ(hosts[3], "c.d.e.f.g");
+  EXPECT_EQ(hosts[4], "a.b.c.d.e.f.g");
+  EXPECT_TRUE(VectorContains(paths, "/1.html"));
+  EXPECT_TRUE(VectorContains(paths, "/"));
+
+  url = GURL("http://a.b/saw-cgi/eBayISAPI.dll/");
+  GeneratePathsToCheck(url, &paths);
+  EXPECT_EQ(paths.size(), static_cast<size_t>(3));
+  EXPECT_TRUE(VectorContains(paths, "/saw-cgi/eBayISAPI.dll/"));
+  EXPECT_TRUE(VectorContains(paths, "/saw-cgi/"));
+  EXPECT_TRUE(VectorContains(paths, "/"));
+}
+
+// Tests the url canonicalization according to the Safe Browsing spec.
+// See section 6.1 in
+// http://code.google.com/p/google-safe-browsing/wiki/Protocolv2Spec.
+TEST(SafeBrowsingDbUtilTest, CanonicalizeUrl) {
+  struct {
+    const char* input_url;
+    const char* expected_canonicalized_hostname;
+    const char* expected_canonicalized_path;
+    const char* expected_canonicalized_query;
+  } tests[] = {
+    {
+      "http://host/%25%32%35",
+      "host",
+      "/%25",
+      ""
+    }, {
+      "http://host/%25%32%35%25%32%35",
+      "host",
+      "/%25%25",
+      ""
+    }, {
+      "http://host/%2525252525252525",
+      "host",
+      "/%25",
+      ""
+    }, {
+      "http://host/asdf%25%32%35asd",
+      "host",
+      "/asdf%25asd",
+      ""
+    }, {
+      "http://host/%%%25%32%35asd%%",
+      "host",
+      "/%25%25%25asd%25%25",
+      ""
+    }, {
+      "http://host/%%%25%32%35asd%%",
+      "host",
+      "/%25%25%25asd%25%25",
+      ""
+    }, {
+      "http://www.google.com/",
+      "www.google.com",
+      "/",
+      ""
+    }, {
+      "http://%31%36%38%2e%31%38%38%2e%39%39%2e%32%36/%2E%73%65%63%75%72%65/%77"
+          "%77%77%2E%65%62%61%79%2E%63%6F%6D/",
+      "168.188.99.26",
+      "/.secure/www.ebay.com/",
+      ""
+    }, {
+      "http://195.127.0.11/uploads/%20%20%20%20/.verify/.eBaysecure=updateuserd"
+          "ataxplimnbqmn-xplmvalidateinfoswqpcmlx=hgplmcx/",
+      "195.127.0.11",
+      "/uploads/%20%20%20%20/.verify/.eBaysecure=updateuserdataxplimnbqmn-xplmv"
+          "alidateinfoswqpcmlx=hgplmcx/",
+      ""
+    }, {
+      "http://host.com/%257Ea%2521b%2540c%2523d%2524e%25f%255E00%252611%252A"
+          "22%252833%252944_55%252B",
+      "host.com",
+      "/~a!b@c%23d$e%25f^00&11*22(33)44_55+",
+      ""
+    }, {
+      "http://3279880203/blah",
+      "195.127.0.11",
+      "/blah",
+      ""
+    }, {
+      "http://www.google.com/blah/..",
+      "www.google.com",
+      "/",
+      ""
+    }, {
+      "http://www.google.com/blah#fraq",
+      "www.google.com",
+      "/blah",
+      ""
+    }, {
+      "http://www.GOOgle.com/",
+      "www.google.com",
+      "/",
+      ""
+    }, {
+      "http://www.google.com.../",
+      "www.google.com",
+      "/",
+      ""
+    }, {
+      "http://www.google.com/q?",
+      "www.google.com",
+      "/q",
+      ""
+    }, {
+      "http://www.google.com/q?r?",
+      "www.google.com",
+      "/q",
+      "r?"
+    }, {
+      "http://www.google.com/q?r?s",
+      "www.google.com",
+      "/q",
+      "r?s"
+    }, {
+      "http://evil.com/foo#bar#baz",
+      "evil.com",
+      "/foo",
+      ""
+    }, {
+      "http://evil.com/foo;",
+      "evil.com",
+      "/foo;",
+      ""
+    }, {
+      "http://evil.com/foo?bar;",
+      "evil.com",
+      "/foo",
+      "bar;"
+    }, {
+      "http://notrailingslash.com",
+      "notrailingslash.com",
+      "/",
+      ""
+    }, {
+      "http://www.gotaport.com:1234/",
+      "www.gotaport.com",
+      "/",
+      ""
+    }, {
+      "  http://www.google.com/  ",
+      "www.google.com",
+      "/",
+      ""
+    }, {
+      "http:// leadingspace.com/",
+      "%20leadingspace.com",
+      "/",
+      ""
+    }, {
+      "http://%20leadingspace.com/",
+      "%20leadingspace.com",
+      "/",
+      ""
+    }, {
+      "https://www.securesite.com/",
+      "www.securesite.com",
+      "/",
+      ""
+    }, {
+      "http://host.com/ab%23cd",
+      "host.com",
+      "/ab%23cd",
+      ""
+    }, {
+      "http://host%3e.com//twoslashes?more//slashes",
+      "host>.com",
+      "/twoslashes",
+      "more//slashes"
+    }, {
+      "http://host.com/abc?val=xyz#anything",
+      "host.com",
+      "/abc",
+      "val=xyz"
+    }, {
+      "http://abc:def@host.com/xyz",
+      "host.com",
+      "/xyz",
+      ""
+    }, {
+      "http://host%3e.com/abc/%2e%2e%2fdef",
+      "host>.com",
+      "/def",
+      ""
+    }, {
+      "http://.......host...com.....//abc/////def%2F%2F%2Fxyz",
+      "host.com",
+      "/abc/def/xyz",
+      ""
+    }, {
+      "ftp://host.com/foo?bar",
+      "host.com",
+      "/foo",
+      "bar"
+    }, {
+      "data:text/html;charset=utf-8,%0D%0A",
+      "",
+      "",
+      ""
+    }, {
+      "javascript:alert()",
+      "",
+      "",
+      ""
+    }, {
+      "mailto:abc@example.com",
+      "",
+      "",
+      ""
+    },
+  };
+  for (size_t i = 0; i < arraysize(tests); ++i) {
+    SCOPED_TRACE(base::StringPrintf("Test: %s", tests[i].input_url));
+    GURL url(tests[i].input_url);
+
+    std::string canonicalized_hostname;
+    std::string canonicalized_path;
+    std::string canonicalized_query;
+    CanonicalizeUrl(url, &canonicalized_hostname, &canonicalized_path,
+                    &canonicalized_query);
+
+    EXPECT_EQ(tests[i].expected_canonicalized_hostname, canonicalized_hostname);
+    EXPECT_EQ(tests[i].expected_canonicalized_path, canonicalized_path);
+    EXPECT_EQ(tests[i].expected_canonicalized_query, canonicalized_query);
+  }
+}
+
 TEST(SafeBrowsingDbUtilTest, UrlToFullHashes) {
   std::vector<SBFullHash> results;
   GURL url("http://www.evil.com/evil1/evilness.html");
diff --git a/components/safe_browsing_db/v4_local_database_manager.cc b/components/safe_browsing_db/v4_local_database_manager.cc
index 493ccc5..8432b4b 100644
--- a/components/safe_browsing_db/v4_local_database_manager.cc
+++ b/components/safe_browsing_db/v4_local_database_manager.cc
@@ -10,6 +10,7 @@
 #include <vector>
 
 #include "base/callback.h"
+#include "components/safe_browsing_db/safebrowsing.pb.h"
 #include "content/public/browser/browser_thread.h"
 
 using content::BrowserThread;
@@ -17,12 +18,29 @@ using content::BrowserThread;
 namespace safe_browsing {
 
 namespace {
+#if defined(OS_WIN)
+#define PLATFORM_TYPE WINDOWS_PLATFORM
+#elif defined(OS_LINUX)
+#define PLATFORM_TYPE LINUX_PLATFORM
+#elif defined(OS_MACOSX)
+#define PLATFORM_TYPE OSX_PLATFORM
+#else
+// This should ideally never compile but it is getting compiled on Android.
+// See: https://bugs.chromium.org/p/chromium/issues/detail?id=621647
+// TODO(vakh): Once that bug is fixed, this should be removed. If we leave
+// the platform_type empty, the server won't recognize the request and
+// return an error response which will pollute our UMA metrics.
+#define PLATFORM_TYPE LINUX_PLATFORM
+#endif
 
 // TODO(vakh): Implement this to populate the map appopriately.
 // Filed as http://crbug.com/608075
 StoreFileNameMap GetStoreFileNameMap() {
   return StoreFileNameMap(
-      {{kUrlMalwareId, "UrlMalware.store"}, {kUrlSocengId, "UrlSoceng.store"}});
+      {{UpdateListIdentifier(PLATFORM_TYPE, URL, MALWARE_THREAT),
+        "UrlMalware.store"},
+       {UpdateListIdentifier(PLATFORM_TYPE, URL, SOCIAL_ENGINEERING_PUBLIC),
+        "UrlSoceng.store"}});
 }
 
 }  // namespace
@@ -136,7 +154,7 @@ bool V4LocalDatabaseManager::IsCsdWhitelistKillSwitchOn() {
 bool V4LocalDatabaseManager::CheckBrowseUrl(const GURL& url, Client* client) {
   // TODO(vakh): Implement this skeleton.
   DCHECK_CURRENTLY_ON(BrowserThread::IO);
-  if (!enabled_ || !CanCheckUrl(url)) {
+  if (!enabled_) {
     return true;
   }
 
diff --git a/components/safe_browsing_db/v4_protocol_manager_util.cc b/components/safe_browsing_db/v4_protocol_manager_util.cc
index ffc13d4..e5e4f01 100644
--- a/components/safe_browsing_db/v4_protocol_manager_util.cc
+++ b/components/safe_browsing_db/v4_protocol_manager_util.cc
@@ -7,60 +7,15 @@
 #include "base/base64.h"
 #include "base/metrics/sparse_histogram.h"
 #include "base/rand_util.h"
-#include "base/strings/string_util.h"
 #include "base/strings/stringprintf.h"
-#include "crypto/sha2.h"
 #include "net/base/escape.h"
 #include "net/http/http_request_headers.h"
-#include "url/url_util.h"
 
 using base::Time;
 using base::TimeDelta;
 
 namespace safe_browsing {
 
-namespace {
-
-std::string Unescape(const std::string& url) {
-  std::string unescaped_str(url);
-  const int kMaxLoopIterations = 1024;
-  size_t old_size = 0;
-  int loop_var = 0;
-  do {
-    old_size = unescaped_str.size();
-    unescaped_str = net::UnescapeURLComponent(
-        unescaped_str,
-        net::UnescapeRule::SPOOFING_AND_CONTROL_CHARS |
-            net::UnescapeRule::SPACES | net::UnescapeRule::PATH_SEPARATORS |
-            net::UnescapeRule::URL_SPECIAL_CHARS_EXCEPT_PATH_SEPARATORS);
-  } while (old_size != unescaped_str.size() &&
-           ++loop_var <= kMaxLoopIterations);
-
-  return unescaped_str;
-}
-
-std::string Escape(const std::string& url) {
-  std::string escaped_str;
-  // The escaped string is larger so allocate double the length to reduce the
-  // chance of the string being grown.
-  escaped_str.reserve(url.length() * 2);
-  const char* kHexString = "0123456789ABCDEF";
-  for (size_t i = 0; i < url.length(); i++) {
-    unsigned char c = static_cast<unsigned char>(url[i]);
-    if (c <= ' ' || c > '~' || c == '#' || c == '%') {
-      escaped_str += '%';
-      escaped_str += kHexString[c >> 4];
-      escaped_str += kHexString[c & 0xf];
-    } else {
-      escaped_str += c;
-    }
-  }
-
-  return escaped_str;
-}
-
-}  // namespace
-
 std::ostream& operator<<(std::ostream& os, const UpdateListIdentifier& id) {
   os << "{hash: " << id.hash() << "; platform_type: " << id.platform_type
      << "; threat_entry_type: " << id.threat_entry_type
@@ -183,241 +138,4 @@ void V4ProtocolManagerUtil::UpdateHeaders(net::HttpRequestHeaders* headers) {
   headers->SetHeaderIfMissing("X-HTTP-Method-Override", "POST");
 }
 
-// static
-void V4ProtocolManagerUtil::UrlToFullHashes(
-    const GURL& url,
-    base::hash_set<FullHash>* full_hashes) {
-  std::string canon_host, canon_path, canon_query;
-  CanonicalizeUrl(url, &canon_host, &canon_path, &canon_query);
-
-  std::vector<std::string> hosts;
-  if (url.HostIsIPAddress()) {
-    hosts.push_back(url.host());
-  } else {
-    GenerateHostVariantsToCheck(canon_host, &hosts);
-  }
-
-  std::vector<std::string> paths;
-  GeneratePathVariantsToCheck(canon_path, canon_query, &paths);
-  for (const std::string& host : hosts) {
-    for (const std::string& path : paths) {
-      full_hashes->insert(crypto::SHA256HashString(host + path));
-    }
-  }
-}
-
-// static
-void V4ProtocolManagerUtil::GenerateHostsToCheck(
-    const GURL& url,
-    std::vector<std::string>* hosts) {
-  std::string canon_host;
-  CanonicalizeUrl(url, &canon_host, NULL, NULL);
-  GenerateHostVariantsToCheck(canon_host, hosts);
-}
-
-// static
-void V4ProtocolManagerUtil::GeneratePathsToCheck(
-    const GURL& url,
-    std::vector<std::string>* paths) {
-  std::string canon_path;
-  std::string canon_query;
-  CanonicalizeUrl(url, NULL, &canon_path, &canon_query);
-  GeneratePathVariantsToCheck(canon_path, canon_query, paths);
-}
-
-// static
-void V4ProtocolManagerUtil::GeneratePatternsToCheck(
-    const GURL& url,
-    std::vector<std::string>* urls) {
-  std::string canon_host;
-  std::string canon_path;
-  std::string canon_query;
-  CanonicalizeUrl(url, &canon_host, &canon_path, &canon_query);
-
-  std::vector<std::string> hosts, paths;
-  GenerateHostVariantsToCheck(canon_host, &hosts);
-  GeneratePathVariantsToCheck(canon_path, canon_query, &paths);
-  for (size_t h = 0; h < hosts.size(); ++h) {
-    for (size_t p = 0; p < paths.size(); ++p) {
-      urls->push_back(hosts[h] + paths[p]);
-    }
-  }
-}
-
-// static
-void V4ProtocolManagerUtil::CanonicalizeUrl(const GURL& url,
-                                            std::string* canonicalized_hostname,
-                                            std::string* canonicalized_path,
-                                            std::string* canonicalized_query) {
-  DCHECK(url.is_valid());
-
-  // We only canonicalize "normal" URLs.
-  if (!url.IsStandard())
-    return;
-
-  // Following canonicalization steps are excluded since url parsing takes care
-  // of those :-
-  // 1. Remove any tab (0x09), CR (0x0d), and LF (0x0a) chars from url.
-  //    (Exclude escaped version of these chars).
-  // 2. Normalize hostname to 4 dot-seperated decimal values.
-  // 3. Lowercase hostname.
-  // 4. Resolve path sequences "/../" and "/./".
-
-  // That leaves us with the following :-
-  // 1. Remove fragment in URL.
-  GURL url_without_fragment;
-  GURL::Replacements f_replacements;
-  f_replacements.ClearRef();
-  f_replacements.ClearUsername();
-  f_replacements.ClearPassword();
-  url_without_fragment = url.ReplaceComponents(f_replacements);
-
-  // 2. Do URL unescaping until no more hex encoded characters exist.
-  std::string url_unescaped_str(Unescape(url_without_fragment.spec()));
-  url::Parsed parsed;
-  url::ParseStandardURL(url_unescaped_str.data(), url_unescaped_str.length(),
-                        &parsed);
-
-  // 3. In hostname, remove all leading and trailing dots.
-  base::StringPiece host;
-  if (parsed.host.len > 0)
-    host.set(url_unescaped_str.data() + parsed.host.begin, parsed.host.len);
-
-  base::StringPiece host_without_end_dots =
-      base::TrimString(host, ".", base::TrimPositions::TRIM_ALL);
-
-  // 4. In hostname, replace consecutive dots with a single dot.
-  std::string host_without_consecutive_dots(
-      RemoveConsecutiveChars(host_without_end_dots, '.'));
-
-  // 5. In path, replace runs of consecutive slashes with a single slash.
-  base::StringPiece path;
-  if (parsed.path.len > 0)
-    path.set(url_unescaped_str.data() + parsed.path.begin, parsed.path.len);
-  std::string path_without_consecutive_slash(RemoveConsecutiveChars(path, '/'));
-
-  url::Replacements<char> hp_replacements;
-  hp_replacements.SetHost(
-      host_without_consecutive_dots.data(),
-      url::Component(0, host_without_consecutive_dots.length()));
-  hp_replacements.SetPath(
-      path_without_consecutive_slash.data(),
-      url::Component(0, path_without_consecutive_slash.length()));
-
-  std::string url_unescaped_with_can_hostpath;
-  url::StdStringCanonOutput output(&url_unescaped_with_can_hostpath);
-  url::Parsed temp_parsed;
-  url::ReplaceComponents(url_unescaped_str.data(), url_unescaped_str.length(),
-                         parsed, hp_replacements, NULL, &output, &temp_parsed);
-  output.Complete();
-
-  // 6. Step needed to revert escaping done in url::ReplaceComponents.
-  url_unescaped_with_can_hostpath = Unescape(url_unescaped_with_can_hostpath);
-
-  // 7. After performing all above steps, percent-escape all chars in url which
-  // are <= ASCII 32, >= 127, #, %. Escapes must be uppercase hex characters.
-  std::string escaped_canon_url_str(Escape(url_unescaped_with_can_hostpath));
-  url::Parsed final_parsed;
-  url::ParseStandardURL(escaped_canon_url_str.data(),
-                        escaped_canon_url_str.length(), &final_parsed);
-
-  if (canonicalized_hostname && final_parsed.host.len > 0) {
-    *canonicalized_hostname = escaped_canon_url_str.substr(
-        final_parsed.host.begin, final_parsed.host.len);
-  }
-  if (canonicalized_path && final_parsed.path.len > 0) {
-    *canonicalized_path = escaped_canon_url_str.substr(final_parsed.path.begin,
-                                                       final_parsed.path.len);
-  }
-  if (canonicalized_query && final_parsed.query.len > 0) {
-    *canonicalized_query = escaped_canon_url_str.substr(
-        final_parsed.query.begin, final_parsed.query.len);
-  }
-}
-
-// static
-std::string V4ProtocolManagerUtil::RemoveConsecutiveChars(base::StringPiece str,
-                                                          const char c) {
-  std::string output;
-  // Output is at most the length of the original string.
-  output.reserve(str.size());
-
-  size_t i = 0;
-  while (i < str.size()) {
-    output.append(1, str[i++]);
-    if (str[i - 1] == c) {
-      while (i < str.size() && str[i] == c) {
-        i++;
-      }
-    }
-  }
-
-  return output;
-}
-
-// static
-void V4ProtocolManagerUtil::GenerateHostVariantsToCheck(
-    const std::string& host,
-    std::vector<std::string>* hosts) {
-  hosts->clear();
-
-  if (host.empty())
-    return;
-
-  // Per the Safe Browsing Protocol v2 spec, we try the host, and also up to 4
-  // hostnames formed by starting with the last 5 components and successively
-  // removing the leading component.  The last component isn't examined alone,
-  // since it's the TLD or a subcomponent thereof.
-  //
-  // Note that we don't need to be clever about stopping at the "real" eTLD --
-  // the data on the server side has been filtered to ensure it will not
-  // blacklist a whole TLD, and it's not significantly slower on our side to
-  // just check too much.
-  //
-  // Also note that because we have a simple blacklist, not some sort of complex
-  // whitelist-in-blacklist or vice versa, it doesn't matter what order we check
-  // these in.
-  const size_t kMaxHostsToCheck = 4;
-  bool skipped_last_component = false;
-  for (std::string::const_reverse_iterator i(host.rbegin());
-       i != host.rend() && hosts->size() < kMaxHostsToCheck; ++i) {
-    if (*i == '.') {
-      if (skipped_last_component)
-        hosts->push_back(std::string(i.base(), host.end()));
-      else
-        skipped_last_component = true;
-    }
-  }
-  hosts->push_back(host);
-}
-
-// static
-void V4ProtocolManagerUtil::GeneratePathVariantsToCheck(
-    const std::string& path,
-    const std::string& query,
-    std::vector<std::string>* paths) {
-  paths->clear();
-
-  if (path.empty())
-    return;
-
-  // Per the Safe Browsing Protocol v2 spec, we try the exact path with/without
-  // the query parameters, and also up to 4 paths formed by starting at the root
-  // and adding more path components.
-  //
-  // As with the hosts above, it doesn't matter what order we check these in.
-  const size_t kMaxPathsToCheck = 4;
-  for (std::string::const_iterator i(path.begin());
-       i != path.end() && paths->size() < kMaxPathsToCheck; ++i) {
-    if (*i == '/')
-      paths->push_back(std::string(path.begin(), i + 1));
-  }
-
-  if (!paths->empty() && paths->back() != path)
-    paths->push_back(path);
-
-  if (!query.empty())
-    paths->push_back(path + "?" + query);
-}
-
 }  // namespace safe_browsing
diff --git a/components/safe_browsing_db/v4_protocol_manager_util.h b/components/safe_browsing_db/v4_protocol_manager_util.h
index fc6472b..6b81e8b 100644
--- a/components/safe_browsing_db/v4_protocol_manager_util.h
+++ b/components/safe_browsing_db/v4_protocol_manager_util.h
@@ -13,7 +13,6 @@
 
 #include "base/gtest_prod_util.h"
 #include "base/hash.h"
-#include "base/strings/string_piece.h"
 #include "components/safe_browsing_db/safebrowsing.pb.h"
 #include "net/url_request/url_request_status.h"
 #include "url/gurl.h"
@@ -24,12 +23,6 @@ class HttpRequestHeaders;
 
 namespace safe_browsing {
 
-// A hash prefix sent by the SafeBrowsing PVer4 service.
-typedef std::string HashPrefix;
-
-// A full SHA256 hash.
-typedef HashPrefix FullHash;
-
 typedef FetchThreatListUpdatesRequest::ListUpdateRequest ListUpdateRequest;
 typedef FetchThreatListUpdatesResponse::ListUpdateResponse ListUpdateResponse;
 
@@ -77,26 +70,6 @@ struct UpdateListIdentifier {
 
 std::ostream& operator<<(std::ostream& os, const UpdateListIdentifier& id);
 
-#if defined(OS_WIN)
-#define PLATFORM_TYPE WINDOWS_PLATFORM
-#elif defined(OS_LINUX)
-#define PLATFORM_TYPE LINUX_PLATFORM
-#elif defined(OS_MACOSX)
-#define PLATFORM_TYPE OSX_PLATFORM
-#else
-// This should ideally never compile but it is getting compiled on Android.
-// See: https://bugs.chromium.org/p/chromium/issues/detail?id=621647
-// TODO(vakh): Once that bug is fixed, this should be removed. If we leave
-// the platform_type empty, the server won't recognize the request and
-// return an error response which will pollute our UMA metrics.
-#define PLATFORM_TYPE LINUX_PLATFORM
-#endif
-
-const UpdateListIdentifier kUrlMalwareId(PLATFORM_TYPE, URL, MALWARE_THREAT);
-const UpdateListIdentifier kUrlSocengId(PLATFORM_TYPE,
-                                        URL,
-                                        SOCIAL_ENGINEERING_PUBLIC);
-
 // The set of interesting lists and ASCII filenames for their hash prefix
 // stores. The stores are created inside the user-data directory.
 // For instance, the UpdateListIdentifier could be for URL expressions for UwS
@@ -144,29 +117,14 @@ enum V4OperationResult {
 // A class that provides static methods related to the Pver4 protocol.
 class V4ProtocolManagerUtil {
  public:
-  // Canonicalizes url as per Google Safe Browsing Specification.
-  // See: https://developers.google.com/safe-browsing/v4/urls-hashing
-  static void CanonicalizeUrl(const GURL& url,
-                              std::string* canonicalized_hostname,
-                              std::string* canonicalized_path,
-                              std::string* canonicalized_query);
-
-  // This method returns the host suffix combinations from the hostname in the
-  // URL, as described here:
-  // https://developers.google.com/safe-browsing/v4/urls-hashing
-  static void GenerateHostVariantsToCheck(const std::string& host,
-                                          std::vector<std::string>* hosts);
-
-  // This method returns the path prefix combinations from the path in the
-  // URL, as described here:
-  // https://developers.google.com/safe-browsing/v4/urls-hashing
-  static void GeneratePathVariantsToCheck(const std::string& path,
-                                          const std::string& query,
-                                          std::vector<std::string>* paths);
-
-  // Given a URL, returns all the patterns we need to check.
-  static void GeneratePatternsToCheck(const GURL& url,
-                                      std::vector<std::string>* urls);
+  // Record HTTP response code when there's no error in fetching an HTTP
+  // request, and the error code, when there is.
+  // |metric_name| is the name of the UMA metric to record the response code or
+  // error code against, |status| represents the status of the HTTP request, and
+  // |response code| represents the HTTP response code received from the server.
+  static void RecordHttpResponseOrErrorCode(const char* metric_name,
+                                            const net::URLRequestStatus& status,
+                                            int response_code);
 
   // Generates a Pver4 request URL and sets the appropriate header values.
   // |request_base64| is the serialized request protocol buffer encoded in
@@ -187,26 +145,12 @@ class V4ProtocolManagerUtil {
   static base::TimeDelta GetNextBackOffInterval(size_t* error_count,
                                                 size_t* multiplier);
 
-  // Record HTTP response code when there's no error in fetching an HTTP
-  // request, and the error code, when there is.
-  // |metric_name| is the name of the UMA metric to record the response code or
-  // error code against, |status| represents the status of the HTTP request, and
-  // |response code| represents the HTTP response code received from the server.
-  static void RecordHttpResponseOrErrorCode(const char* metric_name,
-                                            const net::URLRequestStatus& status,
-                                            int response_code);
-
-  // Generate the set of FullHashes to check for |url|.
-  static void UrlToFullHashes(const GURL& url,
-                              base::hash_set<FullHash>* full_hashes);
-
  private:
   V4ProtocolManagerUtil(){};
-  FRIEND_TEST_ALL_PREFIXES(V4ProtocolManagerUtilTest, TestBackOffLogic);
-  FRIEND_TEST_ALL_PREFIXES(V4ProtocolManagerUtilTest,
+  FRIEND_TEST_ALL_PREFIXES(SafeBrowsingV4ProtocolManagerUtilTest,
+                           TestBackOffLogic);
+  FRIEND_TEST_ALL_PREFIXES(SafeBrowsingV4ProtocolManagerUtilTest,
                            TestGetRequestUrlAndUpdateHeaders);
-  FRIEND_TEST_ALL_PREFIXES(V4ProtocolManagerUtilTest, UrlParsing);
-  FRIEND_TEST_ALL_PREFIXES(V4ProtocolManagerUtilTest, CanonicalizeUrl);
 
   // Composes a URL using |prefix|, |method| (e.g.: encodedFullHashes).
   // |request_base64|, |client_id|, |version| and |key_param|. |prefix|
@@ -219,18 +163,6 @@ class V4ProtocolManagerUtil {
   // Sets the HTTP headers expected by a standard PVer4 request.
   static void UpdateHeaders(net::HttpRequestHeaders* headers);
 
-  // Given a URL, returns all the hosts we need to check.  They are returned
-  // in order of size (i.e. b.c is first, then a.b.c).
-  static void GenerateHostsToCheck(const GURL& url,
-                                   std::vector<std::string>* hosts);
-
-  // Given a URL, returns all the paths we need to check.
-  static void GeneratePathsToCheck(const GURL& url,
-                                   std::vector<std::string>* paths);
-
-  static std::string RemoveConsecutiveChars(base::StringPiece str,
-                                            const char c);
-
   DISALLOW_COPY_AND_ASSIGN(V4ProtocolManagerUtil);
 };
 
diff --git a/components/safe_browsing_db/v4_protocol_manager_util_unittest.cc b/components/safe_browsing_db/v4_protocol_manager_util_unittest.cc
index 20e8085..f118c7f 100644
--- a/components/safe_browsing_db/v4_protocol_manager_util_unittest.cc
+++ b/components/safe_browsing_db/v4_protocol_manager_util_unittest.cc
@@ -7,7 +7,6 @@
 #include <vector>
 
 #include "base/base64.h"
-#include "base/strings/stringprintf.h"
 #include "base/time/time.h"
 #include "net/base/escape.h"
 #include "net/http/http_request_headers.h"
@@ -22,16 +21,11 @@ const char kClient[] = "unittest";
 const char kAppVer[] = "1.0";
 const char kKeyParam[] = "test_key_param";
 
-bool VectorContains(const std::vector<std::string>& data,
-                    const std::string& str) {
-  return std::find(data.begin(), data.end(), str) != data.end();
-}
-
 }  // namespace
 
 namespace safe_browsing {
 
-class V4ProtocolManagerUtilTest : public testing::Test {
+class SafeBrowsingV4ProtocolManagerUtilTest : public testing::Test {
  protected:
   void PopulateV4ProtocolConfig(V4ProtocolConfig* config) {
     config->client_name = kClient;
@@ -40,7 +34,7 @@ class V4ProtocolManagerUtilTest : public testing::Test {
   }
 };
 
-TEST_F(V4ProtocolManagerUtilTest, TestBackOffLogic) {
+TEST_F(SafeBrowsingV4ProtocolManagerUtilTest, TestBackOffLogic) {
   size_t error_count = 0, back_off_multiplier = 1;
 
   // 1 error.
@@ -114,7 +108,8 @@ TEST_F(V4ProtocolManagerUtilTest, TestBackOffLogic) {
   EXPECT_EQ(TimeDelta::FromHours(24), next);
 }
 
-TEST_F(V4ProtocolManagerUtilTest, TestGetRequestUrlAndUpdateHeaders) {
+TEST_F(SafeBrowsingV4ProtocolManagerUtilTest,
+       TestGetRequestUrlAndUpdateHeaders) {
   V4ProtocolConfig config;
   PopulateV4ProtocolConfig(&config);
 
@@ -131,122 +126,4 @@ TEST_F(V4ProtocolManagerUtilTest, TestGetRequestUrlAndUpdateHeaders) {
   EXPECT_EQ("POST", header_value);
 }
 
-// Tests that we generate the required host/path combinations for testing
-// according to the Safe Browsing spec.
-// See: https://developers.google.com/safe-browsing/v4/urls-hashing
-TEST_F(V4ProtocolManagerUtilTest, UrlParsing) {
-  std::vector<std::string> hosts, paths;
-
-  GURL url("http://a.b.c/1/2.html?param=1");
-  V4ProtocolManagerUtil::GenerateHostsToCheck(url, &hosts);
-  V4ProtocolManagerUtil::GeneratePathsToCheck(url, &paths);
-  EXPECT_EQ(hosts.size(), static_cast<size_t>(2));
-  EXPECT_EQ(paths.size(), static_cast<size_t>(4));
-  EXPECT_EQ(hosts[0], "b.c");
-  EXPECT_EQ(hosts[1], "a.b.c");
-
-  EXPECT_TRUE(VectorContains(paths, "/1/2.html?param=1"));
-  EXPECT_TRUE(VectorContains(paths, "/1/2.html"));
-  EXPECT_TRUE(VectorContains(paths, "/1/"));
-  EXPECT_TRUE(VectorContains(paths, "/"));
-
-  url = GURL("http://a.b.c.d.e.f.g/1.html");
-  V4ProtocolManagerUtil::GenerateHostsToCheck(url, &hosts);
-  V4ProtocolManagerUtil::GeneratePathsToCheck(url, &paths);
-  EXPECT_EQ(hosts.size(), static_cast<size_t>(5));
-  EXPECT_EQ(paths.size(), static_cast<size_t>(2));
-  EXPECT_EQ(hosts[0], "f.g");
-  EXPECT_EQ(hosts[1], "e.f.g");
-  EXPECT_EQ(hosts[2], "d.e.f.g");
-  EXPECT_EQ(hosts[3], "c.d.e.f.g");
-  EXPECT_EQ(hosts[4], "a.b.c.d.e.f.g");
-  EXPECT_TRUE(VectorContains(paths, "/1.html"));
-  EXPECT_TRUE(VectorContains(paths, "/"));
-
-  url = GURL("http://a.b/saw-cgi/eBayISAPI.dll/");
-  V4ProtocolManagerUtil::GeneratePathsToCheck(url, &paths);
-  EXPECT_EQ(paths.size(), static_cast<size_t>(3));
-  EXPECT_TRUE(VectorContains(paths, "/saw-cgi/eBayISAPI.dll/"));
-  EXPECT_TRUE(VectorContains(paths, "/saw-cgi/"));
-  EXPECT_TRUE(VectorContains(paths, "/"));
-}
-
-// Tests the url canonicalization according to the Safe Browsing spec.
-// See: https://developers.google.com/safe-browsing/v4/urls-hashing
-TEST_F(V4ProtocolManagerUtilTest, CanonicalizeUrl) {
-  struct {
-    const char* input_url;
-    const char* expected_canonicalized_hostname;
-    const char* expected_canonicalized_path;
-    const char* expected_canonicalized_query;
-  } tests[] = {
-      {"http://host/%25%32%35", "host", "/%25", ""},
-      {"http://host/%25%32%35%25%32%35", "host", "/%25%25", ""},
-      {"http://host/%2525252525252525", "host", "/%25", ""},
-      {"http://host/asdf%25%32%35asd", "host", "/asdf%25asd", ""},
-      {"http://host/%%%25%32%35asd%%", "host", "/%25%25%25asd%25%25", ""},
-      {"http://host/%%%25%32%35asd%%", "host", "/%25%25%25asd%25%25", ""},
-      {"http://www.google.com/", "www.google.com", "/", ""},
-      {"http://%31%36%38%2e%31%38%38%2e%39%39%2e%32%36/%2E%73%65%63%75%72%65/"
-       "%77"
-       "%77%77%2E%65%62%61%79%2E%63%6F%6D/",
-       "168.188.99.26", "/.secure/www.ebay.com/", ""},
-      {"http://195.127.0.11/uploads/%20%20%20%20/.verify/"
-       ".eBaysecure=updateuserd"
-       "ataxplimnbqmn-xplmvalidateinfoswqpcmlx=hgplmcx/",
-       "195.127.0.11",
-       "/uploads/%20%20%20%20/.verify/"
-       ".eBaysecure=updateuserdataxplimnbqmn-xplmv"
-       "alidateinfoswqpcmlx=hgplmcx/",
-       ""},
-      {"http://host.com/%257Ea%2521b%2540c%2523d%2524e%25f%255E00%252611%252A"
-       "22%252833%252944_55%252B",
-       "host.com", "/~a!b@c%23d$e%25f^00&11*22(33)44_55+", ""},
-      {"http://3279880203/blah", "195.127.0.11", "/blah", ""},
-      {"http://www.google.com/blah/..", "www.google.com", "/", ""},
-      {"http://www.google.com/blah#fraq", "www.google.com", "/blah", ""},
-      {"http://www.GOOgle.com/", "www.google.com", "/", ""},
-      {"http://www.google.com.../", "www.google.com", "/", ""},
-      {"http://www.google.com/q?", "www.google.com", "/q", ""},
-      {"http://www.google.com/q?r?", "www.google.com", "/q", "r?"},
-      {"http://www.google.com/q?r?s", "www.google.com", "/q", "r?s"},
-      {"http://evil.com/foo#bar#baz", "evil.com", "/foo", ""},
-      {"http://evil.com/foo;", "evil.com", "/foo;", ""},
-      {"http://evil.com/foo?bar;", "evil.com", "/foo", "bar;"},
-      {"http://notrailingslash.com", "notrailingslash.com", "/", ""},
-      {"http://www.gotaport.com:1234/", "www.gotaport.com", "/", ""},
-      {"  http://www.google.com/  ", "www.google.com", "/", ""},
-      {"http:// leadingspace.com/", "%20leadingspace.com", "/", ""},
-      {"http://%20leadingspace.com/", "%20leadingspace.com", "/", ""},
-      {"https://www.securesite.com/", "www.securesite.com", "/", ""},
-      {"http://host.com/ab%23cd", "host.com", "/ab%23cd", ""},
-      {"http://host%3e.com//twoslashes?more//slashes", "host>.com",
-       "/twoslashes", "more//slashes"},
-      {"http://host.com/abc?val=xyz#anything", "host.com", "/abc", "val=xyz"},
-      {"http://abc:def@host.com/xyz", "host.com", "/xyz", ""},
-      {"http://host%3e.com/abc/%2e%2e%2fdef", "host>.com", "/def", ""},
-      {"http://.......host...com.....//abc/////def%2F%2F%2Fxyz", "host.com",
-       "/abc/def/xyz", ""},
-      {"ftp://host.com/foo?bar", "host.com", "/foo", "bar"},
-      {"data:text/html;charset=utf-8,%0D%0A", "", "", ""},
-      {"javascript:alert()", "", "", ""},
-      {"mailto:abc@example.com", "", "", ""},
-  };
-  for (size_t i = 0; i < arraysize(tests); ++i) {
-    SCOPED_TRACE(base::StringPrintf("Test: %s", tests[i].input_url));
-    GURL url(tests[i].input_url);
-
-    std::string canonicalized_hostname;
-    std::string canonicalized_path;
-    std::string canonicalized_query;
-    V4ProtocolManagerUtil::CanonicalizeUrl(url, &canonicalized_hostname,
-                                           &canonicalized_path,
-                                           &canonicalized_query);
-
-    EXPECT_EQ(tests[i].expected_canonicalized_hostname, canonicalized_hostname);
-    EXPECT_EQ(tests[i].expected_canonicalized_path, canonicalized_path);
-    EXPECT_EQ(tests[i].expected_canonicalized_query, canonicalized_query);
-  }
-}
-
 }  // namespace safe_browsing
diff --git a/components/safe_browsing_db/v4_store.h b/components/safe_browsing_db/v4_store.h
index 770088b..94621e5 100644
--- a/components/safe_browsing_db/v4_store.h
+++ b/components/safe_browsing_db/v4_store.h
@@ -22,6 +22,9 @@ typedef base::Callback<void(std::unique_ptr<V4Store>)>
 // hash).
 typedef size_t PrefixSize;
 
+// A hash prefix sent by the SafeBrowsing PVer4 service.
+typedef std::string HashPrefix;
+
 // The sorted list of hash prefixes.
 typedef std::string HashPrefixes;
 
@@ -35,6 +38,9 @@ typedef base::hash_map<PrefixSize, HashPrefixes> HashPrefixMap;
 // 3 hash prefixes of length 4, and 1 hash prefix of length 5.
 typedef base::hash_map<PrefixSize, HashPrefixes::const_iterator> IteratorMap;
 
+// A full SHA256 hash.
+typedef HashPrefix FullHash;
+
 // Enumerate different failure events while parsing the file read from disk for
 // histogramming purposes.  DO NOT CHANGE THE ORDERING OF THESE VALUES.
 enum StoreReadResult {
diff --git a/components/search/search.cc b/components/search/search.cc
index db31c28..cbc9552 100644
--- a/components/search/search.cc
+++ b/components/search/search.cc
@@ -59,6 +59,8 @@ const char kDisablingSuffix[] = "DISABLED";
 const char kEnableQueryExtractionFlagName[] = "query_extraction";
 #endif
 
+const char kAllowPrefetchNonDefaultMatch[] = "allow_prefetch_non_default_match";
+
 #if defined(OS_ANDROID)
 const char kPrefetchSearchResultsFlagName[] = "prefetch_results";
 
@@ -226,6 +228,16 @@ bool ShouldReuseInstantSearchBasePage() {
 #endif
 }
 
+bool ShouldAllowPrefetchNonDefaultMatch() {
+  if (!ShouldPrefetchSearchResults())
+    return false;
+
+  FieldTrialFlags flags;
+  return GetFieldTrialInfo(&flags) &&
+         GetBoolValueForFlagWithDefault(kAllowPrefetchNonDefaultMatch, false,
+                                        flags);
+}
+
 // |url| should either have a secure scheme or have a non-HTTPS base URL that
 // the user specified using --google-base-url. (This allows testers to use
 // --google-base-url to point at non-HTTPS servers, which eases testing.)
diff --git a/components/search/search.h b/components/search/search.h
index ee7fe8f..d97b240 100644
--- a/components/search/search.h
+++ b/components/search/search.h
@@ -88,6 +88,11 @@ bool ShouldPrefetchSearchResults();
 // trials to reuse the prerendered page to commit any search query.
 bool ShouldReuseInstantSearchBasePage();
 
+// Returns true if 'allow_prefetch_non_default_match' flag is enabled in field
+// trials to allow prefetching the suggestion marked to be prefetched by the
+// suggest server even if it is not the default match.
+bool ShouldAllowPrefetchNonDefaultMatch();
+
 // |url| should either have a secure scheme or have a non-HTTPS base URL that
 // the user specified using --google-base-url. (This allows testers to use
 // --google-base-url to point at non-HTTPS servers, which eases testing.)
diff --git a/components/search/search_unittest.cc b/components/search/search_unittest.cc
index f11151c..622ecd5 100644
--- a/components/search/search_unittest.cc
+++ b/components/search/search_unittest.cc
@@ -151,6 +151,20 @@ TEST_F(SearchTest, ShouldReuseInstantSearchBasePage_Default) {
   EXPECT_TRUE(ShouldReuseInstantSearchBasePage());
 }
 
+TEST_F(SearchTest, ShouldAllowPrefetchNonDefaultMatch_DisabledViaFieldTrial) {
+  ASSERT_TRUE(base::FieldTrialList::CreateFieldTrial(
+      "EmbeddedSearch", "Group1 espv:89 allow_prefetch_non_default_match:0"));
+  EXPECT_FALSE(ShouldAllowPrefetchNonDefaultMatch());
+  EXPECT_EQ(89ul, EmbeddedSearchPageVersion());
+}
+
+TEST_F(SearchTest, ShouldAllowPrefetchNonDefaultMatch_EnabledViaFieldTrial) {
+  ASSERT_TRUE(base::FieldTrialList::CreateFieldTrial(
+      "EmbeddedSearch", "Group1 espv:80 allow_prefetch_non_default_match:1"));
+  EXPECT_TRUE(ShouldAllowPrefetchNonDefaultMatch());
+  EXPECT_EQ(80ul, EmbeddedSearchPageVersion());
+}
+
 TEST_F(SearchTest, ForceInstantResultsParam) {
   ASSERT_TRUE(base::FieldTrialList::CreateFieldTrial("EmbeddedSearch",
                                                      "Group1 espv:2"));
diff --git a/components/startup_metric_utils/browser/startup_metric_utils.cc b/components/startup_metric_utils/browser/startup_metric_utils.cc
index f0d4154..b285272 100644
--- a/components/startup_metric_utils/browser/startup_metric_utils.cc
+++ b/components/startup_metric_utils/browser/startup_metric_utils.cc
@@ -316,6 +316,9 @@ base::TimeTicks StartupTimeToTimeTicks(const base::Time& time) {
   // bumping the priority reduces the likelihood of a context switch interfering
   // with this computation.
 
+// Enabling this logic on OS X causes a significant performance regression.
+// https://crbug.com/601270
+#if !defined(OS_MACOSX)
   static bool statics_initialized = false;
 
   base::ThreadPriority previous_priority = base::ThreadPriority::NORMAL;
@@ -324,14 +327,17 @@ base::TimeTicks StartupTimeToTimeTicks(const base::Time& time) {
     base::PlatformThread::SetCurrentThreadPriority(
         base::ThreadPriority::DISPLAY);
   }
+#endif
 
   static const base::Time time_base = base::Time::Now();
   static const base::TimeTicks trace_ticks_base = base::TimeTicks::Now();
 
+#if !defined(OS_MACOSX)
   if (!statics_initialized) {
     base::PlatformThread::SetCurrentThreadPriority(previous_priority);
   }
   statics_initialized = true;
+#endif
 
   // Then use the TimeDelta common ground between the two units to make the
   // conversion.
diff --git a/components/subresource_filter.gypi b/components/subresource_filter.gypi
index eecfeb4..ee3894c 100644
--- a/components/subresource_filter.gypi
+++ b/components/subresource_filter.gypi
@@ -12,7 +12,6 @@
         '../base/base.gyp:base',
         '../components/components.gyp:variations',
         '../components/prefs/prefs.gyp:prefs',
-        '../third_party/protobuf/protobuf.gyp:protobuf_lite',
         'subresource_filter_core_common',
       ],
       'include_dirs': [
@@ -56,7 +55,6 @@
         '../base/base.gyp:base',
         '../net/net.gyp:net',
         '../third_party/flatbuffers/flatbuffers.gyp:flatbuffers',
-        '../third_party/protobuf/protobuf.gyp:protobuf_lite',
         '../url/url.gyp:url_lib',
         'subresource_filter_core_common_ruleset_flatbuffer',
         'subresource_filter_core_common_ruleset_proto',
@@ -66,13 +64,9 @@
       ],
       'sources': [
         # Note: sources list duplicated in GN build.
-        'subresource_filter/core/common/activation_scope.cc',
-        'subresource_filter/core/common/activation_scope.h',
         'subresource_filter/core/common/activation_state.cc',
         'subresource_filter/core/common/activation_state.h',
         'subresource_filter/core/common/closed_hash_map.h',
-        'subresource_filter/core/common/copying_file_stream.cc',
-        'subresource_filter/core/common/copying_file_stream.h',
         'subresource_filter/core/common/fuzzy_pattern_matching.cc',
         'subresource_filter/core/common/fuzzy_pattern_matching.h',
         'subresource_filter/core/common/indexed_ruleset.cc',
@@ -83,8 +77,6 @@
         'subresource_filter/core/common/ngram_extractor.h',
         'subresource_filter/core/common/string_splitter.h',
         'subresource_filter/core/common/uint64_hasher.h',
-        'subresource_filter/core/common/unindexed_ruleset.cc',
-        'subresource_filter/core/common/unindexed_ruleset.h',
         'subresource_filter/core/common/url_pattern.cc',
         'subresource_filter/core/common/url_pattern.h',
         'subresource_filter/core/common/url_pattern_matching.h',
@@ -131,7 +123,6 @@
       'dependencies': [
         '../base/base.gyp:base',
         '../testing/gtest.gyp:gtest',
-        '../third_party/protobuf/protobuf.gyp:protobuf_lite',
         'subresource_filter_core_common',
       ],
       'include_dirs': [
diff --git a/components/subresource_filter/DEPS b/components/subresource_filter/DEPS
index b69525f..1a60453 100644
--- a/components/subresource_filter/DEPS
+++ b/components/subresource_filter/DEPS
@@ -7,5 +7,4 @@ include_rules = [
   "-components/subresource_filter/content",
   "+net/base",
   "+third_party/flatbuffers",
-  "+third_party/protobuf",
 ]
diff --git a/components/subresource_filter/content/browser/content_subresource_filter_driver_factory.cc b/components/subresource_filter/content/browser/content_subresource_filter_driver_factory.cc
index 1d98723..9bee08f 100644
--- a/components/subresource_filter/content/browser/content_subresource_filter_driver_factory.cc
+++ b/components/subresource_filter/content/browser/content_subresource_filter_driver_factory.cc
@@ -82,8 +82,7 @@ void ContentSubresourceFilterDriverFactory::AddOriginOfURLToActivationSet(
 void ContentSubresourceFilterDriverFactory::ActivateForFrameHostIfNeeded(
     content::RenderFrameHost* render_frame_host,
     const GURL& url) {
-  if (GetCurrentActivationScope() != ActivationScope::ACTIVATION_LIST ||
-      !ShouldActivateForURL(url))
+  if (!ShouldActivateForURL(url))
     return;
   ContentSubresourceFilterDriver* driver =
       DriverFromFrameHost(render_frame_host);
@@ -122,10 +121,9 @@ void ContentSubresourceFilterDriverFactory::DidStartProvisionalLoadForFrame(
     const GURL& validated_url,
     bool is_error_page,
     bool is_iframe_srcdoc) {
-  if (GetCurrentActivationScope() == ActivationScope::ALL_SITES) {
-    DriverFromFrameHost(render_frame_host)
-        ->ActivateForProvisionalLoad(GetMaximumActivationState());
-  }
+  // TODO(melandory): Replace placeholder with actual activation logic.
+  DriverFromFrameHost(render_frame_host)
+      ->ActivateForProvisionalLoad(GetMaximumActivationState());
 }
 
 }  // namespace subresource_filter
diff --git a/components/subresource_filter/content/browser/content_subresource_filter_driver_factory_unittest.cc b/components/subresource_filter/content/browser/content_subresource_filter_driver_factory_unittest.cc
index f19421a..6edca0e 100644
--- a/components/subresource_filter/content/browser/content_subresource_filter_driver_factory_unittest.cc
+++ b/components/subresource_filter/content/browser/content_subresource_filter_driver_factory_unittest.cc
@@ -4,12 +4,9 @@
 
 #include "base/macros.h"
 #include "base/memory/ptr_util.h"
-#include "base/metrics/field_trial.h"
 #include "components/safe_browsing_db/util.h"
 #include "components/subresource_filter/content/browser/content_subresource_filter_driver.h"
 #include "components/subresource_filter/content/browser/content_subresource_filter_driver_factory.h"
-#include "components/subresource_filter/core/browser/subresource_filter_features.h"
-#include "components/subresource_filter/core/browser/subresource_filter_features_test_support.h"
 #include "content/public/browser/web_contents.h"
 #include "content/public/test/test_renderer_host.h"
 #include "testing/gmock/include/gmock/gmock.h"
@@ -108,44 +105,17 @@ TEST_F(ContentSubresourceFilterDriverFactoryTest, SocEngHitWithRedirects) {
   }
 }
 
-TEST_F(ContentSubresourceFilterDriverFactoryTest,
-       ActivateForFrameHostNotNeeded) {
-  base::FieldTrialList field_trial_list(nullptr);
-  testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-      base::FeatureList::OVERRIDE_DISABLE_FEATURE, kActivationStateEnabled,
-      kActivationScopeNoSites);
-  EXPECT_CALL(*driver(), ActivateForProvisionalLoad(::testing::_)).Times(0);
-  factory()->ActivateForFrameHostIfNeeded(main_rfh(), GURL("https://test.com"));
-  ::testing::Mock::VerifyAndClearExpectations(driver());
-
-  factory()->OnMainResourceMatchedSafeBrowsingBlacklist(
-      GURL("https://example.com/soceng?q=engsoc"), std::vector<GURL>(),
-      safe_browsing::ThreatPatternType::SOCIAL_ENGINEERING_ADS);
-
-  EXPECT_CALL(*driver(), ActivateForProvisionalLoad(::testing::_)).Times(0);
-  factory()->ActivateForFrameHostIfNeeded(main_rfh(),
-                                          GURL("https://example.com"));
-  ::testing::Mock::VerifyAndClearExpectations(driver());
-}
-
 TEST_F(ContentSubresourceFilterDriverFactoryTest, ActivateForFrameHostNeeded) {
-  base::FieldTrialList field_trial_list(nullptr);
-  testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled,
-      kActivationScopeActivationList);
-
+  EXPECT_CALL(*driver(), ActivateForProvisionalLoad(::testing::_)).Times(0);
   factory()->OnMainResourceMatchedSafeBrowsingBlacklist(
       GURL("https://example.com/soceng?q=engsoc"), std::vector<GURL>(),
       safe_browsing::ThreatPatternType::SOCIAL_ENGINEERING_ADS);
-
-  EXPECT_CALL(*driver(), ActivateForProvisionalLoad(::testing::_)).Times(0);
   factory()->ActivateForFrameHostIfNeeded(main_rfh(), GURL("https://test.com"));
-  ::testing::Mock::VerifyAndClearExpectations(driver());
 
+  ::testing::Mock::VerifyAndClearExpectations(driver());
   EXPECT_CALL(*driver(), ActivateForProvisionalLoad(::testing::_)).Times(1);
   factory()->ActivateForFrameHostIfNeeded(main_rfh(),
                                           GURL("https://example.com"));
-  ::testing::Mock::VerifyAndClearExpectations(driver());
 }
 
 TEST_P(ContentSubresourceFilterDriverFactoryThreatTypeTest, NonSocEngHit) {
@@ -176,7 +146,7 @@ TEST_P(ContentSubresourceFilterDriverFactoryThreatTypeTest, NonSocEngHit) {
 INSTANTIATE_TEST_CASE_P(
     NoSonEngHit,
     ContentSubresourceFilterDriverFactoryThreatTypeTest,
-    ::testing::Values(
+    testing::Values(
         safe_browsing::ThreatPatternType::NONE,
         safe_browsing::ThreatPatternType::MALWARE_LANDING,
         safe_browsing::ThreatPatternType::MALWARE_DISTRIBUTION,
diff --git a/components/subresource_filter/content/browser/subresource_filter_navigation_throttle_unittests.cc b/components/subresource_filter/content/browser/subresource_filter_navigation_throttle_unittests.cc
index 547abb3..cee9d99 100644
--- a/components/subresource_filter/content/browser/subresource_filter_navigation_throttle_unittests.cc
+++ b/components/subresource_filter/content/browser/subresource_filter_navigation_throttle_unittests.cc
@@ -113,8 +113,7 @@ class SubresourceFilterNavigationThrottleTest
 TEST_F(SubresourceFilterNavigationThrottleTest, RequestWithoutRedirects) {
   base::FieldTrialList field_trial_list(nullptr);
   testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled,
-      kActivationScopeActivationList);
+      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled);
 
   const GURL url(kExampleURL);
   SetUpNavigationHandleForURL(url);
@@ -135,8 +134,7 @@ TEST_F(SubresourceFilterNavigationThrottleTest,
        RequestWithoutRedirectsNoActivation) {
   base::FieldTrialList field_trial_list(nullptr);
   testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled,
-      kActivationScopeActivationList);
+      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled);
 
   const GURL url_with_activation(kExampleURL);
   const GURL url_without_activation(kTestURL);
@@ -161,8 +159,7 @@ TEST_F(SubresourceFilterNavigationThrottleTest,
        RequestToNonWebURLNoActivation) {
   base::FieldTrialList field_trial_list(nullptr);
   testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled,
-      kActivationScopeActivationList);
+      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled);
 
   const GURL non_web_url(kNonWebURL);
 
@@ -188,8 +185,7 @@ TEST_F(SubresourceFilterNavigationThrottleTest,
   // Test checks that both |url| and |redirect| are in the activation set.
   base::FieldTrialList field_trial_list(nullptr);
   testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled,
-      kActivationScopeActivationList);
+      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled);
 
   const GURL url(kExampleURL);
   const GURL redirect(kRedirectURLFirst);
@@ -219,8 +215,7 @@ TEST_F(SubresourceFilterNavigationThrottleTest,
   // are in the activation set.
   base::FieldTrialList field_trial_list(nullptr);
   testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled,
-      kActivationScopeActivationList);
+      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled);
 
   const GURL url(kExampleURL);
   const GURL redirect_after_sb_classification(kTestURL);
@@ -256,8 +251,7 @@ TEST_F(SubresourceFilterNavigationThrottleTest,
        RequestRedirectWithMatchRedirectTest) {
   base::FieldTrialList field_trial_list(nullptr);
   testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled,
-      kActivationScopeActivationList);
+      base::FeatureList::OVERRIDE_ENABLE_FEATURE, kActivationStateEnabled);
 
   const GURL init_url(kExampleURL);
   const GURL redirect_with_match(kRedirectURLFirst);
diff --git a/components/subresource_filter/core/browser/BUILD.gn b/components/subresource_filter/core/browser/BUILD.gn
index 0f4a3f3..75d8624 100644
--- a/components/subresource_filter/core/browser/BUILD.gn
+++ b/components/subresource_filter/core/browser/BUILD.gn
@@ -17,7 +17,6 @@ static_library("browser") {
     "//components/prefs:prefs",
     "//components/subresource_filter/core/common",
     "//components/variations",
-    "//third_party/protobuf:protobuf_lite",
   ]
 }
 
diff --git a/components/subresource_filter/core/browser/ruleset_service.cc b/components/subresource_filter/core/browser/ruleset_service.cc
index 8f81d80..b3336c6 100644
--- a/components/subresource_filter/core/browser/ruleset_service.cc
+++ b/components/subresource_filter/core/browser/ruleset_service.cc
@@ -24,11 +24,8 @@
 #include "components/prefs/pref_service.h"
 #include "components/subresource_filter/core/browser/ruleset_distributor.h"
 #include "components/subresource_filter/core/browser/subresource_filter_constants.h"
-#include "components/subresource_filter/core/common/copying_file_stream.h"
 #include "components/subresource_filter/core/common/indexed_ruleset.h"
 #include "components/subresource_filter/core/common/proto/rules.pb.h"
-#include "components/subresource_filter/core/common/unindexed_ruleset.h"
-#include "third_party/protobuf/src/google/protobuf/io/zero_copy_stream_impl_lite.h"
 
 namespace subresource_filter {
 
@@ -161,24 +158,19 @@ IndexedRulesetVersion RulesetService::IndexAndWriteRuleset(
     const base::FilePath& indexed_ruleset_base_dir,
     const UnindexedRulesetInfo& unindexed_ruleset_info) {
   base::ThreadRestrictions::AssertIOAllowed();
-
-  base::File unindexed_ruleset_file(
-      unindexed_ruleset_info.ruleset_path,
-      base::File::FLAG_OPEN | base::File::FLAG_READ);
-  if (!unindexed_ruleset_file.IsValid())
+  std::string unindexed_ruleset_data;
+  if (!base::ReadFileToString(unindexed_ruleset_info.ruleset_path,
+                              &unindexed_ruleset_data)) {
     return IndexedRulesetVersion();
+  }
 
-  CopyingFileInputStream copying_stream(std::move(unindexed_ruleset_file));
-  google::protobuf::io::CopyingInputStreamAdaptor zero_copy_stream_adaptor(
-      &copying_stream, 4096 /* buffer_size */);
-  UnindexedRulesetReader reader(&zero_copy_stream_adaptor);
+  // TODO(pkalinnikov): Implement streaming wire format here.
+  proto::UrlRule rule;
+  if (!rule.ParseFromString(unindexed_ruleset_data))
+    return IndexedRulesetVersion();
 
   RulesetIndexer indexer;
-  proto::FilteringRules ruleset_chunk;
-  while (reader.ReadNextChunk(&ruleset_chunk)) {
-    for (const proto::UrlRule& rule : ruleset_chunk.url_rules())
-      indexer.AddUrlRule(rule);
-  }
+  indexer.AddUrlRule(rule);
   indexer.Finish();
 
   IndexedRulesetVersion indexed_version(
diff --git a/components/subresource_filter/core/browser/subresource_filter_features.cc b/components/subresource_filter/core/browser/subresource_filter_features.cc
index a0dea39..3e16a9f 100644
--- a/components/subresource_filter/core/browser/subresource_filter_features.cc
+++ b/components/subresource_filter/core/browser/subresource_filter_features.cc
@@ -19,11 +19,6 @@ const char kActivationStateDryRun[] = "dryrun";
 const char kActivationStateEnabled[] = "enabled";
 const char kActivationStateDisabled[] = "disabled";
 
-const char kActivationScopeParameterName[] = "activation_scope";
-const char kActivationScopeAllSites[] = "all_sites";
-const char kActivationScopeActivationList[] = "activation_list";
-const char kActivationScopeNoSites[] = "no_sites";
-
 ActivationState GetMaximumActivationState() {
   std::string activation_state = variations::GetVariationParamValueByFeature(
       kSafeBrowsingSubresourceFilter, kActivationStateParameterName);
@@ -34,15 +29,4 @@ ActivationState GetMaximumActivationState() {
   return ActivationState::DISABLED;
 }
 
-ActivationScope GetCurrentActivationScope() {
-  std::string activation_scope = variations::GetVariationParamValueByFeature(
-      kSafeBrowsingSubresourceFilter, kActivationScopeParameterName);
-  if (base::LowerCaseEqualsASCII(activation_scope, kActivationScopeAllSites))
-    return ActivationScope::ALL_SITES;
-  else if (base::LowerCaseEqualsASCII(activation_scope,
-                                      kActivationScopeActivationList))
-    return ActivationScope::ACTIVATION_LIST;
-  return ActivationScope::NO_SITES;
-}
-
 }  // namespace subresource_filter
diff --git a/components/subresource_filter/core/browser/subresource_filter_features.h b/components/subresource_filter/core/browser/subresource_filter_features.h
index 0d972a7..612a2d9 100644
--- a/components/subresource_filter/core/browser/subresource_filter_features.h
+++ b/components/subresource_filter/core/browser/subresource_filter_features.h
@@ -6,7 +6,6 @@
 #define COMPONENTS_SUBRESOURCE_FILTER_SUBRESOURCE_FILTER_FEATURES_H_
 
 #include "base/feature_list.h"
-#include "components/subresource_filter/core/common/activation_scope.h"
 #include "components/subresource_filter/core/common/activation_state.h"
 
 namespace subresource_filter {
@@ -20,22 +19,11 @@ extern const char kActivationStateDryRun[];
 extern const char kActivationStateEnabled[];
 extern const char kActivationStateDisabled[];
 
-extern const char kActivationScopeParameterName[];
-extern const char kActivationScopeAllSites[];
-extern const char kActivationScopeActivationList[];
-extern const char kActivationScopeNoSites[];
-
 // Returns the maximum degree to which subresource filtering should be activated
 // on any RenderFrame. This will be ActivationState::DISABLED unless the feature
 // is enabled and variation parameters prescribe a higher activation state.
 ActivationState GetMaximumActivationState();
 
-// Returns the current activation scope, that is, the subset of page loads where
-// subresource filtering should be activated. The function returns
-// ActivationScope::NO_SITES unless the feature is enabled and variation
-// parameters prescribe a wider activation scope.
-ActivationScope GetCurrentActivationScope();
-
 }  // namespace subresource_filter
 
 #endif  // COMPONENTS_SUBRESOURCE_FILTER_SUBRESOURCE_FILTER_FEATURES_H_
diff --git a/components/subresource_filter/core/browser/subresource_filter_features_test_support.cc b/components/subresource_filter/core/browser/subresource_filter_features_test_support.cc
index 87dd1a0..6b9cee6 100644
--- a/components/subresource_filter/core/browser/subresource_filter_features_test_support.cc
+++ b/components/subresource_filter/core/browser/subresource_filter_features_test_support.cc
@@ -22,14 +22,12 @@ const char kTestExperimentGroupName[] = "GroupNameShouldNotMatter";
 
 ScopedSubresourceFilterFeatureToggle::ScopedSubresourceFilterFeatureToggle(
     base::FeatureList::OverrideState feature_state,
-    const std::string& maximum_activation_state,
-    const std::string& activation_scope) {
+    const std::string& maximum_activation_state) {
   base::FeatureList::ClearInstanceForTesting();
   variations::testing::ClearAllVariationParams();
 
   std::map<std::string, std::string> variation_params;
   variation_params[kActivationStateParameterName] = maximum_activation_state;
-  variation_params[kActivationScopeParameterName] = activation_scope;
   EXPECT_TRUE(variations::AssociateVariationParams(
       kTestFieldTrialName, kTestExperimentGroupName, variation_params));
 
diff --git a/components/subresource_filter/core/browser/subresource_filter_features_test_support.h b/components/subresource_filter/core/browser/subresource_filter_features_test_support.h
index eedc83c..0c301b9 100644
--- a/components/subresource_filter/core/browser/subresource_filter_features_test_support.h
+++ b/components/subresource_filter/core/browser/subresource_filter_features_test_support.h
@@ -20,8 +20,7 @@ class ScopedSubresourceFilterFeatureToggle {
  public:
   ScopedSubresourceFilterFeatureToggle(
       base::FeatureList::OverrideState feature_state,
-      const std::string& maximum_activation_state,
-      const std::string& activation_scope);
+      const std::string& maximum_activation_state);
   ~ScopedSubresourceFilterFeatureToggle();
 
  private:
diff --git a/components/subresource_filter/core/browser/subresource_filter_features_unittest.cc b/components/subresource_filter/core/browser/subresource_filter_features_unittest.cc
index 6943d96..78637e4 100644
--- a/components/subresource_filter/core/browser/subresource_filter_features_unittest.cc
+++ b/components/subresource_filter/core/browser/subresource_filter_features_unittest.cc
@@ -40,94 +40,9 @@ TEST(SubresourceFilterFeaturesTest, ActivationState) {
     testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
         test_case.feature_enabled ? base::FeatureList::OVERRIDE_ENABLE_FEATURE
                                   : base::FeatureList::OVERRIDE_USE_DEFAULT,
-        test_case.activation_state_param, kActivationScopeNoSites);
+        test_case.activation_state_param);
 
     EXPECT_EQ(test_case.expected_activation_state, GetMaximumActivationState());
-    EXPECT_EQ(ActivationScope::NO_SITES, GetCurrentActivationScope());
-  }
-}
-
-TEST(SubresourceFilterFeaturesTest, ActivationScope) {
-  const struct {
-    bool feature_enabled;
-    const char* activation_scope_param;
-    ActivationScope expected_activation_scope;
-  } kTestCases[] = {
-      {false, "", ActivationScope::NO_SITES},
-      {false, "no_sites", ActivationScope::NO_SITES},
-      {false, "allsites", ActivationScope::NO_SITES},
-      {false, "enabled", ActivationScope::NO_SITES},
-      {false, "%$ garbage !%", ActivationScope::NO_SITES},
-      {true, "", ActivationScope::NO_SITES},
-      {true, "nosites", ActivationScope::NO_SITES},
-      {true, "No_sites", ActivationScope::NO_SITES},
-      {true, "no_sites", ActivationScope::NO_SITES},
-      {true, "%$ garbage !%", ActivationScope::NO_SITES},
-      {true, kActivationScopeAllSites, ActivationScope::ALL_SITES},
-      {true, kActivationScopeActivationList, ActivationScope::ACTIVATION_LIST}};
-
-  for (const auto& test_case : kTestCases) {
-    SCOPED_TRACE(::testing::Message("Enabled = ") << test_case.feature_enabled);
-    SCOPED_TRACE(::testing::Message("ActivationScopeParam = \"")
-                 << test_case.activation_scope_param << "\"");
-
-    base::FieldTrialList field_trial_list(nullptr /* entropy_provider */);
-    testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-        test_case.feature_enabled ? base::FeatureList::OVERRIDE_ENABLE_FEATURE
-                                  : base::FeatureList::OVERRIDE_USE_DEFAULT,
-        kActivationStateDisabled, test_case.activation_scope_param);
-
-    EXPECT_EQ(ActivationState::DISABLED, GetMaximumActivationState());
-    EXPECT_EQ(test_case.expected_activation_scope, GetCurrentActivationScope());
-  }
-}
-
-TEST(SubresourceFilterFeaturesTest, ActivationStateAndScope) {
-  const struct {
-    bool feature_enabled;
-    const char* activation_state_param;
-    ActivationState expected_activation_state;
-    const char* activation_scope_param;
-    ActivationScope expected_activation_scope;
-  } kTestCases[] = {
-      {false, kActivationStateDisabled, ActivationState::DISABLED,
-       kActivationScopeNoSites, ActivationScope::NO_SITES},
-      {true, kActivationStateDisabled, ActivationState::DISABLED,
-       kActivationScopeNoSites, ActivationScope::NO_SITES},
-      {true, kActivationStateDisabled, ActivationState::DISABLED,
-       kActivationScopeAllSites, ActivationScope::ALL_SITES},
-      {true, kActivationStateDisabled, ActivationState::DISABLED,
-       kActivationScopeActivationList, ActivationScope::ACTIVATION_LIST},
-      {true, kActivationStateDisabled, ActivationState::DISABLED,
-       kActivationScopeAllSites, ActivationScope::ALL_SITES},
-      {true, kActivationStateDryRun, ActivationState::DRYRUN,
-       kActivationScopeNoSites, ActivationScope::NO_SITES},
-      {true, kActivationStateDryRun, ActivationState::DRYRUN,
-       kActivationScopeAllSites, ActivationScope::ALL_SITES},
-      {true, kActivationStateDryRun, ActivationState::DRYRUN,
-       kActivationScopeActivationList, ActivationScope::ACTIVATION_LIST},
-      {true, kActivationStateDryRun, ActivationState::DRYRUN,
-       kActivationScopeAllSites, ActivationScope::ALL_SITES},
-      {true, kActivationStateEnabled, ActivationState::ENABLED,
-       kActivationScopeNoSites, ActivationScope::NO_SITES},
-      {true, kActivationStateEnabled, ActivationState::ENABLED,
-       kActivationScopeAllSites, ActivationScope::ALL_SITES},
-      {true, kActivationStateEnabled, ActivationState::ENABLED,
-       kActivationScopeActivationList, ActivationScope::ACTIVATION_LIST},
-      {true, kActivationStateEnabled, ActivationState::ENABLED,
-       kActivationScopeAllSites, ActivationScope::ALL_SITES},
-      {false, kActivationStateEnabled, ActivationState::DISABLED,
-       kActivationScopeAllSites, ActivationScope::NO_SITES}};
-
-  for (const auto& test_case : kTestCases) {
-    base::FieldTrialList field_trial_list(nullptr /* entropy_provider */);
-    testing::ScopedSubresourceFilterFeatureToggle scoped_feature_toggle(
-        test_case.feature_enabled ? base::FeatureList::OVERRIDE_ENABLE_FEATURE
-                                  : base::FeatureList::OVERRIDE_USE_DEFAULT,
-        test_case.activation_state_param, test_case.activation_scope_param);
-
-    EXPECT_EQ(test_case.expected_activation_scope, GetCurrentActivationScope());
-    EXPECT_EQ(test_case.expected_activation_state, GetMaximumActivationState());
   }
 }
 
diff --git a/components/subresource_filter/core/common/BUILD.gn b/components/subresource_filter/core/common/BUILD.gn
index 4e12cc3..815c546 100644
--- a/components/subresource_filter/core/common/BUILD.gn
+++ b/components/subresource_filter/core/common/BUILD.gn
@@ -4,13 +4,9 @@
 
 static_library("common") {
   sources = [
-    "activation_scope.cc",
-    "activation_scope.h",
     "activation_state.cc",
     "activation_state.h",
     "closed_hash_map.h",
-    "copying_file_stream.cc",
-    "copying_file_stream.h",
     "fuzzy_pattern_matching.cc",
     "fuzzy_pattern_matching.h",
     "indexed_ruleset.cc",
@@ -21,8 +17,6 @@ static_library("common") {
     "ngram_extractor.h",
     "string_splitter.h",
     "uint64_hasher.h",
-    "unindexed_ruleset.cc",
-    "unindexed_ruleset.h",
     "url_pattern.cc",
     "url_pattern.h",
     "url_pattern_matching.h",
@@ -37,7 +31,6 @@ static_library("common") {
     "//base",
     "//net",
     "//third_party/flatbuffers:flatbuffers",
-    "//third_party/protobuf:protobuf_lite",
     "//url",
   ]
 }
@@ -52,7 +45,6 @@ static_library("test_support") {
     ":common",
     "//base",
     "//testing/gtest",
-    "//third_party/protobuf:protobuf_lite",
   ]
 }
 
@@ -65,14 +57,12 @@ source_set("unit_tests") {
     "knuth_morris_pratt_unittest.cc",
     "ngram_extractor_unittest.cc",
     "string_splitter_unittest.cc",
-    "unindexed_ruleset_unittest.cc",
     "url_pattern_matching_unittest.cc",
   ]
   deps = [
     ":common",
     "//base",
     "//testing/gtest",
-    "//third_party/protobuf:protobuf_lite",
     "//url",
   ]
 }
diff --git a/components/subresource_filter/core/common/activation_scope.cc b/components/subresource_filter/core/common/activation_scope.cc
deleted file mode 100644
index 9b93957..0000000
--- a/components/subresource_filter/core/common/activation_scope.cc
+++ /dev/null
@@ -1,31 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "components/subresource_filter/core/common/activation_scope.h"
-
-#include <ostream>
-
-#include "base/logging.h"
-
-namespace subresource_filter {
-
-std::ostream& operator<<(std::ostream& os, const ActivationScope& state) {
-  switch (state) {
-    case ActivationScope::NO_SITES:
-      os << "NO_SITES";
-      break;
-    case ActivationScope::ALL_SITES:
-      os << "ALL_SITES";
-      break;
-    case ActivationScope::ACTIVATION_LIST:
-      os << "ACTIVATION_LIST";
-      break;
-    default:
-      NOTREACHED();
-      break;
-  }
-  return os;
-}
-
-}  // namespace subresource_filter
diff --git a/components/subresource_filter/core/common/activation_scope.h b/components/subresource_filter/core/common/activation_scope.h
deleted file mode 100644
index aa65d36..0000000
--- a/components/subresource_filter/core/common/activation_scope.h
+++ /dev/null
@@ -1,29 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef COMPONENTS_SUBRESOURCE_FILTER_CORE_COMMON_ACTIVATION_SCOPE_H_
-#define COMPONENTS_SUBRESOURCE_FILTER_CORE_COMMON_ACTIVATION_SCOPE_H_
-
-#include <iosfwd>
-
-namespace subresource_filter {
-
-// Defines the scope of triggering the Safe Browsing Subresource Filter.
-enum class ActivationScope {
-  NO_SITES,
-  // Allows to activate Safe Browsing Subresource Filter only on web sites from
-  // the Safe Browsing blacklist.
-  ACTIVATION_LIST,
-  // Testing only. Allows to send activation signal to the RenderFrame for each
-  // load.
-  ALL_SITES,
-  LAST = ACTIVATION_LIST,
-};
-
-// For logging use only.
-std::ostream& operator<<(std::ostream& os, const ActivationScope& state);
-
-}  // namespace subresource_filter
-
-#endif  // COMPONENTS_SUBRESOURCE_FILTER_CORE_COMMON_ACTIVATION_SCOPE_H_
diff --git a/components/subresource_filter/core/common/copying_file_stream.cc b/components/subresource_filter/core/common/copying_file_stream.cc
deleted file mode 100644
index 5d4b82b..0000000
--- a/components/subresource_filter/core/common/copying_file_stream.cc
+++ /dev/null
@@ -1,31 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "components/subresource_filter/core/common/copying_file_stream.h"
-
-namespace subresource_filter {
-
-// CopyingFileInputStream ------------------------------------------------------
-
-CopyingFileInputStream::~CopyingFileInputStream() = default;
-
-CopyingFileInputStream::CopyingFileInputStream(base::File file)
-    : file_(std::move(file)) {}
-
-int CopyingFileInputStream::Read(void* buffer, int size) {
-  return file_.ReadAtCurrentPosNoBestEffort(static_cast<char*>(buffer), size);
-}
-
-// CopyingFileOutputStream -----------------------------------------------------
-CopyingFileOutputStream::~CopyingFileOutputStream() = default;
-
-CopyingFileOutputStream::CopyingFileOutputStream(base::File file)
-    : file_(std::move(file)) {}
-
-bool CopyingFileOutputStream::Write(const void* buffer, int size) {
-  return file_.WriteAtCurrentPos(static_cast<const char*>(buffer), size) ==
-         size;
-}
-
-}  // namespace subresource_filter
diff --git a/components/subresource_filter/core/common/copying_file_stream.h b/components/subresource_filter/core/common/copying_file_stream.h
deleted file mode 100644
index f831816..0000000
--- a/components/subresource_filter/core/common/copying_file_stream.h
+++ /dev/null
@@ -1,51 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef COMPONENTS_SUBRESOURCE_FILTER_CORE_COMMON_COPYING_FILE_STREAM_H_
-#define COMPONENTS_SUBRESOURCE_FILTER_CORE_COMMON_COPYING_FILE_STREAM_H_
-
-#include "base/files/file.h"
-#include "base/macros.h"
-#include "third_party/protobuf/src/google/protobuf/io/zero_copy_stream_impl_lite.h"
-
-namespace subresource_filter {
-
-// Implements a CopyingInputStream that reads from a base::File. Can be used in
-// combination with CopyingInputStreamAdaptor for reading from that file through
-// the ZeroCopyInputStream interface.
-class CopyingFileInputStream : public google::protobuf::io::CopyingInputStream {
- public:
-  explicit CopyingFileInputStream(base::File file);
-  ~CopyingFileInputStream() override;
-
-  // google::protobuf::io::CopyingInputStream:
-  int Read(void* buffer, int size) override;
-
- private:
-  base::File file_;
-
-  DISALLOW_COPY_AND_ASSIGN(CopyingFileInputStream);
-};
-
-// Implements a CopyingOutputStream that writes to a base::File. Can be used in
-// combination with CopyingOutputStreamAdaptor for writing to that file through
-// the ZeroCopyOutputStream interface.
-class CopyingFileOutputStream
-    : public google::protobuf::io::CopyingOutputStream {
- public:
-  explicit CopyingFileOutputStream(base::File file);
-  ~CopyingFileOutputStream() override;
-
-  // google::protobuf::io::CopyingOutputStream:
-  bool Write(const void* buffer, int size) override;
-
- private:
-  base::File file_;
-
-  DISALLOW_COPY_AND_ASSIGN(CopyingFileOutputStream);
-};
-
-}  // namespace subresource_filter
-
-#endif  // COMPONENTS_SUBRESOURCE_FILTER_CORE_COMMON_COPYING_FILE_STREAM_H_
diff --git a/components/subresource_filter/core/common/test_ruleset_creator.cc b/components/subresource_filter/core/common/test_ruleset_creator.cc
index 6c056cf..51c8b95 100644
--- a/components/subresource_filter/core/common/test_ruleset_creator.cc
+++ b/components/subresource_filter/core/common/test_ruleset_creator.cc
@@ -9,9 +9,7 @@
 #include "base/strings/string_number_conversions.h"
 #include "components/subresource_filter/core/common/indexed_ruleset.h"
 #include "components/subresource_filter/core/common/proto/rules.pb.h"
-#include "components/subresource_filter/core/common/unindexed_ruleset.h"
 #include "testing/gtest/include/gtest/gtest.h"
-#include "third_party/protobuf/src/google/protobuf/io/zero_copy_stream_impl_lite.h"
 
 namespace subresource_filter {
 
@@ -34,14 +32,12 @@ proto::UrlRule CreateSuffixRule(base::StringPiece suffix) {
 
 std::vector<uint8_t> SerializeUnindexedRulesetWithSingleRule(
     const proto::UrlRule& rule) {
-  std::string ruleset_contents;
-  google::protobuf::io::StringOutputStream output(&ruleset_contents);
-  UnindexedRulesetWriter ruleset_writer(&output);
-  ruleset_writer.AddUrlRule(rule);
-  ruleset_writer.Finish();
-
-  auto data = reinterpret_cast<const uint8_t*>(ruleset_contents.data());
-  return std::vector<uint8_t>(data, data + ruleset_contents.size());
+  std::vector<uint8_t> ruleset_contents;
+  std::string serialized_rule;
+  rule.SerializeToString(&serialized_rule);
+  const uint8_t* data =
+      reinterpret_cast<const uint8_t*>(serialized_rule.data());
+  return std::vector<uint8_t>(data, data + serialized_rule.size());
 }
 
 std::vector<uint8_t> SerializeIndexedRulesetWithSingleRule(
diff --git a/components/subresource_filter/core/common/unindexed_ruleset.cc b/components/subresource_filter/core/common/unindexed_ruleset.cc
deleted file mode 100644
index 086fb24..0000000
--- a/components/subresource_filter/core/common/unindexed_ruleset.cc
+++ /dev/null
@@ -1,67 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "components/subresource_filter/core/common/unindexed_ruleset.h"
-
-#include "base/numerics/safe_conversions.h"
-
-namespace subresource_filter {
-
-// UnindexedRulesetReader ------------------------------------------------------
-
-UnindexedRulesetReader::UnindexedRulesetReader(
-    google::protobuf::io::ZeroCopyInputStream* stream)
-    : coded_stream_(stream) {}
-
-UnindexedRulesetReader::~UnindexedRulesetReader() = default;
-
-bool UnindexedRulesetReader::ReadNextChunk(proto::FilteringRules* chunk) {
-  uint32_t chunk_size = 0;
-  if (!coded_stream_.ReadVarint32(&chunk_size))
-    return false;
-  auto limit = coded_stream_.PushLimit(chunk_size);
-  if (!chunk->ParseFromCodedStream(&coded_stream_))
-    return false;
-  coded_stream_.PopLimit(limit);
-  return true;
-}
-
-// UnindexedRulesetWriter ------------------------------------------------------
-
-UnindexedRulesetWriter::UnindexedRulesetWriter(
-    google::protobuf::io::ZeroCopyOutputStream* stream,
-    int max_rules_per_chunk)
-    : coded_stream_(stream), max_rules_per_chunk_(max_rules_per_chunk) {}
-
-UnindexedRulesetWriter::~UnindexedRulesetWriter() {
-  DCHECK_EQ(pending_chunk_.url_rules_size(), 0);
-  DCHECK_EQ(pending_chunk_.css_rules_size(), 0);
-}
-
-bool UnindexedRulesetWriter::AddUrlRule(const proto::UrlRule& rule) {
-  DCHECK(!had_error());
-  pending_chunk_.add_url_rules()->CopyFrom(rule);
-  if (pending_chunk_.url_rules_size() >= max_rules_per_chunk_) {
-    DCHECK_EQ(pending_chunk_.url_rules_size(), max_rules_per_chunk_);
-    return WritePendingChunk();
-  }
-  return true;
-}
-
-bool UnindexedRulesetWriter::Finish() {
-  DCHECK(!had_error());
-  return !pending_chunk_.url_rules_size() || WritePendingChunk();
-}
-
-bool UnindexedRulesetWriter::WritePendingChunk() {
-  DCHECK(!had_error());
-  DCHECK_GT(pending_chunk_.url_rules_size(), 0);
-
-  proto::FilteringRules chunk;
-  chunk.Swap(&pending_chunk_);
-  coded_stream_.WriteVarint32(base::checked_cast<uint32_t>(chunk.ByteSize()));
-  return !had_error() && chunk.SerializeToCodedStream(&coded_stream_);
-}
-
-}  // namespace subresource_filter
diff --git a/components/subresource_filter/core/common/unindexed_ruleset.h b/components/subresource_filter/core/common/unindexed_ruleset.h
deleted file mode 100644
index 62b417b..0000000
--- a/components/subresource_filter/core/common/unindexed_ruleset.h
+++ /dev/null
@@ -1,97 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-// Semantically speaking, an unindexed ruleset consists of a single
-// proto::FilteringRules message. However, because the ruleset can be relatively
-// large, we want to avoid deserializing all of it at once, as doing so can lead
-// to memory allocation bursts.
-//
-// To work around the limitation that partial (or streaming) deserialization is
-// not supported by the proto parser, the UnindexedRulesetReader/Writer classes
-// implement a format where the ruleset is split into several chunks. Each chunk
-// is itself a proto::FilteringRules message. If all chunks were merged, they
-// would add up to the original proto::FilteringRules message representing the
-// entire ruleset.
-//
-// Consumers of an unindexed ruleset in this format will be able to read it one
-// chunk at a time, and are expected to fully process and discard the chunk
-// before reading the next one. In practice, this should not be an issue as
-// indexing of the ruleset is expected to be performed in an on-line fashion.
-
-#ifndef COMPONENTS_SUBRESOURCE_FILTER_CORE_COMMON_UNINDEXED_RULESET_H_
-#define COMPONENTS_SUBRESOURCE_FILTER_CORE_COMMON_UNINDEXED_RULESET_H_
-
-#include "base/macros.h"
-#include "components/subresource_filter/core/common/proto/rules.pb.h"
-#include "third_party/protobuf/src/google/protobuf/io/coded_stream.h"
-#include "third_party/protobuf/src/google/protobuf/io/zero_copy_stream.h"
-
-namespace subresource_filter {
-
-// Reads an unindexed ruleset from |stream| one chunk at a time.
-class UnindexedRulesetReader {
- public:
-  // Note: The |stream| should outlive |this| instance.
-  explicit UnindexedRulesetReader(
-      google::protobuf::io::ZeroCopyInputStream* stream);
-  ~UnindexedRulesetReader();
-
-  // Reads the next ruleset |chunk| from the |input|. Returns false iff reached
-  // the end of the stream or an error occurred. Once returned false, calling
-  // ReadNextChunk is undefined befaviour.
-  bool ReadNextChunk(proto::FilteringRules* chunk);
-
- private:
-  google::protobuf::io::CodedInputStream coded_stream_;
-
-  DISALLOW_COPY_AND_ASSIGN(UnindexedRulesetReader);
-};
-
-// Divides an unindexed ruleset into chunks and writes them into |stream|.
-//
-// Writing methods of this class return bool false if an I/O error occurrs
-// during these calls. In this case the UnindexedRulesetWriter becomes broken,
-// and write operations should not be used further.
-class UnindexedRulesetWriter {
- public:
-  // Creates an instance that will write proto::FilteringRules chunks to the
-  // |stream|, with each chunk containing up to |max_rules_per_chunk| rules.
-  explicit UnindexedRulesetWriter(
-      google::protobuf::io::ZeroCopyOutputStream* stream,
-      int max_rules_per_chunk = 64);
-  ~UnindexedRulesetWriter();
-
-  int max_rules_per_chunk() const { return max_rules_per_chunk_; }
-
-  // Returns whether an I/O error occurred since this object was created.
-  bool had_error() const { return coded_stream_.HadError(); }
-
-  // Places the |rule| to the current chunk, and serializes the chunk if it has
-  // grown up to |max_rules_per_chunk|.
-  bool AddUrlRule(const proto::UrlRule& rule);
-  // TODO(pkalinnikov): Implement AddCssRule when needed.
-
-  // Finalizes the serialization of the unindexed ruleset, i.e., writes the
-  // final chunk of rules, if there are any still pending. This method *should*
-  // be called exactly once when interaction with |this| instance ends, unless
-  // some of the writing operations returned false, which indicates an error.
-  // After calling Finish write operations should not be used any more.
-  bool Finish();
-
- private:
-  // Writes the non-empty |pending_chunk_| to the |coded_stream_|. Always leaves
-  // the |panding_chunk_| empty, regardless of whether an error occurred.
-  bool WritePendingChunk();
-
-  google::protobuf::io::CodedOutputStream coded_stream_;
-
-  const int max_rules_per_chunk_ = 0;
-  proto::FilteringRules pending_chunk_;
-
-  DISALLOW_COPY_AND_ASSIGN(UnindexedRulesetWriter);
-};
-
-}  // namespace subresource_filter
-
-#endif  // COMPONENTS_SUBRESOURCE_FILTER_CORE_COMMON_UNINDEXED_RULESET_H_
diff --git a/components/subresource_filter/core/common/unindexed_ruleset_unittest.cc b/components/subresource_filter/core/common/unindexed_ruleset_unittest.cc
deleted file mode 100644
index 5c093b3..0000000
--- a/components/subresource_filter/core/common/unindexed_ruleset_unittest.cc
+++ /dev/null
@@ -1,198 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "components/subresource_filter/core/common/unindexed_ruleset.h"
-
-#include <memory>
-#include <string>
-#include <vector>
-
-#include "base/macros.h"
-#include "base/strings/string_number_conversions.h"
-#include "components/subresource_filter/core/common/proto/rules.pb.h"
-#include "components/subresource_filter/core/common/url_pattern.h"
-#include "testing/gtest/include/gtest/gtest.h"
-#include "third_party/protobuf/src/google/protobuf/io/zero_copy_stream.h"
-#include "third_party/protobuf/src/google/protobuf/io/zero_copy_stream_impl_lite.h"
-
-namespace subresource_filter {
-
-namespace {
-
-bool IsEqual(const proto::UrlRule& first, const proto::UrlRule& second) {
-  // Note: The domain list is omitted for simplicity.
-  return first.semantics() == second.semantics() &&
-         first.source_type() == second.source_type() &&
-         first.element_types() == second.element_types() &&
-         first.activation_types() == second.activation_types() &&
-         first.url_pattern_type() == second.url_pattern_type() &&
-         first.anchor_left() == second.anchor_left() &&
-         first.anchor_right() == second.anchor_right() &&
-         first.match_case() == second.match_case() &&
-         first.url_pattern() == second.url_pattern();
-}
-
-proto::UrlRule CreateRule(const UrlPattern& url_pattern,
-                          proto::SourceType source_type,
-                          bool is_whitelist) {
-  proto::UrlRule rule;
-  rule.set_semantics(is_whitelist ? proto::RULE_SEMANTICS_WHITELIST
-                                  : proto::RULE_SEMANTICS_BLACKLIST);
-
-  rule.set_source_type(source_type);
-  rule.set_element_types(proto::ELEMENT_TYPE_ALL);
-
-  rule.set_url_pattern_type(url_pattern.type);
-  rule.set_anchor_left(url_pattern.anchor_left);
-  rule.set_anchor_right(url_pattern.anchor_right);
-  rule.set_match_case(url_pattern.match_case);
-  rule.set_url_pattern(url_pattern.url_pattern.as_string());
-  return rule;
-}
-
-// The helper class used for building UnindexedRulesets.
-class UnindexedRulesetTestBuilder {
- public:
-  // Initializes the builder that writes the ruleset to StringOutputStream.
-  UnindexedRulesetTestBuilder()
-      : output_(
-            new google::protobuf::io::StringOutputStream(&ruleset_contents_)),
-        ruleset_writer_(output_.get()) {}
-
-  // Initializes the builder that writes the ruleset to an array of |array_size|
-  // through an ArrayOutputStream.
-  UnindexedRulesetTestBuilder(int array_size)
-      : ruleset_contents_(array_size, '\0'),
-        output_(
-            new google::protobuf::io::ArrayOutputStream(&ruleset_contents_[0],
-                                                        array_size)),
-        ruleset_writer_(output_.get()) {}
-
-  int max_rules_per_chunk() const {
-    return ruleset_writer_.max_rules_per_chunk();
-  }
-
-  bool AddUrlRule(const UrlPattern& url_pattern,
-                  proto::SourceType source_type,
-                  bool is_whitelist) {
-    url_rules_.push_back(CreateRule(url_pattern, source_type, is_whitelist));
-    return !ruleset_writer_.had_error() &&
-           ruleset_writer_.AddUrlRule(url_rules_.back());
-  }
-
-  bool AddUrlRules(int number_of_rules) {
-    for (int i = 0; i < number_of_rules; ++i) {
-      std::string url_pattern = "example" + base::IntToString(i) + ".com";
-      if (!AddUrlRule(UrlPattern(url_pattern), proto::SOURCE_TYPE_ANY, i & 1))
-        return false;
-    }
-    return true;
-  }
-
-  bool Finish() {
-    if (!ruleset_writer_.had_error() && ruleset_writer_.Finish()) {
-      // Note: This line has effect only when |output_| is an ArrayOutputStream.
-      ruleset_contents_.resize(output_->ByteCount());
-      return true;
-    }
-    return false;
-  }
-
-  const std::vector<proto::UrlRule>& url_rules() const { return url_rules_; }
-  const std::string& ruleset_contents() const { return ruleset_contents_; }
-
- private:
-  std::vector<proto::UrlRule> url_rules_;
-  std::string ruleset_contents_;
-  std::unique_ptr<google::protobuf::io::ZeroCopyOutputStream> output_;
-  UnindexedRulesetWriter ruleset_writer_;
-
-  DISALLOW_COPY_AND_ASSIGN(UnindexedRulesetTestBuilder);
-};
-
-bool IsRulesetValid(const std::string& ruleset_contents,
-                    const std::vector<proto::UrlRule>& expected_url_rules) {
-  google::protobuf::io::ArrayInputStream array_input(ruleset_contents.data(),
-                                                     ruleset_contents.size());
-  UnindexedRulesetReader reader(&array_input);
-  proto::FilteringRules chunk;
-  std::vector<proto::UrlRule> read_rules;
-  while (reader.ReadNextChunk(&chunk)) {
-    read_rules.insert(read_rules.end(), chunk.url_rules().begin(),
-                      chunk.url_rules().end());
-  }
-
-  if (expected_url_rules.size() != read_rules.size())
-    return false;
-  for (size_t i = 0, size = read_rules.size(); i != size; ++i) {
-    if (!IsEqual(expected_url_rules[i], read_rules[i]))
-      return false;
-  }
-  return true;
-}
-
-}  // namespace
-
-TEST(UnindexedRulesetTest, EmptyRuleset) {
-  UnindexedRulesetTestBuilder builder;
-  EXPECT_TRUE(builder.Finish());
-  EXPECT_TRUE(IsRulesetValid(builder.ruleset_contents(), builder.url_rules()));
-}
-
-TEST(UnindexedRulesetTest, OneUrlRule) {
-  UnindexedRulesetTestBuilder builder;
-  EXPECT_TRUE(builder.AddUrlRule(UrlPattern("example.com"),
-                                 proto::SOURCE_TYPE_THIRD_PARTY, false));
-  EXPECT_TRUE(builder.Finish());
-  EXPECT_TRUE(IsRulesetValid(builder.ruleset_contents(), builder.url_rules()));
-}
-
-TEST(UnindexedRulesetTest, ManyUrlRules) {
-  UnindexedRulesetTestBuilder builder;
-  EXPECT_TRUE(builder.AddUrlRules(1234));
-  EXPECT_TRUE(builder.Finish());
-  EXPECT_TRUE(IsRulesetValid(builder.ruleset_contents(), builder.url_rules()));
-}
-
-TEST(UnindexedRulesetTest, ExactlyMaxRulesPerChunk) {
-  UnindexedRulesetTestBuilder builder;
-  EXPECT_TRUE(builder.AddUrlRules(builder.max_rules_per_chunk()));
-  EXPECT_TRUE(builder.Finish());
-  EXPECT_TRUE(IsRulesetValid(builder.ruleset_contents(), builder.url_rules()));
-}
-
-TEST(UnindexedRulesetTest, MaxRulesPerChunkPlusOne) {
-  UnindexedRulesetTestBuilder builder;
-  EXPECT_TRUE(builder.AddUrlRules(builder.max_rules_per_chunk() + 1));
-  EXPECT_TRUE(builder.Finish());
-  EXPECT_TRUE(IsRulesetValid(builder.ruleset_contents(), builder.url_rules()));
-}
-
-TEST(UnindexedRulesetTest, ErrorOnWrite) {
-  UnindexedRulesetTestBuilder builder(1000);
-  EXPECT_FALSE(builder.AddUrlRules(1234));
-}
-
-TEST(UnindexedRulesetTest, ReadCorruptedInput) {
-  UnindexedRulesetTestBuilder builder;
-  EXPECT_TRUE(builder.AddUrlRules(1000));
-  EXPECT_TRUE(builder.Finish());
-
-  {
-    std::string ruleset_contents = builder.ruleset_contents();
-    ASSERT_GE(ruleset_contents.size(), static_cast<size_t>(2000));
-    ruleset_contents[100] ^= 239;
-    ruleset_contents[1000] ^= 3;
-    EXPECT_FALSE(IsRulesetValid(ruleset_contents, builder.url_rules()));
-  }
-
-  {
-    std::string ruleset_contents = builder.ruleset_contents();
-    ASSERT_GT(ruleset_contents.size(), static_cast<size_t>(100));
-    ruleset_contents.resize(100);
-    EXPECT_FALSE(IsRulesetValid(ruleset_contents, builder.url_rules()));
-  }
-}
-
-}  // namespace subresource_filter
diff --git a/components/sync_driver/non_blocking_data_type_controller.cc b/components/sync_driver/non_blocking_data_type_controller.cc
index d669d08..03e7e80 100644
--- a/components/sync_driver/non_blocking_data_type_controller.cc
+++ b/components/sync_driver/non_blocking_data_type_controller.cc
@@ -37,7 +37,7 @@ NonBlockingDataTypeController::NonBlockingDataTypeController(
 NonBlockingDataTypeController::~NonBlockingDataTypeController() {}
 
 bool NonBlockingDataTypeController::ShouldLoadModelBeforeConfigure() const {
-  // USS datatypes require loading models because model controls storage where
+  // USS datatypes require loading models because model contols storage where
   // data type context and progress marker are persisted.
   return true;
 }
diff --git a/components/toolbar/toolbar_model.h b/components/toolbar/toolbar_model.h
index afc86a9..9b2858f 100644
--- a/components/toolbar/toolbar_model.h
+++ b/components/toolbar/toolbar_model.h
@@ -61,6 +61,10 @@ class ToolbarModel {
   virtual security_state::SecurityStateModel::SecurityLevel GetSecurityLevel(
       bool ignore_editing) const = 0;
 
+
+  virtual int GetIronframeStatus() const = 0;
+  virtual std::string GetIronframeOrigin() const = 0;
+
   // Returns true if a call to GetText() would return something other than the
   // URL because of search term replacement.
   bool WouldReplaceURL() const;
diff --git a/components/toolbar/toolbar_model_delegate.h b/components/toolbar/toolbar_model_delegate.h
index 33f95c8..5fcac02 100644
--- a/components/toolbar/toolbar_model_delegate.h
+++ b/components/toolbar/toolbar_model_delegate.h
@@ -40,6 +40,10 @@ class ToolbarModelDelegate {
   // user edits that may be in progress.
   virtual SecurityLevel GetSecurityLevel() const = 0;
 
+  virtual int GetIronframeStatus() const = 0;
+
+  virtual std::string GetIronframeOrigin() const = 0;
+
   // Returns search terms as in search::GetSearchTerms() if such terms should
   // appear in the omnibox (i.e. the page is sufficiently secure, search term
   // replacement is enabled, editing is not in progress, etc.) given that the
diff --git a/components/toolbar/toolbar_model_impl.cc b/components/toolbar/toolbar_model_impl.cc
index f6c7410..d86c7c3 100644
--- a/components/toolbar/toolbar_model_impl.cc
+++ b/components/toolbar/toolbar_model_impl.cc
@@ -83,6 +83,21 @@ SecurityStateModel::SecurityLevel ToolbarModelImpl::GetSecurityLevel(
              : delegate_->GetSecurityLevel();
 }
 
+int ToolbarModelImpl::GetIronframeStatus() const {
+  // When editing or empty, assume no ironframe
+  return ((input_in_progress()) || !ShouldDisplayURL())
+             ? 0
+             : delegate_->GetIronframeStatus();
+}
+
+std::string ToolbarModelImpl::GetIronframeOrigin() const {
+  // When editing or empty, assume no ironframe
+    base::string16 empty;
+  return ((input_in_progress()) || !ShouldDisplayURL())
+      ? std::string()
+             : delegate_->GetIronframeOrigin();
+}
+
 int ToolbarModelImpl::GetIcon() const {
   switch (GetSecurityLevel(false)) {
     case SecurityStateModel::NONE:
diff --git a/components/toolbar/toolbar_model_impl.h b/components/toolbar/toolbar_model_impl.h
index 4b823f6..5ba4e10 100644
--- a/components/toolbar/toolbar_model_impl.h
+++ b/components/toolbar/toolbar_model_impl.h
@@ -38,6 +38,10 @@ class ToolbarModelImpl : public ToolbarModel {
   bool WouldPerformSearchTermReplacement(bool ignore_editing) const override;
   security_state::SecurityStateModel::SecurityLevel GetSecurityLevel(
       bool ignore_editing) const override;
+
+  int GetIronframeStatus() const override;
+  std::string GetIronframeOrigin() const override;
+
   int GetIcon() const override;
   gfx::VectorIconId GetVectorIcon() const override;
   base::string16 GetEVCertName() const override;
diff --git a/components/tracing/core/scattered_stream_writer.h b/components/tracing/core/scattered_stream_writer.h
index 8fbf84c..00af4d7 100644
--- a/components/tracing/core/scattered_stream_writer.h
+++ b/components/tracing/core/scattered_stream_writer.h
@@ -7,7 +7,6 @@
 
 #include <stdint.h>
 
-#include "base/logging.h"
 #include "base/macros.h"
 #include "components/tracing/tracing_export.h"
 
@@ -53,16 +52,6 @@ class TRACING_EXPORT ScatteredStreamWriter {
   // is guaranteed to be contiguous and not span across chunks.
   ContiguousMemoryRange ReserveBytes(size_t size);
 
-  // Fast (but unsafe) version of the above. The caller must have previously
-  // checked that there are at least |size| contiguos bytes available.
-  // Returns only the start pointer of the reservation.
-  uint8_t* ReserveBytesUnsafe(size_t size) {
-    uint8_t* begin = write_ptr_;
-    write_ptr_ += size;
-    DCHECK_LE(write_ptr_, cur_range_.end);
-    return begin;
-  }
-
   // Resets the buffer boundaries and the write pointer to the given |range|.
   // Subsequent WriteByte(s) will write into |range|.
   void Reset(ContiguousMemoryRange range);
diff --git a/components/tracing/core/scattered_stream_writer_unittest.cc b/components/tracing/core/scattered_stream_writer_unittest.cc
index 424aa00..0ce1824 100644
--- a/components/tracing/core/scattered_stream_writer_unittest.cc
+++ b/components/tracing/core/scattered_stream_writer_unittest.cc
@@ -68,13 +68,8 @@ TEST(ScatteredStreamWriterTest, ScatteredWrites) {
   for (uint8_t i = 0; i < 5; ++i)
     ssw.WriteByte(0xFF);
   memcpy(ssw.ReserveBytes(4).begin, kFourByteBuf, sizeof(kFourByteBuf));
-  memcpy(ssw.ReserveBytesUnsafe(3), kThreeByteBuf, sizeof(kThreeByteBuf));
-  memcpy(ssw.ReserveBytes(3).begin, kThreeByteBuf, sizeof(kThreeByteBuf));
-  memcpy(ssw.ReserveBytesUnsafe(1), kOneByteBuf, sizeof(kOneByteBuf));
-  memcpy(ssw.ReserveBytes(1).begin, kOneByteBuf, sizeof(kOneByteBuf));
-
-  EXPECT_EQ(8u, delegate.chunks().size());
-  EXPECT_EQ(3u, ssw.bytes_available());
+  EXPECT_EQ(7u, delegate.chunks().size());
+  EXPECT_EQ(4u, ssw.bytes_available());
 
   EXPECT_EQ("0001020304050607", delegate.GetChunkAsString(0));
   EXPECT_EQ("4060616263FF5051", delegate.GetChunkAsString(1));
@@ -82,8 +77,7 @@ TEST(ScatteredStreamWriterTest, ScatteredWrites) {
   EXPECT_EQ("A3A4A5A6A7A8A9AA", delegate.GetChunkAsString(3));
   EXPECT_EQ("ABACADAEAFB0B1B2", delegate.GetChunkAsString(4));
   EXPECT_EQ("B3FFFFFFFFFF0000", delegate.GetChunkAsString(5));
-  EXPECT_EQ("6061626350515200", delegate.GetChunkAsString(6));
-  EXPECT_EQ("5051524040000000", delegate.GetChunkAsString(7));
+  EXPECT_EQ("6061626300000000", delegate.GetChunkAsString(6));
 
   // Finally reset the writer to a new buffer.
   uint8_t other_buffer[8] = {0};
diff --git a/components/tracing/core/trace_ring_buffer.cc b/components/tracing/core/trace_ring_buffer.cc
index c206ed3..2a52bf6 100644
--- a/components/tracing/core/trace_ring_buffer.cc
+++ b/components/tracing/core/trace_ring_buffer.cc
@@ -10,9 +10,7 @@ namespace tracing {
 namespace v2 {
 
 TraceRingBuffer::TraceRingBuffer(uint8_t* begin, size_t size)
-    : num_chunks_(size / Chunk::kSize),
-      num_chunks_taken_(0),
-      current_chunk_idx_(0) {
+    : num_chunks_(size / Chunk::kSize), current_chunk_idx_(0) {
   DCHECK_GT(num_chunks_, 0u);
   DCHECK_EQ(0ul, reinterpret_cast<uintptr_t>(begin) % sizeof(uintptr_t));
   chunks_.reset(new Chunk[num_chunks_]);
@@ -25,7 +23,7 @@ TraceRingBuffer::TraceRingBuffer(uint8_t* begin, size_t size)
 
 TraceRingBuffer::~TraceRingBuffer() {}
 
-TraceRingBuffer::Chunk* TraceRingBuffer::TakeChunk(uint32_t writer_id) {
+TraceRingBuffer::Chunk* TraceRingBuffer::TakeChunk() {
   base::AutoLock lock(lock_);
   DCHECK_GT(num_chunks_, 0ul);
   DCHECK_LT(current_chunk_idx_, num_chunks_);
@@ -34,9 +32,7 @@ TraceRingBuffer::Chunk* TraceRingBuffer::TakeChunk(uint32_t writer_id) {
     current_chunk_idx_ = (current_chunk_idx_ + 1) % num_chunks_;
     if (!chunk->is_owned()) {
       chunk->Clear();
-      DCHECK_NE(0u, writer_id);
-      chunk->set_owner(writer_id);
-      num_chunks_taken_++;
+      chunk->set_owner(base::PlatformThread::CurrentId());
       return chunk;
     }
   }
@@ -50,40 +46,20 @@ TraceRingBuffer::Chunk* TraceRingBuffer::TakeChunk(uint32_t writer_id) {
   return &bankrupcy_chunk_;
 }
 
-void TraceRingBuffer::ReturnChunk(TraceRingBuffer::Chunk* chunk) {
-  // Returning a chunk without using it is quite odd, very likely a bug.
-  DCHECK_GT(chunk->used_size(), 0u);
-
-  // The caller should never return chunks which are part of a retaining chain.
-  DCHECK(!chunk->next_in_owner_list());
-
-  if (chunk == &bankrupcy_chunk_)
-    return;
-
-  // TODO(primiano): this lock might be removed in favor of acquire/release
-  // semantics on the two vars below. Check once the reader of these are landed.
+void TraceRingBuffer::ReturnChunk(TraceRingBuffer::Chunk* chunk,
+                                  uint32_t used_size) {
   base::AutoLock lock(lock_);
+  chunk->set_used_size(used_size);
   chunk->clear_owner();
-  num_chunks_taken_--;
-}
-
-bool TraceRingBuffer::IsBankrupcyChunkForTesting(const Chunk* chunk) const {
-  return chunk == &bankrupcy_chunk_;
-}
-
-size_t TraceRingBuffer::GetNumChunksTaken() const {
-  base::AutoLock lock(lock_);
-  return num_chunks_taken_;
 }
 
 TraceRingBuffer::Chunk::Chunk()
-    : begin_(nullptr), owner_(kNoChunkOwner), next_in_owner_list_(nullptr) {}
+    : begin_(nullptr), owner_(base::kInvalidThreadId) {}
 
 TraceRingBuffer::Chunk::~Chunk() {}
 
 void TraceRingBuffer::Chunk::Clear() {
   set_used_size(0);
-  set_next_in_owner_list(nullptr);
 }
 
 void TraceRingBuffer::Chunk::Initialize(uint8_t* begin) {
diff --git a/components/tracing/core/trace_ring_buffer.h b/components/tracing/core/trace_ring_buffer.h
index 534d3aa..4a86a8b 100644
--- a/components/tracing/core/trace_ring_buffer.h
+++ b/components/tracing/core/trace_ring_buffer.h
@@ -5,18 +5,15 @@
 #ifndef COMPONENTS_TRACING_CORE_TRACE_RING_BUFFER_H_
 #define COMPONENTS_TRACING_CORE_TRACE_RING_BUFFER_H_
 
-#include <memory>
-
 #include "base/atomicops.h"
 #include "base/macros.h"
 #include "base/synchronization/lock.h"
+#include "base/threading/thread.h"
 #include "components/tracing/tracing_export.h"
 
 namespace tracing {
 namespace v2 {
 
-static const uint32_t kNoChunkOwner = 0;
-
 class TRACING_EXPORT TraceRingBuffer {
  public:
   class Chunk {
@@ -42,26 +39,14 @@ class TRACING_EXPORT TraceRingBuffer {
       return base::subtle::NoBarrier_Load(header());
     }
 
-    void set_next_in_owner_list(Chunk* next) { next_in_owner_list_ = next; }
-    Chunk* next_in_owner_list() const { return next_in_owner_list_; }
-
-    // Owner is a flag matching the id of the TraceBufferWriter, 0 if not owned.
     // Accesses to |owner_| must happen under the buffer |lock_|.
-    bool is_owned() const { return owner_ != kNoChunkOwner; }
-    uint32_t owner() const { return owner_; }
-    void clear_owner() { owner_ = kNoChunkOwner; }
-    void set_owner(uint32_t owner) {
-      DCHECK_NE(kNoChunkOwner, owner);
-      owner_ = owner;
-    }
+    bool is_owned() const { return owner_ != base::kInvalidThreadId; }
+    void clear_owner() { owner_ = base::kInvalidThreadId; }
+    void set_owner(base::PlatformThreadId tid) { owner_ = tid; }
 
    private:
     uint8_t* begin_;
-    uint32_t owner_;
-
-    // When a chunk is owned, this is the next pointer to keep track of all
-    // owned chunks in a singly linked list.
-    Chunk* next_in_owner_list_;
+    base::PlatformThreadId owner_;  // kInvalidThreadId -> Chunk is not owned.
 
     DISALLOW_COPY_AND_ASSIGN(Chunk);
   };
@@ -69,23 +54,13 @@ class TRACING_EXPORT TraceRingBuffer {
   TraceRingBuffer(uint8_t* begin, size_t size);
   ~TraceRingBuffer();
 
-  Chunk* TakeChunk(uint32_t writer_id);
-  void ReturnChunk(Chunk* chunk);
-
-  size_t num_chunks() const { return num_chunks_; }
-
-  // Returns the number of chunks taken and not returned, without counting any
-  // bankrupcy chunk obtained when the ring buffer was full.
-  size_t GetNumChunksTaken() const;
-
-  const Chunk* chunks_for_testing() const { return chunks_.get(); }
-  bool IsBankrupcyChunkForTesting(const Chunk*) const;
+  Chunk* TakeChunk();
+  void ReturnChunk(Chunk* chunk, uint32_t used_size);
 
  private:
-  mutable base::Lock lock_;
+  base::Lock lock_;
   std::unique_ptr<Chunk[]> chunks_;
   const size_t num_chunks_;
-  size_t num_chunks_taken_;
   size_t current_chunk_idx_;
 
   // An emergency chunk used in the rare case in which all chunks are in flight.
diff --git a/components/tracing/core/trace_ring_buffer_unittest.cc b/components/tracing/core/trace_ring_buffer_unittest.cc
index 34104bd..0738f82 100644
--- a/components/tracing/core/trace_ring_buffer_unittest.cc
+++ b/components/tracing/core/trace_ring_buffer_unittest.cc
@@ -13,29 +13,27 @@ namespace {
 
 const size_t kChunkSize = TraceRingBuffer::Chunk::kSize;
 
+bool overlap(uint8_t* start1, uint8_t* end1, uint8_t* start2, uint8_t* end2) {
+  return start1 < end2 && start2 < end1;
+}
+
 TEST(TraceRingBufferTest, BasicChunkWrapping) {
   const uint32_t kNumChunks = 5;
   const size_t kBufferSize = kChunkSize * kNumChunks;
   std::unique_ptr<uint8_t[]> storage(new uint8_t[kBufferSize]);
   TraceRingBuffer ring_buffer(storage.get(), kBufferSize);
 
-  EXPECT_EQ(0u, ring_buffer.GetNumChunksTaken());
   uint8_t* last_chunk_end = nullptr;
-
   // Fill the buffer twice to test wrapping logic.
   for (uint32_t i = 0; i < kNumChunks * 2; ++i) {
-    TraceRingBuffer::Chunk* chunk = ring_buffer.TakeChunk(42 /* owner */);
+    TraceRingBuffer::Chunk* chunk = ring_buffer.TakeChunk();
     ASSERT_NE(nullptr, chunk);
-    EXPECT_EQ(1u, ring_buffer.GetNumChunksTaken());
-    EXPECT_EQ(42u, chunk->owner());
     const uint32_t chunk_idx = i % kNumChunks;
     EXPECT_EQ(chunk_idx == 0 ? storage.get() : last_chunk_end, chunk->begin());
     const uint32_t kPayloadSize = (chunk_idx + 1) * 8;
     memset(chunk->payload(), static_cast<int>(chunk_idx + 1), kPayloadSize);
     last_chunk_end = chunk->end();
-    chunk->set_used_size(kPayloadSize);
-    ring_buffer.ReturnChunk(chunk);
-    EXPECT_EQ(0u, ring_buffer.GetNumChunksTaken());
+    ring_buffer.ReturnChunk(chunk, /* used_size = */ kPayloadSize);
   }
 
   // Now scrape the |storage| buffer and check its contents.
@@ -54,31 +52,28 @@ TEST(TraceRingBufferTest, ChunkBankrupcyDoesNotCrash) {
   std::unique_ptr<uint8_t[]> storage(new uint8_t[kBufferSize]);
   TraceRingBuffer ring_buffer(storage.get(), kBufferSize);
 
-  TraceRingBuffer::Chunk* chunk1 = ring_buffer.TakeChunk(1);
+  TraceRingBuffer::Chunk* chunk1 = ring_buffer.TakeChunk();
   ASSERT_NE(nullptr, chunk1);
 
-  TraceRingBuffer::Chunk* chunk2 = ring_buffer.TakeChunk(1);
+  TraceRingBuffer::Chunk* chunk2 = ring_buffer.TakeChunk();
   ASSERT_NE(nullptr, chunk2);
 
-  EXPECT_EQ(2u, ring_buffer.GetNumChunksTaken());
-
   for (int i = 0; i < 3; ++i) {
-    TraceRingBuffer::Chunk* bankrupcy_chunk = ring_buffer.TakeChunk(1);
+    TraceRingBuffer::Chunk* bankrupcy_chunk = ring_buffer.TakeChunk();
     ASSERT_NE(nullptr, bankrupcy_chunk);
-    ASSERT_TRUE(ring_buffer.IsBankrupcyChunkForTesting(bankrupcy_chunk));
+    ASSERT_FALSE(overlap(bankrupcy_chunk->begin(), bankrupcy_chunk->end(),
+                         storage.get(), storage.get() + kBufferSize));
 
     // Make sure that the memory of the bankrupty chunk can be dereferenced.
     memset(bankrupcy_chunk->begin(), 0, kChunkSize);
   }
-  EXPECT_EQ(2u, ring_buffer.GetNumChunksTaken());
 
   // Return a chunk and check that the ring buffer is not bankrupt anymore.
-  chunk2->set_used_size(42);
-  ring_buffer.ReturnChunk(chunk2);
-  EXPECT_EQ(1u, ring_buffer.GetNumChunksTaken());
-  TraceRingBuffer::Chunk* chunk = ring_buffer.TakeChunk(1);
+  ring_buffer.ReturnChunk(chunk2, 42);
+  TraceRingBuffer::Chunk* chunk = ring_buffer.TakeChunk();
   ASSERT_NE(nullptr, chunk);
-  ASSERT_FALSE(ring_buffer.IsBankrupcyChunkForTesting(chunk));
+  ASSERT_TRUE(overlap(chunk->begin(), chunk->end(), storage.get(),
+                      storage.get() + kBufferSize));
 }
 
 }  // namespace
diff --git a/components/tracing/test/example_proto/test_messages.proto b/components/tracing/test/example_proto/test_messages.proto
index f6d5361..588ec84 100644
--- a/components/tracing/test/example_proto/test_messages.proto
+++ b/components/tracing/test/example_proto/test_messages.proto
@@ -73,16 +73,3 @@ message NestedA {
   repeated NestedB repeated_a = 2;
   optional NestedB.NestedC super_nested = 3;
 }
-
-message CamelCaseFields {
-  // To check that any reasonable name converts to camel case correctly.
-  optional bool foo_bar_baz = 1;
-  optional bool barBaz = 2;
-  optional bool MooMoo = 3;
-  optional bool URLEncoder = 4;
-  optional bool XMap = 5;
-  optional bool UrLE_nco__der = 6;
-  optional bool __bigBang = 7;
-  optional bool U2 = 8;
-  optional bool bangBig__ = 9;
-}
diff --git a/components/tracing/test/proto_zero_generation_unittest.cc b/components/tracing/test/proto_zero_generation_unittest.cc
index cc2be35..531cadb 100644
--- a/components/tracing/test/proto_zero_generation_unittest.cc
+++ b/components/tracing/test/proto_zero_generation_unittest.cc
@@ -8,24 +8,9 @@
 namespace tracing {
 namespace proto {
 
-using foo::bar::CamelCaseFields;
-
 TEST(ProtoZeroTest, Simple) {
   // TODO(kraynov) Put tests in the next CL (crbug.com/608721).
 }
 
-TEST(ProtoZeroTest, FieldNumbers) {
-  // Tests camel case conversion as well.
-  EXPECT_EQ(1, CamelCaseFields::kFooBarBazFieldNumber);
-  EXPECT_EQ(2, CamelCaseFields::kBarBazFieldNumber);
-  EXPECT_EQ(3, CamelCaseFields::kMooMooFieldNumber);
-  EXPECT_EQ(4, CamelCaseFields::kURLEncoderFieldNumber);
-  EXPECT_EQ(5, CamelCaseFields::kXMapFieldNumber);
-  EXPECT_EQ(6, CamelCaseFields::kUrLENcoDerFieldNumber);
-  EXPECT_EQ(7, CamelCaseFields::kBigBangFieldNumber);
-  EXPECT_EQ(8, CamelCaseFields::kU2FieldNumber);
-  EXPECT_EQ(9, CamelCaseFields::kBangBigFieldNumber);
-}
-
 }  // namespace proto
 }  // namespace tracing
diff --git a/components/tracing/tools/proto_zero_plugin/proto_zero_generator.cc b/components/tracing/tools/proto_zero_plugin/proto_zero_generator.cc
index 7182015..2165673 100644
--- a/components/tracing/tools/proto_zero_plugin/proto_zero_generator.cc
+++ b/components/tracing/tools/proto_zero_plugin/proto_zero_generator.cc
@@ -463,31 +463,7 @@ class GeneratorJob {
       }
     }
 
-    // Field numbers.
-    if (message->field_count() > 0) {
-      stub_h_->Print("enum : int32_t {\n");
-      stub_h_->Indent();
-
-      for (int i = 0; i < message->field_count(); ++i) {
-        const FieldDescriptor* field = message->field(i);
-        std::string name = field->camelcase_name();
-        if (!name.empty()) {
-          name.at(0) = toupper(name.at(0));
-        } else {
-          // Protoc allows fields like 'bool _ = 1'.
-          Abort("Empty field name in camel case notation.");
-        }
-
-        stub_h_->Print(
-            "k$name$FieldNumber = $id$,\n",
-            "name", name,
-            "id", std::to_string(field->number()));
-      }
-      stub_h_->Outdent();
-      stub_h_->Print("};\n");
-    }
-
-    // Field descriptors.
+    // Fields descriptors.
     for (int i = 0; i < message->field_count(); ++i) {
       const FieldDescriptor* field = message->field(i);
       if (field->is_packed()) {
diff --git a/components/webdata/common/web_data_service_base.h b/components/webdata/common/web_data_service_base.h
index 2783beb..adad9f1 100644
--- a/components/webdata/common/web_data_service_base.h
+++ b/components/webdata/common/web_data_service_base.h
@@ -36,8 +36,7 @@ class WEBDATA_EXPORT WebDataServiceBase
   // takes a single parameter, the sql::InitStatus value from trying
   // to open the database.
   // TODO(joi): Should we combine this with WebDatabaseService::InitCallback?
-  typedef base::Callback<void(sql::InitStatus, const std::string&)>
-      ProfileErrorCallback;
+  typedef base::Callback<void(sql::InitStatus)> ProfileErrorCallback;
 
   typedef base::Closure DBLoadedCallback;
 
diff --git a/components/webdata/common/web_database.cc b/components/webdata/common/web_database.cc
index c731270..a24a4b8 100644
--- a/components/webdata/common/web_database.cc
+++ b/components/webdata/common/web_database.cc
@@ -65,11 +65,6 @@ void WebDatabase::CommitTransaction() {
   db_.CommitTransaction();
 }
 
-std::string WebDatabase::GetDiagnosticInfo(int extended_error,
-                                           sql::Statement* statement) {
-  return db_.GetDiagnosticInfo(extended_error, statement);
-}
-
 sql::Connection* WebDatabase::GetSQLConnection() {
   return &db_;
 }
diff --git a/components/webdata/common/web_database.h b/components/webdata/common/web_database.h
index 79931be..bd914f4 100644
--- a/components/webdata/common/web_database.h
+++ b/components/webdata/common/web_database.h
@@ -41,13 +41,6 @@ class WEBDATA_EXPORT WebDatabase {
   // Retrieves a table based on its |key|.
   WebDatabaseTable* GetTable(WebDatabaseTable::TypeKey key);
 
-  // Call before Init() to set the error callback to be used for the
-  // underlying database connection.
-  void set_error_callback(
-      const sql::Connection::ErrorCallback& error_callback) {
-    db_.set_error_callback(error_callback);
-  }
-
   // Initialize the database given a name. The name defines where the SQLite
   // file is. If this returns an error code, no other method should be called.
   //
@@ -60,8 +53,6 @@ class WEBDATA_EXPORT WebDatabase {
   void BeginTransaction();
   void CommitTransaction();
 
-  std::string GetDiagnosticInfo(int extended_error, sql::Statement* statement);
-
   // Exposed for testing only.
   sql::Connection* GetSQLConnection();
 
diff --git a/components/webdata/common/web_database_backend.cc b/components/webdata/common/web_database_backend.cc
index 1408bd2..7cb343e 100644
--- a/components/webdata/common/web_database_backend.cc
+++ b/components/webdata/common/web_database_backend.cc
@@ -4,7 +4,6 @@
 
 #include "components/webdata/common/web_database_backend.h"
 
-#include <algorithm>
 #include <utility>
 
 #include "base/bind.h"
@@ -12,7 +11,6 @@
 #include "components/webdata/common/web_data_request_manager.h"
 #include "components/webdata/common/web_database.h"
 #include "components/webdata/common/web_database_table.h"
-#include "sql/error_delegate_util.h"
 
 using base::Bind;
 using base::FilePath;
@@ -26,8 +24,8 @@ WebDatabaseBackend::WebDatabaseBackend(
       request_manager_(new WebDataRequestManager()),
       init_status_(sql::INIT_FAILURE),
       init_complete_(false),
-      catastrophic_error_occurred_(false),
-      delegate_(delegate) {}
+      delegate_(delegate) {
+}
 
 void WebDatabaseBackend::AddTable(std::unique_ptr<WebDatabaseTable> table) {
   DCHECK(!db_.get());
@@ -37,7 +35,7 @@ void WebDatabaseBackend::AddTable(std::unique_ptr<WebDatabaseTable> table) {
 void WebDatabaseBackend::InitDatabase() {
   LoadDatabaseIfNecessary();
   if (delegate_) {
-    delegate_->DBLoaded(init_status_, diagnostics_);
+    delegate_->DBLoaded(init_status_);
   }
 }
 
@@ -48,18 +46,15 @@ sql::InitStatus WebDatabaseBackend::LoadDatabaseIfNecessary() {
   init_complete_ = true;
   db_.reset(new WebDatabase());
 
-  for (const auto& table : tables_)
-    db_->AddTable(table);
+  for (ScopedVector<WebDatabaseTable>::iterator it = tables_.begin();
+       it != tables_.end(); ++it) {
+    db_->AddTable(*it);
+  }
 
-  // Unretained to avoid a ref loop since we own |db_|.
-  db_->set_error_callback(base::Bind(&WebDatabaseBackend::DatabaseErrorCallback,
-                                     base::Unretained(this)));
-  diagnostics_.clear();
   init_status_ = db_->Init(db_path_);
   if (init_status_ != sql::INIT_OK) {
     LOG(ERROR) << "Cannot initialize the web database: " << init_status_;
-    diagnostics_ += sql::GetCorruptFileDiagnosticsInfo(db_path_);
-    db_.reset();
+    db_.reset(NULL);
     return init_status_;
   }
 
@@ -118,15 +113,6 @@ WebDatabaseBackend::~WebDatabaseBackend() {
   ShutdownDatabase();
 }
 
-void WebDatabaseBackend::DatabaseErrorCallback(int error,
-                                               sql::Statement* statement) {
-  // We ignore any further error callbacks after the first catastrophic error.
-  if (!catastrophic_error_occurred_ && sql::IsErrorCatastrophic(error)) {
-    catastrophic_error_occurred_ = true;
-    diagnostics_ = db_->GetDiagnosticInfo(error, statement);
-  }
-}
-
 void WebDatabaseBackend::Commit() {
   DCHECK(db_);
   DCHECK_EQ(sql::INIT_OK, init_status_);
diff --git a/components/webdata/common/web_database_backend.h b/components/webdata/common/web_database_backend.h
index a3ae1fc..341bb76 100644
--- a/components/webdata/common/web_database_backend.h
+++ b/components/webdata/common/web_database_backend.h
@@ -39,11 +39,7 @@ class WEBDATA_EXPORT WebDatabaseBackend
     virtual ~Delegate() {}
 
     // Invoked when the backend has finished loading the db.
-    // |status| is the result of initializing the db.
-    // |diagnostics| contains diagnostic information about the db, and it will
-    // only be populated when an error occurs.
-    virtual void DBLoaded(sql::InitStatus status,
-                          const std::string& diagnostics) = 0;
+    virtual void DBLoaded(sql::InitStatus status) = 0;
   };
 
   WebDatabaseBackend(
@@ -94,9 +90,6 @@ class WEBDATA_EXPORT WebDatabaseBackend
   virtual ~WebDatabaseBackend();
 
  private:
-  // Invoked on a db error.
-  void DatabaseErrorCallback(int error, sql::Statement* statement);
-
   // Commit the current transaction.
   void Commit();
 
@@ -126,14 +119,6 @@ class WEBDATA_EXPORT WebDatabaseBackend
   // fails), used to avoid continually trying to reinit if the db init fails.
   bool init_complete_;
 
-  // True if a catastrophic database error occurs and further error callbacks
-  // from the database should be ignored.
-  bool catastrophic_error_occurred_;
-
-  // If a catastrophic database error has occurred, this contains any available
-  // diagnostic information.
-  std::string diagnostics_;
-
   // Delegate. See the class definition above for more information.
   std::unique_ptr<Delegate> delegate_;
 
diff --git a/components/webdata/common/web_database_service.cc b/components/webdata/common/web_database_service.cc
index a5ed863..3ecd6f3 100644
--- a/components/webdata/common/web_database_service.cc
+++ b/components/webdata/common/web_database_service.cc
@@ -27,11 +27,12 @@ class WebDatabaseService::BackendDelegate
       : web_database_service_(web_database_service),
         callback_thread_(base::ThreadTaskRunnerHandle::Get()) {}
 
-  void DBLoaded(sql::InitStatus status,
-                const std::string& diagnostics) override {
+  void DBLoaded(sql::InitStatus status) override {
     callback_thread_->PostTask(
-        FROM_HERE, base::Bind(&WebDatabaseService::OnDatabaseLoadDone,
-                              web_database_service_, status, diagnostics));
+        FROM_HERE,
+        base::Bind(&WebDatabaseService::OnDatabaseLoadDone,
+                   web_database_service_,
+                   status));
   }
  private:
   const base::WeakPtr<WebDatabaseService> web_database_service_;
@@ -132,22 +133,21 @@ void WebDatabaseService::RegisterDBErrorCallback(
   error_callbacks_.push_back(callback);
 }
 
-void WebDatabaseService::OnDatabaseLoadDone(sql::InitStatus status,
-                                            const std::string& diagnostics) {
+void WebDatabaseService::OnDatabaseLoadDone(sql::InitStatus status) {
   if (status == sql::INIT_OK) {
     db_loaded_ = true;
 
-    for (const auto& loaded_callback : loaded_callbacks_) {
-      if (!loaded_callback.is_null())
-        loaded_callback.Run();
+    for (size_t i = 0; i < loaded_callbacks_.size(); i++) {
+      if (!loaded_callbacks_[i].is_null())
+        loaded_callbacks_[i].Run();
     }
 
     loaded_callbacks_.clear();
   } else {
     // Notify that the database load failed.
-    for (const auto& error_callback : error_callbacks_) {
-      if (!error_callback.is_null())
-        error_callback.Run(status, diagnostics);
+    for (size_t i = 0; i < error_callbacks_.size(); i++) {
+      if (!error_callbacks_[i].is_null())
+        error_callbacks_[i].Run(status);
     }
 
     error_callbacks_.clear();
diff --git a/components/webdata/common/web_database_service.h b/components/webdata/common/web_database_service.h
index e0d3f59..2c68a3b 100644
--- a/components/webdata/common/web_database_service.h
+++ b/components/webdata/common/web_database_service.h
@@ -50,13 +50,12 @@ class WebDataServiceConsumer;
 class WEBDATA_EXPORT WebDatabaseService
     : public base::RefCountedDeleteOnMessageLoop<WebDatabaseService> {
  public:
-  using ReadTask = base::Callback<std::unique_ptr<WDTypedResult>(WebDatabase*)>;
-  using WriteTask = base::Callback<WebDatabase::State(WebDatabase*)>;
+  typedef base::Callback<std::unique_ptr<WDTypedResult>(WebDatabase*)> ReadTask;
+  typedef base::Callback<WebDatabase::State(WebDatabase*)> WriteTask;
 
   // Types for managing DB loading callbacks.
-  using DBLoadedCallback = base::Closure;
-  using DBLoadErrorCallback =
-      base::Callback<void(sql::InitStatus, const std::string&)>;
+  typedef base::Closure DBLoadedCallback;
+  typedef base::Callback<void(sql::InitStatus)> DBLoadErrorCallback;
 
   // Takes the path to the WebDatabase file.
   // WebDatabaseService lives on |ui_thread| and posts tasks to |db_thread|.
@@ -125,8 +124,7 @@ class WEBDATA_EXPORT WebDatabaseService
 
   virtual ~WebDatabaseService();
 
-  void OnDatabaseLoadDone(sql::InitStatus status,
-                          const std::string& diagnostics);
+  void OnDatabaseLoadDone(sql::InitStatus status);
 
   base::FilePath path_;
 
diff --git a/components/webdata_services/web_data_service_wrapper.h b/components/webdata_services/web_data_service_wrapper.h
index 3da8cd9..a9aa97f 100644
--- a/components/webdata_services/web_data_service_wrapper.h
+++ b/components/webdata_services/web_data_service_wrapper.h
@@ -46,14 +46,7 @@ class WebDataServiceWrapper : public KeyedService {
   };
 
   // Shows an error message if a loading error occurs.
-  // |error_type| shows which service encountered an error while loading.
-  // |init_status| is the returned status of initializing the underlying
-  // database.
-  // |diagnostics| contains information about the underlying database
-  // which can help in identifying the cause of the error.
-  using ShowErrorCallback = void (*)(ErrorType error_type,
-                                     sql::InitStatus init_status,
-                                     const std::string& diagnostics);
+  using ShowErrorCallback = void (*)(ErrorType, sql::InitStatus);
 
   // Constructor for WebDataServiceWrapper that initializes the different
   // WebDataServices and starts the synchronization services using |flare|.
diff --git a/content/browser/android/content_video_view.cc b/content/browser/android/content_video_view.cc
index e1ff446..86f6755 100644
--- a/content/browser/android/content_video_view.cc
+++ b/content/browser/android/content_video_view.cc
@@ -48,12 +48,10 @@ ContentVideoView* ContentVideoView::GetInstance() {
 }
 
 ContentVideoView::ContentVideoView(Client* client,
-                                   ContentViewCore* content_view_core,
-                                   const gfx::Size& video_natural_size)
+                                   ContentViewCore* content_view_core)
     : client_(client), weak_factory_(this) {
   DCHECK(!g_content_video_view);
-  j_content_video_view_ =
-      CreateJavaObject(content_view_core, video_natural_size);
+  j_content_video_view_ = CreateJavaObject(content_view_core);
   g_content_video_view = this;
 }
 
@@ -161,8 +159,7 @@ void ContentVideoView::RecordExitFullscreenPlayback(
 }
 
 JavaObjectWeakGlobalRef ContentVideoView::CreateJavaObject(
-    ContentViewCore* content_view_core,
-    const gfx::Size& video_natural_size) {
+    ContentViewCore* content_view_core) {
   JNIEnv* env = AttachCurrentThread();
   base::android::ScopedJavaLocalRef<jobject> j_content_view_core =
       content_view_core->GetJavaObject();
@@ -170,9 +167,10 @@ JavaObjectWeakGlobalRef ContentVideoView::CreateJavaObject(
     return JavaObjectWeakGlobalRef(env, nullptr);
 
   return JavaObjectWeakGlobalRef(
-      env, Java_ContentVideoView_createContentVideoView(
-               env, j_content_view_core.obj(), reinterpret_cast<intptr_t>(this),
-               video_natural_size.width(), video_natural_size.height())
-               .obj());
+      env,
+      Java_ContentVideoView_createContentVideoView(
+          env,
+          j_content_view_core.obj(),
+          reinterpret_cast<intptr_t>(this)).obj());
 }
 }  // namespace content
diff --git a/content/browser/android/content_video_view.h b/content/browser/android/content_video_view.h
index 7efe330..f54a29f 100644
--- a/content/browser/android/content_video_view.h
+++ b/content/browser/android/content_video_view.h
@@ -44,9 +44,7 @@ class ContentVideoView {
     DISALLOW_COPY_AND_ASSIGN(Client);
   };
 
-  explicit ContentVideoView(Client* client,
-                            ContentViewCore* content_view_core,
-                            const gfx::Size& video_natural_size);
+  explicit ContentVideoView(Client* client, ContentViewCore* content_view_core);
   ~ContentVideoView();
 
   // To open another video on existing ContentVideoView.
@@ -55,7 +53,7 @@ class ContentVideoView {
   // Display an error dialog to the user.
   void OnMediaPlayerError(int error_type);
 
-  // Update the video size.
+  // Update the video size. The video will not be visible until this is called.
   void OnVideoSizeChanged(int width, int height);
 
   // Exit fullscreen and notify |client_| with |DidExitFullscreen|.
@@ -90,8 +88,7 @@ class ContentVideoView {
 
  private:
   // Creates the corresponding ContentVideoView Java object.
-  JavaObjectWeakGlobalRef CreateJavaObject(ContentViewCore* content_view_core,
-                                           const gfx::Size& video_natural_size);
+  JavaObjectWeakGlobalRef CreateJavaObject(ContentViewCore* content_view_core);
 
   Client* client_;
 
diff --git a/content/browser/bad_message.cc b/content/browser/bad_message.cc
index 183b46e..9e2910f 100644
--- a/content/browser/bad_message.cc
+++ b/content/browser/bad_message.cc
@@ -4,13 +4,11 @@
 
 #include "content/browser/bad_message.h"
 
-#include "base/bind.h"
 #include "base/debug/crash_logging.h"
 #include "base/logging.h"
 #include "base/metrics/sparse_histogram.h"
 #include "base/strings/string_number_conversions.h"
 #include "content/public/browser/browser_message_filter.h"
-#include "content/public/browser/browser_thread.h"
 #include "content/public/browser/render_process_host.h"
 
 namespace content {
@@ -25,14 +23,6 @@ void LogBadMessage(BadMessageReason reason) {
                                 base::IntToString(reason));
 }
 
-void ReceivedBadMessageOnUIThread(int render_process_id,
-                                  BadMessageReason reason) {
-  DCHECK(BrowserThread::CurrentlyOn(BrowserThread::UI));
-  RenderProcessHost* host = RenderProcessHost::FromID(render_process_id);
-  if (host)
-    ReceivedBadMessage(host, reason);
-}
-
 }  // namespace
 
 void ReceivedBadMessage(RenderProcessHost* host, BadMessageReason reason) {
@@ -40,17 +30,6 @@ void ReceivedBadMessage(RenderProcessHost* host, BadMessageReason reason) {
   host->ShutdownForBadMessage();
 }
 
-void ReceivedBadMessage(int render_process_id, BadMessageReason reason) {
-  if (!BrowserThread::CurrentlyOn(BrowserThread::UI)) {
-    BrowserThread::PostTask(
-        BrowserThread::UI,
-        FROM_HERE,
-        base::Bind(&ReceivedBadMessageOnUIThread, render_process_id, reason));
-    return;
-  }
-  ReceivedBadMessageOnUIThread(render_process_id, reason);
-}
-
 void ReceivedBadMessage(BrowserMessageFilter* filter, BadMessageReason reason) {
   LogBadMessage(reason);
   filter->ShutdownForBadMessage();
diff --git a/content/browser/bad_message.h b/content/browser/bad_message.h
index 35d8279..c35dfa1 100644
--- a/content/browser/bad_message.h
+++ b/content/browser/bad_message.h
@@ -132,8 +132,8 @@ enum BadMessageReason {
   RDHI_WRONG_STORAGE_PARTITION = 107,
   RDH_INVALID_REQUEST_ID = 108,
   BDH_SERVICE_NOT_ALLOWED_FOR_ORIGIN = 109,
-  WSI_UNEXPECTED_ADD_CHANNEL_REQUEST = 110,
-  WSI_UNEXPECTED_SEND_FRAME = 111,
+  WSH_SEND_BLOB_DURING_BLOB_SEND = 110,
+  WSH_SEND_FRAME_DURING_BLOB_SEND = 111,
   RFH_UNEXPECTED_LOAD_START = 112,
   NMF_INVALID_ARGUMENT = 113,
   RFH_INVALID_ORIGIN_ON_COMMIT = 114,
@@ -149,7 +149,7 @@ enum BadMessageReason {
   DBMF_INVALID_ORIGIN_ON_GET_SPACE = 124,
   DBMF_INVALID_ORIGIN_ON_MODIFIED = 125,
   DBMF_INVALID_ORIGIN_ON_CLOSED = 126,
-  WSI_INVALID_HEADER_VALUE = 127,
+  WSH_INVALID_HEADER_VALUE = 127,
   SWDH_SET_HOSTED_VERSION_INVALID_HOST = 128,
   SWDH_SET_HOSTED_VERSION_PROCESS_MISMATCH = 129,
   MSDH_INVALID_FRAME_ID = 130,
@@ -169,9 +169,6 @@ enum BadMessageReason {
 // and terminates the process for |host|.
 void ReceivedBadMessage(RenderProcessHost* host, BadMessageReason reason);
 
-// Equivalent to the above, but callable from any thread.
-void ReceivedBadMessage(int render_process_id, BadMessageReason reason);
-
 // Called when a browser message filter receives a bad IPC message from a
 // renderer or other child process. Logs the event, records a histogram metric
 // for the |reason|, and terminates the process for |filter|.
diff --git a/content/browser/browser_main_loop.cc b/content/browser/browser_main_loop.cc
index 78afa47..d7a1f39 100644
--- a/content/browser/browser_main_loop.cc
+++ b/content/browser/browser_main_loop.cc
@@ -1292,7 +1292,6 @@ int BrowserMainLoop::BrowserThreadsStarted() {
     TRACE_EVENT0("startup",
       "BrowserMainLoop::BrowserThreadsStarted:InitResourceDispatcherHost");
     resource_dispatcher_host_.reset(new ResourceDispatcherHostImpl());
-    GetContentClient()->browser()->ResourceDispatcherHostCreated();
 
     loader_delegate_.reset(new LoaderDelegateImpl());
     resource_dispatcher_host_->SetLoaderDelegate(loader_delegate_.get());
diff --git a/content/browser/devtools/render_frame_devtools_agent_host.cc b/content/browser/devtools/render_frame_devtools_agent_host.cc
index c3353de..b3391d9 100644
--- a/content/browser/devtools/render_frame_devtools_agent_host.cc
+++ b/content/browser/devtools/render_frame_devtools_agent_host.cc
@@ -521,7 +521,19 @@ void RenderFrameDevToolsAgentHost::OnClientAttached() {
     return;
 
   frame_trace_recorder_.reset(new DevToolsFrameTraceRecorder());
-  CreatePowerSaveBlocker();
+#if defined(OS_ANDROID)
+  power_save_blocker_.reset(new device::PowerSaveBlocker(
+      device::PowerSaveBlocker::kPowerSaveBlockPreventDisplaySleep,
+      device::PowerSaveBlocker::kReasonOther, "DevTools",
+      BrowserThread::GetTaskRunnerForThread(BrowserThread::UI),
+      BrowserThread::GetTaskRunnerForThread(BrowserThread::FILE)));
+  if (web_contents()->GetNativeView()) {
+    view_weak_factory_.reset(new base::WeakPtrFactory<ui::ViewAndroid>(
+        web_contents()->GetNativeView()));
+    power_save_blocker_->InitDisplaySleepBlocker(
+        view_weak_factory_->GetWeakPtr());
+  }
+#endif
 
   // TODO(kaznacheev): Move this call back to DevToolsManager when
   // extensions::ProcessManager no longer relies on this notification.
@@ -674,22 +686,6 @@ void RenderFrameDevToolsAgentHost::DestroyOnRenderFrameGone() {
   Release();
 }
 
-void RenderFrameDevToolsAgentHost::CreatePowerSaveBlocker() {
-#if defined(OS_ANDROID)
-  power_save_blocker_.reset(new device::PowerSaveBlocker(
-      device::PowerSaveBlocker::kPowerSaveBlockPreventDisplaySleep,
-      device::PowerSaveBlocker::kReasonOther, "DevTools",
-      BrowserThread::GetTaskRunnerForThread(BrowserThread::UI),
-      BrowserThread::GetTaskRunnerForThread(BrowserThread::FILE)));
-  if (web_contents()->GetNativeView()) {
-    view_weak_factory_.reset(new base::WeakPtrFactory<ui::ViewAndroid>(
-        web_contents()->GetNativeView()));
-    power_save_blocker_->InitDisplaySleepBlocker(
-        view_weak_factory_->GetWeakPtr());
-  }
-#endif
-}
-
 void RenderFrameDevToolsAgentHost::RenderProcessGone(
     base::TerminationStatus status) {
   switch(status) {
@@ -789,16 +785,6 @@ void RenderFrameDevToolsAgentHost::WebContentsDestroyed() {
 #endif
 }
 
-void RenderFrameDevToolsAgentHost::WasShown() {
-  CreatePowerSaveBlocker();
-}
-
-void RenderFrameDevToolsAgentHost::WasHidden() {
-#if defined(OS_ANDROID)
-  power_save_blocker_.reset();
-#endif
-}
-
 void RenderFrameDevToolsAgentHost::
     DispatchBufferedProtocolMessagesIfNecessary() {
   if (navigating_handles_.empty() &&
diff --git a/content/browser/devtools/render_frame_devtools_agent_host.h b/content/browser/devtools/render_frame_devtools_agent_host.h
index 6565fe1..a3c3158 100644
--- a/content/browser/devtools/render_frame_devtools_agent_host.h
+++ b/content/browser/devtools/render_frame_devtools_agent_host.h
@@ -127,8 +127,6 @@ class CONTENT_EXPORT RenderFrameDevToolsAgentHost
       const base::string16& error_description,
       bool was_ignored_by_handler) override;
   void WebContentsDestroyed() override;
-  void WasShown() override;
-  void WasHidden() override;
 
   void AboutToNavigateRenderFrame(RenderFrameHost* old_host,
                                   RenderFrameHost* new_host);
@@ -154,8 +152,6 @@ class CONTENT_EXPORT RenderFrameDevToolsAgentHost
   void OnRequestNewWindow(RenderFrameHost* sender, int new_routing_id);
   void DestroyOnRenderFrameGone();
 
-  void CreatePowerSaveBlocker();
-
   class FrameHostHolder;
 
   std::unique_ptr<FrameHostHolder> current_;
diff --git a/content/browser/frame_host/render_frame_host_impl.cc b/content/browser/frame_host/render_frame_host_impl.cc
index ec402d5..1a55641 100644
--- a/content/browser/frame_host/render_frame_host_impl.cc
+++ b/content/browser/frame_host/render_frame_host_impl.cc
@@ -49,7 +49,6 @@
 #include "content/browser/renderer_host/render_widget_host_impl.h"
 #include "content/browser/renderer_host/render_widget_host_view_base.h"
 #include "content/browser/wake_lock/wake_lock_service_context.h"
-#include "content/browser/websockets/websocket_manager.h"
 #include "content/browser/webui/web_ui_controller_factory_registry.h"
 #include "content/common/accessibility_messages.h"
 #include "content/common/frame_messages.h"
@@ -2124,14 +2123,6 @@ void RenderFrameHostImpl::RegisterMojoInterfaces() {
 
   GetInterfaceRegistry()->AddInterface<media::mojom::ServiceFactory>(this);
 
-  // This is to support usage of WebSockets in cases in which there is an
-  // associated RenderFrame. This is important for showing the correct security
-  // state of the page and also honoring user override of bad certificates.
-  GetInterfaceRegistry()->AddInterface(
-      base::Bind(&WebSocketManager::CreateWebSocket,
-                 process_->GetID(),
-                 routing_id_));
-
 #if defined(ENABLE_WEBVR)
   const base::CommandLine& browser_command_line =
       *base::CommandLine::ForCurrentProcess();
diff --git a/content/browser/gpu/gpu_data_manager_impl.cc b/content/browser/gpu/gpu_data_manager_impl.cc
index 3a642b6..0a820a4 100644
--- a/content/browser/gpu/gpu_data_manager_impl.cc
+++ b/content/browser/gpu/gpu_data_manager_impl.cc
@@ -134,11 +134,6 @@ void GpuDataManagerImpl::GetDisabledExtensions(
   private_->GetDisabledExtensions(disabled_extensions);
 }
 
-void GpuDataManagerImpl::SetGpuInfo(const gpu::GPUInfo& gpu_info) {
-  base::AutoLock auto_lock(lock_);
-  private_->SetGpuInfo(gpu_info);
-}
-
 void GpuDataManagerImpl::Initialize() {
   base::AutoLock auto_lock(lock_);
   private_->Initialize();
diff --git a/content/browser/gpu/gpu_data_manager_impl.h b/content/browser/gpu/gpu_data_manager_impl.h
index 2bb7115..b5192d0 100644
--- a/content/browser/gpu/gpu_data_manager_impl.h
+++ b/content/browser/gpu/gpu_data_manager_impl.h
@@ -96,7 +96,6 @@ class CONTENT_EXPORT GpuDataManagerImpl
   void DisableHardwareAcceleration() override;
   bool CanUseGpuBrowserCompositor() const override;
   void GetDisabledExtensions(std::string* disabled_extensions) const override;
-  void SetGpuInfo(const gpu::GPUInfo& gpu_info) override;
 
   // This collects preliminary GPU info, load GpuBlacklist, and compute the
   // preliminary blacklisted features; it should only be called at browser
diff --git a/content/browser/gpu/gpu_data_manager_impl_private.cc b/content/browser/gpu/gpu_data_manager_impl_private.cc
index 613294c..7f3ef1a 100644
--- a/content/browser/gpu/gpu_data_manager_impl_private.cc
+++ b/content/browser/gpu/gpu_data_manager_impl_private.cc
@@ -536,14 +536,9 @@ void GpuDataManagerImplPrivate::Initialize() {
     // So mark it as collected.
     gpu_info.basic_info_state = gpu::kCollectInfoSuccess;
   } else {
-    // Skip collecting the basic driver info if SetGpuInfo() is already called.
-    if (IsCompleteGpuInfoAvailable()) {
-      gpu_info = gpu_info_;
-    } else {
-      TRACE_EVENT0("startup",
-                   "GpuDataManagerImpl::Initialize:CollectBasicGraphicsInfo");
-      gpu::CollectBasicGraphicsInfo(&gpu_info);
-    }
+    TRACE_EVENT0("startup",
+      "GpuDataManagerImpl::Initialize:CollectBasicGraphicsInfo");
+    gpu::CollectBasicGraphicsInfo(&gpu_info);
 
     if (command_line->HasSwitch(switches::kGpuTestingVendorId) &&
         command_line->HasSwitch(switches::kGpuTestingDeviceId)) {
@@ -861,12 +856,6 @@ void GpuDataManagerImplPrivate::DisableHardwareAcceleration() {
   NotifyGpuInfoUpdate();
 }
 
-void GpuDataManagerImplPrivate::SetGpuInfo(const gpu::GPUInfo& gpu_info) {
-  DCHECK(!is_initialized_);
-  gpu_info_ = gpu_info;
-  DCHECK(IsCompleteGpuInfoAvailable());
-}
-
 std::string GpuDataManagerImplPrivate::GetBlacklistVersion() const {
   if (gpu_blacklist_)
     return gpu_blacklist_->version();
diff --git a/content/browser/gpu/gpu_data_manager_impl_private.h b/content/browser/gpu/gpu_data_manager_impl_private.h
index c6e051d..420d6ba 100644
--- a/content/browser/gpu/gpu_data_manager_impl_private.h
+++ b/content/browser/gpu/gpu_data_manager_impl_private.h
@@ -65,7 +65,6 @@ class CONTENT_EXPORT GpuDataManagerImplPrivate {
                     std::string* gl_renderer,
                     std::string* gl_version);
   void DisableHardwareAcceleration();
-  void SetGpuInfo(const gpu::GPUInfo& gpu_info);
 
   void Initialize();
 
diff --git a/content/browser/loader/resource_dispatcher_host_impl.cc b/content/browser/loader/resource_dispatcher_host_impl.cc
index d0bc8a6..981c71b 100644
--- a/content/browser/loader/resource_dispatcher_host_impl.cc
+++ b/content/browser/loader/resource_dispatcher_host_impl.cc
@@ -517,6 +517,8 @@ ResourceDispatcherHostImpl::ResourceDispatcherHostImpl()
   DCHECK(!g_resource_dispatcher_host);
   g_resource_dispatcher_host = this;
 
+  GetContentClient()->browser()->ResourceDispatcherHostCreated();
+
   ANNOTATE_BENIGN_RACE(
       &last_user_gesture_time_,
       "We don't care about the precise value, see http://crbug.com/92889");
diff --git a/content/browser/media/android/browser_media_player_manager.cc b/content/browser/media/android/browser_media_player_manager.cc
index 4d6a10c..b4c9ab0 100644
--- a/content/browser/media/android/browser_media_player_manager.cc
+++ b/content/browser/media/android/browser_media_player_manager.cc
@@ -565,17 +565,7 @@ void BrowserMediaPlayerManager::OnEnterFullscreen(int player_id) {
   }
 
   // There's no ContentVideoView instance so create one.
-  // If we know the video frame size, use it.
-  gfx::Size natural_video_size;
-  MediaPlayerAndroid* player = GetFullscreenPlayer();
-  if (player && player->IsPlayerReady()) {
-    natural_video_size =
-        gfx::Size(player->GetVideoWidth(), player->GetVideoHeight());
-  }
-
-  video_view_.reset(
-      new ContentVideoView(this, GetContentViewCore(), natural_video_size));
-
+  video_view_.reset(new ContentVideoView(this, GetContentViewCore()));
   base::android::ScopedJavaLocalRef<jobject> j_content_video_view =
       video_view_->GetJavaObject(base::android::AttachCurrentThread());
   if (!j_content_video_view.is_null()) {
diff --git a/content/browser/media/android/browser_surface_view_manager.cc b/content/browser/media/android/browser_surface_view_manager.cc
index 104db83..6263e28 100644
--- a/content/browser/media/android/browser_surface_view_manager.cc
+++ b/content/browser/media/android/browser_surface_view_manager.cc
@@ -83,8 +83,8 @@ void BrowserSurfaceViewManager::OnCreateFullscreenSurface(
 
   ContentViewCore* cvc = ContentViewCore::FromWebContents(
       WebContents::FromRenderFrameHost(render_frame_host_));
-  content_video_view_.reset(
-      new ContentVideoView(this, cvc, video_natural_size));
+  content_video_view_.reset(new ContentVideoView(this, cvc));
+  OnNaturalSizeChanged(video_natural_size);
 }
 
 void BrowserSurfaceViewManager::OnNaturalSizeChanged(const gfx::Size& size) {
diff --git a/content/browser/renderer_host/input/synthetic_mouse_pointer.cc b/content/browser/renderer_host/input/synthetic_mouse_pointer.cc
index 2dd8cbb..556d1fe 100644
--- a/content/browser/renderer_host/input/synthetic_mouse_pointer.cc
+++ b/content/browser/renderer_host/input/synthetic_mouse_pointer.cc
@@ -33,12 +33,9 @@ void SyntheticMousePointer::Move(int index,
                                  float y,
                                  SyntheticGestureTarget* target,
                                  const base::TimeTicks& timestamp) {
-  blink::WebMouseEvent::Button button = mouse_event_.button;
-  int click_count = mouse_event_.clickCount;
   mouse_event_ = SyntheticWebMouseEventBuilder::Build(
       blink::WebInputEvent::MouseMove, x, y, 0);
-  mouse_event_.button = button;
-  mouse_event_.clickCount = click_count;
+  mouse_event_.button = blink::WebMouseEvent::ButtonLeft;
 }
 
 void SyntheticMousePointer::Release(int index,
diff --git a/content/browser/renderer_host/input/synthetic_pointer_action.cc b/content/browser/renderer_host/input/synthetic_pointer_action.cc
index a701ce5..76eb443 100644
--- a/content/browser/renderer_host/input/synthetic_pointer_action.cc
+++ b/content/browser/renderer_host/input/synthetic_pointer_action.cc
@@ -77,15 +77,10 @@ bool SyntheticPointerAction::UserInputCheck(
     return false;
   }
 
-  if (synthetic_pointer_->SourceType() == SyntheticGestureParams::TOUCH_INPUT &&
-      params.pointer_action_type() ==
-          SyntheticPointerActionParams::PointerActionType::MOVE &&
-      GetPointIndex(params.index()) < 0) {
-    return false;
-  }
-
-  if (params.pointer_action_type() ==
-          SyntheticPointerActionParams::PointerActionType::RELEASE &&
+  if ((params.pointer_action_type() ==
+           SyntheticPointerActionParams::PointerActionType::MOVE ||
+       params.pointer_action_type() ==
+           SyntheticPointerActionParams::PointerActionType::RELEASE) &&
       GetPointIndex(params.index()) < 0) {
     return false;
   }
diff --git a/content/browser/renderer_host/input/synthetic_pointer_action_unittest.cc b/content/browser/renderer_host/input/synthetic_pointer_action_unittest.cc
index 98145ef..9bee51c 100644
--- a/content/browser/renderer_host/input/synthetic_pointer_action_unittest.cc
+++ b/content/browser/renderer_host/input/synthetic_pointer_action_unittest.cc
@@ -15,7 +15,6 @@
 
 using blink::WebInputEvent;
 using blink::WebTouchEvent;
-using blink::WebMouseEvent;
 using blink::WebTouchPoint;
 
 namespace content {
@@ -86,39 +85,12 @@ class MockSyntheticPointerTouchActionTarget
   WebTouchPoint::State states_[WebTouchEvent::kTouchesLengthCap];
 };
 
-class MockSyntheticPointerMouseActionTarget
-    : public MockSyntheticPointerActionTarget {
- public:
-  MockSyntheticPointerMouseActionTarget() {}
-  ~MockSyntheticPointerMouseActionTarget() override {}
-
-  void DispatchInputEventToPlatform(const WebInputEvent& event) override {
-    ASSERT_TRUE(WebInputEvent::isMouseEventType(event.type));
-    const WebMouseEvent& mouse_event = static_cast<const WebMouseEvent&>(event);
-    type_ = mouse_event.type;
-    position_ = gfx::PointF(mouse_event.x, mouse_event.y);
-    clickCount_ = mouse_event.clickCount;
-    button_ = mouse_event.button;
-  }
-
-  SyntheticGestureParams::GestureSourceType
-  GetDefaultSyntheticGestureSourceType() const override {
-    return SyntheticGestureParams::MOUSE_INPUT;
-  }
-
-  gfx::PointF position() const { return position_; }
-  int clickCount() const { return clickCount_; }
-  WebMouseEvent::Button button() const { return button_; }
-
- private:
-  gfx::PointF position_;
-  int clickCount_;
-  WebMouseEvent::Button button_;
-};
-
 class SyntheticPointerActionTest : public testing::Test {
  public:
   SyntheticPointerActionTest() {
+    target_.reset(new MockSyntheticPointerTouchActionTarget());
+    synthetic_pointer_ =
+        SyntheticPointer::Create(SyntheticGestureParams::TOUCH_INPUT);
     action_param_list_.reset(new std::vector<SyntheticPointerActionParams>());
     std::fill(index_map_.begin(), index_map_.end(), -1);
     num_success_ = 0;
@@ -127,13 +99,6 @@ class SyntheticPointerActionTest : public testing::Test {
   ~SyntheticPointerActionTest() override {}
 
  protected:
-  template <typename MockGestureTarget>
-  void CreateSyntheticPointerActionTarget() {
-    target_.reset(new MockGestureTarget());
-    synthetic_pointer_ = SyntheticPointer::Create(
-        target_->GetDefaultSyntheticGestureSourceType());
-  }
-
   void ForwardSyntheticPointerAction() {
     pointer_action_.reset(new SyntheticPointerAction(
         std::move(action_param_list_), synthetic_pointer_.get(), &index_map_));
@@ -157,8 +122,6 @@ class SyntheticPointerActionTest : public testing::Test {
 };
 
 TEST_F(SyntheticPointerActionTest, PointerTouchAction) {
-  CreateSyntheticPointerActionTarget<MockSyntheticPointerTouchActionTarget>();
-
   // Send a touch press for one finger.
   SyntheticPointerActionParams params0 = SyntheticPointerActionParams(
       SyntheticPointerActionParams::PointerActionType::PRESS);
@@ -194,6 +157,8 @@ TEST_F(SyntheticPointerActionTest, PointerTouchAction) {
   action_param_list_->push_back(params1);
   ForwardSyntheticPointerAction();
 
+  pointer_touch_target =
+      static_cast<MockSyntheticPointerTouchActionTarget*>(target_.get());
   EXPECT_EQ(2, num_success_);
   EXPECT_EQ(0, num_failure_);
   // The type of the SyntheticWebTouchEvent is the action of the last finger.
@@ -216,6 +181,8 @@ TEST_F(SyntheticPointerActionTest, PointerTouchAction) {
   action_param_list_->push_back(params1);
   ForwardSyntheticPointerAction();
 
+  pointer_touch_target =
+      static_cast<MockSyntheticPointerTouchActionTarget*>(target_.get());
   EXPECT_EQ(3, num_success_);
   EXPECT_EQ(0, num_failure_);
   EXPECT_EQ(pointer_touch_target->type(), WebInputEvent::TouchMove);
@@ -248,8 +215,6 @@ TEST_F(SyntheticPointerActionTest, PointerTouchAction) {
 }
 
 TEST_F(SyntheticPointerActionTest, PointerTouchActionIndexInvalid) {
-  CreateSyntheticPointerActionTarget<MockSyntheticPointerTouchActionTarget>();
-
   // Users sent a wrong index for the touch action.
   SyntheticPointerActionParams params0 = SyntheticPointerActionParams(
       SyntheticPointerActionParams::PointerActionType::PRESS);
@@ -280,8 +245,6 @@ TEST_F(SyntheticPointerActionTest, PointerTouchActionIndexInvalid) {
 }
 
 TEST_F(SyntheticPointerActionTest, PointerTouchActionSourceTypeInvalid) {
-  CreateSyntheticPointerActionTarget<MockSyntheticPointerTouchActionTarget>();
-
   // Users' gesture source type does not match with the touch action.
   SyntheticPointerActionParams params0 = SyntheticPointerActionParams(
       SyntheticPointerActionParams::PointerActionType::PRESS);
@@ -312,8 +275,6 @@ TEST_F(SyntheticPointerActionTest, PointerTouchActionSourceTypeInvalid) {
 }
 
 TEST_F(SyntheticPointerActionTest, PointerTouchActionTypeInvalid) {
-  CreateSyntheticPointerActionTarget<MockSyntheticPointerTouchActionTarget>();
-
   // Cannot send a touch move or touch release without sending a touch press
   // first.
   SyntheticPointerActionParams params0 = SyntheticPointerActionParams(
@@ -367,157 +328,6 @@ TEST_F(SyntheticPointerActionTest, PointerTouchActionTypeInvalid) {
   EXPECT_EQ(3, num_failure_);
 }
 
-TEST_F(SyntheticPointerActionTest, PointerMouseAction) {
-  CreateSyntheticPointerActionTarget<MockSyntheticPointerMouseActionTarget>();
-
-  // Send a mouse move.
-  SyntheticPointerActionParams params = SyntheticPointerActionParams(
-      SyntheticPointerActionParams::PointerActionType::MOVE);
-  params.gesture_source_type = SyntheticGestureParams::MOUSE_INPUT;
-  params.set_index(0);
-  params.set_position(gfx::PointF(189, 62));
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  MockSyntheticPointerMouseActionTarget* pointer_mouse_target =
-      static_cast<MockSyntheticPointerMouseActionTarget*>(target_.get());
-  EXPECT_EQ(1, num_success_);
-  EXPECT_EQ(0, num_failure_);
-  EXPECT_EQ(pointer_mouse_target->type(), WebInputEvent::MouseMove);
-  EXPECT_EQ(pointer_mouse_target->position(), params.position());
-  EXPECT_EQ(pointer_mouse_target->clickCount(), 0);
-  EXPECT_EQ(pointer_mouse_target->button(), WebMouseEvent::ButtonNone);
-
-  // Send a mouse down.
-  action_param_list_.reset(new std::vector<SyntheticPointerActionParams>());
-  params.set_position(gfx::PointF(189, 62));
-  params.set_pointer_action_type(
-      SyntheticPointerActionParams::PointerActionType::PRESS);
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  EXPECT_EQ(2, num_success_);
-  EXPECT_EQ(0, num_failure_);
-  EXPECT_EQ(pointer_mouse_target->type(), WebInputEvent::MouseDown);
-  EXPECT_EQ(pointer_mouse_target->position(), params.position());
-  EXPECT_EQ(pointer_mouse_target->clickCount(), 1);
-  EXPECT_EQ(pointer_mouse_target->button(), WebMouseEvent::ButtonLeft);
-
-  // Send a mouse drag.
-  action_param_list_.reset(new std::vector<SyntheticPointerActionParams>());
-  params.set_position(gfx::PointF(326, 298));
-  params.set_pointer_action_type(
-      SyntheticPointerActionParams::PointerActionType::MOVE);
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  EXPECT_EQ(3, num_success_);
-  EXPECT_EQ(0, num_failure_);
-  EXPECT_EQ(pointer_mouse_target->type(), WebInputEvent::MouseMove);
-  EXPECT_EQ(pointer_mouse_target->position(), params.position());
-  EXPECT_EQ(pointer_mouse_target->clickCount(), 1);
-  EXPECT_EQ(pointer_mouse_target->button(), WebMouseEvent::ButtonLeft);
-
-  // Send a mouse up.
-  action_param_list_.reset(new std::vector<SyntheticPointerActionParams>());
-  params.set_pointer_action_type(
-      SyntheticPointerActionParams::PointerActionType::RELEASE);
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  EXPECT_EQ(4, num_success_);
-  EXPECT_EQ(0, num_failure_);
-  EXPECT_EQ(pointer_mouse_target->type(), WebInputEvent::MouseUp);
-  EXPECT_EQ(pointer_mouse_target->clickCount(), 1);
-  EXPECT_EQ(pointer_mouse_target->button(), WebMouseEvent::ButtonLeft);
-}
-
-TEST_F(SyntheticPointerActionTest, PointerMouseActionSourceTypeInvalid) {
-  CreateSyntheticPointerActionTarget<MockSyntheticPointerMouseActionTarget>();
-
-  // Users' gesture source type does not match with the mouse action.
-  SyntheticPointerActionParams params = SyntheticPointerActionParams(
-      SyntheticPointerActionParams::PointerActionType::PRESS);
-  params.gesture_source_type = SyntheticGestureParams::TOUCH_INPUT;
-  params.set_index(0);
-  params.set_position(gfx::PointF(54, 89));
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  EXPECT_EQ(0, num_success_);
-  EXPECT_EQ(1, num_failure_);
-
-  action_param_list_.reset(new std::vector<SyntheticPointerActionParams>());
-  params.gesture_source_type = SyntheticGestureParams::MOUSE_INPUT;
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  MockSyntheticPointerMouseActionTarget* pointer_mouse_target =
-      static_cast<MockSyntheticPointerMouseActionTarget*>(target_.get());
-  EXPECT_EQ(1, num_success_);
-  EXPECT_EQ(1, num_failure_);
-  EXPECT_EQ(pointer_mouse_target->type(), WebInputEvent::MouseDown);
-  EXPECT_EQ(pointer_mouse_target->position(), params.position());
-  EXPECT_EQ(pointer_mouse_target->clickCount(), 1);
-  EXPECT_EQ(pointer_mouse_target->button(), WebMouseEvent::ButtonLeft);
-}
-
-TEST_F(SyntheticPointerActionTest, PointerMouseActionTypeInvalid) {
-  CreateSyntheticPointerActionTarget<MockSyntheticPointerMouseActionTarget>();
-
-  // Send a mouse move.
-  SyntheticPointerActionParams params = SyntheticPointerActionParams(
-      SyntheticPointerActionParams::PointerActionType::MOVE);
-  params.gesture_source_type = SyntheticGestureParams::MOUSE_INPUT;
-  params.set_index(0);
-  params.set_position(gfx::PointF(189, 62));
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  MockSyntheticPointerMouseActionTarget* pointer_mouse_target =
-      static_cast<MockSyntheticPointerMouseActionTarget*>(target_.get());
-  EXPECT_EQ(1, num_success_);
-  EXPECT_EQ(0, num_failure_);
-  EXPECT_EQ(pointer_mouse_target->type(), WebInputEvent::MouseMove);
-  EXPECT_EQ(pointer_mouse_target->position(), params.position());
-  EXPECT_EQ(pointer_mouse_target->clickCount(), 0);
-  EXPECT_EQ(pointer_mouse_target->button(), WebMouseEvent::ButtonNone);
-
-  // Cannot send a mouse up without sending a mouse down first.
-  action_param_list_.reset(new std::vector<SyntheticPointerActionParams>());
-  params.set_pointer_action_type(
-      SyntheticPointerActionParams::PointerActionType::RELEASE);
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  EXPECT_EQ(1, num_success_);
-  EXPECT_EQ(1, num_failure_);
-
-  // Send a mouse down for one finger.
-  action_param_list_.reset(new std::vector<SyntheticPointerActionParams>());
-  params.set_pointer_action_type(
-      SyntheticPointerActionParams::PointerActionType::PRESS);
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  EXPECT_EQ(2, num_success_);
-  EXPECT_EQ(1, num_failure_);
-  EXPECT_EQ(pointer_mouse_target->type(), WebInputEvent::MouseDown);
-  EXPECT_EQ(pointer_mouse_target->position(), params.position());
-  EXPECT_EQ(pointer_mouse_target->clickCount(), 1);
-  EXPECT_EQ(pointer_mouse_target->button(), WebMouseEvent::ButtonLeft);
-
-  // Cannot send a mouse down again without releasing the mouse button.
-  action_param_list_.reset(new std::vector<SyntheticPointerActionParams>());
-  params.set_pointer_action_type(
-      SyntheticPointerActionParams::PointerActionType::PRESS);
-  action_param_list_->push_back(params);
-  ForwardSyntheticPointerAction();
-
-  EXPECT_EQ(2, num_success_);
-  EXPECT_EQ(2, num_failure_);
-}
-
 }  // namespace
 
-}  // namespace content
\ No newline at end of file
+}  // namespace content
diff --git a/content/browser/renderer_host/render_process_host_impl.cc b/content/browser/renderer_host/render_process_host_impl.cc
index dfc9364..394217d 100644
--- a/content/browser/renderer_host/render_process_host_impl.cc
+++ b/content/browser/renderer_host/render_process_host_impl.cc
@@ -111,6 +111,7 @@
 #include "content/browser/renderer_host/render_widget_helper.h"
 #include "content/browser/renderer_host/render_widget_host_impl.h"
 #include "content/browser/renderer_host/text_input_client_message_filter.h"
+#include "content/browser/renderer_host/websocket_dispatcher_host.h"
 #include "content/browser/resolve_proxy_msg_helper.h"
 #include "content/browser/service_worker/service_worker_context_wrapper.h"
 #include "content/browser/service_worker/service_worker_dispatcher_host.h"
@@ -120,7 +121,6 @@
 #include "content/browser/storage_partition_impl.h"
 #include "content/browser/streams/stream_context.h"
 #include "content/browser/tracing/trace_message_filter.h"
-#include "content/browser/websockets/websocket_manager.h"
 #include "content/browser/webui/web_ui_controller_factory_registry.h"
 #include "content/common/child_process_host_impl.h"
 #include "content/common/child_process_messages.h"
@@ -1035,6 +1035,15 @@ void RenderProcessHostImpl::CreateMessageFilters() {
   AddFilter(new BrowserCdmManager(GetID(), NULL));
 #endif
 
+  WebSocketDispatcherHost::GetRequestContextCallback
+      websocket_request_context_callback(
+          base::Bind(&GetRequestContext, request_context, media_request_context,
+                     RESOURCE_TYPE_SUB_RESOURCE));
+
+  AddFilter(new WebSocketDispatcherHost(
+      GetID(), websocket_request_context_callback, blob_storage_context.get(),
+      storage_partition_impl_));
+
   message_port_message_filter_ = new MessagePortMessageFilter(
       base::Bind(&RenderWidgetHelper::GetNextRoutingID,
                  base::Unretained(widget_helper_.get())));
@@ -1161,12 +1170,6 @@ void RenderProcessHostImpl::RegisterMojoInterfaces() {
   registry->AddInterface(base::Bind(&DeviceOrientationHost::Create));
   registry->AddInterface(base::Bind(&DeviceOrientationAbsoluteHost::Create));
 
-  // This is to support usage of WebSockets in cases in which there is no
-  // associated RenderFrame (e.g., Shared Workers).
-  registry->AddInterface(
-      base::Bind(&WebSocketManager::CreateWebSocket, GetID(), MSG_ROUTING_NONE),
-      ui_task_runner);
-
   GetContentClient()->browser()->ExposeInterfacesToRenderer(registry.get(),
                                                             this);
 
@@ -1533,7 +1536,6 @@ void RenderProcessHostImpl::PropagateBrowserCommandLineToRenderer(
     switches::kEnableCanvas2dDynamicRenderingModeSwitching,
     switches::kForceOverlayFullscreenVideo,
     switches::kFullMemoryCrashReport,
-    switches::kHideScrollbars,
     switches::kInertVisualViewport,
     switches::kIPCConnectionTimeout,
     switches::kIsRunningInMash,
diff --git a/content/browser/renderer_host/render_widget_host_impl.h b/content/browser/renderer_host/render_widget_host_impl.h
index 473d0ee..fad138c 100644
--- a/content/browser/renderer_host/render_widget_host_impl.h
+++ b/content/browser/renderer_host/render_widget_host_impl.h
@@ -263,12 +263,6 @@ class CONTENT_EXPORT RenderWidgetHostImpl : public RenderWidgetHost,
   // Notifies the RenderWidgetHost that the View was destroyed.
   void ViewDestroyed();
 
-  // Signals if this host has forwarded a GestureScrollBegin without yet having
-  // forwarded a matching GestureScrollEnd/GestureFlingStart.
-  bool is_in_touchscreen_gesture_scroll() const {
-    return is_in_touchscreen_gesture_scroll_;
-  }
-
 #if defined(OS_MACOSX)
   // Pause for a moment to wait for pending repaint or resize messages sent to
   // the renderer to arrive. If pending resize messages are for an old window
diff --git a/content/browser/renderer_host/render_widget_host_input_event_router.cc b/content/browser/renderer_host/render_widget_host_input_event_router.cc
index 703868a..9e17495 100644
--- a/content/browser/renderer_host/render_widget_host_input_event_router.cc
+++ b/content/browser/renderer_host/render_widget_host_input_event_router.cc
@@ -7,7 +7,6 @@
 #include "cc/quads/surface_draw_quad.h"
 #include "cc/surfaces/surface_id_allocator.h"
 #include "cc/surfaces/surface_manager.h"
-#include "content/browser/renderer_host/render_widget_host_impl.h"
 #include "content/browser/renderer_host/render_widget_host_view_base.h"
 #include "content/common/frame_messages.h"
 #include "third_party/WebKit/public/web/WebInputEvent.h"
@@ -95,9 +94,7 @@ bool RenderWidgetHostInputEventRouter::HittestDelegate::AcceptHitTarget(
 }
 
 RenderWidgetHostInputEventRouter::RenderWidgetHostInputEventRouter()
-    : active_touches_(0),
-      in_touchscreen_gesture_pinch_(false),
-      gesture_pinch_did_send_scroll_begin_(false) {}
+    : active_touches_(0) {}
 
 RenderWidgetHostInputEventRouter::~RenderWidgetHostInputEventRouter() {
   // We may be destroyed before some of the owners in the map, so we must
@@ -322,8 +319,7 @@ void RenderWidgetHostInputEventRouter::BubbleScrollEvent(
 void RenderWidgetHostInputEventRouter::SendGestureScrollBegin(
     RenderWidgetHostViewBase* view,
     const blink::WebGestureEvent& event) {
-  DCHECK(event.type == blink::WebInputEvent::GestureScrollUpdate ||
-         event.type == blink::WebInputEvent::GesturePinchBegin);
+  DCHECK(event.type == blink::WebInputEvent::GestureScrollUpdate);
   blink::WebGestureEvent scroll_begin(event);
   scroll_begin.type = blink::WebInputEvent::GestureScrollBegin;
   scroll_begin.data.scrollBegin.deltaXHint = event.data.scrollUpdate.deltaX;
@@ -336,8 +332,7 @@ void RenderWidgetHostInputEventRouter::SendGestureScrollBegin(
 void RenderWidgetHostInputEventRouter::SendGestureScrollEnd(
     RenderWidgetHostViewBase* view,
     const blink::WebGestureEvent& event) {
-  DCHECK(event.type == blink::WebInputEvent::GestureScrollUpdate ||
-         event.type == blink::WebInputEvent::GesturePinchEnd);
+  DCHECK(event.type == blink::WebInputEvent::GestureScrollUpdate);
   blink::WebGestureEvent scroll_end(event);
   scroll_end.type = blink::WebInputEvent::GestureScrollEnd;
   scroll_end.timeStampSeconds =
@@ -398,43 +393,6 @@ void RenderWidgetHostInputEventRouter::RouteTouchscreenGestureEvent(
     const ui::LatencyInfo& latency) {
   DCHECK_EQ(blink::WebGestureDeviceTouchscreen, event->sourceDevice);
 
-  if (event->type == blink::WebInputEvent::GesturePinchBegin) {
-    in_touchscreen_gesture_pinch_ = true;
-    // If the root view wasn't already receiving the gesture stream, then we
-    // need to wrap the diverted pinch events in a GestureScrollBegin/End.
-    // TODO(wjmaclean,kenrb,tdresser): When scroll latching lands, we can
-    // revisit how this code should work.
-    // https://crbug.com/526463
-    auto rwhi =
-        static_cast<RenderWidgetHostImpl*>(root_view->GetRenderWidgetHost());
-    // If the root view is the current gesture target, then we explicitly don't
-    // send a GestureScrollBegin, as by the time we see GesturePinchBegin there
-    // should have been one.
-    if (root_view != touchscreen_gesture_target_.target &&
-        !rwhi->is_in_touchscreen_gesture_scroll()) {
-      gesture_pinch_did_send_scroll_begin_ = true;
-      SendGestureScrollBegin(root_view, *event);
-    }
-  }
-
-  if (in_touchscreen_gesture_pinch_) {
-    root_view->ProcessGestureEvent(*event, latency);
-    if (event->type == blink::WebInputEvent::GesturePinchEnd) {
-      in_touchscreen_gesture_pinch_ = false;
-      // If the root view wasn't already receiving the gesture stream, then we
-      // need to wrap the diverted pinch events in a GestureScrollBegin/End.
-      auto rwhi =
-          static_cast<RenderWidgetHostImpl*>(root_view->GetRenderWidgetHost());
-      if (root_view != touchscreen_gesture_target_.target &&
-          gesture_pinch_did_send_scroll_begin_ &&
-          rwhi->is_in_touchscreen_gesture_scroll()) {
-        SendGestureScrollEnd(root_view, *event);
-      }
-      gesture_pinch_did_send_scroll_begin_ = false;
-    }
-    return;
-  }
-
   // We use GestureTapDown to detect the start of a gesture sequence since there
   // is no WebGestureEvent equivalent for ET_GESTURE_BEGIN. Note that this
   // means the GestureFlingCancel that always comes between ET_GESTURE_BEGIN and
diff --git a/content/browser/renderer_host/render_widget_host_input_event_router.h b/content/browser/renderer_host/render_widget_host_input_event_router.h
index 83736c4..70f8b05 100644
--- a/content/browser/renderer_host/render_widget_host_input_event_router.h
+++ b/content/browser/renderer_host/render_widget_host_input_event_router.h
@@ -137,11 +137,6 @@ class CONTENT_EXPORT RenderWidgetHostInputEventRouter
   TargetData bubbling_gesture_scroll_target_;
   TargetData first_bubbling_scroll_target_;
   int active_touches_;
-  // Keep track of when we are between GesturePinchBegin and GesturePinchEnd
-  // inclusive, as we need to route these events (and anything in between) to
-  // the main frame.
-  bool in_touchscreen_gesture_pinch_;
-  bool gesture_pinch_did_send_scroll_begin_;
   std::unordered_map<cc::SurfaceId, HittestData, cc::SurfaceIdHash>
       hittest_data_;
 
diff --git a/content/browser/renderer_host/websocket_blob_sender.cc b/content/browser/renderer_host/websocket_blob_sender.cc
new file mode 100644
index 0000000..89bb151
--- /dev/null
+++ b/content/browser/renderer_host/websocket_blob_sender.cc
@@ -0,0 +1,284 @@
+// Copyright 2016 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "content/browser/renderer_host/websocket_blob_sender.h"
+
+#include <algorithm>
+#include <ostream>
+#include <utility>
+
+#include "base/bind.h"
+#include "base/bind_helpers.h"
+#include "base/callback_helpers.h"
+#include "base/logging.h"
+#include "base/numerics/safe_conversions.h"
+#include "content/browser/renderer_host/websocket_dispatcher_host.h"
+#include "content/browser/renderer_host/websocket_host.h"
+#include "net/base/io_buffer.h"
+#include "net/base/net_errors.h"
+#include "net/websockets/websocket_channel.h"
+#include "net/websockets/websocket_frame.h"
+#include "storage/browser/blob/blob_data_handle.h"
+#include "storage/browser/blob/blob_reader.h"
+#include "storage/browser/blob/blob_storage_context.h"
+
+namespace content {
+
+namespace {
+
+using storage::BlobReader;
+using storage::BlobDataHandle;
+using storage::BlobStorageContext;
+
+// This must be smaller than the send quota high water mark or this class will
+// never send anything.
+const int kMinimumNonFinalFrameSize = 8 * 1024;
+
+// The IOBuffer has a fixed size for simplicity.
+const size_t kBufferSize = 128 * 1024;
+
+}  // namespace
+
+// This is needed to make DCHECK_EQ(), etc. compile.
+std::ostream& operator<<(std::ostream& os, WebSocketBlobSender::State state) {
+  static const char* const kStateStrings[] = {
+      "NONE",
+      "READ_SIZE",
+      "READ_SIZE_COMPLETE",
+      "WAIT_FOR_QUOTA",
+      "WAIT_FOR_QUOTA_COMPLETE",
+      "READ",
+      "READ_COMPLETE",
+  };
+  if (state < WebSocketBlobSender::State::NONE ||
+      state > WebSocketBlobSender::State::READ_COMPLETE) {
+    return os << "Bad State (" << static_cast<int>(state) << ")";
+  }
+  return os << kStateStrings[static_cast<int>(state)];
+}
+
+WebSocketBlobSender::WebSocketBlobSender(std::unique_ptr<Channel> channel)
+    : channel_(std::move(channel)) {}
+
+WebSocketBlobSender::~WebSocketBlobSender() {}
+
+int WebSocketBlobSender::Start(
+    const std::string& uuid,
+    uint64_t expected_size,
+    BlobStorageContext* context,
+    storage::FileSystemContext* file_system_context,
+    base::SingleThreadTaskRunner* file_task_runner,
+    net::WebSocketEventInterface::ChannelState* channel_state,
+    const net::CompletionCallback& callback) {
+  DCHECK(context);
+  DCHECK(channel_state);
+  DCHECK(!reader_);
+  std::unique_ptr<storage::BlobDataHandle> data_handle(
+      context->GetBlobDataFromUUID(uuid));
+  if (!data_handle)
+    return net::ERR_INVALID_HANDLE;
+  reader_ = data_handle->CreateReader(file_system_context, file_task_runner);
+  expected_size_ = expected_size;
+  next_state_ = State::READ_SIZE;
+  int rv = DoLoop(net::OK, channel_state);
+  if (*channel_state == net::WebSocketEventInterface::CHANNEL_ALIVE &&
+      rv == net::ERR_IO_PENDING) {
+    callback_ = callback;
+  }
+  return rv;
+}
+
+void WebSocketBlobSender::OnNewSendQuota() {
+  if (next_state_ == State::WAIT_FOR_QUOTA)
+    DoLoopAsync(net::OK);
+  // |this| may be deleted.
+}
+
+uint64_t WebSocketBlobSender::ActualSize() const {
+  return reader_->total_size();
+}
+
+void WebSocketBlobSender::OnReadComplete(int rv) {
+  DCHECK_EQ(State::READ_COMPLETE, next_state_);
+  DoLoopAsync(rv);
+  // |this| may be deleted.
+}
+
+void WebSocketBlobSender::OnSizeCalculated(int rv) {
+  DCHECK_EQ(State::READ_SIZE_COMPLETE, next_state_);
+  DoLoopAsync(rv);
+  // |this| may be deleted.
+}
+
+int WebSocketBlobSender::DoLoop(int result,
+                                Channel::ChannelState* channel_state) {
+  DCHECK_NE(State::NONE, next_state_);
+  int rv = result;
+  do {
+    State state = next_state_;
+    next_state_ = State::NONE;
+    switch (state) {
+      case State::READ_SIZE:
+        DCHECK_EQ(net::OK, rv);
+        rv = DoReadSize();
+        break;
+
+      case State::READ_SIZE_COMPLETE:
+        rv = DoReadSizeComplete(rv);
+        break;
+
+      case State::WAIT_FOR_QUOTA:
+        DCHECK_EQ(net::OK, rv);
+        rv = DoWaitForQuota();
+        break;
+
+      case State::WAIT_FOR_QUOTA_COMPLETE:
+        DCHECK_EQ(net::OK, rv);
+        rv = DoWaitForQuotaComplete();
+        break;
+
+      case State::READ:
+        DCHECK_EQ(net::OK, rv);
+        rv = DoRead();
+        break;
+
+      case State::READ_COMPLETE:
+        rv = DoReadComplete(rv, channel_state);
+        break;
+
+      default:
+        NOTREACHED();
+        break;
+    }
+  } while (*channel_state != net::WebSocketEventInterface::CHANNEL_DELETED &&
+           rv != net::ERR_IO_PENDING && next_state_ != State::NONE);
+  return rv;
+}
+
+void WebSocketBlobSender::DoLoopAsync(int result) {
+  Channel::ChannelState channel_state =
+      net::WebSocketEventInterface::CHANNEL_ALIVE;
+  int rv = DoLoop(result, &channel_state);
+  if (channel_state == net::WebSocketEventInterface::CHANNEL_ALIVE &&
+      rv != net::ERR_IO_PENDING) {
+    ResetAndReturn(&callback_).Run(rv);
+  }
+  // |this| may be deleted.
+}
+
+int WebSocketBlobSender::DoReadSize() {
+  next_state_ = State::READ_SIZE_COMPLETE;
+  // This use of base::Unretained() is safe because BlobReader cannot call the
+  // callback after it has been destroyed, and it is owned by this object.
+  BlobReader::Status status = reader_->CalculateSize(base::Bind(
+      &WebSocketBlobSender::OnSizeCalculated, base::Unretained(this)));
+  switch (status) {
+    case BlobReader::Status::NET_ERROR:
+      return reader_->net_error();
+
+    case BlobReader::Status::IO_PENDING:
+      return net::ERR_IO_PENDING;
+
+    case BlobReader::Status::DONE:
+      return net::OK;
+  }
+  NOTREACHED();
+  return net::ERR_UNEXPECTED;
+}
+
+int WebSocketBlobSender::DoReadSizeComplete(int result) {
+  if (result < 0)
+    return result;
+  if (reader_->total_size() != expected_size_)
+    return net::ERR_UPLOAD_FILE_CHANGED;
+  bytes_left_ = expected_size_;
+  // The result of the call to std::min() must fit inside a size_t because
+  // kBufferSize is type size_t.
+  size_t buffer_size = static_cast<size_t>(
+      std::min(bytes_left_, base::strict_cast<uint64_t>(kBufferSize)));
+  buffer_ = new net::IOBuffer(buffer_size);
+  next_state_ = State::WAIT_FOR_QUOTA;
+  return net::OK;
+}
+
+// The WAIT_FOR_QUOTA state has a self-edge; it will wait in this state until
+// there is enough quota to send some data.
+int WebSocketBlobSender::DoWaitForQuota() {
+  size_t quota = channel_->GetSendQuota();
+  if (kMinimumNonFinalFrameSize <= quota || bytes_left_ <= quota) {
+    next_state_ = State::WAIT_FOR_QUOTA_COMPLETE;
+    return net::OK;
+  }
+  next_state_ = State::WAIT_FOR_QUOTA;
+  return net::ERR_IO_PENDING;
+}
+
+// State::WAIT_FOR_QUOTA_COMPLETE exists just to give the state machine the
+// expected shape. It should be mostly optimised out.
+int WebSocketBlobSender::DoWaitForQuotaComplete() {
+  next_state_ = State::READ;
+  return net::OK;
+}
+
+int WebSocketBlobSender::DoRead() {
+  next_state_ = State::READ_COMPLETE;
+  size_t quota = channel_->GetSendQuota();
+  // |desired_bytes| must fit in a size_t because |quota| is of type
+  // size_t and so cannot be larger than its maximum value.
+  size_t desired_bytes =
+      static_cast<size_t>(std::min(bytes_left_, static_cast<uint64_t>(quota)));
+
+  // For simplicity this method only reads as many bytes as are currently
+  // needed.
+  size_t bytes_to_read = std::min(desired_bytes, kBufferSize);
+  int bytes_read = 0;
+  DCHECK(reader_);
+  DCHECK(buffer_);
+
+  // This use of base::Unretained is safe because the BlobReader object won't
+  // call the callback after it has been destroyed, and it belongs to this
+  // object.
+  BlobReader::Status status = reader_->Read(
+      buffer_.get(), bytes_to_read, &bytes_read,
+      base::Bind(&WebSocketBlobSender::OnReadComplete, base::Unretained(this)));
+
+  switch (status) {
+    case BlobReader::Status::NET_ERROR:
+      return reader_->net_error();
+
+    case BlobReader::Status::IO_PENDING:
+      return net::ERR_IO_PENDING;
+
+    case BlobReader::Status::DONE:
+      return bytes_read;
+  }
+  NOTREACHED();
+  return net::ERR_UNEXPECTED;
+}
+
+int WebSocketBlobSender::DoReadComplete(int result,
+                                        Channel::ChannelState* channel_state) {
+  if (result < 0)
+    return result;
+  DCHECK_GE(channel_->GetSendQuota(), static_cast<size_t>(result));
+  uint64_t bytes_read = static_cast<uint64_t>(result);
+  DCHECK_GE(bytes_left_, bytes_read);
+  bytes_left_ -= bytes_read;
+  bool fin = bytes_left_ == 0;
+  std::vector<char> data(buffer_->data(), buffer_->data() + bytes_read);
+  DCHECK(fin || data.size() > 0u) << "Non-final frames should be non-empty";
+  *channel_state = channel_->SendFrame(fin, data);
+  if (*channel_state == net::WebSocketEventInterface::CHANNEL_DELETED) {
+    // |this| is deleted.
+    return net::ERR_CONNECTION_RESET;
+  }
+
+  // It is important not to set next_state_ until after the call to SendFrame()
+  // because SendFrame() will sometimes call OnNewSendQuota() synchronously.
+  if (!fin)
+    next_state_ = State::WAIT_FOR_QUOTA;
+  return net::OK;
+}
+
+}  // namespace content
diff --git a/content/browser/renderer_host/websocket_blob_sender.h b/content/browser/renderer_host/websocket_blob_sender.h
new file mode 100644
index 0000000..d8131ad
--- /dev/null
+++ b/content/browser/renderer_host/websocket_blob_sender.h
@@ -0,0 +1,140 @@
+// Copyright 2016 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CONTENT_BROWSER_RENDERER_HOST_WEBSOCKET_BLOB_SENDER_H_
+#define CONTENT_BROWSER_RENDERER_HOST_WEBSOCKET_BLOB_SENDER_H_
+
+#include <stddef.h>
+#include <stdint.h>
+
+#include <iosfwd>
+#include <memory>
+#include <string>
+#include <vector>
+
+#include "base/macros.h"
+#include "base/memory/ref_counted.h"
+#include "content/common/content_export.h"
+#include "net/base/completion_callback.h"
+#include "net/websockets/websocket_event_interface.h"
+
+namespace base {
+class SingleThreadTaskRunner;
+}
+
+namespace net {
+class IOBuffer;
+}
+
+namespace storage {
+class BlobReader;
+class BlobStorageContext;
+class FileSystemContext;
+}
+
+namespace content {
+
+class WebSocketHost;
+
+// Read the contents of a Blob and write it to a WebSocket. Single-use: a new
+// object must be created each time a Blob is sent. Destroying the object
+// cancels all pending operations.
+class CONTENT_EXPORT WebSocketBlobSender final {
+ public:
+  // An abstraction of the WebSocketChannel this object will send frames to.
+  class Channel {
+   public:
+    using ChannelState = net::WebSocketEventInterface::ChannelState;
+
+    Channel() {}
+    virtual ~Channel() {}
+
+    // The currently available quota for sending. It must not decrease without
+    // SendFrame() being called.
+    virtual size_t GetSendQuota() const = 0;
+
+    // Send a binary frame. |fin| is true for the final frame of the message.
+    // |data| is the contents of the frame. data.size() must be less than
+    // GetSendQuota(). If this call returns CHANNEL_DELETED, WebSocketBlobSender
+    // will assume that it has been deleted and return without calling any
+    // callbacks or accessing any other member data.
+    virtual ChannelState SendFrame(bool fin, const std::vector<char>& data) = 0;
+
+   private:
+    DISALLOW_COPY_AND_ASSIGN(Channel);
+  };
+
+  // |channel| will be destroyed when this object is.
+  explicit WebSocketBlobSender(std::unique_ptr<Channel> channel);
+  ~WebSocketBlobSender();
+
+  // Checks that the blob identified by |uuid| exists, has the size
+  // |expected_size| and then starts sending it via |channel_|. Returns
+  // ERR_IO_PENDING to indicate that |callback| will be called later with the
+  // result. net::OK indicates synchronous success. Any other net error code
+  // indicates synchronous failure. This method may result in the destruction of
+  // the channel, in which case |*channel_state| will be set to CHANNEL_DELETED.
+  int Start(const std::string& uuid,
+            uint64_t expected_size,
+            storage::BlobStorageContext* context,
+            storage::FileSystemContext* file_system_context,
+            base::SingleThreadTaskRunner* file_task_runner,
+            net::WebSocketEventInterface::ChannelState* channel_state,
+            const net::CompletionCallback& callback);
+
+  // Sends more data if the object was waiting for quota and the new value of
+  // GetSendQuota() is large enough.
+  void OnNewSendQuota();
+
+  uint64_t expected_size() const { return expected_size_; }
+
+  // ActualSize() should only be called after completion: ie. Start() returned a
+  // value other than ERR_IO_PENDING or |callback_| has been called.
+  uint64_t ActualSize() const;
+
+ private:
+  // State proceeds through READ_SIZE and READ_SIZE_COMPLETE, then
+  // loops WAIT_FOR_QUOTA -> WAIT_FOR_QUOTA_COMPLETE -> READ
+  // -> READ_COMPLETE -> WAIT_FOR_QUOTA until the Blob is completely
+  // sent.
+  enum class State {
+    NONE = 0,
+    READ_SIZE,
+    READ_SIZE_COMPLETE,
+    WAIT_FOR_QUOTA,
+    WAIT_FOR_QUOTA_COMPLETE,
+    READ,
+    READ_COMPLETE,
+  };
+
+  // This is needed to make DCHECK_EQ(), etc. compile.
+  friend std::ostream& operator<<(std::ostream& os, State state);
+
+  void OnReadComplete(int rv);
+  void OnSizeCalculated(int rv);
+  // |channel_state| should point to CHANNEL_ALIVE when called. If it is
+  // CHANNEL_DELETED on return, the object has been deleted.
+  int DoLoop(int result, Channel::ChannelState* channel_state);
+  void DoLoopAsync(int result);
+  int DoReadSize();
+  int DoReadSizeComplete(int result);
+  int DoWaitForQuota();
+  int DoWaitForQuotaComplete();
+  int DoRead();
+  int DoReadComplete(int result, Channel::ChannelState* channel_state);
+
+  State next_state_ = State::NONE;
+  uint64_t expected_size_ = 0;
+  uint64_t bytes_left_ = 0;
+  net::CompletionCallback callback_;
+  scoped_refptr<net::IOBuffer> buffer_;
+  std::unique_ptr<storage::BlobReader> reader_;
+  const std::unique_ptr<Channel> channel_;
+
+  DISALLOW_COPY_AND_ASSIGN(WebSocketBlobSender);
+};
+
+}  // namespace content
+
+#endif  // CONTENT_BROWSER_RENDERER_HOST_WEBSOCKET_BLOB_SENDER_H_
diff --git a/content/browser/renderer_host/websocket_blob_sender_unittest.cc b/content/browser/renderer_host/websocket_blob_sender_unittest.cc
new file mode 100644
index 0000000..590c914
--- /dev/null
+++ b/content/browser/renderer_host/websocket_blob_sender_unittest.cc
@@ -0,0 +1,450 @@
+// Copyright 2016 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "content/browser/renderer_host/websocket_blob_sender.h"
+
+#include <string.h>
+
+#include "base/bind.h"
+#include "base/bind_helpers.h"
+#include "base/callback.h"
+#include "base/files/file.h"
+#include "base/files/file_path.h"
+#include "base/files/file_util.h"
+#include "base/files/scoped_temp_dir.h"
+#include "base/location.h"
+#include "base/memory/ptr_util.h"
+#include "base/memory/weak_ptr.h"
+#include "base/message_loop/message_loop.h"
+#include "base/run_loop.h"
+#include "base/single_thread_task_runner.h"
+#include "base/task_runner.h"
+#include "base/threading/thread_task_runner_handle.h"
+#include "base/time/time.h"
+#include "content/browser/blob_storage/chrome_blob_storage_context.h"
+#include "content/public/browser/blob_handle.h"
+#include "content/public/browser/browser_thread.h"
+#include "content/public/browser/storage_partition.h"
+#include "content/public/test/test_browser_context.h"
+#include "content/public/test/test_browser_thread_bundle.h"
+#include "net/base/completion_callback.h"
+#include "net/base/net_errors.h"
+#include "net/base/test_completion_callback.h"
+#include "storage/common/fileapi/file_system_types.h"
+#include "testing/gtest/include/gtest/gtest.h"
+#include "url/gurl.h"
+
+namespace content {
+
+namespace {
+
+const char kDummyUrl[] = "http://www.example.com/";
+const char kBanana[] = "banana";
+
+// This is small so that the tests do not waste too much time just copying bytes
+// around. But it has to be larger than kMinimumNonFinalFrameSize defined in
+// websocket_blob_sender.cc.
+const size_t kInitialQuota = 16 * 1024;
+
+using net::TestCompletionCallback;
+
+// A fake channel for testing. Records the contents of the message that was sent
+// through it. Quota is restricted, and is refreshed asynchronously in response
+// to calls to SendFrame().
+class FakeChannel : public WebSocketBlobSender::Channel {
+ public:
+  // |notify_new_quota| will be run asynchronously on the current MessageLoop
+  // every time GetSendQuota() increases.
+  FakeChannel() : weak_factory_(this) {}
+
+  // This method must be called before SendFrame() is.
+  void set_notify_new_quota(const base::Closure& notify_new_quota) {
+    notify_new_quota_ = notify_new_quota;
+  }
+
+  size_t GetSendQuota() const override { return current_send_quota_; }
+
+  ChannelState SendFrame(bool fin, const std::vector<char>& data) override {
+    ++frames_sent_;
+    EXPECT_FALSE(got_fin_);
+    if (fin)
+      got_fin_ = true;
+    EXPECT_LE(data.size(), current_send_quota_);
+    message_.insert(message_.end(), data.begin(), data.end());
+    current_send_quota_ -= data.size();
+    base::ThreadTaskRunnerHandle::Get()->PostTask(
+        FROM_HERE,
+        base::Bind(&FakeChannel::RefreshQuota, weak_factory_.GetWeakPtr()));
+    return net::WebSocketEventInterface::CHANNEL_ALIVE;
+  }
+
+  bool got_fin() const { return got_fin_; }
+
+  int frames_sent() const { return frames_sent_; }
+
+  const std::vector<char>& message() const { return message_; }
+
+ private:
+  void RefreshQuota() {
+    if (current_send_quota_ == kInitialQuota)
+      return;
+    current_send_quota_ = kInitialQuota;
+    DCHECK(!notify_new_quota_.is_null());
+    notify_new_quota_.Run();
+  }
+
+  base::Closure notify_new_quota_;
+  size_t current_send_quota_ = kInitialQuota;
+  int frames_sent_ = 0;
+  bool got_fin_ = false;
+  std::vector<char> message_;
+  base::WeakPtrFactory<FakeChannel> weak_factory_;
+};
+
+class WebSocketBlobSenderTest : public ::testing::Test {
+ protected:
+  // The Windows implementation of net::FileStream::Context requires a real IO
+  // MessageLoop.
+  WebSocketBlobSenderTest()
+      : threads_(TestBrowserThreadBundle::IO_MAINLOOP),
+        chrome_blob_storage_context_(
+            ChromeBlobStorageContext::GetFor(&browser_context_)),
+        fake_channel_(nullptr),
+        sender_() {}
+  ~WebSocketBlobSenderTest() override {}
+
+  void SetUp() override {
+    // ChromeBlobStorageContext::GetFor() does some work asynchronously.
+    base::RunLoop().RunUntilIdle();
+    SetUpSender();
+  }
+
+  // This method can be overriden to use a different channel implementation.
+  virtual void SetUpSender() {
+    fake_channel_ = new FakeChannel;
+    sender_.reset(new WebSocketBlobSender(base::WrapUnique(fake_channel_)));
+    fake_channel_->set_notify_new_quota(base::Bind(
+        &WebSocketBlobSender::OnNewSendQuota, base::Unretained(sender_.get())));
+  }
+
+  storage::BlobStorageContext* context() {
+    return chrome_blob_storage_context_->context();
+  }
+
+  storage::FileSystemContext* GetFileSystemContext() {
+    StoragePartition* partition = BrowserContext::GetStoragePartitionForSite(
+        &browser_context_, GURL(kDummyUrl));
+    return partition->GetFileSystemContext();
+  }
+
+  // |string| is copied.
+  std::unique_ptr<BlobHandle> CreateMemoryBackedBlob(const char* string) {
+    std::unique_ptr<BlobHandle> handle =
+        chrome_blob_storage_context_->CreateMemoryBackedBlob(string,
+                                                             strlen(string));
+    EXPECT_TRUE(handle);
+    return handle;
+  }
+
+  // Call sender_.Start() with the other parameters filled in appropriately for
+  // this test fixture.
+  int Start(const std::string& uuid,
+            uint64_t expected_size,
+            const net::CompletionCallback& callback) {
+    net::WebSocketEventInterface::ChannelState channel_state =
+        net::WebSocketEventInterface::CHANNEL_ALIVE;
+    return sender_->Start(
+        uuid, expected_size, context(), GetFileSystemContext(),
+        BrowserThread::GetTaskRunnerForThread(BrowserThread::FILE).get(),
+        &channel_state, callback);
+  }
+
+  void NotCalledCallbackImpl(int rv) {
+    ADD_FAILURE()
+        << "Callback that should not be called was called with argument " << rv;
+  }
+
+  net::CompletionCallback NotCalled() {
+    return base::Bind(&WebSocketBlobSenderTest::NotCalledCallbackImpl,
+                      base::Unretained(this));
+  }
+
+  void ExpectOkAndQuit(base::RunLoop* run_loop, int result) {
+    EXPECT_EQ(net::OK, result);
+    run_loop->Quit();
+  }
+
+  net::CompletionCallback ExpectOkAndQuitCallback(base::RunLoop* run_loop) {
+    return base::Bind(&WebSocketBlobSenderTest::ExpectOkAndQuit,
+                      base::Unretained(this), run_loop);
+  }
+
+  TestBrowserThreadBundle threads_;
+  TestBrowserContext browser_context_;
+  scoped_refptr<ChromeBlobStorageContext> chrome_blob_storage_context_;
+  // |fake_channel_| is owned by |sender_|.
+  FakeChannel* fake_channel_;
+  std::unique_ptr<WebSocketBlobSender> sender_;
+};
+
+TEST_F(WebSocketBlobSenderTest, Construction) {}
+
+TEST_F(WebSocketBlobSenderTest, EmptyBlob) {
+  std::unique_ptr<BlobHandle> handle = CreateMemoryBackedBlob("");
+
+  // The APIs allow for this to be asynchronous but that is unlikely in
+  // practice.
+  int result = Start(handle->GetUUID(), UINT64_C(0), NotCalled());
+  // If this fails with result == -1, someone has changed the code to be
+  // asynchronous and this test should be adapted to match.
+  EXPECT_EQ(net::OK, result);
+  EXPECT_TRUE(fake_channel_->got_fin());
+  EXPECT_EQ(0U, fake_channel_->message().size());
+}
+
+TEST_F(WebSocketBlobSenderTest, SmallBlob) {
+  std::unique_ptr<BlobHandle> handle = CreateMemoryBackedBlob(kBanana);
+
+  EXPECT_EQ(net::OK, Start(handle->GetUUID(), UINT64_C(6), NotCalled()));
+  EXPECT_TRUE(fake_channel_->got_fin());
+  EXPECT_EQ(1, fake_channel_->frames_sent());
+  EXPECT_EQ(std::vector<char>(kBanana, kBanana + 6), fake_channel_->message());
+}
+
+TEST_F(WebSocketBlobSenderTest, SizeMismatch) {
+  std::unique_ptr<BlobHandle> handle = CreateMemoryBackedBlob(kBanana);
+
+  EXPECT_EQ(net::ERR_UPLOAD_FILE_CHANGED,
+            Start(handle->GetUUID(), UINT64_C(5), NotCalled()));
+  EXPECT_EQ(0, fake_channel_->frames_sent());
+}
+
+TEST_F(WebSocketBlobSenderTest, InvalidUUID) {
+  EXPECT_EQ(net::ERR_INVALID_HANDLE,
+            Start("sandwich", UINT64_C(0), NotCalled()));
+}
+
+TEST_F(WebSocketBlobSenderTest, LargeMessage) {
+  std::string message(kInitialQuota + 10, 'a');
+  std::unique_ptr<BlobHandle> handle = CreateMemoryBackedBlob(message.c_str());
+
+  base::RunLoop run_loop;
+  int rv = Start(handle->GetUUID(), message.size(),
+                 ExpectOkAndQuitCallback(&run_loop));
+  EXPECT_EQ(net::ERR_IO_PENDING, rv);
+  EXPECT_EQ(1, fake_channel_->frames_sent());
+  run_loop.Run();
+  EXPECT_EQ(2, fake_channel_->frames_sent());
+  EXPECT_TRUE(fake_channel_->got_fin());
+  std::vector<char> expected_message(message.begin(), message.end());
+  EXPECT_EQ(expected_message, fake_channel_->message());
+}
+
+// A message exactly equal to the available quota should be sent in one frame.
+TEST_F(WebSocketBlobSenderTest, ExactSizeMessage) {
+  std::string message(kInitialQuota, 'a');
+  std::unique_ptr<BlobHandle> handle = CreateMemoryBackedBlob(message.c_str());
+
+  EXPECT_EQ(net::OK, Start(handle->GetUUID(), message.size(), NotCalled()));
+  EXPECT_EQ(1, fake_channel_->frames_sent());
+  EXPECT_TRUE(fake_channel_->got_fin());
+  std::vector<char> expected_message(message.begin(), message.end());
+  EXPECT_EQ(expected_message, fake_channel_->message());
+}
+
+// If the connection is closed while sending a message, the WebSocketBlobSender
+// object will be destroyed. It needs to handle this case without error.
+TEST_F(WebSocketBlobSenderTest, AbortedSend) {
+  std::string message(kInitialQuota + 10, 'a');
+  std::unique_ptr<BlobHandle> handle = CreateMemoryBackedBlob(message.c_str());
+
+  int rv = Start(handle->GetUUID(), message.size(), NotCalled());
+  EXPECT_EQ(net::ERR_IO_PENDING, rv);
+  sender_.reset();
+}
+
+// Invalid file-backed blob.
+TEST_F(WebSocketBlobSenderTest, InvalidFileBackedBlob) {
+  base::FilePath path(FILE_PATH_LITERAL(
+      "WebSocketBlobSentTest.InvalidFileBackedBlob.NonExistentFile"));
+  std::unique_ptr<BlobHandle> handle =
+      chrome_blob_storage_context_->CreateFileBackedBlob(path, 0u, 32u,
+                                                         base::Time::Now());
+  EXPECT_TRUE(handle);
+
+  TestCompletionCallback callback;
+  int rv =
+      callback.GetResult(Start(handle->GetUUID(), 5u, callback.callback()));
+  EXPECT_EQ(net::ERR_FILE_NOT_FOUND, rv);
+}
+
+// A test fixture that does the additional work necessary to create working
+// file-backed blobs.
+class WebSocketFileBackedBlobSenderTest : public WebSocketBlobSenderTest {
+ protected:
+  void SetUp() override {
+    WebSocketBlobSenderTest::SetUp();
+    // temp_dir_ is recursively deleted on destruction.
+    ASSERT_TRUE(temp_dir_.CreateUniqueTempDir());
+  }
+
+  void CreateFile(const std::string& contents,
+                  const base::FilePath& path,
+                  base::File::Info* info) {
+    ASSERT_EQ(contents.size(), static_cast<size_t>(base::WriteFile(
+                                   path, contents.data(), contents.size())));
+    ASSERT_TRUE(base::GetFileInfo(path, info));
+  }
+
+  std::unique_ptr<BlobHandle> CreateFileBackedBlob(
+      const std::string& contents) {
+    base::FilePath path = temp_dir_.path().AppendASCII("blob.dat");
+    base::File::Info info;
+    CreateFile(contents, path, &info);
+    if (HasFatalFailure())
+      return nullptr;
+    return chrome_blob_storage_context_->CreateFileBackedBlob(
+        path, 0u, contents.size(), info.last_modified);
+  }
+
+  base::ScopedTempDir temp_dir_;
+};
+
+TEST_F(WebSocketFileBackedBlobSenderTest, EmptyBlob) {
+  std::unique_ptr<BlobHandle> handle = CreateFileBackedBlob("");
+  ASSERT_TRUE(handle);
+
+  TestCompletionCallback callback;
+  int result = callback.GetResult(
+      Start(handle->GetUUID(), UINT64_C(0), callback.callback()));
+  EXPECT_EQ(net::OK, result);
+  EXPECT_TRUE(fake_channel_->got_fin());
+  EXPECT_EQ(0U, fake_channel_->message().size());
+}
+
+TEST_F(WebSocketFileBackedBlobSenderTest, SizeMismatch) {
+  std::unique_ptr<BlobHandle> handle = CreateFileBackedBlob(kBanana);
+  ASSERT_TRUE(handle);
+
+  TestCompletionCallback callback;
+  int result = Start(handle->GetUUID(), UINT64_C(8), callback.callback());
+  // This test explicitly aims to test the asynchronous code path, otherwise it
+  // would be identical to the other SizeMismatch test above.
+  EXPECT_EQ(net::ERR_IO_PENDING, result);
+  EXPECT_EQ(net::ERR_UPLOAD_FILE_CHANGED, callback.WaitForResult());
+  EXPECT_EQ(0, fake_channel_->frames_sent());
+}
+
+TEST_F(WebSocketFileBackedBlobSenderTest, LargeMessage) {
+  std::string message = "the green potato had lunch with the angry cat. ";
+  while (message.size() <= kInitialQuota) {
+    message = message + message;
+  }
+  std::unique_ptr<BlobHandle> handle = CreateFileBackedBlob(message);
+  ASSERT_TRUE(handle);
+
+  TestCompletionCallback callback;
+  int result = Start(handle->GetUUID(), message.size(), callback.callback());
+  EXPECT_EQ(net::OK, callback.GetResult(result));
+  std::vector<char> expected_message(message.begin(), message.end());
+  EXPECT_EQ(expected_message, fake_channel_->message());
+}
+
+// The WebSocketBlobSender needs to handle a connection close while doing file
+// IO cleanly.
+TEST_F(WebSocketFileBackedBlobSenderTest, Aborted) {
+  std::unique_ptr<BlobHandle> handle = CreateFileBackedBlob(kBanana);
+
+  int rv = Start(handle->GetUUID(), UINT64_C(6), NotCalled());
+  EXPECT_EQ(net::ERR_IO_PENDING, rv);
+  sender_.reset();
+}
+
+class DeletingFakeChannel : public WebSocketBlobSender::Channel {
+ public:
+  explicit DeletingFakeChannel(
+      std::unique_ptr<WebSocketBlobSender>* sender_to_delete)
+      : sender_(sender_to_delete) {}
+
+  size_t GetSendQuota() const override { return kInitialQuota; }
+
+  ChannelState SendFrame(bool fin, const std::vector<char>& data) override {
+    sender_->reset();
+    // |this| is deleted here.
+    return net::WebSocketEventInterface::CHANNEL_DELETED;
+  }
+
+ private:
+  std::unique_ptr<WebSocketBlobSender>* sender_;
+};
+
+class WebSocketBlobSenderDeletingTest : public WebSocketBlobSenderTest {
+ protected:
+  void SetUpSender() override {
+    sender_.reset(new WebSocketBlobSender(
+        base::WrapUnique(new DeletingFakeChannel(&sender_))));
+  }
+};
+
+// This test only does something useful when run under AddressSanitizer or a
+// similar tool that can detect use-after-free bugs.
+TEST_F(WebSocketBlobSenderDeletingTest, SenderDeleted) {
+  std::unique_ptr<BlobHandle> handle = CreateMemoryBackedBlob(kBanana);
+
+  EXPECT_EQ(net::ERR_CONNECTION_RESET,
+            Start(handle->GetUUID(), UINT64_C(6), NotCalled()));
+  EXPECT_FALSE(sender_);
+}
+
+// SendFrame() calls OnSendNewQuota() synchronously while filling the operating
+// system's socket write buffer. The purpose of this Channel implementation is
+// to verify that the synchronous case works correctly.
+class SynchronousFakeChannel : public WebSocketBlobSender::Channel {
+ public:
+  // This method must be called before SendFrame() is.
+  void set_notify_new_quota(const base::Closure& notify_new_quota) {
+    notify_new_quota_ = notify_new_quota;
+  }
+
+  size_t GetSendQuota() const override { return kInitialQuota; }
+
+  ChannelState SendFrame(bool fin, const std::vector<char>& data) override {
+    message_.insert(message_.end(), data.begin(), data.end());
+    notify_new_quota_.Run();
+    return net::WebSocketEventInterface::CHANNEL_ALIVE;
+  }
+
+  const std::vector<char>& message() const { return message_; }
+
+ private:
+  base::Closure notify_new_quota_;
+  std::vector<char> message_;
+};
+
+class WebSocketBlobSenderSynchronousTest : public WebSocketBlobSenderTest {
+ protected:
+  void SetUpSender() override {
+    synchronous_fake_channel_ = new SynchronousFakeChannel;
+    sender_.reset(
+        new WebSocketBlobSender(base::WrapUnique(synchronous_fake_channel_)));
+    synchronous_fake_channel_->set_notify_new_quota(base::Bind(
+        &WebSocketBlobSender::OnNewSendQuota, base::Unretained(sender_.get())));
+  }
+
+  SynchronousFakeChannel* synchronous_fake_channel_ = nullptr;
+};
+
+TEST_F(WebSocketBlobSenderSynchronousTest, LargeMessage) {
+  std::string message(kInitialQuota + 10, 'a');
+  std::unique_ptr<BlobHandle> handle = CreateMemoryBackedBlob(message.c_str());
+
+  int rv = Start(handle->GetUUID(), message.size(), NotCalled());
+  EXPECT_EQ(net::OK, rv);
+  std::vector<char> expected_message(message.begin(), message.end());
+  EXPECT_EQ(expected_message, synchronous_fake_channel_->message());
+}
+
+}  // namespace
+
+}  // namespace content
diff --git a/content/browser/renderer_host/websocket_dispatcher_host.cc b/content/browser/renderer_host/websocket_dispatcher_host.cc
new file mode 100644
index 0000000..b20f54c
--- /dev/null
+++ b/content/browser/renderer_host/websocket_dispatcher_host.cc
@@ -0,0 +1,310 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "content/browser/renderer_host/websocket_dispatcher_host.h"
+
+#include <stddef.h>
+
+#include <algorithm>
+#include <string>
+#include <vector>
+
+#include "base/callback.h"
+#include "base/logging.h"
+#include "base/numerics/safe_conversions.h"
+#include "base/rand_util.h"
+#include "base/stl_util.h"
+#include "content/browser/blob_storage/chrome_blob_storage_context.h"
+#include "content/browser/child_process_security_policy_impl.h"
+#include "content/browser/renderer_host/websocket_host.h"
+#include "content/common/websocket_messages.h"
+
+namespace content {
+
+namespace {
+
+// Many methods defined in this file return a WebSocketHostState enum
+// value. Make WebSocketHostState visible at file scope so it doesn't have to be
+// fully-qualified every time.
+typedef WebSocketDispatcherHost::WebSocketHostState WebSocketHostState;
+
+// Max number of pending connections per WebSocketDispatcherHost
+// used for per-renderer WebSocket throttling.
+const int kMaxPendingWebSocketConnections = 255;
+
+}  // namespace
+
+WebSocketDispatcherHost::WebSocketDispatcherHost(
+    int process_id,
+    const GetRequestContextCallback& get_context_callback,
+    ChromeBlobStorageContext* blob_storage_context,
+    StoragePartition* storage_partition)
+    : BrowserMessageFilter(WebSocketMsgStart),
+      process_id_(process_id),
+      get_context_callback_(get_context_callback),
+      websocket_host_factory_(
+          base::Bind(&WebSocketDispatcherHost::CreateWebSocketHost,
+                     base::Unretained(this))),
+      num_pending_connections_(0),
+      num_current_succeeded_connections_(0),
+      num_previous_succeeded_connections_(0),
+      num_current_failed_connections_(0),
+      num_previous_failed_connections_(0),
+      blob_storage_context_(blob_storage_context),
+      storage_partition_(storage_partition) {}
+
+WebSocketDispatcherHost::WebSocketDispatcherHost(
+    int process_id,
+    const GetRequestContextCallback& get_context_callback,
+    const WebSocketHostFactory& websocket_host_factory)
+    : BrowserMessageFilter(WebSocketMsgStart),
+      process_id_(process_id),
+      get_context_callback_(get_context_callback),
+      websocket_host_factory_(websocket_host_factory),
+      num_pending_connections_(0),
+      num_current_succeeded_connections_(0),
+      num_previous_succeeded_connections_(0),
+      num_current_failed_connections_(0),
+      num_previous_failed_connections_(0),
+      storage_partition_(nullptr) {}
+
+WebSocketHost* WebSocketDispatcherHost::CreateWebSocketHost(
+    int routing_id,
+    base::TimeDelta delay) {
+  return new WebSocketHost(
+      routing_id, this, get_context_callback_.Run(), delay);
+}
+
+bool WebSocketDispatcherHost::OnMessageReceived(const IPC::Message& message) {
+  switch (message.type()) {
+    case WebSocketHostMsg_AddChannelRequest::ID:
+    case WebSocketHostMsg_SendBlob::ID:
+    case WebSocketMsg_SendFrame::ID:
+    case WebSocketMsg_FlowControl::ID:
+    case WebSocketMsg_DropChannel::ID:
+      break;
+
+    default:
+      // Every message that has not been handled by a previous filter passes
+      // through here, so it is good to pass them on as efficiently as possible.
+      return false;
+  }
+
+  int routing_id = message.routing_id();
+  WebSocketHost* host = GetHost(routing_id);
+  if (message.type() == WebSocketHostMsg_AddChannelRequest::ID) {
+    if (host) {
+      DVLOG(1) << "routing_id=" << routing_id << " already in use.";
+      // The websocket multiplexing spec says to should drop the physical
+      // connection in this case, but there isn't a real physical connection
+      // to the renderer, and killing the renderer for this would seem to be a
+      // little extreme. So for now just ignore the bogus request.
+      return true;  // We handled the message (by ignoring it).
+    }
+    if (num_pending_connections_ >= kMaxPendingWebSocketConnections) {
+      if (!Send(new WebSocketMsg_NotifyFailure(
+              routing_id,
+              "Error in connection establishment: "
+              "net::ERR_INSUFFICIENT_RESOURCES"))) {
+        DVLOG(1) << "Sending of message type "
+                 << "WebSocketMsg_NotifyFailure failed.";
+      }
+      return true;
+    }
+    host = websocket_host_factory_.Run(routing_id, CalculateDelay());
+    hosts_.insert(WebSocketHostTable::value_type(routing_id, host));
+    ++num_pending_connections_;
+    if (!throttling_period_timer_.IsRunning())
+      throttling_period_timer_.Start(
+          FROM_HERE,
+          base::TimeDelta::FromMinutes(2),
+          this,
+          &WebSocketDispatcherHost::ThrottlingPeriodTimerCallback);
+  }
+  if (!host) {
+    DVLOG(1) << "Received invalid routing ID " << routing_id
+             << " from renderer.";
+    return true;  // We handled the message (by ignoring it).
+  }
+  return host->OnMessageReceived(message);
+}
+
+bool WebSocketDispatcherHost::CanReadRawCookies() const {
+  ChildProcessSecurityPolicyImpl* policy =
+      ChildProcessSecurityPolicyImpl::GetInstance();
+  return policy->CanReadRawCookies(process_id_);
+}
+
+storage::BlobStorageContext* WebSocketDispatcherHost::blob_storage_context()
+    const {
+  DCHECK(blob_storage_context_);
+  return blob_storage_context_->context();
+}
+
+WebSocketHost* WebSocketDispatcherHost::GetHost(int routing_id) const {
+  WebSocketHostTable::const_iterator it = hosts_.find(routing_id);
+  return it == hosts_.end() ? NULL : it->second;
+}
+
+WebSocketHostState WebSocketDispatcherHost::SendOrDrop(IPC::Message* message) {
+  const uint32_t message_type = message->type();
+  const int32_t message_routing_id = message->routing_id();
+  if (!Send(message)) {
+    message = NULL;
+    DVLOG(1) << "Sending of message type " << message_type
+             << " failed. Dropping channel.";
+    DeleteWebSocketHost(message_routing_id);
+    return WEBSOCKET_HOST_DELETED;
+  }
+  return WEBSOCKET_HOST_ALIVE;
+}
+
+WebSocketHostState WebSocketDispatcherHost::SendAddChannelResponse(
+    int routing_id,
+    const std::string& selected_protocol,
+    const std::string& extensions) {
+  // Update throttling counters (success).
+  WebSocketHost* host = GetHost(routing_id);
+  DCHECK(host);
+  host->OnHandshakeSucceeded();
+  --num_pending_connections_;
+  DCHECK_GE(num_pending_connections_, 0);
+  ++num_current_succeeded_connections_;
+
+  return SendOrDrop(new WebSocketMsg_AddChannelResponse(
+      routing_id, selected_protocol, extensions));
+}
+
+WebSocketHostState WebSocketDispatcherHost::SendFrame(
+    int routing_id,
+    bool fin,
+    WebSocketMessageType type,
+    const std::vector<char>& data) {
+  return SendOrDrop(new WebSocketMsg_SendFrame(routing_id, fin, type, data));
+}
+
+WebSocketHostState WebSocketDispatcherHost::SendFlowControl(int routing_id,
+                                                            int64_t quota) {
+  return SendOrDrop(new WebSocketMsg_FlowControl(routing_id, quota));
+}
+
+WebSocketHostState WebSocketDispatcherHost::NotifyClosingHandshake(
+    int routing_id) {
+  return SendOrDrop(new WebSocketMsg_NotifyClosing(routing_id));
+}
+
+WebSocketHostState WebSocketDispatcherHost::NotifyStartOpeningHandshake(
+    int routing_id, const WebSocketHandshakeRequest& request) {
+  return SendOrDrop(new WebSocketMsg_NotifyStartOpeningHandshake(
+      routing_id, request));
+}
+
+WebSocketHostState WebSocketDispatcherHost::NotifyFinishOpeningHandshake(
+    int routing_id, const WebSocketHandshakeResponse& response) {
+  return SendOrDrop(new WebSocketMsg_NotifyFinishOpeningHandshake(
+      routing_id, response));
+}
+
+WebSocketHostState WebSocketDispatcherHost::NotifyFailure(
+    int routing_id,
+    const std::string& message) {
+  if (SendOrDrop(new WebSocketMsg_NotifyFailure(
+          routing_id, message)) == WEBSOCKET_HOST_DELETED) {
+    return WEBSOCKET_HOST_DELETED;
+  }
+  DeleteWebSocketHost(routing_id);
+  return WEBSOCKET_HOST_DELETED;
+}
+
+WebSocketHostState WebSocketDispatcherHost::BlobSendComplete(int routing_id) {
+  return SendOrDrop(new WebSocketMsg_BlobSendComplete(routing_id));
+}
+
+WebSocketHostState WebSocketDispatcherHost::DoDropChannel(
+    int routing_id,
+    bool was_clean,
+    uint16_t code,
+    const std::string& reason) {
+  if (SendOrDrop(
+          new WebSocketMsg_DropChannel(routing_id, was_clean, code, reason)) ==
+      WEBSOCKET_HOST_DELETED)
+    return WEBSOCKET_HOST_DELETED;
+  DeleteWebSocketHost(routing_id);
+  return WEBSOCKET_HOST_DELETED;
+}
+
+WebSocketDispatcherHost::~WebSocketDispatcherHost() {
+  std::vector<WebSocketHost*> hosts;
+  for (base::hash_map<int, WebSocketHost*>::const_iterator i = hosts_.begin();
+       i != hosts_.end(); ++i) {
+    // In order to avoid changing the container while iterating, we copy
+    // the hosts.
+    hosts.push_back(i->second);
+  }
+
+  for (size_t i = 0; i < hosts.size(); ++i) {
+    // Note that some calls to GoAway could fail. In that case hosts[i] will be
+    // deleted and removed from |hosts_| in |DoDropChannel|.
+    hosts[i]->GoAway();
+    hosts[i] = NULL;
+  }
+
+  STLDeleteContainerPairSecondPointers(hosts_.begin(), hosts_.end());
+}
+
+void WebSocketDispatcherHost::DeleteWebSocketHost(int routing_id) {
+  WebSocketHostTable::iterator it = hosts_.find(routing_id);
+  DCHECK(it != hosts_.end());
+  DCHECK(it->second);
+  if (!it->second->handshake_succeeded()) {
+    // Update throttling counters (failure).
+    --num_pending_connections_;
+    DCHECK_GE(num_pending_connections_, 0);
+    ++num_current_failed_connections_;
+  }
+
+  delete it->second;
+  hosts_.erase(it);
+
+  DCHECK_LE(base::checked_cast<size_t>(num_pending_connections_),
+            hosts_.size());
+}
+
+int64_t WebSocketDispatcherHost::num_failed_connections() const {
+  return num_previous_failed_connections_ +
+         num_current_failed_connections_;
+}
+
+int64_t WebSocketDispatcherHost::num_succeeded_connections() const {
+  return num_previous_succeeded_connections_ +
+         num_current_succeeded_connections_;
+}
+
+// Calculate delay as described in
+// the per-renderer WebSocket throttling design doc:
+// https://docs.google.com/document/d/1aw2oN5PKfk-1gLnBrlv1OwLA8K3-ykM2ckwX2lubTg4/edit?usp=sharing
+base::TimeDelta WebSocketDispatcherHost::CalculateDelay() const {
+  int64_t f = num_failed_connections();
+  int64_t s = num_succeeded_connections();
+  int p = num_pending_connections();
+  return base::TimeDelta::FromMilliseconds(
+      base::RandInt(1000, 5000) *
+      (1 << std::min(p + f / (s + 1), INT64_C(16))) / 65536);
+}
+
+void WebSocketDispatcherHost::ThrottlingPeriodTimerCallback() {
+  num_previous_failed_connections_ = num_current_failed_connections_;
+  num_current_failed_connections_ = 0;
+
+  num_previous_succeeded_connections_ = num_current_succeeded_connections_;
+  num_current_succeeded_connections_ = 0;
+
+  if (num_pending_connections_ == 0 &&
+      num_previous_failed_connections_ == 0 &&
+      num_previous_succeeded_connections_ == 0) {
+    throttling_period_timer_.Stop();
+  }
+}
+
+}  // namespace content
diff --git a/content/browser/renderer_host/websocket_dispatcher_host.h b/content/browser/renderer_host/websocket_dispatcher_host.h
new file mode 100644
index 0000000..5d5c804
--- /dev/null
+++ b/content/browser/renderer_host/websocket_dispatcher_host.h
@@ -0,0 +1,212 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CONTENT_BROWSER_RENDERER_HOST_WEBSOCKET_DISPATCHER_HOST_H_
+#define CONTENT_BROWSER_RENDERER_HOST_WEBSOCKET_DISPATCHER_HOST_H_
+
+#include <stdint.h>
+#include <string>
+#include <vector>
+
+#include "base/callback.h"
+#include "base/compiler_specific.h"
+#include "base/containers/hash_tables.h"
+#include "base/macros.h"
+#include "base/memory/ref_counted.h"
+#include "base/time/time.h"
+#include "base/timer/timer.h"
+#include "content/common/content_export.h"
+#include "content/common/websocket.h"
+#include "content/public/browser/browser_message_filter.h"
+
+namespace net {
+class URLRequestContext;
+}  // namespace net
+
+namespace storage {
+class BlobStorageContext;
+}
+
+namespace content {
+
+class ChromeBlobStorageContext;
+class StoragePartition;
+struct WebSocketHandshakeRequest;
+struct WebSocketHandshakeResponse;
+class WebSocketHost;
+
+// Creates a WebSocketHost object for each WebSocket channel, and dispatches
+// WebSocketMsg_* messages sent from renderer to the appropriate WebSocketHost.
+class CONTENT_EXPORT WebSocketDispatcherHost : public BrowserMessageFilter {
+ public:
+  typedef base::Callback<net::URLRequestContext*()> GetRequestContextCallback;
+
+  // Given a routing_id and delay, WebSocketHostFactory returns a new
+  // instance of WebSocketHost or its subclass.
+  typedef base::Callback<WebSocketHost*(int, base::TimeDelta)>
+      WebSocketHostFactory;
+
+  // Return value for methods that may delete the WebSocketHost. This enum is
+  // binary-compatible with net::WebSocketEventInterface::ChannelState, to make
+  // conversion cheap. By using a separate enum including net/ header files can
+  // be avoided.
+  enum WebSocketHostState {
+    WEBSOCKET_HOST_ALIVE,
+    WEBSOCKET_HOST_DELETED
+  };
+
+  WebSocketDispatcherHost(int process_id,
+                          const GetRequestContextCallback& get_context_callback,
+                          ChromeBlobStorageContext* blob_storage_context,
+                          StoragePartition* storage_partition);
+
+  // BrowserMessageFilter:
+  bool OnMessageReceived(const IPC::Message& message) override;
+
+  // The following methods are used by WebSocketHost::EventInterface to send
+  // IPCs from the browser to the renderer or child process. Any of them may
+  // return WEBSOCKET_HOST_DELETED and delete the WebSocketHost on failure,
+  // leading to the WebSocketChannel and EventInterface also being deleted.
+
+  // Sends a WebSocketMsg_AddChannelResponse IPC.
+  WebSocketHostState SendAddChannelResponse(
+      int routing_id,
+      const std::string& selected_protocol,
+      const std::string& extensions) WARN_UNUSED_RESULT;
+
+  // Sends a WebSocketMsg_SendFrame IPC.
+  WebSocketHostState SendFrame(int routing_id,
+                               bool fin,
+                               WebSocketMessageType type,
+                               const std::vector<char>& data);
+
+  // Sends a WebSocketMsg_FlowControl IPC.
+  WebSocketHostState SendFlowControl(int routing_id,
+                                     int64_t quota) WARN_UNUSED_RESULT;
+
+  // Sends a WebSocketMsg_NotifyClosing IPC
+  WebSocketHostState NotifyClosingHandshake(int routing_id) WARN_UNUSED_RESULT;
+
+  // Sends a WebSocketMsg_NotifyStartOpeningHandshake IPC.
+  WebSocketHostState NotifyStartOpeningHandshake(
+      int routing_id,
+      const WebSocketHandshakeRequest& request) WARN_UNUSED_RESULT;
+
+  // Sends a WebSocketMsg_NotifyFinishOpeningHandshake IPC.
+  WebSocketHostState NotifyFinishOpeningHandshake(
+      int routing_id,
+      const WebSocketHandshakeResponse& response) WARN_UNUSED_RESULT;
+
+  // Sends a WebSocketMsg_NotifyFailure IPC and deletes and unregisters the
+  // channel.
+  WebSocketHostState NotifyFailure(
+      int routing_id,
+      const std::string& message) WARN_UNUSED_RESULT;
+
+  WebSocketHostState BlobSendComplete(int routing_id);
+
+  // Sends a WebSocketMsg_DropChannel IPC and deletes and unregisters the
+  // channel.
+  WebSocketHostState DoDropChannel(int routing_id,
+                                   bool was_clean,
+                                   uint16_t code,
+                                   const std::string& reason)
+      WARN_UNUSED_RESULT;
+
+  // Returns whether the associated renderer process can read raw cookies.
+  bool CanReadRawCookies() const;
+
+  int render_process_id() const { return process_id_; }
+
+  // Returns a BlobStorageContext associated with this object's render process.
+  // The pointer will be valid for as long this object is.
+  storage::BlobStorageContext* blob_storage_context() const;
+
+  // Returns the StoragePartition associated with this render process.
+  StoragePartition* storage_partition() const { return storage_partition_; }
+
+ protected:
+  // For testing. Specify a factory method that creates mock version of
+  // WebSocketHost.
+  WebSocketDispatcherHost(int process_id,
+                          const GetRequestContextCallback& get_context_callback,
+                          const WebSocketHostFactory& websocket_host_factory);
+
+  int num_pending_connections() const { return num_pending_connections_; }
+
+  // The number of handshakes that failed/succeeded in the current and
+  // previous time period, respectively.
+  int64_t num_failed_connections() const;
+  int64_t num_succeeded_connections() const;
+
+  ~WebSocketDispatcherHost() override;
+
+ private:
+  typedef base::hash_map<int, WebSocketHost*> WebSocketHostTable;
+
+  WebSocketHost* CreateWebSocketHost(int routing_id, base::TimeDelta delay);
+
+  // Looks up a WebSocketHost object by |routing_id|. Returns the object if one
+  // is found, or NULL otherwise.
+  WebSocketHost* GetHost(int routing_id) const;
+
+  // Sends the passed in IPC::Message via the BrowserMessageFilter::Send()
+  // method. If sending the IPC fails, assumes that this connection is no
+  // longer useable, calls DeleteWebSocketHost(), and returns
+  // WEBSOCKET_HOST_DELETED. The behaviour is the same for all message types.
+  WebSocketHostState SendOrDrop(IPC::Message* message) WARN_UNUSED_RESULT;
+
+  // Deletes the WebSocketHost object associated with the given |routing_id| and
+  // removes it from the |hosts_| table.
+  void DeleteWebSocketHost(int routing_id);
+
+  // Calculates the delay for per-renderer WebSocket throttling.
+  base::TimeDelta CalculateDelay() const;
+
+  // Rotates the counts of successful and failed connections for current
+  // and previous time periods. Called every two minutes while the counts
+  // are non-zero.
+  void ThrottlingPeriodTimerCallback();
+
+  // Table of WebSocketHost objects, owned by this object, indexed by
+  // routing_id.
+  WebSocketHostTable hosts_;
+
+  // The the process ID of the associated renderer process.
+  const int process_id_;
+
+  // A callback which returns the appropriate net::URLRequestContext for us to
+  // use.
+  GetRequestContextCallback get_context_callback_;
+
+  WebSocketHostFactory websocket_host_factory_;
+
+  // Timer and counters for per-renderer WebSocket throttling.
+  base::RepeatingTimer throttling_period_timer_;
+
+  // The current number of pending connections.
+  int num_pending_connections_;
+
+  // The number of handshakes that failed in the current and previous time
+  // period.
+  int64_t num_current_succeeded_connections_;
+  int64_t num_previous_succeeded_connections_;
+
+  // The number of handshakes that succeeded in the current and previous time
+  // period.
+  int64_t num_current_failed_connections_;
+  int64_t num_previous_failed_connections_;
+
+  // Needed to read from blobs for browser-side blob sending.
+  const scoped_refptr<const ChromeBlobStorageContext> blob_storage_context_;
+
+  // Needed to access to the StoragePartition for browser-side blob sending.
+  StoragePartition* const storage_partition_;
+
+  DISALLOW_COPY_AND_ASSIGN(WebSocketDispatcherHost);
+};
+
+}  // namespace content
+
+#endif  // CONTENT_BROWSER_RENDERER_HOST_WEBSOCKET_DISPATCHER_HOST_H_
diff --git a/content/browser/renderer_host/websocket_dispatcher_host_unittest.cc b/content/browser/renderer_host/websocket_dispatcher_host_unittest.cc
new file mode 100644
index 0000000..4fd1f5c
--- /dev/null
+++ b/content/browser/renderer_host/websocket_dispatcher_host_unittest.cc
@@ -0,0 +1,468 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "content/browser/renderer_host/websocket_dispatcher_host.h"
+
+#include <algorithm>
+#include <vector>
+
+#include "base/bind.h"
+#include "base/bind_helpers.h"
+#include "base/memory/ref_counted.h"
+#include "base/memory/weak_ptr.h"
+#include "base/message_loop/message_loop.h"
+#include "content/browser/renderer_host/websocket_host.h"
+#include "content/common/websocket.h"
+#include "content/common/websocket_messages.h"
+#include "ipc/ipc_message.h"
+#include "net/websockets/websocket_errors.h"
+#include "testing/gtest/include/gtest/gtest.h"
+#include "url/gurl.h"
+#include "url/origin.h"
+
+namespace content {
+namespace {
+
+// This number is unlikely to occur by chance.
+static const int kMagicRenderProcessId = 506116062;
+
+class WebSocketDispatcherHostTest;
+
+// A mock of WebsocketHost which records received messages.
+class MockWebSocketHost : public WebSocketHost {
+ public:
+  MockWebSocketHost(int routing_id,
+                    WebSocketDispatcherHost* dispatcher,
+                    net::URLRequestContext* url_request_context,
+                    base::TimeDelta delay,
+                    WebSocketDispatcherHostTest* owner);
+
+  ~MockWebSocketHost() override {}
+
+  bool OnMessageReceived(const IPC::Message& message) override {
+    received_messages_.push_back(message);
+    switch (message.type()) {
+      case WebSocketMsg_DropChannel::ID:
+        // Needed for PerRendererThrottlingFailedHandshakes, because without
+        // calling WebSocketHost::OnMessageReceived() (and thus
+        // WebSocketHost::OnDropChannel()), the connection stays pending and
+        // we cannot test per-renderer throttling with failed connections.
+        return WebSocketHost::OnMessageReceived(message);
+
+      default:
+        return true;
+    }
+  }
+
+  void GoAway() override;
+
+  std::vector<IPC::Message> received_messages_;
+  base::WeakPtr<WebSocketDispatcherHostTest> owner_;
+  base::TimeDelta delay_;
+};
+
+class TestingWebSocketDispatcherHost : public WebSocketDispatcherHost {
+ public:
+  TestingWebSocketDispatcherHost(
+      int process_id,
+      const GetRequestContextCallback& get_context_callback,
+      const WebSocketHostFactory& websocket_host_factory)
+      : WebSocketDispatcherHost(process_id,
+                                get_context_callback,
+                                websocket_host_factory) {}
+
+  // This is needed because BrowserMessageFilter::Send() tries post the task to
+  // the IO thread, which doesn't exist in the context of these tests.
+  bool Send(IPC::Message* message) override {
+    delete message;
+    return true;
+  }
+
+  using WebSocketDispatcherHost::num_pending_connections;
+  using WebSocketDispatcherHost::num_failed_connections;
+  using WebSocketDispatcherHost::num_succeeded_connections;
+
+ private:
+  ~TestingWebSocketDispatcherHost() override {}
+};
+
+class WebSocketDispatcherHostTest : public ::testing::Test {
+ public:
+  WebSocketDispatcherHostTest()
+      : next_routing_id_(123),
+        weak_ptr_factory_(this) {
+    dispatcher_host_ = new TestingWebSocketDispatcherHost(
+        kMagicRenderProcessId,
+        base::Bind(&WebSocketDispatcherHostTest::OnGetRequestContext,
+                   base::Unretained(this)),
+        base::Bind(&WebSocketDispatcherHostTest::CreateWebSocketHost,
+                   base::Unretained(this)));
+  }
+
+  ~WebSocketDispatcherHostTest() override {
+    // We need to invalidate the issued WeakPtrs at the beginning of the
+    // destructor in order not to access destructed member variables.
+    weak_ptr_factory_.InvalidateWeakPtrs();
+  }
+
+  void GoAway(int routing_id) {
+    gone_hosts_.push_back(routing_id);
+  }
+
+  base::WeakPtr<WebSocketDispatcherHostTest> GetWeakPtr() {
+    return weak_ptr_factory_.GetWeakPtr();
+  }
+
+ protected:
+  // Adds |n| connections. Returns true if succeeded.
+  bool AddMultipleChannels(int number_of_channels) {
+    for (int i = 0; i < number_of_channels; ++i) {
+      int routing_id = next_routing_id_++;
+
+      WebSocketHostMsg_AddChannelRequest_Params params;
+      params.socket_url = GURL("ws://example.com/test");
+      params.origin = url::Origin(GURL("http://example.com"));
+      params.first_party_for_cookies = GURL("http://example.com");
+      params.user_agent_override = "";
+      params.render_frame_id = -3;
+
+      WebSocketHostMsg_AddChannelRequest message(routing_id, params);
+      if (!dispatcher_host_->OnMessageReceived(message))
+        return false;
+    }
+
+    return true;
+  }
+
+  // Adds and cancels |n| connections. Returns true if succeeded.
+  bool AddAndCancelMultipleChannels(int number_of_channels) {
+    for (int i = 0; i < number_of_channels; ++i) {
+      int routing_id = next_routing_id_++;
+
+      WebSocketHostMsg_AddChannelRequest_Params params;
+      params.socket_url = GURL("ws://example.com/test");
+      params.origin = url::Origin(GURL("http://example.com"));
+      params.first_party_for_cookies = GURL("http://example.com");
+      params.user_agent_override = "";
+      params.render_frame_id = -3;
+
+      WebSocketHostMsg_AddChannelRequest messageAddChannelRequest(
+          routing_id, params);
+      if (!dispatcher_host_->OnMessageReceived(messageAddChannelRequest))
+        return false;
+
+      WebSocketMsg_DropChannel messageDropChannel(
+          routing_id, false, net::kWebSocketErrorAbnormalClosure, "");
+      if (!dispatcher_host_->OnMessageReceived(messageDropChannel))
+        return false;
+    }
+
+    return true;
+  }
+
+  scoped_refptr<TestingWebSocketDispatcherHost> dispatcher_host_;
+
+  // Stores allocated MockWebSocketHost instances. Doesn't take ownership of
+  // them.
+  std::vector<MockWebSocketHost*> mock_hosts_;
+  std::vector<int> gone_hosts_;
+
+ private:
+  net::URLRequestContext* OnGetRequestContext() {
+    return NULL;
+  }
+
+  WebSocketHost* CreateWebSocketHost(int routing_id, base::TimeDelta delay) {
+    MockWebSocketHost* host = new MockWebSocketHost(
+        routing_id, dispatcher_host_.get(), NULL, delay, this);
+    mock_hosts_.push_back(host);
+    return host;
+  }
+
+  base::MessageLoop message_loop_;
+
+  int next_routing_id_;
+
+  base::WeakPtrFactory<WebSocketDispatcherHostTest> weak_ptr_factory_;
+};
+
+MockWebSocketHost::MockWebSocketHost(
+    int routing_id,
+    WebSocketDispatcherHost* dispatcher,
+    net::URLRequestContext* url_request_context,
+    base::TimeDelta delay,
+    WebSocketDispatcherHostTest* owner)
+    : WebSocketHost(routing_id, dispatcher, url_request_context, delay),
+      owner_(owner->GetWeakPtr()),
+      delay_(delay) {}
+
+void MockWebSocketHost::GoAway() {
+  if (owner_)
+    owner_->GoAway(routing_id());
+}
+
+TEST_F(WebSocketDispatcherHostTest, Construct) {
+  // Do nothing.
+}
+
+TEST_F(WebSocketDispatcherHostTest, UnrelatedMessage) {
+  IPC::Message message;
+  EXPECT_FALSE(dispatcher_host_->OnMessageReceived(message));
+}
+
+TEST_F(WebSocketDispatcherHostTest, RenderProcessIdGetter) {
+  EXPECT_EQ(kMagicRenderProcessId, dispatcher_host_->render_process_id());
+}
+
+TEST_F(WebSocketDispatcherHostTest, AddChannelRequest) {
+  int routing_id = 123;
+  std::vector<std::string> requested_protocols;
+  requested_protocols.push_back("hello");
+
+  WebSocketHostMsg_AddChannelRequest_Params params;
+  params.socket_url = GURL("ws://example.com/test");
+  params.requested_protocols = requested_protocols;
+  params.origin = url::Origin(GURL("http://example.com"));
+  params.first_party_for_cookies = GURL("http://example.com");
+  params.user_agent_override = "";
+  params.render_frame_id = -2;
+
+  WebSocketHostMsg_AddChannelRequest message(routing_id, params);
+
+  ASSERT_TRUE(dispatcher_host_->OnMessageReceived(message));
+
+  ASSERT_EQ(1U, mock_hosts_.size());
+  MockWebSocketHost* host = mock_hosts_[0];
+
+  ASSERT_EQ(1U, host->received_messages_.size());
+  const IPC::Message& forwarded_message = host->received_messages_[0];
+  EXPECT_EQ(WebSocketHostMsg_AddChannelRequest::ID, forwarded_message.type());
+  EXPECT_EQ(routing_id, forwarded_message.routing_id());
+}
+
+TEST_F(WebSocketDispatcherHostTest, SendFrameButNoHostYet) {
+  int routing_id = 123;
+  std::vector<char> data;
+  WebSocketMsg_SendFrame message(
+      routing_id, true, WEB_SOCKET_MESSAGE_TYPE_TEXT, data);
+
+  // Expected to be ignored.
+  EXPECT_TRUE(dispatcher_host_->OnMessageReceived(message));
+
+  EXPECT_EQ(0U, mock_hosts_.size());
+}
+
+TEST_F(WebSocketDispatcherHostTest, SendFrame) {
+  int routing_id = 123;
+
+  std::vector<std::string> requested_protocols;
+  requested_protocols.push_back("hello");
+
+  WebSocketHostMsg_AddChannelRequest_Params params;
+  params.socket_url = GURL("ws://example.com/test");
+  params.requested_protocols = requested_protocols;
+  params.origin = url::Origin(GURL("http://example.com"));
+  params.first_party_for_cookies = GURL("http://example.com");
+  params.user_agent_override = "";
+  params.render_frame_id = -2;
+
+  WebSocketHostMsg_AddChannelRequest add_channel_message(routing_id, params);
+
+  ASSERT_TRUE(dispatcher_host_->OnMessageReceived(add_channel_message));
+
+  std::vector<char> data;
+  WebSocketMsg_SendFrame send_frame_message(
+      routing_id, true, WEB_SOCKET_MESSAGE_TYPE_TEXT, data);
+
+  EXPECT_TRUE(dispatcher_host_->OnMessageReceived(send_frame_message));
+
+  ASSERT_EQ(1U, mock_hosts_.size());
+  MockWebSocketHost* host = mock_hosts_[0];
+
+  ASSERT_EQ(2U, host->received_messages_.size());
+  {
+    const IPC::Message& forwarded_message = host->received_messages_[0];
+    EXPECT_EQ(WebSocketHostMsg_AddChannelRequest::ID, forwarded_message.type());
+    EXPECT_EQ(routing_id, forwarded_message.routing_id());
+  }
+  {
+    const IPC::Message& forwarded_message = host->received_messages_[1];
+    EXPECT_EQ(WebSocketMsg_SendFrame::ID, forwarded_message.type());
+    EXPECT_EQ(routing_id, forwarded_message.routing_id());
+  }
+}
+
+TEST_F(WebSocketDispatcherHostTest, Destruct) {
+  WebSocketHostMsg_AddChannelRequest_Params params1;
+  params1.socket_url = GURL("ws://example.com/test");
+  params1.requested_protocols = std::vector<std::string>();
+  params1.origin = url::Origin(GURL("http://example.com"));
+  params1.first_party_for_cookies = GURL("http://example.com");
+  params1.user_agent_override = "";
+  params1.render_frame_id = -1;
+
+  WebSocketHostMsg_AddChannelRequest message1(123, params1);
+
+  WebSocketHostMsg_AddChannelRequest_Params params2;
+  params2.socket_url = GURL("ws://example.com/test2");
+  params2.requested_protocols = std::vector<std::string>();
+  params2.origin = url::Origin(GURL("http://example.com"));
+  params2.first_party_for_cookies = GURL("http://example.com");
+  params2.user_agent_override = "";
+  params2.render_frame_id = -1;
+
+  WebSocketHostMsg_AddChannelRequest message2(456, params2);
+
+  ASSERT_TRUE(dispatcher_host_->OnMessageReceived(message1));
+  ASSERT_TRUE(dispatcher_host_->OnMessageReceived(message2));
+
+  ASSERT_EQ(2u, mock_hosts_.size());
+
+  mock_hosts_.clear();
+  dispatcher_host_ = NULL;
+
+  ASSERT_EQ(2u, gone_hosts_.size());
+  // The gone_hosts_ ordering is not predictable because it depends on the
+  // hash_map ordering.
+  std::sort(gone_hosts_.begin(), gone_hosts_.end());
+  EXPECT_EQ(123, gone_hosts_[0]);
+  EXPECT_EQ(456, gone_hosts_[1]);
+}
+
+TEST_F(WebSocketDispatcherHostTest, DelayFor4thPendingConnectionIsZero) {
+  ASSERT_TRUE(AddMultipleChannels(4));
+
+  EXPECT_EQ(4, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+
+  ASSERT_EQ(4U, mock_hosts_.size());
+  EXPECT_EQ(base::TimeDelta(), mock_hosts_[3]->delay_);
+}
+
+TEST_F(WebSocketDispatcherHostTest, DelayFor8thPendingConnectionIsNonZero) {
+  ASSERT_TRUE(AddMultipleChannels(8));
+
+  EXPECT_EQ(8, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+
+  ASSERT_EQ(8U, mock_hosts_.size());
+  EXPECT_LT(base::TimeDelta(), mock_hosts_[7]->delay_);
+}
+
+TEST_F(WebSocketDispatcherHostTest, DelayFor17thPendingConnection) {
+  ASSERT_TRUE(AddMultipleChannels(17));
+
+  EXPECT_EQ(17, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+
+  ASSERT_EQ(17U, mock_hosts_.size());
+  EXPECT_LE(base::TimeDelta::FromMilliseconds(1000), mock_hosts_[16]->delay_);
+  EXPECT_GE(base::TimeDelta::FromMilliseconds(5000), mock_hosts_[16]->delay_);
+}
+
+// The 256th connection is rejected by per-renderer WebSocket throttling.
+// This is not counted as a failure.
+TEST_F(WebSocketDispatcherHostTest, Rejects256thPendingConnection) {
+  ASSERT_TRUE(AddMultipleChannels(256));
+
+  EXPECT_EQ(255, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+
+  ASSERT_EQ(255U, mock_hosts_.size());
+}
+
+TEST_F(WebSocketDispatcherHostTest, DelayIsZeroAfter3FailedConnections) {
+  ASSERT_TRUE(AddAndCancelMultipleChannels(3));
+
+  EXPECT_EQ(0, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(3, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+
+  ASSERT_TRUE(AddMultipleChannels(1));
+
+  ASSERT_EQ(4U, mock_hosts_.size());
+  EXPECT_EQ(base::TimeDelta(), mock_hosts_[3]->delay_);
+}
+
+TEST_F(WebSocketDispatcherHostTest, DelayIsNonZeroAfter7FailedConnections) {
+  ASSERT_TRUE(AddAndCancelMultipleChannels(7));
+
+  EXPECT_EQ(0, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(7, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+
+  ASSERT_TRUE(AddMultipleChannels(1));
+
+  ASSERT_EQ(8U, mock_hosts_.size());
+  EXPECT_LT(base::TimeDelta(), mock_hosts_[7]->delay_);
+}
+
+TEST_F(WebSocketDispatcherHostTest, DelayAfter16FailedConnections) {
+  ASSERT_TRUE(AddAndCancelMultipleChannels(16));
+
+  EXPECT_EQ(0, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(16, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+
+  ASSERT_TRUE(AddMultipleChannels(1));
+
+  ASSERT_EQ(17U, mock_hosts_.size());
+  EXPECT_LE(base::TimeDelta::FromMilliseconds(1000), mock_hosts_[16]->delay_);
+  EXPECT_GE(base::TimeDelta::FromMilliseconds(5000), mock_hosts_[16]->delay_);
+}
+
+TEST_F(WebSocketDispatcherHostTest, NotRejectedAfter255FailedConnections) {
+  ASSERT_TRUE(AddAndCancelMultipleChannels(255));
+
+  EXPECT_EQ(0, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(255, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+
+  ASSERT_TRUE(AddMultipleChannels(1));
+
+  EXPECT_EQ(1, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(255, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+}
+
+// This is a regression test for https://crrev.com/998173003/.
+TEST_F(WebSocketDispatcherHostTest, InvalidScheme) {
+  int routing_id = 123;
+
+  std::vector<std::string> requested_protocols;
+  requested_protocols.push_back("hello");
+
+  WebSocketHostMsg_AddChannelRequest_Params params;
+  params.socket_url = GURL("http://example.com/test");
+  params.requested_protocols = requested_protocols;
+  params.origin = url::Origin(GURL("http://example.com"));
+  params.first_party_for_cookies = GURL("http://example.com");
+  params.user_agent_override = "";
+  params.render_frame_id = -2;
+
+  WebSocketHostMsg_AddChannelRequest message(routing_id, params);
+
+  ASSERT_TRUE(dispatcher_host_->OnMessageReceived(message));
+
+  ASSERT_EQ(1U, mock_hosts_.size());
+  MockWebSocketHost* host = mock_hosts_[0];
+
+  // Tests that WebSocketHost::OnMessageReceived() doesn't cause a crash and
+  // the connection with an invalid scheme fails here.
+  // We call WebSocketHost::OnMessageReceived() here explicitly because
+  // MockWebSocketHost does not call WebSocketHost::OnMessageReceived() for
+  // WebSocketHostMsg_AddChannelRequest.
+  host->WebSocketHost::OnMessageReceived(message);
+
+  EXPECT_EQ(0, dispatcher_host_->num_pending_connections());
+  EXPECT_EQ(1, dispatcher_host_->num_failed_connections());
+  EXPECT_EQ(0, dispatcher_host_->num_succeeded_connections());
+}
+
+}  // namespace
+}  // namespace content
diff --git a/content/browser/renderer_host/websocket_host.cc b/content/browser/renderer_host/websocket_host.cc
new file mode 100644
index 0000000..513789a
--- /dev/null
+++ b/content/browser/renderer_host/websocket_host.cc
@@ -0,0 +1,606 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "content/browser/renderer_host/websocket_host.h"
+
+#include <inttypes.h>
+
+#include <utility>
+
+#include "base/bind.h"
+#include "base/bind_helpers.h"
+#include "base/location.h"
+#include "base/logging.h"
+#include "base/macros.h"
+#include "base/memory/ptr_util.h"
+#include "base/single_thread_task_runner.h"
+#include "base/strings/string_util.h"
+#include "base/strings/stringprintf.h"
+#include "base/threading/thread_task_runner_handle.h"
+#include "content/browser/bad_message.h"
+#include "content/browser/renderer_host/websocket_blob_sender.h"
+#include "content/browser/renderer_host/websocket_dispatcher_host.h"
+#include "content/browser/ssl/ssl_error_handler.h"
+#include "content/browser/ssl/ssl_manager.h"
+#include "content/common/websocket_messages.h"
+#include "content/public/browser/browser_thread.h"
+#include "content/public/browser/render_frame_host.h"
+#include "content/public/browser/storage_partition.h"
+#include "ipc/ipc_message_macros.h"
+#include "net/base/net_errors.h"
+#include "net/http/http_request_headers.h"
+#include "net/http/http_response_headers.h"
+#include "net/http/http_util.h"
+#include "net/ssl/ssl_info.h"
+#include "net/websockets/websocket_channel.h"
+#include "net/websockets/websocket_errors.h"
+#include "net/websockets/websocket_event_interface.h"
+#include "net/websockets/websocket_frame.h"  // for WebSocketFrameHeader::OpCode
+#include "net/websockets/websocket_handshake_request_info.h"
+#include "net/websockets/websocket_handshake_response_info.h"
+#include "url/origin.h"
+
+namespace content {
+
+namespace {
+
+typedef net::WebSocketEventInterface::ChannelState ChannelState;
+
+// Convert a content::WebSocketMessageType to a
+// net::WebSocketFrameHeader::OpCode
+net::WebSocketFrameHeader::OpCode MessageTypeToOpCode(
+    WebSocketMessageType type) {
+  DCHECK(type == WEB_SOCKET_MESSAGE_TYPE_CONTINUATION ||
+         type == WEB_SOCKET_MESSAGE_TYPE_TEXT ||
+         type == WEB_SOCKET_MESSAGE_TYPE_BINARY);
+  typedef net::WebSocketFrameHeader::OpCode OpCode;
+  // These compile asserts verify that the same underlying values are used for
+  // both types, so we can simply cast between them.
+  static_assert(static_cast<OpCode>(WEB_SOCKET_MESSAGE_TYPE_CONTINUATION) ==
+                    net::WebSocketFrameHeader::kOpCodeContinuation,
+                "enum values must match for opcode continuation");
+  static_assert(static_cast<OpCode>(WEB_SOCKET_MESSAGE_TYPE_TEXT) ==
+                    net::WebSocketFrameHeader::kOpCodeText,
+                "enum values must match for opcode text");
+  static_assert(static_cast<OpCode>(WEB_SOCKET_MESSAGE_TYPE_BINARY) ==
+                    net::WebSocketFrameHeader::kOpCodeBinary,
+                "enum values must match for opcode binary");
+  return static_cast<OpCode>(type);
+}
+
+WebSocketMessageType OpCodeToMessageType(
+    net::WebSocketFrameHeader::OpCode opCode) {
+  DCHECK(opCode == net::WebSocketFrameHeader::kOpCodeContinuation ||
+         opCode == net::WebSocketFrameHeader::kOpCodeText ||
+         opCode == net::WebSocketFrameHeader::kOpCodeBinary);
+  // This cast is guaranteed valid by the static_assert() statements above.
+  return static_cast<WebSocketMessageType>(opCode);
+}
+
+ChannelState StateCast(WebSocketDispatcherHost::WebSocketHostState host_state) {
+  const WebSocketDispatcherHost::WebSocketHostState WEBSOCKET_HOST_ALIVE =
+      WebSocketDispatcherHost::WEBSOCKET_HOST_ALIVE;
+  const WebSocketDispatcherHost::WebSocketHostState WEBSOCKET_HOST_DELETED =
+      WebSocketDispatcherHost::WEBSOCKET_HOST_DELETED;
+
+  DCHECK(host_state == WEBSOCKET_HOST_ALIVE ||
+         host_state == WEBSOCKET_HOST_DELETED);
+  // These compile asserts verify that we can get away with using static_cast<>
+  // for the conversion.
+  static_assert(static_cast<ChannelState>(WEBSOCKET_HOST_ALIVE) ==
+                    net::WebSocketEventInterface::CHANNEL_ALIVE,
+                "enum values must match for state_alive");
+  static_assert(static_cast<ChannelState>(WEBSOCKET_HOST_DELETED) ==
+                    net::WebSocketEventInterface::CHANNEL_DELETED,
+                "enum values must match for state_deleted");
+  return static_cast<ChannelState>(host_state);
+}
+
+// Implementation of WebSocketBlobSender::Channel
+class SendChannelImpl final : public WebSocketBlobSender::Channel {
+ public:
+  explicit SendChannelImpl(net::WebSocketChannel* channel)
+      : channel_(channel) {}
+
+  // Implementation of WebSocketBlobSender::Channel
+  size_t GetSendQuota() const override {
+    return static_cast<size_t>(channel_->current_send_quota());
+  }
+
+  ChannelState SendFrame(bool fin, const std::vector<char>& data) override {
+    int opcode = first_frame_ ? net::WebSocketFrameHeader::kOpCodeBinary
+                              : net::WebSocketFrameHeader::kOpCodeContinuation;
+    first_frame_ = false;
+    return channel_->SendFrame(fin, opcode, data);
+  }
+
+ private:
+  net::WebSocketChannel* channel_;
+  bool first_frame_ = true;
+
+  DISALLOW_COPY_AND_ASSIGN(SendChannelImpl);
+};
+
+}  // namespace
+
+// Implementation of net::WebSocketEventInterface. Receives events from our
+// WebSocketChannel object. Each event is translated to an IPC and sent to the
+// renderer or child process via WebSocketDispatcherHost.
+class WebSocketHost::WebSocketEventHandler final
+    : public net::WebSocketEventInterface {
+ public:
+  WebSocketEventHandler(WebSocketDispatcherHost* dispatcher,
+                        WebSocketHost* host,
+                        int routing_id,
+                        int render_frame_id);
+  ~WebSocketEventHandler() override;
+
+  // net::WebSocketEventInterface implementation
+
+  ChannelState OnAddChannelResponse(const std::string& selected_subprotocol,
+                                    const std::string& extensions) override;
+  ChannelState OnDataFrame(bool fin,
+                           WebSocketMessageType type,
+                           const std::vector<char>& data) override;
+  ChannelState OnClosingHandshake() override;
+  ChannelState OnFlowControl(int64_t quota) override;
+  ChannelState OnDropChannel(bool was_clean,
+                             uint16_t code,
+                             const std::string& reason) override;
+  ChannelState OnFailChannel(const std::string& message) override;
+  ChannelState OnStartOpeningHandshake(
+      std::unique_ptr<net::WebSocketHandshakeRequestInfo> request) override;
+  ChannelState OnFinishOpeningHandshake(
+      std::unique_ptr<net::WebSocketHandshakeResponseInfo> response) override;
+  ChannelState OnSSLCertificateError(
+      std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks>
+          callbacks,
+      const GURL& url,
+      const net::SSLInfo& ssl_info,
+      bool fatal) override;
+
+ private:
+  class SSLErrorHandlerDelegate final : public SSLErrorHandler::Delegate {
+   public:
+    SSLErrorHandlerDelegate(
+        std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks>
+            callbacks);
+    ~SSLErrorHandlerDelegate() override;
+
+    base::WeakPtr<SSLErrorHandler::Delegate> GetWeakPtr();
+
+    // SSLErrorHandler::Delegate methods
+    void CancelSSLRequest(int error, const net::SSLInfo* ssl_info) override;
+    void ContinueSSLRequest() override;
+
+   private:
+    std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks> callbacks_;
+    base::WeakPtrFactory<SSLErrorHandlerDelegate> weak_ptr_factory_;
+
+    DISALLOW_COPY_AND_ASSIGN(SSLErrorHandlerDelegate);
+  };
+
+  WebSocketDispatcherHost* const dispatcher_;
+  WebSocketHost* const host_;
+  const int routing_id_;
+  const int render_frame_id_;
+  std::unique_ptr<SSLErrorHandlerDelegate> ssl_error_handler_delegate_;
+
+  DISALLOW_COPY_AND_ASSIGN(WebSocketEventHandler);
+};
+
+WebSocketHost::WebSocketEventHandler::WebSocketEventHandler(
+    WebSocketDispatcherHost* dispatcher,
+    WebSocketHost* host,
+    int routing_id,
+    int render_frame_id)
+    : dispatcher_(dispatcher),
+      host_(host),
+      routing_id_(routing_id),
+      render_frame_id_(render_frame_id) {}
+
+WebSocketHost::WebSocketEventHandler::~WebSocketEventHandler() {
+  DVLOG(1) << "WebSocketEventHandler destroyed routing_id=" << routing_id_;
+}
+
+ChannelState WebSocketHost::WebSocketEventHandler::OnAddChannelResponse(
+    const std::string& selected_protocol,
+    const std::string& extensions) {
+  DVLOG(3) << "WebSocketEventHandler::OnAddChannelResponse"
+           << " routing_id=" << routing_id_
+           << " selected_protocol=\"" << selected_protocol << "\""
+           << " extensions=\"" << extensions << "\"";
+
+  return StateCast(dispatcher_->SendAddChannelResponse(
+      routing_id_, selected_protocol, extensions));
+}
+
+ChannelState WebSocketHost::WebSocketEventHandler::OnDataFrame(
+    bool fin,
+    net::WebSocketFrameHeader::OpCode type,
+    const std::vector<char>& data) {
+  DVLOG(3) << "WebSocketEventHandler::OnDataFrame"
+           << " routing_id=" << routing_id_ << " fin=" << fin
+           << " type=" << type << " data is " << data.size() << " bytes";
+
+  return StateCast(dispatcher_->SendFrame(routing_id_, fin,
+                                          OpCodeToMessageType(type), data));
+}
+
+ChannelState WebSocketHost::WebSocketEventHandler::OnClosingHandshake() {
+  DVLOG(3) << "WebSocketEventHandler::OnClosingHandshake"
+           << " routing_id=" << routing_id_;
+
+  return StateCast(dispatcher_->NotifyClosingHandshake(routing_id_));
+}
+
+ChannelState WebSocketHost::WebSocketEventHandler::OnFlowControl(
+    int64_t quota) {
+  DVLOG(3) << "WebSocketEventHandler::OnFlowControl"
+           << " routing_id=" << routing_id_ << " quota=" << quota;
+
+  if (host_->blob_sender_)
+    host_->blob_sender_->OnNewSendQuota();
+  return StateCast(dispatcher_->SendFlowControl(routing_id_, quota));
+}
+
+ChannelState WebSocketHost::WebSocketEventHandler::OnDropChannel(
+    bool was_clean,
+    uint16_t code,
+    const std::string& reason) {
+  DVLOG(3) << "WebSocketEventHandler::OnDropChannel"
+           << " routing_id=" << routing_id_ << " was_clean=" << was_clean
+           << " code=" << code << " reason=\"" << reason << "\"";
+
+  return StateCast(
+      dispatcher_->DoDropChannel(routing_id_, was_clean, code, reason));
+}
+
+ChannelState WebSocketHost::WebSocketEventHandler::OnFailChannel(
+    const std::string& message) {
+  DVLOG(3) << "WebSocketEventHandler::OnFailChannel"
+           << " routing_id=" << routing_id_ << " message=\"" << message << "\"";
+
+  return StateCast(dispatcher_->NotifyFailure(routing_id_, message));
+}
+
+ChannelState WebSocketHost::WebSocketEventHandler::OnStartOpeningHandshake(
+    std::unique_ptr<net::WebSocketHandshakeRequestInfo> request) {
+  bool should_send = dispatcher_->CanReadRawCookies();
+  DVLOG(3) << "WebSocketEventHandler::OnStartOpeningHandshake "
+           << "should_send=" << should_send;
+
+  if (!should_send)
+    return WebSocketEventInterface::CHANNEL_ALIVE;
+
+  WebSocketHandshakeRequest request_to_pass;
+  request_to_pass.url.Swap(&request->url);
+  net::HttpRequestHeaders::Iterator it(request->headers);
+  while (it.GetNext())
+    request_to_pass.headers.push_back(std::make_pair(it.name(), it.value()));
+  request_to_pass.headers_text =
+      base::StringPrintf("GET %s HTTP/1.1\r\n",
+                         request_to_pass.url.spec().c_str()) +
+      request->headers.ToString();
+  request_to_pass.request_time = request->request_time;
+
+  return StateCast(
+      dispatcher_->NotifyStartOpeningHandshake(routing_id_, request_to_pass));
+}
+
+ChannelState WebSocketHost::WebSocketEventHandler::OnFinishOpeningHandshake(
+    std::unique_ptr<net::WebSocketHandshakeResponseInfo> response) {
+  bool should_send = dispatcher_->CanReadRawCookies();
+  DVLOG(3) << "WebSocketEventHandler::OnFinishOpeningHandshake "
+           << "should_send=" << should_send;
+
+  if (!should_send)
+    return WebSocketEventInterface::CHANNEL_ALIVE;
+
+  WebSocketHandshakeResponse response_to_pass;
+  response_to_pass.url.Swap(&response->url);
+  response_to_pass.status_code = response->status_code;
+  response_to_pass.status_text.swap(response->status_text);
+  size_t iter = 0;
+  std::string name, value;
+  while (response->headers->EnumerateHeaderLines(&iter, &name, &value))
+    response_to_pass.headers.push_back(std::make_pair(name, value));
+  response_to_pass.headers_text =
+      net::HttpUtil::ConvertHeadersBackToHTTPResponse(
+          response->headers->raw_headers());
+  response_to_pass.response_time = response->response_time;
+
+  return StateCast(
+      dispatcher_->NotifyFinishOpeningHandshake(routing_id_, response_to_pass));
+}
+
+ChannelState WebSocketHost::WebSocketEventHandler::OnSSLCertificateError(
+    std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks> callbacks,
+    const GURL& url,
+    const net::SSLInfo& ssl_info,
+    bool fatal) {
+  DVLOG(3) << "WebSocketEventHandler::OnSSLCertificateError"
+           << " routing_id=" << routing_id_ << " url=" << url.spec()
+           << " cert_status=" << ssl_info.cert_status << " fatal=" << fatal;
+  ssl_error_handler_delegate_.reset(
+      new SSLErrorHandlerDelegate(std::move(callbacks)));
+  SSLManager::OnSSLCertificateSubresourceError(
+      ssl_error_handler_delegate_->GetWeakPtr(), url,
+      dispatcher_->render_process_id(), render_frame_id_, ssl_info, fatal);
+  // The above method is always asynchronous.
+  return WebSocketEventInterface::CHANNEL_ALIVE;
+}
+
+WebSocketHost::WebSocketEventHandler::SSLErrorHandlerDelegate::
+    SSLErrorHandlerDelegate(
+        std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks>
+            callbacks)
+    : callbacks_(std::move(callbacks)), weak_ptr_factory_(this) {}
+
+WebSocketHost::WebSocketEventHandler::SSLErrorHandlerDelegate::
+    ~SSLErrorHandlerDelegate() {}
+
+base::WeakPtr<SSLErrorHandler::Delegate>
+WebSocketHost::WebSocketEventHandler::SSLErrorHandlerDelegate::GetWeakPtr() {
+  return weak_ptr_factory_.GetWeakPtr();
+}
+
+void WebSocketHost::WebSocketEventHandler::SSLErrorHandlerDelegate::
+    CancelSSLRequest(int error, const net::SSLInfo* ssl_info) {
+  DVLOG(3) << "SSLErrorHandlerDelegate::CancelSSLRequest"
+           << " error=" << error
+           << " cert_status=" << (ssl_info ? ssl_info->cert_status
+                                           : static_cast<net::CertStatus>(-1));
+  callbacks_->CancelSSLRequest(error, ssl_info);
+}
+
+void WebSocketHost::WebSocketEventHandler::SSLErrorHandlerDelegate::
+    ContinueSSLRequest() {
+  DVLOG(3) << "SSLErrorHandlerDelegate::ContinueSSLRequest";
+  callbacks_->ContinueSSLRequest();
+}
+
+WebSocketHost::WebSocketHost(int routing_id,
+                             WebSocketDispatcherHost* dispatcher,
+                             net::URLRequestContext* url_request_context,
+                             base::TimeDelta delay)
+    : dispatcher_(dispatcher),
+      url_request_context_(url_request_context),
+      routing_id_(routing_id),
+      delay_(delay),
+      pending_flow_control_quota_(0),
+      handshake_succeeded_(false),
+      weak_ptr_factory_(this) {
+  DVLOG(1) << "WebSocketHost: created routing_id=" << routing_id;
+}
+
+WebSocketHost::~WebSocketHost() {}
+
+void WebSocketHost::GoAway() {
+  OnDropChannel(false, static_cast<uint16_t>(net::kWebSocketErrorGoingAway),
+                "");
+}
+
+bool WebSocketHost::OnMessageReceived(const IPC::Message& message) {
+  bool handled = true;
+  IPC_BEGIN_MESSAGE_MAP(WebSocketHost, message)
+    IPC_MESSAGE_HANDLER(WebSocketHostMsg_AddChannelRequest, OnAddChannelRequest)
+    IPC_MESSAGE_HANDLER(WebSocketHostMsg_SendBlob, OnSendBlob)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_SendFrame, OnSendFrame)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_FlowControl, OnFlowControl)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_DropChannel, OnDropChannel)
+    IPC_MESSAGE_UNHANDLED(handled = false)
+  IPC_END_MESSAGE_MAP()
+  return handled;
+}
+
+void WebSocketHost::OnAddChannelRequest(
+    const WebSocketHostMsg_AddChannelRequest_Params& params) {
+  DVLOG(3) << "WebSocketHost::OnAddChannelRequest"
+           << " routing_id=" << routing_id_ << " socket_url=\""
+           << params.socket_url << "\" requested_protocols=\""
+           << base::JoinString(params.requested_protocols, ", ")
+           << "\" origin=\"" << params.origin
+           << "\" first_party_for_cookies=\""
+           << params.first_party_for_cookies << "\" user_agent_override=\""
+           << params.user_agent_override
+           << "\"";
+
+  DCHECK(!channel_);
+  if (delay_ > base::TimeDelta()) {
+    base::ThreadTaskRunnerHandle::Get()->PostDelayedTask(
+        FROM_HERE,
+        base::Bind(&WebSocketHost::AddChannel, weak_ptr_factory_.GetWeakPtr(),
+                   params.socket_url, params.requested_protocols,
+                   params.origin, params.first_party_for_cookies,
+                   params.user_agent_override, params.render_frame_id),
+        delay_);
+  } else {
+    AddChannel(
+        params.socket_url, params.requested_protocols, params.origin,
+        params.first_party_for_cookies, params.user_agent_override,
+        params.render_frame_id);
+  }
+  // |this| may have been deleted here.
+}
+
+void WebSocketHost::AddChannel(
+    const GURL& socket_url,
+    const std::vector<std::string>& requested_protocols,
+    const url::Origin& origin,
+    const GURL& first_party_for_cookies,
+    const std::string& user_agent_override,
+    int render_frame_id) {
+  DVLOG(3) << "WebSocketHost::AddChannel"
+           << " routing_id=" << routing_id_ << " socket_url=\"" << socket_url
+           << "\" requested_protocols=\""
+           << base::JoinString(requested_protocols, ", ") << "\" origin=\""
+           << origin << "\" first_party_for_cookies=\""
+           << first_party_for_cookies << "\" user_agent_override=\""
+           << user_agent_override << "\"";
+
+  DCHECK(!channel_);
+
+  std::unique_ptr<net::WebSocketEventInterface> event_interface(
+      new WebSocketEventHandler(dispatcher_, this, routing_id_,
+                                render_frame_id));
+  channel_.reset(new net::WebSocketChannel(std::move(event_interface),
+                                           url_request_context_));
+
+  if (pending_flow_control_quota_ > 0) {
+    // channel_->SendFlowControl(pending_flow_control_quota_) must be called
+    // after channel_->SendAddChannelRequest() below.
+    // We post OnFlowControl() here using |weak_ptr_factory_| instead of
+    // calling SendFlowControl directly, because |this| may have been deleted
+    // after channel_->SendAddChannelRequest().
+    base::ThreadTaskRunnerHandle::Get()->PostTask(
+        FROM_HERE, base::Bind(&WebSocketHost::OnFlowControl,
+                              weak_ptr_factory_.GetWeakPtr(),
+                              pending_flow_control_quota_));
+    pending_flow_control_quota_ = 0;
+  }
+
+  std::string additional_headers;
+  if (user_agent_override != "") {
+    if (!net::HttpUtil::IsValidHeaderValue(user_agent_override)) {
+      bad_message::ReceivedBadMessage(
+          dispatcher_, bad_message::WSH_INVALID_HEADER_VALUE);
+      return;
+    }
+    additional_headers = base::StringPrintf("%s:%s",
+                                            net::HttpRequestHeaders::kUserAgent,
+                                            user_agent_override.c_str());
+  }
+  channel_->SendAddChannelRequest(
+      socket_url, requested_protocols, origin, first_party_for_cookies,
+      additional_headers);
+  // |this| may have been deleted here.
+}
+
+void WebSocketHost::OnSendBlob(const std::string& uuid,
+                               uint64_t expected_size) {
+  DVLOG(3) << "WebSocketHost::OnSendBlob"
+           << " routing_id=" << routing_id_ << " uuid=" << uuid
+           << " expected_size=" << expected_size;
+
+  DCHECK(channel_);
+  if (blob_sender_) {
+    bad_message::ReceivedBadMessage(
+        dispatcher_, bad_message::WSH_SEND_BLOB_DURING_BLOB_SEND);
+    return;
+  }
+  blob_sender_.reset(new WebSocketBlobSender(
+      base::WrapUnique(new SendChannelImpl(channel_.get()))));
+  StoragePartition* partition = dispatcher_->storage_partition();
+  storage::FileSystemContext* file_system_context =
+      partition->GetFileSystemContext();
+
+  net::WebSocketEventInterface::ChannelState channel_state =
+      net::WebSocketEventInterface::CHANNEL_ALIVE;
+
+  // This use of base::Unretained is safe because the WebSocketBlobSender object
+  // is owned by this object and will not call it back after destruction.
+  int rv = blob_sender_->Start(
+      uuid, expected_size, dispatcher_->blob_storage_context(),
+      file_system_context,
+      BrowserThread::GetTaskRunnerForThread(BrowserThread::FILE).get(),
+      &channel_state,
+      base::Bind(&WebSocketHost::BlobSendComplete, base::Unretained(this)));
+  if (channel_state == net::WebSocketEventInterface::CHANNEL_ALIVE &&
+      rv != net::ERR_IO_PENDING)
+    BlobSendComplete(rv);
+  // |this| may be destroyed here.
+}
+
+void WebSocketHost::OnSendFrame(bool fin,
+                                WebSocketMessageType type,
+                                const std::vector<char>& data) {
+  DVLOG(3) << "WebSocketHost::OnSendFrame"
+           << " routing_id=" << routing_id_ << " fin=" << fin
+           << " type=" << type << " data is " << data.size() << " bytes";
+
+  DCHECK(channel_);
+  if (blob_sender_) {
+    bad_message::ReceivedBadMessage(
+        dispatcher_, bad_message::WSH_SEND_FRAME_DURING_BLOB_SEND);
+    return;
+  }
+  channel_->SendFrame(fin, MessageTypeToOpCode(type), data);
+}
+
+void WebSocketHost::OnFlowControl(int64_t quota) {
+  DVLOG(3) << "WebSocketHost::OnFlowControl"
+           << " routing_id=" << routing_id_ << " quota=" << quota;
+
+  if (!channel_) {
+    // WebSocketChannel is not yet created due to the delay introduced by
+    // per-renderer WebSocket throttling.
+    // SendFlowControl() is called after WebSocketChannel is created.
+    pending_flow_control_quota_ += quota;
+    return;
+  }
+
+  ignore_result(channel_->SendFlowControl(quota));
+}
+
+void WebSocketHost::OnDropChannel(bool was_clean,
+                                  uint16_t code,
+                                  const std::string& reason) {
+  DVLOG(3) << "WebSocketHost::OnDropChannel"
+           << " routing_id=" << routing_id_ << " was_clean=" << was_clean
+           << " code=" << code << " reason=\"" << reason << "\"";
+
+  if (!channel_) {
+    // WebSocketChannel is not yet created due to the delay introduced by
+    // per-renderer WebSocket throttling.
+    WebSocketDispatcherHost::WebSocketHostState result =
+        dispatcher_->DoDropChannel(routing_id_, false,
+                                   net::kWebSocketErrorAbnormalClosure, "");
+    DCHECK_EQ(WebSocketDispatcherHost::WEBSOCKET_HOST_DELETED, result);
+    return;
+  }
+
+  blob_sender_.reset();
+  // TODO(yhirano): Handle |was_clean| appropriately.
+  ignore_result(channel_->StartClosingHandshake(code, reason));
+}
+
+void WebSocketHost::BlobSendComplete(int result) {
+  DVLOG(3) << "WebSocketHost::BlobSendComplete"
+           << " routing_id=" << routing_id_
+           << " result=" << net::ErrorToString(result);
+
+  // All paths through this method must reset blob_sender_, so take ownership
+  // at the beginning.
+  std::unique_ptr<WebSocketBlobSender> blob_sender(std::move(blob_sender_));
+  switch (result) {
+    case net::OK:
+      ignore_result(dispatcher_->BlobSendComplete(routing_id_));
+      // |this| may be destroyed here.
+      return;
+
+    case net::ERR_UPLOAD_FILE_CHANGED: {
+      uint64_t expected_size = blob_sender->expected_size();
+      uint64_t actual_size = blob_sender->ActualSize();
+      if (expected_size != actual_size) {
+        ignore_result(dispatcher_->NotifyFailure(
+            routing_id_,
+            base::StringPrintf("Blob size mismatch; renderer size = %" PRIu64
+                               ", browser size = %" PRIu64,
+                               expected_size, actual_size)));
+        // |this| is destroyed here.
+        return;
+      }  // else fallthrough
+    }
+
+    default:
+      ignore_result(dispatcher_->NotifyFailure(
+          routing_id_,
+          "Failed to load Blob: error code = " + net::ErrorToString(result)));
+      // |this| is destroyed here.
+      return;
+  }
+}
+
+}  // namespace content
diff --git a/content/browser/renderer_host/websocket_host.h b/content/browser/renderer_host/websocket_host.h
new file mode 100644
index 0000000..3488ef0
--- /dev/null
+++ b/content/browser/renderer_host/websocket_host.h
@@ -0,0 +1,126 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CONTENT_BROWSER_RENDERER_HOST_WEBSOCKET_HOST_H_
+#define CONTENT_BROWSER_RENDERER_HOST_WEBSOCKET_HOST_H_
+
+#include <stdint.h>
+
+#include <memory>
+#include <string>
+#include <vector>
+
+#include "base/macros.h"
+#include "base/memory/weak_ptr.h"
+#include "base/time/time.h"
+#include "content/common/content_export.h"
+#include "content/common/websocket.h"
+
+class GURL;
+struct WebSocketHostMsg_AddChannelRequest_Params;
+
+namespace url {
+class Origin;
+}  // namespace url
+
+namespace net {
+class WebSocketChannel;
+class URLRequestContext;
+}  // namespace net
+
+namespace IPC {
+class Message;
+}  // namespace IPC
+
+namespace content {
+
+class WebSocketBlobSender;
+class WebSocketDispatcherHost;
+
+// Host of net::WebSocketChannel. The lifetime of an instance of this class is
+// completely controlled by the WebSocketDispatcherHost object.
+class CONTENT_EXPORT WebSocketHost {
+ public:
+  WebSocketHost(int routing_id,
+                WebSocketDispatcherHost* dispatcher,
+                net::URLRequestContext* url_request_context,
+                base::TimeDelta delay);
+  virtual ~WebSocketHost();
+
+  // The renderer process is going away.
+  // This function is virtual for testing.
+  virtual void GoAway();
+
+  // General message dispatch. WebSocketDispatcherHost::OnMessageReceived
+  // delegates to this method after looking up the |routing_id|.
+  virtual bool OnMessageReceived(const IPC::Message& message);
+
+  int routing_id() const { return routing_id_; }
+
+  bool handshake_succeeded() const { return handshake_succeeded_; }
+  void OnHandshakeSucceeded() { handshake_succeeded_ = true; }
+
+ private:
+  class WebSocketEventHandler;
+
+  // Handlers for each message type, dispatched by OnMessageReceived(), as
+  // defined in content/common/websocket_messages.h
+
+  void OnAddChannelRequest(
+      const WebSocketHostMsg_AddChannelRequest_Params& request);
+
+  void AddChannel(const GURL& socket_url,
+                  const std::vector<std::string>& requested_protocols,
+                  const url::Origin& origin,
+                  const GURL& first_party_for_cookies,
+                  const std::string& user_agent_override,
+                  int render_frame_id);
+
+  void OnSendBlob(const std::string& uuid, uint64_t expected_size);
+
+  void OnSendFrame(bool fin,
+                   WebSocketMessageType type,
+                   const std::vector<char>& data);
+
+  void OnFlowControl(int64_t quota);
+
+  void OnDropChannel(bool was_clean, uint16_t code, const std::string& reason);
+
+  void BlobSendComplete(int result);
+
+  // non-NULL if and only if this object is currently in "blob sending mode".
+  std::unique_ptr<WebSocketBlobSender> blob_sender_;
+
+  // The channel we use to send events to the network.
+  std::unique_ptr<net::WebSocketChannel> channel_;
+
+  // The WebSocketHostDispatcher that created this object.
+  WebSocketDispatcherHost* const dispatcher_;
+
+  // The URL request context for the channel.
+  net::URLRequestContext* const url_request_context_;
+
+  // The ID used to route messages.
+  const int routing_id_;
+
+  // Delay used for per-renderer WebSocket throttling.
+  base::TimeDelta delay_;
+
+  // SendFlowControl() is delayed when OnFlowControl() is called before
+  // AddChannel() is called.
+  // Zero indicates there is no pending SendFlowControl().
+  int64_t pending_flow_control_quota_;
+
+  // handshake_succeeded_ is set and used by WebSocketDispatcherHost
+  // to manage counters for per-renderer WebSocket throttling.
+  bool handshake_succeeded_;
+
+  base::WeakPtrFactory<WebSocketHost> weak_ptr_factory_;
+
+  DISALLOW_COPY_AND_ASSIGN(WebSocketHost);
+};
+
+}  // namespace content
+
+#endif  // CONTENT_BROWSER_RENDERER_HOST_WEBSOCKET_HOST_H_
diff --git a/content/browser/service_worker/service_worker_version.h b/content/browser/service_worker/service_worker_version.h
index 0e368ab..4074eba 100644
--- a/content/browser/service_worker/service_worker_version.h
+++ b/content/browser/service_worker/service_worker_version.h
@@ -35,7 +35,6 @@
 #include "content/common/service_worker/service_worker_status_code.h"
 #include "content/common/service_worker/service_worker_types.h"
 #include "ipc/ipc_message.h"
-#include "mojo/public/cpp/bindings/interface_ptr.h"
 #include "services/shell/public/cpp/interface_provider.h"
 #include "third_party/WebKit/public/platform/modules/serviceworker/WebServiceWorkerEventResult.h"
 #include "url/gurl.h"
@@ -461,9 +460,9 @@ class CONTENT_EXPORT ServiceWorkerVersion
   class MojoServiceWrapper : public BaseMojoServiceWrapper {
    public:
     MojoServiceWrapper(ServiceWorkerVersion* worker,
-                       mojo::InterfacePtr<Interface> interface_ptr)
+                       mojo::InterfacePtr<Interface> interface)
         : BaseMojoServiceWrapper(worker, Interface::Name_),
-          interface_(std::move(interface_ptr)),
+          interface_(std::move(interface)),
           weak_ptr_factory_(interface_.get()) {}
 
     base::WeakPtr<Interface> GetWeakPtr() {
@@ -755,12 +754,12 @@ base::WeakPtr<Interface> ServiceWorkerVersion::GetMojoServiceForRequest(
       static_cast<MojoServiceWrapper<Interface>*>(
           mojo_services_.get(Interface::Name_));
   if (!service) {
-    mojo::InterfacePtr<Interface> interface_ptr;
-    embedded_worker_->GetRemoteInterfaces()->GetInterface(&interface_ptr);
-    interface_ptr.set_connection_error_handler(
+    mojo::InterfacePtr<Interface> interface;
+    embedded_worker_->GetRemoteInterfaces()->GetInterface(&interface);
+    interface.set_connection_error_handler(
         base::Bind(&ServiceWorkerVersion::OnMojoConnectionError,
                    weak_factory_.GetWeakPtr(), Interface::Name_));
-    service = new MojoServiceWrapper<Interface>(this, std::move(interface_ptr));
+    service = new MojoServiceWrapper<Interface>(this, std::move(interface));
     mojo_services_.add(Interface::Name_, base::WrapUnique(service));
   }
   request->mojo_service = Interface::Name_;
diff --git a/content/browser/site_per_process_browsertest.cc b/content/browser/site_per_process_browsertest.cc
index 8212564..84f83ea 100644
--- a/content/browser/site_per_process_browsertest.cc
+++ b/content/browser/site_per_process_browsertest.cc
@@ -179,29 +179,27 @@ class RenderWidgetHostMouseEventMonitor {
 
 class TestInputEventObserver : public RenderWidgetHost::InputEventObserver {
  public:
-  explicit TestInputEventObserver(RenderWidgetHost* host) : host_(host) {
+  explicit TestInputEventObserver(RenderWidgetHost* host)
+      : host_(host),
+        event_received_(false),
+        last_event_type_(blink::WebInputEvent::Undefined) {
     host_->AddInputEventObserver(this);
   }
 
   ~TestInputEventObserver() override { host_->RemoveInputEventObserver(this); }
 
-  bool EventWasReceived() const { return !events_received_.empty(); }
-  void ResetEventsReceived() { events_received_.clear(); }
-  blink::WebInputEvent::Type EventType() const {
-    DCHECK(EventWasReceived());
-    return events_received_.front();
-  }
-  const std::vector<blink::WebInputEvent::Type>& events_received() {
-    return events_received_;
-  }
+  bool EventWasReceived() const { return event_received_; }
+  void ResetEventReceived() { event_received_ = false; }
+  blink::WebInputEvent::Type EventType() const { return last_event_type_; }
 
   void OnInputEvent(const blink::WebInputEvent& event) override {
-    events_received_.push_back(event.type);
+    event_received_ = true;
+    last_event_type_ = event.type;
   };
 
- private:
   RenderWidgetHost* host_;
-  std::vector<blink::WebInputEvent::Type> events_received_;
+  bool event_received_;
+  blink::WebInputEvent::Type last_event_type_;
 
   DISALLOW_COPY_AND_ASSIGN(TestInputEventObserver);
 };
@@ -7502,183 +7500,4 @@ IN_PROC_BROWSER_TEST_F(SitePerProcessBrowserTest, VisibilityChange) {
   EXPECT_EQ(2, event_fired);
 }
 
-#if defined(USE_AURA)
-class SitePerProcessGestureBrowserTest : public SitePerProcessBrowserTest {
- public:
-  SitePerProcessGestureBrowserTest() {}
-
-  // This functions simulates a sequence of events that are typical of a
-  // gesture pinch at |position|. We need this since machinery in the event
-  // codepath will require GesturePinch* to be enclosed in
-  // GestureScrollBegin/End, and since RenderWidgetHostInputEventRouter needs
-  // both the preceding touch events, as well as GestureTapDown, in order to
-  // correctly target the subsequent gesture event stream. The minimum stream
-  // required to trigger the correct behaviours is represented here, but could
-  // be expanded to include additional events such as one or more
-  // GestureScrollUpdate and GesturePinchUpdate events.
-  void SendPinchBeginEndSequence(RenderWidgetHostViewAura* rwhva,
-                                 const gfx::Point& position) {
-    DCHECK(rwhva);
-    // Use full version of constructor with radius, angle and force since it
-    // will crash in the renderer otherwise.
-    ui::TouchEvent touch_pressed(ui::ET_TOUCH_PRESSED, position, 0, 0,
-                                 ui::EventTimeForNow(), 1.f, 1.f, 0.f, 1.f);
-    rwhva->OnTouchEvent(&touch_pressed);
-    ui::TouchEvent touch_released(ui::ET_TOUCH_RELEASED, position, 0, 0,
-                                  ui::EventTimeForNow(), 1.f, 1.f, 0.f, 1.f);
-    rwhva->OnTouchEvent(&touch_released);
-
-    ui::GestureEventDetails gesture_tap_down_details(ui::ET_GESTURE_TAP_DOWN);
-    gesture_tap_down_details.set_device_type(
-        ui::GestureDeviceType::DEVICE_TOUCHSCREEN);
-    ui::GestureEvent gesture_tap_down(position.x(), position.y(), 0,
-                                      ui::EventTimeForNow(),
-                                      gesture_tap_down_details);
-    rwhva->OnGestureEvent(&gesture_tap_down);
-
-    ui::GestureEventDetails gesture_scroll_begin_details(
-        ui::ET_GESTURE_SCROLL_BEGIN);
-    gesture_scroll_begin_details.set_device_type(
-        ui::GestureDeviceType::DEVICE_TOUCHSCREEN);
-    ui::GestureEvent gesture_scroll_begin(position.x(), position.y(), 0,
-                                          ui::EventTimeForNow(),
-                                          gesture_scroll_begin_details);
-    rwhva->OnGestureEvent(&gesture_scroll_begin);
-
-    ui::GestureEventDetails gesture_pinch_begin_details(
-        ui::ET_GESTURE_PINCH_BEGIN);
-    gesture_pinch_begin_details.set_device_type(
-        ui::GestureDeviceType::DEVICE_TOUCHSCREEN);
-    ui::GestureEvent gesture_pinch_begin(position.x(), position.y(), 0,
-                                         ui::EventTimeForNow(),
-                                         gesture_pinch_begin_details);
-    rwhva->OnGestureEvent(&gesture_pinch_begin);
-
-    ui::GestureEventDetails gesture_pinch_end_details(ui::ET_GESTURE_PINCH_END);
-    gesture_pinch_end_details.set_device_type(
-        ui::GestureDeviceType::DEVICE_TOUCHSCREEN);
-    ui::GestureEvent gesture_pinch_end(position.x(), position.y(), 0,
-                                       ui::EventTimeForNow(),
-                                       gesture_pinch_end_details);
-    rwhva->OnGestureEvent(&gesture_pinch_end);
-
-    ui::GestureEventDetails gesture_scroll_end_details(
-        ui::ET_GESTURE_SCROLL_END);
-    gesture_scroll_end_details.set_device_type(
-        ui::GestureDeviceType::DEVICE_TOUCHSCREEN);
-    ui::GestureEvent gesture_scroll_end(position.x(), position.y(), 0,
-                                        ui::EventTimeForNow(),
-                                        gesture_scroll_end_details);
-    rwhva->OnGestureEvent(&gesture_scroll_end);
-  }
-
-  void SetupRootAndChild() {
-    GURL main_url(embedded_test_server()->GetURL(
-        "a.com", "/cross_site_iframe_factory.html?a(b)"));
-    NavigateToURL(shell(), main_url);
-
-    FrameTreeNode* root_node =
-        static_cast<WebContentsImpl*>(shell()->web_contents())
-            ->GetFrameTree()
-            ->root();
-    FrameTreeNode* child_node = root_node->child_at(0);
-
-    rwhv_child_ = static_cast<RenderWidgetHostViewBase*>(
-        child_node->current_frame_host()->GetRenderWidgetHost()->GetView());
-
-    rwhva_root_ = static_cast<RenderWidgetHostViewAura*>(
-        shell()->web_contents()->GetRenderWidgetHostView());
-
-    SurfaceHitTestReadyNotifier notifier(
-        static_cast<RenderWidgetHostViewChildFrame*>(rwhv_child_));
-    notifier.WaitForSurfaceReady();
-
-    rwhi_child_ = child_node->current_frame_host()->GetRenderWidgetHost();
-    rwhi_root_ = root_node->current_frame_host()->GetRenderWidgetHost();
-  }
-
- protected:
-  RenderWidgetHostViewBase* rwhv_child_;
-  RenderWidgetHostViewAura* rwhva_root_;
-  RenderWidgetHostImpl* rwhi_child_;
-  RenderWidgetHostImpl* rwhi_root_;
-
- private:
-  DISALLOW_COPY_AND_ASSIGN(SitePerProcessGestureBrowserTest);
-};
-
-IN_PROC_BROWSER_TEST_F(SitePerProcessGestureBrowserTest,
-                       SubframeGesturePinchGoesToMainFrame) {
-  SetupRootAndChild();
-
-  TestInputEventObserver root_frame_monitor(rwhi_root_);
-  TestInputEventObserver child_frame_monitor(rwhi_child_);
-
-  // Need child rect in main frame coords.
-  gfx::Rect bounds = rwhv_child_->GetViewBounds();
-  bounds.Offset(gfx::Point() - rwhva_root_->GetViewBounds().origin());
-  SendPinchBeginEndSequence(rwhva_root_, bounds.CenterPoint());
-
-  // Verify root-RWHI gets GSB/GPB/GPE/GSE.
-  EXPECT_TRUE(root_frame_monitor.EventWasReceived());
-  EXPECT_EQ(blink::WebInputEvent::GestureScrollBegin,
-            root_frame_monitor.events_received()[0]);
-  EXPECT_EQ(blink::WebInputEvent::GesturePinchBegin,
-            root_frame_monitor.events_received()[1]);
-  EXPECT_EQ(blink::WebInputEvent::GesturePinchEnd,
-            root_frame_monitor.events_received()[2]);
-  EXPECT_EQ(blink::WebInputEvent::GestureScrollEnd,
-            root_frame_monitor.events_received()[3]);
-
-  // Verify child-RWHI gets TS/TE, GTD/GSB/GSE.
-  EXPECT_TRUE(child_frame_monitor.EventWasReceived());
-  EXPECT_EQ(blink::WebInputEvent::TouchStart,
-            child_frame_monitor.events_received()[0]);
-  EXPECT_EQ(blink::WebInputEvent::TouchEnd,
-            child_frame_monitor.events_received()[1]);
-  EXPECT_EQ(blink::WebInputEvent::GestureTapDown,
-            child_frame_monitor.events_received()[2]);
-  EXPECT_EQ(blink::WebInputEvent::GestureScrollBegin,
-            child_frame_monitor.events_received()[3]);
-  EXPECT_EQ(blink::WebInputEvent::GestureScrollEnd,
-            child_frame_monitor.events_received()[4]);
-}
-
-IN_PROC_BROWSER_TEST_F(SitePerProcessGestureBrowserTest,
-                       MainframeGesturePinchGoesToMainFrame) {
-  SetupRootAndChild();
-
-  TestInputEventObserver root_frame_monitor(rwhi_root_);
-  TestInputEventObserver child_frame_monitor(rwhi_child_);
-
-  // Need child rect in main frame coords.
-  gfx::Rect bounds = rwhv_child_->GetViewBounds();
-  bounds.Offset(gfx::Point() - rwhva_root_->GetViewBounds().origin());
-
-  gfx::Point main_frame_point(bounds.origin());
-  main_frame_point += gfx::Vector2d(-5, -5);
-  SendPinchBeginEndSequence(rwhva_root_, main_frame_point);
-
-  // Verify root-RWHI gets TS/TE/GTD/GSB/GPB/GPE/GSE.
-  EXPECT_TRUE(root_frame_monitor.EventWasReceived());
-  EXPECT_EQ(blink::WebInputEvent::TouchStart,
-            root_frame_monitor.events_received()[0]);
-  EXPECT_EQ(blink::WebInputEvent::TouchEnd,
-            root_frame_monitor.events_received()[1]);
-  EXPECT_EQ(blink::WebInputEvent::GestureTapDown,
-            root_frame_monitor.events_received()[2]);
-  EXPECT_EQ(blink::WebInputEvent::GestureScrollBegin,
-            root_frame_monitor.events_received()[3]);
-  EXPECT_EQ(blink::WebInputEvent::GesturePinchBegin,
-            root_frame_monitor.events_received()[4]);
-  EXPECT_EQ(blink::WebInputEvent::GesturePinchEnd,
-            root_frame_monitor.events_received()[5]);
-  EXPECT_EQ(blink::WebInputEvent::GestureScrollEnd,
-            root_frame_monitor.events_received()[6]);
-
-  // Verify child-RWHI gets no events.
-  EXPECT_FALSE(child_frame_monitor.EventWasReceived());
-}
-#endif
-
 }  // namespace content
diff --git a/content/browser/ssl/ssl_policy.cc b/content/browser/ssl/ssl_policy.cc
index a45e135..e84b99e 100644
--- a/content/browser/ssl/ssl_policy.cc
+++ b/content/browser/ssl/ssl_policy.cc
@@ -147,6 +147,17 @@ void SSLPolicy::UpdateEntry(NavigationEntryImpl* entry,
 
   InitializeEntryIfNeeded(entry);
 
+  // if (web_contents->IronframeStatus() != 0)
+  // {
+  //     if (web_contents->IronframeStatus() == 1) {
+  //         entry->GetSSL().security_style = SECURITY_STYLE_AUTHENTICATED;
+  //     } else if (web_contents->IronframeStatus() == 2) {
+  //         entry->GetSSL().security_style = SECURITY_STYLE_AUTHENTICATION_BROKEN;
+  //     }
+  // }
+
+
+  
   if (entry->GetSSL().security_style == SECURITY_STYLE_UNAUTHENTICATED)
     return;
 
diff --git a/content/browser/web_contents/web_contents_impl.cc b/content/browser/web_contents/web_contents_impl.cc
index 26e6d0a..a99271c 100644
--- a/content/browser/web_contents/web_contents_impl.cc
+++ b/content/browser/web_contents/web_contents_impl.cc
@@ -697,6 +697,12 @@ bool WebContentsImpl::OnMessageReceived(RenderViewHost* render_view_host,
                         OnFirstVisuallyNonEmptyPaint)
     IPC_MESSAGE_HANDLER(FrameHostMsg_DidLoadResourceFromMemoryCache,
                         OnDidLoadResourceFromMemoryCache)
+    IPC_MESSAGE_HANDLER(FrameHostMsg_IronframeOrigin,
+                        OnIronframeOrigin)
+    IPC_MESSAGE_HANDLER(FrameHostMsg_ValidIronframe,
+                        OnValidIronframe)
+    IPC_MESSAGE_HANDLER(FrameHostMsg_InvalidIronframe,
+                        OnInvalidIronframe)
     IPC_MESSAGE_HANDLER(FrameHostMsg_DidDisplayInsecureContent,
                         OnDidDisplayInsecureContent)
     IPC_MESSAGE_HANDLER(FrameHostMsg_DidRunInsecureContent,
@@ -1181,6 +1187,10 @@ const std::string& WebContentsImpl::GetEncoding() const {
   return canonical_encoding_;
 }
 
+int WebContentsImpl::IronframeStatus() const {
+  return ironframe_status_;
+}
+
 bool WebContentsImpl::DisplayedInsecureContent() const {
   return displayed_insecure_content_;
 }
@@ -3480,6 +3490,35 @@ void WebContentsImpl::OnDidLoadResourceFromMemoryCache(
   }
 }
 
+
+std::string WebContentsImpl::IronframeOrigin() const {
+      RecordAction(base::UserMetricsAction("Ironframe.Origin"));
+      return ironframe_origin_;
+}
+
+
+void WebContentsImpl::OnIronframeOrigin(const std::string& origin) {
+    ironframe_origin_ = origin;
+}
+
+void WebContentsImpl::OnValidIronframe() {
+  RecordAction(base::UserMetricsAction("Ironframe.Valid"));
+  ironframe_status_ = 1;
+  this->DidChangeVisibleSSLState();
+// displayed_insecure_content_ = false;
+  //SSLManager::NotifySSLInternalStateChanged(
+  //GetController().GetBrowserContext());
+}
+void WebContentsImpl::OnInvalidIronframe() {
+  RecordAction(base::UserMetricsAction("Ironframe.Invalid"));
+  ironframe_status_ = 2;
+  this->DidChangeVisibleSSLState();
+// displayed_insecure_content_ = true;
+  //SSLManager::NotifySSLInternalStateChanged(
+  //  GetController().GetBrowserContext());
+}
+
+
 void WebContentsImpl::OnDidDisplayInsecureContent() {
   RecordAction(base::UserMetricsAction("SSL.DisplayedInsecureContent"));
   displayed_insecure_content_ = true;
diff --git a/content/browser/web_contents/web_contents_impl.h b/content/browser/web_contents/web_contents_impl.h
index 91226f8..a962147 100644
--- a/content/browser/web_contents/web_contents_impl.h
+++ b/content/browser/web_contents/web_contents_impl.h
@@ -291,6 +291,8 @@ class CONTENT_EXPORT WebContentsImpl
   uint64_t GetUploadSize() const override;
   uint64_t GetUploadPosition() const override;
   const std::string& GetEncoding() const override;
+  int IronframeStatus() const override;
+  std::string IronframeOrigin() const override;
   bool DisplayedInsecureContent() const override;
   void IncrementCapturerCount(const gfx::Size& capture_size) override;
   void DecrementCapturerCount() override;
@@ -909,6 +911,9 @@ class CONTENT_EXPORT WebContentsImpl
                                         const std::string& http_request,
                                         const std::string& mime_type,
                                         ResourceType resource_type);
+  void OnIronframeOrigin(const std::string& origin);
+  void OnValidIronframe();
+  void OnInvalidIronframe();
   void OnDidDisplayInsecureContent();
   void OnDidRunInsecureContent(const GURL& security_origin,
                                const GURL& target_url);
@@ -1199,6 +1204,11 @@ class CONTENT_EXPORT WebContentsImpl
   // The canonicalized character encoding.
   std::string canonical_encoding_;
 
+  //   0 - no ironframe, 1 - valid ironframe, 2 - invalid ironframe
+  int  ironframe_status_;
+
+  std::string ironframe_origin_;
+  
   // True if this is a secure page which displayed insecure content.
   bool displayed_insecure_content_;
 
diff --git a/content/browser/webrtc/webrtc_image_capture_browsertest.cc b/content/browser/webrtc/webrtc_image_capture_browsertest.cc
index 1131180..19ffda4 100644
--- a/content/browser/webrtc/webrtc_image_capture_browsertest.cc
+++ b/content/browser/webrtc/webrtc_image_capture_browsertest.cc
@@ -18,12 +18,14 @@ static const char kImageCaptureHtmlFile[] = "/media/image_capture_test.html";
 
 // TODO(mcasas): enable real-camera tests by disabling the Fake Device for
 // platforms where the ImageCaptureCode is landed, https://crbug.com/518807.
-// TODO(mcasas): enable in Android when takePhoto() can be specified a (small)
-// capture resolution preventing the test from timeout https://crbug.com/634811.
 static struct TargetCamera {
   bool use_fake;
 }
+#if defined(OS_ANDROID)
+const kTestParameters[] = {{true}, {false}};
+#else
 const kTestParameters[] = {{true}};
+#endif
 
 }  // namespace
 
diff --git a/content/browser/websockets/websocket_impl.cc b/content/browser/websockets/websocket_impl.cc
deleted file mode 100644
index d391005..0000000
--- a/content/browser/websockets/websocket_impl.cc
+++ /dev/null
@@ -1,536 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "content/browser/websockets/websocket_impl.h"
-
-#include <inttypes.h>
-
-#include <utility>
-
-#include "base/bind.h"
-#include "base/bind_helpers.h"
-#include "base/location.h"
-#include "base/logging.h"
-#include "base/macros.h"
-#include "base/memory/ptr_util.h"
-#include "base/single_thread_task_runner.h"
-#include "base/strings/string_util.h"
-#include "base/strings/stringprintf.h"
-#include "base/threading/thread_task_runner_handle.h"
-#include "content/browser/bad_message.h"
-#include "content/browser/child_process_security_policy_impl.h"
-#include "content/browser/ssl/ssl_error_handler.h"
-#include "content/browser/ssl/ssl_manager.h"
-#include "content/public/browser/storage_partition.h"
-#include "ipc/ipc_message.h"
-#include "net/base/net_errors.h"
-#include "net/http/http_request_headers.h"
-#include "net/http/http_response_headers.h"
-#include "net/http/http_util.h"
-#include "net/ssl/ssl_info.h"
-#include "net/url_request/url_request_context_getter.h"
-#include "net/websockets/websocket_channel.h"
-#include "net/websockets/websocket_errors.h"
-#include "net/websockets/websocket_event_interface.h"
-#include "net/websockets/websocket_frame.h"  // for WebSocketFrameHeader::OpCode
-#include "net/websockets/websocket_handshake_request_info.h"
-#include "net/websockets/websocket_handshake_response_info.h"
-#include "url/origin.h"
-
-namespace content {
-namespace {
-
-typedef net::WebSocketEventInterface::ChannelState ChannelState;
-
-// Convert a mojom::WebSocketMessageType to a
-// net::WebSocketFrameHeader::OpCode
-net::WebSocketFrameHeader::OpCode MessageTypeToOpCode(
-    mojom::WebSocketMessageType type) {
-  DCHECK(type == mojom::WebSocketMessageType::CONTINUATION ||
-         type == mojom::WebSocketMessageType::TEXT ||
-         type == mojom::WebSocketMessageType::BINARY);
-  typedef net::WebSocketFrameHeader::OpCode OpCode;
-  // These compile asserts verify that the same underlying values are used for
-  // both types, so we can simply cast between them.
-  static_assert(
-      static_cast<OpCode>(mojom::WebSocketMessageType::CONTINUATION) ==
-          net::WebSocketFrameHeader::kOpCodeContinuation,
-      "enum values must match for opcode continuation");
-  static_assert(
-      static_cast<OpCode>(mojom::WebSocketMessageType::TEXT) ==
-          net::WebSocketFrameHeader::kOpCodeText,
-      "enum values must match for opcode text");
-  static_assert(
-      static_cast<OpCode>(mojom::WebSocketMessageType::BINARY) ==
-          net::WebSocketFrameHeader::kOpCodeBinary,
-      "enum values must match for opcode binary");
-  return static_cast<OpCode>(type);
-}
-
-mojom::WebSocketMessageType OpCodeToMessageType(
-    net::WebSocketFrameHeader::OpCode opCode) {
-  DCHECK(opCode == net::WebSocketFrameHeader::kOpCodeContinuation ||
-         opCode == net::WebSocketFrameHeader::kOpCodeText ||
-         opCode == net::WebSocketFrameHeader::kOpCodeBinary);
-  // This cast is guaranteed valid by the static_assert() statements above.
-  return static_cast<mojom::WebSocketMessageType>(opCode);
-}
-
-}  // namespace
-
-// Implementation of net::WebSocketEventInterface. Receives events from our
-// WebSocketChannel object.
-class WebSocketImpl::WebSocketEventHandler final
-    : public net::WebSocketEventInterface {
- public:
-  explicit WebSocketEventHandler(WebSocketImpl* impl);
-  ~WebSocketEventHandler() override;
-
-  // net::WebSocketEventInterface implementation
-
-  ChannelState OnAddChannelResponse(const std::string& selected_subprotocol,
-                                    const std::string& extensions) override;
-  ChannelState OnDataFrame(bool fin,
-                           WebSocketMessageType type,
-                           const std::vector<char>& data) override;
-  ChannelState OnClosingHandshake() override;
-  ChannelState OnFlowControl(int64_t quota) override;
-  ChannelState OnDropChannel(bool was_clean,
-                             uint16_t code,
-                             const std::string& reason) override;
-  ChannelState OnFailChannel(const std::string& message) override;
-  ChannelState OnStartOpeningHandshake(
-      std::unique_ptr<net::WebSocketHandshakeRequestInfo> request) override;
-  ChannelState OnFinishOpeningHandshake(
-      std::unique_ptr<net::WebSocketHandshakeResponseInfo> response) override;
-  ChannelState OnSSLCertificateError(
-      std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks>
-          callbacks,
-      const GURL& url,
-      const net::SSLInfo& ssl_info,
-      bool fatal) override;
-
- private:
-  class SSLErrorHandlerDelegate final : public SSLErrorHandler::Delegate {
-   public:
-    SSLErrorHandlerDelegate(
-        std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks>
-            callbacks);
-    ~SSLErrorHandlerDelegate() override;
-
-    base::WeakPtr<SSLErrorHandler::Delegate> GetWeakPtr();
-
-    // SSLErrorHandler::Delegate methods
-    void CancelSSLRequest(int error, const net::SSLInfo* ssl_info) override;
-    void ContinueSSLRequest() override;
-
-   private:
-    std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks> callbacks_;
-    base::WeakPtrFactory<SSLErrorHandlerDelegate> weak_ptr_factory_;
-
-    DISALLOW_COPY_AND_ASSIGN(SSLErrorHandlerDelegate);
-  };
-
-  WebSocketImpl* const impl_;
-  std::unique_ptr<SSLErrorHandlerDelegate> ssl_error_handler_delegate_;
-
-  DISALLOW_COPY_AND_ASSIGN(WebSocketEventHandler);
-};
-
-WebSocketImpl::WebSocketEventHandler::WebSocketEventHandler(WebSocketImpl* impl)
-    : impl_(impl) {
-  DVLOG(1) << "WebSocketEventHandler created @"
-           << reinterpret_cast<void*>(this);
-}
-
-WebSocketImpl::WebSocketEventHandler::~WebSocketEventHandler() {
-  DVLOG(1) << "WebSocketEventHandler destroyed @"
-           << reinterpret_cast<void*>(this);
-}
-
-ChannelState WebSocketImpl::WebSocketEventHandler::OnAddChannelResponse(
-    const std::string& selected_protocol,
-    const std::string& extensions) {
-  DVLOG(3) << "WebSocketEventHandler::OnAddChannelResponse @"
-           << reinterpret_cast<void*>(this)
-           << " selected_protocol=\"" << selected_protocol << "\""
-           << " extensions=\"" << extensions << "\"";
-
-  impl_->delegate_->OnReceivedResponseFromServer(impl_);
-
-  impl_->client_->OnAddChannelResponse(selected_protocol, extensions);
-
-  return net::WebSocketEventInterface::CHANNEL_ALIVE;
-}
-
-ChannelState WebSocketImpl::WebSocketEventHandler::OnDataFrame(
-    bool fin,
-    net::WebSocketFrameHeader::OpCode type,
-    const std::vector<char>& data) {
-  DVLOG(3) << "WebSocketEventHandler::OnDataFrame @"
-           << reinterpret_cast<void*>(this)
-           << " fin=" << fin
-           << " type=" << type << " data is " << data.size() << " bytes";
-
-  // TODO(darin): Avoid this copy.
-  mojo::Array<uint8_t> data_to_pass(data.size());
-  std::copy(data.begin(), data.end(), data_to_pass.begin());
-
-  impl_->client_->OnDataFrame(fin, OpCodeToMessageType(type),
-                              std::move(data_to_pass));
-
-  return net::WebSocketEventInterface::CHANNEL_ALIVE;
-}
-
-ChannelState WebSocketImpl::WebSocketEventHandler::OnClosingHandshake() {
-  DVLOG(3) << "WebSocketEventHandler::OnClosingHandshake @"
-           << reinterpret_cast<void*>(this);
-
-  impl_->client_->OnClosingHandshake();
-
-  return net::WebSocketEventInterface::CHANNEL_ALIVE;
-}
-
-ChannelState WebSocketImpl::WebSocketEventHandler::OnFlowControl(
-    int64_t quota) {
-  DVLOG(3) << "WebSocketEventHandler::OnFlowControl @"
-           << reinterpret_cast<void*>(this)
-           << " quota=" << quota;
-
-  impl_->client_->OnFlowControl(quota);
-
-  return net::WebSocketEventInterface::CHANNEL_ALIVE;
-}
-
-ChannelState WebSocketImpl::WebSocketEventHandler::OnDropChannel(
-    bool was_clean,
-    uint16_t code,
-    const std::string& reason) {
-  DVLOG(3) << "WebSocketEventHandler::OnDropChannel @"
-           << reinterpret_cast<void*>(this)
-           << " was_clean=" << was_clean << " code=" << code
-           << " reason=\"" << reason << "\"";
-
-  impl_->client_->OnDropChannel(was_clean, code, reason);
-
-  // net::WebSocketChannel requires that we delete it at this point.
-  impl_->channel_.reset();
-
-  return net::WebSocketEventInterface::CHANNEL_DELETED;
-}
-
-ChannelState WebSocketImpl::WebSocketEventHandler::OnFailChannel(
-    const std::string& message) {
-  DVLOG(3) << "WebSocketEventHandler::OnFailChannel @"
-           << reinterpret_cast<void*>(this) << " message=\"" << message << "\"";
-
-  impl_->client_->OnFailChannel(message);
-
-  // net::WebSocketChannel requires that we delete it at this point.
-  impl_->channel_.reset();
-
-  return net::WebSocketEventInterface::CHANNEL_DELETED;
-}
-
-ChannelState WebSocketImpl::WebSocketEventHandler::OnStartOpeningHandshake(
-    std::unique_ptr<net::WebSocketHandshakeRequestInfo> request) {
-  bool should_send =
-      ChildProcessSecurityPolicyImpl::GetInstance()->CanReadRawCookies(
-          impl_->delegate_->GetClientProcessId());
-
-  DVLOG(3) << "WebSocketEventHandler::OnStartOpeningHandshake @"
-           << reinterpret_cast<void*>(this) << " should_send=" << should_send;
-
-  if (!should_send)
-    return WebSocketEventInterface::CHANNEL_ALIVE;
-
-  mojom::WebSocketHandshakeRequestPtr request_to_pass(
-      mojom::WebSocketHandshakeRequest::New());
-  request_to_pass->url.Swap(&request->url);
-  net::HttpRequestHeaders::Iterator it(request->headers);
-  while (it.GetNext()) {
-    mojom::HttpHeaderPtr header(mojom::HttpHeader::New());
-    header->name = it.name();
-    header->value = it.value();
-    request_to_pass->headers.push_back(std::move(header));
-  }
-  request_to_pass->headers_text =
-      base::StringPrintf("GET %s HTTP/1.1\r\n",
-                         request_to_pass->url.spec().c_str()) +
-      request->headers.ToString();
-
-  impl_->client_->OnStartOpeningHandshake(std::move(request_to_pass));
-
-  return WebSocketEventInterface::CHANNEL_ALIVE;
-}
-
-ChannelState WebSocketImpl::WebSocketEventHandler::OnFinishOpeningHandshake(
-    std::unique_ptr<net::WebSocketHandshakeResponseInfo> response) {
-  bool should_send =
-      ChildProcessSecurityPolicyImpl::GetInstance()->CanReadRawCookies(
-          impl_->delegate_->GetClientProcessId());
-
-  DVLOG(3) << "WebSocketEventHandler::OnFinishOpeningHandshake "
-           << reinterpret_cast<void*>(this) << " should_send=" << should_send;
-
-  if (!should_send)
-    return WebSocketEventInterface::CHANNEL_ALIVE;
-
-  mojom::WebSocketHandshakeResponsePtr response_to_pass(
-      mojom::WebSocketHandshakeResponse::New());
-  response_to_pass->url.Swap(&response->url);
-  response_to_pass->status_code = response->status_code;
-  response_to_pass->status_text = response->status_text;
-  size_t iter = 0;
-  std::string name, value;
-  while (response->headers->EnumerateHeaderLines(&iter, &name, &value)) {
-    mojom::HttpHeaderPtr header(mojom::HttpHeader::New());
-    header->name = name;
-    header->value = value;
-    response_to_pass->headers.push_back(std::move(header));
-  }
-  response_to_pass->headers_text =
-      net::HttpUtil::ConvertHeadersBackToHTTPResponse(
-          response->headers->raw_headers());
-
-  impl_->client_->OnFinishOpeningHandshake(std::move(response_to_pass));
-
-  return WebSocketEventInterface::CHANNEL_ALIVE;
-}
-
-ChannelState WebSocketImpl::WebSocketEventHandler::OnSSLCertificateError(
-    std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks> callbacks,
-    const GURL& url,
-    const net::SSLInfo& ssl_info,
-    bool fatal) {
-  DVLOG(3) << "WebSocketEventHandler::OnSSLCertificateError"
-           << reinterpret_cast<void*>(this) << " url=" << url.spec()
-           << " cert_status=" << ssl_info.cert_status << " fatal=" << fatal;
-  ssl_error_handler_delegate_.reset(
-      new SSLErrorHandlerDelegate(std::move(callbacks)));
-  SSLManager::OnSSLCertificateSubresourceError(
-      ssl_error_handler_delegate_->GetWeakPtr(),
-      url,
-      impl_->delegate_->GetClientProcessId(),
-      impl_->frame_id_,
-      ssl_info,
-      fatal);
-  // The above method is always asynchronous.
-  return WebSocketEventInterface::CHANNEL_ALIVE;
-}
-
-WebSocketImpl::WebSocketEventHandler::SSLErrorHandlerDelegate::
-    SSLErrorHandlerDelegate(
-        std::unique_ptr<net::WebSocketEventInterface::SSLErrorCallbacks>
-            callbacks)
-    : callbacks_(std::move(callbacks)), weak_ptr_factory_(this) {}
-
-WebSocketImpl::WebSocketEventHandler::SSLErrorHandlerDelegate::
-    ~SSLErrorHandlerDelegate() {}
-
-base::WeakPtr<SSLErrorHandler::Delegate>
-WebSocketImpl::WebSocketEventHandler::SSLErrorHandlerDelegate::GetWeakPtr() {
-  return weak_ptr_factory_.GetWeakPtr();
-}
-
-void WebSocketImpl::WebSocketEventHandler::SSLErrorHandlerDelegate::
-    CancelSSLRequest(int error, const net::SSLInfo* ssl_info) {
-  DVLOG(3) << "SSLErrorHandlerDelegate::CancelSSLRequest"
-           << " error=" << error
-           << " cert_status=" << (ssl_info ? ssl_info->cert_status
-                                           : static_cast<net::CertStatus>(-1));
-  callbacks_->CancelSSLRequest(error, ssl_info);
-}
-
-void WebSocketImpl::WebSocketEventHandler::SSLErrorHandlerDelegate::
-    ContinueSSLRequest() {
-  DVLOG(3) << "SSLErrorHandlerDelegate::ContinueSSLRequest";
-  callbacks_->ContinueSSLRequest();
-}
-
-WebSocketImpl::WebSocketImpl(
-    Delegate* delegate,
-    mojom::WebSocketRequest request,
-    int frame_id,
-    base::TimeDelta delay)
-    : delegate_(delegate),
-      binding_(this, std::move(request)),
-      delay_(delay),
-      pending_flow_control_quota_(0),
-      frame_id_(frame_id),
-      handshake_succeeded_(false),
-      weak_ptr_factory_(this) {
-  binding_.set_connection_error_handler(
-      base::Bind(&WebSocketImpl::OnConnectionError, base::Unretained(this)));
-}
-
-WebSocketImpl::~WebSocketImpl() {}
-
-void WebSocketImpl::GoAway() {
-  StartClosingHandshake(static_cast<uint16_t>(net::kWebSocketErrorGoingAway),
-                        "");
-}
-
-void WebSocketImpl::AddChannelRequest(
-    const GURL& socket_url,
-    mojo::Array<mojo::String> requested_protocols_mojo,
-    const url::Origin& origin,
-    const GURL& first_party_for_cookies,
-    const mojo::String& user_agent_override,
-    mojom::WebSocketClientPtr client) {
-  // Convert to STL types.
-  std::vector<std::string> requested_protocols(
-      requested_protocols_mojo.begin(),
-      requested_protocols_mojo.end());
-
-  DVLOG(3) << "WebSocketImpl::AddChannelRequest @"
-           << reinterpret_cast<void*>(this)
-           << " socket_url=\"" << socket_url << "\" requested_protocols=\""
-           << base::JoinString(requested_protocols, ", ")
-           << "\" origin=\"" << origin
-           << "\" first_party_for_cookies=\"" << first_party_for_cookies
-           << "\" user_agent_override=\"" << user_agent_override
-           << "\"";
-
-  if (client_ || !client) {
-    bad_message::ReceivedBadMessage(
-        delegate_->GetClientProcessId(),
-        bad_message::WSI_UNEXPECTED_ADD_CHANNEL_REQUEST);
-    return;
-  }
-
-  client_ = std::move(client);
-
-  DCHECK(!channel_);
-  if (delay_ > base::TimeDelta()) {
-    base::ThreadTaskRunnerHandle::Get()->PostDelayedTask(
-        FROM_HERE,
-        base::Bind(&WebSocketImpl::AddChannel,
-                   weak_ptr_factory_.GetWeakPtr(),
-                   socket_url,
-                   requested_protocols,
-                   origin,
-                   first_party_for_cookies,
-                   user_agent_override),
-        delay_);
-  } else {
-    AddChannel(socket_url, requested_protocols, origin, first_party_for_cookies,
-               user_agent_override);
-  }
-}
-
-void WebSocketImpl::SendFrame(bool fin, mojom::WebSocketMessageType type,
-                              mojo::Array<uint8_t> data) {
-  DVLOG(3) << "WebSocketImpl::SendFrame @"
-           << reinterpret_cast<void*>(this) << " fin=" << fin
-           << " type=" << type << " data is " << data.size() << " bytes";
-
-  if (!channel_) {
-    // The client should not be sending us frames until after we've informed
-    // it that the channel has been opened (OnAddChannelResponse).
-    if (handshake_succeeded_) {
-      DVLOG(1) << "Dropping frame sent to closed websocket";
-    } else {
-      bad_message::ReceivedBadMessage(
-          delegate_->GetClientProcessId(),
-          bad_message::WSI_UNEXPECTED_SEND_FRAME);
-    }
-    return;
-  }
-
-  // TODO(darin): Avoid this copy.
-  std::vector<char> data_to_pass(data.size());
-  std::copy(data.begin(), data.end(), data_to_pass.begin());
-
-  channel_->SendFrame(fin, MessageTypeToOpCode(type), data_to_pass);
-}
-
-void WebSocketImpl::SendFlowControl(int64_t quota) {
-  DVLOG(3) << "WebSocketImpl::OnFlowControl @"
-           << reinterpret_cast<void*>(this) << " quota=" << quota;
-
-  if (!channel_) {
-    // WebSocketChannel is not yet created due to the delay introduced by
-    // per-renderer WebSocket throttling.
-    // SendFlowControl() is called after WebSocketChannel is created.
-    pending_flow_control_quota_ += quota;
-    return;
-  }
-
-  ignore_result(channel_->SendFlowControl(quota));
-}
-
-void WebSocketImpl::StartClosingHandshake(uint16_t code,
-                                          const mojo::String& reason) {
-  DVLOG(3) << "WebSocketImpl::StartClosingHandshake @"
-           << reinterpret_cast<void*>(this)
-           << " code=" << code << " reason=\"" << reason << "\"";
-
-  if (!channel_) {
-    // WebSocketChannel is not yet created due to the delay introduced by
-    // per-renderer WebSocket throttling.
-    if (client_)
-      client_->OnDropChannel(false, net::kWebSocketErrorAbnormalClosure, "");
-    return;
-  }
-
-  ignore_result(channel_->StartClosingHandshake(code, reason));
-}
-
-void WebSocketImpl::OnConnectionError() {
-  DVLOG(3) << "WebSocketImpl::OnConnectionError @"
-           << reinterpret_cast<void*>(this);
-
-  delegate_->OnLostConnectionToClient(this);
-}
-
-void WebSocketImpl::AddChannel(
-    const GURL& socket_url,
-    const std::vector<std::string>& requested_protocols,
-    const url::Origin& origin,
-    const GURL& first_party_for_cookies,
-    const std::string& user_agent_override) {
-  DVLOG(3) << "WebSocketImpl::AddChannel @"
-           << reinterpret_cast<void*>(this)
-           << " socket_url=\"" << socket_url
-           << "\" requested_protocols=\""
-           << base::JoinString(requested_protocols, ", ")
-           << "\" origin=\"" << origin
-           << "\" first_party_for_cookies=\"" << first_party_for_cookies
-           << "\" user_agent_override=\"" << user_agent_override
-           << "\"";
-
-  DCHECK(!channel_);
-
-  StoragePartition* partition = delegate_->GetStoragePartition();
-
-  std::unique_ptr<net::WebSocketEventInterface> event_interface(
-      new WebSocketEventHandler(this));
-  channel_.reset(
-      new net::WebSocketChannel(
-          std::move(event_interface),
-          partition->GetURLRequestContext()->GetURLRequestContext()));
-
-  int64_t quota = pending_flow_control_quota_;
-  pending_flow_control_quota_ = 0;
-
-  std::string additional_headers;
-  if (!user_agent_override.empty()) {
-    if (!net::HttpUtil::IsValidHeaderValue(user_agent_override)) {
-      bad_message::ReceivedBadMessage(
-          delegate_->GetClientProcessId(),
-          bad_message::WSI_INVALID_HEADER_VALUE);
-      return;
-    }
-    additional_headers = base::StringPrintf("%s:%s",
-                                            net::HttpRequestHeaders::kUserAgent,
-                                            user_agent_override.c_str());
-  }
-  channel_->SendAddChannelRequest(socket_url, requested_protocols, origin,
-                                  first_party_for_cookies, additional_headers);
-  if (quota > 0)
-    SendFlowControl(quota);
-}
-
-}  // namespace content
diff --git a/content/browser/websockets/websocket_impl.h b/content/browser/websockets/websocket_impl.h
deleted file mode 100644
index fa3b5d8..0000000
--- a/content/browser/websockets/websocket_impl.h
+++ /dev/null
@@ -1,112 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CONTENT_BROWSER_WEBSOCKETS_WEBSOCKET_IMPL_H_
-#define CONTENT_BROWSER_WEBSOCKETS_WEBSOCKET_IMPL_H_
-
-#include <stdint.h>
-
-#include <memory>
-#include <string>
-#include <vector>
-
-#include "base/macros.h"
-#include "base/memory/weak_ptr.h"
-#include "base/time/time.h"
-#include "content/common/content_export.h"
-#include "content/common/websocket.mojom.h"
-#include "mojo/public/cpp/bindings/binding.h"
-
-class GURL;
-
-namespace url {
-class Origin;
-}  // namespace url
-
-namespace net {
-class WebSocketChannel;
-}  // namespace net
-
-namespace content {
-class StoragePartition;
-
-// Host of net::WebSocketChannel.
-class CONTENT_EXPORT WebSocketImpl
-    : NON_EXPORTED_BASE(public mojom::WebSocket) {
- public:
-  class Delegate {
-   public:
-    virtual ~Delegate() {}
-    virtual int GetClientProcessId() = 0;
-    virtual StoragePartition* GetStoragePartition() = 0;
-    virtual void OnReceivedResponseFromServer(WebSocketImpl* impl) = 0;
-    virtual void OnLostConnectionToClient(WebSocketImpl* impl) = 0;
-  };
-
-  WebSocketImpl(Delegate* delegate,
-                mojom::WebSocketRequest request,
-                int frame_id,
-                base::TimeDelta delay);
-  ~WebSocketImpl() override;
-
-  // The renderer process is going away.
-  // This function is virtual for testing.
-  virtual void GoAway();
-
-  // mojom::WebSocket methods:
-  void AddChannelRequest(const GURL& url,
-                         mojo::Array<mojo::String> requested_protocols,
-                         const url::Origin& origin,
-                         const GURL& first_party_for_cookies,
-                         const mojo::String& user_agent_override,
-                         mojom::WebSocketClientPtr client) override;
-  void SendFrame(bool fin, mojom::WebSocketMessageType type,
-                 mojo::Array<uint8_t> data) override;
-  void SendFlowControl(int64_t quota) override;
-  void StartClosingHandshake(uint16_t code,
-                             const mojo::String& reason) override;
-
-  bool handshake_succeeded() const { return handshake_succeeded_; }
-  void OnHandshakeSucceeded() { handshake_succeeded_ = true; }
-
- protected:
-  class WebSocketEventHandler;
-
-  void OnConnectionError();
-  void AddChannel(const GURL& socket_url,
-                  const std::vector<std::string>& requested_protocols,
-                  const url::Origin& origin,
-                  const GURL& first_party_for_cookies,
-                  const std::string& user_agent_override);
-
-  Delegate* delegate_;
-  mojo::Binding<mojom::WebSocket> binding_;
-
-  mojom::WebSocketClientPtr client_;
-
-  // The channel we use to send events to the network.
-  std::unique_ptr<net::WebSocketChannel> channel_;
-
-  // Delay used for per-renderer WebSocket throttling.
-  base::TimeDelta delay_;
-
-  // SendFlowControl() is delayed when OnFlowControl() is called before
-  // AddChannel() is called.
-  // Zero indicates there is no pending SendFlowControl().
-  int64_t pending_flow_control_quota_;
-
-  int frame_id_;
-
-  // handshake_succeeded_ is set and used by WebSocketManager to manage
-  // counters for per-renderer WebSocket throttling.
-  bool handshake_succeeded_;
-
-  base::WeakPtrFactory<WebSocketImpl> weak_ptr_factory_;
-
-  DISALLOW_COPY_AND_ASSIGN(WebSocketImpl);
-};
-
-}  // namespace content
-
-#endif  // CONTENT_BROWSER_WEBSOCKETS_WEBSOCKET_IMPL_H_
diff --git a/content/browser/websockets/websocket_manager.cc b/content/browser/websockets/websocket_manager.cc
deleted file mode 100644
index 586a697..0000000
--- a/content/browser/websockets/websocket_manager.cc
+++ /dev/null
@@ -1,176 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "content/browser/websockets/websocket_manager.h"
-
-#include <algorithm>
-#include <string>
-#include <vector>
-
-#include "base/callback.h"
-#include "base/logging.h"
-#include "base/numerics/safe_conversions.h"
-#include "base/rand_util.h"
-#include "content/public/browser/browser_thread.h"
-#include "content/public/browser/render_process_host.h"
-#include "services/shell/public/cpp/interface_registry.h"
-
-namespace content {
-
-namespace {
-
-const char kWebSocketManagerKeyName[] = "web_socket_manager";
-
-// Max number of pending connections per WebSocketManager used for per-renderer
-// WebSocket throttling.
-const int kMaxPendingWebSocketConnections = 255;
-
-}  // namespace
-
-class WebSocketManager::Handle : public base::SupportsUserData::Data {
- public:
-  explicit Handle(WebSocketManager* manager) : manager_(manager) {}
-  ~Handle() override {
-    BrowserThread::DeleteSoon(BrowserThread::IO, FROM_HERE, manager_);
-  }
-  WebSocketManager* manager() const { return manager_; }
- private:
-  WebSocketManager* manager_;
-};
-
-// static
-void WebSocketManager::CreateWebSocket(int process_id, int frame_id,
-                                       mojom::WebSocketRequest request) {
-  DCHECK(BrowserThread::CurrentlyOn(BrowserThread::UI));
-
-  RenderProcessHost* host = RenderProcessHost::FromID(process_id);
-  CHECK(host);
-
-  Handle* handle =
-      static_cast<Handle*>(host->GetUserData(kWebSocketManagerKeyName));
-  if (!handle) {
-    handle = new Handle(
-        new WebSocketManager(process_id, host->GetStoragePartition()));
-    host->SetUserData(kWebSocketManagerKeyName, handle);
-  }
-
-  BrowserThread::PostTask(
-      BrowserThread::IO,
-      FROM_HERE,
-      base::Bind(&WebSocketManager::DoCreateWebSocket,
-                 base::Unretained(handle->manager()),
-                 frame_id,
-                 base::Passed(&request)));
-}
-
-WebSocketManager::WebSocketManager(int process_id,
-                                   StoragePartition* storage_partition)
-    : process_id_(process_id),
-      storage_partition_(storage_partition),
-      num_pending_connections_(0),
-      num_current_succeeded_connections_(0),
-      num_previous_succeeded_connections_(0),
-      num_current_failed_connections_(0),
-      num_previous_failed_connections_(0) {}
-
-WebSocketManager::~WebSocketManager() {
-  DCHECK(BrowserThread::CurrentlyOn(BrowserThread::IO));
-
-  for (auto impl : impls_) {
-    impl->GoAway();
-    delete impl;
-  }
-}
-
-void WebSocketManager::DoCreateWebSocket(int frame_id,
-                                         mojom::WebSocketRequest request) {
-  DCHECK(BrowserThread::CurrentlyOn(BrowserThread::IO));
-
-  if (num_pending_connections_ >= kMaxPendingWebSocketConnections) {
-    // Too many websockets! By returning here, we let |request| die, which
-    // will be observed by the client as Mojo connection error.
-    return;
-  }
-
-  // Keep all WebSocketImpls alive until either the client drops its
-  // connection (see OnLostConnectionToClient) or we need to shutdown.
-
-  impls_.insert(CreateWebSocketImpl(this, std::move(request), frame_id,
-                                    CalculateDelay()));
-  ++num_pending_connections_;
-
-  if (!throttling_period_timer_.IsRunning()) {
-    throttling_period_timer_.Start(
-        FROM_HERE,
-        base::TimeDelta::FromMinutes(2),
-        this,
-        &WebSocketManager::ThrottlingPeriodTimerCallback);
-  }
-}
-
-// Calculate delay as described in the per-renderer WebSocket throttling
-// design doc: https://goo.gl/tldFNn
-base::TimeDelta WebSocketManager::CalculateDelay() const {
-  int64_t f = num_previous_failed_connections_ +
-              num_current_failed_connections_;
-  int64_t s = num_previous_succeeded_connections_ +
-              num_current_succeeded_connections_;
-  int p = num_pending_connections_;
-  return base::TimeDelta::FromMilliseconds(
-      base::RandInt(1000, 5000) *
-      (1 << std::min(p + f / (s + 1), INT64_C(16))) / 65536);
-}
-
-void WebSocketManager::ThrottlingPeriodTimerCallback() {
-  num_previous_failed_connections_ = num_current_failed_connections_;
-  num_current_failed_connections_ = 0;
-
-  num_previous_succeeded_connections_ = num_current_succeeded_connections_;
-  num_current_succeeded_connections_ = 0;
-
-  if (num_pending_connections_ == 0 &&
-      num_previous_failed_connections_ == 0 &&
-      num_previous_succeeded_connections_ == 0) {
-    throttling_period_timer_.Stop();
-  }
-}
-
-WebSocketImpl* WebSocketManager::CreateWebSocketImpl(
-    WebSocketImpl::Delegate* delegate,
-    mojom::WebSocketRequest request,
-    int frame_id,
-    base::TimeDelta delay) {
-  return new WebSocketImpl(delegate, std::move(request), frame_id, delay);
-}
-
-int WebSocketManager::GetClientProcessId() {
-  return process_id_;
-}
-
-StoragePartition* WebSocketManager::GetStoragePartition() {
-  return storage_partition_;
-}
-
-void WebSocketManager::OnReceivedResponseFromServer(WebSocketImpl* impl) {
-  // The server accepted this WebSocket connection.
-  impl->OnHandshakeSucceeded();
-  --num_pending_connections_;
-  DCHECK_GE(num_pending_connections_, 0);
-  ++num_current_succeeded_connections_;
-}
-
-void WebSocketManager::OnLostConnectionToClient(WebSocketImpl* impl) {
-  // The client is no longer interested in this WebSocket.
-  if (!impl->handshake_succeeded()) {
-    // Update throttling counters (failure).
-    --num_pending_connections_;
-    DCHECK_GE(num_pending_connections_, 0);
-    ++num_current_failed_connections_;
-  }
-  impl->GoAway();
-  impls_.erase(impl);
-  delete impl;
-}
-
-}  // namespace content
diff --git a/content/browser/websockets/websocket_manager.h b/content/browser/websockets/websocket_manager.h
deleted file mode 100644
index 4047e43..0000000
--- a/content/browser/websockets/websocket_manager.h
+++ /dev/null
@@ -1,86 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CONTENT_BROWSER_WEBSOCKETS_WEBSOCKET_MANAGER_H_
-#define CONTENT_BROWSER_WEBSOCKETS_WEBSOCKET_MANAGER_H_
-
-#include <set>
-
-#include "base/compiler_specific.h"
-#include "base/macros.h"
-#include "base/timer/timer.h"
-#include "content/browser/websockets/websocket_impl.h"
-#include "content/common/content_export.h"
-
-namespace shell {
-class InterfaceRegistry;
-}  // namespace shell
-
-namespace content {
-class StoragePartition;
-
-// The WebSocketManager is a per child process instance that manages the
-// lifecycle of WebSocketImpl objects. It is responsible for creating
-// WebSocketImpl objects for each WebSocketRequest and throttling the number of
-// WebSocketImpl objects in use.
-class CONTENT_EXPORT WebSocketManager
-    : NON_EXPORTED_BASE(public WebSocketImpl::Delegate) {
- public:
-  // Called on the UI thread:
-  static void CreateWebSocket(int process_id, int frame_id,
-                              mojom::WebSocketRequest request);
-
- protected:
-  class Handle;
-  friend class base::DeleteHelper<WebSocketManager>;
-
-  // Called on the UI thread:
-  WebSocketManager(int process_id, StoragePartition* storage_partition);
-
-  // All other methods must run on the IO thread.
-
-  ~WebSocketManager() override;
-  void DoCreateWebSocket(int frame_id, mojom::WebSocketRequest request);
-  base::TimeDelta CalculateDelay() const;
-  void ThrottlingPeriodTimerCallback();
-
-  // This is virtual to support testing.
-  virtual WebSocketImpl* CreateWebSocketImpl(WebSocketImpl::Delegate* delegate,
-                                             mojom::WebSocketRequest request,
-                                             int frame_id,
-                                             base::TimeDelta delay);
-
-  // WebSocketImpl::Delegate methods:
-  int GetClientProcessId() override;
-  StoragePartition* GetStoragePartition() override;
-  void OnReceivedResponseFromServer(WebSocketImpl* impl) override;
-  void OnLostConnectionToClient(WebSocketImpl* impl) override;
-
-  int process_id_;
-  StoragePartition* storage_partition_;
-
-  std::set<WebSocketImpl*> impls_;
-
-  // Timer and counters for per-renderer WebSocket throttling.
-  base::RepeatingTimer throttling_period_timer_;
-
-  // The current number of pending connections.
-  int num_pending_connections_;
-
-  // The number of handshakes that failed in the current and previous time
-  // period.
-  int64_t num_current_succeeded_connections_;
-  int64_t num_previous_succeeded_connections_;
-
-  // The number of handshakes that succeeded in the current and previous time
-  // period.
-  int64_t num_current_failed_connections_;
-  int64_t num_previous_failed_connections_;
-
-  DISALLOW_COPY_AND_ASSIGN(WebSocketManager);
-};
-
-}  // namespace content
-
-#endif  // CONTENT_BROWSER_WEBSOCKETS_WEBSOCKET_MANAGER_H_
diff --git a/content/browser/websockets/websocket_manager_unittest.cc b/content/browser/websockets/websocket_manager_unittest.cc
deleted file mode 100644
index fc5f94f..0000000
--- a/content/browser/websockets/websocket_manager_unittest.cc
+++ /dev/null
@@ -1,242 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include <algorithm>
-#include <memory>
-#include <vector>
-
-#include "content/browser/websockets/websocket_manager.h"
-#include "content/public/test/test_browser_thread_bundle.h"
-#include "ipc/ipc_message.h"
-#include "testing/gtest/include/gtest/gtest.h"
-#include "url/gurl.h"
-#include "url/origin.h"
-
-namespace content {
-namespace {
-
-// This number is unlikely to occur by chance.
-static const int kMagicRenderProcessId = 506116062;
-
-class TestWebSocketImpl : public WebSocketImpl {
- public:
-  TestWebSocketImpl(Delegate* delegate,
-                    mojom::WebSocketRequest request,
-                    int frame_id,
-                    base::TimeDelta delay)
-      : WebSocketImpl(delegate, std::move(request), frame_id, delay) {}
-
-  base::TimeDelta delay() const { return delay_; }
-
-  void SimulateConnectionError() {
-    OnConnectionError();
-  }
-};
-
-class TestWebSocketManager : public WebSocketManager {
- public:
-  TestWebSocketManager()
-      : WebSocketManager(kMagicRenderProcessId, nullptr) {}
-
-  const std::vector<TestWebSocketImpl*>& sockets() const {
-    return sockets_;
-  }
-
-  int num_pending_connections() const {
-    return num_pending_connections_;
-  }
-  int64_t num_failed_connections() const {
-    return num_current_failed_connections_ + num_previous_failed_connections_;
-  }
-  int64_t num_succeeded_connections() const {
-    return num_current_succeeded_connections_ +
-           num_previous_succeeded_connections_;
-  }
-
-  void DoCreateWebSocket(mojom::WebSocketRequest request) {
-    WebSocketManager::DoCreateWebSocket(MSG_ROUTING_NONE, std::move(request));
-  }
-
- private:
-  WebSocketImpl* CreateWebSocketImpl(WebSocketImpl::Delegate* delegate,
-                                     mojom::WebSocketRequest request,
-                                     int frame_id,
-                                     base::TimeDelta delay) override {
-    TestWebSocketImpl* impl =
-        new TestWebSocketImpl(delegate, std::move(request), frame_id, delay);
-    // We keep a vector of sockets here to track their creation order.
-    sockets_.push_back(impl);
-    return impl;
-  }
-
-  void OnLostConnectionToClient(WebSocketImpl* impl) override {
-    auto it = std::find(sockets_.begin(), sockets_.end(),
-                        static_cast<TestWebSocketImpl*>(impl));
-    ASSERT_TRUE(it != sockets_.end());
-    sockets_.erase(it);
-
-    WebSocketManager::OnLostConnectionToClient(impl);
-  }
-
-  std::vector<TestWebSocketImpl*> sockets_;
-};
-
-class WebSocketManagerTest : public ::testing::Test {
- public:
-  WebSocketManagerTest()
-      : thread_bundle_(TestBrowserThreadBundle::IO_MAINLOOP) {
-    websocket_manager_.reset(new TestWebSocketManager());
-  }
-
-  void AddMultipleChannels(int number_of_channels) {
-    for (int i = 0; i < number_of_channels; ++i) {
-      mojom::WebSocketPtr websocket;
-      websocket_manager_->DoCreateWebSocket(mojo::GetProxy(&websocket));
-    }
-  }
-
-  void AddAndCancelMultipleChannels(int number_of_channels) {
-    for (int i = 0; i < number_of_channels; ++i) {
-      mojom::WebSocketPtr websocket;
-      websocket_manager_->DoCreateWebSocket(mojo::GetProxy(&websocket));
-      websocket_manager_->sockets().back()->SimulateConnectionError();
-    }
-  }
-
-  TestWebSocketManager* websocket_manager() { return websocket_manager_.get(); }
-
- private:
-  TestBrowserThreadBundle thread_bundle_;
-  std::unique_ptr<TestWebSocketManager> websocket_manager_;
-};
-
-TEST_F(WebSocketManagerTest, Construct) {
-  // Do nothing.
-}
-
-TEST_F(WebSocketManagerTest, CreateWebSocket) {
-  mojom::WebSocketPtr websocket;
-
-  websocket_manager()->DoCreateWebSocket(mojo::GetProxy(&websocket));
-
-  EXPECT_EQ(1U, websocket_manager()->sockets().size());
-}
-
-TEST_F(WebSocketManagerTest, SendFrameButNotConnectedYet) {
-  mojom::WebSocketPtr websocket;
-
-  websocket_manager()->DoCreateWebSocket(mojo::GetProxy(&websocket));
-
-  // This should not crash.
-  mojo::Array<uint8_t> data;
-  websocket->SendFrame(
-      true, mojom::WebSocketMessageType::TEXT, std::move(data));
-}
-
-TEST_F(WebSocketManagerTest, DelayFor4thPendingConnectionIsZero) {
-  AddMultipleChannels(4);
-
-  EXPECT_EQ(4, websocket_manager()->num_pending_connections());
-  EXPECT_EQ(0, websocket_manager()->num_failed_connections());
-  EXPECT_EQ(0, websocket_manager()->num_succeeded_connections());
-
-  ASSERT_EQ(4U, websocket_manager()->sockets().size());
-  EXPECT_EQ(base::TimeDelta(), websocket_manager()->sockets()[3]->delay());
-}
-
-TEST_F(WebSocketManagerTest, DelayFor8thPendingConnectionIsNonZero) {
-  AddMultipleChannels(8);
-
-  EXPECT_EQ(8, websocket_manager()->num_pending_connections());
-  EXPECT_EQ(0, websocket_manager()->num_failed_connections());
-  EXPECT_EQ(0, websocket_manager()->num_succeeded_connections());
-
-  ASSERT_EQ(8U, websocket_manager()->sockets().size());
-  EXPECT_LT(base::TimeDelta(), websocket_manager()->sockets()[7]->delay());
-}
-
-TEST_F(WebSocketManagerTest, DelayFor17thPendingConnection) {
-  AddMultipleChannels(17);
-
-  EXPECT_EQ(17, websocket_manager()->num_pending_connections());
-  EXPECT_EQ(0, websocket_manager()->num_failed_connections());
-  EXPECT_EQ(0, websocket_manager()->num_succeeded_connections());
-
-  ASSERT_EQ(17U, websocket_manager()->sockets().size());
-  EXPECT_LE(base::TimeDelta::FromMilliseconds(1000),
-            websocket_manager()->sockets()[16]->delay());
-  EXPECT_GE(base::TimeDelta::FromMilliseconds(5000),
-            websocket_manager()->sockets()[16]->delay());
-}
-
-// The 256th connection is rejected by per-renderer WebSocket throttling.
-// This is not counted as a failure.
-TEST_F(WebSocketManagerTest, Rejects256thPendingConnection) {
-  AddMultipleChannels(256);
-
-  EXPECT_EQ(255, websocket_manager()->num_pending_connections());
-  EXPECT_EQ(0, websocket_manager()->num_failed_connections());
-  EXPECT_EQ(0, websocket_manager()->num_succeeded_connections());
-
-  ASSERT_EQ(255U, websocket_manager()->sockets().size());
-}
-
-TEST_F(WebSocketManagerTest, DelayIsZeroAfter3FailedConnections) {
-  AddAndCancelMultipleChannels(3);
-
-  EXPECT_EQ(0, websocket_manager()->num_pending_connections());
-  EXPECT_EQ(3, websocket_manager()->num_failed_connections());
-  EXPECT_EQ(0, websocket_manager()->num_succeeded_connections());
-
-  AddMultipleChannels(1);
-
-  ASSERT_EQ(1U, websocket_manager()->sockets().size());
-  EXPECT_EQ(base::TimeDelta(), websocket_manager()->sockets()[0]->delay());
-}
-
-TEST_F(WebSocketManagerTest, DelayIsNonZeroAfter7FailedConnections) {
-  AddAndCancelMultipleChannels(7);
-
-  EXPECT_EQ(0, websocket_manager()->num_pending_connections());
-  EXPECT_EQ(7, websocket_manager()->num_failed_connections());
-  EXPECT_EQ(0, websocket_manager()->num_succeeded_connections());
-
-  AddMultipleChannels(1);
-
-  ASSERT_EQ(1U, websocket_manager()->sockets().size());
-  EXPECT_LT(base::TimeDelta(), websocket_manager()->sockets()[0]->delay());
-}
-
-TEST_F(WebSocketManagerTest, DelayAfter16FailedConnections) {
-  AddAndCancelMultipleChannels(16);
-
-  EXPECT_EQ(0, websocket_manager()->num_pending_connections());
-  EXPECT_EQ(16, websocket_manager()->num_failed_connections());
-  EXPECT_EQ(0, websocket_manager()->num_succeeded_connections());
-
-  AddMultipleChannels(1);
-
-  ASSERT_EQ(1U, websocket_manager()->sockets().size());
-  EXPECT_LE(base::TimeDelta::FromMilliseconds(1000),
-            websocket_manager()->sockets()[0]->delay());
-  EXPECT_GE(base::TimeDelta::FromMilliseconds(5000),
-            websocket_manager()->sockets()[0]->delay());
-}
-
-TEST_F(WebSocketManagerTest, NotRejectedAfter255FailedConnections) {
-  AddAndCancelMultipleChannels(255);
-
-  EXPECT_EQ(0, websocket_manager()->num_pending_connections());
-  EXPECT_EQ(255, websocket_manager()->num_failed_connections());
-  EXPECT_EQ(0, websocket_manager()->num_succeeded_connections());
-
-  AddMultipleChannels(1);
-
-  EXPECT_EQ(1, websocket_manager()->num_pending_connections());
-  EXPECT_EQ(255, websocket_manager()->num_failed_connections());
-  EXPECT_EQ(0, websocket_manager()->num_succeeded_connections());
-}
-
-}  // namespace
-}  // namespace content
diff --git a/content/child/OWNERS b/content/child/OWNERS
index f04dee2..3d62269 100644
--- a/content/child/OWNERS
+++ b/content/child/OWNERS
@@ -4,6 +4,11 @@ esprehn@chromium.org
 # AppCache
 per-file appcache*=michaeln@chromium.org
 
+# WebSocket
+per-file *websocket*=ricea@chromium.org
+per-file *websocket*=tyoshino@chromium.org
+per-file *websocket*=yhirano@chromium.org
+
 # WebSQL
 per-file database_*=jsbell@chromium.org
 per-file database_*=michaeln@chromium.org
diff --git a/content/child/blink_platform_impl.cc b/content/child/blink_platform_impl.cc
index 936edc5..ba47d22 100644
--- a/content/child/blink_platform_impl.cc
+++ b/content/child/blink_platform_impl.cc
@@ -49,6 +49,7 @@
 #include "content/child/thread_safe_sender.h"
 #include "content/child/web_url_loader_impl.h"
 #include "content/child/web_url_request_util.h"
+#include "content/child/websocket_bridge.h"
 #include "content/child/worker_thread_registry.h"
 #include "content/public/common/content_client.h"
 #include "net/base/data_url.h"
@@ -409,6 +410,10 @@ void BlinkPlatformImpl::UpdateWebThreadTLS(blink::WebThread* thread,
 BlinkPlatformImpl::~BlinkPlatformImpl() {
 }
 
+blink::WebSocketHandle* BlinkPlatformImpl::createWebSocketHandle() {
+  return new WebSocketBridge;
+}
+
 WebString BlinkPlatformImpl::userAgent() {
   return blink::WebString::fromUTF8(GetContentClient()->GetUserAgent());
 }
diff --git a/content/child/blink_platform_impl.h b/content/child/blink_platform_impl.h
index 59c3a00..1ee9106 100644
--- a/content/child/blink_platform_impl.h
+++ b/content/child/blink_platform_impl.h
@@ -83,6 +83,7 @@ class CONTENT_EXPORT BlinkPlatformImpl
 
   size_t maxDecodedImageBytes() override;
   uint32_t getUniqueIdForProcess() override;
+  blink::WebSocketHandle* createWebSocketHandle() override;
   blink::WebString userAgent() override;
   blink::WebData parseDataURL(const blink::WebURL& url,
                               blink::WebString& mimetype,
diff --git a/content/child/child_thread_impl.cc b/content/child/child_thread_impl.cc
index 6f73603..e4e008b 100644
--- a/content/child/child_thread_impl.cc
+++ b/content/child/child_thread_impl.cc
@@ -49,6 +49,8 @@
 #include "content/child/resource_dispatcher.h"
 #include "content/child/service_worker/service_worker_message_filter.h"
 #include "content/child/thread_safe_sender.h"
+#include "content/child/websocket_dispatcher.h"
+#include "content/child/websocket_message_filter.h"
 #include "content/common/child_process_messages.h"
 #include "content/common/in_process_child_thread_params.h"
 #include "content/common/mojo/constants.h"
@@ -468,6 +470,7 @@ void ChildThreadImpl::Init(const Options& options) {
 
   resource_dispatcher_.reset(new ResourceDispatcher(
       this, message_loop()->task_runner()));
+  websocket_dispatcher_.reset(new WebSocketDispatcher);
   file_system_dispatcher_.reset(new FileSystemDispatcher());
 
   histogram_message_filter_ = new ChildHistogramMessageFilter();
@@ -485,12 +488,16 @@ void ChildThreadImpl::Init(const Options& options) {
       new NotificationDispatcher(thread_safe_sender_.get());
   push_dispatcher_ = new PushDispatcher(thread_safe_sender_.get());
 
+  websocket_message_filter_ =
+      new WebSocketMessageFilter(websocket_dispatcher_.get());
+
   channel_->AddFilter(histogram_message_filter_.get());
   channel_->AddFilter(resource_message_filter_.get());
   channel_->AddFilter(quota_message_filter_->GetFilter());
   channel_->AddFilter(notification_dispatcher_->GetFilter());
   channel_->AddFilter(push_dispatcher_->GetFilter());
   channel_->AddFilter(service_worker_message_filter_->GetFilter());
+  channel_->AddFilter(websocket_message_filter_.get());
 
   if (!IsInBrowserProcess()) {
     // In single process mode, browser-side tracing and memory will cover the
diff --git a/content/child/child_thread_impl.h b/content/child/child_thread_impl.h
index 94bd0ba..ae2fa20 100644
--- a/content/child/child_thread_impl.h
+++ b/content/child/child_thread_impl.h
@@ -64,6 +64,8 @@ class QuotaDispatcher;
 class QuotaMessageFilter;
 class ResourceDispatcher;
 class ThreadSafeSender;
+class WebSocketDispatcher;
+class WebSocketMessageFilter;
 struct RequestInfo;
 
 // The main thread of a child process derives from this class.
@@ -137,6 +139,10 @@ class CONTENT_EXPORT ChildThreadImpl
     return resource_dispatcher_.get();
   }
 
+  WebSocketDispatcher* websocket_dispatcher() const {
+    return websocket_dispatcher_.get();
+  }
+
   FileSystemDispatcher* file_system_dispatcher() const {
     return file_system_dispatcher_.get();
   }
@@ -180,6 +186,10 @@ class CONTENT_EXPORT ChildThreadImpl
     return resource_message_filter_.get();
   }
 
+  WebSocketMessageFilter* websocket_message_filter() const {
+    return websocket_message_filter_.get();
+  }
+
   base::MessageLoop* message_loop() const { return message_loop_; }
 
   // Returns the one child thread. Can only be called on the main thread.
@@ -266,6 +276,8 @@ class CONTENT_EXPORT ChildThreadImpl
   // Handles resource loads for this process.
   std::unique_ptr<ResourceDispatcher> resource_dispatcher_;
 
+  std::unique_ptr<WebSocketDispatcher> websocket_dispatcher_;
+
   // The OnChannelError() callback was invoked - the channel is dead, don't
   // attempt to communicate.
   bool on_channel_error_called_;
@@ -284,6 +296,8 @@ class CONTENT_EXPORT ChildThreadImpl
 
   scoped_refptr<QuotaMessageFilter> quota_message_filter_;
 
+  scoped_refptr<WebSocketMessageFilter> websocket_message_filter_;
+
   scoped_refptr<NotificationDispatcher> notification_dispatcher_;
 
   scoped_refptr<PushDispatcher> push_dispatcher_;
diff --git a/content/child/simple_webmimeregistry_impl_unittest.cc b/content/child/simple_webmimeregistry_impl_unittest.cc
index 0f56f62..40d3bd5 100644
--- a/content/child/simple_webmimeregistry_impl_unittest.cc
+++ b/content/child/simple_webmimeregistry_impl_unittest.cc
@@ -19,14 +19,3 @@ TEST(SimpleWebMimeRegistryImpl, mimeTypeTest)
   EXPECT_TRUE(registry.supportsImageMIMEType("image/gif"));
 }
 
-TEST(SimpleWebMimeRegistryImpl, PluginMimeTypes) {
-  content::SimpleWebMimeRegistryImpl registry;
-
-  // Since we've removed MIME type guessing based on plugin-declared file
-  // extensions, ensure that the SimpleWebMimeRegistry already contains
-  // the extensions used by common PPAPI plugins.
-  EXPECT_EQ("application/pdf",
-            registry.wellKnownMimeTypeForExtension("pdf").utf8());
-  EXPECT_EQ("application/x-shockwave-flash",
-            registry.wellKnownMimeTypeForExtension("swf").utf8());
-}
diff --git a/content/child/websocket_bridge.cc b/content/child/websocket_bridge.cc
new file mode 100644
index 0000000..bd94b42
--- /dev/null
+++ b/content/child/websocket_bridge.cc
@@ -0,0 +1,304 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "content/child/websocket_bridge.h"
+
+#include <stdint.h>
+#include <string>
+#include <utility>
+#include <vector>
+
+#include "base/logging.h"
+#include "base/strings/string_util.h"
+#include "content/child/child_thread_impl.h"
+#include "content/child/websocket_dispatcher.h"
+#include "content/common/websocket.h"
+#include "content/common/websocket_messages.h"
+#include "ipc/ipc_message.h"
+#include "ipc/ipc_message_macros.h"
+#include "third_party/WebKit/public/platform/WebSecurityOrigin.h"
+#include "third_party/WebKit/public/platform/WebString.h"
+#include "third_party/WebKit/public/platform/WebURL.h"
+#include "third_party/WebKit/public/platform/WebVector.h"
+#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandle.h"
+#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandleClient.h"
+#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandshakeRequestInfo.h"
+#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandshakeResponseInfo.h"
+#include "url/gurl.h"
+#include "url/origin.h"
+
+using blink::WebSecurityOrigin;
+using blink::WebSocketHandle;
+using blink::WebSocketHandleClient;
+using blink::WebString;
+using blink::WebURL;
+using blink::WebVector;
+
+namespace content {
+
+namespace {
+
+const unsigned short kAbnormalShutdownOpCode = 1006;
+
+}  // namespace
+
+WebSocketBridge::WebSocketBridge()
+    : channel_id_(kInvalidChannelId),
+      render_frame_id_(MSG_ROUTING_NONE),
+      client_(NULL) {}
+
+WebSocketBridge::~WebSocketBridge() {
+  if (channel_id_ != kInvalidChannelId) {
+    // The connection is abruptly disconnected by the renderer without
+    // closing handshake.
+    ChildThreadImpl::current()->Send(
+        new WebSocketMsg_DropChannel(channel_id_,
+                                     false,
+                                     kAbnormalShutdownOpCode,
+                                     std::string()));
+  }
+  Disconnect();
+}
+
+bool WebSocketBridge::OnMessageReceived(const IPC::Message& msg) {
+  bool handled = true;
+  IPC_BEGIN_MESSAGE_MAP(WebSocketBridge, msg)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_AddChannelResponse, DidConnect)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_NotifyStartOpeningHandshake,
+                        DidStartOpeningHandshake)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_NotifyFinishOpeningHandshake,
+                        DidFinishOpeningHandshake)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_NotifyFailure, DidFail)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_SendFrame, DidReceiveData)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_FlowControl, DidReceiveFlowControl)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_DropChannel, DidClose)
+    IPC_MESSAGE_HANDLER(WebSocketMsg_NotifyClosing,
+                        DidStartClosingHandshake)
+    IPC_MESSAGE_UNHANDLED(handled = false)
+  IPC_END_MESSAGE_MAP()
+  return handled;
+}
+
+void WebSocketBridge::DidConnect(const std::string& selected_protocol,
+                                 const std::string& extensions) {
+  WebSocketHandleClient* client = client_;
+  DVLOG(1) << "WebSocketBridge::DidConnect("
+           << selected_protocol << ", "
+           << extensions << ")";
+  if (!client)
+    return;
+
+  WebString protocol_to_pass = WebString::fromUTF8(selected_protocol);
+  WebString extensions_to_pass = WebString::fromUTF8(extensions);
+  client->didConnect(this, protocol_to_pass, extensions_to_pass);
+  // |this| can be deleted here.
+}
+
+void WebSocketBridge::DidStartOpeningHandshake(
+    const WebSocketHandshakeRequest& request) {
+  DVLOG(1) << "WebSocketBridge::DidStartOpeningHandshake("
+           << request.url << ")";
+  // All strings are already encoded to ASCII in the browser.
+  blink::WebSocketHandshakeRequestInfo request_to_pass;
+  request_to_pass.setURL(WebURL(request.url));
+  for (size_t i = 0; i < request.headers.size(); ++i) {
+    const std::pair<std::string, std::string>& header = request.headers[i];
+    request_to_pass.addHeaderField(WebString::fromLatin1(header.first),
+                                   WebString::fromLatin1(header.second));
+  }
+  request_to_pass.setHeadersText(WebString::fromLatin1(request.headers_text));
+  client_->didStartOpeningHandshake(this, request_to_pass);
+}
+
+void WebSocketBridge::DidFinishOpeningHandshake(
+    const WebSocketHandshakeResponse& response) {
+  DVLOG(1) << "WebSocketBridge::DidFinishOpeningHandshake("
+           << response.url << ")";
+  // All strings are already encoded to ASCII in the browser.
+  blink::WebSocketHandshakeResponseInfo response_to_pass;
+  response_to_pass.setStatusCode(response.status_code);
+  response_to_pass.setStatusText(WebString::fromLatin1(response.status_text));
+  for (size_t i = 0; i < response.headers.size(); ++i) {
+    const std::pair<std::string, std::string>& header = response.headers[i];
+    response_to_pass.addHeaderField(WebString::fromLatin1(header.first),
+                                    WebString::fromLatin1(header.second));
+  }
+  response_to_pass.setHeadersText(WebString::fromLatin1(response.headers_text));
+  client_->didFinishOpeningHandshake(this, response_to_pass);
+}
+
+void WebSocketBridge::DidFail(const std::string& message) {
+  DVLOG(1) << "WebSocketBridge::DidFail(" << message << ")";
+  WebSocketHandleClient* client = client_;
+  Disconnect();
+  if (!client)
+    return;
+
+  WebString message_to_pass = WebString::fromUTF8(message);
+  client->didFail(this, message_to_pass);
+  // |this| can be deleted here.
+}
+
+void WebSocketBridge::DidReceiveData(bool fin,
+                                     WebSocketMessageType type,
+                                     const std::vector<char>& data) {
+  DVLOG(1) << "WebSocketBridge::DidReceiveData("
+           << fin << ", "
+           << type << ", "
+           << "(data size = " << data.size() << "))";
+  if (!client_)
+    return;
+
+  WebSocketHandle::MessageType type_to_pass =
+      WebSocketHandle::MessageTypeContinuation;
+  switch (type) {
+    case WEB_SOCKET_MESSAGE_TYPE_CONTINUATION:
+      type_to_pass = WebSocketHandle::MessageTypeContinuation;
+      break;
+    case WEB_SOCKET_MESSAGE_TYPE_TEXT:
+      type_to_pass = WebSocketHandle::MessageTypeText;
+      break;
+    case WEB_SOCKET_MESSAGE_TYPE_BINARY:
+      type_to_pass = WebSocketHandle::MessageTypeBinary;
+      break;
+  }
+  const char* data_to_pass = data.empty() ? NULL : &data[0];
+  client_->didReceiveData(this, fin, type_to_pass, data_to_pass, data.size());
+  // |this| can be deleted here.
+}
+
+void WebSocketBridge::DidReceiveFlowControl(int64_t quota) {
+  DVLOG(1) << "WebSocketBridge::DidReceiveFlowControl(" << quota << ")";
+  if (!client_)
+    return;
+
+  client_->didReceiveFlowControl(this, quota);
+  // |this| can be deleted here.
+}
+
+void WebSocketBridge::DidClose(bool was_clean,
+                               unsigned short code,
+                               const std::string& reason) {
+  DVLOG(1) << "WebSocketBridge::DidClose("
+           << was_clean << ", "
+           << code << ", "
+           << reason << ")";
+  WebSocketHandleClient* client = client_;
+  Disconnect();
+  if (!client)
+    return;
+
+  WebString reason_to_pass = WebString::fromUTF8(reason);
+  client->didClose(this, was_clean, code, reason_to_pass);
+  // |this| can be deleted here.
+}
+
+void WebSocketBridge::DidStartClosingHandshake() {
+  DVLOG(1) << "WebSocketBridge::DidStartClosingHandshake()";
+  if (!client_)
+    return;
+
+  client_->didStartClosingHandshake(this);
+  // |this| can be deleted here.
+}
+
+void WebSocketBridge::connect(const WebURL& url,
+                              const WebVector<WebString>& protocols,
+                              const WebSecurityOrigin& origin,
+                              const WebURL& first_party_for_cookies,
+                              const WebString& user_agent_override,
+                              WebSocketHandleClient* client) {
+  DCHECK_EQ(kInvalidChannelId, channel_id_);
+  WebSocketDispatcher* dispatcher =
+      ChildThreadImpl::current()->websocket_dispatcher();
+  channel_id_ = dispatcher->AddBridge(this);
+  client_ = client;
+
+  std::vector<std::string> protocols_to_pass;
+  for (size_t i = 0; i < protocols.size(); ++i)
+    protocols_to_pass.push_back(protocols[i].utf8());
+
+  DVLOG(1) << "Bridge#" << channel_id_ << " Connect(" << url << ", ("
+           << base::JoinString(protocols_to_pass, ", ") << "), "
+           << origin.toString().utf8() << ")";
+
+  WebSocketHostMsg_AddChannelRequest_Params params;
+  params.socket_url = url;
+  params.requested_protocols = protocols_to_pass;
+  params.origin = origin;
+  params.first_party_for_cookies = first_party_for_cookies;
+  params.user_agent_override = user_agent_override.latin1();
+  params.render_frame_id = render_frame_id_;
+
+  // Headers (ie: User-Agent) are ISO Latin 1.
+  ChildThreadImpl::current()->Send(new WebSocketHostMsg_AddChannelRequest(
+      channel_id_, params));
+}
+
+void WebSocketBridge::send(bool fin,
+                           WebSocketHandle::MessageType type,
+                           const char* data,
+                           size_t size) {
+  if (channel_id_ == kInvalidChannelId)
+    return;
+
+  WebSocketMessageType type_to_pass = WEB_SOCKET_MESSAGE_TYPE_CONTINUATION;
+  switch (type) {
+    case WebSocketHandle::MessageTypeContinuation:
+      type_to_pass = WEB_SOCKET_MESSAGE_TYPE_CONTINUATION;
+      break;
+    case WebSocketHandle::MessageTypeText:
+      type_to_pass = WEB_SOCKET_MESSAGE_TYPE_TEXT;
+      break;
+    case WebSocketHandle::MessageTypeBinary:
+      type_to_pass = WEB_SOCKET_MESSAGE_TYPE_BINARY;
+      break;
+  }
+
+  DVLOG(1) << "Bridge #" << channel_id_ << " Send("
+           << fin << ", " << type_to_pass << ", "
+           << "(data size = "  << size << "))";
+
+  ChildThreadImpl::current()->Send(
+      new WebSocketMsg_SendFrame(channel_id_,
+                                 fin,
+                                 type_to_pass,
+                                 std::vector<char>(data, data + size)));
+}
+
+void WebSocketBridge::flowControl(int64_t quota) {
+  if (channel_id_ == kInvalidChannelId)
+    return;
+
+  DVLOG(1) << "Bridge #" << channel_id_ << " FlowControl(" << quota << ")";
+
+  ChildThreadImpl::current()->Send(
+      new WebSocketMsg_FlowControl(channel_id_, quota));
+}
+
+void WebSocketBridge::close(unsigned short code,
+                            const WebString& reason) {
+  if (channel_id_ == kInvalidChannelId)
+    return;
+
+  std::string reason_to_pass = reason.utf8();
+  DVLOG(1) << "Bridge #" << channel_id_ << " Close("
+           << code << ", " << reason_to_pass << ")";
+  // This method is for closing handshake and hence |was_clean| shall be true.
+  ChildThreadImpl::current()->Send(
+      new WebSocketMsg_DropChannel(channel_id_, true, code, reason_to_pass));
+}
+
+void WebSocketBridge::Disconnect() {
+  if (channel_id_ == kInvalidChannelId)
+    return;
+  WebSocketDispatcher* dispatcher =
+      ChildThreadImpl::current()->websocket_dispatcher();
+  dispatcher->RemoveBridge(channel_id_);
+
+  channel_id_ = kInvalidChannelId;
+  client_ = NULL;
+}
+
+}  // namespace content
diff --git a/content/child/websocket_bridge.h b/content/child/websocket_bridge.h
new file mode 100644
index 0000000..d8ccc2b
--- /dev/null
+++ b/content/child/websocket_bridge.h
@@ -0,0 +1,77 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CONTENT_CHILD_WEBSOCKET_BRIDGE_H_
+#define CONTENT_CHILD_WEBSOCKET_BRIDGE_H_
+
+#include <stddef.h>
+#include <stdint.h>
+#include <string>
+#include <vector>
+
+#include "content/common/websocket.h"
+#include "ipc/ipc_message.h"
+#include "third_party/WebKit/public/platform/WebVector.h"
+#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandle.h"
+
+namespace blink {
+class WebSecurityOrigin;
+class WebString;
+class WebURL;
+}  // namespace blink
+
+namespace content {
+
+class WebSocketBridge : public blink::WebSocketHandle {
+ public:
+  WebSocketBridge();
+
+  // Handles an IPC message from the browser process.
+  bool OnMessageReceived(const IPC::Message& message);
+
+  // WebSocketHandle functions.
+  void connect(const blink::WebURL& url,
+               const blink::WebVector<blink::WebString>& protocols,
+               const blink::WebSecurityOrigin& origin,
+               const blink::WebURL& first_party_for_cookies,
+               const blink::WebString& user_agent_override,
+               blink::WebSocketHandleClient* client) override;
+  void send(bool fin,
+            WebSocketHandle::MessageType type,
+            const char* data,
+            size_t size) override;
+  void flowControl(int64_t quota) override;
+  void close(unsigned short code, const blink::WebString& reason) override;
+
+  void Disconnect();
+
+  void set_render_frame_id(int id) {
+    render_frame_id_ = id;
+  }
+
+ private:
+  ~WebSocketBridge() override;
+
+  void DidConnect(const std::string& selected_protocol,
+                  const std::string& extensions);
+  void DidStartOpeningHandshake(const WebSocketHandshakeRequest& request);
+  void DidFinishOpeningHandshake(const WebSocketHandshakeResponse& response);
+  void DidFail(const std::string& message);
+  void DidReceiveData(bool fin,
+                      WebSocketMessageType type,
+                      const std::vector<char>& data);
+  void DidReceiveFlowControl(int64_t quota);
+  void DidClose(bool was_clean, unsigned short code, const std::string& reason);
+  void DidStartClosingHandshake();
+
+  int channel_id_;
+  int render_frame_id_;
+  blink::WebSocketHandleClient* client_;
+
+  static const int kInvalidChannelId = -1;
+};
+
+}  // namespace content
+
+#endif  // CONTENT_CHILD_WEBSOCKET_BRIDGE_H_
diff --git a/content/child/websocket_dispatcher.cc b/content/child/websocket_dispatcher.cc
new file mode 100644
index 0000000..13535eb
--- /dev/null
+++ b/content/child/websocket_dispatcher.cc
@@ -0,0 +1,74 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "content/child/websocket_dispatcher.h"
+
+#include <stdint.h>
+#include <map>
+
+#include "base/logging.h"
+#include "content/child/websocket_bridge.h"
+#include "content/common/websocket_messages.h"
+#include "ipc/ipc_message.h"
+#include "url/gurl.h"
+
+namespace content {
+
+WebSocketDispatcher::WebSocketDispatcher()
+  : channel_id_max_(0),
+    weak_ptr_factory_(this) {}
+
+WebSocketDispatcher::~WebSocketDispatcher() {}
+
+bool WebSocketDispatcher::CanHandleMessage(const IPC::Message& msg) {
+  switch (msg.type()) {
+    case WebSocketMsg_AddChannelResponse::ID:
+    case WebSocketMsg_NotifyStartOpeningHandshake::ID:
+    case WebSocketMsg_NotifyFinishOpeningHandshake::ID:
+    case WebSocketMsg_NotifyFailure::ID:
+    case WebSocketMsg_SendFrame::ID:
+    case WebSocketMsg_FlowControl::ID:
+    case WebSocketMsg_DropChannel::ID:
+    case WebSocketMsg_NotifyClosing::ID:
+      return true;
+    default:
+      return false;
+  }
+}
+
+int WebSocketDispatcher::AddBridge(WebSocketBridge* bridge) {
+  ++channel_id_max_;
+  bridges_.insert(std::make_pair(channel_id_max_, bridge));
+  return channel_id_max_;
+}
+
+void WebSocketDispatcher::RemoveBridge(int channel_id) {
+  std::map<int, WebSocketBridge*>::iterator iter = bridges_.find(channel_id);
+  if (iter == bridges_.end()) {
+    DVLOG(1) << "Remove a non-existent bridge(" << channel_id << ")";
+    return;
+  }
+  bridges_.erase(iter);
+}
+
+bool WebSocketDispatcher::OnMessageReceived(const IPC::Message& msg) {
+  if (!CanHandleMessage(msg))
+    return false;
+  WebSocketBridge* bridge = GetBridge(msg.routing_id(), msg.type());
+  if (!bridge)
+    return true;
+  return bridge->OnMessageReceived(msg);
+}
+
+WebSocketBridge* WebSocketDispatcher::GetBridge(int channel_id, uint32_t type) {
+  std::map<int, WebSocketBridge*>::iterator iter = bridges_.find(channel_id);
+  if (iter == bridges_.end()) {
+    DVLOG(1) << "No bridge for channel_id=" << channel_id
+             << ", type=" << type;
+    return NULL;
+  }
+  return iter->second;
+}
+
+}  // namespace content
diff --git a/content/child/websocket_dispatcher.h b/content/child/websocket_dispatcher.h
new file mode 100644
index 0000000..bd2fd50
--- /dev/null
+++ b/content/child/websocket_dispatcher.h
@@ -0,0 +1,56 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CONTENT_CHILD_WEBSOCKET_DISPATCHER_H_
+#define CONTENT_CHILD_WEBSOCKET_DISPATCHER_H_
+
+#include <stdint.h>
+#include <map>
+#include <string>
+#include <vector>
+
+#include "base/compiler_specific.h"
+#include "base/macros.h"
+#include "base/memory/weak_ptr.h"
+#include "ipc/ipc_listener.h"
+
+namespace content {
+
+class WebSocketBridge;
+
+// Dispatches WebSocket related messages sent to a child process from the
+// main browser process.  There is one instance per child process. Messages
+// are dispatched on the main child thread.  The ChildThread class
+// creates an instance of WebSocketDispatcher and delegates calls to it.
+class WebSocketDispatcher : public IPC::Listener {
+ public:
+  WebSocketDispatcher();
+  ~WebSocketDispatcher() override;
+
+  static bool CanHandleMessage(const IPC::Message& msg);
+
+  // Returns a unique channel id
+  int AddBridge(WebSocketBridge* bridge);
+  void RemoveBridge(int channel_id);
+
+  // IPC::Listener implementation.
+  bool OnMessageReceived(const IPC::Message& msg) override;
+
+  base::WeakPtr<WebSocketDispatcher> GetWeakPtr() {
+    return weak_ptr_factory_.GetWeakPtr();
+  }
+
+ private:
+  WebSocketBridge* GetBridge(int channel_id, uint32_t type);
+
+  std::map<int, WebSocketBridge*> bridges_;
+  int channel_id_max_;
+  base::WeakPtrFactory<WebSocketDispatcher> weak_ptr_factory_;
+
+  DISALLOW_COPY_AND_ASSIGN(WebSocketDispatcher);
+};
+
+}  // namespace content
+
+#endif  // CONTENT_CHILD_WEBSOCKET_DISPATCHER_H_
diff --git a/content/child/websocket_message_filter.cc b/content/child/websocket_message_filter.cc
new file mode 100644
index 0000000..b2e54c0
--- /dev/null
+++ b/content/child/websocket_message_filter.cc
@@ -0,0 +1,36 @@
+// Copyright 2016 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "content/child/websocket_message_filter.h"
+
+#include "base/bind.h"
+#include "base/single_thread_task_runner.h"
+#include "content/child/websocket_dispatcher.h"
+#include "ipc/ipc_message.h"
+
+namespace content {
+
+WebSocketMessageFilter::WebSocketMessageFilter(
+    WebSocketDispatcher* websocket_dispatcher)
+  : websocket_dispatcher_(websocket_dispatcher->GetWeakPtr()) {}
+
+WebSocketMessageFilter::~WebSocketMessageFilter() {}
+
+bool WebSocketMessageFilter::OnMessageReceived(const IPC::Message& message) {
+  if (!WebSocketDispatcher::CanHandleMessage(message))
+    return false;
+  loading_task_runner_->PostTask(FROM_HERE, base::Bind(
+      &WebSocketMessageFilter::OnMessageReceivedOnMainThread,
+      this, message));
+  return true;
+}
+
+void WebSocketMessageFilter::OnMessageReceivedOnMainThread(
+    const IPC::Message& message) {
+  if (!websocket_dispatcher_.get())
+    return;
+  websocket_dispatcher_->OnMessageReceived(message);
+}
+
+}  // namespace content
diff --git a/content/child/websocket_message_filter.h b/content/child/websocket_message_filter.h
new file mode 100644
index 0000000..00efbb2
--- /dev/null
+++ b/content/child/websocket_message_filter.h
@@ -0,0 +1,50 @@
+// Copyright 2016 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CONTENT_CHILD_WEBSOCKET_MESSAGE_FILTER_H_
+#define CONTENT_CHILD_WEBSOCKET_MESSAGE_FILTER_H_
+
+#include "base/macros.h"
+#include "base/memory/ref_counted.h"
+#include "base/memory/weak_ptr.h"
+#include "ipc/message_filter.h"
+
+namespace base {
+class SingleThreadTaskRunner;
+}
+
+namespace content {
+
+class WebSocketDispatcher;
+
+// Delegates IPC messages to a WebSocketDispatcher on the loading task queue
+// instead of the default task queue.
+class WebSocketMessageFilter : public IPC::MessageFilter {
+ public:
+  explicit WebSocketMessageFilter(WebSocketDispatcher* websocket_dispatcher);
+
+  // IPC::MessageFilter implementation.
+  bool OnMessageReceived(const IPC::Message& message) override;
+
+  void SetLoadingTaskRunner(
+      scoped_refptr<base::SingleThreadTaskRunner> loading_task_runner) {
+    loading_task_runner_ = loading_task_runner;
+  }
+
+ private:
+  ~WebSocketMessageFilter() override;
+  void OnMessageReceivedOnMainThread(const IPC::Message& message);
+
+  scoped_refptr<base::SingleThreadTaskRunner> loading_task_runner_;
+
+  // This actual object is owned by a ChildThreadImpl and is derefed only on the
+  // main thread.
+  base::WeakPtr<WebSocketDispatcher> websocket_dispatcher_;
+
+  DISALLOW_COPY_AND_ASSIGN(WebSocketMessageFilter);
+};
+
+}  // namespace content
+
+#endif  // CONTENT_CHILD_WEBSOCKET_MESSAGE_FILTER_H_
diff --git a/content/common/BUILD.gn b/content/common/BUILD.gn
index d92200d..c5d320a 100644
--- a/content/common/BUILD.gn
+++ b/content/common/BUILD.gn
@@ -249,7 +249,6 @@ mojom("mojo_bindings") {
     "render_widget_window_tree_client_factory.mojom",
     "service_worker/embedded_worker_setup.mojom",
     "storage_partition_service.mojom",
-    "websocket.mojom",
   ]
 
   import_dirs = [ "//mojo/services" ]
diff --git a/content/common/content_message_generator.h b/content/common/content_message_generator.h
index 7b8c0c8..e436f93 100644
--- a/content/common/content_message_generator.h
+++ b/content/common/content_message_generator.h
@@ -52,6 +52,7 @@
 #include "content/common/text_input_client_messages.h"
 #include "content/common/utility_messages.h"
 #include "content/common/view_messages.h"
+#include "content/common/websocket_messages.h"
 #include "content/common/worker_messages.h"
 
 #if defined(ENABLE_WEBRTC)
diff --git a/content/common/frame_messages.h b/content/common/frame_messages.h
index 5a649f3..e2ec270 100644
--- a/content/common/frame_messages.h
+++ b/content/common/frame_messages.h
@@ -1461,6 +1461,10 @@ IPC_MESSAGE_ROUTED0(FrameHostMsg_DispatchLoad)
 IPC_MESSAGE_ROUTED1(FrameHostMsg_RouteMessageEvent,
                     FrameMsg_PostMessage_Params)
 
+IPC_MESSAGE_ROUTED1(FrameHostMsg_IronframeOrigin, std::string)
+IPC_MESSAGE_ROUTED0(FrameHostMsg_ValidIronframe)
+IPC_MESSAGE_ROUTED0(FrameHostMsg_InvalidIronframe)
+
 // Sent when the renderer displays insecure content in a secure origin.
 IPC_MESSAGE_ROUTED0(FrameHostMsg_DidDisplayInsecureContent)
 
diff --git a/content/common/input/synthetic_pointer_action_params.h b/content/common/input/synthetic_pointer_action_params.h
index 4e51f03..641787c 100644
--- a/content/common/input/synthetic_pointer_action_params.h
+++ b/content/common/input/synthetic_pointer_action_params.h
@@ -51,8 +51,6 @@ struct CONTENT_EXPORT SyntheticPointerActionParams
   void set_index(int index) {
     DCHECK(pointer_action_type_ != PointerActionType::PROCESS &&
            pointer_action_type_ != PointerActionType::FINISH);
-    // For all mouse pointer actions, the index should always be 0.
-    DCHECK(gesture_source_type != MOUSE_INPUT || index == 0);
     index_ = index;
   }
 
@@ -67,7 +65,6 @@ struct CONTENT_EXPORT SyntheticPointerActionParams
   int index() const {
     DCHECK(pointer_action_type_ != PointerActionType::PROCESS &&
            pointer_action_type_ != PointerActionType::FINISH);
-    DCHECK(gesture_source_type != MOUSE_INPUT || index_ == 0);
     return index_;
   }
 
diff --git a/content/common/site_isolation_policy.cc b/content/common/site_isolation_policy.cc
index 789bde7..b25741b 100644
--- a/content/common/site_isolation_policy.cc
+++ b/content/common/site_isolation_policy.cc
@@ -39,7 +39,10 @@ bool SiteIsolationPolicy::IsTopDocumentIsolationEnabled() {
 
 // static
 bool SiteIsolationPolicy::UseSubframeNavigationEntries() {
-  return true;
+  // Enable the new navigation history behavior if any manner of site isolation
+  // is active.
+  // PlzNavigate: also enable the new navigation history behavior.
+  return AreCrossProcessFramesPossible() || IsBrowserSideNavigationEnabled();
 }
 
 }  // namespace content
diff --git a/content/common/websocket.cc b/content/common/websocket.cc
new file mode 100644
index 0000000..b1d5761
--- /dev/null
+++ b/content/common/websocket.cc
@@ -0,0 +1,18 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "content/common/websocket.h"
+
+namespace content {
+
+WebSocketHandshakeRequest::WebSocketHandshakeRequest() {}
+
+WebSocketHandshakeRequest::~WebSocketHandshakeRequest() {}
+
+WebSocketHandshakeResponse::WebSocketHandshakeResponse()
+    : status_code(0) {}
+
+WebSocketHandshakeResponse::~WebSocketHandshakeResponse() {}
+
+}  // namespace content
diff --git a/content/common/websocket.h b/content/common/websocket.h
new file mode 100644
index 0000000..324e9a1
--- /dev/null
+++ b/content/common/websocket.h
@@ -0,0 +1,64 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CONTENT_COMMON_WEBSOCKET_H_
+#define CONTENT_COMMON_WEBSOCKET_H_
+
+#include <string>
+#include <utility>
+#include <vector>
+
+#include "base/strings/string_split.h"
+#include "base/time/time.h"
+#include "url/gurl.h"
+
+namespace content {
+
+// WebSocket data message types sent between the browser and renderer processes.
+enum WebSocketMessageType {
+  WEB_SOCKET_MESSAGE_TYPE_CONTINUATION = 0x0,
+  WEB_SOCKET_MESSAGE_TYPE_TEXT = 0x1,
+  WEB_SOCKET_MESSAGE_TYPE_BINARY = 0x2,
+  WEB_SOCKET_MESSAGE_TYPE_LAST = WEB_SOCKET_MESSAGE_TYPE_BINARY
+};
+
+// Opening handshake request information which will be shown in the inspector.
+// All string data should be encoded to ASCII in the browser process.
+struct WebSocketHandshakeRequest {
+  WebSocketHandshakeRequest();
+  ~WebSocketHandshakeRequest();
+
+  // The request URL
+  GURL url;
+  // Additional HTTP request headers
+  base::StringPairs headers;
+  // HTTP request headers raw string
+  std::string headers_text;
+  // The time that this request is sent
+  base::Time request_time;
+};
+
+// Opening handshake response information which will be shown in the inspector.
+// All string data should be encoded to ASCII in the browser process.
+struct WebSocketHandshakeResponse {
+  WebSocketHandshakeResponse();
+  ~WebSocketHandshakeResponse();
+
+  // The request URL
+  GURL url;
+  // HTTP status code
+  int status_code;
+  // HTTP status text
+  std::string status_text;
+  // Additional HTTP response headers
+  base::StringPairs headers;
+  // HTTP response headers raw string
+  std::string headers_text;
+  // The time that this response arrives
+  base::Time response_time;
+};
+
+}  // namespace content
+
+#endif  // CONTENT_COMMON_WEBSOCKET_H_
diff --git a/content/common/websocket.mojom b/content/common/websocket.mojom
deleted file mode 100644
index 120f4e9..0000000
--- a/content/common/websocket.mojom
+++ /dev/null
@@ -1,138 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-module content.mojom;
-
-import "url/mojo/origin.mojom";
-import "url/mojo/url.mojom";
-
-enum WebSocketMessageType {
-  CONTINUATION,
-  TEXT,
-  BINARY,
-  LAST = BINARY
-};
-
-// TODO(darin): Move to a more general location.
-struct HttpHeader {
-  string name;
-  string value;
-};
-
-// TODO(darin): Remove redundancy b/w |headers| and |headers_text|.
-
-struct WebSocketHandshakeRequest {
-  url.mojom.Url url;
-  array<HttpHeader> headers;
-  string headers_text;
-};
-
-struct WebSocketHandshakeResponse {
-  url.mojom.Url url;
-  int32 status_code;
-  string status_text;
-  array<HttpHeader> headers;
-  string headers_text;
-};
-
-interface WebSocketClient {
-  OnFailChannel(string reason);
-
-  // Notify the renderer that the browser has started an opening handshake.
-  // This message is for showing the request in the inspector and
-  // can be omitted if the inspector is not active.
-  OnStartOpeningHandshake(WebSocketHandshakeRequest request);
-
-  // Notify the renderer that the browser has finished an opening handshake.
-  // This message precedes AddChannelResponse.
-  // This message is for showing the response in the inspector and
-  // can be omitted if the inspector is not active.
-  OnFinishOpeningHandshake(WebSocketHandshakeResponse response);
-
-  // Response to an AddChannelRequest. |selected_protocol| is the sub-protocol
-  // the server selected, or empty if no sub-protocol was selected.
-  // |extensions| is the list of extensions negotiated for the connection.
-  OnAddChannelResponse(string selected_protocol, string extensions);
-
-  // Receive a non-control frame from the remote server.
-  // - |fin| indicates that this frame is the last in the current message.
-  // - |type| is the type of the message. On the first frame of a message, it
-  //   must be set to either WebSocketMessageType.TEXT or
-  //   WebSocketMessageType.BINARY. On subsequent frames, it must be set to
-  //   WebSocketMessageType.CONTINUATION, and the type is the same as that of
-  //   the first message. If |type| is WebSocketMessageType.TEXT, then the
-  //   concatenation of the |data| from every frame in the message must be valid
-  //   UTF-8. If |fin| is not set, |data| must be non-empty.
-  OnDataFrame(bool fin, WebSocketMessageType type, array<uint8> data);
-
-  // Add |quota| tokens of send quota for the channel. |quota| must be a
-  // positive integer. Both the browser and the renderer set send quota for the
-  // other side, and check that quota has not been exceeded when receiving
-  // messages.  Both sides start a new channel with a quota of 0, and must wait
-  // for a FlowControl message before calling SendFrame. The total available
-  // quota on one side must never exceed 0x7FFFFFFFFFFFFFFF tokens.
-  OnFlowControl(int64 quota);
-
-  // Drop the channel.
-  //
-  // When sent by the renderer, this will cause a Close message will be sent and
-  // the TCP/IP connection will be closed.
-  //
-  // When sent by the browser, this indicates that a Close has been received,
-  // the connection was closed, or a network or protocol error occurred.
-  //
-  // - |code| is one of the reason codes specified in RFC6455.
-  // - |reason|, if non-empty, is a UTF-8 encoded string which may be useful
-  //   for debugging but is not necessarily human-readable, as supplied by the
-  //   server in the Close message.
-  // - If |was_clean| is false, then the WebSocket connection was not closed
-  //   cleanly.
-  OnDropChannel(bool was_clean, uint16 code, string reason);
-
-  // Notify the renderer that a closing handshake has been initiated by the
-  // server, so that it can set the Javascript readyState to CLOSING.
-  OnClosingHandshake();
-};
-
-interface WebSocket {
-  // Open new WebSocket connection to |socket_url|. |requested_protocols| is a
-  // list of tokens identifying sub-protocols the renderer would like to use,
-  // as described in RFC6455 "Subprotocols Using the WebSocket Protocol".
-  AddChannelRequest(url.mojom.Url url,
-                    array<string> requested_protocols,
-                    url.mojom.Origin origin,
-                    url.mojom.Url first_party_for_cookies,
-                    string user_agent_override,
-                    WebSocketClient client);
-
-  // Send a non-control frame to the remote server.
-  // - |fin| indicates that this frame is the last in the current message.
-  // - |type| is the type of the message. On the first frame of a message, it
-  //   must be set to either WebSocketMessageType.TEXT or
-  //   WebSocketMessageType.BINARY. On subsequent frames, it must be set to
-  //   WebSocketMessageType.CONTINUATION, and the type is the same as that of
-  //   the first message. If |type| is WebSocketMessageType.TEXT, then the
-  //   concatenation of the |data| from every frame in the message must be valid
-  //   UTF-8. If |fin| is not set, |data| must be non-empty.
-  SendFrame(bool fin, WebSocketMessageType type, array<uint8> data);
-
-  // Add |quota| tokens of send quota for the channel. |quota| must be a
-  // positive integer. Both the browser and the renderer set send quota for the
-  // other side, and check that quota has not been exceeded when receiving
-  // messages.  Both sides start a new channel with a quota of 0, and must wait
-  // for a FlowControl message before calling SendFrame. The total available
-  // quota on one side must never exceed 0x7FFFFFFFFFFFFFFF tokens.
-  SendFlowControl(int64 quota);
-
-  // Close the channel gracefully.
-  //
-  // When sent by the renderer, this will cause a Close message will be sent and
-  // the TCP/IP connection will be closed.
-  //
-  // - |code| is one of the reason codes specified in RFC6455.
-  // - |reason|, if non-empty, is a UTF-8 encoded string which may be useful for
-  //   debugging but is not necessarily human-readable, as supplied by the
-  //   server in the Close message.
-  StartClosingHandshake(uint16 code, string reason);
-};
diff --git a/content/common/websocket_messages.h b/content/common/websocket_messages.h
new file mode 100644
index 0000000..ce25078
--- /dev/null
+++ b/content/common/websocket_messages.h
@@ -0,0 +1,201 @@
+// Copyright 2013 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+// Multiply-included message file, hence no include guard.
+
+// This file defines the IPCs for the browser-side implementation of
+// WebSockets.
+//
+// This IPC interface was originally desined based on the WebSocket
+// multiplexing draft spec,
+// http://tools.ietf.org/html/draft-ietf-hybi-websocket-multiplexing-09. So,
+// some of them are given names correspond to the concepts defined in the spec.
+//
+// A WebSocketBridge object in the renderer and the corresponding WebSocketHost
+// object in the browser are associated using an identifier named channel ID.
+// The channel id is chosen by the renderer for a new channel. While the
+// channel id is unique per-renderer, the browser may have multiple renderers
+// using the same channel id.
+//
+// There're WebSocketDispatcherHost objects for each renderer. Each of
+// WebSocketDispatcherHost holds a channel id to WebSocketHost map.
+//
+// Received messages are routed to the corresponding object by
+// WebSocketDispatcher in the renderer and WebSocketDispatcherHost in the
+// browser using the channel ID.
+//
+// The channel ID value is stored in the routing ID member which is available
+// when we use the IPC_MESSAGE_ROUTED macro though it's unintended use.
+
+#include <stdint.h>
+
+#include <string>
+#include <vector>
+
+#include "content/common/content_export.h"
+#include "content/common/websocket.h"
+#include "ipc/ipc_message_macros.h"
+#include "url/gurl.h"
+#include "url/origin.h"
+
+#undef IPC_MESSAGE_EXPORT
+#define IPC_MESSAGE_EXPORT CONTENT_EXPORT
+#define IPC_MESSAGE_START WebSocketMsgStart
+
+IPC_ENUM_TRAITS_MAX_VALUE(content::WebSocketMessageType,
+                          content::WEB_SOCKET_MESSAGE_TYPE_LAST)
+
+IPC_STRUCT_BEGIN(WebSocketHostMsg_AddChannelRequest_Params)
+  IPC_STRUCT_MEMBER(GURL, socket_url)
+  IPC_STRUCT_MEMBER(std::vector<std::string>, requested_protocols)
+  IPC_STRUCT_MEMBER(url::Origin, origin)
+  IPC_STRUCT_MEMBER(GURL, first_party_for_cookies)
+  IPC_STRUCT_MEMBER(std::string, user_agent_override)
+  IPC_STRUCT_MEMBER(int, render_frame_id)
+IPC_STRUCT_END()
+
+IPC_STRUCT_TRAITS_BEGIN(content::WebSocketHandshakeRequest)
+  IPC_STRUCT_TRAITS_MEMBER(url)
+  IPC_STRUCT_TRAITS_MEMBER(headers)
+  IPC_STRUCT_TRAITS_MEMBER(headers_text)
+  IPC_STRUCT_TRAITS_MEMBER(request_time)
+IPC_STRUCT_TRAITS_END()
+
+IPC_STRUCT_TRAITS_BEGIN(content::WebSocketHandshakeResponse)
+  IPC_STRUCT_TRAITS_MEMBER(url)
+  IPC_STRUCT_TRAITS_MEMBER(status_code)
+  IPC_STRUCT_TRAITS_MEMBER(status_text)
+  IPC_STRUCT_TRAITS_MEMBER(headers)
+  IPC_STRUCT_TRAITS_MEMBER(headers_text)
+  IPC_STRUCT_TRAITS_MEMBER(response_time)
+IPC_STRUCT_TRAITS_END()
+
+// WebSocket messages sent from the renderer to the browser.
+
+// Open new WebSocket connection to |socket_url|. |requested_protocols| is a
+// list of tokens identifying sub-protocols the renderer would like to use, as
+// described in RFC6455 "Subprotocols Using the WebSocket Protocol".
+IPC_MESSAGE_ROUTED1(WebSocketHostMsg_AddChannelRequest,
+                    WebSocketHostMsg_AddChannelRequest_Params)
+
+// Send a complete binary WebSocket message consisting of the Blob identified by
+// |uuid|. The message will be split into frames as necessary. |expected_size|
+// must match the browser's idea of the size of the Blob to prevent flow control
+// from becoming desynchronised. If it does not match the connection will be
+// terminated with a WebSocketMsg_NotifyFailure message. On success, the browser
+// will have consumed |expected_size| bytes of flow control send quota and the
+// renderer needs to subtract that from its running total of flow control send
+// quota. See the design doc at
+// https://docs.google.com/document/d/1CDiXB9pBumhFVVfmIn1CRI6v6byxyqWu2urEE9xp714/edit
+// SendFrame or SendBlob IPCs must not be sent by the renderer until the
+// BlobSendComplete message has been received from the browser. The renderer
+// should retain a reference to the Blob until either a BlobSendComplete or
+// NotifyFailure IPC is received.
+IPC_MESSAGE_ROUTED2(WebSocketHostMsg_SendBlob,
+                    std::string /* uuid */,
+                    uint64_t /* expected_size */)
+
+// WebSocket messages sent from the browser to the renderer.
+
+// Respond to an AddChannelRequest. |selected_protocol| is the sub-protocol the
+// server selected, or empty if no sub-protocol was selected. |extensions| is
+// the list of extensions negotiated for the connection.
+IPC_MESSAGE_ROUTED2(WebSocketMsg_AddChannelResponse,
+                    std::string /* selected_protocol */,
+                    std::string /* extensions */)
+
+// Notify the renderer that the browser has started an opening handshake.
+// This message is for showing the request in the inspector and
+// can be omitted if the inspector is not active.
+IPC_MESSAGE_ROUTED1(WebSocketMsg_NotifyStartOpeningHandshake,
+                    content::WebSocketHandshakeRequest /* request */)
+
+// Notify the renderer that the browser has finished an opening handshake.
+// This message precedes AddChannelResponse.
+// This message is for showing the response in the inspector and
+// can be omitted if the inspector is not active.
+IPC_MESSAGE_ROUTED1(WebSocketMsg_NotifyFinishOpeningHandshake,
+                    content::WebSocketHandshakeResponse /* response */)
+
+// Notify the renderer that either:
+// - the connection open request (WebSocketHostMsg_AddChannelRequest) failed.
+// - the browser is required to fail the connection
+//   (see RFC6455 7.1.7 for details).
+//
+// When the renderer process receives this messages it does the following:
+// 1. Fire an error event.
+// 2. Show |message| to the inspector.
+// 3. Close the channel immediately uncleanly, as if it received
+//    DropChannel(was_clean = false, code = 1006, reason = "").
+// |message| will be shown in the inspector and won't be passed to the script.
+// TODO(yhirano): Find the way to pass |message| directly to the inspector
+// process.
+IPC_MESSAGE_ROUTED1(WebSocketMsg_NotifyFailure,
+                    std::string /* message */)
+
+// Indicates tbat the current Blob has finished sending. The renderer can
+// release its reference on the Blob, and may now use SendFrame or SendBlob to
+// send more messages.
+IPC_MESSAGE_ROUTED0(WebSocketMsg_BlobSendComplete)
+
+// WebSocket messages that can be sent in either direction.
+
+// Send a non-control frame to the channel.
+// - If the sender is the renderer, it will be sent to the remote server.
+// - If the sender is the browser, it comes from the remote server.
+//
+// - |fin| indicates that this frame is the last in the current message.
+// - |type| is the type of the message. On the first frame of a message, it
+//   must be set to either WEB_SOCKET_MESSAGE_TYPE_TEXT or
+//   WEB_SOCKET_MESSAGE_TYPE_BINARY. On subsequent frames, it must be set to
+//   WEB_SOCKET_MESSAGE_TYPE_CONTINUATION, and the type is the same as that of
+//   the first message. If |type| is WEB_SOCKET_MESSAGE_TYPE_TEXT, then the
+//   concatenation of the |data| from every frame in the message must be valid
+//   UTF-8. If |fin| is not set, |data| must be non-empty.
+IPC_MESSAGE_ROUTED3(WebSocketMsg_SendFrame,
+                    bool /* fin */,
+                    content::WebSocketMessageType /* type */,
+                    std::vector<char> /* data */)
+
+// Add |quota| tokens of send quota for the channel. |quota| must be a positive
+// integer. Both the browser and the renderer set send quota for the other
+// side, and check that quota has not been exceeded when receiving messages.
+// Both sides start a new channel with a quota of 0, and must wait for a
+// FlowControl message before calling SendFrame. The total available quota on
+// one side must never exceed 0x7FFFFFFFFFFFFFFF tokens.
+//
+// During "blob sending mode", ie. between the renderer sending a
+// WebSocketHostMsg_SendBlob IPC and receiving a WebSocketMsg_BlobSendComplete
+// IPC, quota is used up in the browser process to send the blob, but
+// FlowControl IPCs for that quota are still sent to the renderer. The render
+// process needs to take into account that quota equal to the size of the Blob
+// has already been used when calculating how much send quota it has left after
+// receiving BlobSendComplete.
+IPC_MESSAGE_ROUTED1(WebSocketMsg_FlowControl, int64_t /* quota */)
+
+// Drop the channel.
+//
+// When sent by the renderer, this will cause a Close message will be sent and
+// the TCP/IP connection will be closed.
+//
+// When sent by the browser, this indicates that a Close has been received, the
+// connection was closed, or a network or protocol error occurred.
+//
+// - |code| is one of the reason codes specified in RFC6455.
+// - |reason|, if non-empty, is a UTF-8 encoded string which may be useful for
+//   debugging but is not necessarily human-readable, as supplied by the server
+//   in the Close message.
+// - If |was_clean| is false on a message from the browser, then the WebSocket
+//   connection was not closed cleanly. If |was_clean| is false on a message
+//   from the renderer, then the connection should be closed immediately without
+//   a closing handshake and the renderer cannot accept any new messages on this
+//   connection.
+IPC_MESSAGE_ROUTED3(WebSocketMsg_DropChannel,
+                    bool /* was_clean */,
+                    unsigned short /* code */,
+                    std::string /* reason */)
+
+// Notify the renderer that a closing handshake has been initiated by the
+// server, so that it can set the Javascript readyState to CLOSING.
+IPC_MESSAGE_ROUTED0(WebSocketMsg_NotifyClosing)
diff --git a/content/content_browser.gypi b/content/content_browser.gypi
index dc7b855..4fd4b67 100644
--- a/content/content_browser.gypi
+++ b/content/content_browser.gypi
@@ -1333,6 +1333,12 @@
       'browser/renderer_host/web_input_event_aurawin.cc',
       'browser/renderer_host/webmenurunner_mac.h',
       'browser/renderer_host/webmenurunner_mac.mm',
+      'browser/renderer_host/websocket_blob_sender.cc',
+      'browser/renderer_host/websocket_blob_sender.h',
+      'browser/renderer_host/websocket_dispatcher_host.cc',
+      'browser/renderer_host/websocket_dispatcher_host.h',
+      'browser/renderer_host/websocket_host.cc',
+      'browser/renderer_host/websocket_host.h',
       'browser/resolve_proxy_msg_helper.cc',
       'browser/resolve_proxy_msg_helper.h',
       'browser/resource_context_impl.cc',
@@ -1568,10 +1574,6 @@
       'browser/webui/web_ui_impl.cc',
       'browser/webui/web_ui_impl.h',
       'browser/webui/web_ui_message_handler.cc',
-      'browser/websockets/websocket_impl.cc',
-      'browser/websockets/websocket_impl.h',
-      'browser/websockets/websocket_manager.cc',
-      'browser/websockets/websocket_manager.h',
       'browser/zygote_host/zygote_communication_linux.cc',
       'browser/zygote_host/zygote_communication_linux.h',
       'browser/zygote_host/zygote_handle_linux.cc',
diff --git a/content/content_child.gypi b/content/content_child.gypi
index 8e16e1e..0b6b6c4 100644
--- a/content/content_child.gypi
+++ b/content/content_child.gypi
@@ -211,6 +211,12 @@
       'child/webfileutilities_impl.h',
       'child/webmessageportchannel_impl.cc',
       'child/webmessageportchannel_impl.h',
+      'child/websocket_bridge.cc',
+      'child/websocket_bridge.h',
+      'child/websocket_dispatcher.cc',
+      'child/websocket_dispatcher.h',
+      'child/websocket_message_filter.cc',
+      'child/websocket_message_filter.h',
       'child/webthemeengine_impl_android.cc',
       'child/webthemeengine_impl_android.h',
       'child/webthemeengine_impl_default.cc',
diff --git a/content/content_common.gypi b/content/content_common.gypi
index 637d4bd..c16e64a 100644
--- a/content/content_common.gypi
+++ b/content/content_common.gypi
@@ -545,6 +545,9 @@
       'common/utility_messages.h',
       'common/view_message_enums.h',
       'common/view_messages.h',
+      'common/websocket.cc',
+      'common/websocket.h',
+      'common/websocket_messages.h',
       'common/worker_messages.h',
       'common/zygote_commands_linux.h',
     ],
diff --git a/content/content_common_mojo_bindings.gyp b/content/content_common_mojo_bindings.gyp
index f15d427..ce0a991 100644
--- a/content/content_common_mojo_bindings.gyp
+++ b/content/content_common_mojo_bindings.gyp
@@ -18,7 +18,6 @@
           'common/render_frame_message_filter.mojom',
           'common/service_worker/embedded_worker_setup.mojom',
           'common/storage_partition_service.mojom',
-          'common/websocket.mojom',
           '../third_party/WebKit/public/platform/modules/bluetooth/web_bluetooth.mojom',
         ],
         'mojom_typemaps': [
diff --git a/content/content_renderer.gypi b/content/content_renderer.gypi
index dc433a7..a210e3e 100644
--- a/content/content_renderer.gypi
+++ b/content/content_renderer.gypi
@@ -491,8 +491,6 @@
       'renderer/webscrollbarbehavior_impl_mac.mm',
       'renderer/websharedworker_proxy.cc',
       'renderer/websharedworker_proxy.h',
-      'renderer/websockethandle_impl.cc',
-      'renderer/websockethandle_impl.h',
     ],
     # Put WebRTC-related sources in the plugin+WebRTC section below.
     'private_renderer_plugin_sources': [
diff --git a/content/content_shell_test_apk.isolate b/content/content_shell_test_apk.isolate
new file mode 100644
index 0000000..67bc693
--- /dev/null
+++ b/content/content_shell_test_apk.isolate
@@ -0,0 +1,25 @@
+# Copyright 2015 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+{
+  'includes': [
+    '../build/android/android.isolate',
+    'content_shell_test_data.isolate',
+  ],
+  'variables': {
+    'command': [
+      '<(PRODUCT_DIR)/bin/run_content_shell_test_apk',
+      '--enable-platform-mode',
+      '-e', 'local',
+      '--logcat-output-dir', '${ISOLATED_OUTDIR}/logcats',
+    ],
+    'files': [
+      '../third_party/proguard/',
+      '<(PRODUCT_DIR)/apks/ContentShell.apk',
+      '<(PRODUCT_DIR)/apks/ContentShellTest.apk',
+      '<(PRODUCT_DIR)/bin/run_content_shell_test_apk',
+      '<(PRODUCT_DIR)/test.lib.java/ContentShellTest.jar',
+      'content_shell_test_data.isolate',
+    ]
+  },
+}
diff --git a/content/content_shell_test_data.isolate b/content/content_shell_test_data.isolate
new file mode 100644
index 0000000..72d4d7c
--- /dev/null
+++ b/content/content_shell_test_data.isolate
@@ -0,0 +1,17 @@
+# Copyright (c) 2014 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+{
+  'variables': {
+    'files': [
+      '<(DEPTH)/content/test/data/android/',
+      '<(DEPTH)/content/test/data/media/session/',
+      '<(DEPTH)/net/data/ssl/certificates/crit-codeSigning-chain.pem',
+      '<(DEPTH)/net/data/ssl/certificates/eku-test-root.pem',
+      '<(DEPTH)/net/data/ssl/certificates/invalid_key_usage_cert.der',
+      '<(DEPTH)/net/data/ssl/certificates/non-crit-codeSigning-chain.pem',
+      '<(DEPTH)/net/data/ssl/certificates/ok_cert.pem',
+      '<(DEPTH)/net/data/ssl/certificates/root_ca_cert.pem',
+    ],
+  },
+}
diff --git a/content/content_tests.gypi b/content/content_tests.gypi
index 31d20bd..d7e6323 100644
--- a/content/content_tests.gypi
+++ b/content/content_tests.gypi
@@ -594,6 +594,8 @@
       'browser/renderer_host/render_widget_host_view_mac_unittest.mm',
       'browser/renderer_host/text_input_client_mac_unittest.mm',
       'browser/renderer_host/web_input_event_aura_unittest.cc',
+      'browser/renderer_host/websocket_blob_sender_unittest.cc',
+      'browser/renderer_host/websocket_dispatcher_host_unittest.cc',
       'browser/resolve_proxy_msg_helper_unittest.cc',
       'browser/service_worker/embedded_worker_instance_unittest.cc',
       'browser/service_worker/embedded_worker_test_helper.cc',
@@ -638,7 +640,6 @@
       'browser/web_contents/web_contents_view_mac_unittest.mm',
       'browser/web_contents/web_drag_dest_mac_unittest.mm',
       'browser/web_contents/web_drag_source_mac_unittest.mm',
-      'browser/websockets/websocket_manager_unittest.cc',
       'browser/webui/url_data_manager_backend_unittest.cc',
       'browser/webui/web_ui_data_source_unittest.cc',
       'browser/webui/web_ui_message_handler_unittest.cc',
diff --git a/content/public/android/BUILD.gn b/content/public/android/BUILD.gn
index ac9356e..64fd9af 100644
--- a/content/public/android/BUILD.gn
+++ b/content/public/android/BUILD.gn
@@ -382,14 +382,6 @@ android_library("content_javatests") {
     "javatests/src/org/chromium/content/browser/webcontents/WebContentsTest.java",
     "javatests/src/org/chromium/content/common/CleanupReferenceTest.java",
   ]
-
-  data = [
-    "//content/test/data/android/",
-    "//content/test/data/media/session/",
-  ]
-  data_deps = [
-    "//net:test_support",
-  ]
 }
 
 # GYP: //content/content_tests.gypi:content_junit_tests
diff --git a/content/public/android/java/src/org/chromium/content/browser/ActivityContentVideoViewEmbedder.java b/content/public/android/java/src/org/chromium/content/browser/ActivityContentVideoViewEmbedder.java
index a61d42e..fece9d1 100644
--- a/content/public/android/java/src/org/chromium/content/browser/ActivityContentVideoViewEmbedder.java
+++ b/content/public/android/java/src/org/chromium/content/browser/ActivityContentVideoViewEmbedder.java
@@ -25,7 +25,7 @@ public class ActivityContentVideoViewEmbedder implements ContentVideoViewEmbedde
     }
 
     @Override
-    public void enterFullscreenVideo(View view, boolean isVideoLoaded) {
+    public void enterFullscreenVideo(View view) {
         FrameLayout decor = (FrameLayout) mActivity.getWindow().getDecorView();
         decor.addView(view, 0,
                 new FrameLayout.LayoutParams(
@@ -37,9 +37,6 @@ public class ActivityContentVideoViewEmbedder implements ContentVideoViewEmbedde
     }
 
     @Override
-    public void fullscreenVideoLoaded() {}
-
-    @Override
     public void exitFullscreenVideo() {
         FrameLayout decor = (FrameLayout) mActivity.getWindow().getDecorView();
         decor.removeView(mView);
@@ -48,6 +45,11 @@ public class ActivityContentVideoViewEmbedder implements ContentVideoViewEmbedde
     }
 
     @Override
+    public View getVideoLoadingProgressView() {
+        return null;
+    }
+
+    @Override
     @SuppressLint("InlinedApi")
     public void setSystemUiVisibility(boolean enterFullscreen) {
         View decor = mActivity.getWindow().getDecorView();
diff --git a/content/public/android/java/src/org/chromium/content/browser/ContentVideoView.java b/content/public/android/java/src/org/chromium/content/browser/ContentVideoView.java
index 262584e..089c559 100644
--- a/content/public/android/java/src/org/chromium/content/browser/ContentVideoView.java
+++ b/content/public/android/java/src/org/chromium/content/browser/ContentVideoView.java
@@ -18,6 +18,9 @@ import android.view.View;
 import android.view.ViewGroup;
 import android.view.WindowManager;
 import android.widget.FrameLayout;
+import android.widget.LinearLayout;
+import android.widget.ProgressBar;
+import android.widget.TextView;
 
 import org.chromium.base.Log;
 import org.chromium.base.ThreadUtils;
@@ -47,7 +50,6 @@ public class ContentVideoView extends FrameLayout
     private SurfaceHolder mSurfaceHolder;
     private int mVideoWidth;
     private int mVideoHeight;
-    private boolean mIsVideoLoaded;
 
     // Native pointer to C++ ContentVideoView object.
     private long mNativeContentVideoView;
@@ -59,10 +61,14 @@ public class ContentVideoView extends FrameLayout
     private String mUnknownErrorText;
     private String mErrorButton;
     private String mErrorTitle;
+    private String mVideoLoadingText;
 
     // This view will contain the video.
     private VideoSurfaceView mVideoSurfaceView;
 
+    // Progress view when the video is loading.
+    private View mProgressView;
+
     private final ContentVideoViewEmbedder mEmbedder;
 
     private boolean mInitialOrientation;
@@ -113,6 +119,25 @@ public class ContentVideoView extends FrameLayout
         }
     }
 
+    private static class ProgressView extends LinearLayout {
+
+        private final ProgressBar mProgressBar;
+        private final TextView mTextView;
+
+        public ProgressView(Context context, String videoLoadingText) {
+            super(context);
+            setOrientation(LinearLayout.VERTICAL);
+            setLayoutParams(new LinearLayout.LayoutParams(
+                    LinearLayout.LayoutParams.WRAP_CONTENT,
+                    LinearLayout.LayoutParams.WRAP_CONTENT));
+            mProgressBar = new ProgressBar(context, null, android.R.attr.progressBarStyleLarge);
+            mTextView = new TextView(context);
+            mTextView.setText(videoLoadingText);
+            addView(mProgressBar);
+            addView(mTextView);
+        }
+    }
+
     private final Runnable mExitFullscreenRunnable = new Runnable() {
         @Override
         public void run() {
@@ -121,19 +146,16 @@ public class ContentVideoView extends FrameLayout
     };
 
     private ContentVideoView(Context context, long nativeContentVideoView,
-            ContentVideoViewEmbedder embedder, int videoWidth, int videoHeight) {
+            ContentVideoViewEmbedder embedder) {
         super(context);
         mNativeContentVideoView = nativeContentVideoView;
         mEmbedder = embedder;
         mUmaRecorded = false;
         mPossibleAccidentalChange = false;
-        mIsVideoLoaded = videoWidth > 0 && videoHeight > 0;
         initResources(context);
         mVideoSurfaceView = new VideoSurfaceView(context);
         showContentVideoView();
         setVisibility(View.VISIBLE);
-        mEmbedder.enterFullscreenVideo(this, mIsVideoLoaded);
-        onVideoSizeChanged(videoWidth, videoHeight);
     }
 
     private ContentVideoViewEmbedder getContentVideoViewEmbedder() {
@@ -150,11 +172,22 @@ public class ContentVideoView extends FrameLayout
                 org.chromium.content.R.string.media_player_error_button);
         mErrorTitle = context.getString(
                 org.chromium.content.R.string.media_player_error_title);
+        mVideoLoadingText = context.getString(
+                org.chromium.content.R.string.media_player_loading_video);
     }
 
     private void showContentVideoView() {
         mVideoSurfaceView.getHolder().addCallback(this);
-        addView(mVideoSurfaceView, new FrameLayout.LayoutParams(
+        this.addView(mVideoSurfaceView, new FrameLayout.LayoutParams(
+                ViewGroup.LayoutParams.WRAP_CONTENT,
+                ViewGroup.LayoutParams.WRAP_CONTENT,
+                Gravity.CENTER));
+
+        mProgressView = mEmbedder.getVideoLoadingProgressView();
+        if (mProgressView == null) {
+            mProgressView = new ProgressView(getContext(), mVideoLoadingText);
+        }
+        this.addView(mProgressView, new FrameLayout.LayoutParams(
                 ViewGroup.LayoutParams.WRAP_CONTENT,
                 ViewGroup.LayoutParams.WRAP_CONTENT,
                 Gravity.CENTER));
@@ -217,18 +250,11 @@ public class ContentVideoView extends FrameLayout
     private void onVideoSizeChanged(int width, int height) {
         mVideoWidth = width;
         mVideoHeight = height;
-
-        // We take non-zero frame size as an indication that the video has been loaded.
-        if (!mIsVideoLoaded && mVideoWidth > 0 && mVideoHeight > 0) {
-            mIsVideoLoaded = true;
-            mEmbedder.fullscreenVideoLoaded();
-        }
-
         // This will trigger the SurfaceView.onMeasure() call.
         mVideoSurfaceView.getHolder().setFixedSize(mVideoWidth, mVideoHeight);
-
         if (mUmaRecorded) return;
 
+        mProgressView.setVisibility(View.GONE);
         try {
             if (Settings.System.getInt(getContext().getContentResolver(),
                     Settings.System.ACCELEROMETER_ROTATION) == 0) {
@@ -275,25 +301,23 @@ public class ContentVideoView extends FrameLayout
         }
     }
 
-    /**
-     * Creates ContentVideoView. The videoWidth and videoHeight parameters designate
-     * the video frame size if it is known at the time of this call, or should be 0.
-     * ContentVideoView assumes that zero size means video has not been loaded yet.
-     */
     @CalledByNative
-    private static ContentVideoView createContentVideoView(ContentViewCore contentViewCore,
-            long nativeContentVideoView, int videoWidth, int videoHeight) {
+    private static ContentVideoView createContentVideoView(
+            ContentViewCore contentViewCore, long nativeContentVideoView) {
         ThreadUtils.assertOnUiThread();
         Context context = contentViewCore.getContext();
         ContentVideoViewEmbedder embedder = contentViewCore.getContentVideoViewEmbedder();
-        ContentVideoView videoView = new ContentVideoView(
-                context, nativeContentVideoView, embedder, videoWidth, videoHeight);
+        ContentVideoView videoView =
+                new ContentVideoView(context, nativeContentVideoView, embedder);
+        embedder.enterFullscreenVideo(videoView);
         return videoView;
     }
 
-    private void removeSurfaceView() {
+    public void removeSurfaceView() {
         removeView(mVideoSurfaceView);
+        removeView(mProgressView);
         mVideoSurfaceView = null;
+        mProgressView = null;
     }
 
     @CalledByNative
diff --git a/content/public/android/java/src/org/chromium/content/browser/ContentVideoViewEmbedder.java b/content/public/android/java/src/org/chromium/content/browser/ContentVideoViewEmbedder.java
index fadbe5b..198a5a2 100644
--- a/content/public/android/java/src/org/chromium/content/browser/ContentVideoViewEmbedder.java
+++ b/content/public/android/java/src/org/chromium/content/browser/ContentVideoViewEmbedder.java
@@ -23,15 +23,8 @@ public interface ContentVideoViewEmbedder {
      * Called when the {@link ContentVideoView}, which contains the fullscreen video,
      * is ready to be shown. Must be implemented.
      * @param view The view containing the fullscreen video that embedders must show.
-     * @param isVideoLoaded The flag telling whether video has already been loaded.
-     *                      When it is false, embedder might show the progress view.
      */
-    public void enterFullscreenVideo(View view, boolean isVideoLoaded);
-
-    /**
-     * Tells the embedder to remove the progress view.
-     */
-    public void fullscreenVideoLoaded();
+    public void enterFullscreenVideo(View view);
 
     /**
      * Called to exit fullscreen video. Embedders must stop showing the view given in
@@ -40,6 +33,12 @@ public interface ContentVideoViewEmbedder {
     public void exitFullscreenVideo();
 
     /**
+     * Allows the embedder to replace the view indicating that the video is loading.
+     * If null is returned, the default video loading view is used.
+     */
+    public View getVideoLoadingProgressView();
+
+    /**
      * Sets the system ui visibility after entering or exiting fullscreen.
      * @param enterFullscreen True if video is going fullscreen, or false otherwise.
      */
diff --git a/content/public/android/java/strings/android_content_strings.grd b/content/public/android/java/strings/android_content_strings.grd
index 7e7c486..0b1cfa5 100644
--- a/content/public/android/java/strings/android_content_strings.grd
+++ b/content/public/android/java/strings/android_content_strings.grd
@@ -114,6 +114,9 @@
       <message name="IDS_MEDIA_PLAYER_ERROR_BUTTON" desc="OK button to dismiss an error dialog [CHAR-LIMIT=16]">
         OK
       </message>
+      <message name="IDS_MEDIA_PLAYER_LOADING_VIDEO" desc="Text shown while a video is loading [CHAR-LIMIT=16]">
+        Loading video
+      </message>
       <message name="IDS_PROFILER_STARTED_TOAST" desc="Toast notifying the user that profiler started">
         Profiler started
       </message>
diff --git a/content/public/browser/gpu_data_manager.h b/content/public/browser/gpu_data_manager.h
index 80d8a90..9edf2bc 100644
--- a/content/public/browser/gpu_data_manager.h
+++ b/content/public/browser/gpu_data_manager.h
@@ -110,10 +110,6 @@ class GpuDataManager {
   virtual void GetDisabledExtensions(
       std::string* disabled_extensions) const = 0;
 
-  // Sets the initial GPU information. This should happen before calculating
-  // the backlists decision and applying commandline switches.
-  virtual void SetGpuInfo(const gpu::GPUInfo& gpu_info) = 0;
-
  protected:
   virtual ~GpuDataManager() {}
 };
diff --git a/content/public/browser/web_contents.h b/content/public/browser/web_contents.h
index c34b118..1cbb335 100644
--- a/content/public/browser/web_contents.h
+++ b/content/public/browser/web_contents.h
@@ -364,6 +364,13 @@ class WebContents : public PageNavigator,
   // Returns the character encoding of the page.
   virtual const std::string& GetEncoding() const = 0;
 
+
+  // True if this is a secure page which displayed insecure content.
+  virtual int IronframeStatus() const = 0;
+
+  // True if this is a secure page which displayed insecure content.
+  virtual std::string IronframeOrigin() const = 0;
+
   // True if this is a secure page which displayed insecure content.
   virtual bool DisplayedInsecureContent() const = 0;
 
diff --git a/content/public/renderer/plugin_instance_throttler.h b/content/public/renderer/plugin_instance_throttler.h
index ca981c6..541427f 100644
--- a/content/public/renderer/plugin_instance_throttler.h
+++ b/content/public/renderer/plugin_instance_throttler.h
@@ -54,7 +54,6 @@ class CONTENT_EXPORT PluginInstanceThrottler {
     UNTHROTTLE_METHOD_BY_WHITELIST = 2,
     UNTHROTTLE_METHOD_BY_AUDIO = 3,
     UNTHROTTLE_METHOD_BY_SIZE_CHANGE = 4,
-    UNTHROTTLE_METHOD_BY_OMNIBOX_ICON = 5,
     UNTHROTTLE_METHOD_NUM_ITEMS
   };
 
diff --git a/content/renderer/OWNERS b/content/renderer/OWNERS
index ec2f37c..d285f81 100644
--- a/content/renderer/OWNERS
+++ b/content/renderer/OWNERS
@@ -11,9 +11,4 @@ per-file renderer_font_platform_win.*=cpu@chromium.org
 
 # Web Notifications.
 per-file notification_permission_dispatcher.*=mvanouwerkerk@chromium.org
-per-file notification_permission_dispatcher.*=peter@chromium.org
-
-# WebSocket
-per-file *websocket*=ricea@chromium.org
-per-file *websocket*=tyoshino@chromium.org
-per-file *websocket*=yhirano@chromium.org
+per-file notification_permission_dispatcher.*=peter@chromium.org
\ No newline at end of file
diff --git a/content/renderer/categorized_worker_pool.cc b/content/renderer/categorized_worker_pool.cc
index 41814b4..fa7de93 100644
--- a/content/renderer/categorized_worker_pool.cc
+++ b/content/renderer/categorized_worker_pool.cc
@@ -152,7 +152,7 @@ void CategorizedWorkerPool::Start(int num_threads) {
   // Use background priority for background thread.
   base::SimpleThread::Options thread_options;
 #if !defined(OS_MACOSX)
-  thread_options.set_priority(base::ThreadPriority::BACKGROUND);
+  thread_options.priority = base::ThreadPriority::BACKGROUND;
 #endif
 
   std::unique_ptr<base::SimpleThread> thread(new CategorizedWorkerPoolThread(
diff --git a/content/renderer/gpu/render_widget_compositor.cc b/content/renderer/gpu/render_widget_compositor.cc
index ce6ea32..6e67635 100644
--- a/content/renderer/gpu/render_widget_compositor.cc
+++ b/content/renderer/gpu/render_widget_compositor.cc
@@ -410,8 +410,8 @@ cc::LayerTreeSettings RenderWidgetCompositor::GenerateLayerTreeSettings(
   if (base::SysInfo::IsLowEndDevice())
     settings.gpu_rasterization_enabled = false;
   settings.using_synchronous_renderer_compositor = using_synchronous_compositor;
-  // Also hide scrollbars for Android WebView, since it uses system scrollbars.
-  if (ui::ShouldHideScrollbars() || using_synchronous_compositor) {
+  if (using_synchronous_compositor) {
+    // Android WebView uses system scrollbars, so make ours invisible.
     settings.scrollbar_animator = cc::LayerTreeSettings::NO_ANIMATOR;
     settings.solid_color_scrollbar_color = SK_ColorTRANSPARENT;
   } else {
@@ -455,10 +455,7 @@ cc::LayerTreeSettings RenderWidgetCompositor::GenerateLayerTreeSettings(
 
 #else  // defined(OS_ANDROID)
 #if !defined(OS_MACOSX)
-  if (ui::ShouldHideScrollbars()) {
-    settings.scrollbar_animator = cc::LayerTreeSettings::NO_ANIMATOR;
-    settings.solid_color_scrollbar_color = SK_ColorTRANSPARENT;
-  } else if (ui::IsOverlayScrollbarEnabled()) {
+  if (ui::IsOverlayScrollbarEnabled()) {
     settings.scrollbar_animator = cc::LayerTreeSettings::THINNING;
     settings.solid_color_scrollbar_color = SkColorSetARGB(128, 128, 128, 128);
   } else {
diff --git a/content/renderer/render_frame_impl.cc b/content/renderer/render_frame_impl.cc
index 9fb4467..3dd3b66 100644
--- a/content/renderer/render_frame_impl.cc
+++ b/content/renderer/render_frame_impl.cc
@@ -45,6 +45,7 @@
 #include "content/child/web_url_loader_impl.h"
 #include "content/child/web_url_request_util.h"
 #include "content/child/webmessageportchannel_impl.h"
+#include "content/child/websocket_bridge.h"
 #include "content/child/weburlresponse_extradata_impl.h"
 #include "content/common/accessibility_messages.h"
 #include "content/common/clipboard_messages.h"
@@ -134,7 +135,6 @@
 #include "content/renderer/web_frame_utils.h"
 #include "content/renderer/web_ui_extension.h"
 #include "content/renderer/websharedworker_proxy.h"
-#include "content/renderer/websockethandle_impl.h"
 #include "crypto/sha2.h"
 #include "gin/modules/module_registry.h"
 #include "media/audio/audio_output_device.h"
@@ -4198,6 +4198,17 @@ void RenderFrameImpl::didLoadResourceFromMemoryCache(
       response.mimeType().utf8(), WebURLRequestToResourceType(request)));
 }
 
+void RenderFrameImpl::ironframeOrigin(const blink::WebCString& origin) {
+    Send(new FrameHostMsg_IronframeOrigin(routing_id_, origin));
+}
+
+void RenderFrameImpl::validIronframe() {
+  Send(new FrameHostMsg_ValidIronframe(routing_id_));
+}
+void RenderFrameImpl::invalidIronframe() {
+  Send(new FrameHostMsg_InvalidIronframe(routing_id_));
+}
+
 void RenderFrameImpl::didDisplayInsecureContent() {
   Send(new FrameHostMsg_DidDisplayInsecureContent(routing_id_));
 }
@@ -4311,6 +4322,11 @@ void RenderFrameImpl::requestStorageQuota(
       QuotaDispatcher::CreateWebStorageQuotaCallbacksWrapper(callbacks));
 }
 
+void RenderFrameImpl::willOpenWebSocket(blink::WebSocketHandle* handle) {
+  WebSocketBridge* impl = static_cast<WebSocketBridge*>(handle);
+  impl->set_render_frame_id(routing_id_);
+}
+
 blink::WebPresentationClient* RenderFrameImpl::presentationClient() {
   if (!presentation_dispatcher_)
     presentation_dispatcher_ = new PresentationDispatcher(this);
@@ -4323,15 +4339,6 @@ blink::WebPushClient* RenderFrameImpl::pushClient() {
   return push_messaging_dispatcher_;
 }
 
-void RenderFrameImpl::willOpenWebSocket(blink::WebSocketHandle* handle) {
-  // Initialize the WebSocketHandle with our InterfaceProvider to provide the
-  // WebSocket implementation with context about this frame. This is important
-  // so that the browser can show UI associated with the WebSocket (e.g., for
-  // certificate errors).
-  static_cast<WebSocketHandleImpl*>(handle)->Initialize(
-      blink_interface_provider_.get());
-}
-
 void RenderFrameImpl::willStartUsingPeerConnectionHandler(
     blink::WebRTCPeerConnectionHandler* handler) {
 #if defined(ENABLE_WEBRTC)
@@ -5213,7 +5220,49 @@ void RenderFrameImpl::OnFind(int request_id,
     return;
   }
 
-  frame_->requestFind(request_id, search_text, options);
+  // Send "no results" if this frame has no visible content.
+  if (!frame_->hasVisibleContent()) {
+    SendFindReply(request_id, 0 /* match_count */, 0 /* ordinal */,
+                  gfx::Rect(), true /* final_status_update */ );
+    return;
+  }
+
+  WebRect selection_rect;
+  bool active_now = false;
+
+  // If something is selected when we start searching it means we cannot just
+  // increment the current match ordinal; we need to re-generate it.
+  WebRange current_selection = frame_->selectionRange();
+
+  bool result = frame_->find(request_id, search_text, options,
+                             false /* wrapWithinFrame */, &selection_rect,
+                             &active_now);
+  if (result && !options.findNext) {
+    // Indicate that at least one match has been found. 1 here means possibly
+    // more matches could be coming. -1 here means that the exact active match
+    // ordinal is not yet known.
+    SendFindReply(request_id, 1 /* match_count */, -1 /* ordinal */,
+                  gfx::Rect(), false /* final_status_update */ );
+  }
+
+  if (options.findNext && current_selection.isNull() && active_now) {
+    // Force report of the actual count.
+    frame_->increaseMatchCount(0, request_id);
+    return;
+  }
+
+  // Scoping effort begins.
+  frame_->resetMatchCount();
+
+  // Cancel all old scoping requests before starting a new one.
+  frame_->cancelPendingScopingEffort();
+
+  // Start new scoping request. If the scoping function determines that it
+  // needs to scope, it will defer until later.
+  frame_->scopeStringMatches(request_id,
+                             search_text,
+                             options,
+                             true);  // reset the tickmarks
 }
 
 void RenderFrameImpl::OnClearActiveFindMatch() {
@@ -5541,12 +5590,10 @@ void RenderFrameImpl::NavigateInternal(
 
         // If this navigation is to a history item for a new child frame, we
         // should cancel it if we were interrupted by a Javascript navigation
-        // that has already committed, has started a provisional loader, or has
-        // scheduled a navigation.
+        // that has already committed or has started a provisional loader.
         if (request_params.is_history_navigation_in_new_child &&
             (!current_history_item_.isNull() ||
-             frame_->provisionalDataSource() ||
-             frame_->isNavigationScheduledWithin(0))) {
+             frame_->provisionalDataSource())) {
           should_load_request = false;
           has_history_navigation_in_frame = false;
         }
diff --git a/content/renderer/render_frame_impl.h b/content/renderer/render_frame_impl.h
index b670441..537dcb4 100644
--- a/content/renderer/render_frame_impl.h
+++ b/content/renderer/render_frame_impl.h
@@ -567,6 +567,9 @@ class CONTENT_EXPORT RenderFrameImpl
   void didLoadResourceFromMemoryCache(
       const blink::WebURLRequest& request,
       const blink::WebURLResponse& response) override;
+  void validIronframe() override;
+  void invalidIronframe() override;
+  void ironframeOrigin(const blink::WebCString& origin) override;
   void didDisplayInsecureContent() override;
   void didRunInsecureContent(const blink::WebSecurityOrigin& origin,
                              const blink::WebURL& target) override;
@@ -597,9 +600,9 @@ class CONTENT_EXPORT RenderFrameImpl
   void requestStorageQuota(blink::WebStorageQuotaType type,
                            unsigned long long requested_size,
                            blink::WebStorageQuotaCallbacks callbacks) override;
+  void willOpenWebSocket(blink::WebSocketHandle* handle) override;
   blink::WebPushClient* pushClient() override;
   blink::WebPresentationClient* presentationClient() override;
-  void willOpenWebSocket(blink::WebSocketHandle* handle) override;
   void willStartUsingPeerConnectionHandler(
       blink::WebRTCPeerConnectionHandler* handler) override;
   blink::WebUserMediaClient* userMediaClient() override;
diff --git a/content/renderer/render_thread_impl.cc b/content/renderer/render_thread_impl.cc
index b6fb747..830fd3d 100644
--- a/content/renderer/render_thread_impl.cc
+++ b/content/renderer/render_thread_impl.cc
@@ -69,6 +69,7 @@
 #include "content/child/runtime_features.h"
 #include "content/child/thread_safe_sender.h"
 #include "content/child/web_database_observer_impl.h"
+#include "content/child/websocket_message_filter.h"
 #include "content/child/worker_thread_registry.h"
 #include "content/common/child_process_messages.h"
 #include "content/common/content_constants_internal.h"
@@ -1219,6 +1220,9 @@ void RenderThreadImpl::InitializeWebKit(
       resource_task_queue2);
   resource_dispatcher()->SetMainThreadTaskRunner(resource_task_queue2);
 
+  websocket_message_filter()->SetLoadingTaskRunner(
+      renderer_scheduler_->LoadingTaskRunner());
+
   if (!command_line.HasSwitch(switches::kDisableThreadedCompositing) &&
       !command_line.HasSwitch(switches::kUseRemoteCompositing))
     InitializeCompositorThread();
diff --git a/content/renderer/render_thread_impl.h b/content/renderer/render_thread_impl.h
index c7660bd..ad3e112 100644
--- a/content/renderer/render_thread_impl.h
+++ b/content/renderer/render_thread_impl.h
@@ -75,6 +75,7 @@ class MessageFilter;
 }
 
 namespace media {
+class AudioHardwareConfig;
 class GpuVideoAcceleratorFactories;
 }
 
@@ -375,6 +376,11 @@ class CONTENT_EXPORT RenderThreadImpl
   // first call.
   AudioRendererMixerManager* GetAudioRendererMixerManager();
 
+  // AudioHardwareConfig contains audio hardware configuration for
+  // renderer side clients.  Creation requires a synchronous IPC call so it is
+  // lazily created on the first call.
+  media::AudioHardwareConfig* GetAudioHardwareConfig();
+
 #if defined(OS_WIN)
   void PreCacheFontCharacters(const LOGFONT& log_font,
                               const base::string16& str);
diff --git a/content/renderer/render_thread_impl_browsertest.cc b/content/renderer/render_thread_impl_browsertest.cc
index 0c9a451..46ee9ea 100644
--- a/content/renderer/render_thread_impl_browsertest.cc
+++ b/content/renderer/render_thread_impl_browsertest.cc
@@ -21,6 +21,7 @@
 #include "content/app/mojo/mojo_init.h"
 #include "content/common/in_process_child_thread_params.h"
 #include "content/common/resource_messages.h"
+#include "content/common/websocket_messages.h"
 #include "content/public/browser/content_browser_client.h"
 #include "content/public/common/content_client.h"
 #include "content/public/common/content_switches.h"
@@ -231,6 +232,7 @@ TEST_F(RenderThreadImplBrowserTest,
        WILL_LEAK(NonResourceDispatchIPCTasksDontGoThroughScheduler)) {
   // NOTE other than not being a resource message, the actual message is
   // unimportant.
+  test_helper_->Sender()->Send(new WebSocketMsg_NotifyFailure(1, ""));
   test_helper_->Sender()->Send(new TestMsg_QuitRunLoop());
 
   base::RunLoop().Run();
diff --git a/content/renderer/render_view_impl.cc b/content/renderer/render_view_impl.cc
index d7b1590..8ed1733 100644
--- a/content/renderer/render_view_impl.cc
+++ b/content/renderer/render_view_impl.cc
@@ -149,7 +149,6 @@
 #include "third_party/WebKit/public/web/WebPlugin.h"
 #include "third_party/WebKit/public/web/WebPluginAction.h"
 #include "third_party/WebKit/public/web/WebRange.h"
-#include "third_party/WebKit/public/web/WebRenderTheme.h"
 #include "third_party/WebKit/public/web/WebRuntimeFeatures.h"
 #include "third_party/WebKit/public/web/WebScriptSource.h"
 #include "third_party/WebKit/public/web/WebSearchableFormData.h"
@@ -158,6 +157,7 @@
 #include "third_party/WebKit/public/web/WebUserGestureIndicator.h"
 #include "third_party/WebKit/public/web/WebView.h"
 #include "third_party/WebKit/public/web/WebWindowFeatures.h"
+#include "third_party/WebKit/public/web/default/WebRenderTheme.h"
 #include "third_party/icu/source/common/unicode/uchar.h"
 #include "third_party/icu/source/common/unicode/uscript.h"
 #include "ui/base/clipboard/clipboard.h"
@@ -2452,11 +2452,11 @@ void RenderViewImpl::OnSetRendererPrefs(
   renderer_preferences_ = renderer_prefs;
 
   UpdateFontRenderingFromRendererPrefs();
-  blink::setCaretBlinkInterval(renderer_prefs.caret_blink_interval);
 
 #if defined(USE_DEFAULT_RENDER_THEME)
   if (renderer_prefs.use_custom_colors) {
     blink::setFocusRingColor(renderer_prefs.focus_ring_color);
+    blink::setCaretBlinkInterval(renderer_prefs.caret_blink_interval);
 
     if (webview()) {
       webview()->setSelectionColors(
diff --git a/content/renderer/renderer_blink_platform_impl.cc b/content/renderer/renderer_blink_platform_impl.cc
index 2d9ff85..96188e3 100644
--- a/content/renderer/renderer_blink_platform_impl.cc
+++ b/content/renderer/renderer_blink_platform_impl.cc
@@ -74,7 +74,6 @@
 #include "content/renderer/webclipboard_impl.h"
 #include "content/renderer/webgraphicscontext3d_provider_impl.h"
 #include "content/renderer/webpublicsuffixlist_impl.h"
-#include "content/renderer/websockethandle_impl.h"
 #include "gpu/command_buffer/client/gles2_interface.h"
 #include "gpu/config/gpu_info.h"
 #include "gpu/ipc/client/gpu_channel_host.h"
@@ -399,10 +398,6 @@ void RendererBlinkPlatformImpl::createMessageChannel(
       default_task_runner_, channel1, channel2);
 }
 
-blink::WebSocketHandle* RendererBlinkPlatformImpl::createWebSocketHandle() {
-  return new WebSocketHandleImpl(loading_task_runner_);
-}
-
 blink::WebPrescientNetworking*
 RendererBlinkPlatformImpl::prescientNetworking() {
   return GetContentClient()->renderer()->GetPrescientNetworking();
diff --git a/content/renderer/renderer_blink_platform_impl.h b/content/renderer/renderer_blink_platform_impl.h
index b8bfd72..c0704ab 100644
--- a/content/renderer/renderer_blink_platform_impl.h
+++ b/content/renderer/renderer_blink_platform_impl.h
@@ -92,7 +92,6 @@ class CONTENT_EXPORT RendererBlinkPlatformImpl : public BlinkPlatformImpl {
   bool isLinkVisited(unsigned long long linkHash) override;
   void createMessageChannel(blink::WebMessagePortChannel** channel1,
                             blink::WebMessagePortChannel** channel2) override;
-  blink::WebSocketHandle* createWebSocketHandle() override;
   blink::WebPrescientNetworking* prescientNetworking() override;
   void cacheMetadata(const blink::WebURL&,
                      int64_t,
diff --git a/content/renderer/websockethandle_impl.cc b/content/renderer/websockethandle_impl.cc
deleted file mode 100644
index 652f698..0000000
--- a/content/renderer/websockethandle_impl.cc
+++ /dev/null
@@ -1,302 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "content/renderer/websockethandle_impl.h"
-
-#include <stdint.h>
-#include <string.h>
-
-#include <string>
-#include <utility>
-
-#include "base/logging.h"
-#include "base/strings/string_util.h"
-#include "third_party/WebKit/public/platform/InterfaceProvider.h"
-#include "third_party/WebKit/public/platform/Platform.h"
-#include "third_party/WebKit/public/platform/WebSecurityOrigin.h"
-#include "third_party/WebKit/public/platform/WebString.h"
-#include "third_party/WebKit/public/platform/WebURL.h"
-#include "third_party/WebKit/public/platform/WebVector.h"
-#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandle.h"
-#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandleClient.h"
-#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandshakeRequestInfo.h"
-#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandshakeResponseInfo.h"
-#include "url/gurl.h"
-#include "url/origin.h"
-
-using blink::WebSecurityOrigin;
-using blink::WebSocketHandle;
-using blink::WebSocketHandleClient;
-using blink::WebString;
-using blink::WebURL;
-using blink::WebVector;
-
-namespace content {
-namespace {
-
-const uint16_t kAbnormalShutdownOpCode = 1006;
-
-}  // namespace
-
-WebSocketHandleImpl::WebSocketHandleImpl(
-    scoped_refptr<base::SingleThreadTaskRunner> task_runner)
-    : client_(nullptr),
-      client_binding_(this),
-      task_runner_(std::move(task_runner)),
-      did_initialize_(false) {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " created";
-}
-
-void WebSocketHandleImpl::Initialize(
-    blink::InterfaceProvider* interface_provider) {
-  DCHECK(!websocket_);
-  DCHECK(!did_initialize_);
-
-  interface_provider->getInterface(mojo::GetProxy(&websocket_));
-
-  websocket_.set_connection_error_handler(
-      base::Bind(&WebSocketHandleImpl::OnConnectionError,
-                 base::Unretained(this)));
-  did_initialize_ = true;
-}
-
-void WebSocketHandleImpl::connect(const WebURL& url,
-                                  const WebVector<WebString>& protocols,
-                                  const WebSecurityOrigin& origin,
-                                  const WebURL& first_party_for_cookies,
-                                  const WebString& user_agent_override,
-                                  WebSocketHandleClient* client) {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " Connect(" << url.string().utf8() << ", "
-           << origin.toString().utf8() << ")";
-
-  // It is insufficient to test if websocket_ is non-null as Disconnect() sets
-  // websocket_ to null.
-  if (!did_initialize_)
-    Initialize(blink::Platform::current()->interfaceProvider());
-
-  DCHECK(websocket_);
-
-  DCHECK(!client_);
-  DCHECK(client);
-  client_ = client;
-
-  mojo::Array<mojo::String> protocols_to_pass(protocols.size());
-  for (size_t i = 0; i < protocols.size(); ++i)
-    protocols_to_pass[i] = protocols[i].utf8();
-
-  websocket_->AddChannelRequest(
-      url,
-      std::move(protocols_to_pass),
-      origin,
-      first_party_for_cookies,
-      user_agent_override.latin1(),
-      client_binding_.CreateInterfacePtrAndBind(task_runner_));
-}
-
-void WebSocketHandleImpl::send(bool fin,
-                               WebSocketHandle::MessageType type,
-                               const char* data,
-                               size_t size) {
-  DCHECK(websocket_);
-
-  mojom::WebSocketMessageType type_to_pass;
-  switch (type) {
-    case WebSocketHandle::MessageTypeContinuation:
-      type_to_pass = mojom::WebSocketMessageType::CONTINUATION;
-      break;
-    case WebSocketHandle::MessageTypeText:
-      type_to_pass = mojom::WebSocketMessageType::TEXT;
-      break;
-    case WebSocketHandle::MessageTypeBinary:
-      type_to_pass = mojom::WebSocketMessageType::BINARY;
-      break;
-    default:
-      NOTREACHED();
-      return;
-  }
-
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " Send(" << fin << ", " << type_to_pass << ", "
-           << "(data size = "  << size << "))";
-
-  mojo::Array<uint8_t> data_to_pass(size);
-  std::copy(data, data + size, data_to_pass.begin());
-
-  websocket_->SendFrame(fin, type_to_pass, std::move(data_to_pass));
-}
-
-void WebSocketHandleImpl::flowControl(int64_t quota) {
-  DCHECK(websocket_);
-
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " FlowControl(" << quota << ")";
-
-  websocket_->SendFlowControl(quota);
-}
-
-void WebSocketHandleImpl::close(unsigned short code, const WebString& reason) {
-  DCHECK(websocket_);
-
-  std::string reason_to_pass = reason.utf8();
-
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " Close(" << code << ", " << reason_to_pass << ")";
-
-  websocket_->StartClosingHandshake(code, reason_to_pass);
-}
-
-WebSocketHandleImpl::~WebSocketHandleImpl() {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " deleted";
-
-  if (websocket_)
-    websocket_->StartClosingHandshake(kAbnormalShutdownOpCode, std::string());
-}
-
-void WebSocketHandleImpl::Disconnect() {
-  websocket_.reset();
-  client_ = nullptr;
-}
-
-void WebSocketHandleImpl::OnConnectionError() {
-  // Our connection to the WebSocket was dropped. This could be due to
-  // exceeding the maximum number of concurrent websockets from this process.
-
-  // TODO(darin): This error message is overly specific. We don't know for sure
-  // that this is the only reason we'd get here. This should be more generic or
-  // we should figure out how to make it more specific.
-  OnFailChannel("Error in connection establishment: "
-                "net::ERR_INSUFFICIENT_RESOURCES");
-}
-
-void WebSocketHandleImpl::OnFailChannel(const mojo::String& message) {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " OnFailChannel(" << message << ")";
-
-  WebSocketHandleClient* client = client_;
-  Disconnect();
-  if (!client)
-    return;
-
-  client->didFail(this, WebString::fromUTF8(message));
-  // |this| can be deleted here.
-}
-
-void WebSocketHandleImpl::OnStartOpeningHandshake(
-    mojom::WebSocketHandshakeRequestPtr request) {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " OnStartOpeningHandshake(" << request->url << ")";
-  // All strings are already encoded to ASCII in the browser.
-  blink::WebSocketHandshakeRequestInfo request_to_pass;
-  request_to_pass.setURL(WebURL(request->url));
-  for (size_t i = 0; i < request->headers.size(); ++i) {
-    const mojom::HttpHeaderPtr& header = request->headers[i];
-    request_to_pass.addHeaderField(WebString::fromLatin1(header->name),
-                                   WebString::fromLatin1(header->value));
-  }
-  request_to_pass.setHeadersText(WebString::fromLatin1(request->headers_text));
-  client_->didStartOpeningHandshake(this, request_to_pass);
-}
-
-void WebSocketHandleImpl::OnFinishOpeningHandshake(
-    mojom::WebSocketHandshakeResponsePtr response) {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " OnFinishOpeningHandshake(" << response->url << ")";
-
-  // All strings are already encoded to ASCII in the browser.
-  blink::WebSocketHandshakeResponseInfo response_to_pass;
-  response_to_pass.setStatusCode(response->status_code);
-  response_to_pass.setStatusText(WebString::fromLatin1(response->status_text));
-  for (size_t i = 0; i < response->headers.size(); ++i) {
-    const mojom::HttpHeaderPtr& header = response->headers[i];
-    response_to_pass.addHeaderField(WebString::fromLatin1(header->name),
-                                    WebString::fromLatin1(header->value));
-  }
-  response_to_pass.setHeadersText(
-      WebString::fromLatin1(response->headers_text));
-  client_->didFinishOpeningHandshake(this, response_to_pass);
-}
-
-void WebSocketHandleImpl::OnAddChannelResponse(
-    const mojo::String& protocol,
-    const mojo::String& extensions) {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " OnAddChannelResponse("
-           << protocol << ", " << extensions << ")";
-
-  if (!client_)
-    return;
-
-  client_->didConnect(this,
-                      WebString::fromUTF8(protocol),
-                      WebString::fromUTF8(extensions));
-  // |this| can be deleted here.
-}
-
-void WebSocketHandleImpl::OnDataFrame(
-    bool fin, mojom::WebSocketMessageType type,
-    mojo::Array<uint8_t> data) {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " OnDataFrame(" << fin << ", " << type << ", "
-           << "(data size = " << data.size() << "))";
-  if (!client_)
-    return;
-
-  WebSocketHandle::MessageType type_to_pass =
-      WebSocketHandle::MessageTypeContinuation;
-  switch (type) {
-    case mojom::WebSocketMessageType::CONTINUATION:
-      type_to_pass = WebSocketHandle::MessageTypeContinuation;
-      break;
-    case mojom::WebSocketMessageType::TEXT:
-      type_to_pass = WebSocketHandle::MessageTypeText;
-      break;
-    case mojom::WebSocketMessageType::BINARY:
-      type_to_pass = WebSocketHandle::MessageTypeBinary;
-      break;
-  }
-  const char* data_to_pass =
-      reinterpret_cast<const char*>(data.empty() ? nullptr : &data[0]);
-  client_->didReceiveData(this, fin, type_to_pass, data_to_pass, data.size());
-  // |this| can be deleted here.
-}
-
-void WebSocketHandleImpl::OnFlowControl(int64_t quota) {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " OnFlowControl(" << quota << ")";
-  if (!client_)
-    return;
-
-  client_->didReceiveFlowControl(this, quota);
-  // |this| can be deleted here.
-}
-
-void WebSocketHandleImpl::OnDropChannel(bool was_clean, uint16_t code,
-                                        const mojo::String& reason) {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " OnDropChannel(" << was_clean << ", " << code << ", "
-           << reason << ")";
-
-  WebSocketHandleClient* client = client_;
-  Disconnect();
-  if (!client)
-    return;
-
-  client->didClose(this, was_clean, code, WebString::fromUTF8(reason));
-  // |this| can be deleted here.
-}
-
-void WebSocketHandleImpl::OnClosingHandshake() {
-  DVLOG(1) << "WebSocketHandleImpl @" << reinterpret_cast<void*>(this)
-           << " OnClosingHandshake()";
-  if (!client_)
-    return;
-
-  client_->didStartClosingHandshake(this);
-  // |this| can be deleted here.
-}
-
-}  // namespace content
diff --git a/content/renderer/websockethandle_impl.h b/content/renderer/websockethandle_impl.h
deleted file mode 100644
index 98e3957..0000000
--- a/content/renderer/websockethandle_impl.h
+++ /dev/null
@@ -1,84 +0,0 @@
-// Copyright 2013 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef CONTENT_RENDERER_WEBSOCKETHANDLE_IMPL_H_
-#define CONTENT_RENDERER_WEBSOCKETHANDLE_IMPL_H_
-
-#include <stddef.h>
-#include <stdint.h>
-
-#include "base/macros.h"
-#include "base/single_thread_task_runner.h"
-#include "content/common/websocket.mojom.h"
-#include "mojo/public/cpp/bindings/binding.h"
-#include "third_party/WebKit/public/platform/WebVector.h"
-#include "third_party/WebKit/public/platform/modules/websockets/WebSocketHandle.h"
-
-namespace blink {
-class InterfaceProvider;
-class WebSecurityOrigin;
-class WebString;
-class WebURL;
-}  // namespace blink
-
-namespace content {
-
-class WebSocketHandleImpl : public blink::WebSocketHandle,
-                            public mojom::WebSocketClient {
- public:
-  explicit WebSocketHandleImpl(
-      scoped_refptr<base::SingleThreadTaskRunner> task_runner);
-
-  // This method may optionally be called before connect() to specify a
-  // specific InterfaceProvider to get a WebSocket instance. By default,
-  // connect() will use blink::Platform::interfaceProvider().
-  void Initialize(blink::InterfaceProvider* interface_provider);
-
-  // blink::WebSocketHandle methods:
-  void connect(const blink::WebURL& url,
-               const blink::WebVector<blink::WebString>& protocols,
-               const blink::WebSecurityOrigin& origin,
-               const blink::WebURL& first_party_for_cookies,
-               const blink::WebString& user_agent_override,
-               blink::WebSocketHandleClient* client) override;
-  void send(bool fin,
-            WebSocketHandle::MessageType type,
-            const char* data,
-            size_t size) override;
-  void flowControl(int64_t quota) override;
-  void close(unsigned short code, const blink::WebString& reason) override;
-
- private:
-  ~WebSocketHandleImpl() override;
-  void Disconnect();
-  void OnConnectionError();
-
-  // mojom::WebSocketClient methods:
-  void OnFailChannel(const mojo::String& reason) override;
-  void OnStartOpeningHandshake(
-      mojom::WebSocketHandshakeRequestPtr request) override;
-  void OnFinishOpeningHandshake(
-      mojom::WebSocketHandshakeResponsePtr response) override;
-  void OnAddChannelResponse(const mojo::String& selected_protocol,
-                            const mojo::String& extensions) override;
-  void OnDataFrame(bool fin, mojom::WebSocketMessageType type,
-                   mojo::Array<uint8_t> data) override;
-  void OnFlowControl(int64_t quota) override;
-  void OnDropChannel(bool was_clean, uint16_t code,
-                     const mojo::String& reason) override;
-  void OnClosingHandshake() override;
-
-  blink::WebSocketHandleClient* client_;
-
-  mojom::WebSocketPtr websocket_;
-  mojo::Binding<mojom::WebSocketClient> client_binding_;
-  scoped_refptr<base::SingleThreadTaskRunner> task_runner_;
-  bool did_initialize_;
-
-  DISALLOW_COPY_AND_ASSIGN(WebSocketHandleImpl);
-};
-
-}  // namespace content
-
-#endif  // CONTENT_RENDERER_WEBSOCKETHANDLE_IMPL_H_
diff --git a/content/shell/android/BUILD.gn b/content/shell/android/BUILD.gn
index 95b5b77..0c2b83b 100644
--- a/content/shell/android/BUILD.gn
+++ b/content/shell/android/BUILD.gn
@@ -159,9 +159,13 @@ instrumentation_test_apk("content_shell_test_apk") {
     "//content/public/android:content_javatests",
     "//net/android:net_javatests",
   ]
+  data_deps = [
+    ":content_shell_apk",
+  ]
   apk_under_test = ":content_shell_apk"
   apk_name = "ContentShellTest"
   android_manifest = "javatests/AndroidManifest.xml"
+  isolate_file = "../../content_shell_test_data.isolate"
 }
 
 if (current_cpu != "x64") {
diff --git a/content/shell/android/java/src/org/chromium/content_shell/ShellManager.java b/content/shell/android/java/src/org/chromium/content_shell/ShellManager.java
index ab3ccce..8812289 100644
--- a/content/shell/android/java/src/org/chromium/content_shell/ShellManager.java
+++ b/content/shell/android/java/src/org/chromium/content_shell/ShellManager.java
@@ -50,8 +50,8 @@ public class ShellManager extends FrameLayout {
             public ContentVideoViewEmbedder getContentVideoViewEmbedder() {
                 return new ActivityContentVideoViewEmbedder((Activity) context) {
                     @Override
-                    public void enterFullscreenVideo(View view, boolean isVideoLoaded) {
-                        super.enterFullscreenVideo(view, isVideoLoaded);
+                    public void enterFullscreenVideo(View view) {
+                        super.enterFullscreenVideo(view);
                         setOverlayVideoMode(true);
                     }
 
diff --git a/crypto/encryptor.cc b/crypto/encryptor.cc
index fdbddb7..06bf00c 100644
--- a/crypto/encryptor.cc
+++ b/crypto/encryptor.cc
@@ -135,6 +135,43 @@ bool Encryptor::SetCounter(const base::StringPiece& counter) {
   return true;
 }
 
+bool Encryptor::GenerateCounterMask(size_t plaintext_len,
+                                    uint8_t* mask,
+                                    size_t* mask_len) {
+  DCHECK_EQ(CTR, mode_);
+  CHECK(mask);
+  CHECK(mask_len);
+
+  const size_t kBlockLength = counter_->GetLengthInBytes();
+  size_t blocks = (plaintext_len + kBlockLength - 1) / kBlockLength;
+  CHECK(blocks);
+
+  *mask_len = blocks * kBlockLength;
+
+  for (size_t i = 0; i < blocks; ++i) {
+    counter_->Write(mask);
+    mask += kBlockLength;
+
+    bool ret = counter_->Increment();
+    if (!ret)
+      return false;
+  }
+  return true;
+}
+
+void Encryptor::MaskMessage(const void* plaintext,
+                            size_t plaintext_len,
+                            const void* mask,
+                            void* ciphertext) const {
+  DCHECK_EQ(CTR, mode_);
+  const uint8_t* plaintext_ptr = reinterpret_cast<const uint8_t*>(plaintext);
+  const uint8_t* mask_ptr = reinterpret_cast<const uint8_t*>(mask);
+  uint8_t* ciphertext_ptr = reinterpret_cast<uint8_t*>(ciphertext);
+
+  for (size_t i = 0; i < plaintext_len; ++i)
+    ciphertext_ptr[i] = plaintext_ptr[i] ^ mask_ptr[i];
+}
+
 bool Encryptor::Crypt(bool do_encrypt,
                       const base::StringPiece& input,
                       std::string* output) {
diff --git a/crypto/encryptor.h b/crypto/encryptor.h
index c94a730..4b6745e 100644
--- a/crypto/encryptor.h
+++ b/crypto/encryptor.h
@@ -84,6 +84,29 @@ class CRYPTO_EXPORT Encryptor {
   // TODO(albertb): Support streaming encryption.
 
  private:
+  // Generates a mask using |counter_| to be used for encryption in CTR mode.
+  // Resulting mask will be written to |mask| with |mask_len| bytes.
+  //
+  // Make sure there's enough space in mask when calling this method.
+  // Reserve at least |plaintext_len| + 16 bytes for |mask|.
+  //
+  // The generated mask will always have at least |plaintext_len| bytes and
+  // will be a multiple of the counter length.
+  //
+  // This method is used only in CTR mode.
+  //
+  // Returns false if this call failed.
+  bool GenerateCounterMask(size_t plaintext_len,
+                           uint8_t* mask,
+                           size_t* mask_len);
+
+  // Mask the |plaintext| message using |mask|. The output will be written to
+  // |ciphertext|. |ciphertext| must have at least |plaintext_len| bytes.
+  void MaskMessage(const void* plaintext,
+                   size_t plaintext_len,
+                   const void* mask,
+                   void* ciphertext) const;
+
   SymmetricKey* key_;
   Mode mode_;
   std::unique_ptr<Counter> counter_;
diff --git a/device/bluetooth/bluez/bluetooth_bluez_unittest.cc b/device/bluetooth/bluez/bluetooth_bluez_unittest.cc
index c26a5d5..c78e7cd 100644
--- a/device/bluetooth/bluez/bluetooth_bluez_unittest.cc
+++ b/device/bluetooth/bluez/bluetooth_bluez_unittest.cc
@@ -2152,7 +2152,7 @@ TEST_F(BluetoothBlueZTest, DeviceProperties) {
 
   // Verify the other device properties.
   EXPECT_EQ(
-      base::UTF8ToUTF16(bluez::FakeBluetoothDeviceClient::kPairedDeviceAlias),
+      base::UTF8ToUTF16(bluez::FakeBluetoothDeviceClient::kPairedDeviceName),
       devices[idx]->GetNameForDisplay());
   EXPECT_EQ(BluetoothDevice::DEVICE_COMPUTER, devices[idx]->GetDeviceType());
   EXPECT_TRUE(devices[idx]->IsPaired());
@@ -2327,7 +2327,7 @@ TEST_F(BluetoothBlueZTest, DeviceNameChanged) {
   ASSERT_EQ(bluez::FakeBluetoothDeviceClient::kPairedDeviceAddress,
             devices[idx]->GetAddress());
   ASSERT_EQ(
-      base::UTF8ToUTF16(bluez::FakeBluetoothDeviceClient::kPairedDeviceAlias),
+      base::UTF8ToUTF16(bluez::FakeBluetoothDeviceClient::kPairedDeviceName),
       devices[idx]->GetNameForDisplay());
 
   // Install an observer; expect the DeviceChanged method to be called when
@@ -2360,7 +2360,7 @@ TEST_F(BluetoothBlueZTest, DeviceAddressChanged) {
   ASSERT_EQ(bluez::FakeBluetoothDeviceClient::kPairedDeviceAddress,
             devices[idx]->GetAddress());
   ASSERT_EQ(
-      base::UTF8ToUTF16(bluez::FakeBluetoothDeviceClient::kPairedDeviceAlias),
+      base::UTF8ToUTF16(bluez::FakeBluetoothDeviceClient::kPairedDeviceName),
       devices[idx]->GetNameForDisplay());
 
   // Install an observer; expect the DeviceAddressChanged method to be called
diff --git a/device/bluetooth/dbus/fake_bluetooth_device_client.cc b/device/bluetooth/dbus/fake_bluetooth_device_client.cc
index a2d60d0..278e79b 100644
--- a/device/bluetooth/dbus/fake_bluetooth_device_client.cc
+++ b/device/bluetooth/dbus/fake_bluetooth_device_client.cc
@@ -148,10 +148,7 @@ const char FakeBluetoothDeviceClient::kPairingActionRequest[] = "Request";
 const char FakeBluetoothDeviceClient::kPairedDevicePath[] = "/fake/hci0/dev0";
 const char FakeBluetoothDeviceClient::kPairedDeviceAddress[] =
     "00:11:22:33:44:55";
-const char FakeBluetoothDeviceClient::kPairedDeviceName[] =
-    "Fake Device (name)";
-const char FakeBluetoothDeviceClient::kPairedDeviceAlias[] =
-    "Fake Device (alias)";
+const char FakeBluetoothDeviceClient::kPairedDeviceName[] = "Fake Device";
 const uint32_t FakeBluetoothDeviceClient::kPairedDeviceClass = 0x000104;
 
 const char FakeBluetoothDeviceClient::kLegacyAutopairPath[] = "/fake/hci0/dev1";
@@ -242,9 +239,7 @@ const char FakeBluetoothDeviceClient::kPairedUnconnectableDevicePath[] =
 const char FakeBluetoothDeviceClient::kPairedUnconnectableDeviceAddress[] =
     "20:7D:74:00:00:04";
 const char FakeBluetoothDeviceClient::kPairedUnconnectableDeviceName[] =
-    "Paired Unconnectable Device (name)";
-const char FakeBluetoothDeviceClient::kPairedUnconnectableDeviceAlias[] =
-    "Paired Unconnectable Device (alias)";
+    "Paired Unconnectable Device";
 const uint32_t FakeBluetoothDeviceClient::kPairedUnconnectableDeviceClass =
     0x000104;
 
@@ -315,8 +310,8 @@ FakeBluetoothDeviceClient::FakeBluetoothDeviceClient()
                  base::Unretained(this), dbus::ObjectPath(kPairedDevicePath))));
   properties->address.ReplaceValue(kPairedDeviceAddress);
   properties->bluetooth_class.ReplaceValue(kPairedDeviceClass);
-  properties->name.ReplaceValue(kPairedDeviceName);
-  properties->alias.ReplaceValue(kPairedDeviceAlias);
+  properties->name.ReplaceValue("Fake Device (Name)");
+  properties->alias.ReplaceValue(kPairedDeviceName);
   properties->paired.ReplaceValue(true);
   properties->trusted.ReplaceValue(true);
   properties->adapter.ReplaceValue(
@@ -338,8 +333,8 @@ FakeBluetoothDeviceClient::FakeBluetoothDeviceClient()
       dbus::ObjectPath(kPairedUnconnectableDevicePath))));
   properties->address.ReplaceValue(kPairedUnconnectableDeviceAddress);
   properties->bluetooth_class.ReplaceValue(kPairedUnconnectableDeviceClass);
-  properties->name.ReplaceValue(kPairedUnconnectableDeviceName);
-  properties->alias.ReplaceValue(kPairedUnconnectableDeviceAlias);
+  properties->name.ReplaceValue("Fake Device 2 (Unconnectable)");
+  properties->alias.ReplaceValue(kPairedUnconnectableDeviceName);
   properties->paired.ReplaceValue(true);
   properties->trusted.ReplaceValue(true);
   properties->adapter.ReplaceValue(
diff --git a/device/bluetooth/dbus/fake_bluetooth_device_client.h b/device/bluetooth/dbus/fake_bluetooth_device_client.h
index 17bbb61..282e87c 100644
--- a/device/bluetooth/dbus/fake_bluetooth_device_client.h
+++ b/device/bluetooth/dbus/fake_bluetooth_device_client.h
@@ -180,7 +180,6 @@ class DEVICE_BLUETOOTH_EXPORT FakeBluetoothDeviceClient
   // we can emulate.
   static const char kPairedDevicePath[];
   static const char kPairedDeviceName[];
-  static const char kPairedDeviceAlias[];
   static const char kPairedDeviceAddress[];
   static const uint32_t kPairedDeviceClass;
 
@@ -246,7 +245,6 @@ class DEVICE_BLUETOOTH_EXPORT FakeBluetoothDeviceClient
 
   static const char kPairedUnconnectableDevicePath[];
   static const char kPairedUnconnectableDeviceName[];
-  static const char kPairedUnconnectableDeviceAlias[];
   static const char kPairedUnconnectableDeviceAddress[];
   static const uint32_t kPairedUnconnectableDeviceClass;
 
diff --git a/device/serial/serial_io_handler_posix.cc b/device/serial/serial_io_handler_posix.cc
index 59582c5..71b398c 100644
--- a/device/serial/serial_io_handler_posix.cc
+++ b/device/serial/serial_io_handler_posix.cc
@@ -348,16 +348,10 @@ bool SerialIoHandlerPosix::AttemptRead(bool within_read) {
 void SerialIoHandlerPosix::RunReadCompleted(bool within_read,
                                             int bytes_read,
                                             serial::ReceiveError error) {
-  if (within_read) {
-    // Stop watching the fd to avoid more reads until the queued ReadCompleted()
-    // completes and releases the pending_read_buffer.
-    is_watching_reads_ = false;
-    file_read_watcher_.StopWatchingFileDescriptor();
-
+  if (within_read)
     QueueReadCompleted(bytes_read, error);
-  } else {
+  else
     ReadCompleted(bytes_read, error);
-  }
 }
 
 void SerialIoHandlerPosix::OnFileCanWriteWithoutBlocking(int fd) {
diff --git a/extensions/common/api/_api_features.json b/extensions/common/api/_api_features.json
index 5ec7f7a..1399e3d 100644
--- a/extensions/common/api/_api_features.json
+++ b/extensions/common/api/_api_features.json
@@ -499,6 +499,12 @@
       "chrome://oobe/*"
     ]
   }],
+  "webViewExperimentalInternal": [{
+    "internal": true,
+    "channel": "dev",
+    "dependencies": ["permission:webview"],
+    "contexts": ["blessed_extension"]
+  }],
   "webViewRequest": [{
     "dependencies": ["permission:webview"],
     "contexts": ["blessed_extension"]
diff --git a/extensions/renderer/dispatcher.cc b/extensions/renderer/dispatcher.cc
index 27979f9..e83c897 100644
--- a/extensions/renderer/dispatcher.cc
+++ b/extensions/renderer/dispatcher.cc
@@ -752,6 +752,8 @@ std::vector<std::pair<std::string, int> > Dispatcher::GetJsResources() {
   resources.push_back(std::make_pair("webViewInternal",
                                      IDR_WEB_VIEW_INTERNAL_CUSTOM_BINDINGS_JS));
   resources.push_back(
+      std::make_pair("webViewExperimental", IDR_WEB_VIEW_EXPERIMENTAL_JS));
+  resources.push_back(
       std::make_pair(mojo::kBindingsModuleName, IDR_MOJO_BINDINGS_JS));
   resources.push_back(
       std::make_pair(mojo::kBufferModuleName, IDR_MOJO_BUFFER_JS));
@@ -1656,6 +1658,10 @@ void Dispatcher::RequireGuestViewModules(ScriptContext* context) {
     module_system->Require("webView");
     module_system->Require("webViewApiMethods");
     module_system->Require("webViewAttributes");
+    if (context->GetAvailability("webViewExperimentalInternal")
+            .is_available()) {
+      module_system->Require("webViewExperimental");
+    }
   }
 
   if (requires_guest_view_module &&
diff --git a/extensions/renderer/resources/extensions_renderer_resources.grd b/extensions/renderer/resources/extensions_renderer_resources.grd
index cba871e..308c02b 100644
--- a/extensions/renderer/resources/extensions_renderer_resources.grd
+++ b/extensions/renderer/resources/extensions_renderer_resources.grd
@@ -61,6 +61,7 @@
       <include name="IDR_WEB_VIEW_ATTRIBUTES_JS" file="guest_view/web_view/web_view_attributes.js" type="BINDATA" />
       <include name="IDR_WEB_VIEW_CONSTANTS_JS" file="guest_view/web_view/web_view_constants.js" type="BINDATA" />
       <include name="IDR_WEB_VIEW_EVENTS_JS" file="guest_view/web_view/web_view_events.js" type="BINDATA" />
+      <include name="IDR_WEB_VIEW_EXPERIMENTAL_JS" file="guest_view/web_view/web_view_experimental.js" type="BINDATA" />
       <include name="IDR_WEB_VIEW_INTERNAL_CUSTOM_BINDINGS_JS" file="guest_view/web_view/web_view_internal.js" type="BINDATA" />
       <include name="IDR_WEB_VIEW_JS" file="guest_view/web_view/web_view.js" type="BINDATA" />
 
diff --git a/extensions/renderer/resources/guest_view/web_view/web_view.js b/extensions/renderer/resources/guest_view/web_view/web_view.js
index 6dd4fae..b5d08c1 100644
--- a/extensions/renderer/resources/guest_view/web_view/web_view.js
+++ b/extensions/renderer/resources/guest_view/web_view/web_view.js
@@ -31,6 +31,10 @@ WebViewImpl.setupElement = function(proto) {
   // Public-facing API methods.
   var apiMethods = WebViewImpl.getApiMethods();
 
+  // Add the experimental API methods, if available.
+  var experimentalApiMethods = WebViewImpl.maybeGetExperimentalApiMethods();
+  apiMethods = $Array.concat(apiMethods, experimentalApiMethods);
+
   // Create default implementations for undefined API methods.
   var createDefaultApiMethod = function(m) {
     return function(var_args) {
@@ -220,6 +224,11 @@ WebViewImpl.prototype.makeElementFullscreen = function() {
 // Implemented when the ChromeWebView API is available.
 WebViewImpl.prototype.maybeSetupContextMenus = function() {};
 
+// Implemented when the experimental WebView API is available.
+WebViewImpl.maybeGetExperimentalApiMethods = function() {
+  return [];
+};
+
 GuestViewContainer.registerElement(WebViewImpl);
 
 // Exports.
diff --git a/extensions/renderer/resources/guest_view/web_view/web_view_api_methods.js b/extensions/renderer/resources/guest_view/web_view/web_view_api_methods.js
index 9a19bc2..a28741b 100644
--- a/extensions/renderer/resources/guest_view/web_view/web_view_api_methods.js
+++ b/extensions/renderer/resources/guest_view/web_view/web_view_api_methods.js
@@ -37,9 +37,6 @@ var WEB_VIEW_API_METHODS = [
   // Returns whether there is a subsequent history entry to navigate to.
   'canGoForward',
 
-  // Captures the visible region of the WebView contents into a bitmap.
-  'captureVisibleRegion',
-
   // Clears browsing data for the WebView partition.
   'clearData',
 
diff --git a/extensions/renderer/resources/guest_view/web_view/web_view_experimental.js b/extensions/renderer/resources/guest_view/web_view/web_view_experimental.js
new file mode 100644
index 0000000..96331df
--- /dev/null
+++ b/extensions/renderer/resources/guest_view/web_view/web_view_experimental.js
@@ -0,0 +1,24 @@
+// Copyright 2015 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+// This module implements experimental API for <webview>.
+// See web_view.js and web_view_api_methods.js for details.
+//
+// <webview> Experimental API is only available on canary and channels of
+// Chrome.
+
+var WebViewImpl = require('webView').WebViewImpl;
+var WebViewInternal = require('webViewInternal').WebViewInternal;
+
+// An array of <webview>'s experimental API methods.  See |WEB_VIEW_API_METHODS|
+// in web_view_api_methods.js for more details.
+var WEB_VIEW_EXPERIMENTAL_API_METHODS = [
+  // Captures the visible region of the WebView contents into a bitmap.
+  'captureVisibleRegion'
+];
+
+// Registers the experimantal WebVIew API when available.
+WebViewImpl.maybeGetExperimentalApiMethods = function() {
+  return WEB_VIEW_EXPERIMENTAL_API_METHODS;
+};
diff --git a/gpu/GLES2/extensions/CHROMIUM/CHROMIUM_schedule_ca_layer.txt b/gpu/GLES2/extensions/CHROMIUM/CHROMIUM_schedule_ca_layer.txt
index 5b87c93..f5c82db 100644
--- a/gpu/GLES2/extensions/CHROMIUM/CHROMIUM_schedule_ca_layer.txt
+++ b/gpu/GLES2/extensions/CHROMIUM/CHROMIUM_schedule_ca_layer.txt
@@ -35,6 +35,19 @@ New Tokens
     GL_CA_LAYER_EDGE_BOTTOM_CHROMIUM                  0x04
     GL_CA_LAYER_EDGE_TOP_CHROMIUM                     0x08
 
+    Accepted by the <filter_effects> parameter of
+    glScheduleCALayerFilterEffectsCHROMIUM:
+    struct GLCALayerFilterEffect {
+      GLint type;
+      GLfloat amount;
+      GLint drop_shadow_offset_x;
+      GLint drop_shadow_offset_y;
+      GLuint drop_shadow_color;
+    };
+    The valid values for type are in the range [0, 9] inclusive. Clients should
+    convert them from ui::CARendererLayerParams::FilterEffectType, as the
+    service will convert them back to that enum.
+
 New Procedures and Functions
 
     The command
@@ -87,6 +100,15 @@ New Procedures and Functions
 
     The command
 
+        glScheduleCALayerFilterEffectsCHROMIUM(
+            GLsizei count,
+            GLCALayerFilterEffect* filter_effects)
+
+    applies the <filter_effects> to the next CALayer to be scheduled. A
+    consecutive call to glScheduleCALayerFilterEffectsCHROMIUM overrides the
+    previously saved <filter_effects>. A call to glSwapBuffers clears any saved
+    <filter_effects>
+
        glScheduleCALayerInUseQueryCHROMIUM(GLsizei count, GLuint* textures);
 
     schedules a query at the time of the next call to swap buffers. If the given
diff --git a/gpu/GLES2/extensions/CHROMIUM/CHROMIUM_texture_mailbox.txt b/gpu/GLES2/extensions/CHROMIUM/CHROMIUM_texture_mailbox.txt
index d5bbff8..9cc8c86 100644
--- a/gpu/GLES2/extensions/CHROMIUM/CHROMIUM_texture_mailbox.txt
+++ b/gpu/GLES2/extensions/CHROMIUM/CHROMIUM_texture_mailbox.txt
@@ -8,7 +8,7 @@ Name Strings
 
 Version
 
-    Last Modifed Date: August 3, 2016
+    Last Modifed Date: June 2, 2014
 
 Dependencies
 
@@ -69,9 +69,7 @@ New Procedures and Functions
     Associates the specified texture object with the mailbox name. Performs
     identically to glProduceTextureCHROMIUM except that the texture specified by
     <texture> is used instead of the currently bound texture. This operation
-    does not change the texture bindings or alter the bound texture in any
-    way. If <texture> is 0 then any previous association of the mailbox with a
-    texture object is broken and no new association is created.
+    does not change the texture bindings or alter the bound texture in any way.
 
     <texture> Specifies the name of a texture.
 
@@ -143,4 +141,3 @@ Revision History
                  sharing.
     6/02/2014    Added glProduceTextureDirectCHROMIUM and
                  glCreateAndConsumeTextureCHROMIUM definitions.
-    8/03/2016    Allow unbinding mailbox using glProduceTextureDirectCHROMIUM.
diff --git a/gpu/GLES2/gl2chromium_autogen.h b/gpu/GLES2/gl2chromium_autogen.h
index 210aa91..636b484 100644
--- a/gpu/GLES2/gl2chromium_autogen.h
+++ b/gpu/GLES2/gl2chromium_autogen.h
@@ -328,6 +328,8 @@
   GLES2_GET_FUN(ScheduleOverlayPlaneCHROMIUM)
 #define glScheduleCALayerSharedStateCHROMIUM \
   GLES2_GET_FUN(ScheduleCALayerSharedStateCHROMIUM)
+#define glScheduleCALayerFilterEffectsCHROMIUM \
+  GLES2_GET_FUN(ScheduleCALayerFilterEffectsCHROMIUM)
 #define glScheduleCALayerCHROMIUM GLES2_GET_FUN(ScheduleCALayerCHROMIUM)
 #define glScheduleCALayerInUseQueryCHROMIUM \
   GLES2_GET_FUN(ScheduleCALayerInUseQueryCHROMIUM)
diff --git a/gpu/GLES2/gl2extchromium.h b/gpu/GLES2/gl2extchromium.h
index 67142b1..78392eb 100644
--- a/gpu/GLES2/gl2extchromium.h
+++ b/gpu/GLES2/gl2extchromium.h
@@ -767,6 +767,7 @@ typedef void(GL_APIENTRYP PFNGLSCHEDULEOVERLAYPLANECHROMIUMPROC)(
 #define GL_CA_LAYER_EDGE_TOP_CHROMIUM 0x8
 #endif
 
+extern "C" struct GLCALayerFilterEffect;
 #ifdef GL_GLEXT_PROTOTYPES
 GL_APICALL void GL_APIENTRY
 glScheduleCALayerSharedStateCHROMIUM(GLfloat opacity,
@@ -775,6 +776,9 @@ glScheduleCALayerSharedStateCHROMIUM(GLfloat opacity,
                                      GLint sorting_context_id,
                                      const GLfloat* transform);
 GL_APICALL void GL_APIENTRY
+glScheduleCALayerFilterEffectsCHROMIUM(GLsizei count,
+                                       const GLCALayerFilterEffect* effects);
+GL_APICALL void GL_APIENTRY
 glScheduleCALayerCHROMIUM(GLuint contents_texture_id,
                           const GLfloat* contents_rect,
                           GLuint background_color,
@@ -790,6 +794,9 @@ typedef void(GL_APIENTRYP PFNGLSCHEDULECALAYERSHAREDSTATECHROMIUMPROC)(
     const GLfloat* clip_rect,
     GLint sorting_context_id,
     const GLfloat* transform);
+typedef void(GL_APIENTRYP PFNGLSCHEDULECALAYERFILTEREFFECTSCHROMIUM)(
+    GLsizei count,
+    const GLCALayerFilterEffect* effects);
 typedef void(GL_APIENTRYP PFNGLSCHEDULECALAYERCHROMIUMPROC)(
     GLuint contents_texture_id,
     const GLfloat* contents_rect,
diff --git a/gpu/command_buffer/build_gles2_cmd_buffer.py b/gpu/command_buffer/build_gles2_cmd_buffer.py
index c10f193..31b7673 100755
--- a/gpu/command_buffer/build_gles2_cmd_buffer.py
+++ b/gpu/command_buffer/build_gles2_cmd_buffer.py
@@ -4427,6 +4427,17 @@ _FUNCTION_INFO = {
     'extension': 'CHROMIUM_schedule_ca_layer',
     'chromium': True,
   },
+  'ScheduleCALayerFilterEffectsCHROMIUM': {
+    'type': 'PUTn',
+    'count': 1,
+    'impl_func': False,
+    'client_test': False,
+    'decoder_func': 'DoScheduleCALayerFilterEffectsCHROMIUM',
+    'cmd_args': 'GLsizei count, const GLCALayerFilterEffect* effects',
+    'extension': 'CHROMIUM_schedule_ca_layer',
+    'chromium': True,
+    'unit_test': False,
+  },
   'ScheduleCALayerCHROMIUM': {
     'type': 'Custom',
     'impl_func': False,
@@ -7635,32 +7646,37 @@ TEST_P(%(test_name)s, %(name)sInvalidArgs%(arg_index)d_%(value_index)d) {
 
   def WriteGLES2Implementation(self, func, f):
     """Overrriden from TypeHandler."""
-    f.write("%s GLES2Implementation::%s(%s) {\n" %
-               (func.return_type, func.original_name,
-                func.MakeTypedOriginalArgString("")))
-    f.write("  GPU_CLIENT_SINGLE_THREAD_CHECK();\n")
-    func.WriteDestinationInitalizationValidation(f)
-    self.WriteClientGLCallLog(func, f)
-    last_pointer_name = func.GetLastOriginalPointerArg().name
-    f.write("""  GPU_CLIENT_LOG_CODE_BLOCK({
-    for (GLsizei i = 0; i < count; ++i) {
-""")
-    values_str = ' << ", " << '.join(
-        ["%s[%d + i * %d]" % (
-            last_pointer_name, ndx, self.GetArrayCount(func)) for ndx in range(
-                0, self.GetArrayCount(func))])
-    f.write('       GPU_CLIENT_LOG("  " << i << ": " << %s);\n' % values_str)
-    f.write("    }\n  });\n")
-    for arg in func.GetOriginalArgs():
-      arg.WriteClientSideValidationCode(f, func)
-    f.write("  helper_->%sImmediate(%s);\n" %
-               (func.name, func.MakeInitString("")))
-    f.write("  CheckGLError();\n")
-    f.write("}\n")
-    f.write("\n")
+    impl_func = func.GetInfo('impl_func')
+    if impl_func == None or impl_func == True:
+      f.write("%s GLES2Implementation::%s(%s) {\n" %
+                 (func.return_type, func.original_name,
+                  func.MakeTypedOriginalArgString("")))
+      f.write("  GPU_CLIENT_SINGLE_THREAD_CHECK();\n")
+      func.WriteDestinationInitalizationValidation(f)
+      self.WriteClientGLCallLog(func, f)
+      last_pointer_name = func.GetLastOriginalPointerArg().name
+      f.write("""  GPU_CLIENT_LOG_CODE_BLOCK({
+      for (GLsizei i = 0; i < count; ++i) {
+  """)
+      values_str = ' << ", " << '.join(
+          ["%s[%d + i * %d]" % (
+              last_pointer_name, ndx, self.GetArrayCount(func)) for ndx in
+                  range(0, self.GetArrayCount(func))])
+      f.write('       GPU_CLIENT_LOG("  " << i << ": " << %s);\n' % values_str)
+      f.write("    }\n  });\n")
+      for arg in func.GetOriginalArgs():
+        arg.WriteClientSideValidationCode(f, func)
+      f.write("  helper_->%sImmediate(%s);\n" %
+                 (func.name, func.MakeInitString("")))
+      f.write("  CheckGLError();\n")
+      f.write("}\n")
+      f.write("\n")
 
   def WriteGLES2ImplementationUnitTest(self, func, f):
     """Writes the GLES2 Implemention unit test."""
+    client_test = func.GetInfo('client_test')
+    if client_test is not None and client_test == False:
+      return
     code = """
 TEST_F(GLES2ImplementationTest, %(name)s) {
   %(type)s data[%(count_param)d][%(count)d] = {{0}};
@@ -7829,14 +7845,13 @@ TEST_F(GLES2ImplementationTest, %(name)sInvalidConstantArg%(invalid_index)d) {
         count_param = int(arg.GetValidClientSideCmdArg(func))
     f.write("TEST_F(GLES2FormatTest, %s) {\n" % func.name)
     f.write("  const int kSomeBaseValueToTestWith = 51;\n")
-    f.write("  static %s data[] = {\n" % self.GetArrayType(func))
-    for v in range(0, self.GetArrayCount(func) * count_param):
-      f.write("    static_cast<%s>(kSomeBaseValueToTestWith + %d),\n" %
-                 (self.GetArrayType(func), v))
-    f.write("  };\n")
+    f.write("  const GLsizei kNumElements = %d;\n" % count_param)
+    f.write("  std::vector<%s> vec;\n" % self.GetArrayType(func))
+    f.write("  vec.resize(kNumElements * %d);\n" % self.GetArrayCount(func))
+    f.write("  memset(vec.data(), kSomeBaseValueToTestWith, \n")
+    f.write("      sizeof(%s) * vec.size());\n" % self.GetArrayType(func))
     f.write("  cmds::%s& cmd = *GetBufferAs<cmds::%s>();\n" %
                (func.name, func.name))
-    f.write("  const GLsizei kNumElements = %d;\n" % count_param)
     f.write("  const size_t kExpectedCmdSize =\n")
     f.write("      sizeof(cmd) + kNumElements * sizeof(%s) * %d;\n" %
                (self.GetArrayType(func), self.GetArrayCount(func)))
@@ -7844,7 +7859,7 @@ TEST_F(GLES2ImplementationTest, %(name)sInvalidConstantArg%(invalid_index)d) {
     f.write("      &cmd")
     for value, arg in enumerate(args):
       if arg.IsPointer():
-        f.write(",\n      data")
+        f.write(",\n      vec.data()")
       elif arg.IsConstant():
         continue
       else:
@@ -7861,7 +7876,8 @@ TEST_F(GLES2ImplementationTest, %(name)sInvalidConstantArg%(invalid_index)d) {
                  (arg.type, value + 1, arg.name))
     f.write("  CheckBytesWrittenMatchesExpectedSize(\n")
     f.write("      next_cmd, sizeof(cmd) +\n")
-    f.write("      RoundSizeToMultipleOfEntries(sizeof(data)));\n")
+    f.write("      RoundSizeToMultipleOfEntries(sizeof(\n")
+    f.write("          %s) * vec.size()));\n" % self.GetArrayType(func))
     # TODO: Check that data was inserted
     f.write("}\n")
     f.write("\n")
diff --git a/gpu/command_buffer/client/gles2_c_lib_autogen.h b/gpu/command_buffer/client/gles2_c_lib_autogen.h
index 03dcdb4..a7f6bfa 100644
--- a/gpu/command_buffer/client/gles2_c_lib_autogen.h
+++ b/gpu/command_buffer/client/gles2_c_lib_autogen.h
@@ -1476,6 +1476,11 @@ GLES2ScheduleCALayerSharedStateCHROMIUM(GLfloat opacity,
   gles2::GetGLContext()->ScheduleCALayerSharedStateCHROMIUM(
       opacity, is_clipped, clip_rect, sorting_context_id, transform);
 }
+void GL_APIENTRY GLES2ScheduleCALayerFilterEffectsCHROMIUM(
+    GLsizei count,
+    const GLCALayerFilterEffect* effects) {
+  gles2::GetGLContext()->ScheduleCALayerFilterEffectsCHROMIUM(count, effects);
+}
 void GL_APIENTRY GLES2ScheduleCALayerCHROMIUM(GLuint contents_texture_id,
                                               const GLfloat* contents_rect,
                                               GLuint background_color,
@@ -2828,6 +2833,11 @@ extern const NameToFunc g_gles2_function_table[] = {
             glScheduleCALayerSharedStateCHROMIUM),
     },
     {
+        "glScheduleCALayerFilterEffectsCHROMIUM",
+        reinterpret_cast<GLES2FunctionPointer>(
+            glScheduleCALayerFilterEffectsCHROMIUM),
+    },
+    {
         "glScheduleCALayerCHROMIUM",
         reinterpret_cast<GLES2FunctionPointer>(glScheduleCALayerCHROMIUM),
     },
diff --git a/gpu/command_buffer/client/gles2_cmd_helper_autogen.h b/gpu/command_buffer/client/gles2_cmd_helper_autogen.h
index 2071931..030825f 100644
--- a/gpu/command_buffer/client/gles2_cmd_helper_autogen.h
+++ b/gpu/command_buffer/client/gles2_cmd_helper_autogen.h
@@ -2765,6 +2765,20 @@ void ScheduleCALayerSharedStateCHROMIUM(GLfloat opacity,
   }
 }
 
+void ScheduleCALayerFilterEffectsCHROMIUMImmediate(
+    GLsizei count,
+    const GLCALayerFilterEffect* effects) {
+  const uint32_t size =
+      gles2::cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate::ComputeSize(
+          count);
+  gles2::cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate* c =
+      GetImmediateCmdSpaceTotalSize<
+          gles2::cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate>(size);
+  if (c) {
+    c->Init(count, effects);
+  }
+}
+
 void ScheduleCALayerCHROMIUM(GLuint contents_texture_id,
                              GLuint background_color,
                              GLuint edge_aa_mask,
diff --git a/gpu/command_buffer/client/gles2_implementation.cc b/gpu/command_buffer/client/gles2_implementation.cc
index f80481c..61ffff9 100644
--- a/gpu/command_buffer/client/gles2_implementation.cc
+++ b/gpu/command_buffer/client/gles2_implementation.cc
@@ -6150,6 +6150,26 @@ GLuint GLES2Implementation::CreateGpuMemoryBufferImageCHROMIUM(
   return image_id;
 }
 
+void GLES2Implementation::ScheduleCALayerFilterEffectsCHROMIUM(
+      GLsizei count,
+      const GLCALayerFilterEffect* effects) {
+  GPU_CLIENT_SINGLE_THREAD_CHECK();
+  GPU_CLIENT_LOG("[" << GetLogPrefix()
+                     << "] ScheduleCALayerFilterEffectsCHROMIUM(" << count
+                     << ", " << static_cast<const void*>(effects) << ")");
+  GPU_CLIENT_LOG_CODE_BLOCK({
+    for (GLsizei i = 0; i < count; ++i) {
+      const GLCALayerFilterEffect& effect = effects[i];
+      GPU_CLIENT_LOG("  " << i << ": " << effect.type << " " << effect.amount
+                          << " " << effect.drop_shadow_offset_x << " "
+                          << effect.drop_shadow_offset_y << " "
+                          << effect.drop_shadow_color);
+    }
+  });
+  helper_->ScheduleCALayerFilterEffectsCHROMIUMImmediate(count, effects);
+  CheckGLError();
+}
+
 bool GLES2Implementation::ValidateSize(const char* func, GLsizeiptr size) {
   if (size < 0) {
     SetGLError(GL_INVALID_VALUE, func, "size < 0");
diff --git a/gpu/command_buffer/client/gles2_implementation_autogen.h b/gpu/command_buffer/client/gles2_implementation_autogen.h
index a51e669..201708d 100644
--- a/gpu/command_buffer/client/gles2_implementation_autogen.h
+++ b/gpu/command_buffer/client/gles2_implementation_autogen.h
@@ -1025,6 +1025,10 @@ void ScheduleCALayerSharedStateCHROMIUM(GLfloat opacity,
                                         GLint sorting_context_id,
                                         const GLfloat* transform) override;
 
+void ScheduleCALayerFilterEffectsCHROMIUM(
+    GLsizei count,
+    const GLCALayerFilterEffect* effects) override;
+
 void ScheduleCALayerCHROMIUM(GLuint contents_texture_id,
                              const GLfloat* contents_rect,
                              GLuint background_color,
diff --git a/gpu/command_buffer/client/gles2_implementation_unittest_autogen.h b/gpu/command_buffer/client/gles2_implementation_unittest_autogen.h
index 8507032..28f76b1 100644
--- a/gpu/command_buffer/client/gles2_implementation_unittest_autogen.h
+++ b/gpu/command_buffer/client/gles2_implementation_unittest_autogen.h
@@ -1138,42 +1138,6 @@ TEST_F(GLES2ImplementationTest, Hint) {
   EXPECT_EQ(0, memcmp(&expected, commands_, sizeof(expected)));
 }
 
-TEST_F(GLES2ImplementationTest, InvalidateFramebuffer) {
-  GLenum data[2][1] = {{0}};
-  struct Cmds {
-    cmds::InvalidateFramebufferImmediate cmd;
-    GLenum data[2][1];
-  };
-
-  Cmds expected;
-  for (int ii = 0; ii < 2; ++ii) {
-    for (int jj = 0; jj < 1; ++jj) {
-      data[ii][jj] = static_cast<GLenum>(ii * 1 + jj);
-    }
-  }
-  expected.cmd.Init(GL_FRAMEBUFFER, 2, &data[0][0]);
-  gl_->InvalidateFramebuffer(GL_FRAMEBUFFER, 2, &data[0][0]);
-  EXPECT_EQ(0, memcmp(&expected, commands_, sizeof(expected)));
-}
-
-TEST_F(GLES2ImplementationTest, InvalidateSubFramebuffer) {
-  GLenum data[2][1] = {{0}};
-  struct Cmds {
-    cmds::InvalidateSubFramebufferImmediate cmd;
-    GLenum data[2][1];
-  };
-
-  Cmds expected;
-  for (int ii = 0; ii < 2; ++ii) {
-    for (int jj = 0; jj < 1; ++jj) {
-      data[ii][jj] = static_cast<GLenum>(ii * 1 + jj);
-    }
-  }
-  expected.cmd.Init(GL_FRAMEBUFFER, 2, &data[0][0], 4, 5, 6, 7);
-  gl_->InvalidateSubFramebuffer(GL_FRAMEBUFFER, 2, &data[0][0], 4, 5, 6, 7);
-  EXPECT_EQ(0, memcmp(&expected, commands_, sizeof(expected)));
-}
-
 TEST_F(GLES2ImplementationTest, IsBuffer) {
   struct Cmds {
     cmds::IsBuffer cmd;
@@ -2778,24 +2742,6 @@ TEST_F(GLES2ImplementationTest, ReleaseTexImage2DCHROMIUM) {
   EXPECT_EQ(0, memcmp(&expected, commands_, sizeof(expected)));
 }
 
-TEST_F(GLES2ImplementationTest, DiscardFramebufferEXT) {
-  GLenum data[2][1] = {{0}};
-  struct Cmds {
-    cmds::DiscardFramebufferEXTImmediate cmd;
-    GLenum data[2][1];
-  };
-
-  Cmds expected;
-  for (int ii = 0; ii < 2; ++ii) {
-    for (int jj = 0; jj < 1; ++jj) {
-      data[ii][jj] = static_cast<GLenum>(ii * 1 + jj);
-    }
-  }
-  expected.cmd.Init(1, 2, &data[0][0]);
-  gl_->DiscardFramebufferEXT(1, 2, &data[0][0]);
-  EXPECT_EQ(0, memcmp(&expected, commands_, sizeof(expected)));
-}
-
 TEST_F(GLES2ImplementationTest, LoseContextCHROMIUM) {
   struct Cmds {
     cmds::LoseContextCHROMIUM cmd;
@@ -2808,24 +2754,6 @@ TEST_F(GLES2ImplementationTest, LoseContextCHROMIUM) {
   EXPECT_EQ(0, memcmp(&expected, commands_, sizeof(expected)));
 }
 
-TEST_F(GLES2ImplementationTest, DrawBuffersEXT) {
-  GLenum data[1][1] = {{0}};
-  struct Cmds {
-    cmds::DrawBuffersEXTImmediate cmd;
-    GLenum data[1][1];
-  };
-
-  Cmds expected;
-  for (int ii = 0; ii < 1; ++ii) {
-    for (int jj = 0; jj < 1; ++jj) {
-      data[ii][jj] = static_cast<GLenum>(ii * 1 + jj);
-    }
-  }
-  expected.cmd.Init(1, &data[0][0]);
-  gl_->DrawBuffersEXT(1, &data[0][0]);
-  EXPECT_EQ(0, memcmp(&expected, commands_, sizeof(expected)));
-}
-
 TEST_F(GLES2ImplementationTest, DiscardBackbufferCHROMIUM) {
   struct Cmds {
     cmds::DiscardBackbufferCHROMIUM cmd;
diff --git a/gpu/command_buffer/client/gles2_interface.h b/gpu/command_buffer/client/gles2_interface.h
index 0b0bc51..3385197 100644
--- a/gpu/command_buffer/client/gles2_interface.h
+++ b/gpu/command_buffer/client/gles2_interface.h
@@ -10,6 +10,7 @@
 #include "base/compiler_specific.h"
 
 extern "C" typedef struct _ClientBuffer* ClientBuffer;
+extern "C" struct GLCALayerFilterEffect;
 
 namespace gpu {
 namespace gles2 {
diff --git a/gpu/command_buffer/client/gles2_interface_autogen.h b/gpu/command_buffer/client/gles2_interface_autogen.h
index f3a835e..bf8a9c9 100644
--- a/gpu/command_buffer/client/gles2_interface_autogen.h
+++ b/gpu/command_buffer/client/gles2_interface_autogen.h
@@ -759,6 +759,9 @@ virtual void ScheduleCALayerSharedStateCHROMIUM(GLfloat opacity,
                                                 const GLfloat* clip_rect,
                                                 GLint sorting_context_id,
                                                 const GLfloat* transform) = 0;
+virtual void ScheduleCALayerFilterEffectsCHROMIUM(
+    GLsizei count,
+    const GLCALayerFilterEffect* effects) = 0;
 virtual void ScheduleCALayerCHROMIUM(GLuint contents_texture_id,
                                      const GLfloat* contents_rect,
                                      GLuint background_color,
diff --git a/gpu/command_buffer/client/gles2_interface_stub_autogen.h b/gpu/command_buffer/client/gles2_interface_stub_autogen.h
index f8121b3..6920b06 100644
--- a/gpu/command_buffer/client/gles2_interface_stub_autogen.h
+++ b/gpu/command_buffer/client/gles2_interface_stub_autogen.h
@@ -737,6 +737,9 @@ void ScheduleCALayerSharedStateCHROMIUM(GLfloat opacity,
                                         const GLfloat* clip_rect,
                                         GLint sorting_context_id,
                                         const GLfloat* transform) override;
+void ScheduleCALayerFilterEffectsCHROMIUM(
+    GLsizei count,
+    const GLCALayerFilterEffect* effects) override;
 void ScheduleCALayerCHROMIUM(GLuint contents_texture_id,
                              const GLfloat* contents_rect,
                              GLuint background_color,
diff --git a/gpu/command_buffer/client/gles2_interface_stub_impl_autogen.h b/gpu/command_buffer/client/gles2_interface_stub_impl_autogen.h
index ff8b9b0..4f5c82d 100644
--- a/gpu/command_buffer/client/gles2_interface_stub_impl_autogen.h
+++ b/gpu/command_buffer/client/gles2_interface_stub_impl_autogen.h
@@ -1007,6 +1007,9 @@ void GLES2InterfaceStub::ScheduleCALayerSharedStateCHROMIUM(
     const GLfloat* /* clip_rect */,
     GLint /* sorting_context_id */,
     const GLfloat* /* transform */) {}
+void GLES2InterfaceStub::ScheduleCALayerFilterEffectsCHROMIUM(
+    GLsizei /* count */,
+    const GLCALayerFilterEffect* /* effects */) {}
 void GLES2InterfaceStub::ScheduleCALayerCHROMIUM(
     GLuint /* contents_texture_id */,
     const GLfloat* /* contents_rect */,
diff --git a/gpu/command_buffer/client/gles2_trace_implementation_autogen.h b/gpu/command_buffer/client/gles2_trace_implementation_autogen.h
index 2f733c7..3261075 100644
--- a/gpu/command_buffer/client/gles2_trace_implementation_autogen.h
+++ b/gpu/command_buffer/client/gles2_trace_implementation_autogen.h
@@ -737,6 +737,9 @@ void ScheduleCALayerSharedStateCHROMIUM(GLfloat opacity,
                                         const GLfloat* clip_rect,
                                         GLint sorting_context_id,
                                         const GLfloat* transform) override;
+void ScheduleCALayerFilterEffectsCHROMIUM(
+    GLsizei count,
+    const GLCALayerFilterEffect* effects) override;
 void ScheduleCALayerCHROMIUM(GLuint contents_texture_id,
                              const GLfloat* contents_rect,
                              GLuint background_color,
diff --git a/gpu/command_buffer/client/gles2_trace_implementation_impl_autogen.h b/gpu/command_buffer/client/gles2_trace_implementation_impl_autogen.h
index 7c06622..30f6556 100644
--- a/gpu/command_buffer/client/gles2_trace_implementation_impl_autogen.h
+++ b/gpu/command_buffer/client/gles2_trace_implementation_impl_autogen.h
@@ -2154,6 +2154,14 @@ void GLES2TraceImplementation::ScheduleCALayerSharedStateCHROMIUM(
                                           sorting_context_id, transform);
 }
 
+void GLES2TraceImplementation::ScheduleCALayerFilterEffectsCHROMIUM(
+    GLsizei count,
+    const GLCALayerFilterEffect* effects) {
+  TRACE_EVENT_BINARY_EFFICIENT0(
+      "gpu", "GLES2Trace::ScheduleCALayerFilterEffectsCHROMIUM");
+  gl_->ScheduleCALayerFilterEffectsCHROMIUM(count, effects);
+}
+
 void GLES2TraceImplementation::ScheduleCALayerCHROMIUM(
     GLuint contents_texture_id,
     const GLfloat* contents_rect,
diff --git a/gpu/command_buffer/cmd_buffer_functions.txt b/gpu/command_buffer/cmd_buffer_functions.txt
index 3b63480..d253800 100644
--- a/gpu/command_buffer/cmd_buffer_functions.txt
+++ b/gpu/command_buffer/cmd_buffer_functions.txt
@@ -306,6 +306,7 @@ GL_APICALL void         GL_APIENTRY glDrawBuffersEXT (GLsizei count, const GLenu
 GL_APICALL void         GL_APIENTRY glDiscardBackbufferCHROMIUM (void);
 GL_APICALL void         GL_APIENTRY glScheduleOverlayPlaneCHROMIUM (GLint plane_z_order, GLenum plane_transform, GLuint overlay_texture_id, GLint bounds_x, GLint bounds_y, GLint bounds_width, GLint bounds_height, GLfloat uv_x, GLfloat uv_y, GLfloat uv_width, GLfloat uv_height);
 GL_APICALL void         GL_APIENTRY glScheduleCALayerSharedStateCHROMIUM (GLfloat opacity, GLboolean is_clipped, const GLfloat* clip_rect, GLint sorting_context_id, const GLfloat* transform);
+GL_APICALL void         GL_APIENTRY glScheduleCALayerFilterEffectsCHROMIUM (GLsizei count, const GLCALayerFilterEffect* effects);
 GL_APICALL void         GL_APIENTRY glScheduleCALayerCHROMIUM (GLuint contents_texture_id, const GLfloat* contents_rect, GLuint background_color, GLuint edge_aa_mask, const GLfloat* bounds_rect, GLuint filter);
 GL_APICALL void         GL_APIENTRY glScheduleCALayerInUseQueryCHROMIUM (GLsizei count, const GLuint* textures);
 GL_APICALL void         GL_APIENTRY glCommitOverlayPlanesCHROMIUM (void);
diff --git a/gpu/command_buffer/common/gles2_cmd_format.h b/gpu/command_buffer/common/gles2_cmd_format.h
index 1ac1d89..f8b8f5c 100644
--- a/gpu/command_buffer/common/gles2_cmd_format.h
+++ b/gpu/command_buffer/common/gles2_cmd_format.h
@@ -48,6 +48,14 @@ typedef struct __GLsync *GLsync;
 typedef int64_t GLint64;
 typedef uint64_t GLuint64;
 
+struct GLCALayerFilterEffect {
+  GLint type;
+  GLfloat amount;
+  GLint drop_shadow_offset_x;
+  GLint drop_shadow_offset_y;
+  GLuint drop_shadow_color;
+};
+
 namespace gpu {
 namespace gles2 {
 
diff --git a/gpu/command_buffer/common/gles2_cmd_format_autogen.h b/gpu/command_buffer/common/gles2_cmd_format_autogen.h
index fba8b00..d17adc6 100644
--- a/gpu/command_buffer/common/gles2_cmd_format_autogen.h
+++ b/gpu/command_buffer/common/gles2_cmd_format_autogen.h
@@ -13628,6 +13628,55 @@ static_assert(
     offsetof(ScheduleCALayerSharedStateCHROMIUM, shm_offset) == 20,
     "offset of ScheduleCALayerSharedStateCHROMIUM shm_offset should be 20");
 
+struct ScheduleCALayerFilterEffectsCHROMIUMImmediate {
+  typedef ScheduleCALayerFilterEffectsCHROMIUMImmediate ValueType;
+  static const CommandId kCmdId =
+      kScheduleCALayerFilterEffectsCHROMIUMImmediate;
+  static const cmd::ArgFlags kArgFlags = cmd::kAtLeastN;
+  static const uint8_t cmd_flags = CMD_FLAG_SET_TRACE_LEVEL(3);
+
+  static uint32_t ComputeDataSize(GLsizei count) {
+    return static_cast<uint32_t>(sizeof(GLCALayerFilterEffect) * 1 *
+                                 count);  // NOLINT
+  }
+
+  static uint32_t ComputeSize(GLsizei count) {
+    return static_cast<uint32_t>(sizeof(ValueType) +
+                                 ComputeDataSize(count));  // NOLINT
+  }
+
+  void SetHeader(GLsizei count) {
+    header.SetCmdByTotalSize<ValueType>(ComputeSize(count));
+  }
+
+  void Init(GLsizei _count, const GLCALayerFilterEffect* _effects) {
+    SetHeader(_count);
+    count = _count;
+    memcpy(ImmediateDataAddress(this), _effects, ComputeDataSize(_count));
+  }
+
+  void* Set(void* cmd, GLsizei _count, const GLCALayerFilterEffect* _effects) {
+    static_cast<ValueType*>(cmd)->Init(_count, _effects);
+    const uint32_t size = ComputeSize(_count);
+    return NextImmediateCmdAddressTotalSize<ValueType>(cmd, size);
+  }
+
+  gpu::CommandHeader header;
+  int32_t count;
+};
+
+static_assert(
+    sizeof(ScheduleCALayerFilterEffectsCHROMIUMImmediate) == 8,
+    "size of ScheduleCALayerFilterEffectsCHROMIUMImmediate should be 8");
+static_assert(offsetof(ScheduleCALayerFilterEffectsCHROMIUMImmediate, header) ==
+                  0,
+              "offset of ScheduleCALayerFilterEffectsCHROMIUMImmediate header "
+              "should be 0");
+static_assert(offsetof(ScheduleCALayerFilterEffectsCHROMIUMImmediate, count) ==
+                  4,
+              "offset of ScheduleCALayerFilterEffectsCHROMIUMImmediate count "
+              "should be 4");
+
 struct ScheduleCALayerCHROMIUM {
   typedef ScheduleCALayerCHROMIUM ValueType;
   static const CommandId kCmdId = kScheduleCALayerCHROMIUM;
diff --git a/gpu/command_buffer/common/gles2_cmd_format_test_autogen.h b/gpu/command_buffer/common/gles2_cmd_format_test_autogen.h
index b2c1671..ba08803 100644
--- a/gpu/command_buffer/common/gles2_cmd_format_test_autogen.h
+++ b/gpu/command_buffer/common/gles2_cmd_format_test_autogen.h
@@ -1849,39 +1849,38 @@ TEST_F(GLES2FormatTest, Hint) {
 
 TEST_F(GLES2FormatTest, InvalidateFramebufferImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLenum data[] = {
-      static_cast<GLenum>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLenum>(kSomeBaseValueToTestWith + 1),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLenum> vec;
+  vec.resize(kNumElements * 1);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLenum) * vec.size());
   cmds::InvalidateFramebufferImmediate& cmd =
       *GetBufferAs<cmds::InvalidateFramebufferImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLenum) * 1;
-  void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLenum>(1), static_cast<GLsizei>(2), data);
+  void* next_cmd = cmd.Set(&cmd, static_cast<GLenum>(1),
+                           static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::InvalidateFramebufferImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLenum>(1), cmd.target);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLenum) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, InvalidateSubFramebufferImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLenum data[] = {
-      static_cast<GLenum>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLenum>(kSomeBaseValueToTestWith + 1),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLenum> vec;
+  vec.resize(kNumElements * 1);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLenum) * vec.size());
   cmds::InvalidateSubFramebufferImmediate& cmd =
       *GetBufferAs<cmds::InvalidateSubFramebufferImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLenum) * 1;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLenum>(1), static_cast<GLsizei>(2), data,
+      cmd.Set(&cmd, static_cast<GLenum>(1), static_cast<GLsizei>(2), vec.data(),
               static_cast<GLint>(4), static_cast<GLint>(5),
               static_cast<GLsizei>(6), static_cast<GLsizei>(7));
   EXPECT_EQ(
@@ -1895,7 +1894,8 @@ TEST_F(GLES2FormatTest, InvalidateSubFramebufferImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(6), cmd.width);
   EXPECT_EQ(static_cast<GLsizei>(7), cmd.height);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLenum) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, IsBuffer) {
@@ -2561,23 +2561,23 @@ TEST_F(GLES2FormatTest, Uniform1f) {
 
 TEST_F(GLES2FormatTest, Uniform1fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-  };
-  cmds::Uniform1fvImmediate& cmd = *GetBufferAs<cmds::Uniform1fvImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 1);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
+  cmds::Uniform1fvImmediate& cmd = *GetBufferAs<cmds::Uniform1fvImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 1;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform1fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform1i) {
@@ -2593,23 +2593,23 @@ TEST_F(GLES2FormatTest, Uniform1i) {
 
 TEST_F(GLES2FormatTest, Uniform1ivImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLint data[] = {
-      static_cast<GLint>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 1),
-  };
-  cmds::Uniform1ivImmediate& cmd = *GetBufferAs<cmds::Uniform1ivImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLint> vec;
+  vec.resize(kNumElements * 1);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLint) * vec.size());
+  cmds::Uniform1ivImmediate& cmd = *GetBufferAs<cmds::Uniform1ivImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLint) * 1;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform1ivImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLint) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform1ui) {
@@ -2626,23 +2626,23 @@ TEST_F(GLES2FormatTest, Uniform1ui) {
 
 TEST_F(GLES2FormatTest, Uniform1uivImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLuint data[] = {
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 1),
-  };
-  cmds::Uniform1uivImmediate& cmd = *GetBufferAs<cmds::Uniform1uivImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLuint> vec;
+  vec.resize(kNumElements * 1);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLuint) * vec.size());
+  cmds::Uniform1uivImmediate& cmd = *GetBufferAs<cmds::Uniform1uivImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLuint) * 1;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform1uivImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLuint) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform2f) {
@@ -2659,25 +2659,23 @@ TEST_F(GLES2FormatTest, Uniform2f) {
 
 TEST_F(GLES2FormatTest, Uniform2fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-  };
-  cmds::Uniform2fvImmediate& cmd = *GetBufferAs<cmds::Uniform2fvImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 2);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
+  cmds::Uniform2fvImmediate& cmd = *GetBufferAs<cmds::Uniform2fvImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 2;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform2fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform2i) {
@@ -2694,25 +2692,23 @@ TEST_F(GLES2FormatTest, Uniform2i) {
 
 TEST_F(GLES2FormatTest, Uniform2ivImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLint data[] = {
-      static_cast<GLint>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 3),
-  };
-  cmds::Uniform2ivImmediate& cmd = *GetBufferAs<cmds::Uniform2ivImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLint> vec;
+  vec.resize(kNumElements * 2);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLint) * vec.size());
+  cmds::Uniform2ivImmediate& cmd = *GetBufferAs<cmds::Uniform2ivImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLint) * 2;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform2ivImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLint) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform2ui) {
@@ -2730,25 +2726,23 @@ TEST_F(GLES2FormatTest, Uniform2ui) {
 
 TEST_F(GLES2FormatTest, Uniform2uivImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLuint data[] = {
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 3),
-  };
-  cmds::Uniform2uivImmediate& cmd = *GetBufferAs<cmds::Uniform2uivImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLuint> vec;
+  vec.resize(kNumElements * 2);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLuint) * vec.size());
+  cmds::Uniform2uivImmediate& cmd = *GetBufferAs<cmds::Uniform2uivImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLuint) * 2;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform2uivImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLuint) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform3f) {
@@ -2767,27 +2761,23 @@ TEST_F(GLES2FormatTest, Uniform3f) {
 
 TEST_F(GLES2FormatTest, Uniform3fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-  };
-  cmds::Uniform3fvImmediate& cmd = *GetBufferAs<cmds::Uniform3fvImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 3);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
+  cmds::Uniform3fvImmediate& cmd = *GetBufferAs<cmds::Uniform3fvImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 3;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform3fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform3i) {
@@ -2805,27 +2795,23 @@ TEST_F(GLES2FormatTest, Uniform3i) {
 
 TEST_F(GLES2FormatTest, Uniform3ivImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLint data[] = {
-      static_cast<GLint>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 5),
-  };
-  cmds::Uniform3ivImmediate& cmd = *GetBufferAs<cmds::Uniform3ivImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLint> vec;
+  vec.resize(kNumElements * 3);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLint) * vec.size());
+  cmds::Uniform3ivImmediate& cmd = *GetBufferAs<cmds::Uniform3ivImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLint) * 3;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform3ivImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLint) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform3ui) {
@@ -2845,27 +2831,23 @@ TEST_F(GLES2FormatTest, Uniform3ui) {
 
 TEST_F(GLES2FormatTest, Uniform3uivImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLuint data[] = {
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 5),
-  };
-  cmds::Uniform3uivImmediate& cmd = *GetBufferAs<cmds::Uniform3uivImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLuint> vec;
+  vec.resize(kNumElements * 3);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLuint) * vec.size());
+  cmds::Uniform3uivImmediate& cmd = *GetBufferAs<cmds::Uniform3uivImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLuint) * 3;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform3uivImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLuint) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform4f) {
@@ -2885,29 +2867,23 @@ TEST_F(GLES2FormatTest, Uniform4f) {
 
 TEST_F(GLES2FormatTest, Uniform4fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-  };
-  cmds::Uniform4fvImmediate& cmd = *GetBufferAs<cmds::Uniform4fvImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 4);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
+  cmds::Uniform4fvImmediate& cmd = *GetBufferAs<cmds::Uniform4fvImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 4;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform4fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform4i) {
@@ -2927,29 +2903,23 @@ TEST_F(GLES2FormatTest, Uniform4i) {
 
 TEST_F(GLES2FormatTest, Uniform4ivImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLint data[] = {
-      static_cast<GLint>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLint>(kSomeBaseValueToTestWith + 7),
-  };
-  cmds::Uniform4ivImmediate& cmd = *GetBufferAs<cmds::Uniform4ivImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLint> vec;
+  vec.resize(kNumElements * 4);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLint) * vec.size());
+  cmds::Uniform4ivImmediate& cmd = *GetBufferAs<cmds::Uniform4ivImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLint) * 4;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform4ivImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLint) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, Uniform4ui) {
@@ -2970,29 +2940,23 @@ TEST_F(GLES2FormatTest, Uniform4ui) {
 
 TEST_F(GLES2FormatTest, Uniform4uivImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLuint data[] = {
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 7),
-  };
-  cmds::Uniform4uivImmediate& cmd = *GetBufferAs<cmds::Uniform4uivImmediate>();
   const GLsizei kNumElements = 2;
+  std::vector<GLuint> vec;
+  vec.resize(kNumElements * 4);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLuint) * vec.size());
+  cmds::Uniform4uivImmediate& cmd = *GetBufferAs<cmds::Uniform4uivImmediate>();
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLuint) * 4;
   void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), data);
+      cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::Uniform4uivImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLint>(1), cmd.location);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLuint) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UniformBlockBinding) {
@@ -3010,23 +2974,16 @@ TEST_F(GLES2FormatTest, UniformBlockBinding) {
 
 TEST_F(GLES2FormatTest, UniformMatrix2fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 4);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
   cmds::UniformMatrix2fvImmediate& cmd =
       *GetBufferAs<cmds::UniformMatrix2fvImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 4;
   void* next_cmd = cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2),
-                           static_cast<GLboolean>(3), data);
+                           static_cast<GLboolean>(3), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::UniformMatrix2fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
@@ -3034,32 +2991,22 @@ TEST_F(GLES2FormatTest, UniformMatrix2fvImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   EXPECT_EQ(static_cast<GLboolean>(3), cmd.transpose);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UniformMatrix2x3fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 8),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 9),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 10),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 11),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 6);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
   cmds::UniformMatrix2x3fvImmediate& cmd =
       *GetBufferAs<cmds::UniformMatrix2x3fvImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 6;
   void* next_cmd = cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2),
-                           static_cast<GLboolean>(3), data);
+                           static_cast<GLboolean>(3), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::UniformMatrix2x3fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
@@ -3067,36 +3014,22 @@ TEST_F(GLES2FormatTest, UniformMatrix2x3fvImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   EXPECT_EQ(static_cast<GLboolean>(3), cmd.transpose);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UniformMatrix2x4fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 8),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 9),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 10),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 11),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 12),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 13),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 14),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 15),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 8);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
   cmds::UniformMatrix2x4fvImmediate& cmd =
       *GetBufferAs<cmds::UniformMatrix2x4fvImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 8;
   void* next_cmd = cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2),
-                           static_cast<GLboolean>(3), data);
+                           static_cast<GLboolean>(3), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::UniformMatrix2x4fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
@@ -3104,38 +3037,22 @@ TEST_F(GLES2FormatTest, UniformMatrix2x4fvImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   EXPECT_EQ(static_cast<GLboolean>(3), cmd.transpose);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UniformMatrix3fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 8),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 9),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 10),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 11),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 12),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 13),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 14),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 15),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 16),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 17),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 9);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
   cmds::UniformMatrix3fvImmediate& cmd =
       *GetBufferAs<cmds::UniformMatrix3fvImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 9;
   void* next_cmd = cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2),
-                           static_cast<GLboolean>(3), data);
+                           static_cast<GLboolean>(3), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::UniformMatrix3fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
@@ -3143,32 +3060,22 @@ TEST_F(GLES2FormatTest, UniformMatrix3fvImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   EXPECT_EQ(static_cast<GLboolean>(3), cmd.transpose);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UniformMatrix3x2fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 8),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 9),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 10),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 11),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 6);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
   cmds::UniformMatrix3x2fvImmediate& cmd =
       *GetBufferAs<cmds::UniformMatrix3x2fvImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 6;
   void* next_cmd = cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2),
-                           static_cast<GLboolean>(3), data);
+                           static_cast<GLboolean>(3), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::UniformMatrix3x2fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
@@ -3176,44 +3083,22 @@ TEST_F(GLES2FormatTest, UniformMatrix3x2fvImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   EXPECT_EQ(static_cast<GLboolean>(3), cmd.transpose);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UniformMatrix3x4fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 8),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 9),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 10),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 11),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 12),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 13),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 14),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 15),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 16),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 17),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 18),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 19),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 20),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 21),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 22),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 23),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 12);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
   cmds::UniformMatrix3x4fvImmediate& cmd =
       *GetBufferAs<cmds::UniformMatrix3x4fvImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 12;
   void* next_cmd = cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2),
-                           static_cast<GLboolean>(3), data);
+                           static_cast<GLboolean>(3), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::UniformMatrix3x4fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
@@ -3221,52 +3106,22 @@ TEST_F(GLES2FormatTest, UniformMatrix3x4fvImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   EXPECT_EQ(static_cast<GLboolean>(3), cmd.transpose);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UniformMatrix4fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 8),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 9),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 10),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 11),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 12),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 13),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 14),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 15),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 16),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 17),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 18),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 19),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 20),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 21),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 22),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 23),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 24),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 25),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 26),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 27),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 28),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 29),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 30),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 31),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 16);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
   cmds::UniformMatrix4fvImmediate& cmd =
       *GetBufferAs<cmds::UniformMatrix4fvImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 16;
   void* next_cmd = cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2),
-                           static_cast<GLboolean>(3), data);
+                           static_cast<GLboolean>(3), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::UniformMatrix4fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
@@ -3274,36 +3129,22 @@ TEST_F(GLES2FormatTest, UniformMatrix4fvImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   EXPECT_EQ(static_cast<GLboolean>(3), cmd.transpose);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UniformMatrix4x2fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 8),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 9),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 10),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 11),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 12),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 13),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 14),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 15),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 8);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
   cmds::UniformMatrix4x2fvImmediate& cmd =
       *GetBufferAs<cmds::UniformMatrix4x2fvImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 8;
   void* next_cmd = cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2),
-                           static_cast<GLboolean>(3), data);
+                           static_cast<GLboolean>(3), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::UniformMatrix4x2fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
@@ -3311,44 +3152,22 @@ TEST_F(GLES2FormatTest, UniformMatrix4x2fvImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   EXPECT_EQ(static_cast<GLboolean>(3), cmd.transpose);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UniformMatrix4x3fvImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLfloat data[] = {
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 1),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 2),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 3),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 4),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 5),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 6),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 7),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 8),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 9),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 10),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 11),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 12),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 13),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 14),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 15),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 16),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 17),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 18),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 19),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 20),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 21),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 22),
-      static_cast<GLfloat>(kSomeBaseValueToTestWith + 23),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLfloat> vec;
+  vec.resize(kNumElements * 12);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLfloat) * vec.size());
   cmds::UniformMatrix4x3fvImmediate& cmd =
       *GetBufferAs<cmds::UniformMatrix4x3fvImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLfloat) * 12;
   void* next_cmd = cmd.Set(&cmd, static_cast<GLint>(1), static_cast<GLsizei>(2),
-                           static_cast<GLboolean>(3), data);
+                           static_cast<GLboolean>(3), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::UniformMatrix4x3fvImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
@@ -3356,7 +3175,8 @@ TEST_F(GLES2FormatTest, UniformMatrix4x3fvImmediate) {
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   EXPECT_EQ(static_cast<GLboolean>(3), cmd.transpose);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLfloat) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, UseProgram) {
@@ -4556,24 +4376,24 @@ TEST_F(GLES2FormatTest, TraceEndCHROMIUM) {
 
 TEST_F(GLES2FormatTest, DiscardFramebufferEXTImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLenum data[] = {
-      static_cast<GLenum>(kSomeBaseValueToTestWith + 0),
-      static_cast<GLenum>(kSomeBaseValueToTestWith + 1),
-  };
+  const GLsizei kNumElements = 2;
+  std::vector<GLenum> vec;
+  vec.resize(kNumElements * 1);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLenum) * vec.size());
   cmds::DiscardFramebufferEXTImmediate& cmd =
       *GetBufferAs<cmds::DiscardFramebufferEXTImmediate>();
-  const GLsizei kNumElements = 2;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLenum) * 1;
-  void* next_cmd =
-      cmd.Set(&cmd, static_cast<GLenum>(1), static_cast<GLsizei>(2), data);
+  void* next_cmd = cmd.Set(&cmd, static_cast<GLenum>(1),
+                           static_cast<GLsizei>(2), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::DiscardFramebufferEXTImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLenum>(1), cmd.target);
   EXPECT_EQ(static_cast<GLsizei>(2), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLenum) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, LoseContextCHROMIUM) {
@@ -4616,21 +4436,22 @@ TEST_F(GLES2FormatTest, WaitSyncTokenCHROMIUM) {
 
 TEST_F(GLES2FormatTest, DrawBuffersEXTImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLenum data[] = {
-      static_cast<GLenum>(kSomeBaseValueToTestWith + 0),
-  };
+  const GLsizei kNumElements = 1;
+  std::vector<GLenum> vec;
+  vec.resize(kNumElements * 1);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLenum) * vec.size());
   cmds::DrawBuffersEXTImmediate& cmd =
       *GetBufferAs<cmds::DrawBuffersEXTImmediate>();
-  const GLsizei kNumElements = 1;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLenum) * 1;
-  void* next_cmd = cmd.Set(&cmd, static_cast<GLsizei>(1), data);
+  void* next_cmd = cmd.Set(&cmd, static_cast<GLsizei>(1), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(cmds::DrawBuffersEXTImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLsizei>(1), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLenum) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, DiscardBackbufferCHROMIUM) {
@@ -4687,6 +4508,28 @@ TEST_F(GLES2FormatTest, ScheduleCALayerSharedStateCHROMIUM) {
   CheckBytesWrittenMatchesExpectedSize(next_cmd, sizeof(cmd));
 }
 
+TEST_F(GLES2FormatTest, ScheduleCALayerFilterEffectsCHROMIUMImmediate) {
+  const int kSomeBaseValueToTestWith = 51;
+  const GLsizei kNumElements = 1;
+  std::vector<GLCALayerFilterEffect> vec;
+  vec.resize(kNumElements * 1);
+  memset(vec.data(), kSomeBaseValueToTestWith,
+         sizeof(GLCALayerFilterEffect) * vec.size());
+  cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate& cmd =
+      *GetBufferAs<cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate>();
+  const size_t kExpectedCmdSize =
+      sizeof(cmd) + kNumElements * sizeof(GLCALayerFilterEffect) * 1;
+  void* next_cmd = cmd.Set(&cmd, static_cast<GLsizei>(1), vec.data());
+  EXPECT_EQ(static_cast<uint32_t>(
+                cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate::kCmdId),
+            cmd.header.command);
+  EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
+  EXPECT_EQ(static_cast<GLsizei>(1), cmd.count);
+  CheckBytesWrittenMatchesExpectedSize(
+      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(
+                                  sizeof(GLCALayerFilterEffect) * vec.size()));
+}
+
 TEST_F(GLES2FormatTest, ScheduleCALayerCHROMIUM) {
   cmds::ScheduleCALayerCHROMIUM& cmd =
       *GetBufferAs<cmds::ScheduleCALayerCHROMIUM>();
@@ -4708,22 +4551,23 @@ TEST_F(GLES2FormatTest, ScheduleCALayerCHROMIUM) {
 
 TEST_F(GLES2FormatTest, ScheduleCALayerInUseQueryCHROMIUMImmediate) {
   const int kSomeBaseValueToTestWith = 51;
-  static GLuint data[] = {
-      static_cast<GLuint>(kSomeBaseValueToTestWith + 0),
-  };
+  const GLsizei kNumElements = 1;
+  std::vector<GLuint> vec;
+  vec.resize(kNumElements * 1);
+  memset(vec.data(), kSomeBaseValueToTestWith, sizeof(GLuint) * vec.size());
   cmds::ScheduleCALayerInUseQueryCHROMIUMImmediate& cmd =
       *GetBufferAs<cmds::ScheduleCALayerInUseQueryCHROMIUMImmediate>();
-  const GLsizei kNumElements = 1;
   const size_t kExpectedCmdSize =
       sizeof(cmd) + kNumElements * sizeof(GLuint) * 1;
-  void* next_cmd = cmd.Set(&cmd, static_cast<GLsizei>(1), data);
+  void* next_cmd = cmd.Set(&cmd, static_cast<GLsizei>(1), vec.data());
   EXPECT_EQ(static_cast<uint32_t>(
                 cmds::ScheduleCALayerInUseQueryCHROMIUMImmediate::kCmdId),
             cmd.header.command);
   EXPECT_EQ(kExpectedCmdSize, cmd.header.size * 4u);
   EXPECT_EQ(static_cast<GLsizei>(1), cmd.count);
   CheckBytesWrittenMatchesExpectedSize(
-      next_cmd, sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(data)));
+      next_cmd,
+      sizeof(cmd) + RoundSizeToMultipleOfEntries(sizeof(GLuint) * vec.size()));
 }
 
 TEST_F(GLES2FormatTest, CommitOverlayPlanesCHROMIUM) {
diff --git a/gpu/command_buffer/common/gles2_cmd_ids_autogen.h b/gpu/command_buffer/common/gles2_cmd_ids_autogen.h
index f7e554d..995c103 100644
--- a/gpu/command_buffer/common/gles2_cmd_ids_autogen.h
+++ b/gpu/command_buffer/common/gles2_cmd_ids_autogen.h
@@ -295,41 +295,42 @@
   OP(DiscardBackbufferCHROMIUM)                            /* 536 */ \
   OP(ScheduleOverlayPlaneCHROMIUM)                         /* 537 */ \
   OP(ScheduleCALayerSharedStateCHROMIUM)                   /* 538 */ \
-  OP(ScheduleCALayerCHROMIUM)                              /* 539 */ \
-  OP(ScheduleCALayerInUseQueryCHROMIUMImmediate)           /* 540 */ \
-  OP(CommitOverlayPlanesCHROMIUM)                          /* 541 */ \
-  OP(SwapInterval)                                         /* 542 */ \
-  OP(FlushDriverCachesCHROMIUM)                            /* 543 */ \
-  OP(MatrixLoadfCHROMIUMImmediate)                         /* 544 */ \
-  OP(MatrixLoadIdentityCHROMIUM)                           /* 545 */ \
-  OP(GenPathsCHROMIUM)                                     /* 546 */ \
-  OP(DeletePathsCHROMIUM)                                  /* 547 */ \
-  OP(IsPathCHROMIUM)                                       /* 548 */ \
-  OP(PathCommandsCHROMIUM)                                 /* 549 */ \
-  OP(PathParameterfCHROMIUM)                               /* 550 */ \
-  OP(PathParameteriCHROMIUM)                               /* 551 */ \
-  OP(PathStencilFuncCHROMIUM)                              /* 552 */ \
-  OP(StencilFillPathCHROMIUM)                              /* 553 */ \
-  OP(StencilStrokePathCHROMIUM)                            /* 554 */ \
-  OP(CoverFillPathCHROMIUM)                                /* 555 */ \
-  OP(CoverStrokePathCHROMIUM)                              /* 556 */ \
-  OP(StencilThenCoverFillPathCHROMIUM)                     /* 557 */ \
-  OP(StencilThenCoverStrokePathCHROMIUM)                   /* 558 */ \
-  OP(StencilFillPathInstancedCHROMIUM)                     /* 559 */ \
-  OP(StencilStrokePathInstancedCHROMIUM)                   /* 560 */ \
-  OP(CoverFillPathInstancedCHROMIUM)                       /* 561 */ \
-  OP(CoverStrokePathInstancedCHROMIUM)                     /* 562 */ \
-  OP(StencilThenCoverFillPathInstancedCHROMIUM)            /* 563 */ \
-  OP(StencilThenCoverStrokePathInstancedCHROMIUM)          /* 564 */ \
-  OP(BindFragmentInputLocationCHROMIUMBucket)              /* 565 */ \
-  OP(ProgramPathFragmentInputGenCHROMIUM)                  /* 566 */ \
-  OP(CoverageModulationCHROMIUM)                           /* 567 */ \
-  OP(BlendBarrierKHR)                                      /* 568 */ \
-  OP(ApplyScreenSpaceAntialiasingCHROMIUM)                 /* 569 */ \
-  OP(BindFragDataLocationIndexedEXTBucket)                 /* 570 */ \
-  OP(BindFragDataLocationEXTBucket)                        /* 571 */ \
-  OP(GetFragDataIndexEXT)                                  /* 572 */ \
-  OP(UniformMatrix4fvStreamTextureMatrixCHROMIUMImmediate) /* 573 */
+  OP(ScheduleCALayerFilterEffectsCHROMIUMImmediate)        /* 539 */ \
+  OP(ScheduleCALayerCHROMIUM)                              /* 540 */ \
+  OP(ScheduleCALayerInUseQueryCHROMIUMImmediate)           /* 541 */ \
+  OP(CommitOverlayPlanesCHROMIUM)                          /* 542 */ \
+  OP(SwapInterval)                                         /* 543 */ \
+  OP(FlushDriverCachesCHROMIUM)                            /* 544 */ \
+  OP(MatrixLoadfCHROMIUMImmediate)                         /* 545 */ \
+  OP(MatrixLoadIdentityCHROMIUM)                           /* 546 */ \
+  OP(GenPathsCHROMIUM)                                     /* 547 */ \
+  OP(DeletePathsCHROMIUM)                                  /* 548 */ \
+  OP(IsPathCHROMIUM)                                       /* 549 */ \
+  OP(PathCommandsCHROMIUM)                                 /* 550 */ \
+  OP(PathParameterfCHROMIUM)                               /* 551 */ \
+  OP(PathParameteriCHROMIUM)                               /* 552 */ \
+  OP(PathStencilFuncCHROMIUM)                              /* 553 */ \
+  OP(StencilFillPathCHROMIUM)                              /* 554 */ \
+  OP(StencilStrokePathCHROMIUM)                            /* 555 */ \
+  OP(CoverFillPathCHROMIUM)                                /* 556 */ \
+  OP(CoverStrokePathCHROMIUM)                              /* 557 */ \
+  OP(StencilThenCoverFillPathCHROMIUM)                     /* 558 */ \
+  OP(StencilThenCoverStrokePathCHROMIUM)                   /* 559 */ \
+  OP(StencilFillPathInstancedCHROMIUM)                     /* 560 */ \
+  OP(StencilStrokePathInstancedCHROMIUM)                   /* 561 */ \
+  OP(CoverFillPathInstancedCHROMIUM)                       /* 562 */ \
+  OP(CoverStrokePathInstancedCHROMIUM)                     /* 563 */ \
+  OP(StencilThenCoverFillPathInstancedCHROMIUM)            /* 564 */ \
+  OP(StencilThenCoverStrokePathInstancedCHROMIUM)          /* 565 */ \
+  OP(BindFragmentInputLocationCHROMIUMBucket)              /* 566 */ \
+  OP(ProgramPathFragmentInputGenCHROMIUM)                  /* 567 */ \
+  OP(CoverageModulationCHROMIUM)                           /* 568 */ \
+  OP(BlendBarrierKHR)                                      /* 569 */ \
+  OP(ApplyScreenSpaceAntialiasingCHROMIUM)                 /* 570 */ \
+  OP(BindFragDataLocationIndexedEXTBucket)                 /* 571 */ \
+  OP(BindFragDataLocationEXTBucket)                        /* 572 */ \
+  OP(GetFragDataIndexEXT)                                  /* 573 */ \
+  OP(UniformMatrix4fvStreamTextureMatrixCHROMIUMImmediate) /* 574 */
 
 enum CommandId {
   kOneBeforeStartPoint =
diff --git a/gpu/command_buffer/service/gles2_cmd_decoder.cc b/gpu/command_buffer/service/gles2_cmd_decoder.cc
index ceabff8..179c600 100644
--- a/gpu/command_buffer/service/gles2_cmd_decoder.cc
+++ b/gpu/command_buffer/service/gles2_cmd_decoder.cc
@@ -1070,7 +1070,6 @@ class GLES2DecoderImpl : public GLES2Decoder, public ErrorStateClient {
   void DoProduceTextureDirectCHROMIUM(GLuint texture, GLenum target,
       const GLbyte* key);
   void ProduceTextureRef(const char* func_name,
-                         bool clear,
                          TextureRef* texture_ref,
                          GLenum target,
                          const GLbyte* data);
@@ -1098,6 +1097,9 @@ class GLES2DecoderImpl : public GLES2Decoder, public ErrorStateClient {
 
   void DoMatrixLoadfCHROMIUM(GLenum matrix_mode, const GLfloat* matrix);
   void DoMatrixLoadIdentityCHROMIUM(GLenum matrix_mode);
+  void DoScheduleCALayerFilterEffectsCHROMIUM(
+      GLsizei count,
+      const GLCALayerFilterEffect* filter_effects);
   void DoScheduleCALayerInUseQueryCHROMIUM(GLsizei count,
                                            const GLuint* textures);
 
@@ -2331,6 +2333,7 @@ class GLES2DecoderImpl : public GLES2Decoder, public ErrorStateClient {
   };
 
   std::unique_ptr<CALayerSharedState> ca_layer_shared_state_;
+  std::vector<ui::CARendererLayerParams::FilterEffect> ca_layer_filter_effects_;
 
   DISALLOW_COPY_AND_ASSIGN(GLES2DecoderImpl);
 };
@@ -11009,6 +11012,8 @@ error::Error GLES2DecoderImpl::HandleScheduleCALayerCHROMIUM(
   gfx::RectF contents_rect(mem[0], mem[1], mem[2], mem[3]);
   gfx::RectF bounds_rect(mem[4], mem[5], mem[6], mem[7]);
 
+  // TODO(erikchen): Pass through filter effects. https://crbug.com/581526.
+  ca_layer_filter_effects_.clear();
   ui::CARendererLayerParams params = ui::CARendererLayerParams(
       ca_layer_shared_state_->is_clipped, ca_layer_shared_state_->clip_rect,
       ca_layer_shared_state_->sorting_context_id,
@@ -11022,6 +11027,42 @@ error::Error GLES2DecoderImpl::HandleScheduleCALayerCHROMIUM(
   return error::kNoError;
 }
 
+void GLES2DecoderImpl::DoScheduleCALayerFilterEffectsCHROMIUM(
+    GLsizei count,
+    const GLCALayerFilterEffect* filter_effects) {
+  std::vector<ui::CARendererLayerParams::FilterEffect> effects;
+  effects.resize(count);
+  for (GLsizei i = 0; i < count; ++i) {
+    const GLCALayerFilterEffect& filter_effect = filter_effects[i];
+    GLint min =
+        static_cast<GLint>(ui::CARendererLayerParams::FilterEffectType::MIN);
+    GLint max =
+        static_cast<GLint>(ui::CARendererLayerParams::FilterEffectType::MAX);
+    if (filter_effect.type < min || filter_effect.type > max) {
+      LOCAL_SET_GL_ERROR(GL_INVALID_VALUE,
+                         "glScheduleCALayerFilterEffectsCHROMIUM",
+                         "Invalid filter type.");
+      return;
+    }
+    ui::CARendererLayerParams::FilterEffectType filter_type =
+        static_cast<ui::CARendererLayerParams::FilterEffectType>(
+            filter_effect.type);
+
+    ui::CARendererLayerParams::FilterEffect& effect = effects[i];
+    effect.type = filter_type;
+    effect.amount = filter_effect.amount;
+    effect.drop_shadow_offset = gfx::Point(filter_effect.drop_shadow_offset_x,
+                                           filter_effect.drop_shadow_offset_y);
+
+    static_assert(sizeof(GLuint) == sizeof(SkColor),
+                  "GLuint and SkColor must have the same size.");
+    effect.drop_shadow_color =
+        static_cast<SkColor>(filter_effect.drop_shadow_color);
+  }
+
+  ca_layer_filter_effects_.swap(effects);
+}
+
 void GLES2DecoderImpl::DoScheduleCALayerInUseQueryCHROMIUM(
     GLsizei count,
     const GLuint* textures) {
@@ -15769,8 +15810,7 @@ void GLES2DecoderImpl::DoProduceTextureCHROMIUM(GLenum target,
 
   TextureRef* texture_ref = texture_manager()->GetTextureInfoForTarget(
       &state_, target);
-  ProduceTextureRef("glProduceTextureCHROMIUM", false, texture_ref, target,
-                    data);
+  ProduceTextureRef("glProduceTextureCHROMIUM", texture_ref, target, data);
 }
 
 void GLES2DecoderImpl::DoProduceTextureDirectCHROMIUM(GLuint client_id,
@@ -15779,12 +15819,11 @@ void GLES2DecoderImpl::DoProduceTextureDirectCHROMIUM(GLuint client_id,
       "context", logger_.GetLogPrefix(),
       "mailbox[0]", static_cast<unsigned char>(data[0]));
 
-  ProduceTextureRef("glProduceTextureDirectCHROMIUM", !client_id,
-                    GetTexture(client_id), target, data);
+  ProduceTextureRef("glProduceTextureDirectCHROMIUM", GetTexture(client_id),
+      target, data);
 }
 
 void GLES2DecoderImpl::ProduceTextureRef(const char* func_name,
-                                         bool clear,
                                          TextureRef* texture_ref,
                                          GLenum target,
                                          const GLbyte* data) {
@@ -15793,13 +15832,6 @@ void GLES2DecoderImpl::ProduceTextureRef(const char* func_name,
                                        "mailbox that was not generated by "
                                        "GenMailboxCHROMIUM.";
 
-  if (clear) {
-    DCHECK(!texture_ref);
-
-    group_->mailbox_manager()->ProduceTexture(mailbox, nullptr);
-    return;
-  }
-
   if (!texture_ref) {
     LOCAL_SET_GL_ERROR(
         GL_INVALID_OPERATION, func_name, "unknown texture for target");
@@ -17567,6 +17599,7 @@ bool GLES2DecoderImpl::ChromiumImageNeedsRGBEmulation() {
 
 void GLES2DecoderImpl::ClearScheduleCALayerState() {
   ca_layer_shared_state_.reset();
+  ca_layer_filter_effects_.clear();
 }
 
 error::Error GLES2DecoderImpl::HandleBindFragmentInputLocationCHROMIUMBucket(
diff --git a/gpu/command_buffer/service/gles2_cmd_decoder_autogen.h b/gpu/command_buffer/service/gles2_cmd_decoder_autogen.h
index b899034..7a60901 100644
--- a/gpu/command_buffer/service/gles2_cmd_decoder_autogen.h
+++ b/gpu/command_buffer/service/gles2_cmd_decoder_autogen.h
@@ -5281,6 +5281,40 @@ error::Error GLES2DecoderImpl::HandleDrawBuffersEXTImmediate(
   return error::kNoError;
 }
 
+error::Error
+GLES2DecoderImpl::HandleScheduleCALayerFilterEffectsCHROMIUMImmediate(
+    uint32_t immediate_data_size,
+    const void* cmd_data) {
+  const gles2::cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate& c =
+      *static_cast<
+          const gles2::cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate*>(
+          cmd_data);
+  (void)c;
+  GLsizei count = static_cast<GLsizei>(c.count);
+  uint32_t data_size = 0;
+  if (count >= 0 &&
+      !GLES2Util::ComputeDataSize(count, sizeof(GLCALayerFilterEffect), 1,
+                                  &data_size)) {
+    return error::kOutOfBounds;
+  }
+  if (data_size > immediate_data_size) {
+    return error::kOutOfBounds;
+  }
+  const GLCALayerFilterEffect* effects =
+      GetImmediateDataAs<const GLCALayerFilterEffect*>(c, data_size,
+                                                       immediate_data_size);
+  if (count < 0) {
+    LOCAL_SET_GL_ERROR(GL_INVALID_VALUE,
+                       "glScheduleCALayerFilterEffectsCHROMIUM", "count < 0");
+    return error::kNoError;
+  }
+  if (effects == NULL) {
+    return error::kOutOfBounds;
+  }
+  DoScheduleCALayerFilterEffectsCHROMIUM(count, effects);
+  return error::kNoError;
+}
+
 error::Error GLES2DecoderImpl::HandleScheduleCALayerInUseQueryCHROMIUMImmediate(
     uint32_t immediate_data_size,
     const void* cmd_data) {
diff --git a/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_doer_prototypes.h b/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_doer_prototypes.h
index 4d08c50..399d542 100644
--- a/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_doer_prototypes.h
+++ b/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_doer_prototypes.h
@@ -764,6 +764,9 @@ error::Error DoScheduleCALayerSharedStateCHROMIUM(GLfloat opacity,
                                                   const GLfloat* clip_rect,
                                                   GLint sorting_context_id,
                                                   const GLfloat* transform);
+error::Error DoScheduleCALayerFilterEffectsCHROMIUM(
+    GLuint n,
+    const GLCALayerFilterEffect* effects);
 error::Error DoScheduleCALayerCHROMIUM(GLuint contents_texture_id,
                                        const GLfloat* contents_rect,
                                        GLuint background_color,
diff --git a/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_doers.cc b/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_doers.cc
index 72c8ded..c58836b 100644
--- a/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_doers.cc
+++ b/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_doers.cc
@@ -1867,6 +1867,13 @@ error::Error GLES2DecoderPassthroughImpl::DoScheduleCALayerSharedStateCHROMIUM(
   return error::kNoError;
 }
 
+error::Error
+GLES2DecoderPassthroughImpl::DoScheduleCALayerFilterEffectsCHROMIUM(
+    GLuint n,
+    const GLCALayerFilterEffect* effects) {
+  return error::kNoError;
+}
+
 error::Error GLES2DecoderPassthroughImpl::DoScheduleCALayerCHROMIUM(
     GLuint contents_texture_id,
     const GLfloat* contents_rect,
diff --git a/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_handlers_autogen.cc b/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_handlers_autogen.cc
index 652bf09..4564dd8 100644
--- a/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_handlers_autogen.cc
+++ b/gpu/command_buffer/service/gles2_cmd_decoder_passthrough_handlers_autogen.cc
@@ -4273,6 +4273,35 @@ error::Error GLES2DecoderPassthroughImpl::HandleDrawBuffersEXTImmediate(
   return error::kNoError;
 }
 
+error::Error GLES2DecoderPassthroughImpl::
+    HandleScheduleCALayerFilterEffectsCHROMIUMImmediate(
+        uint32_t immediate_data_size,
+        const void* cmd_data) {
+  const gles2::cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate& c =
+      *static_cast<
+          const gles2::cmds::ScheduleCALayerFilterEffectsCHROMIUMImmediate*>(
+          cmd_data);
+  (void)c;
+  GLsizei count = static_cast<GLsizei>(c.count);
+  uint32_t data_size = 0;
+  if (count >= 0 &&
+      !GLES2Util::ComputeDataSize(count, sizeof(GLCALayerFilterEffect), 1,
+                                  &data_size)) {
+    return error::kOutOfBounds;
+  }
+  if (data_size > immediate_data_size) {
+    return error::kOutOfBounds;
+  }
+  const GLCALayerFilterEffect* effects =
+      GetImmediateDataAs<const GLCALayerFilterEffect*>(c, data_size,
+                                                       immediate_data_size);
+  error::Error error = DoScheduleCALayerFilterEffectsCHROMIUM(count, effects);
+  if (error != error::kNoError) {
+    return error;
+  }
+  return error::kNoError;
+}
+
 error::Error
 GLES2DecoderPassthroughImpl::HandleScheduleCALayerInUseQueryCHROMIUMImmediate(
     uint32_t immediate_data_size,
diff --git a/gpu/command_buffer/service/mailbox_manager_impl.cc b/gpu/command_buffer/service/mailbox_manager_impl.cc
index a8ce6ed..58e98f0 100644
--- a/gpu/command_buffer/service/mailbox_manager_impl.cc
+++ b/gpu/command_buffer/service/mailbox_manager_impl.cc
@@ -44,8 +44,7 @@ void MailboxManagerImpl::ProduceTexture(const Mailbox& mailbox,
     mailbox_to_textures_.erase(it);
     textures_to_mailboxes_.erase(texture_it);
   }
-  if (texture)
-    InsertTexture(mailbox, texture);
+  InsertTexture(mailbox, texture);
 }
 
 void MailboxManagerImpl::InsertTexture(const Mailbox& mailbox,
diff --git a/gpu/command_buffer/service/mailbox_manager_sync.cc b/gpu/command_buffer/service/mailbox_manager_sync.cc
index 5a79a41..d07a3dd 100644
--- a/gpu/command_buffer/service/mailbox_manager_sync.cc
+++ b/gpu/command_buffer/service/mailbox_manager_sync.cc
@@ -239,9 +239,6 @@ void MailboxManagerSync::ProduceTexture(const Mailbox& mailbox,
     group_for_mailbox->RemoveName(mailbox);
   }
 
-  if (!texture)
-    return;
-
   if (group_for_texture) {
     group_for_texture->AddName(mailbox);
   } else {
diff --git a/gpu/command_buffer/service/program_manager.cc b/gpu/command_buffer/service/program_manager.cc
index 2b3757b..91bcf8c 100644
--- a/gpu/command_buffer/service/program_manager.cc
+++ b/gpu/command_buffer/service/program_manager.cc
@@ -151,38 +151,6 @@ ShaderVariableBaseType InputOutputTypeToBaseType(bool is_input, GLenum type) {
   }
 }
 
-// Scoped object which logs three UMA stats related to program cleanup when
-// destructed:
-// - GPU.DestroyProgramManagerPrograms.Elapsed - The amount of time spent
-//   destroying programs during ProgramManager::Destroy.
-// - GPU.DestroyProgramManagerPrograms.Programs - The number of progams
-//   destroyed during ProgramManager::Destroy.
-// - GPU.DestroyProgramManagerPrograms.ProgramsPerMs - The number of programs
-//   destroyed per millisecond during ProgramManager::Destroy. Only logged if
-//   both the number of programs and the elapsed time are greater than zero.
-class ProgramDeletionScopedUmaTimeAndRate {
- public:
-  ProgramDeletionScopedUmaTimeAndRate(int32_t count)
-      : count_(count), start_(base::TimeTicks::Now()) {}
-
-  ~ProgramDeletionScopedUmaTimeAndRate() {
-    base::TimeDelta elapsed = base::TimeTicks::Now() - start_;
-    UMA_HISTOGRAM_TIMES("GPU.DestroyProgramManagerPrograms.Elapsed", elapsed);
-    UMA_HISTOGRAM_COUNTS("GPU.DestroyProgramManagerPrograms.Programs", count_);
-
-    double elapsed_ms = elapsed.InMillisecondsF();
-    if (count_ > 0 && elapsed_ms > 0) {
-      double rate = static_cast<double>(count_) / elapsed_ms;
-      UMA_HISTOGRAM_COUNTS("GPU.DestroyProgramManagerPrograms.ProgramsPerMs",
-                           base::saturated_cast<int32_t>(rate));
-    }
-  }
-
- private:
-  const int32_t count_;
-  const base::TimeTicks start_;
-};
-
 }  // anonymous namespace.
 
 Program::UniformInfo::UniformInfo()
@@ -2462,9 +2430,6 @@ ProgramManager::~ProgramManager() {
 
 void ProgramManager::Destroy(bool have_context) {
   have_context_ = have_context;
-
-  ProgramDeletionScopedUmaTimeAndRate scoped_histogram(
-      base::saturated_cast<int32_t>(programs_.size()));
   programs_.clear();
 }
 
diff --git a/gpu/command_buffer/tests/gl_tests_main.cc b/gpu/command_buffer/tests/gl_tests_main.cc
index 9f97550..0c79c11 100644
--- a/gpu/command_buffer/tests/gl_tests_main.cc
+++ b/gpu/command_buffer/tests/gl_tests_main.cc
@@ -5,7 +5,6 @@
 #include "base/at_exit.h"
 #include "base/bind.h"
 #include "base/command_line.h"
-#include "base/feature_list.h"
 #include "base/message_loop/message_loop.h"
 #if defined(OS_MACOSX)
 #include "base/mac/scoped_nsautorelease_pool.h"
@@ -31,7 +30,6 @@ int RunHelper(base::TestSuite* testSuite) {
 #else
   base::MessageLoopForIO message_loop;
 #endif
-  base::FeatureList::InitializeInstance(std::string(), std::string());
   gpu::GPUInfo gpu_info;
   gpu::CollectBasicGraphicsInfo(&gpu_info);
   gpu::ApplyGpuDriverBugWorkarounds(gpu_info,
diff --git a/gpu/ipc/common/BUILD.gn b/gpu/ipc/common/BUILD.gn
index 69692eb..ece6dc8 100644
--- a/gpu/ipc/common/BUILD.gn
+++ b/gpu/ipc/common/BUILD.gn
@@ -122,16 +122,11 @@ mojom("interfaces") {
   sources = [
     "capabilities.mojom",
     "command_buffer.mojom",
-    "dx_diag_node.mojom",
     "gpu_info.mojom",
     "mailbox.mojom",
     "mailbox_holder.mojom",
     "sync_token.mojom",
   ]
-
-  public_deps = [
-    "//ui/gfx/geometry/mojo",
-  ]
 }
 
 mojom("test_interfaces") {
diff --git a/gpu/ipc/common/dx_diag_node.mojom b/gpu/ipc/common/dx_diag_node.mojom
deleted file mode 100644
index f0b52e1..0000000
--- a/gpu/ipc/common/dx_diag_node.mojom
+++ /dev/null
@@ -1,12 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-module gpu.mojom;
-
-// gpu/config/dx_diag_node.h
-// gpu::DxDiagNode
-struct DxDiagNode {
-  map<string, string> values;
-  map<string, DxDiagNode> children;
-};
diff --git a/gpu/ipc/common/dx_diag_node.typemap b/gpu/ipc/common/dx_diag_node.typemap
deleted file mode 100644
index 976e94c..0000000
--- a/gpu/ipc/common/dx_diag_node.typemap
+++ /dev/null
@@ -1,11 +0,0 @@
-# Copyright 2016 The Chromium Authors. All rights reserved.
-# Use of this source code is governed by a BSD-style license that can be
-# found in the LICENSE file.
-
-mojom = "//gpu/ipc/common/dx_diag_node.mojom"
-public_headers = [ "//gpu/config/dx_diag_node.h" ]
-traits_headers = [ "//gpu/ipc/common/dx_diag_node_struct_traits.h" ]
-sources = [
-  "//gpu/ipc/common/dx_diag_node_struct_traits.cc",
-]
-type_mappings = [ "gpu.mojom.DxDiagNode=gpu::DxDiagNode" ]
diff --git a/gpu/ipc/common/dx_diag_node_struct_traits.cc b/gpu/ipc/common/dx_diag_node_struct_traits.cc
deleted file mode 100644
index 4bcf5e1..0000000
--- a/gpu/ipc/common/dx_diag_node_struct_traits.cc
+++ /dev/null
@@ -1,16 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "gpu/ipc/common/dx_diag_node_struct_traits.h"
-
-namespace mojo {
-
-// static
-bool StructTraits<gpu::mojom::DxDiagNode, gpu::DxDiagNode>::Read(
-    gpu::mojom::DxDiagNodeDataView data,
-    gpu::DxDiagNode* out) {
-  return data.ReadValues(&out->values) && data.ReadChildren(&out->children);
-}
-
-}  // namespace mojo
diff --git a/gpu/ipc/common/dx_diag_node_struct_traits.h b/gpu/ipc/common/dx_diag_node_struct_traits.h
deleted file mode 100644
index f405240..0000000
--- a/gpu/ipc/common/dx_diag_node_struct_traits.h
+++ /dev/null
@@ -1,29 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef GPU_IPC_COMMON_DX_DIAG_NODE_STRUCT_TRAITS_H_
-#define GPU_IPC_COMMON_DX_DIAG_NODE_STRUCT_TRAITS_H_
-
-#include "gpu/ipc/common/dx_diag_node.mojom.h"
-
-namespace mojo {
-
-template <>
-struct StructTraits<gpu::mojom::DxDiagNode, gpu::DxDiagNode> {
-  static bool Read(gpu::mojom::DxDiagNodeDataView data, gpu::DxDiagNode* out);
-
-  static const std::map<std::string, std::string>& values(
-      const gpu::DxDiagNode& node) {
-    return node.values;
-  }
-
-  static const std::map<std::string, gpu::DxDiagNode>& children(
-      const gpu::DxDiagNode& node) {
-    return node.children;
-  }
-};
-
-}  // namespace mojo
-
-#endif  // GPU_IPC_COMMON_DX_DIAG_NODE_STRUCT_TRAITS_H_
diff --git a/gpu/ipc/common/gpu_info.mojom b/gpu/ipc/common/gpu_info.mojom
index db7babd..26b8387 100644
--- a/gpu/ipc/common/gpu_info.mojom
+++ b/gpu/ipc/common/gpu_info.mojom
@@ -1,12 +1,9 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
+// Copyright 2014 The Chromium Authors. All rights reserved.
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
-// gpu/config/gpu_info.h
 module gpu.mojom;
 
-import "ui/gfx/geometry/mojo/geometry.mojom";
-
 // gpu::GPUInfo::GPUDevice
 struct GpuDevice {
   uint32 vendor_id;
@@ -16,55 +13,9 @@ struct GpuDevice {
   string device_string;
 };
 
-// gpu::CollectInfoResult
 enum CollectInfoResult {
   kCollectInfoNone = 0,
   kCollectInfoSuccess = 1,
   kCollectInfoNonFatalFailure = 2,
   kCollectInfoFatalFailure = 3
 };
-
-// gpu::VideoCodecProfile
-enum VideoCodecProfile {
-  VIDEO_CODEC_PROFILE_UNKNOWN = -1,
-  H264PROFILE_BASELINE = 0,
-  H264PROFILE_MAIN,
-  H264PROFILE_EXTENDED,
-  H264PROFILE_HIGH,
-  H264PROFILE_HIGH10PROFILE,
-  H264PROFILE_HIGH422PROFILE,
-  H264PROFILE_HIGH444PREDICTIVEPROFILE,
-  H264PROFILE_SCALABLEBASELINE,
-  H264PROFILE_SCALABLEHIGH,
-  H264PROFILE_STEREOHIGH,
-  H264PROFILE_MULTIVIEWHIGH,
-  VP8PROFILE_ANY,
-  VP9PROFILE_PROFILE0,
-  VP9PROFILE_PROFILE1,
-  VP9PROFILE_PROFILE2,
-  VP9PROFILE_PROFILE3,
-  HEVCPROFILE_MAIN,
-  HEVCPROFILE_MAIN10,
-  HEVCPROFILE_MAIN_STILL_PICTURE,
-};
-
-// gpu::VideoDecodeAcceleratorSupportedProfile
-struct VideoDecodeAcceleratorSupportedProfile {
-  VideoCodecProfile profile;
-  gfx.mojom.Size max_resolution;
-  gfx.mojom.Size min_resolution;
-  bool encrypted_only;
-};
-
-// gpu::VideoDecodeAcceleratorCapabilities
-struct VideoDecodeAcceleratorCapabilities {
-  uint32 flags;
-};
-
-// gpu::VideoEncodeAcceleratorSupportedProfile
-struct VideoEncodeAcceleratorSupportedProfile {
-  VideoCodecProfile profile;
-  gfx.mojom.Size max_resolution;
-  uint32 max_framerate_numerator;
-  uint32 max_framerate_denominator;
-};
diff --git a/gpu/ipc/common/gpu_info.typemap b/gpu/ipc/common/gpu_info.typemap
index dc8eb05..3282fde 100644
--- a/gpu/ipc/common/gpu_info.typemap
+++ b/gpu/ipc/common/gpu_info.typemap
@@ -10,13 +10,8 @@ sources = [
 ]
 deps = [
   "//gpu/config",
-  "//ui/gfx/geometry/mojo",
 ]
 type_mappings = [
-  "gpu.mojom.GpuDevice=gpu::GPUInfo::GPUDevice",
-  "gpu.mojom.CollectInfoResult=gpu::CollectInfoResult",
-  "gpu.mojom.VideoCodecProfile=gpu::VideoCodecProfile",
-  "gpu.mojom.VideoDecodeAcceleratorSupportedProfile=gpu::VideoDecodeAcceleratorSupportedProfile",
-  "gpu.mojom.VideoDecodeAcceleratorCapabilities=gpu::VideoDecodeAcceleratorCapabilities",
-  "gpu.mojom.VideoEncodeAcceleratorSupportedProfile=gpu::VideoEncodeAcceleratorSupportedProfile",
+  "gpu.mojom.GpuDevice=::gpu::GPUInfo::GPUDevice",
+  "gpu.mojom.CollectInfoResult=::gpu::CollectInfoResult",
 ]
diff --git a/gpu/ipc/common/gpu_info_struct_traits.cc b/gpu/ipc/common/gpu_info_struct_traits.cc
index ca3153b..6bcea5c 100644
--- a/gpu/ipc/common/gpu_info_struct_traits.cc
+++ b/gpu/ipc/common/gpu_info_struct_traits.cc
@@ -57,156 +57,4 @@ bool EnumTraits<gpu::mojom::CollectInfoResult, gpu::CollectInfoResult>::
   return false;
 }
 
-// static
-gpu::mojom::VideoCodecProfile
-EnumTraits<gpu::mojom::VideoCodecProfile, gpu::VideoCodecProfile>::ToMojom(
-    gpu::VideoCodecProfile video_codec_profile) {
-  switch (video_codec_profile) {
-    case gpu::VideoCodecProfile::VIDEO_CODEC_PROFILE_UNKNOWN:
-      return gpu::mojom::VideoCodecProfile::VIDEO_CODEC_PROFILE_UNKNOWN;
-    case gpu::VideoCodecProfile::H264PROFILE_BASELINE:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_BASELINE;
-    case gpu::VideoCodecProfile::H264PROFILE_MAIN:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_MAIN;
-    case gpu::VideoCodecProfile::H264PROFILE_EXTENDED:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_EXTENDED;
-    case gpu::VideoCodecProfile::H264PROFILE_HIGH:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_HIGH;
-    case gpu::VideoCodecProfile::H264PROFILE_HIGH10PROFILE:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_HIGH10PROFILE;
-    case gpu::VideoCodecProfile::H264PROFILE_HIGH422PROFILE:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_HIGH422PROFILE;
-    case gpu::VideoCodecProfile::H264PROFILE_HIGH444PREDICTIVEPROFILE:
-      return gpu::mojom::VideoCodecProfile::
-          H264PROFILE_HIGH444PREDICTIVEPROFILE;
-    case gpu::VideoCodecProfile::H264PROFILE_SCALABLEBASELINE:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_SCALABLEBASELINE;
-    case gpu::VideoCodecProfile::H264PROFILE_SCALABLEHIGH:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_SCALABLEHIGH;
-    case gpu::VideoCodecProfile::H264PROFILE_STEREOHIGH:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_STEREOHIGH;
-    case gpu::VideoCodecProfile::H264PROFILE_MULTIVIEWHIGH:
-      return gpu::mojom::VideoCodecProfile::H264PROFILE_MULTIVIEWHIGH;
-    case gpu::VideoCodecProfile::VP8PROFILE_ANY:
-      return gpu::mojom::VideoCodecProfile::VP8PROFILE_ANY;
-    case gpu::VideoCodecProfile::VP9PROFILE_PROFILE0:
-      return gpu::mojom::VideoCodecProfile::VP9PROFILE_PROFILE0;
-    case gpu::VideoCodecProfile::VP9PROFILE_PROFILE1:
-      return gpu::mojom::VideoCodecProfile::VP9PROFILE_PROFILE1;
-    case gpu::VideoCodecProfile::VP9PROFILE_PROFILE2:
-      return gpu::mojom::VideoCodecProfile::VP9PROFILE_PROFILE2;
-    case gpu::VideoCodecProfile::VP9PROFILE_PROFILE3:
-      return gpu::mojom::VideoCodecProfile::VP9PROFILE_PROFILE3;
-    case gpu::VideoCodecProfile::HEVCPROFILE_MAIN:
-      return gpu::mojom::VideoCodecProfile::HEVCPROFILE_MAIN;
-    case gpu::VideoCodecProfile::HEVCPROFILE_MAIN10:
-      return gpu::mojom::VideoCodecProfile::HEVCPROFILE_MAIN10;
-    case gpu::VideoCodecProfile::HEVCPROFILE_MAIN_STILL_PICTURE:
-      return gpu::mojom::VideoCodecProfile::HEVCPROFILE_MAIN_STILL_PICTURE;
-  }
-  NOTREACHED() << "Invalid VideoCodecProfile:" << video_codec_profile;
-  return gpu::mojom::VideoCodecProfile::VIDEO_CODEC_PROFILE_UNKNOWN;
-}
-
-// static
-bool EnumTraits<gpu::mojom::VideoCodecProfile, gpu::VideoCodecProfile>::
-    FromMojom(gpu::mojom::VideoCodecProfile input,
-              gpu::VideoCodecProfile* out) {
-  switch (input) {
-    case gpu::mojom::VideoCodecProfile::VIDEO_CODEC_PROFILE_UNKNOWN:
-      *out = gpu::VideoCodecProfile::VIDEO_CODEC_PROFILE_UNKNOWN;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_BASELINE:
-      *out = gpu::VideoCodecProfile::H264PROFILE_BASELINE;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_MAIN:
-      *out = gpu::VideoCodecProfile::H264PROFILE_MAIN;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_EXTENDED:
-      *out = gpu::VideoCodecProfile::H264PROFILE_EXTENDED;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_HIGH:
-      *out = gpu::VideoCodecProfile::H264PROFILE_HIGH;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_HIGH10PROFILE:
-      *out = gpu::VideoCodecProfile::H264PROFILE_HIGH10PROFILE;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_HIGH422PROFILE:
-      *out = gpu::VideoCodecProfile::H264PROFILE_HIGH422PROFILE;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_HIGH444PREDICTIVEPROFILE:
-      *out = gpu::VideoCodecProfile::H264PROFILE_HIGH444PREDICTIVEPROFILE;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_SCALABLEBASELINE:
-      *out = gpu::VideoCodecProfile::H264PROFILE_SCALABLEBASELINE;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_SCALABLEHIGH:
-      *out = gpu::VideoCodecProfile::H264PROFILE_SCALABLEHIGH;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_STEREOHIGH:
-      *out = gpu::VideoCodecProfile::H264PROFILE_STEREOHIGH;
-      return true;
-    case gpu::mojom::VideoCodecProfile::H264PROFILE_MULTIVIEWHIGH:
-      *out = gpu::VideoCodecProfile::H264PROFILE_MULTIVIEWHIGH;
-      return true;
-    case gpu::mojom::VideoCodecProfile::VP8PROFILE_ANY:
-      *out = gpu::VideoCodecProfile::VP8PROFILE_ANY;
-      return true;
-    case gpu::mojom::VideoCodecProfile::VP9PROFILE_PROFILE0:
-      *out = gpu::VideoCodecProfile::VP9PROFILE_PROFILE0;
-      return true;
-    case gpu::mojom::VideoCodecProfile::VP9PROFILE_PROFILE1:
-      *out = gpu::VideoCodecProfile::VP9PROFILE_PROFILE1;
-      return true;
-    case gpu::mojom::VideoCodecProfile::VP9PROFILE_PROFILE2:
-      *out = gpu::VideoCodecProfile::VP9PROFILE_PROFILE2;
-      return true;
-    case gpu::mojom::VideoCodecProfile::VP9PROFILE_PROFILE3:
-      *out = gpu::VideoCodecProfile::VP9PROFILE_PROFILE3;
-      return true;
-    case gpu::mojom::VideoCodecProfile::HEVCPROFILE_MAIN:
-      *out = gpu::VideoCodecProfile::HEVCPROFILE_MAIN;
-      return true;
-    case gpu::mojom::VideoCodecProfile::HEVCPROFILE_MAIN10:
-      *out = gpu::VideoCodecProfile::HEVCPROFILE_MAIN10;
-      return true;
-    case gpu::mojom::VideoCodecProfile::HEVCPROFILE_MAIN_STILL_PICTURE:
-      *out = gpu::VideoCodecProfile::HEVCPROFILE_MAIN_STILL_PICTURE;
-      return true;
-  }
-  NOTREACHED() << "Invalid VideoCodecProfile: " << input;
-  return false;
-}
-
-// static
-bool StructTraits<gpu::mojom::VideoDecodeAcceleratorSupportedProfile,
-                  gpu::VideoDecodeAcceleratorSupportedProfile>::
-    Read(gpu::mojom::VideoDecodeAcceleratorSupportedProfileDataView data,
-         gpu::VideoDecodeAcceleratorSupportedProfile* out) {
-  out->encrypted_only = data.encrypted_only();
-  return data.ReadProfile(&out->profile) &&
-         data.ReadMaxResolution(&out->max_resolution) &&
-         data.ReadMinResolution(&out->min_resolution);
-}
-
-// static
-bool StructTraits<gpu::mojom::VideoDecodeAcceleratorCapabilities,
-                  gpu::VideoDecodeAcceleratorCapabilities>::
-    Read(gpu::mojom::VideoDecodeAcceleratorCapabilitiesDataView data,
-         gpu::VideoDecodeAcceleratorCapabilities* out) {
-  out->flags = data.flags();
-  return true;
-}
-
-// static
-bool StructTraits<gpu::mojom::VideoEncodeAcceleratorSupportedProfile,
-                  gpu::VideoEncodeAcceleratorSupportedProfile>::
-    Read(gpu::mojom::VideoEncodeAcceleratorSupportedProfileDataView data,
-         gpu::VideoEncodeAcceleratorSupportedProfile* out) {
-  out->max_framerate_numerator = data.max_framerate_numerator();
-  out->max_framerate_denominator = data.max_framerate_denominator();
-  return data.ReadProfile(&out->profile) &&
-         data.ReadMaxResolution(&out->max_resolution);
-}
-
 }  // namespace mojo
diff --git a/gpu/ipc/common/gpu_info_struct_traits.h b/gpu/ipc/common/gpu_info_struct_traits.h
index 1dedef1..ca14216 100644
--- a/gpu/ipc/common/gpu_info_struct_traits.h
+++ b/gpu/ipc/common/gpu_info_struct_traits.h
@@ -7,7 +7,6 @@
 
 #include "gpu/config/gpu_info.h"
 #include "gpu/ipc/common/gpu_info.mojom.h"
-#include "ui/gfx/geometry/mojo/geometry_struct_traits.h"
 
 namespace mojo {
 
@@ -48,80 +47,5 @@ struct EnumTraits<gpu::mojom::CollectInfoResult, gpu::CollectInfoResult> {
                         gpu::CollectInfoResult* out);
 };
 
-template <>
-struct EnumTraits<gpu::mojom::VideoCodecProfile, gpu::VideoCodecProfile> {
-  static gpu::mojom::VideoCodecProfile ToMojom(
-      gpu::VideoCodecProfile video_codec_profile);
-  static bool FromMojom(gpu::mojom::VideoCodecProfile input,
-                        gpu::VideoCodecProfile* out);
-};
-
-template <>
-struct StructTraits<gpu::mojom::VideoDecodeAcceleratorSupportedProfile,
-                    gpu::VideoDecodeAcceleratorSupportedProfile> {
-  static bool Read(
-      gpu::mojom::VideoDecodeAcceleratorSupportedProfileDataView data,
-      gpu::VideoDecodeAcceleratorSupportedProfile* out);
-
-  static gpu::VideoCodecProfile profile(
-      const gpu::VideoDecodeAcceleratorSupportedProfile& input) {
-    return input.profile;
-  }
-
-  static const gfx::Size& max_resolution(
-      const gpu::VideoDecodeAcceleratorSupportedProfile& input) {
-    return input.max_resolution;
-  }
-
-  static const gfx::Size& min_resolution(
-      const gpu::VideoDecodeAcceleratorSupportedProfile& input) {
-    return input.min_resolution;
-  }
-
-  static bool encrypted_only(
-      const gpu::VideoDecodeAcceleratorSupportedProfile& input) {
-    return input.encrypted_only;
-  }
-};
-
-template <>
-struct StructTraits<gpu::mojom::VideoDecodeAcceleratorCapabilities,
-                    gpu::VideoDecodeAcceleratorCapabilities> {
-  static bool Read(gpu::mojom::VideoDecodeAcceleratorCapabilitiesDataView data,
-                   gpu::VideoDecodeAcceleratorCapabilities* out);
-
-  static uint32_t flags(const gpu::VideoDecodeAcceleratorCapabilities& input) {
-    return input.flags;
-  }
-};
-
-template <>
-struct StructTraits<gpu::mojom::VideoEncodeAcceleratorSupportedProfile,
-                    gpu::VideoEncodeAcceleratorSupportedProfile> {
-  static bool Read(
-      gpu::mojom::VideoEncodeAcceleratorSupportedProfileDataView data,
-      gpu::VideoEncodeAcceleratorSupportedProfile* out);
-
-  static gpu::VideoCodecProfile profile(
-      const gpu::VideoEncodeAcceleratorSupportedProfile& input) {
-    return input.profile;
-  }
-
-  static const gfx::Size& max_resolution(
-      const gpu::VideoEncodeAcceleratorSupportedProfile& input) {
-    return input.max_resolution;
-  }
-
-  static uint32_t max_framerate_numerator(
-      const gpu::VideoEncodeAcceleratorSupportedProfile& input) {
-    return input.max_framerate_numerator;
-  }
-
-  static uint32_t max_framerate_denominator(
-      const gpu::VideoEncodeAcceleratorSupportedProfile& input) {
-    return input.max_framerate_denominator;
-  }
-};
-
 }  // namespace mojo
 #endif  // CC_IPC_GPU_STRUCT_TRAITS_H_
diff --git a/gpu/ipc/common/struct_traits_unittest.cc b/gpu/ipc/common/struct_traits_unittest.cc
index b25ce4e..a589c05 100644
--- a/gpu/ipc/common/struct_traits_unittest.cc
+++ b/gpu/ipc/common/struct_traits_unittest.cc
@@ -24,11 +24,6 @@ class StructTraitsTest : public testing::Test, public mojom::TraitsTestService {
 
  private:
   // TraitsTestService:
-  void EchoDxDiagNode(const DxDiagNode& d,
-                      const EchoDxDiagNodeCallback& callback) override {
-    callback.Run(d);
-  }
-
   void EchoGpuDevice(const GPUInfo::GPUDevice& g,
                      const EchoGpuDeviceCallback& callback) override {
     callback.Run(g);
@@ -49,26 +44,6 @@ class StructTraitsTest : public testing::Test, public mojom::TraitsTestService {
     callback.Run(s);
   }
 
-  void EchoVideoDecodeAcceleratorSupportedProfile(
-      const VideoDecodeAcceleratorSupportedProfile& v,
-      const EchoVideoDecodeAcceleratorSupportedProfileCallback& callback)
-      override {
-    callback.Run(v);
-  }
-
-  void EchoVideoDecodeAcceleratorCapabilities(
-      const VideoDecodeAcceleratorCapabilities& v,
-      const EchoVideoDecodeAcceleratorCapabilitiesCallback& callback) override {
-    callback.Run(v);
-  }
-
-  void EchoVideoEncodeAcceleratorSupportedProfile(
-      const VideoEncodeAcceleratorSupportedProfile& v,
-      const EchoVideoEncodeAcceleratorSupportedProfileCallback& callback)
-      override {
-    callback.Run(v);
-  }
-
   base::MessageLoop loop_;
   mojo::BindingSet<TraitsTestService> traits_test_bindings_;
 
@@ -77,18 +52,6 @@ class StructTraitsTest : public testing::Test, public mojom::TraitsTestService {
 
 }  // namespace
 
-TEST_F(StructTraitsTest, DxDiagNode) {
-  gpu::DxDiagNode input;
-  input.values["abc"] = "123";
-  mojom::TraitsTestServicePtr proxy = GetTraitsTestProxy();
-  gpu::DxDiagNode output;
-  proxy->EchoDxDiagNode(input, &output);
-
-  gpu::DxDiagNode test_dx_diag_node;
-  test_dx_diag_node.values["abc"] = "123";
-  EXPECT_EQ(test_dx_diag_node.values, output.values);
-}
-
 TEST_F(StructTraitsTest, GPUDevice) {
   gpu::GPUInfo::GPUDevice input;
   // Using the values from gpu/config/gpu_info_collector_unittest.cc::nvidia_gpu
@@ -175,63 +138,4 @@ TEST_F(StructTraitsTest, SyncToken) {
   EXPECT_EQ(verified_flush, output.verified_flush());
 }
 
-TEST_F(StructTraitsTest, VideoDecodeAcceleratorSupportedProfile) {
-  const gpu::VideoCodecProfile profile =
-      gpu::VideoCodecProfile::H264PROFILE_MAIN;
-  const int32_t max_width = 1920;
-  const int32_t max_height = 1080;
-  const int32_t min_width = 640;
-  const int32_t min_height = 480;
-  const gfx::Size max_resolution(max_width, max_height);
-  const gfx::Size min_resolution(min_width, min_height);
-
-  gpu::VideoDecodeAcceleratorSupportedProfile input;
-  input.profile = profile;
-  input.max_resolution = max_resolution;
-  input.min_resolution = min_resolution;
-  input.encrypted_only = false;
-
-  mojom::TraitsTestServicePtr proxy = GetTraitsTestProxy();
-  gpu::VideoDecodeAcceleratorSupportedProfile output;
-  proxy->EchoVideoDecodeAcceleratorSupportedProfile(input, &output);
-  EXPECT_EQ(profile, output.profile);
-  EXPECT_EQ(max_resolution, output.max_resolution);
-  EXPECT_EQ(min_resolution, output.min_resolution);
-  EXPECT_FALSE(output.encrypted_only);
-}
-
-TEST_F(StructTraitsTest, VideoDecodeAcceleratorCapabilities) {
-  const uint32_t flags = 1234;
-
-  gpu::VideoDecodeAcceleratorCapabilities input;
-  input.flags = flags;
-
-  mojom::TraitsTestServicePtr proxy = GetTraitsTestProxy();
-  gpu::VideoDecodeAcceleratorCapabilities output;
-  proxy->EchoVideoDecodeAcceleratorCapabilities(input, &output);
-  EXPECT_EQ(flags, output.flags);
-}
-
-TEST_F(StructTraitsTest, VideoEncodeAcceleratorSupportedProfile) {
-  const gpu::VideoCodecProfile profile =
-      gpu::VideoCodecProfile::H264PROFILE_MAIN;
-  const gfx::Size max_resolution(1920, 1080);
-  const uint32_t max_framerate_numerator = 144;
-  const uint32_t max_framerate_denominator = 12;
-
-  gpu::VideoEncodeAcceleratorSupportedProfile input;
-  input.profile = profile;
-  input.max_resolution = max_resolution;
-  input.max_framerate_numerator = max_framerate_numerator;
-  input.max_framerate_denominator = max_framerate_denominator;
-
-  mojom::TraitsTestServicePtr proxy = GetTraitsTestProxy();
-  gpu::VideoEncodeAcceleratorSupportedProfile output;
-  proxy->EchoVideoEncodeAcceleratorSupportedProfile(input, &output);
-  EXPECT_EQ(profile, output.profile);
-  EXPECT_EQ(max_resolution, output.max_resolution);
-  EXPECT_EQ(max_framerate_numerator, output.max_framerate_numerator);
-  EXPECT_EQ(max_framerate_denominator, output.max_framerate_denominator);
-}
-
 }  // namespace gpu
diff --git a/gpu/ipc/common/traits_test_service.mojom b/gpu/ipc/common/traits_test_service.mojom
index 94b80ae..196b3f8 100644
--- a/gpu/ipc/common/traits_test_service.mojom
+++ b/gpu/ipc/common/traits_test_service.mojom
@@ -4,7 +4,6 @@
 
 module gpu.mojom;
 
-import "gpu/ipc/common/dx_diag_node.mojom";
 import "gpu/ipc/common/gpu_info.mojom";
 import "gpu/ipc/common/mailbox.mojom";
 import "gpu/ipc/common/mailbox_holder.mojom";
@@ -15,9 +14,6 @@ import "gpu/ipc/common/sync_token.mojom";
 interface TraitsTestService {
 
   [Sync]
-  EchoDxDiagNode(DxDiagNode d) => (DxDiagNode pass);
-
-  [Sync]
   EchoGpuDevice(GpuDevice g) => (GpuDevice pass);
 
   [Sync]
@@ -28,19 +24,4 @@ interface TraitsTestService {
 
   [Sync]
   EchoSyncToken(SyncToken s) => (SyncToken pass);
-
-  [Sync]
-  EchoVideoDecodeAcceleratorSupportedProfile(
-    VideoDecodeAcceleratorSupportedProfile v) =>
-      (VideoDecodeAcceleratorSupportedProfile pass);
-
-  [Sync]
-  EchoVideoDecodeAcceleratorCapabilities(
-    VideoDecodeAcceleratorCapabilities v) =>
-      (VideoDecodeAcceleratorCapabilities pass);
-
-  [Sync]
-  EchoVideoEncodeAcceleratorSupportedProfile(
-    VideoEncodeAcceleratorSupportedProfile v) =>
-      (VideoEncodeAcceleratorSupportedProfile pass);
 };
diff --git a/gpu/ipc/common/typemaps.gni b/gpu/ipc/common/typemaps.gni
index d49a01f..6339167 100644
--- a/gpu/ipc/common/typemaps.gni
+++ b/gpu/ipc/common/typemaps.gni
@@ -6,7 +6,6 @@ typemaps = [
   "//gpu/ipc/common/capabilities.typemap",
   "//gpu/ipc/common/command_buffer.typemap",
   "//gpu/ipc/common/gpu_info.typemap",
-  "//gpu/ipc/common/dx_diag_node.typemap",
   "//gpu/ipc/common/mailbox.typemap",
   "//gpu/ipc/common/mailbox_holder.typemap",
   "//gpu/ipc/common/sync_token.typemap",
diff --git a/headless/app/headless_shell.cc b/headless/app/headless_shell.cc
index 9fafa55..1410313 100644
--- a/headless/app/headless_shell.cc
+++ b/headless/app/headless_shell.cc
@@ -42,18 +42,7 @@ namespace {
 const char kDevToolsHttpServerAddress[] = "127.0.0.1";
 // Default file name for screenshot. Can be overriden by "--screenshot" switch.
 const char kDefaultScreenshotFileName[] = "screenshot.png";
-
-bool ParseWindowSize(std::string window_size, gfx::Size* parsed_window_size) {
-  int width, height = 0;
-  if (sscanf(window_size.c_str(), "%dx%d", &width, &height) >= 2 &&
-      width >= 0 && height >= 0) {
-    parsed_window_size->set_width(width);
-    parsed_window_size->set_height(height);
-    return true;
-  }
-  return false;
 }
-}  // namespace
 
 // A sample application which demonstrates the use of the headless API.
 class HeadlessShell : public HeadlessWebContents::Observer, page::Observer {
@@ -363,17 +352,6 @@ int main(int argc, const char** argv) {
     builder.SetIncognitoMode(false);
   }
 
-  if (command_line.HasSwitch(headless::switches::kWindowSize)) {
-    std::string window_size =
-        command_line.GetSwitchValueASCII(headless::switches::kWindowSize);
-    gfx::Size parsed_window_size;
-    if (!ParseWindowSize(window_size, &parsed_window_size)) {
-      LOG(ERROR) << "Malformed window size";
-      return EXIT_FAILURE;
-    }
-    builder.SetWindowSize(parsed_window_size);
-  }
-
   return HeadlessBrowserMain(
       builder.Build(),
       base::Bind(&HeadlessShell::OnStart, base::Unretained(&shell)));
diff --git a/headless/app/headless_shell_switches.cc b/headless/app/headless_shell_switches.cc
index c748b9b..7cc02dd 100644
--- a/headless/app/headless_shell_switches.cc
+++ b/headless/app/headless_shell_switches.cc
@@ -34,8 +34,5 @@ const char kUseGL[] = "use-gl";
 // Directory where the browser stores the user profile.
 const char kUserDataDir[] = "user-data-dir";
 
-// Sets the initial window size. Provided as string in the format "800x600".
-const char kWindowSize[] = "window-size";
-
 }  // namespace switches
 }  // namespace headless
diff --git a/headless/app/headless_shell_switches.h b/headless/app/headless_shell_switches.h
index 26068b2..7a3d612 100644
--- a/headless/app/headless_shell_switches.h
+++ b/headless/app/headless_shell_switches.h
@@ -14,7 +14,6 @@ extern const char kRepl[];
 extern const char kScreenshot[];
 extern const char kUseGL[];
 extern const char kUserDataDir[];
-extern const char kWindowSize[];
 }  // namespace switches
 }  // namespace headless
 
diff --git a/headless/lib/browser/client_api_generator.py b/headless/lib/browser/client_api_generator.py
index e5276c4..40f1206 100644
--- a/headless/lib/browser/client_api_generator.py
+++ b/headless/lib/browser/client_api_generator.py
@@ -59,17 +59,9 @@ def CamelCaseToHackerStyle(name):
   return name.lower()
 
 
-def SanitizeLiteral(literal):
-  return {
-    # Rename null enumeration values to avoid a clash with the NULL macro.
-    'null': 'none',
-    # Rename mathematical constants to avoid colliding with C macros.
-    'Infinity': 'InfinityValue',
-    '-Infinity': 'NegativeInfinityValue',
-    'NaN': 'NaNValue',
-    # Turn negative zero into a safe identifier.
-    '-0': 'NegativeZeroValue',
-  }.get(literal, literal)
+def MangleEnum(value):
+  # Rename NULL enumeration values to avoid a clash with the actual NULL.
+  return 'NONE' if value == 'NULL' else value
 
 
 def InitializeJinjaEnv(cache_dir):
@@ -85,7 +77,7 @@ def InitializeJinjaEnv(cache_dir):
     'to_title_case': ToTitleCase,
     'dash_to_camelcase': DashToCamelCase,
     'camelcase_to_hacker_style': CamelCaseToHackerStyle,
-    'sanitize_literal': SanitizeLiteral,
+    'mangle_enum': MangleEnum,
   })
   jinja_env.add_extension('jinja2.ext.loopcontrols')
   return jinja_env
diff --git a/headless/lib/browser/client_api_generator_unittest.py b/headless/lib/browser/client_api_generator_unittest.py
index 67ff253..0cd7df3 100644
--- a/headless/lib/browser/client_api_generator_unittest.py
+++ b/headless/lib/browser/client_api_generator_unittest.py
@@ -35,11 +35,9 @@ class ClientApiGeneratorTest(unittest.TestCase):
     self.assertEqual(client_api_generator.CamelCaseToHackerStyle('LoLoLoL'),
                      'lo_lo_lol')
 
-  def test_SanitizeLiteralEnum(self):
-    self.assertEqual(client_api_generator.SanitizeLiteral('foo'), 'foo')
-    self.assertEqual(client_api_generator.SanitizeLiteral('null'), 'none')
-    self.assertEqual(client_api_generator.SanitizeLiteral('Infinity'),
-                                                          'InfinityValue')
+  def test_MangleEnum(self):
+    self.assertEqual(client_api_generator.MangleEnum('FOO'), 'FOO')
+    self.assertEqual(client_api_generator.MangleEnum('NULL'), 'NONE')
 
   def test_PatchFullQualifiedRefs(self):
     json_api = {
diff --git a/headless/lib/browser/type_conversions_h.template b/headless/lib/browser/type_conversions_h.template
index 1c918ac..286b0e5 100644
--- a/headless/lib/browser/type_conversions_h.template
+++ b/headless/lib/browser/type_conversions_h.template
@@ -20,7 +20,7 @@ namespace internal {
 template <>
 struct FromValue<{{namespace}}::{{type.id}}> {
   static {{namespace}}::{{type.id}} Parse(const base::Value& value, ErrorReporter* errors) {
-      {% set default = namespace + '::' + type.id + '::' + type.enum[0] | sanitize_literal | dash_to_camelcase | camelcase_to_hacker_style | upper %}
+      {% set default = namespace + '::' + type.id + '::' + type.enum[0] | dash_to_camelcase | camelcase_to_hacker_style | upper | mangle_enum %}
     std::string string_value;
     if (!value.GetAsString(&string_value)) {
       errors->AddError("string enum value expected");
@@ -29,7 +29,7 @@ struct FromValue<{{namespace}}::{{type.id}}> {
     }
       {% for literal in type.enum %}
     if (string_value == "{{literal}}")
-      return {{namespace}}::{{type.id}}::{{literal | sanitize_literal | dash_to_camelcase | camelcase_to_hacker_style | upper }};
+      return {{namespace}}::{{type.id}}::{{literal | dash_to_camelcase | camelcase_to_hacker_style | upper | mangle_enum}};
       {% endfor %}
     errors->AddError("invalid enum value");
     return {{default}};
@@ -40,7 +40,7 @@ template <typename T>
 std::unique_ptr<base::Value> ToValueImpl(const {{namespace}}::{{type.id}}& value, T*) {
   switch (value) {
       {% for literal in type.enum %}
-    case {{namespace}}::{{type.id}}::{{literal | sanitize_literal | dash_to_camelcase | camelcase_to_hacker_style | upper }}:
+    case {{namespace}}::{{type.id}}::{{literal | dash_to_camelcase | camelcase_to_hacker_style | upper | mangle_enum}}:
       return base::WrapUnique(new base::StringValue("{{literal}}"));
       {% endfor %}
   };
diff --git a/headless/lib/browser/types_h.template b/headless/lib/browser/types_h.template
index 51bd895..25b341d 100644
--- a/headless/lib/browser/types_h.template
+++ b/headless/lib/browser/types_h.template
@@ -39,7 +39,7 @@ namespace {{domain.domain | camelcase_to_hacker_style}} {
     {% if "enum" in type %}
 enum class {{type.id}} {
       {% for literal in type.enum %}
-  {{ literal | sanitize_literal | dash_to_camelcase | camelcase_to_hacker_style | upper }}{{',' if not loop.last}}
+  {{ literal | dash_to_camelcase | camelcase_to_hacker_style | upper | mangle_enum}}{{',' if not loop.last}}
       {% endfor %}
 };
 
diff --git a/infra/config/recipes.cfg b/infra/config/recipes.cfg
index acebb64..f3a4e8b 100644
--- a/infra/config/recipes.cfg
+++ b/infra/config/recipes.cfg
@@ -5,17 +5,17 @@ deps {
   project_id: "build"
   url: "https://chromium.googlesource.com/chromium/tools/build.git"
   branch: "master"
-  revision: "08908190287b7639a699eb6ebd2fd3767df4aa96"
+  revision: "18266e6ec0d831d58f3c158bb0cf483c36ddb9dd"
 }
 deps {
   project_id: "depot_tools"
   url: "https://chromium.googlesource.com/chromium/tools/depot_tools.git"
   branch: "master"
-  revision: "4b8ed59b7bab45995f48623f83dd3d46b3854f98"
+  revision: "6a33f2528314b17e7f7643e6fe6401ddd29de205"
 }
 deps {
   project_id: "recipe_engine"
   url: "https://chromium.googlesource.com/external/github.com/luci/recipes-py.git"
   branch: "master"
-  revision: "28882da017c8638118faba38890c54d2507fabc0"
+  revision: "1f4e7683113215117af63084dfef12ef06ac2896"
 }
diff --git a/ios/chrome/BUILD.gn b/ios/chrome/BUILD.gn
index e8897bb..7545222 100644
--- a/ios/chrome/BUILD.gn
+++ b/ios/chrome/BUILD.gn
@@ -58,7 +58,6 @@ test("ios_chrome_unittests") {
     "browser/passwords/password_controller_unittest.mm",
     "browser/passwords/password_generation_agent_unittest.mm",
     "browser/reading_list/reading_list_entry_unittest.cc",
-    "browser/reading_list/reading_list_model_storage_unittest.mm",
     "browser/reading_list/reading_list_model_unittest.cc",
     "browser/signin/chrome_identity_service_observer_bridge_unittest.mm",
     "browser/signin/gaia_auth_fetcher_ios_unittest.mm",
diff --git a/ios/chrome/browser/BUILD.gn b/ios/chrome/browser/BUILD.gn
index e1d7f81..9674f2c 100644
--- a/ios/chrome/browser/BUILD.gn
+++ b/ios/chrome/browser/BUILD.gn
@@ -328,10 +328,6 @@ source_set("browser") {
     "prefs/pref_observer_bridge.h",
     "prefs/pref_observer_bridge.mm",
     "procedural_block_types.h",
-    "reading_list/reading_list_download_service.cc",
-    "reading_list/reading_list_download_service.h",
-    "reading_list/reading_list_download_service_factory.cc",
-    "reading_list/reading_list_download_service_factory.h",
     "reading_list/reading_list_entry.cc",
     "reading_list/reading_list_entry.h",
     "reading_list/reading_list_model.cc",
diff --git a/ios/chrome/browser/browser_state/test_chrome_browser_state.mm b/ios/chrome/browser/browser_state/test_chrome_browser_state.mm
index 88f840b..f52442c 100644
--- a/ios/chrome/browser/browser_state/test_chrome_browser_state.mm
+++ b/ios/chrome/browser/browser_state/test_chrome_browser_state.mm
@@ -71,9 +71,8 @@ std::unique_ptr<KeyedService> BuildBookmarkModel(web::BrowserState* context) {
   return std::move(bookmark_model);
 }
 
-void NotReachedErrorCallback(WebDataServiceWrapper::ErrorType,
-                             sql::InitStatus,
-                             const std::string&) {
+void NotReachedErrorCallback(WebDataServiceWrapper::ErrorType error_type,
+                             sql::InitStatus status) {
   NOTREACHED();
 }
 
diff --git a/ios/chrome/browser/history/history_client_impl.cc b/ios/chrome/browser/history/history_client_impl.cc
index d1c5f7c..35860d1 100644
--- a/ios/chrome/browser/history/history_client_impl.cc
+++ b/ios/chrome/browser/history/history_client_impl.cc
@@ -60,8 +60,8 @@ bool HistoryClientImpl::CanAddURL(const GURL& url) {
   return ios::CanAddURLToHistory(url);
 }
 
-void HistoryClientImpl::NotifyProfileError(sql::InitStatus init_status,
-                                           const std::string& diagnostics) {}
+void HistoryClientImpl::NotifyProfileError(sql::InitStatus init_status) {
+}
 
 std::unique_ptr<history::HistoryBackendClient>
 HistoryClientImpl::CreateBackendClient() {
diff --git a/ios/chrome/browser/history/history_client_impl.h b/ios/chrome/browser/history/history_client_impl.h
index e69d5be..bae4809 100644
--- a/ios/chrome/browser/history/history_client_impl.h
+++ b/ios/chrome/browser/history/history_client_impl.h
@@ -33,8 +33,7 @@ class HistoryClientImpl : public history::HistoryClient,
       history::HistoryService* history_service) override;
   void Shutdown() override;
   bool CanAddURL(const GURL& url) override;
-  void NotifyProfileError(sql::InitStatus init_status,
-                          const std::string& diagnostics) override;
+  void NotifyProfileError(sql::InitStatus init_status) override;
   std::unique_ptr<history::HistoryBackendClient> CreateBackendClient() override;
 
   // bookmarks::BaseBookmarkModelObserver implementation.
diff --git a/ios/chrome/browser/reading_list/reading_list_download_service.cc b/ios/chrome/browser/reading_list/reading_list_download_service.cc
deleted file mode 100644
index a16187b..0000000
--- a/ios/chrome/browser/reading_list/reading_list_download_service.cc
+++ /dev/null
@@ -1,105 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ios/chrome/browser/reading_list/reading_list_download_service.h"
-
-#include <utility>
-
-#include "base/bind.h"
-#include "base/files/file_path.h"
-#include "ios/chrome/browser/reading_list/reading_list_entry.h"
-#include "ios/chrome/browser/reading_list/reading_list_model.h"
-#include "ios/chrome/browser/reading_list/url_downloader.h"
-
-ReadingListDownloadService::ReadingListDownloadService(
-    ReadingListModel* reading_list_model,
-    dom_distiller::DomDistillerService* distiller_service,
-    PrefService* prefs,
-    base::FilePath chrome_profile_path)
-    : reading_list_model_(reading_list_model) {
-  DCHECK(reading_list_model);
-  url_downloader_ = std::unique_ptr<URLDownloader>(
-      new URLDownloader(distiller_service, prefs, chrome_profile_path,
-                        base::Bind(&ReadingListDownloadService::OnDownloadEnd,
-                                   base::Unretained(this)),
-                        base::Bind(&ReadingListDownloadService::OnDeleteEnd,
-                                   base::Unretained(this))));
-}
-
-ReadingListDownloadService::~ReadingListDownloadService() {}
-
-void ReadingListDownloadService::Initialize() {
-  reading_list_model_->AddObserver(this);
-}
-
-void ReadingListDownloadService::Shutdown() {
-  reading_list_model_->RemoveObserver(this);
-}
-
-void ReadingListDownloadService::ReadingListModelLoaded(
-    const ReadingListModel* model) {
-  DCHECK_EQ(reading_list_model_, model);
-  DownloadAllEntries();
-}
-
-void ReadingListDownloadService::ReadingListWillRemoveReadEntry(
-    const ReadingListModel* model,
-    size_t index) {
-  DCHECK_EQ(reading_list_model_, model);
-  RemoveDownloadedEntry(model->GetReadEntryAtIndex(index));
-}
-
-void ReadingListDownloadService::ReadingListWillRemoveUnreadEntry(
-    const ReadingListModel* model,
-    size_t index) {
-  DCHECK_EQ(reading_list_model_, model);
-  RemoveDownloadedEntry(model->GetUnreadEntryAtIndex(index));
-}
-
-void ReadingListDownloadService::ReadingListWillAddUnreadEntry(
-    const ReadingListModel* model,
-    const ReadingListEntry& entry) {
-  DCHECK_EQ(reading_list_model_, model);
-  DownloadEntry(entry);
-}
-
-void ReadingListDownloadService::ReadingListWillAddReadEntry(
-    const ReadingListModel* model,
-    const ReadingListEntry& entry) {
-  DCHECK_EQ(reading_list_model_, model);
-  DownloadEntry(entry);
-}
-
-void ReadingListDownloadService::DownloadAllEntries() {
-  DCHECK(reading_list_model_->loaded());
-  size_t size = reading_list_model_->unread_size();
-  for (size_t i = 0; i < size; i++) {
-    ReadingListEntry entry = reading_list_model_->GetUnreadEntryAtIndex(i);
-    this->DownloadEntry(entry);
-  }
-  size = reading_list_model_->read_size();
-  for (size_t i = 0; i < size; i++) {
-    ReadingListEntry entry = reading_list_model_->GetReadEntryAtIndex(i);
-    this->DownloadEntry(entry);
-  }
-}
-
-void ReadingListDownloadService::DownloadEntry(const ReadingListEntry& entry) {
-  DCHECK(reading_list_model_->loaded());
-  url_downloader_->DownloadOfflineURL(entry.url());
-}
-
-void ReadingListDownloadService::RemoveDownloadedEntry(
-    const ReadingListEntry& entry) {
-  DCHECK(reading_list_model_->loaded());
-  url_downloader_->RemoveOfflineURL(entry.url());
-}
-
-void ReadingListDownloadService::OnDownloadEnd(const GURL& url, bool success) {
-  // TODO(crbug.com/616747) update entry with offline info
-}
-
-void ReadingListDownloadService::OnDeleteEnd(const GURL& url, bool success) {
-  // TODO(crbug.com/616747) update entry with offline info
-}
diff --git a/ios/chrome/browser/reading_list/reading_list_download_service.h b/ios/chrome/browser/reading_list/reading_list_download_service.h
deleted file mode 100644
index 9d3a285..0000000
--- a/ios/chrome/browser/reading_list/reading_list_download_service.h
+++ /dev/null
@@ -1,77 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef IOS_CHROME_BROWSER_READING_LIST_READING_LIST_DOWNLOAD_SERVICE_H_
-#define IOS_CHROME_BROWSER_READING_LIST_READING_LIST_DOWNLOAD_SERVICE_H_
-
-#include "base/macros.h"
-#include "components/keyed_service/core/keyed_service.h"
-#include "ios/chrome/browser/reading_list/reading_list_model_observer.h"
-
-class GURL;
-class PrefService;
-class URLDownloader;
-class ReadingListModel;
-namespace base {
-class FilePath;
-}
-
-namespace dom_distiller {
-class DomDistillerService;
-}
-
-// Observes the reading list and downloads offline versions of its articles.
-// Any calls made to DownloadAllEntries/DownloadEntry before the model is
-// loaded will be ignored. When the model is loaded, DownloadAllEntries will be
-// called automatically.
-class ReadingListDownloadService : public KeyedService,
-                                   public ReadingListModelObserver {
- public:
-  ReadingListDownloadService(
-      ReadingListModel* reading_list_model,
-      dom_distiller::DomDistillerService* distiller_service,
-      PrefService* prefs,
-      base::FilePath chrome_profile_path);
-  ~ReadingListDownloadService() override;
-
-  // Initializes the reading list download service.
-  void Initialize();
-
-  // KeyedService implementation.
-  void Shutdown() override;
-
-  // ReadingListModelObserver implementation
-  void ReadingListModelLoaded(const ReadingListModel* model) override;
-  void ReadingListWillRemoveReadEntry(const ReadingListModel* model,
-                                      size_t index) override;
-  void ReadingListWillRemoveUnreadEntry(const ReadingListModel* model,
-                                        size_t index) override;
-  void ReadingListWillAddUnreadEntry(const ReadingListModel* model,
-                                     const ReadingListEntry& entry) override;
-  void ReadingListWillAddReadEntry(const ReadingListModel* model,
-                                   const ReadingListEntry& entry) override;
-
- private:
-  // Tries to save offline versions of all entries in the reading list that are
-  // not yet saved. Must only be called after reading list model is loaded.
-  void DownloadAllEntries();
-  // Tries to save an offline version of the reading list entry if it is not yet
-  // saved. Must only be called after reading list model is loaded.
-  void DownloadEntry(const ReadingListEntry& entry);
-  // Removes the offline version of the reading list entry if it exists. Must
-  // only be called after reading list model is loaded.
-  void RemoveDownloadedEntry(const ReadingListEntry& entry);
-  // Callback for entry download.
-  void OnDownloadEnd(const GURL& url, bool success);
-
-  // Callback for entry deletion.
-  void OnDeleteEnd(const GURL& url, bool success);
-
-  ReadingListModel* reading_list_model_;
-  std::unique_ptr<URLDownloader> url_downloader_;
-
-  DISALLOW_COPY_AND_ASSIGN(ReadingListDownloadService);
-};
-
-#endif  // IOS_CHROME_BROWSER_READING_LIST_READING_LIST_DOWNLOAD_SERVICE_H_
diff --git a/ios/chrome/browser/reading_list/reading_list_download_service_factory.cc b/ios/chrome/browser/reading_list/reading_list_download_service_factory.cc
deleted file mode 100644
index 7507d79..0000000
--- a/ios/chrome/browser/reading_list/reading_list_download_service_factory.cc
+++ /dev/null
@@ -1,58 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ios/chrome/browser/reading_list/reading_list_download_service_factory.h"
-
-#include "base/files/file_path.h"
-#include "base/memory/singleton.h"
-#include "components/keyed_service/ios/browser_state_dependency_manager.h"
-#include "ios/chrome/browser/browser_state/browser_state_otr_helper.h"
-#include "ios/chrome/browser/browser_state/chrome_browser_state.h"
-#include "ios/chrome/browser/dom_distiller/dom_distiller_service_factory.h"
-#include "ios/chrome/browser/reading_list/reading_list_download_service.h"
-#include "ios/chrome/browser/reading_list/reading_list_model_factory.h"
-
-// static
-ReadingListDownloadService*
-ReadingListDownloadServiceFactory::GetForBrowserState(
-    ios::ChromeBrowserState* browser_state) {
-  return static_cast<ReadingListDownloadService*>(
-      GetInstance()->GetServiceForBrowserState(browser_state, true));
-}
-
-// static
-ReadingListDownloadServiceFactory*
-ReadingListDownloadServiceFactory::GetInstance() {
-  return base::Singleton<ReadingListDownloadServiceFactory>::get();
-}
-
-ReadingListDownloadServiceFactory::ReadingListDownloadServiceFactory()
-    : BrowserStateKeyedServiceFactory(
-          "ReadingListDownloadService",
-          BrowserStateDependencyManager::GetInstance()) {
-  DependsOn(ReadingListModelFactory::GetInstance());
-  DependsOn(dom_distiller::DomDistillerServiceFactory::GetInstance());
-}
-
-ReadingListDownloadServiceFactory::~ReadingListDownloadServiceFactory() {}
-
-std::unique_ptr<KeyedService>
-ReadingListDownloadServiceFactory::BuildServiceInstanceFor(
-    web::BrowserState* context) const {
-  ios::ChromeBrowserState* chrome_browser_state =
-      ios::ChromeBrowserState::FromBrowserState(context);
-  std::unique_ptr<ReadingListDownloadService> reading_list_download_service(
-      new ReadingListDownloadService(
-          ReadingListModelFactory::GetForBrowserState(chrome_browser_state),
-          dom_distiller::DomDistillerServiceFactory::GetForBrowserState(
-              chrome_browser_state),
-          chrome_browser_state->GetPrefs(),
-          chrome_browser_state->GetStatePath()));
-  return std::move(reading_list_download_service);
-}
-
-web::BrowserState* ReadingListDownloadServiceFactory::GetBrowserStateToUse(
-    web::BrowserState* context) const {
-  return GetBrowserStateRedirectedInIncognito(context);
-}
diff --git a/ios/chrome/browser/reading_list/reading_list_download_service_factory.h b/ios/chrome/browser/reading_list/reading_list_download_service_factory.h
deleted file mode 100644
index f8bc94c..0000000
--- a/ios/chrome/browser/reading_list/reading_list_download_service_factory.h
+++ /dev/null
@@ -1,48 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef IOS_CHROME_BROWSER_READING_LIST_READING_LIST_DOWNLOAD_SERVICE_FACTORY_H_
-#define IOS_CHROME_BROWSER_READING_LIST_READING_LIST_DOWNLOAD_SERVICE_FACTORY_H_
-
-#include <memory>
-
-#include "base/macros.h"
-#include "components/keyed_service/ios/browser_state_keyed_service_factory.h"
-
-class ReadingListDownloadService;
-
-namespace base {
-template <typename T>
-struct DefaultSingletonTraits;
-}
-
-namespace ios {
-class ChromeBrowserState;
-}
-
-// Singleton that owns the ReadingListDownloadService and associates it with
-// ios::ChromeBrowserState.
-class ReadingListDownloadServiceFactory
-    : public BrowserStateKeyedServiceFactory {
- public:
-  static ReadingListDownloadService* GetForBrowserState(
-      ios::ChromeBrowserState* browser_state);
-  static ReadingListDownloadServiceFactory* GetInstance();
-
- private:
-  friend struct base::DefaultSingletonTraits<ReadingListDownloadServiceFactory>;
-
-  ReadingListDownloadServiceFactory();
-  ~ReadingListDownloadServiceFactory() override;
-
-  // BrowserStateKeyedServiceFactory implementation.
-  std::unique_ptr<KeyedService> BuildServiceInstanceFor(
-      web::BrowserState* context) const override;
-  web::BrowserState* GetBrowserStateToUse(
-      web::BrowserState* context) const override;
-
-  DISALLOW_COPY_AND_ASSIGN(ReadingListDownloadServiceFactory);
-};
-
-#endif  // IOS_CHROME_BROWSER_READING_LIST_READING_LIST_DOWNLOAD_SERVICE_FACTORY_H_
diff --git a/ios/chrome/browser/reading_list/reading_list_entry.cc b/ios/chrome/browser/reading_list/reading_list_entry.cc
index d60529f..15c0dea 100644
--- a/ios/chrome/browser/reading_list/reading_list_entry.cc
+++ b/ios/chrome/browser/reading_list/reading_list_entry.cc
@@ -5,66 +5,28 @@
 #include "ios/chrome/browser/reading_list/reading_list_entry.h"
 
 ReadingListEntry::ReadingListEntry(const GURL& url, const std::string& title)
-    : url_(url), title_(title), distilled_state_(WAITING) {
+    : url_(url), title_(title) {
   DCHECK(!url.is_empty());
   DCHECK(url.is_valid());
 }
 ReadingListEntry::ReadingListEntry(const ReadingListEntry& entry)
-    : url_(entry.URL()),
-      title_(entry.Title()),
-      distilled_url_(entry.DistilledURL()),
-      distilled_state_(entry.DistilledState()) {}
+    : url_(entry.url()), title_(entry.title()) {}
 ReadingListEntry::~ReadingListEntry() {}
 
-const GURL& ReadingListEntry::URL() const {
+const GURL& ReadingListEntry::url() const {
   return url_;
 }
 
-const std::string ReadingListEntry::Title() const {
+const std::string ReadingListEntry::title() const {
   return title_;
 }
 
-ReadingListEntry::DistillationState ReadingListEntry::DistilledState() const {
-  return distilled_state_;
-}
-
-const GURL& ReadingListEntry::DistilledURL() const {
-  return distilled_url_;
-}
-
 ReadingListEntry& ReadingListEntry::operator=(const ReadingListEntry& other) {
   url_ = other.url_;
   title_ = other.title_;
-  distilled_url_ = other.distilled_url_;
-  distilled_state_ = other.distilled_state_;
   return *this;
 }
 
 bool ReadingListEntry::operator==(const ReadingListEntry& other) const {
   return url_ == other.url_;
 }
-
-void ReadingListEntry::SetTitle(const std::string& title) {
-  title_ = title;
-}
-
-void ReadingListEntry::SetDistilledURL(const GURL& url) {
-  DCHECK(url.is_valid());
-  distilled_url_ = url;
-  distilled_state_ = PROCESSED;
-}
-
-void ReadingListEntry::SetDistilledState(DistillationState distilled_state) {
-  DCHECK(distilled_state != PROCESSED);  // use SetDistilledURL instead.
-  DCHECK(distilled_state != WAITING);
-  distilled_state_ = distilled_state;
-  distilled_url_ = GURL();
-}
-
-// DEPRECATED
-const GURL& ReadingListEntry::url() const {
-  return url_;
-}
-const std::string ReadingListEntry::title() const {
-  return title_;
-}
diff --git a/ios/chrome/browser/reading_list/reading_list_entry.h b/ios/chrome/browser/reading_list/reading_list_entry.h
index cd19c64..f7287b7 100644
--- a/ios/chrome/browser/reading_list/reading_list_entry.h
+++ b/ios/chrome/browser/reading_list/reading_list_entry.h
@@ -18,41 +18,15 @@ class ReadingListEntry {
   ReadingListEntry(const ReadingListEntry& entry);
   ~ReadingListEntry();
 
-  // Entries are created in WAITING state. At some point they will be PROCESSING
-  // into one of the three state: PROCESSED, the only state a distilled URL
-  // would be set, WILL_RETRY, similar to wait, but with exponential delays or
-  // ERROR where the system will not retry at all.
-  enum DistillationState { WAITING, PROCESSING, PROCESSED, WILL_RETRY, ERROR };
-
-  // The URL of the page the user would like to read later.
-  const GURL& URL() const;
-  // The title of the entry. Might be empty.
-  const std::string Title() const;
-  // What state this entry is in.
-  DistillationState DistilledState() const;
-  // The local file URL for the distilled version of the page. This should only
-  // be called if the state is "PROCESSED".
-  const GURL& DistilledURL() const;
+  const GURL& url() const;
+  const std::string title() const;
 
   ReadingListEntry& operator=(const ReadingListEntry& other);
   bool operator==(const ReadingListEntry& other) const;
 
-  // Sets the title.
-  void SetTitle(const std::string& title);
-  // Sets the distilled URL and switch the state to PROCESSED.
-  void SetDistilledURL(const GURL& url);
-  // Sets the state to one of PROCESSING, WILL_RETRY or ERROR.
-  void SetDistilledState(DistillationState distilled_state);
-
-  // DEPRECATED.
-  const GURL& url() const;
-  const std::string title() const;
-
  private:
   GURL url_;
   std::string title_;
-  GURL distilled_url_;
-  DistillationState distilled_state_;
 };
 
 #endif  // IOS_CHROME_BROWSER_READING_LIST_READING_LIST_ENTRY_H_
diff --git a/ios/chrome/browser/reading_list/reading_list_entry_unittest.cc b/ios/chrome/browser/reading_list/reading_list_entry_unittest.cc
index 215c3fd..1bb920b 100644
--- a/ios/chrome/browser/reading_list/reading_list_entry_unittest.cc
+++ b/ios/chrome/browser/reading_list/reading_list_entry_unittest.cc
@@ -25,28 +25,5 @@ TEST(ReadingListEntry, CopyAreEquals) {
   const ReadingListEntry e2(e1);
 
   EXPECT_EQ(e1, e2);
-  EXPECT_EQ(e1.Title(), e2.Title());
-}
-
-TEST(ReadingListEntry, DistilledURL) {
-  ReadingListEntry e(GURL("http://example.com"), "bar");
-
-  EXPECT_FALSE(e.DistilledURL().is_valid());
-
-  const GURL distilled_url("http://distilled.example.com");
-  e.SetDistilledURL(distilled_url);
-  EXPECT_EQ(distilled_url, e.DistilledURL());
-}
-
-TEST(ReadingListEntry, DistilledState) {
-  ReadingListEntry e(GURL("http://example.com"), "bar");
-
-  EXPECT_EQ(ReadingListEntry::WAITING, e.DistilledState());
-
-  e.SetDistilledState(ReadingListEntry::ERROR);
-  EXPECT_EQ(ReadingListEntry::ERROR, e.DistilledState());
-
-  const GURL distilled_url("http://distilled.example.com");
-  e.SetDistilledURL(distilled_url);
-  EXPECT_EQ(ReadingListEntry::PROCESSED, e.DistilledState());
+  EXPECT_EQ(e1.title(), e2.title());
 }
diff --git a/ios/chrome/browser/reading_list/reading_list_model_storage_defaults.h b/ios/chrome/browser/reading_list/reading_list_model_storage_defaults.h
index c070095..1f4fc1b 100644
--- a/ios/chrome/browser/reading_list/reading_list_model_storage_defaults.h
+++ b/ios/chrome/browser/reading_list/reading_list_model_storage_defaults.h
@@ -9,20 +9,11 @@
 #include "ios/chrome/browser/reading_list/reading_list_model_storage.h"
 
 class ReadingListModel;
-#ifdef __OBJC__
-@class NSUserDefaults;
-#else
-typedef struct objc_object NSUserDefaults;
-#endif
 
 // Implementation of ReadingListModelStorage that stores reading list items in
 // the system user defaults.
 class ReadingListModelStorageDefaults : public ReadingListModelStorage {
  public:
-  ReadingListModelStorageDefaults();
-  ReadingListModelStorageDefaults(NSUserDefaults* backend);
-  ~ReadingListModelStorageDefaults();
-
   std::vector<ReadingListEntry> LoadPersistentReadList() override;
   std::vector<ReadingListEntry> LoadPersistentUnreadList() override;
   bool LoadPersistentHasUnseen() override;
@@ -32,9 +23,6 @@ class ReadingListModelStorageDefaults : public ReadingListModelStorage {
   void SavePersistentUnreadList(
       const std::vector<ReadingListEntry>& unread) override;
   void SavePersistentHasUnseen(bool has_unseen) override;
-
- private:
-  NSUserDefaults* backend_;
 };
 
-#endif  // IOS_CHROME_BROWSER_READING_LIST_READING_LIST_MODEL_STORAGE_DEFAULTS_H_
+#endif  // IOS_CHROME_BROWSER_READING_LIST_READING_LIST_MODEL_STORAGE_DEFAULTS_H_
\ No newline at end of file
diff --git a/ios/chrome/browser/reading_list/reading_list_model_storage_defaults.mm b/ios/chrome/browser/reading_list/reading_list_model_storage_defaults.mm
index 532e119..8c16429 100644
--- a/ios/chrome/browser/reading_list/reading_list_model_storage_defaults.mm
+++ b/ios/chrome/browser/reading_list/reading_list_model_storage_defaults.mm
@@ -17,8 +17,6 @@ NSString* const kReadingListUnreadElements = @"ReadingListUnreadElements";
 NSString* const kReadingListUnseenState = @"ReadingListUnseenState";
 NSString* const kReadingListEntryTitleKey = @"title";
 NSString* const kReadingListEntryURLKey = @"URL";
-NSString* const kReadingListEntryStateKey = @"state";
-NSString* const kReadingListEntryDistilledURLKey = @"distilledURL";
 
 ReadingListEntry DecodeReadingListEntry(NSData* data) {
   NSError* error = nil;
@@ -28,75 +26,28 @@ ReadingListEntry DecodeReadingListEntry(NSData* data) {
       [dictionary objectForKey:kReadingListEntryTitleKey]);
   NSURL* url = base::mac::ObjCCastStrict<NSURL>(
       [dictionary objectForKey:kReadingListEntryURLKey]);
-  auto state(static_cast<ReadingListEntry::DistillationState>(
-      [[dictionary objectForKey:kReadingListEntryStateKey] intValue]));
   DCHECK(title && url);
   GURL gurl(net::GURLWithNSURL(url));
   DCHECK(gurl.is_valid());
-  ReadingListEntry entry(gurl, base::SysNSStringToUTF8(title));
-
-  switch (state) {
-    case ReadingListEntry::PROCESSED: {
-      NSURL* distilled_url = base::mac::ObjCCastStrict<NSURL>(
-          [dictionary objectForKey:kReadingListEntryDistilledURLKey]);
-      DCHECK(distilled_url);
-      GURL distilled_gurl(net::GURLWithNSURL(distilled_url));
-      DCHECK(distilled_gurl.is_valid());
-      entry.SetDistilledURL(distilled_gurl);
-      break;
-    }
-    case ReadingListEntry::PROCESSING:
-    case ReadingListEntry::WILL_RETRY:
-    case ReadingListEntry::ERROR:
-      entry.SetDistilledState(state);
-      break;
-    case ReadingListEntry::WAITING:
-      break;
-  }
-
-  return entry;
+  return ReadingListEntry(gurl, base::SysNSStringToUTF8(title));
 }
 
 NSData* EncodeReadingListEntry(const ReadingListEntry& entry) {
-  NSMutableDictionary* dictionary =
-      [NSMutableDictionary dictionaryWithDictionary:@{
-        kReadingListEntryTitleKey : base::SysUTF8ToNSString(entry.Title()),
-        kReadingListEntryURLKey : net::NSURLWithGURL(entry.URL()),
-        kReadingListEntryStateKey :
-            [NSNumber numberWithInt:entry.DistilledState()]
-      }];
-
-  const GURL distilled_gurl(entry.DistilledURL());
-  if (distilled_gurl.is_valid()) {
-    NSURL* distilled_url = net::NSURLWithGURL(distilled_gurl);
-    if (distilled_url)
-      [dictionary setObject:distilled_url
-                     forKey:kReadingListEntryDistilledURLKey];
-  }
+  NSDictionary* dictionary = @{
+    kReadingListEntryTitleKey : base::SysUTF8ToNSString(entry.title()),
+    kReadingListEntryURLKey : net::NSURLWithGURL(entry.url())
+  };
   return [NSKeyedArchiver archivedDataWithRootObject:dictionary];
 }
 
 }  // namespace
 
-ReadingListModelStorageDefaults::ReadingListModelStorageDefaults() {
-  backend_ = [[NSUserDefaults standardUserDefaults] retain];
-}
-
-ReadingListModelStorageDefaults::ReadingListModelStorageDefaults(
-    NSUserDefaults* backend) {
-  DCHECK(backend);
-  backend_ = [backend retain];
-}
-
-ReadingListModelStorageDefaults::~ReadingListModelStorageDefaults() {
-  [backend_ release];
-}
-
 std::vector<ReadingListEntry>
 ReadingListModelStorageDefaults::LoadPersistentReadList() {
   std::vector<ReadingListEntry> read;
-  NSArray* readList = base::mac::ObjCCastStrict<NSArray>(
-      [backend_ objectForKey:kReadingListReadElements]);
+  NSArray* readList =
+      base::mac::ObjCCastStrict<NSArray>([[NSUserDefaults standardUserDefaults]
+          objectForKey:kReadingListReadElements]);
   if (readList) {
     for (NSData* entryData : readList) {
       read.push_back(DecodeReadingListEntry(entryData));
@@ -108,8 +59,9 @@ ReadingListModelStorageDefaults::LoadPersistentReadList() {
 std::vector<ReadingListEntry>
 ReadingListModelStorageDefaults::LoadPersistentUnreadList() {
   std::vector<ReadingListEntry> unread;
-  NSArray* unreadList = base::mac::ObjCCastStrict<NSArray>(
-      [backend_ objectForKey:kReadingListUnreadElements]);
+  NSArray* unreadList =
+      base::mac::ObjCCastStrict<NSArray>([[NSUserDefaults standardUserDefaults]
+          objectForKey:kReadingListUnreadElements]);
   if (unreadList) {
     for (NSData* entryData : unreadList) {
       unread.push_back(DecodeReadingListEntry(entryData));
@@ -119,7 +71,8 @@ ReadingListModelStorageDefaults::LoadPersistentUnreadList() {
 }
 
 bool ReadingListModelStorageDefaults::LoadPersistentHasUnseen() {
-  return [[backend_ objectForKey:kReadingListUnseenState] boolValue];
+  return [[[NSUserDefaults standardUserDefaults]
+      objectForKey:kReadingListUnseenState] boolValue];
 }
 
 void ReadingListModelStorageDefaults::SavePersistentReadList(
@@ -128,7 +81,8 @@ void ReadingListModelStorageDefaults::SavePersistentReadList(
   for (const ReadingListEntry& entry : read) {
     [read_list addObject:EncodeReadingListEntry(entry)];
   }
-  [backend_ setObject:read_list forKey:kReadingListReadElements];
+  [[NSUserDefaults standardUserDefaults] setObject:read_list
+                                            forKey:kReadingListReadElements];
 }
 
 void ReadingListModelStorageDefaults::SavePersistentUnreadList(
@@ -138,10 +92,12 @@ void ReadingListModelStorageDefaults::SavePersistentUnreadList(
   for (const ReadingListEntry& entry : unread) {
     [unread_list addObject:EncodeReadingListEntry(entry)];
   }
-  [backend_ setObject:unread_list forKey:kReadingListUnreadElements];
+  [[NSUserDefaults standardUserDefaults] setValue:unread_list
+                                           forKey:kReadingListUnreadElements];
 }
 
 void ReadingListModelStorageDefaults::SavePersistentHasUnseen(bool has_unseen) {
-  [backend_ setObject:[NSNumber numberWithBool:has_unseen]
-               forKey:kReadingListUnseenState];
+  [[NSUserDefaults standardUserDefaults]
+      setObject:[NSNumber numberWithBool:has_unseen]
+         forKey:kReadingListUnseenState];
 }
diff --git a/ios/chrome/browser/reading_list/reading_list_model_storage_unittest.mm b/ios/chrome/browser/reading_list/reading_list_model_storage_unittest.mm
deleted file mode 100644
index 7b5cd8d..0000000
--- a/ios/chrome/browser/reading_list/reading_list_model_storage_unittest.mm
+++ /dev/null
@@ -1,88 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#import <Foundation/Foundation.h>
-
-#include "base/mac/scoped_nsobject.h"
-#include "ios/chrome/browser/reading_list/reading_list_model_storage_defaults.h"
-#include "testing/gtest/include/gtest/gtest.h"
-
-namespace {
-NSUserDefaults* FakeNonPersistentUserDefaults() {
-  // Storage only uses two methods on NSUserDefaults: -setObject:forKey: and
-  // -objectForKey:, a dictionary is a perfect replacement for it. If it looks
-  // like a duck, swims like a duck and quacks as a duck, then it probably is a
-  // duck.
-  return (NSUserDefaults*)[[[NSMutableDictionary alloc] init] autorelease];
-}
-}
-
-TEST(ReadingListStorage, CheckEmpties) {
-  ReadingListModelStorageDefaults storage(FakeNonPersistentUserDefaults());
-
-  std::vector<ReadingListEntry> entries;
-
-  entries = storage.LoadPersistentReadList();
-  EXPECT_EQ(0ul, entries.size());
-  entries = storage.LoadPersistentUnreadList();
-  EXPECT_EQ(0ul, entries.size());
-}
-
-TEST(ReadingListStorage, SaveOneRead) {
-  NSUserDefaults* defaults = FakeNonPersistentUserDefaults();
-  static const std::vector<ReadingListEntry> entries{
-      ReadingListEntry(GURL("http://read.example.com"), "read title")};
-
-  {
-    ReadingListModelStorageDefaults storage(defaults);
-    storage.SavePersistentReadList(entries);
-  }
-
-  ReadingListModelStorageDefaults storage(defaults);
-
-  const std::vector<ReadingListEntry> restored_entries(
-      storage.LoadPersistentReadList());
-  EXPECT_EQ(1ul, restored_entries.size());
-  EXPECT_EQ(GURL("http://read.example.com"), restored_entries[0].URL());
-  EXPECT_EQ("read title", restored_entries[0].Title());
-  EXPECT_EQ("read title", restored_entries[0].Title());
-}
-
-TEST(ReadingListStorage, SaveOneUnead) {
-  NSUserDefaults* defaults = FakeNonPersistentUserDefaults();
-  static const std::vector<ReadingListEntry> entries{
-      ReadingListEntry(GURL("http://unread.example.com"), "unread title")};
-
-  {
-    ReadingListModelStorageDefaults storage(defaults);
-    storage.SavePersistentUnreadList(entries);
-  }
-
-  ReadingListModelStorageDefaults storage(defaults);
-  const std::vector<ReadingListEntry> restored_entries(
-      storage.LoadPersistentUnreadList());
-  EXPECT_EQ(1ul, restored_entries.size());
-  EXPECT_EQ(GURL("http://unread.example.com"), restored_entries[0].URL());
-  EXPECT_EQ("unread title", restored_entries[0].Title());
-}
-
-TEST(ReadingListStorage, SaveOneModified) {
-  NSUserDefaults* defaults = FakeNonPersistentUserDefaults();
-  static std::vector<ReadingListEntry> entries{
-      ReadingListEntry(GURL("http://unread.example.com"), "unread title")};
-  {
-    ReadingListModelStorageDefaults storage(defaults);
-    entries[0].SetDistilledURL(GURL("http://distilled.example.com"));
-    storage.SavePersistentUnreadList(entries);
-  }
-
-  ReadingListModelStorageDefaults storage(defaults);
-  const std::vector<ReadingListEntry> restored_entries(
-      storage.LoadPersistentUnreadList());
-  EXPECT_EQ(1ul, restored_entries.size());
-  EXPECT_EQ(GURL("http://unread.example.com"), restored_entries[0].URL());
-  EXPECT_EQ(GURL("http://distilled.example.com"),
-            restored_entries[0].DistilledURL());
-  EXPECT_EQ("unread title", restored_entries[0].Title());
-}
diff --git a/ios/chrome/browser/reading_list/reading_list_model_unittest.cc b/ios/chrome/browser/reading_list/reading_list_model_unittest.cc
index 37dd965..dc689a4 100644
--- a/ios/chrome/browser/reading_list/reading_list_model_unittest.cc
+++ b/ios/chrome/browser/reading_list/reading_list_model_unittest.cc
@@ -115,8 +115,8 @@ TEST_F(ReadingListModelTest, AddEntry) {
   ClearCounts();
   const ReadingListEntry entry =
       model_->AddEntry(GURL("http://example.com"), "sample");
-  EXPECT_EQ(GURL("http://example.com"), entry.URL());
-  EXPECT_EQ("sample", entry.Title());
+  EXPECT_EQ(GURL("http://example.com"), entry.url());
+  EXPECT_EQ("sample", entry.title());
 
   AssertObserverCount(0, 0, 0, 0, 0, 0, 0, 1, 0, 1);
   EXPECT_EQ(1ul, model_->unread_size());
@@ -124,8 +124,8 @@ TEST_F(ReadingListModelTest, AddEntry) {
   EXPECT_TRUE(model_->HasUnseenEntries());
 
   const ReadingListEntry other_entry = model_->GetUnreadEntryAtIndex(0);
-  EXPECT_EQ(GURL("http://example.com"), other_entry.URL());
-  EXPECT_EQ("sample", other_entry.Title());
+  EXPECT_EQ(GURL("http://example.com"), other_entry.url());
+  EXPECT_EQ("sample", other_entry.title());
 }
 
 TEST_F(ReadingListModelTest, ReadEntry) {
@@ -140,8 +140,8 @@ TEST_F(ReadingListModelTest, ReadEntry) {
   EXPECT_FALSE(model_->HasUnseenEntries());
 
   const ReadingListEntry other_entry = model_->GetReadEntryAtIndex(0);
-  EXPECT_EQ(GURL("http://example.com"), other_entry.URL());
-  EXPECT_EQ("sample", other_entry.Title());
+  EXPECT_EQ(GURL("http://example.com"), other_entry.url());
+  EXPECT_EQ("sample", other_entry.title());
 }
 
 TEST_F(ReadingListModelTest, BatchUpdates) {
diff --git a/ios/chrome/browser/ui/autofill/autofill_client_ios.mm b/ios/chrome/browser/ui/autofill/autofill_client_ios.mm
index 31d7956..b8a2e7f 100644
--- a/ios/chrome/browser/ui/autofill/autofill_client_ios.mm
+++ b/ios/chrome/browser/ui/autofill/autofill_client_ios.mm
@@ -8,7 +8,6 @@
 
 #include "base/bind.h"
 #include "base/memory/ptr_util.h"
-#include "components/autofill/core/browser/autofill_credit_card_filling_infobar_delegate_mobile.h"
 #include "components/autofill/core/browser/autofill_save_card_infobar_delegate_mobile.h"
 #include "components/autofill/core/browser/autofill_save_card_infobar_mobile.h"
 #include "components/autofill/core/browser/ui/card_unmask_prompt_view.h"
@@ -23,7 +22,6 @@
 #include "ios/chrome/browser/application_context.h"
 #include "ios/chrome/browser/autofill/personal_data_manager_factory.h"
 #include "ios/chrome/browser/browser_state/chrome_browser_state.h"
-#include "ios/chrome/browser/infobars/infobar_utils.h"
 #include "ios/chrome/browser/web_data_service_factory.h"
 #include "ios/public/provider/chrome/browser/chrome_browser_provider.h"
 
@@ -114,14 +112,7 @@ void AutofillClientIOS::ConfirmSaveCreditCardToCloud(
 void AutofillClientIOS::ConfirmCreditCardFillAssist(
     const CreditCard& card,
     const base::Closure& callback) {
-  auto infobar_delegate =
-      base::MakeUnique<AutofillCreditCardFillingInfoBarDelegateMobile>(
-          card, callback);
-  auto* raw_delegate = infobar_delegate.get();
-  if (infobar_manager_->AddInfoBar(
-          ::CreateConfirmInfoBar(std::move(infobar_delegate)))) {
-    raw_delegate->set_was_shown();
-  }
+  NOTREACHED();
 }
 
 void AutofillClientIOS::LoadRiskData(
diff --git a/ios/chrome/browser/web_data_service_factory.cc b/ios/chrome/browser/web_data_service_factory.cc
index 6a81f74..b49f331 100644
--- a/ios/chrome/browser/web_data_service_factory.cc
+++ b/ios/chrome/browser/web_data_service_factory.cc
@@ -25,8 +25,8 @@ namespace ios {
 namespace {
 
 void DoNothingOnErrorCallback(WebDataServiceWrapper::ErrorType error_type,
-                              sql::InitStatus status,
-                              const std::string& diagnostics) {}
+                              sql::InitStatus status) {
+}
 
 }  // namespace
 
diff --git a/mojo/android/BUILD.gn b/mojo/android/BUILD.gn
index 2b4db7a..813701c 100644
--- a/mojo/android/BUILD.gn
+++ b/mojo/android/BUILD.gn
@@ -102,10 +102,6 @@ android_library("mojo_javatests") {
     "//mojo/public/java:bindings",
     "//mojo/public/java:system",
   ]
-
-  data = [
-    "//mojo/public/interfaces/bindings/tests/data/validation/",
-  ]
 }
 
 shared_library("mojo_java_unittests") {
@@ -145,4 +141,5 @@ instrumentation_test_apk("mojo_test_apk") {
   shared_libraries = [ ":mojo_java_unittests" ]
   apk_name = "MojoTest"
   android_manifest = "javatests/AndroidManifest.xml"
+  isolate_file = "../mojo_test_apk.isolate"
 }
diff --git a/mojo/common/BUILD.gn b/mojo/common/BUILD.gn
index 428ee1e..2edfb6d 100644
--- a/mojo/common/BUILD.gn
+++ b/mojo/common/BUILD.gn
@@ -48,7 +48,6 @@ component("common_base") {
 mojom("test_common_custom_types") {
   sources = [
     "test_common_custom_types.mojom",
-    "traits_test_service.mojom",
   ]
   public_deps = [
     ":common_custom_types",
@@ -75,7 +74,6 @@ test("mojo_common_unittests") {
   sources = [
     "common_custom_types_unittest.cc",
     "common_type_converters_unittest.cc",
-    "struct_traits_unittest.cc",
   ]
 }
 
diff --git a/mojo/common/OWNERS b/mojo/common/OWNERS
index b567079..7daaf52 100644
--- a/mojo/common/OWNERS
+++ b/mojo/common/OWNERS
@@ -1,6 +1,4 @@
-per-file *_type_converter*.*=set noparent
-per-file *_type_converter*.*=file://ipc/SECURITY_OWNERS
 per-file *.mojom=set noparent
 per-file *.mojom=file://ipc/SECURITY_OWNERS
-per-file *_struct_traits*.*=set noparent
-per-file *_struct_traits*.*=file://ipc/SECURITY_OWNERS
+per-file *_type_converter*.*=set noparent
+per-file *_type_converter*.*=file://ipc/SECURITY_OWNERS
diff --git a/mojo/common/common_custom_types.mojom b/mojo/common/common_custom_types.mojom
index 1eca3a5..ba8d397 100644
--- a/mojo/common/common_custom_types.mojom
+++ b/mojo/common/common_custom_types.mojom
@@ -24,8 +24,3 @@ struct TimeTicks;
 
 [Native]
 struct String16;
-
-// Corresponds to |base::Version| in base/version.h
-struct Version {
-  array<uint32> components;
-};
diff --git a/mojo/common/common_custom_types.typemap b/mojo/common/common_custom_types.typemap
index fa56d7f..6a3c188 100644
--- a/mojo/common/common_custom_types.typemap
+++ b/mojo/common/common_custom_types.typemap
@@ -8,15 +8,8 @@ public_headers = [
   "//base/strings/string16.h",
   "//base/time/time.h",
   "//base/values.h",
-  "//base/version.h",
-]
-traits_headers = [
-  "//ipc/ipc_message_utils.h",
-  "//mojo/common/common_custom_types_struct_traits.h",
-]
-sources = [
-  "//mojo/common/common_custom_types_struct_traits.cc",
 ]
+traits_headers = [ "//ipc/ipc_message_utils.h" ]
 public_deps = [
   "//ipc",
 ]
@@ -29,5 +22,4 @@ type_mappings = [
   "mojo.common.mojom.Time=base::Time[copyable_pass_by_value]",
   "mojo.common.mojom.TimeDelta=base::TimeDelta[copyable_pass_by_value]",
   "mojo.common.mojom.TimeTicks=base::TimeTicks[copyable_pass_by_value]",
-  "mojo.common.mojom.Version=base::Version",
 ]
diff --git a/mojo/common/common_custom_types_struct_traits.cc b/mojo/common/common_custom_types_struct_traits.cc
deleted file mode 100644
index 2bb7a6e..0000000
--- a/mojo/common/common_custom_types_struct_traits.cc
+++ /dev/null
@@ -1,32 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "mojo/common/common_custom_types_struct_traits.h"
-
-#include <iterator>
-
-#include "base/version.h"
-
-namespace mojo {
-
-// static
-const std::vector<uint32_t>&
-StructTraits<mojo::common::mojom::Version, base::Version>::components(
-    const base::Version& version) {
-  return version.components();
-}
-
-// static
-bool StructTraits<mojo::common::mojom::Version, base::Version>::Read(
-    mojo::common::mojom::VersionDataView data,
-    base::Version* out) {
-  std::vector<uint32_t> components;
-  if (!data.ReadComponents(&components))
-    return false;
-
-  *out = base::Version(base::Version(std::move(components)));
-  return out->IsValid();
-}
-
-}  // namespace mojo
diff --git a/mojo/common/common_custom_types_struct_traits.h b/mojo/common/common_custom_types_struct_traits.h
deleted file mode 100644
index f3190f9..0000000
--- a/mojo/common/common_custom_types_struct_traits.h
+++ /dev/null
@@ -1,25 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef MOJO_COMMON_COMMON_CUSTOM_TYPES_STRUCT_TRAITS_H_
-#define MOJO_COMMON_COMMON_CUSTOM_TYPES_STRUCT_TRAITS_H_
-
-#include "mojo/common/common_custom_types.mojom.h"
-
-namespace base {
-class Version;
-}
-
-namespace mojo {
-
-template <>
-struct StructTraits<mojo::common::mojom::Version, base::Version> {
-  static const std::vector<uint32_t>& components(const base::Version& version);
-  static bool Read(mojo::common::mojom::VersionDataView data,
-                   base::Version* out);
-};
-
-}  // namespace mojo
-
-#endif  // MOJO_COMMON_COMMON_CUSTOM_TYPES_STRUCT_TRAITS_H_
diff --git a/mojo/common/common_custom_types_struct_traits_unittest.cc b/mojo/common/common_custom_types_struct_traits_unittest.cc
deleted file mode 100644
index e69de29..0000000
diff --git a/mojo/common/struct_traits_unittest.cc b/mojo/common/struct_traits_unittest.cc
deleted file mode 100644
index 054519d..0000000
--- a/mojo/common/struct_traits_unittest.cc
+++ /dev/null
@@ -1,49 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "base/message_loop/message_loop.h"
-#include "mojo/common/traits_test_service.mojom.h"
-#include "mojo/public/cpp/bindings/binding_set.h"
-#include "testing/gtest/include/gtest/gtest.h"
-
-namespace mojo {
-namespace common {
-namespace {
-
-class StructTraitsTest : public testing::Test, public mojom::TraitsTestService {
- public:
-  StructTraitsTest() {}
-
- protected:
-  mojom::TraitsTestServicePtr GetTraitsTestProxy() {
-    return traits_test_bindings_.CreateInterfacePtrAndBind(this);
-  }
-
- private:
-  // TraitsTestService:
-  void EchoVersion(const base::Version& m,
-                   const EchoVersionCallback& callback) override {
-    callback.Run(m);
-  }
-
-  base::MessageLoop loop_;
-  mojo::BindingSet<TraitsTestService> traits_test_bindings_;
-
-  DISALLOW_COPY_AND_ASSIGN(StructTraitsTest);
-};
-
-TEST_F(StructTraitsTest, Version) {
-  const std::string& version_str = "1.2.3.4";
-  base::Version input(version_str);
-  mojom::TraitsTestServicePtr proxy = GetTraitsTestProxy();
-  base::Version output;
-  proxy->EchoVersion(input, &output);
-  base::Version test_version(version_str);
-
-  EXPECT_EQ(version_str, output.GetString());
-}
-
-}  // namespace
-}  // namespace common
-}  // namespace mojo
diff --git a/mojo/common/traits_test_service.mojom b/mojo/common/traits_test_service.mojom
deleted file mode 100644
index 9ea63a1..0000000
--- a/mojo/common/traits_test_service.mojom
+++ /dev/null
@@ -1,14 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-module mojo.common.mojom;
-
-import "mojo/common/common_custom_types.mojom";
-
-// All functions on this interface echo their arguments to test StructTraits
-// serialization and deserialization.
-interface TraitsTestService {
-  [Sync]
-  EchoVersion(Version v) => (Version pass);
-};
diff --git a/mojo/mojo_test_apk.isolate b/mojo/mojo_test_apk.isolate
new file mode 100644
index 0000000..e08c1be
--- /dev/null
+++ b/mojo/mojo_test_apk.isolate
@@ -0,0 +1,11 @@
+# Copyright 2016 The Chromium Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+
+{
+  'variables': {
+    'files': [
+      '<(DEPTH)/mojo/public/interfaces/bindings/tests/data/validation/',
+    ],
+  },
+}
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl
index c27708f..efb9db6 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module.cc.tmpl
@@ -129,6 +129,7 @@ const {{constant.kind|cpp_pod_type}} {{struct.name}}::{{constant.name}} = {{cons
 {%- for struct in structs %}
 {%-   if not struct|is_native_only_kind %}
 {%-     include "wrapper_class_definition.tmpl" %}
+{%-     include "struct_data_view_definition.tmpl" %}
 {%-   endif %}
 {%- endfor %}
 
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl
index 3048d37..2daf6e6 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/module.h.tmpl
@@ -274,7 +274,6 @@ namespace std {
 {%- for struct in structs %}
 {%-   if not struct|is_native_only_kind %}
 {%      include "wrapper_class_template_definition.tmpl" %}
-{%      include "struct_data_view_definition.tmpl" %}
 {%-   endif %}
 
 {%-   if struct.enums %}
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/struct_data_view_declaration.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/struct_data_view_declaration.tmpl
index 4a4948c..575a331 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/struct_data_view_declaration.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/struct_data_view_declaration.tmpl
@@ -17,7 +17,7 @@ class {{struct.name}}DataView {
 {%-   set kind = pf.field.kind %}
 {%-   set name = pf.field.name %}
 {%-   if kind|is_union_kind %}
-  inline void Get{{name|under_to_camel}}DataView(
+  void Get{{name|under_to_camel}}DataView(
       {{kind|cpp_data_view_type}}* output);
 
   bool Read{{name|under_to_camel}}({{kind|cpp_wrapper_type}}* output) {
@@ -32,7 +32,7 @@ class {{struct.name}}DataView {
 }
 
 {%-   elif kind|is_object_kind %}
-  inline void Get{{name|under_to_camel}}DataView(
+  void Get{{name|under_to_camel}}DataView(
       {{kind|cpp_data_view_type}}* output);
 
   template <typename UserType>
diff --git a/mojo/public/tools/bindings/generators/cpp_templates/struct_data_view_definition.tmpl b/mojo/public/tools/bindings/generators/cpp_templates/struct_data_view_definition.tmpl
index 95311dc..1702533 100644
--- a/mojo/public/tools/bindings/generators/cpp_templates/struct_data_view_definition.tmpl
+++ b/mojo/public/tools/bindings/generators/cpp_templates/struct_data_view_definition.tmpl
@@ -3,7 +3,7 @@
 {%-   set name = pf.field.name %}
 
 {%-   if kind|is_union_kind %}
-inline void {{struct.name}}DataView::Get{{name|under_to_camel}}DataView(
+void {{struct.name}}DataView::Get{{name|under_to_camel}}DataView(
     {{kind|cpp_data_view_type}}* output) {
 {%-     if pf.min_version != 0 %}
   auto pointer = data_->header_.version >= {{pf.min_version}}
@@ -15,7 +15,7 @@ inline void {{struct.name}}DataView::Get{{name|under_to_camel}}DataView(
 }
 
 {%-   elif kind|is_object_kind %}
-inline void {{struct.name}}DataView::Get{{name|under_to_camel}}DataView(
+void {{struct.name}}DataView::Get{{name|under_to_camel}}DataView(
     {{kind|cpp_data_view_type}}* output) {
 {%-     if pf.min_version != 0 %}
   auto pointer = data_->header_.version >= {{pf.min_version}}
diff --git a/net/base/net_string_util_icu_alternatives_android.cc b/net/base/net_string_util_icu_alternatives_android.cc
index 1b56c48..237b698 100644
--- a/net/base/net_string_util_icu_alternatives_android.cc
+++ b/net/base/net_string_util_icu_alternatives_android.cc
@@ -9,8 +9,6 @@
 #include "jni/NetStringUtil_jni.h"
 #include "net/base/net_string_util.h"
 
-using base::android::ScopedJavaLocalRef;
-
 namespace net {
 
 namespace {
diff --git a/net/data/fuzzer_dictionaries/net_mime_sniffer_fuzzer.dict b/net/data/fuzzer_dictionaries/net_mime_sniffer_fuzzer.dict
index 2713b56..ec42dd9 100644
--- a/net/data/fuzzer_dictionaries/net_mime_sniffer_fuzzer.dict
+++ b/net/data/fuzzer_dictionaries/net_mime_sniffer_fuzzer.dict
@@ -2,11 +2,8 @@
 # Use of this source code is governed by a BSD-style license that can be
 # found in the LICENSE file.
 
-# Lines 7-299 of this file were generated with
-# testing/libfuzzer/dictionary_generator.py using net_mime_sniffer_fuzzer
-# binary and RFC 2045.
-# The rest was created semimanually based on net/base/mime_sniffer.cc.
-
+# This file has been generated with testing/libfuzzer/dictionary_generator.py
+# using net_mime_sniffer_fuzzer binary and RFC 2045.
 "all"
 "BASE64"
 "US-ASCII."
@@ -299,149 +296,4 @@
 "the"
 "avoid"
 "If"
-"application/xhtml+xml"
-"<html xmlns=\"http://www.w3.org/1999/xhtml\""
-"application/atom+xml"
-"application/rss+xml"
-"<rss"
-"<feed"
-"\xFE\xFF"
-"\xFF\xFE"
-"\xEF\xBB\xBF"
-"unknown/unknown"
-"application/unknown"
-"*/*"
-"application/x-chrome-extension"
-"Cr24\x02\x00\x00\x00"
-"ftp"
-"content"
-"application/msword"
-"application/vnd.ms-excel"
-"application/vnd.ms-powerpoint"
-"application/vnd.openxmlformats-officedocument.wordprocessingml.document"
-"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
-"application/vnd.openxmlformats-officedocument.presentationml.presentation"
-"application/vnd.ms-excel.sheet.macroenabled.12"
-"application/vnd.ms-powerpoint.presentation.macroenabled.12"
-"application/mspowerpoint"
-"application/msexcel"
-"application/vnd.ms-word"
-"application/vnd.ms-word.document.12"
-"application/vnd.msword"
-"text/html"
-"text/xml"
-"application/xml"
-"CFB"
-"\xD0\xCF\x11\xE0\xA1\xB1\x1A\xE1"
-"PK\x03\x04"
-"OOXML"
-"image/x-xbitmap"
-"#define"
-"image/x-icon"
-"\x00\x00\x01\x00"
-"image/svg+xml"
-"<?xml_version="
-"audio/wav"
-"RIFF....WAVEfmt "
-"video/avi"
-"RIFF....AVI LIST"
-"audio/ogg"
-"OggS"
-"video/mpeg"
-"\x00\x00\x01\xB0", "\xFF\xFF\xFF\xF0"
-"audio/mpeg"
-"\xFF\xE0", "\xFF\xE0"
-"....ftyp3g"
-"video/3gpp"
-"....ftypavcl"
-"video/mp4"
-"....ftyp"
-"video/quicktime"
-"....moov"
-"application/x-shockwave-flash"
-"CWS"
-"FWS"
-"video/x-flv"
-"FLV"
-"audio/x-flac"
-"fLaC"
-"image/x-canon-cr2"
-"II\x2a\x00\x10\x00\x00\x00CR"
-"image/x-canon-crw"
-"II\x1a\x00\x00\x00HEAPCCDR"
-"image/x-minolta-mrw"
-"\x00MRM"
-"MMOR"
-"IIRO"
-"image/x-olympus-orf"
-"IIRS"
-"image/x-fuji-raf"
-"FUJIFILMCCD-RAW"
-"image/x-panasonic-raw"
-"IIU\x00\x08\x00\x00\x00"
-"IIU\x00\x18\x00\x00\x00"
-"image/x-phaseone-raw"
-"MMMMRaw"
-"image/x-x3f"
-"FOVb"
-".doc"
-".xls"
-".docx"
-".ppt"
-".pptx"
-".xlsx"
-"<!DOCTYPE html>"
-"<script>"
-"<html>"
-"<!-->"
-"<head>"
-"<iframe>"
-"<h1>"
-"<div>"
-"<font>"
-"<table>"
-"<a>"
-"<style>"
-"<title>"
-"<b>"
-"<body>"
-"<br>"
-"<p>"
-"<?xml"
-"<!DOCTYPE"
-"application/pdf"
-"%PDF-"
-"application/postscript"
-"%!PS-Adobe-"
-"image/gif"
-"GIF87a"
-"GIF89a"
-"image/png"
-"\x89" "PNG\x0D\x0A\x1A\x0A"
-"image/jpeg"
-"\xFF\xD8\xFF"
-"image/bmp"
-"BM"
-"text/plain"
-"#!"
-"%!"
-"application/x-gzip"
-"\x1F\x8B\x08"
-"audio/x-pn-realaudio"
-"\x2E\x52\x4D\x46"
-"video/x-ms-asf"
-"image/tiff"
-"I I"
-"II*"
-"MM\x00*"
-"ID3"
-"image/webp"
-"RIFF....WEBPVP8 "
-"video/webm"
-"\x1A\x45\xDF\xA3"
-"application/zip"
-"application/x-rar-compressed"
-"Rar!\x1A\x07\x00"
-"application/x-msmetafile"
-"\xD7\xCD\xC6\x9A"
-"MZ"
+
diff --git a/net/socket/ssl_client_socket_unittest.cc b/net/socket/ssl_client_socket_unittest.cc
index 41c64f2..06a241e 100644
--- a/net/socket/ssl_client_socket_unittest.cc
+++ b/net/socket/ssl_client_socket_unittest.cc
@@ -2567,36 +2567,6 @@ TEST_F(SSLClientSocketTest, SessionResumption) {
   EXPECT_EQ(SSLInfo::HANDSHAKE_FULL, ssl_info.handshake_type);
 }
 
-// Tests that ALPN works with session resumption.
-TEST_F(SSLClientSocketTest, SessionResumptionAlpn) {
-  SpawnedTestServer::SSLOptions ssl_options;
-  ssl_options.alpn_protocols.push_back("h2");
-  ssl_options.alpn_protocols.push_back("http/1.1");
-  ASSERT_TRUE(StartTestServer(ssl_options));
-
-  // First, perform a full handshake.
-  SSLConfig ssl_config;
-  // Disable TLS False Start to ensure the handshake has completed.
-  ssl_config.false_start_enabled = false;
-  ssl_config.alpn_protos.push_back(kProtoHTTP2);
-  int rv;
-  ASSERT_TRUE(CreateAndConnectSSLClientSocket(ssl_config, &rv));
-  ASSERT_THAT(rv, IsOk());
-  SSLInfo ssl_info;
-  ASSERT_TRUE(sock_->GetSSLInfo(&ssl_info));
-  EXPECT_EQ(SSLInfo::HANDSHAKE_FULL, ssl_info.handshake_type);
-  EXPECT_EQ(kProtoHTTP2, sock_->GetNegotiatedProtocol());
-
-  // The next connection should resume; ALPN should be renegotiated.
-  ssl_config.alpn_protos.clear();
-  ssl_config.alpn_protos.push_back(kProtoHTTP11);
-  ASSERT_TRUE(CreateAndConnectSSLClientSocket(ssl_config, &rv));
-  ASSERT_THAT(rv, IsOk());
-  ASSERT_TRUE(sock_->GetSSLInfo(&ssl_info));
-  EXPECT_EQ(SSLInfo::HANDSHAKE_RESUME, ssl_info.handshake_type);
-  EXPECT_EQ(kProtoHTTP11, sock_->GetNegotiatedProtocol());
-}
-
 // Tests that connections with certificate errors do not add entries to the
 // session cache.
 TEST_F(SSLClientSocketTest, CertificateErrorNoResume) {
@@ -2816,35 +2786,26 @@ TEST_F(SSLClientSocketTest, TokenBindingEnabledWithoutServerSupport) {
   EXPECT_FALSE(info.token_binding_negotiated);
 }
 
-TEST_F(SSLClientSocketFalseStartTest, FalseStartEnabledWithNPN) {
-  // False Start requires ALPN or NPN, and ECDHE, and an AEAD.
+// In tests requiring NPN, client_config.alpn_protos and
+// client_config.npn_protos both need to be set when using NSS, otherwise NPN is
+// disabled due to quirks of the implementation.
+
+TEST_F(SSLClientSocketFalseStartTest, FalseStartEnabled) {
+  // False Start requires NPN/ALPN, ECDHE, and an AEAD.
   SpawnedTestServer::SSLOptions server_options;
   server_options.key_exchanges =
       SpawnedTestServer::SSLOptions::KEY_EXCHANGE_ECDHE_RSA;
   server_options.bulk_ciphers =
       SpawnedTestServer::SSLOptions::BULK_CIPHER_AES128GCM;
-  server_options.npn_protocols.push_back("http/1.1");
+  server_options.npn_protocols.push_back(std::string("http/1.1"));
   SSLConfig client_config;
   client_config.npn_protos.push_back(kProtoHTTP11);
   ASSERT_NO_FATAL_FAILURE(
       TestFalseStart(server_options, client_config, true));
 }
 
-TEST_F(SSLClientSocketFalseStartTest, FalseStartEnabledWithALPN) {
-  // False Start requires ALPN or NPN, and ECDHE, and an AEAD.
-  SpawnedTestServer::SSLOptions server_options;
-  server_options.key_exchanges =
-      SpawnedTestServer::SSLOptions::KEY_EXCHANGE_ECDHE_RSA;
-  server_options.bulk_ciphers =
-      SpawnedTestServer::SSLOptions::BULK_CIPHER_AES128GCM;
-  server_options.alpn_protocols.push_back("http/1.1");
-  SSLConfig client_config;
-  client_config.alpn_protos.push_back(kProtoHTTP11);
-  ASSERT_NO_FATAL_FAILURE(TestFalseStart(server_options, client_config, true));
-}
-
-// Test that False Start is disabled without either ALPN or NPN.
-TEST_F(SSLClientSocketFalseStartTest, NoAlpnAndNoNpn) {
+// Test that False Start is disabled without NPN.
+TEST_F(SSLClientSocketFalseStartTest, NoNPN) {
   SpawnedTestServer::SSLOptions server_options;
   server_options.key_exchanges =
       SpawnedTestServer::SSLOptions::KEY_EXCHANGE_ECDHE_RSA;
@@ -2864,9 +2825,9 @@ TEST_F(SSLClientSocketFalseStartTest, RSA) {
       SpawnedTestServer::SSLOptions::KEY_EXCHANGE_RSA;
   server_options.bulk_ciphers =
       SpawnedTestServer::SSLOptions::BULK_CIPHER_AES128GCM;
-  server_options.alpn_protocols.push_back("http/1.1");
+  server_options.npn_protocols.push_back(std::string("http/1.1"));
   SSLConfig client_config;
-  client_config.alpn_protos.push_back(kProtoHTTP11);
+  client_config.npn_protos.push_back(kProtoHTTP11);
   ASSERT_NO_FATAL_FAILURE(
       TestFalseStart(server_options, client_config, false));
 }
@@ -2878,9 +2839,9 @@ TEST_F(SSLClientSocketFalseStartTest, DHE_RSA) {
       SpawnedTestServer::SSLOptions::KEY_EXCHANGE_DHE_RSA;
   server_options.bulk_ciphers =
       SpawnedTestServer::SSLOptions::BULK_CIPHER_AES128GCM;
-  server_options.alpn_protocols.push_back("http/1.1");
+  server_options.npn_protocols.push_back(std::string("http/1.1"));
   SSLConfig client_config;
-  client_config.alpn_protos.push_back(kProtoHTTP11);
+  client_config.npn_protos.push_back(kProtoHTTP11);
   // DHE is only advertised when deprecated ciphers are enabled.
   client_config.deprecated_cipher_suites_enabled = true;
   ASSERT_NO_FATAL_FAILURE(TestFalseStart(server_options, client_config, false));
@@ -2893,9 +2854,9 @@ TEST_F(SSLClientSocketFalseStartTest, NoAEAD) {
       SpawnedTestServer::SSLOptions::KEY_EXCHANGE_ECDHE_RSA;
   server_options.bulk_ciphers =
       SpawnedTestServer::SSLOptions::BULK_CIPHER_AES128;
-  server_options.alpn_protocols.push_back("http/1.1");
+  server_options.npn_protocols.push_back(std::string("http/1.1"));
   SSLConfig client_config;
-  client_config.alpn_protos.push_back(kProtoHTTP11);
+  client_config.npn_protos.push_back(kProtoHTTP11);
   ASSERT_NO_FATAL_FAILURE(TestFalseStart(server_options, client_config, false));
 }
 
@@ -2907,9 +2868,9 @@ TEST_F(SSLClientSocketFalseStartTest, SessionResumption) {
       SpawnedTestServer::SSLOptions::KEY_EXCHANGE_ECDHE_RSA;
   server_options.bulk_ciphers =
       SpawnedTestServer::SSLOptions::BULK_CIPHER_AES128GCM;
-  server_options.alpn_protocols.push_back("http/1.1");
+  server_options.npn_protocols.push_back(std::string("http/1.1"));
   SSLConfig client_config;
-  client_config.alpn_protos.push_back(kProtoHTTP11);
+  client_config.npn_protos.push_back(kProtoHTTP11);
 
   // Let a full handshake complete with False Start.
   ASSERT_NO_FATAL_FAILURE(
@@ -2935,11 +2896,11 @@ TEST_F(SSLClientSocketFalseStartTest, NoSessionResumptionBeforeFinished) {
       SpawnedTestServer::SSLOptions::KEY_EXCHANGE_ECDHE_RSA;
   server_options.bulk_ciphers =
       SpawnedTestServer::SSLOptions::BULK_CIPHER_AES128GCM;
-  server_options.alpn_protocols.push_back("http/1.1");
+  server_options.npn_protocols.push_back(std::string("http/1.1"));
   ASSERT_TRUE(StartTestServer(server_options));
 
   SSLConfig client_config;
-  client_config.alpn_protos.push_back(kProtoHTTP11);
+  client_config.npn_protos.push_back(kProtoHTTP11);
 
   // Start a handshake up to the server Finished message.
   TestCompletionCallback callback;
@@ -2989,11 +2950,11 @@ TEST_F(SSLClientSocketFalseStartTest, NoSessionResumptionBadFinished) {
       SpawnedTestServer::SSLOptions::KEY_EXCHANGE_ECDHE_RSA;
   server_options.bulk_ciphers =
       SpawnedTestServer::SSLOptions::BULK_CIPHER_AES128GCM;
-  server_options.alpn_protocols.push_back("http/1.1");
+  server_options.npn_protocols.push_back(std::string("http/1.1"));
   ASSERT_TRUE(StartTestServer(server_options));
 
   SSLConfig client_config;
-  client_config.alpn_protos.push_back(kProtoHTTP11);
+  client_config.npn_protos.push_back(kProtoHTTP11);
 
   // Start a handshake up to the server Finished message.
   TestCompletionCallback callback;
@@ -3134,8 +3095,8 @@ TEST_F(SSLClientSocketChannelIDTest, ChannelIDShardSessionCache) {
 
 TEST_F(SSLClientSocketTest, NPN) {
   SpawnedTestServer::SSLOptions server_options;
-  server_options.npn_protocols.push_back("spdy/3.1");
-  server_options.npn_protocols.push_back("h2");
+  server_options.npn_protocols.push_back(std::string("spdy/3.1"));
+  server_options.npn_protocols.push_back(std::string("h2"));
   ASSERT_TRUE(StartTestServer(server_options));
 
   SSLConfig client_config;
@@ -3151,31 +3112,16 @@ TEST_F(SSLClientSocketTest, NPN) {
   EXPECT_EQ("h2", proto);
 }
 
-// Server preference should win in ALPN.
-TEST_F(SSLClientSocketTest, Alpn) {
+// If npn_protos.empty(), then NPN should be disabled, even if
+// !alpn_protos.empty().  Tlslite does not support ALPN, therefore if NPN is
+// disabled in the client, no protocol should be negotiated.
+TEST_F(SSLClientSocketTest, NPNClientDisabled) {
   SpawnedTestServer::SSLOptions server_options;
-  server_options.alpn_protocols.push_back("h2");
-  server_options.alpn_protocols.push_back("http/1.1");
+  server_options.npn_protocols.push_back(std::string("http/1.1"));
   ASSERT_TRUE(StartTestServer(server_options));
 
   SSLConfig client_config;
   client_config.alpn_protos.push_back(kProtoHTTP11);
-  client_config.alpn_protos.push_back(kProtoHTTP2);
-
-  int rv;
-  ASSERT_TRUE(CreateAndConnectSSLClientSocket(client_config, &rv));
-  EXPECT_THAT(rv, IsOk());
-
-  EXPECT_EQ(kProtoHTTP2, sock_->GetNegotiatedProtocol());
-}
-
-// If the server supports ALPN but the client does not, then ALPN is not used.
-TEST_F(SSLClientSocketTest, AlpnClientDisabled) {
-  SpawnedTestServer::SSLOptions server_options;
-  server_options.alpn_protocols.push_back("foo");
-  ASSERT_TRUE(StartTestServer(server_options));
-
-  SSLConfig client_config;
 
   int rv;
   ASSERT_TRUE(CreateAndConnectSSLClientSocket(client_config, &rv));
diff --git a/net/spdy/hpack/hpack_constants.h b/net/spdy/hpack/hpack_constants.h
index 8718ffe..27799ae 100644
--- a/net/spdy/hpack/hpack_constants.h
+++ b/net/spdy/hpack/hpack_constants.h
@@ -46,6 +46,12 @@ class HpackStaticTable;
 // Defined in RFC 7540 section 6.5.2.
 const uint32_t kDefaultHeaderTableSizeSetting = 4096;
 
+// Maximum amount of encoded header buffer HpackDecoder will retain before
+// returning an error.
+// TODO(rjshade): Remove when deprecating
+// FLAGS_chromium_http2_flag_remove_hpack_decode_buffer_size_limit.
+const uint32_t kMaxDecodeBufferSize = 256 * 1024;
+
 // 6.2: Flag for a string literal that is stored unmodified (i.e.,
 // without Huffman encoding).
 const HpackPrefix kStringLiteralIdentityEncoded = {0x0, 1};
diff --git a/net/spdy/hpack/hpack_decoder.h b/net/spdy/hpack/hpack_decoder.h
index ae2cdfe..f4134a4 100644
--- a/net/spdy/hpack/hpack_decoder.h
+++ b/net/spdy/hpack/hpack_decoder.h
@@ -117,7 +117,8 @@ class NET_EXPORT_PRIVATE HpackDecoder : public HpackDecoderInterface {
   uint32_t total_parsed_bytes_;
 
   // How much encoded data this decoder is willing to buffer.
-  size_t max_decode_buffer_size_bytes_ = 32 * 1024;  // 32 KB
+  // Defaults to 256 KB.
+  size_t max_decode_buffer_size_bytes_ = kMaxDecodeBufferSize;
 
   // Handlers for decoding HPACK opcodes and header representations
   // (or parts thereof). These methods return true on success and
diff --git a/net/spdy/hpack/hpack_decoder_interface.h b/net/spdy/hpack/hpack_decoder_interface.h
index e866853..76e6b2b 100644
--- a/net/spdy/hpack/hpack_decoder_interface.h
+++ b/net/spdy/hpack/hpack_decoder_interface.h
@@ -56,7 +56,9 @@ class NET_EXPORT_PRIVATE HpackDecoderInterface {
   virtual void SetHeaderTableDebugVisitor(
       std::unique_ptr<HpackHeaderTable::DebugVisitorInterface> visitor) = 0;
 
-  // How much encoded data this decoder is willing to buffer.
+  // How much encoded data this decoder is willing to buffer. Defaults to 32 KB.
+  // See FLAGS_gfe2_reloadable_flag_remove_hpack_decode_buffer_size_limit, which
+  // is increasing this to twice the decoded limit.
   virtual void set_max_decode_buffer_size_bytes(
       size_t max_decode_buffer_size_bytes) = 0;
 };
diff --git a/net/spdy/hpack/hpack_decoder_test.cc b/net/spdy/hpack/hpack_decoder_test.cc
index 70209d7..8c711d7 100644
--- a/net/spdy/hpack/hpack_decoder_test.cc
+++ b/net/spdy/hpack/hpack_decoder_test.cc
@@ -135,7 +135,11 @@ TEST_P(HpackDecoderTest, AddHeaderDataWithHandleControlFrameHeadersData) {
                                                      second_input.size()));
   // A string which would push the buffer over the threshold is refused.
   const int kThirdInputSize =
-      (kMaxBufferSizeBytes - (first_input.size() + second_input.size())) + 1;
+      ((FLAGS_chromium_http2_flag_remove_hpack_decode_buffer_size_limit
+            ? kMaxBufferSizeBytes
+            : kMaxDecodeBufferSize) -
+       (first_input.size() + second_input.size())) +
+      1;
   string third_input = string(kThirdInputSize, 'y');
   ASSERT_GT(first_input.size() + second_input.size() + third_input.size(),
             kMaxBufferSizeBytes);
diff --git a/net/spdy/spdy_flags.cc b/net/spdy/spdy_flags.cc
index a2d31d0..53ec856 100644
--- a/net/spdy/spdy_flags.cc
+++ b/net/spdy/spdy_flags.cc
@@ -4,12 +4,15 @@
 
 #include "net/spdy/spdy_flags.h"
 
+// When true, remove hardcoded HPACK size limit on buffered encoded data.
+bool FLAGS_chromium_http2_flag_remove_hpack_decode_buffer_size_limit = true;
+
 // Use NestedSpdyFramerDecoder.
 bool FLAGS_use_nested_spdy_framer_decoder = false;
 
 // Enforce the limit we advertise on frame payload size with
 // GOAWAY_FRAME_SIZE_ERROR.
-bool FLAGS_chromium_http2_flag_enforce_max_frame_size = true;
+bool FLAGS_chromium_http2_flag_enforce_max_frame_size = false;
 
 // Use SpdyHeaderBlock::AppendValueOrAddHeader when adding to headers.
 bool FLAGS_chromium_http2_flag_use_new_spdy_header_block_header_joining = true;
diff --git a/net/spdy/spdy_flags.h b/net/spdy/spdy_flags.h
index bd8375b..bd68ba5 100644
--- a/net/spdy/spdy_flags.h
+++ b/net/spdy/spdy_flags.h
@@ -7,6 +7,8 @@
 
 #include "net/base/net_export.h"
 
+NET_EXPORT_PRIVATE extern bool
+    FLAGS_chromium_http2_flag_remove_hpack_decode_buffer_size_limit;
 NET_EXPORT_PRIVATE extern bool FLAGS_use_nested_spdy_framer_decoder;
 NET_EXPORT_PRIVATE extern bool FLAGS_chromium_http2_flag_enforce_max_frame_size;
 NET_EXPORT_PRIVATE extern bool
diff --git a/net/test/spawned_test_server/base_test_server.cc b/net/test/spawned_test_server/base_test_server.cc
index 793304f..d7dbf95 100644
--- a/net/test/spawned_test_server/base_test_server.cc
+++ b/net/test/spawned_test_server/base_test_server.cc
@@ -639,13 +639,6 @@ bool BaseTestServer::GenerateArguments(base::DictionaryValue* arguments) const {
       arguments->Set("ocsp-server-unavailable",
                      base::Value::CreateNullValue());
     }
-    if (!ssl_options_.alpn_protocols.empty()) {
-      std::unique_ptr<base::ListValue> alpn_protocols(new base::ListValue());
-      for (const std::string& proto : ssl_options_.alpn_protocols) {
-        alpn_protocols->AppendString(proto);
-      }
-      arguments->Set("alpn-protocols", std::move(alpn_protocols));
-    }
     if (!ssl_options_.npn_protocols.empty()) {
       std::unique_ptr<base::ListValue> npn_protocols(new base::ListValue());
       for (const std::string& proto : ssl_options_.npn_protocols) {
diff --git a/net/test/spawned_test_server/base_test_server.h b/net/test/spawned_test_server/base_test_server.h
index 24a119b..c9c6517 100644
--- a/net/test/spawned_test_server/base_test_server.h
+++ b/net/test/spawned_test_server/base_test_server.h
@@ -277,9 +277,6 @@ class BaseTestServer {
     // test server will continue to speak HTTP/1.1.
     std::vector<std::string> npn_protocols;
 
-    // List of supported ALPN protocols.
-    std::vector<std::string> alpn_protocols;
-
     // Whether to send a fatal alert immediately after completing the handshake.
     bool alert_after_handshake;
 
diff --git a/net/tools/testserver/testserver.py b/net/tools/testserver/testserver.py
index e8241cb..14c5abc 100755
--- a/net/tools/testserver/testserver.py
+++ b/net/tools/testserver/testserver.py
@@ -161,8 +161,8 @@ class HTTPSServer(tlslite.api.TLSSocketServerMixIn,
 
   def __init__(self, server_address, request_hander_class, pem_cert_and_key,
                ssl_client_auth, ssl_client_cas, ssl_client_cert_types,
-               ssl_bulk_ciphers, ssl_key_exchanges, alpn_protocols,
-               npn_protocols, record_resume_info, tls_intolerant,
+               ssl_bulk_ciphers, ssl_key_exchanges, npn_protocols,
+               record_resume_info, tls_intolerant,
                tls_intolerance_type, signed_cert_timestamps,
                fallback_scsv_enabled, ocsp_response,
                alert_after_handshake, disable_channel_id, disable_ems,
@@ -215,7 +215,6 @@ class HTTPSServer(tlslite.api.TLSSocketServerMixIn,
       self.ssl_handshake_settings.enableExtendedMasterSecret = False
     self.ssl_handshake_settings.supportedTokenBindingParams = \
         token_binding_params
-    self.ssl_handshake_settings.alpnProtos=alpn_protocols;
 
     if record_resume_info:
       # If record_resume_info is true then we'll replace the session cache with
@@ -1993,7 +1992,6 @@ class ServerRunner(testserver_base.TestServerRunner):
                              self.options.ssl_client_cert_type,
                              self.options.ssl_bulk_cipher,
                              self.options.ssl_key_exchange,
-                             self.options.alpn_protocols,
                              self.options.npn_protocols,
                              self.options.record_resume,
                              self.options.tls_intolerant,
@@ -2228,13 +2226,9 @@ class ServerRunner(testserver_base.TestServerRunner):
                                   'will be used. This option may appear '
                                   'multiple times, indicating multiple '
                                   'algorithms should be enabled.');
-    self.option_parser.add_option('--alpn-protocols', action='append',
-                                  help='Specify the list of ALPN protocols.  '
-                                  'The server will not send an ALPN response '
-                                  'if this list does not overlap with the '
-                                  'list of protocols the client advertises.')
+    # TODO(davidben): Add ALPN support to tlslite.
     self.option_parser.add_option('--npn-protocols', action='append',
-                                  help='Specify the list of protocols sent in '
+                                  help='Specify the list of protocols sent in'
                                   'an NPN response.  The server will not'
                                   'support NPN if the list is empty.')
     self.option_parser.add_option('--file-root-url', default='/files/',
diff --git a/sandbox/linux/seccomp-bpf-helpers/sigsys_handlers.cc b/sandbox/linux/seccomp-bpf-helpers/sigsys_handlers.cc
index ff73018..077bc61 100644
--- a/sandbox/linux/seccomp-bpf-helpers/sigsys_handlers.cc
+++ b/sandbox/linux/seccomp-bpf-helpers/sigsys_handlers.cc
@@ -49,8 +49,7 @@ void WriteToStdErr(const char* error_message, size_t size) {
   while (size > 0) {
     // TODO(jln): query the current policy to check if send() is available and
     // use it to perform a non-blocking write.
-    const int ret = HANDLE_EINTR(
-        sandbox::sys_write(STDERR_FILENO, error_message, size));
+    const int ret = HANDLE_EINTR(write(STDERR_FILENO, error_message, size));
     // We can't handle any type of error here.
     if (ret <= 0 || static_cast<size_t>(ret) > size) break;
     size -= ret;
@@ -106,7 +105,7 @@ void PrintSyscallError(uint32_t sysno) {
   WriteToStdErr(kSeccompErrorPostfix, sizeof(kSeccompErrorPostfix) - 1);
 }
 
-}  // namespace
+}  // namespace.
 
 namespace sandbox {
 
diff --git a/sandbox/linux/services/syscall_wrappers.cc b/sandbox/linux/services/syscall_wrappers.cc
index 9c7727c..7132d2a 100644
--- a/sandbox/linux/services/syscall_wrappers.cc
+++ b/sandbox/linux/services/syscall_wrappers.cc
@@ -32,10 +32,6 @@ pid_t sys_gettid(void) {
   return syscall(__NR_gettid);
 }
 
-ssize_t sys_write(int fd, const char* buffer, size_t buffer_size) {
-  return syscall(__NR_write, fd, buffer, buffer_size);
-}
-
 long sys_clone(unsigned long flags,
                std::nullptr_t child_stack,
                pid_t* ptid,
diff --git a/sandbox/linux/services/syscall_wrappers.h b/sandbox/linux/services/syscall_wrappers.h
index 1975bfb..057e4c8 100644
--- a/sandbox/linux/services/syscall_wrappers.h
+++ b/sandbox/linux/services/syscall_wrappers.h
@@ -28,10 +28,6 @@ SANDBOX_EXPORT pid_t sys_getpid(void);
 
 SANDBOX_EXPORT pid_t sys_gettid(void);
 
-SANDBOX_EXPORT ssize_t sys_write(int fd,
-                                 const char* buffer,
-                                 size_t buffer_size);
-
 SANDBOX_EXPORT long sys_clone(unsigned long flags);
 
 // |regs| is not supported and must be passed as nullptr. |child_stack| must be
diff --git a/services/shell/public/cpp/connection.h b/services/shell/public/cpp/connection.h
index 002cb7d..54aef95 100644
--- a/services/shell/public/cpp/connection.h
+++ b/services/shell/public/cpp/connection.h
@@ -100,6 +100,13 @@ class Connection {
   // false for outbound connections.
   virtual bool HasCapabilityClass(const std::string& class_name) const = 0;
 
+  // Returns the name that was used by the source application to establish a
+  // connection to the destination application.
+  //
+  // When Connection is representing and outgoing connection, this will be the
+  // same as the value returned by GetRemoveApplicationName().
+  virtual const std::string& GetConnectionName() = 0;
+
   // Returns the remote identity. While the connection is in the pending state,
   // the user_id() field will be the value passed via Connect(). After the
   // connection is completed, it will change to the value assigned by the shell.
@@ -120,6 +127,13 @@ class Connection {
   // Returns true if the connection has not yet been processed by the shell.
   virtual bool IsPending() const = 0;
 
+  // Returns the instance id of the remote application if it is known at the
+  // time this function is called. When IsPending() returns true, this function
+  // will return mojom::kInvalidInstanceID. Use
+  // AddConnectionCompletedClosure() to schedule a closure to be run when the
+  // connection is processed by the shell and remote id is available.
+  virtual uint32_t GetRemoteInstanceID() const = 0;
+
   // Register a closure to be run when the connection has been completed by the
   // shell and remote metadata is available. Useful only for connections created
   // via Connector::Connect(). Once the connection is complete, metadata is
diff --git a/services/shell/public/cpp/lib/connection_impl.cc b/services/shell/public/cpp/lib/connection_impl.cc
index 9fa2995..593c4fe 100644
--- a/services/shell/public/cpp/lib/connection_impl.cc
+++ b/services/shell/public/cpp/lib/connection_impl.cc
@@ -24,10 +24,14 @@ ConnectionImpl::ConnectionImpl()
       weak_factory_(this) {}
 
 ConnectionImpl::ConnectionImpl(
+    const std::string& connection_name,
     const Identity& remote,
+    uint32_t remote_id,
     const CapabilityRequest& capability_request,
     State initial_state)
-    : remote_(remote),
+    : connection_name_(connection_name),
+      remote_(remote),
+      remote_id_(remote_id),
       state_(initial_state),
       capability_request_(capability_request),
       allow_all_interfaces_(capability_request.interfaces.size() == 1 &&
@@ -61,6 +65,10 @@ bool ConnectionImpl::HasCapabilityClass(const std::string& class_name) const {
   return capability_request_.classes.count(class_name) > 0;
 }
 
+const std::string& ConnectionImpl::GetConnectionName() {
+  return connection_name_;
+}
+
 const Identity& ConnectionImpl::GetRemoteIdentity() const {
   return remote_;
 }
@@ -80,6 +88,10 @@ bool ConnectionImpl::IsPending() const {
   return state_ == State::PENDING;
 }
 
+uint32_t ConnectionImpl::GetRemoteInstanceID() const {
+  return remote_id_;
+}
+
 void ConnectionImpl::AddConnectionCompletedClosure(
     const base::Closure& callback) {
   if (IsPending())
@@ -109,12 +121,14 @@ base::WeakPtr<Connection> ConnectionImpl::GetWeakPtr() {
 // ConnectionImpl, private:
 
 void ConnectionImpl::OnConnectionCompleted(shell::mojom::ConnectResult result,
-                                           mojo::String target_user_id) {
+                                           mojo::String target_user_id,
+                                           uint32_t target_application_id) {
   DCHECK(State::PENDING == state_);
 
   result_ = result;
   state_ = result_ == shell::mojom::ConnectResult::SUCCEEDED ?
       State::CONNECTED : State::DISCONNECTED;
+  remote_id_ = target_application_id;
   remote_.set_user_id(target_user_id);
   std::vector<base::Closure> callbacks;
   callbacks.swap(connection_completed_callbacks_);
diff --git a/services/shell/public/cpp/lib/connection_impl.h b/services/shell/public/cpp/lib/connection_impl.h
index 690644d..46bfd3c 100644
--- a/services/shell/public/cpp/lib/connection_impl.h
+++ b/services/shell/public/cpp/lib/connection_impl.h
@@ -30,7 +30,9 @@ class ConnectionImpl : public Connection {
   // |allowed_interfaces| are the set of interfaces that the shell has allowed
   // an application to expose to another application. If this set contains only
   // the string value "*" all interfaces may be exposed.
-  ConnectionImpl(const Identity& remote,
+  ConnectionImpl(const std::string& connection_name,
+                 const Identity& remote,
+                 uint32_t remote_id,
                  const CapabilityRequest& capability_request,
                  State initial_state);
   ~ConnectionImpl() override;
@@ -55,10 +57,12 @@ class ConnectionImpl : public Connection {
  private:
   // Connection:
   bool HasCapabilityClass(const std::string& class_name) const override;
+  const std::string& GetConnectionName() override;
   const Identity& GetRemoteIdentity() const override;
   void SetConnectionLostClosure(const base::Closure& handler) override;
   shell::mojom::ConnectResult GetResult() const override;
   bool IsPending() const override;
+  uint32_t GetRemoteInstanceID() const override;
   void AddConnectionCompletedClosure(const base::Closure& callback) override;
   bool AllowsInterface(const std::string& interface_name) const override;
   InterfaceRegistry* GetInterfaceRegistry() override;
@@ -66,9 +70,12 @@ class ConnectionImpl : public Connection {
   base::WeakPtr<Connection> GetWeakPtr() override;
 
   void OnConnectionCompleted(shell::mojom::ConnectResult result,
-                             mojo::String target_user_id);
+                             mojo::String target_user_id,
+                             uint32_t target_application_id);
 
+  const std::string connection_name_;
   Identity remote_;
+  uint32_t remote_id_ = shell::mojom::kInvalidInstanceID;
 
   State state_;
   shell::mojom::ConnectResult result_ = shell::mojom::ConnectResult::SUCCEEDED;
diff --git a/services/shell/public/cpp/lib/connector_impl.cc b/services/shell/public/cpp/lib/connector_impl.cc
index f7faf96..40a1b61 100644
--- a/services/shell/public/cpp/lib/connector_impl.cc
+++ b/services/shell/public/cpp/lib/connector_impl.cc
@@ -55,8 +55,9 @@ std::unique_ptr<Connection> ConnectorImpl::Connect(ConnectParams* params) {
   mojom::InterfaceProviderPtr remote_interfaces;
   mojom::InterfaceProviderRequest remote_request = GetProxy(&remote_interfaces);
   std::unique_ptr<internal::ConnectionImpl> connection(
-      new internal::ConnectionImpl(params->target(), request,
-                                   Connection::State::PENDING));
+      new internal::ConnectionImpl(
+          params->target().name(), params->target(), mojom::kInvalidInstanceID,
+          request, Connection::State::PENDING));
   if (params->remote_interfaces()) {
     params->remote_interfaces()->Bind(std::move(remote_interfaces));
     connection->set_remote_interfaces(params->remote_interfaces());
diff --git a/services/shell/public/cpp/lib/interface_registry.cc b/services/shell/public/cpp/lib/interface_registry.cc
index 536bbab..690f054 100644
--- a/services/shell/public/cpp/lib/interface_registry.cc
+++ b/services/shell/public/cpp/lib/interface_registry.cc
@@ -82,9 +82,10 @@ void InterfaceRegistry::GetInterface(const mojo::String& interface_name,
                                 interface_name,
                                 std::move(handle));
   } else if (connection_ && !connection_->AllowsInterface(interface_name)) {
-    LOG(ERROR) << "Capability spec prevented service: "
-               << connection_->GetRemoteIdentity().name()
-               << " from binding interface: " << interface_name;
+    LOG(ERROR) << "Connection CapabilityFilter prevented binding to "
+               << "interface: " << interface_name << " connection_name:"
+               << connection_->GetConnectionName() << " remote_name:"
+               << connection_->GetRemoteIdentity().name();
   } else if (!default_binder_.is_null()) {
     default_binder_.Run(interface_name, std::move(handle));
   } else {
diff --git a/services/shell/public/cpp/lib/service_context.cc b/services/shell/public/cpp/lib/service_context.cc
index 3da21a4..0fc56f8 100644
--- a/services/shell/public/cpp/lib/service_context.cc
+++ b/services/shell/public/cpp/lib/service_context.cc
@@ -48,6 +48,7 @@ void ServiceContext::SetConnectionLostClosure(const base::Closure& closure) {
 // ServiceContext, mojom::Service implementation:
 
 void ServiceContext::OnStart(mojom::IdentityPtr identity,
+                             uint32_t id,
                              const OnStartCallback& callback) {
   identity_ = identity.To<Identity>();
   if (!initialize_handler_.is_null())
@@ -64,10 +65,12 @@ void ServiceContext::OnStart(mojom::IdentityPtr identity,
 
 void ServiceContext::OnConnect(
     mojom::IdentityPtr source,
+    uint32_t source_id,
     mojom::InterfaceProviderRequest interfaces,
-    mojom::CapabilityRequestPtr allowed_capabilities) {
+    mojom::CapabilityRequestPtr allowed_capabilities,
+    const mojo::String& name) {
   std::unique_ptr<internal::ConnectionImpl> connection(
-      new internal::ConnectionImpl(source.To<Identity>(),
+      new internal::ConnectionImpl(name, source.To<Identity>(), source_id,
                                    allowed_capabilities.To<CapabilityRequest>(),
                                    Connection::State::CONNECTED));
 
diff --git a/services/shell/public/cpp/service_context.h b/services/shell/public/cpp/service_context.h
index 94764eb..e43793f 100644
--- a/services/shell/public/cpp/service_context.h
+++ b/services/shell/public/cpp/service_context.h
@@ -66,10 +66,13 @@ class ServiceContext : public mojom::Service {
  private:
   // mojom::Service:
   void OnStart(mojom::IdentityPtr identity,
+               uint32_t id,
                const OnStartCallback& callback) override;
   void OnConnect(mojom::IdentityPtr source,
+                 uint32_t source_id,
                  mojom::InterfaceProviderRequest interfaces,
-                 mojom::CapabilityRequestPtr allowed_capabilities) override;
+                 mojom::CapabilityRequestPtr allowed_capabilities,
+                 const mojo::String& name) override;
 
   void OnConnectionError();
 
diff --git a/services/shell/public/interfaces/connector.mojom b/services/shell/public/interfaces/connector.mojom
index 53ece30..bb675fa 100644
--- a/services/shell/public/interfaces/connector.mojom
+++ b/services/shell/public/interfaces/connector.mojom
@@ -124,10 +124,13 @@ interface Connector {
   //    passes kInheritUserID as the user id to Connect() which is resolved by
   //    the shell into a valid user id returned through this callback.
   //
+  //  application_id
+  //    A unique identifier for the instance that was connected to.
+  //
   Connect(Identity target,
           InterfaceProvider&? remote_interfaces,
           ClientProcessConnection? client_process_connection) =>
-      (ConnectResult result, string user_id);
+      (ConnectResult result, string user_id, uint32 application_id);
 
   // Clones this Connector so it can be passed to another thread.
   Clone(Connector& request);
diff --git a/services/shell/public/interfaces/service.mojom b/services/shell/public/interfaces/service.mojom
index b429eec..0d632e7 100644
--- a/services/shell/public/interfaces/service.mojom
+++ b/services/shell/public/interfaces/service.mojom
@@ -25,13 +25,17 @@ interface Service {
   //      be kInheritUserID.
   //    * The instance group this instance belongs to.
   //
+  //  id
+  //    A unique identifier used by the shell to identify this instance.
+  //
+  //
   // Response parameters:
   //
   //  connector_request
   //    An optional Connector request for the shell to bind, allowing the
   //    initialized client to connect to others.
   //
-  OnStart(Identity identity) => (Connector&? connector_request);
+  OnStart(Identity identity, uint32 id) => (Connector&? connector_request);
 
   // Called when another application attempts to open a connection to this
   // application. An application implements this method to complete the exchange
@@ -45,6 +49,9 @@ interface Service {
   //  source
   //    The identity of the instance originating the connection.
   //
+  //  source_id
+  //    A unique identifier used by the shell to identify the source instance.
+  //
   //  interfaces
   //    A request for an InterfaceProvider by which the source application may
   //    seek to bind interface implementations exported by the target.
@@ -55,7 +62,12 @@ interface Service {
   //    by the source and target's manifests. Attempts to bind interfaces not in
   //    this whitelist must not be fulfilled.
   //
+  //  resolved_name
+  //    The resolved name used to complete this connection.
+  //
   OnConnect(Identity source,
+            uint32 source_id,
             InterfaceProvider&? interfaces,
-            CapabilityRequest allowed_capabilities);
+            CapabilityRequest allowed_capabilities,
+            string resolved_name);
 };
diff --git a/services/shell/service_manager.cc b/services/shell/service_manager.cc
index 28faee3..c2e949a 100644
--- a/services/shell/service_manager.cc
+++ b/services/shell/service_manager.cc
@@ -175,14 +175,16 @@ class ServiceManager::Instance
     std::unique_ptr<ConnectParams> params(std::move(*connect_params));
     if (!params->connect_callback().is_null()) {
         params->connect_callback().Run(mojom::ConnectResult::SUCCEEDED,
-                                       identity_.user_id());
+                                       identity_.user_id(), id_);
     }
+    uint32_t source_id = mojom::kInvalidInstanceID;
     CapabilityRequest request;
     request.interfaces.insert("*");
     Instance* source = service_manager_->GetExistingInstance(params->source());
     if (source) {
       request = GenerateCapabilityRequestForConnection(
           source->capability_spec_, identity_, capability_spec_);
+      source_id = source->id();
     }
 
     // The target has specified that sources must request one of its provided
@@ -192,9 +194,11 @@ class ServiceManager::Instance
       request.interfaces.erase("*");
     }
 
-    service_->OnConnect(mojom::Identity::From(params->source()),
-                        params->TakeRemoteInterfaces(),
-                        mojom::CapabilityRequest::From(request));
+    service_->OnConnect(
+        mojom::Identity::From(params->source()), source_id,
+        params->TakeRemoteInterfaces(), mojom::CapabilityRequest::From(request),
+        params->target().name());
+
     return true;
   }
 
@@ -204,7 +208,7 @@ class ServiceManager::Instance
     service_.set_connection_error_handler(
         base::Bind(&Instance::OnServiceLost, base::Unretained(this),
                    service_manager_->GetWeakPtr()));
-    service_->OnStart(mojom::Identity::From(identity_),
+    service_->OnStart(mojom::Identity::From(identity_), id_,
                       base::Bind(&Instance::OnInitializeResponse,
                                  base::Unretained(this)));
   }
@@ -306,13 +310,13 @@ class ServiceManager::Instance
     if (!IsValidName(identity.name())) {
       LOG(ERROR) << "Error: invalid Name: " << identity.name();
       callback.Run(mojom::ConnectResult::INVALID_ARGUMENT,
-                   mojom::kInheritUserID);
+                   mojom::kInheritUserID, mojom::kInvalidInstanceID);
       return false;
     }
     if (!base::IsValidGUID(identity.user_id())) {
       LOG(ERROR) << "Error: invalid user_id: " << identity.user_id();
       callback.Run(mojom::ConnectResult::INVALID_ARGUMENT,
-                   mojom::kInheritUserID);
+                   mojom::kInheritUserID, mojom::kInvalidInstanceID);
       return false;
     }
     return true;
@@ -329,7 +333,7 @@ class ServiceManager::Instance
                    << "target: " << target.name() << " without the "
                    << "mojo:shell{client_process} capability class.";
         callback.Run(mojom::ConnectResult::ACCESS_DENIED,
-                     mojom::kInheritUserID);
+                     mojom::kInheritUserID, mojom::kInvalidInstanceID);
         return false;
       }
 
@@ -339,7 +343,7 @@ class ServiceManager::Instance
                    << "pid_receiver_request when sending "
                    << "client_process_connection.";
         callback.Run(mojom::ConnectResult::INVALID_ARGUMENT,
-                     mojom::kInheritUserID);
+                     mojom::kInheritUserID, mojom::kInvalidInstanceID);
         return false;
       }
       if (service_manager_->GetExistingInstance(target)) {
@@ -347,7 +351,7 @@ class ServiceManager::Instance
                    << "Name: " << target.name() << " User: "
                    << target.user_id() << " Instance: " << target.instance();
         callback.Run(mojom::ConnectResult::INVALID_ARGUMENT,
-                     mojom::kInheritUserID);
+                     mojom::kInheritUserID, mojom::kInvalidInstanceID);
         return false;
       }
     }
@@ -367,7 +371,7 @@ class ServiceManager::Instance
                   << target.name() << " as: " << target.user_id() << " without "
                   << " the mojo:shell{user_id} capability class.";
       callback.Run(mojom::ConnectResult::ACCESS_DENIED,
-                   mojom::kInheritUserID);
+                   mojom::kInheritUserID, mojom::kInvalidInstanceID);
       return false;
     }
     if (!target.instance().empty() &&
@@ -377,7 +381,8 @@ class ServiceManager::Instance
                   << "connect to " << target.name() << " using Instance name: "
                   << target.instance() << " without the "
                   << "mojo:shell{instance_name} capability class.";
-      callback.Run(mojom::ConnectResult::ACCESS_DENIED, mojom::kInheritUserID);
+      callback.Run(mojom::ConnectResult::ACCESS_DENIED,
+                   mojom::kInheritUserID, mojom::kInvalidInstanceID);
       return false;
 
     }
@@ -389,7 +394,8 @@ class ServiceManager::Instance
     }
     LOG(ERROR) << "Capabilities prevented connection from: " <<
                   identity_.name() << " to: " << target.name();
-    callback.Run(mojom::ConnectResult::ACCESS_DENIED, mojom::kInheritUserID);
+    callback.Run(mojom::ConnectResult::ACCESS_DENIED,
+                 mojom::kInheritUserID, mojom::kInvalidInstanceID);
     return false;
   }
 
@@ -538,7 +544,7 @@ bool ServiceManager::OnConnect(Connection* connection) {
   // caller's instance to continue.
   Instance* instance = nullptr;
   for (const auto& entry : identity_to_instance_) {
-    if (entry.first == connection->GetRemoteIdentity()) {
+    if (entry.second->id() == connection->GetRemoteInstanceID()) {
       instance = entry.second;
       break;
     }
diff --git a/services/shell/tests/connect/OWNERS b/services/shell/tests/connect/OWNERS
deleted file mode 100644
index 08850f4..0000000
--- a/services/shell/tests/connect/OWNERS
+++ /dev/null
@@ -1,2 +0,0 @@
-per-file *.mojom=set noparent
-per-file *.mojom=file://ipc/SECURITY_OWNERS
diff --git a/services/shell/tests/connect/connect_test.mojom b/services/shell/tests/connect/connect_test.mojom
index a8af94c..5a9efcd 100644
--- a/services/shell/tests/connect/connect_test.mojom
+++ b/services/shell/tests/connect/connect_test.mojom
@@ -50,10 +50,13 @@ interface ClientProcessTest {
 };
 
 struct ConnectionState {
+  string connection_local_name;
   string connection_remote_name;
   string connection_remote_userid;
+  uint32 connection_remote_id;
   string initialize_local_name;
   string initialize_userid;
+  uint32 initialize_id;
 };
 
 interface ExposedInterface {
diff --git a/services/shell/tests/connect/connect_test_app.cc b/services/shell/tests/connect/connect_test_app.cc
index 02992a6..01c5078 100644
--- a/services/shell/tests/connect/connect_test_app.cc
+++ b/services/shell/tests/connect/connect_test_app.cc
@@ -67,9 +67,12 @@ class ConnectTestApp : public Service,
     connection->AddInterface<test::mojom::BlockedInterface>(this);
     connection->AddInterface<test::mojom::UserIdTest>(this);
 
+    uint32_t remote_id = connection->GetRemoteInstanceID();
     test::mojom::ConnectionStatePtr state(test::mojom::ConnectionState::New());
+    state->connection_local_name = connection->GetConnectionName();
     state->connection_remote_name = connection->GetRemoteIdentity().name();
     state->connection_remote_userid = connection->GetRemoteIdentity().user_id();
+    state->connection_remote_id = remote_id;
     state->initialize_local_name = identity_.name();
     state->initialize_userid = identity_.user_id();
 
diff --git a/services/shell/tests/connect/connect_test_package.cc b/services/shell/tests/connect/connect_test_package.cc
index cc5d73a..25827f5 100644
--- a/services/shell/tests/connect/connect_test_package.cc
+++ b/services/shell/tests/connect/connect_test_package.cc
@@ -72,9 +72,12 @@ class ProvidedService
     connection->AddInterface<test::mojom::BlockedInterface>(this);
     connection->AddInterface<test::mojom::UserIdTest>(this);
 
+    uint32_t remote_id = connection->GetRemoteInstanceID();
     test::mojom::ConnectionStatePtr state(test::mojom::ConnectionState::New());
+    state->connection_local_name = connection->GetConnectionName();
     state->connection_remote_name = connection->GetRemoteIdentity().name();
     state->connection_remote_userid = connection->GetRemoteIdentity().user_id();
+    state->connection_remote_id = remote_id;
     state->initialize_local_name = identity_.name();
     state->initialize_userid = identity_.user_id();
 
diff --git a/services/shell/tests/connect/connect_unittest.cc b/services/shell/tests/connect/connect_unittest.cc
index a110893..8678f32 100644
--- a/services/shell/tests/connect/connect_unittest.cc
+++ b/services/shell/tests/connect/connect_unittest.cc
@@ -90,6 +90,7 @@ class ConnectTest : public test::ServiceTest,
       const std::string& connection_remote_userid,
       const std::string& initialize_local_name,
       const std::string& initialize_userid) {
+    EXPECT_EQ(connection_local_name, connection_state_->connection_local_name);
     EXPECT_EQ(connection_remote_name,
               connection_state_->connection_remote_name);
     EXPECT_EQ(connection_remote_userid,
@@ -166,6 +167,7 @@ TEST_F(ConnectTest, Connect) {
   run_loop.Run();
   EXPECT_EQ("APP", title);
   EXPECT_FALSE(connection->IsPending());
+  EXPECT_NE(mojom::kInvalidInstanceID, connection->GetRemoteInstanceID());
   EXPECT_EQ(connection->GetRemoteIdentity().name(), kTestAppName);
 }
 
@@ -257,6 +259,7 @@ TEST_F(ConnectTest, PackagedApp) {
   run_loop.Run();
   EXPECT_EQ("A", a_name);
   EXPECT_FALSE(connection->IsPending());
+  EXPECT_NE(mojom::kInvalidInstanceID, connection->GetRemoteInstanceID());
   EXPECT_EQ(connection->GetRemoteIdentity().name(), kTestAppAName);
 }
 
@@ -299,6 +302,7 @@ TEST_F(ConnectTest, BlockedPackagedApplication) {
   run_loop.Run();
   EXPECT_FALSE(connection->IsPending());
   EXPECT_EQ(mojom::ConnectResult::ACCESS_DENIED, connection->GetResult());
+  EXPECT_EQ(mojom::kInvalidInstanceID, connection->GetRemoteInstanceID());
 }
 
 TEST_F(ConnectTest, CapabilityClasses) {
diff --git a/services/ui/public/cpp/lib/window.cc b/services/ui/public/cpp/lib/window.cc
index c58a247..f3dde51 100644
--- a/services/ui/public/cpp/lib/window.cc
+++ b/services/ui/public/cpp/lib/window.cc
@@ -643,15 +643,13 @@ void Window::LocalAddTransientWindow(Window* transient_window) {
     RestackTransientDescendants(this, &GetStackingTarget,
                                 &ReorderWithoutNotification);
 
-  FOR_EACH_OBSERVER(WindowObserver, observers_,
-                    OnTransientChildAdded(this, transient_window));
+  // TODO(fsamuel): We might want a notification here.
 }
 
 void Window::LocalRemoveTransientWindow(Window* transient_window) {
   DCHECK_EQ(this, transient_window->transient_parent());
   RemoveTransientWindowImpl(transient_window);
-  FOR_EACH_OBSERVER(WindowObserver, observers_,
-                    OnTransientChildRemoved(this, transient_window));
+  // TODO(fsamuel): We might want a notification here.
 }
 
 void Window::LocalSetModal() {
diff --git a/services/ui/public/cpp/tests/window_unittest.cc b/services/ui/public/cpp/tests/window_unittest.cc
index a1c09d6..88221a2 100644
--- a/services/ui/public/cpp/tests/window_unittest.cc
+++ b/services/ui/public/cpp/tests/window_unittest.cc
@@ -1198,62 +1198,4 @@ TEST_F(WindowTest, StackUponCreation) {
   EXPECT_EQ("1 3 2", ChildWindowIDsAsString(parent.get()));
 }
 
-namespace {
-
-class TransientWindowObserver : public WindowObserver {
- public:
-  TransientWindowObserver() {}
-  ~TransientWindowObserver() override {}
-
-  void ResetCounts() { added_count_ = removed_count_ = 0; }
-
-  int added_count() const { return added_count_; }
-  int removed_count() const { return removed_count_; }
-
-  // WindowObserver:
-  void OnTransientChildAdded(ui::Window* window,
-                             ui::Window* transient) override {
-    added_count_++;
-  }
-  void OnTransientChildRemoved(ui::Window* window,
-                               ui::Window* transient) override {
-    removed_count_++;
-  }
-
- private:
-  int added_count_ = 0;
-  int removed_count_ = 0;
-
-  DISALLOW_COPY_AND_ASSIGN(TransientWindowObserver);
-};
-
-}  // namespace
-
-// Verifies WindowObserver is notified of transient windows added/removed.
-TEST_F(WindowTest, TransientNotifiesObserver) {
-  std::unique_ptr<TestWindow> parent(CreateTestWindow(0, nullptr));
-  TransientWindowObserver observer;
-  parent->AddObserver(&observer);
-  std::unique_ptr<TestWindow> child(CreateTestWindow(0, nullptr));
-  parent->AddTransientWindow(child.get());
-  EXPECT_EQ(1, observer.added_count());
-  EXPECT_EQ(0, observer.removed_count());
-  observer.ResetCounts();
-
-  parent->RemoveTransientWindow(child.get());
-  EXPECT_EQ(0, observer.added_count());
-  EXPECT_EQ(1, observer.removed_count());
-  observer.ResetCounts();
-
-  parent->AddTransientWindow(child.get());
-  EXPECT_EQ(1, observer.added_count());
-  EXPECT_EQ(0, observer.removed_count());
-  observer.ResetCounts();
-
-  child.reset();
-  EXPECT_EQ(0, observer.added_count());
-  EXPECT_EQ(1, observer.removed_count());
-  observer.ResetCounts();
-}
-
 }  // namespace ui
diff --git a/services/ui/public/cpp/window_observer.h b/services/ui/public/cpp/window_observer.h
index 83ed271..8d54835 100644
--- a/services/ui/public/cpp/window_observer.h
+++ b/services/ui/public/cpp/window_observer.h
@@ -97,11 +97,6 @@ class WindowObserver {
   virtual void OnWindowDrawnChanging(Window* window) {}
   virtual void OnWindowDrawnChanged(Window* window) {}
 
-  virtual void OnTransientChildAdded(ui::Window* window,
-                                     ui::Window* transient) {}
-  virtual void OnTransientChildRemoved(ui::Window* window,
-                                       ui::Window* transient) {}
-
   // The WindowManager has requested the window to close. If the observer
   // allows the close it should destroy the window as appropriate.
   virtual void OnRequestClose(Window* window) {}
diff --git a/services/ui/ws/window_manager_state.cc b/services/ui/ws/window_manager_state.cc
index 0765821..f36ede0 100644
--- a/services/ui/ws/window_manager_state.cc
+++ b/services/ui/ws/window_manager_state.cc
@@ -350,7 +350,7 @@ void WindowManagerState::DispatchInputEventToWindowImpl(
   event_dispatch_phase_ = EventDispatchPhase::TARGET;
 
   WindowTree* tree = window_server()->GetTreeWithId(client_id);
-  DCHECK(tree);
+
   ScheduleInputEventTimeout(tree);
 
   if (accelerator) {
diff --git a/services/ui/ws/window_manager_state_unittest.cc b/services/ui/ws/window_manager_state_unittest.cc
index a4c685a..e83fa35 100644
--- a/services/ui/ws/window_manager_state_unittest.cc
+++ b/services/ui/ws/window_manager_state_unittest.cc
@@ -92,11 +92,6 @@ class WindowManagerStateTest : public testing::Test {
     *embed_tree = window_event_targeting_helper_.last_binding()->tree();
   }
 
-  void DestroyWindowTree() {
-    window_event_targeting_helper_.window_server()->DestroyTree(window_tree_);
-    window_tree_ = nullptr;
-  }
-
   // testing::Test:
   void SetUp() override;
 
@@ -378,34 +373,6 @@ TEST_F(WindowManagerStateTest, DeleteNonRootTree) {
   EXPECT_TRUE(window_manager()->on_accelerator_called());
 }
 
-// Tests that if a tree is destroyed before acking an event, that mus won't
-// then try to send any queued events.
-TEST_F(WindowManagerStateTest, DontSendQueuedEventsToADeadTree) {
-  ServerWindow* target = window();
-  TestChangeTracker* tracker = window_tree_client()->tracker();
-
-  ui::MouseEvent press(ui::ET_MOUSE_PRESSED, gfx::Point(5, 5), gfx::Point(5, 5),
-                       base::TimeTicks(), EF_LEFT_MOUSE_BUTTON,
-                       EF_LEFT_MOUSE_BUTTON);
-  DispatchInputEventToWindow(target, press, nullptr);
-  ASSERT_EQ(1u, tracker->changes()->size());
-  EXPECT_EQ("InputEvent window=1,1 event_action=1",
-            ChangesToDescription1(*tracker->changes())[0]);
-  tracker->changes()->clear();
-  // The above is not setting TreeAwaitingInputAck.
-
-  // Queue the key release event; it should not be immediately dispatched
-  // because there's no ACK for the last one.
-  ui::MouseEvent release(ui::ET_MOUSE_RELEASED, gfx::Point(5, 5),
-                         gfx::Point(5, 5), base::TimeTicks(),
-                         EF_LEFT_MOUSE_BUTTON, EF_LEFT_MOUSE_BUTTON);
-  DispatchInputEventToWindow(target, release, nullptr);
-  EXPECT_EQ(0u, tracker->changes()->size());
-
-  // Destroying a window tree with an event in queue shouldn't crash.
-  DestroyWindowTree();
-}
-
 // Tests that when an ack times out that the accelerator is notified.
 TEST_F(WindowManagerStateTest, AckTimeout) {
   ui::KeyEvent key(ui::ET_KEY_PRESSED, ui::VKEY_W, ui::EF_CONTROL_DOWN);
diff --git a/services/ui/ws/window_tree.cc b/services/ui/ws/window_tree.cc
index e87c9c1..fb500d9 100644
--- a/services/ui/ws/window_tree.cc
+++ b/services/ui/ws/window_tree.cc
@@ -83,12 +83,6 @@ WindowTree::WindowTree(WindowServer* window_server,
 
 WindowTree::~WindowTree() {
   DestroyWindows();
-
-  // We alert the WindowManagerState that we're destroying this state here
-  // because WindowManagerState would attempt to use things that wouldn't have
-  // been cleaned up by OnWindowDestroyingTreeImpl().
-  if (window_manager_state_)
-    window_manager_state_->OnWillDestroyTree(this);
 }
 
 void WindowTree::Init(std::unique_ptr<WindowTreeBinding> binding,
@@ -199,6 +193,9 @@ void WindowTree::AddRootForWindowManager(const ServerWindow* root) {
 }
 
 void WindowTree::OnWindowDestroyingTreeImpl(WindowTree* tree) {
+  if (window_manager_state_)
+    window_manager_state_->OnWillDestroyTree(tree);
+
   if (event_source_wms_ && event_source_wms_->window_tree() == tree)
     event_source_wms_ = nullptr;
 
diff --git a/sql/connection.cc b/sql/connection.cc
index 9c7cb7d..ab84266 100644
--- a/sql/connection.cc
+++ b/sql/connection.cc
@@ -243,7 +243,23 @@ bool Connection::IsExpectedSqliteError(int error) {
 void Connection::ReportDiagnosticInfo(int extended_error, Statement* stmt) {
   AssertIOAllowed();
 
-  std::string debug_info = GetDiagnosticInfo(extended_error, stmt);
+  // Trim extended error codes.
+  const int error = (extended_error & 0xFF);
+  std::string debug_info;
+  if (error == SQLITE_CORRUPT) {
+    // CollectCorruptionInfo() is implemented in terms of sql::Connection,
+    // prevent reentrant calls to the error callback.
+    // TODO(shess): Rewrite IntegrityCheckHelper() in terms of raw SQLite.
+    ErrorCallback original_callback = std::move(error_callback_);
+    reset_error_callback();
+
+    debug_info = CollectCorruptionInfo();
+
+    error_callback_ = std::move(original_callback);
+  } else {
+    debug_info = CollectErrorInfo(extended_error, stmt);
+  }
+
   if (!debug_info.empty() && RegisterIntentToUpload()) {
     char debug_buf[2000];
     base::strlcpy(debug_buf, debug_info.c_str(), arraysize(debug_buf));
@@ -1906,40 +1922,6 @@ bool Connection::QuickIntegrityCheck() {
   return messages.size() == 1 && messages[0] == "ok";
 }
 
-std::string Connection::GetDiagnosticInfo(int extended_error,
-                                          Statement* statement) {
-  // Prevent reentrant calls to the error callback.
-  ErrorCallback original_callback = std::move(error_callback_);
-  reset_error_callback();
-
-  // Trim extended error codes.
-  const int error = (extended_error & 0xFF);
-  // CollectCorruptionInfo() is implemented in terms of sql::Connection,
-  // TODO(shess): Rewrite IntegrityCheckHelper() in terms of raw SQLite.
-  std::string result = (error == SQLITE_CORRUPT)
-                           ? CollectCorruptionInfo()
-                           : CollectErrorInfo(extended_error, statement);
-
-  // The following queries must be executed after CollectErrorInfo() above, so
-  // if they result in their own errors, they don't interfere with
-  // CollectErrorInfo().
-  const bool has_valid_header =
-      (ExecuteAndReturnErrorCode("PRAGMA auto_vacuum") == SQLITE_OK);
-  const bool select_sqlite_master_result =
-      (ExecuteAndReturnErrorCode("SELECT COUNT(*) FROM sqlite_master") ==
-       SQLITE_OK);
-
-  // Restore the original error callback.
-  error_callback_ = std::move(original_callback);
-
-  base::StringAppendF(&result, "Has valid header: %s\n",
-                      (has_valid_header ? "Yes" : "No"));
-  base::StringAppendF(&result, "Has valid schema: %s\n",
-                      (select_sqlite_master_result ? "Yes" : "No"));
-
-  return result;
-}
-
 // TODO(shess): Allow specifying maximum results (default 100 lines).
 bool Connection::IntegrityCheckHelper(
     const char* pragma_sql,
diff --git a/sql/connection.h b/sql/connection.h
index 5b8d399..12e7041 100644
--- a/sql/connection.h
+++ b/sql/connection.h
@@ -239,10 +239,6 @@ class SQL_EXPORT Connection {
   // without error and results in a single "ok" value.
   bool QuickIntegrityCheck() WARN_UNUSED_RESULT;
 
-  // Meant to be called from a client error callback so that it's able to
-  // get diagnostic information about the database.
-  std::string GetDiagnosticInfo(int extended_error, Statement* statement);
-
   // Initialization ------------------------------------------------------------
 
   // Initializes the SQL connection for the given file, returning true if the
diff --git a/sql/error_delegate_util.cc b/sql/error_delegate_util.cc
index ae856b7..37fe006 100644
--- a/sql/error_delegate_util.cc
+++ b/sql/error_delegate_util.cc
@@ -77,13 +77,4 @@ bool IsErrorCatastrophic(int error) {
   return false;
 }
 
-std::string GetCorruptFileDiagnosticsInfo(
-    const base::FilePath& corrupted_file_path) {
-  std::string corrupted_file_info("Corrupted file: ");
-  corrupted_file_info +=
-      corrupted_file_path.DirName().BaseName().AsUTF8Unsafe() + "/" +
-      corrupted_file_path.BaseName().AsUTF8Unsafe() + "\n";
-  return corrupted_file_info;
-}
-
 }  // namespace sql
diff --git a/sql/error_delegate_util.h b/sql/error_delegate_util.h
index 4213321..0c67c07 100644
--- a/sql/error_delegate_util.h
+++ b/sql/error_delegate_util.h
@@ -5,9 +5,6 @@
 #ifndef SQL_ERROR_DELEGATE_UTIL_H_
 #define SQL_ERROR_DELEGATE_UTIL_H_
 
-#include <string>
-
-#include "base/files/file_path.h"
 #include "sql/sql_export.h"
 
 namespace sql {
@@ -16,15 +13,6 @@ namespace sql {
 // |error|.
 SQL_EXPORT bool IsErrorCatastrophic(int error);
 
-// Gets diagnostic info of the given |corrupted_file_path| that can be appended
-// to a corrupt database diagnostics info. The file info are not localized as
-// it's meant to be added to feedback reports and used by developers.
-// Also the full file path is not appended as it might contain some PII. Instead
-// only the last two components of the path are appended to distinguish between
-// default and user profiles.
-SQL_EXPORT std::string GetCorruptFileDiagnosticsInfo(
-    const base::FilePath& corrupted_file_path);
-
 }  // namespace sql
 
 #endif  // SQL_ERROR_DELEGATE_UTIL_H_
diff --git a/testing/android/proguard_for_test.flags b/testing/android/proguard_for_test.flags
index a0f074a..46befb0 100644
--- a/testing/android/proguard_for_test.flags
+++ b/testing/android/proguard_for_test.flags
@@ -2,27 +2,104 @@
 # Use of this source code is governed by a BSD-style license that can be
 # found in the LICENSE file.
 
-# This file is for proguard flags which are applied to the combined test and
-# tested code. Do not put any flags in this file which might affect the
-# correctness of the .apk we are testing, since it will apply to that .apk as
-# well.
+# This file is for proguard flags which will be applied to apks that are being
+# built to be instrumentation tested. The flags in this file should only affect
+# how the instrumentation tests interact with the .apk. Do not put any flags in
+# this file which might affect the correctness of the .apk.
 
-# We want all tests to stick around.
--keep class * extends junit.framework.TestCase {
+# This line prevents optmization from being applied to either packages. We rely
+# on optimizations being off to prevent inlining functions our instrumentation
+# tests use.
+# TODO(smaier): when buildbot scripts have been updated to not include this
+# config as part of its release build, switch these lines to:
+# -dontoptimize
+-keepnames,allowobfuscation class com.google.android.apps.chrome.**,org.chromium.** {
+  *;
+}
+
+# Keeping @VisibleForTesting and its annotated classes + methods
+-keep @interface org.chromium.base.VisibleForTesting
+-keep @org.chromium.base.VisibleForTesting class **
+-keepclasseswithmembers class * {
+  @org.chromium.base.VisibleForTesting <methods>;
+}
+
+# TODO(aurimas): figure out why we need to keep these classes.
+-keep class org.chromium.base.test.** {
+  *;
+}
+
+# Everything below this is kept because they are referenced by the test APK.
+-keep class android.support.v7.mediarouter.R* {
+  *;
+}
+
+-keep class android.support.v7.media.MediaRouteProvider** {
+  *;
+}
+
+-keep class android.support.v4.app.FragmentManager** {
+  *;
+}
+
+-keep class android.support.v4.app.DialogFragment** {
+  *;
+}
+
+-keep class android.support.v7.app.NotificationCompat** {
+  *;
+}
+
+-keep class android.support.v7.app.AlertDialog** {
+  *;
+}
+
+-keep class com.google.android.gms.cast.CastMediaControlIntent* {
+  *;
+}
+
+-keepnames class com.google.android.gms.gcm.** {
+  *;
+}
+
+-keepclassmembers class com.google.android.gms.gcm.TaskParams {
+  public <init>(java.lang.String);
+}
+
+-keepnames class jp.tomorrowkey.android.gifplayer.** {
+  public *;
+}
+
+# Used in tests.
+-keep class android.support.v4.view.ViewCompat {
+  public static int getLayoutDirection(android.view.View);
+}
+
+# flingViewport is used by Android WebView and a Chrome test.
+-keepclassmembers class org.chromium.content.browser.ContentViewCore {
+  public void flingViewport(long, int, int);
+}
+
+# Needed to compile ChromeTest.apk
+-keep class android.support.customtabs.** {
   *;
 }
 
 # TODO(yfriedman): Remove when crbug.com/488192 is fixed.
 -dontwarn org.apache.http.conn.scheme.LayeredSocketFactory
 
-# We have some "library class WebView depends on program class SslCertificate"
-# warnings, and they don't affect us.
--dontwarn android.webkit.WebView*
-
-# We don't want BasicHttpParams or AbstractHttpParams to get renamed since that
-# then makes our calls to them use the implementation that we find in our .dex
-# file, which is broken. We need to rely on these calls resolving to the
-# system's implementation. See crbug.com/488192#c36.
--keep class org.apache.** {
+# Needed to run ChromeTest.apk
+-keepnames class com.google.android.gms.common.GoogleApiAvailability {
   *;
 }
+
+# Needed for chrome_sync_shell_test_apk. Note - these do no affect chrome_apk's
+# size.
+-keep class org.chromium.components.sync.protocol.* { *; }
+
+# These resources are referenced in tests, but not in the real application.
+-keepclassmembers class org.chromium.chrome.R$id {
+  int webapp_splash_space;
+  int mr_chooser_list;
+  int find_toolbar;
+}
diff --git a/testing/buildbot/chromium.fyi.json b/testing/buildbot/chromium.fyi.json
index 39315eb..76288d5 100644
--- a/testing/buildbot/chromium.fyi.json
+++ b/testing/buildbot/chromium.fyi.json
@@ -957,9 +957,6 @@
         "test": "crypto_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "dbus_unittests"
       },
       {
@@ -1011,9 +1008,6 @@
         "test": "gin_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "gl_unittests"
       },
       {
@@ -1319,9 +1313,6 @@
         "test": "crypto_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "dbus_unittests"
       },
       {
@@ -1373,9 +1364,6 @@
         "test": "gin_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "gl_unittests"
       },
       {
@@ -1638,15 +1626,27 @@
         "test": "midi_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_common_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_public_bindings_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_public_system_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_system_unittests"
       },
       {
@@ -1774,15 +1774,27 @@
         "test": "midi_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_common_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_public_bindings_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_public_system_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_system_unittests"
       },
       {
@@ -1941,15 +1953,27 @@
         "test": "midi_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_common_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_public_bindings_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_public_system_unittests"
       },
       {
+        "swarming": {
+          "can_use_on_swarming_builders": true
+        },
         "test": "mojo_system_unittests"
       },
       {
@@ -2018,9 +2042,6 @@
         "test": "angle_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "app_shell_unittests"
       },
       {
@@ -2030,9 +2051,6 @@
         "test": "aura_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "base_unittests"
       },
       {
@@ -2079,9 +2097,6 @@
         "test": "cc_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "chromedriver_unittests"
       },
       {
@@ -2109,15 +2124,9 @@
         "test": "content_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "crypto_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "dbus_unittests"
       },
       {
@@ -2133,9 +2142,6 @@
         "test": "display_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "events_unittests"
       },
       {
@@ -2241,9 +2247,6 @@
         "test": "mojo_system_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "nacl_helper_nonsfi_unittests"
       },
       {
@@ -2253,9 +2256,6 @@
         "test": "nacl_loader_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "net_unittests"
       },
       {
@@ -2301,9 +2301,6 @@
         "test": "ui_base_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "ui_touch_selection_unittests"
       },
       {
@@ -2331,9 +2328,6 @@
         "test": "webkit_unit_tests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "wm_unittests"
       },
       {
@@ -2618,9 +2612,6 @@
         "test": "angle_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "app_shell_unittests"
       },
       {
@@ -2630,9 +2621,6 @@
         "test": "aura_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "base_unittests"
       },
       {
@@ -2679,9 +2667,6 @@
         "test": "cc_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "chromedriver_unittests"
       },
       {
@@ -2709,15 +2694,9 @@
         "test": "content_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "crypto_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "dbus_unittests"
       },
       {
@@ -2733,9 +2712,6 @@
         "test": "display_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "events_unittests"
       },
       {
@@ -2805,9 +2781,6 @@
         "test": "midi_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "mojo_common_unittests"
       },
       {
@@ -2823,15 +2796,9 @@
         "test": "mojo_public_system_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "mojo_system_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "nacl_helper_nonsfi_unittests"
       },
       {
@@ -2841,9 +2808,6 @@
         "test": "nacl_loader_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "net_unittests"
       },
       {
@@ -2889,9 +2853,6 @@
         "test": "ui_base_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "ui_touch_selection_unittests"
       },
       {
@@ -2919,9 +2880,6 @@
         "test": "webkit_unit_tests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "wm_unittests"
       },
       {
@@ -3120,9 +3078,6 @@
   "ClangToTMac tester": {
     "gtest_tests": [
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "accessibility_unittests"
       },
       {
@@ -3182,9 +3137,6 @@
         "test": "cc_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "chromedriver_unittests"
       },
       {
@@ -3284,9 +3236,6 @@
         "test": "media_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "message_center_unittests"
       },
       {
@@ -3362,9 +3311,6 @@
         "test": "sql_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "sync_integration_tests"
       },
       {
@@ -3448,9 +3394,6 @@
   "ClangToTMacASan tester": {
     "gtest_tests": [
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "accessibility_unittests"
       },
       {
@@ -3509,9 +3452,6 @@
         "test": "cc_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "chromedriver_unittests"
       },
       {
@@ -3611,9 +3551,6 @@
         "test": "media_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "message_center_unittests"
       },
       {
@@ -3689,9 +3626,6 @@
         "test": "sql_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "sync_integration_tests"
       },
       {
@@ -3829,12 +3763,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -4098,12 +4026,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -4361,12 +4283,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -4624,12 +4540,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -4887,12 +4797,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -5150,12 +5054,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -5401,12 +5299,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -5866,12 +5758,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -6105,12 +5991,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -6368,12 +6248,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -6631,12 +6505,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -6894,12 +6762,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -7157,12 +7019,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -7420,12 +7276,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -7683,12 +7533,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -7946,12 +7790,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -8209,12 +8047,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -8466,12 +8298,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
@@ -8767,9 +8593,6 @@
         "test": "crypto_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "dbus_unittests"
       },
       {
@@ -8821,9 +8644,6 @@
         "test": "gin_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "gl_unittests"
       },
       {
@@ -9051,9 +8871,6 @@
         "test": "accessibility_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "app_shell_unittests"
       },
       {
@@ -9135,9 +8952,6 @@
         "test": "crypto_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "dbus_unittests"
       },
       {
@@ -9249,9 +9063,6 @@
         "test": "mojo_system_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "nacl_helper_nonsfi_unittests"
       },
       {
@@ -9595,9 +9406,6 @@
         "test": "accessibility_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "app_shell_unittests"
       },
       {
@@ -9679,9 +9487,6 @@
         "test": "crypto_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "dbus_unittests"
       },
       {
@@ -9799,9 +9604,6 @@
         "test": "mojo_system_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "nacl_helper_nonsfi_unittests"
       },
       {
@@ -10708,9 +10510,6 @@
         "test": "crypto_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "dbus_unittests"
       },
       {
@@ -10762,9 +10561,6 @@
         "test": "gin_unittests"
       },
       {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "gl_unittests"
       },
       {
@@ -11022,12 +10818,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "extensions_unittests"
       },
       {
diff --git a/testing/buildbot/chromium.win.json b/testing/buildbot/chromium.win.json
index d4eab83..9cd38f8 100644
--- a/testing/buildbot/chromium.win.json
+++ b/testing/buildbot/chromium.win.json
@@ -150,12 +150,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "display_unittests"
       },
       {
@@ -665,12 +659,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "display_unittests"
       },
       {
@@ -1113,12 +1101,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "display_unittests"
       },
       {
@@ -1577,12 +1559,6 @@
         "swarming": {
           "can_use_on_swarming_builders": true
         },
-        "test": "disable_outdated_build_detector_unittests"
-      },
-      {
-        "swarming": {
-          "can_use_on_swarming_builders": true
-        },
         "test": "events_unittests"
       },
       {
diff --git a/testing/buildbot/gn_isolate_map.pyl b/testing/buildbot/gn_isolate_map.pyl
index 75e1cfd..c143fd6 100644
--- a/testing/buildbot/gn_isolate_map.pyl
+++ b/testing/buildbot/gn_isolate_map.pyl
@@ -270,10 +270,6 @@
     "label": "//device:device_unittests",
     "type": "console_test_launcher",
   },
-  "disable_outdated_build_detector_unittests": {
-    "label": "//chrome/tools/disable_outdated_build_detector:disable_outdated_build_detector_unittests",
-    "type": "console_test_launcher",
-  },
   "display_unittests": {
     "label": "//ui/display:display_unittests",
     "type": "console_test_launcher",
diff --git a/testing/libfuzzer/README.md b/testing/libfuzzer/README.md
index fd45215..a58756d 100644
--- a/testing/libfuzzer/README.md
+++ b/testing/libfuzzer/README.md
@@ -15,7 +15,7 @@ engineers to uncover potential security & stability problems earlier.
 
 *** note
 **Requirements:** libFuzzer in Chrome is supported with GN on Linux only. 
-Check [Reference] for experimental platform availability.
+**Check [Reference] for experimental platform availability.
 ***
 
 ## Integration Status
@@ -42,11 +42,6 @@ libFuzzer.
 * [Pdfium Bugs] - bugs found in pdfium by manual fuzzing.
 * [OSS Trophies] - bugs found with libFuzzer in open-source projects.
 
-
-## Blog Posts
-* [Guided in-process fuzzing of Chrome components].
-
-
 [libFuzzer]: http://llvm.org/docs/LibFuzzer.html
 [crbug.com/539572]: https://bugs.chromium.org/p/chromium/issues/detail?id=539572
 [Cover Bug]: https://bugs.chromium.org/p/chromium/issues/detail?id=539572
@@ -59,4 +54,3 @@ libFuzzer.
 [Pdfium Bugs]: https://bugs.chromium.org/p/pdfium/issues/list?can=1&q=libfuzzer&colspec=ID+Type+Status+Priority+Milestone+Owner+Summary&cells=tiles
 [Manual Bugs]: https://bugs.chromium.org/p/chromium/issues/list?can=1&q=label%3AStability-LibFuzzer+-label%3AClusterFuzz&sort=-modified&colspec=ID+Pri+M+Stars+ReleaseBlock+Component+Status+Owner+Summary+OS+Modified&x=m&y=releaseblock&cells=ids
 [OSS Trophies]: http://llvm.org/docs/LibFuzzer.html#trophies
-[Guided in-process fuzzing of Chrome components]: https://security.googleblog.com/2016/08/guided-in-process-fuzzing-of-chrome.html
diff --git a/testing/test.gni b/testing/test.gni
index 86b4abf..eb386d7 100644
--- a/testing/test.gni
+++ b/testing/test.gni
@@ -249,10 +249,18 @@ template("test") {
         info_plist = "//testing/gtest_ios/unittest-Info.plist"
       }
 
+      # TODO(crbug.com/603102): remove this once gyp support is dropped and all
+      # application uses the target name as value for BUNDLE_ID_TEST_NAME.
+      if (defined(invoker.app_name)) {
+        app_name = invoker.app_name
+      } else {
+        app_name = target_name
+      }
+
       if (!defined(extra_substitutions)) {
         extra_substitutions = []
       }
-      extra_substitutions += [ "BUNDLE_ID_TEST_NAME=$target_name" ]
+      extra_substitutions += [ "BUNDLE_ID_TEST_NAME=$app_name" ]
 
       if (!defined(deps)) {
         deps = []
diff --git a/third_party/WebKit/LayoutTests/TestExpectations b/third_party/WebKit/LayoutTests/TestExpectations
index 2075a5e..4309ee2 100644
--- a/third_party/WebKit/LayoutTests/TestExpectations
+++ b/third_party/WebKit/LayoutTests/TestExpectations
@@ -35,7 +35,7 @@ crbug.com/524236 virtual/spv2/compositing/repaint/should-not-repaint-composited-
 crbug.com/524236 virtual/spv2/compositing/repaint/should-not-repaint-composited-opacity.html [ Failure ]
 crbug.com/524236 virtual/spv2/compositing/repaint/should-not-repaint-composited-transform.html [ Failure ]
 crbug.com/524236 virtual/spv2/fast/repaint/clip-path-constant-repaint.html [ Failure ]
-crbug.com/524236 crbug.com/619103 virtual/spv2/fast/repaint/relative-positioned-movement-repaint.html [ Failure Crash Timeout ]
+crbug.com/524236 virtual/spv2/fast/repaint/relative-positioned-movement-repaint.html [ Failure Crash Timeout ]
 crbug.com/510908 virtual/spv2/svg/custom/object-sizing-no-width-height-change-content-box-size.xhtml [ Failure ]
 
 crbug.com/504613 crbug.com/524248 paint/images/image-backgrounds-not-antialiased.html [ Skip ]
@@ -612,6 +612,16 @@ crbug.com/492664 imported/csswg-test/css-writing-modes-3/table-progression-vrl-0
 # Test sometimes flakes on most platforms
 crbug.com/571531 imported/csswg-test/css-flexbox-1/css-flexbox-height-animation-stretch.html [ Pass Failure ]
 
+crbug.com/529938 virtual/spv2/fast/block/positioning/absolute-length-of-neg-666666.html [ Skip ]
+
+crbug.com/617785 fast/borders/block-mask-overlay-image-outset.html [ Skip ]
+
+# Some SVG tests fail due to incorrect visual rects.
+crbug.com/598051 css3/filters/effect-reference-hidpi.html [ Skip ]
+crbug.com/598051 svg/custom/absolute-sized-content-with-resources.xhtml [ Skip ]
+crbug.com/598051 svg/overflow/overflow-on-foreignObject.svg [ Skip ]
+crbug.com/598051 svg/zoom/page/zoom-foreignObject.svg [ Skip ]
+
 # Either "combo" or split should run: http://testthewebforward.org/docs/css-naming.html
 crbug.com/410320 imported/csswg-test/css-writing-modes-3/orthogonal-parent-shrink-to-fit-001.html [ Skip ]
 crbug.com/492664 imported/csswg-test/css-writing-modes-3/text-orientation-script-001.html [ Skip ]
@@ -748,7 +758,7 @@ crbug.com/324370 compositing/video/video-reflection.html [ Failure ]
 crbug.com/390377 [ Release ] fast/dom/private_script_unittest.html [ Skip ]
 
 crbug.com/613887 http/tests/preload/meta-viewport-link-headers.html [ Failure Pass ]
-crbug.com/564403 http/tests/inspector/service-workers/service-worker-manager.html [ Failure Pass Crash Timeout ]
+crbug.com/564403 http/tests/inspector/service-workers/service-worker-manager.html [ Failure Pass ]
 
 crbug.com/613728 fast/table/border-collapsing/cached-cell-append.html [ Failure ]
 crbug.com/613728 fast/table/border-collapsing/cached-69296.html [ Failure ]
@@ -953,6 +963,7 @@ crbug.com/336604 imported/csswg-test/css-flexbox-1/flexbox_visibility-collapse-l
 crbug.com/336604 imported/csswg-test/css-flexbox-1/flexbox_visibility-collapse.html [ Failure ]
 crbug.com/249112 imported/csswg-test/css-flexbox-1/flex-minimum-width-flex-items-006.xht [ Failure ]
 
+crbug.com/467127 imported/csswg-test/css-flexbox-1/flex-grow-006.html [ Failure ]
 crbug.com/467127 imported/csswg-test/css-flexbox-1/flex-aspect-ratio-img-column-003.html [ Failure ]
 crbug.com/467127 imported/csswg-test/css-flexbox-1/flex-aspect-ratio-img-row-002.html [ Failure ]
 crbug.com/467127 imported/csswg-test/css-flexbox-1/flex-aspect-ratio-img-row-003.html [ Failure ]
@@ -975,6 +986,7 @@ crbug.com/599828 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reft
 crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-canvas-vert-001.xhtml [ Failure ]
 crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-iframe-vert-001.xhtml [ Failure ]
 crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-img-vert-001.xhtml [ Failure ]
+crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-horiz-001.xhtml [ Failure ]
 crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-vert-001.xhtml [ Failure ]
 crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-video-vert-001.xhtml [ Failure ]
 crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-break-request-horiz-001a.html [ Failure ]
@@ -996,6 +1008,8 @@ crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reft
 crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-min-width-auto-002a.html [ Failure ]
 crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-min-width-auto-002c.html [ Failure ]
 crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-paint-ordering-002.xhtml [ Failure ]
+crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001a.xhtml [ Failure ]
+crbug.com/553838 imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001b.xhtml [ Failure ]
 crbug.com/553838 [ Mac ] imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-align-self-baseline-horiz-001a.xhtml [ Failure ]
 crbug.com/553838 [ Mac ] imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-align-self-baseline-horiz-001b.xhtml [ Failure ]
 
@@ -1295,7 +1309,6 @@ crbug.com/624019 [ Mac ] bluetooth/notifications/parallel-start-stop.html [ Skip
 crbug.com/624019 [ Mac ] bluetooth/notifications/start-before-stop-resolves.html [ Skip ]
 crbug.com/624019 [ Mac ] bluetooth/notifications/start-stop-start-stop.html [ Skip ]
 crbug.com/624019 [ Mac ] bluetooth/notifications/start-succeeds.html [ Skip ]
-crbug.com/624019 [ Mac ] bluetooth/notifications/stop-after-start-succeeds.html [ Skip ]
 crbug.com/624019 [ Mac ] bluetooth/notifications/stop-twice.html [ Skip ]
 crbug.com/624019 [ Mac ] bluetooth/notifications/stop-without-starting.html [ Skip ]
 
diff --git a/third_party/WebKit/LayoutTests/bluetooth/notifications/start-succeeds.html b/third_party/WebKit/LayoutTests/bluetooth/notifications/start-succeeds.html
index eff0ec8..df88265 100644
--- a/third_party/WebKit/LayoutTests/bluetooth/notifications/start-succeeds.html
+++ b/third_party/WebKit/LayoutTests/bluetooth/notifications/start-succeeds.html
@@ -11,13 +11,7 @@ promise_test(() => {
     .then(device => device.gatt.connect())
     .then(gattServer => gattServer.getPrimaryService('heart_rate'))
     .then(service => service.getCharacteristic('heart_rate_measurement'))
-    .then(characteristic => {
-      return characteristic.startNotifications()
-        .then(start_characteristic => {
-          assert_equals(start_characteristic, characteristic,
-	                'Start characteristic should be the same as characteristic.');
-        });
-    });
+    .then(characteristic => characteristic.startNotifications());
   // TODO(ortuno): Assert that notifications are active.
   // http://crbug.com/600762
 }, 'Single start notifications succeeds.');
diff --git a/third_party/WebKit/LayoutTests/bluetooth/notifications/stop-after-start-succeeds.html b/third_party/WebKit/LayoutTests/bluetooth/notifications/stop-after-start-succeeds.html
deleted file mode 100644
index ca0832b..0000000
--- a/third_party/WebKit/LayoutTests/bluetooth/notifications/stop-after-start-succeeds.html
+++ /dev/null
@@ -1,29 +0,0 @@
-<!DOCTYPE html>
-<script src="../../resources/testharness.js"></script>
-<script src="../../resources/testharnessreport.js"></script>
-<script src="../../resources/bluetooth/bluetooth-helpers.js"></script>
-<script>
-'use strict';
-promise_test(() => {
-  return setBluetoothFakeAdapter('HeartRateAdapter')
-    .then(() => requestDeviceWithKeyDown({
-      filters: [{services: ['heart_rate']}]}))
-    .then(device => device.gatt.connect())
-    .then(gattServer => gattServer.getPrimaryService('heart_rate'))
-    .then(service => service.getCharacteristic('heart_rate_measurement'))
-    .then(characteristic => {
-      return characteristic.startNotifications()
-        .then(start_characteristic => {
-            assert_equals(start_characteristic, characteristic,
-                'Start characteristic should the same as characteristic.');
-            return characteristic.stopNotifications()
-              .then(stop_characteristic => {
-                assert_equals(stop_characteristic, start_characteristic,
-                    'Stop characteristic should the same as start characteristic.');
-              });
-         });
-     });
-  // TODO(ortuno): Assert that notifications are not active.
-  // http://crbug.com/600762
-}, 'Single stop after start notifications succeeds.');
-</script>
diff --git a/third_party/WebKit/LayoutTests/css3/flexbox/bug633212.html b/third_party/WebKit/LayoutTests/css3/flexbox/bug633212.html
deleted file mode 100644
index f16d3e2..0000000
--- a/third_party/WebKit/LayoutTests/css3/flexbox/bug633212.html
+++ /dev/null
@@ -1,51 +0,0 @@
-<!DOCTYPE html>
-<style>
-html, body {
-  margin: 0;
-}
-
-#flexbox {
-    display: flex;
-    flex-direction: column;
-}
-
-#flexitem {
-    outline: 1px solid black;
-    width: 100%;
-    height: 166px;
-    position: relative;
-    background: green;
-}
-
-#abspos {
-    position: absolute;
-}
-
-#container {
-    background: red;
-}
-</style>
-
-<script src="../../resources/testharness.js"></script>
-<script src="../../resources/testharnessreport.js"></script>
-
-<script>
-function runTest() {
-  test(function() {
-    assert_equals(document.getElementById('flexbox').offsetWidth,
-      document.getElementById('flexitem').offsetWidth);
-  }, "sizes");
-}
-</script>
-
-<body onload="runTest()">
-<div id="container">
-  <div id="flexbox">
-      <div id="flexitem">
-          <div id="abspos">
-              <svg></svg>
-          </div>
-      </div>
-  </div>
-</div>
-
diff --git a/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-blob-resize.html b/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-blob-resize.html
deleted file mode 100644
index 1e08e69..0000000
--- a/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-blob-resize.html
+++ /dev/null
@@ -1,78 +0,0 @@
-<!DOCTYPE html>
-<html>
-<head>
-<script src="./resources/webgl-test-utils-full.js"></script>
-<script src="./resources/tex-image-and-sub-image-utils.js"></script>
-<script src="./resources/tex-image-and-sub-image-image-bitmap-utils.js"></script>
-<script src="../../../resources/testharness.js"></script>
-<script src="../../../resources/testharnessreport.js"></script>
-<body>
-<script>
-var wtu = WebGLTestUtils;
-var tiu = TexImageUtils;
-var gl = null;
-var internalFormat = "RGBA";
-var pixelFormat = "RGBA";
-var pixelType = "UNSIGNED_BYTE";
-var redColor = [255, 0, 0];
-var greenColor = [0, 255, 0];
-var blackColor = [0, 0, 0];
-var darkRed = [26, 0, 0];
-var darkGreen = [0, 26, 0];
-
-var blob1 = null;
-var blob2 = null;
-
-function generateTest()
-{
-    var bitmaps = [];
-
-    var canvas = document.createElement('canvas');
-    canvas.width = 32;
-    canvas.height = 32;
-    document.body.appendChild(canvas);
-    gl = canvas.getContext("webgl");
-
-    gl.clearColor(0,0,0,1);
-    gl.clearDepth(1);
-
-    var p1 = createImageBitmap(blob1, {resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.defaultOption = imageBitmap });
-    var p2 = createImageBitmap(blob1, {imageOrientation: "none", premultiplyAlpha: "premultiply", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.noFlipYPremul = imageBitmap });
-    var p3 = createImageBitmap(blob1, {imageOrientation: "none", premultiplyAlpha: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.noFlipYDefault = imageBitmap });
-    var p4 = createImageBitmap(blob1, {imageOrientation: "none", premultiplyAlpha: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.noFlipYUnpremul = imageBitmap });
-    var p5 = createImageBitmap(blob1, {imageOrientation: "flipY", premultiplyAlpha: "premultiply", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.flipYPremul = imageBitmap });
-    var p6 = createImageBitmap(blob1, {imageOrientation: "flipY", premultiplyAlpha: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.flipYDefault = imageBitmap });
-    var p7 = createImageBitmap(blob1, {imageOrientation: "flipY", premultiplyAlpha: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.flipYUnpremul = imageBitmap });
-    var p8 = createImageBitmap(blob2, {resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.colorSpaceDef = imageBitmap });
-    var p9 = createImageBitmap(blob2, {colorSpaceConversion: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.colorSpaceNone = imageBitmap });
-    var p10 = createImageBitmap(blob2, {colorSpaceConversion: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.colorSpaceDefault = imageBitmap });
-    return Promise.all([p1, p2, p3, p4, p5, p6, p7, p8, p9, p10]).then(function() {
-        var alphaVal = 0.5;
-        var testPassed = runTest(bitmaps, alphaVal, true);
-        if (!testPassed)
-            assert_true(false, 'Test failed');
-    }, function() {
-        assert_true(false, 'Promise rejected');
-    });
-}
-
-promise_test(function() {
-    var xhr1 = new XMLHttpRequest();
-    xhr1.open("GET", 'resources/red-green-semi-transparent.png');
-    xhr1.responseType = 'blob';
-    xhr1.send();
-    xhr1.onload = function() {
-        blob1 = xhr1.response;
-        var xhr2 = new XMLHttpRequest();
-        xhr2.open("GET", 'resources/square-with-colorspin-profile.png');
-        xhr2.responseType = 'blob';
-        xhr2.send();
-        xhr2.onload = function() {
-            blob2 = xhr2.response;
-            return generateTest();
-        }
-    }
-}, 'createImageBitmap(Blob) with resize and other options');
-</script>
-</body>
-</html>
diff --git a/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-canvas-resize.html b/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-canvas-resize.html
deleted file mode 100644
index 257dc0d..0000000
--- a/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-canvas-resize.html
+++ /dev/null
@@ -1,77 +0,0 @@
-<!DOCTYPE html>
-<html>
-<head>
-<script src="./resources/webgl-test-utils-full.js"></script>
-<script src="./resources/tex-image-and-sub-image-utils.js"></script>
-<script src="./resources/tex-image-and-sub-image-image-bitmap-utils.js"></script>
-<script src="../../../resources/testharness.js"></script>
-<script src="../../../resources/testharnessreport.js"></script>
-<body>
-<script>
-var wtu = WebGLTestUtils;
-var tiu = TexImageUtils;
-var gl = null;
-var internalFormat = "RGBA";
-var pixelFormat = "RGBA";
-var pixelType = "UNSIGNED_BYTE";
-var redColor = [255, 0, 0];
-var greenColor = [0, 255, 0];
-var blackColor = [0, 0, 0];
-var darkRed = [26, 0, 0];
-var darkGreen = [0, 26, 0];
-
-function setCanvasToRedGreen(ctx) {
-    ctx.canvas.width = 2;
-    ctx.canvas.height = 2;
-    var width = ctx.canvas.width;
-    var halfWidth = Math.floor(width / 2);
-    var height = ctx.canvas.height;
-    var halfHeight = Math.floor(height / 2);
-    ctx.fillStyle = "rgba(255, 0, 0, 1)";
-    ctx.fillRect(0, 0, halfWidth, halfHeight);
-    ctx.fillStyle = "rgba(255, 0, 0, 0.1)";
-    ctx.fillRect(halfWidth, 0, halfWidth, halfHeight);
-    ctx.fillStyle = "rgba(0, 255, 0, 1)";
-    ctx.fillRect(0, halfHeight, halfWidth, halfHeight);
-    ctx.fillStyle = "rgba(0, 255, 0, 0.1)";
-    ctx.fillRect(halfWidth, halfHeight, halfWidth, halfHeight);
-}
-
-promise_test(function() {
-    var bitmaps = [];
-
-    var canvas = document.createElement('canvas');
-    canvas.width = 32;
-    canvas.height = 32;
-    document.body.appendChild(canvas);
-    gl = canvas.getContext("webgl");
-
-    gl.clearColor(0,0,0,1);
-    gl.clearDepth(1);
-
-    var testCanvas = document.createElement('canvas');
-    var ctx = testCanvas.getContext("2d");
-    setCanvasToRedGreen(ctx);
-
-    var p1 = createImageBitmap(testCanvas, {resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.defaultOption = imageBitmap });
-    var p2 = createImageBitmap(testCanvas, {imageOrientation: "none", premultiplyAlpha: "premultiply", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.noFlipYPremul = imageBitmap });
-    var p3 = createImageBitmap(testCanvas, {imageOrientation: "none", premultiplyAlpha: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.noFlipYDefault = imageBitmap });
-    var p4 = createImageBitmap(testCanvas, {imageOrientation: "none", premultiplyAlpha: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.noFlipYUnpremul = imageBitmap });
-    var p5 = createImageBitmap(testCanvas, {imageOrientation: "flipY", premultiplyAlpha: "premultiply", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.flipYPremul = imageBitmap });
-    var p6 = createImageBitmap(testCanvas, {imageOrientation: "flipY", premultiplyAlpha: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.flipYDefault = imageBitmap });
-    var p7 = createImageBitmap(testCanvas, {imageOrientation: "flipY", premultiplyAlpha: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.flipYUnpremul = imageBitmap });
-    var p8 = createImageBitmap(testCanvas, {resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.colorSpaceDef = imageBitmap });
-    var p9 = createImageBitmap(testCanvas, {colorSpaceConversion: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.colorSpaceNone = imageBitmap });
-    var p10 = createImageBitmap(testCanvas, {colorSpaceConversion: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.colorSpaceDefault = imageBitmap });
-    Promise.all([p1, p2, p3, p4, p5, p6, p7, p8, p9, p10]).then(function() {
-        var alphaVal = 0.5;
-        var testPassed = runTest(bitmaps, alphaVal, false);
-        if (!testPassed)
-            assert_true(false, 'Test failed');
-    }, function() {
-        assert_true(false, 'Promise rejected');
-    });
-}, 'createImageBitmap(HTMLCanvasElement) with resize and other options');
-</script>
-</body>
-</html>
diff --git a/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-image-resize.html b/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-image-resize.html
deleted file mode 100644
index ffb5e1a..0000000
--- a/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-image-resize.html
+++ /dev/null
@@ -1,74 +0,0 @@
-<!DOCTYPE html>
-<html>
-<head>
-<script src="./resources/webgl-test-utils-full.js"></script>
-<script src="./resources/tex-image-and-sub-image-utils.js"></script>
-<script src="./resources/tex-image-and-sub-image-image-bitmap-utils.js"></script>
-<script src="../../../resources/testharness.js"></script>
-<script src="../../../resources/testharnessreport.js"></script>
-</head>
-<body>
-<script>
-var wtu = WebGLTestUtils;
-var tiu = TexImageUtils;
-var gl = null;
-var internalFormat = "RGBA";
-var pixelFormat = "RGBA";
-var pixelType = "UNSIGNED_BYTE";
-var redColor = [255, 0, 0];
-var greenColor = [0, 255, 0];
-var blackColor = [0, 0, 0];
-var darkRed = [26, 0, 0];
-var darkGreen = [0, 26, 0];
-
-var image1 = new Image();
-var image2 = new Image();
-
-function generateTest()
-{
-    var bitmaps = [];
-
-    var canvas = document.createElement('canvas');
-    canvas.width = 32;
-    canvas.height = 32;
-    document.body.appendChild(canvas);
-    gl = canvas.getContext("webgl");
-
-    gl.clearColor(0,0,0,1);
-    gl.clearDepth(1);
-
-    var p1 = createImageBitmap(image1, {resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.defaultOption = imageBitmap });
-    var p2 = createImageBitmap(image1, {imageOrientation: "none", premultiplyAlpha: "premultiply", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.noFlipYPremul = imageBitmap });
-    var p3 = createImageBitmap(image1, {imageOrientation: "none", premultiplyAlpha: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.noFlipYDefault = imageBitmap });
-    var p4 = createImageBitmap(image1, {imageOrientation: "none", premultiplyAlpha: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.noFlipYUnpremul = imageBitmap });
-    var p5 = createImageBitmap(image1, {imageOrientation: "flipY", premultiplyAlpha: "premultiply", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.flipYPremul = imageBitmap });
-    var p6 = createImageBitmap(image1, {imageOrientation: "flipY", premultiplyAlpha: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.flipYDefault = imageBitmap });
-    var p7 = createImageBitmap(image1, {imageOrientation: "flipY", premultiplyAlpha: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.flipYUnpremul = imageBitmap });
-    var p8 = createImageBitmap(image2, {resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.colorSpaceDef = imageBitmap });
-    var p9 = createImageBitmap(image2, {colorSpaceConversion: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.colorSpaceNone = imageBitmap });
-    var p10 = createImageBitmap(image2, {colorSpaceConversion: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "high"}).then(function(imageBitmap) { bitmaps.colorSpaceDefault = imageBitmap });
-    return Promise.all([p1, p2, p3, p4, p5, p6, p7, p8, p9, p10]).then(function() {
-        var alphaVal = 0.5;
-        var testPassed = runTest(bitmaps, alphaVal, true);
-        if (!testPassed)
-            assert_true(false, 'Test failed');
-    }, function() {
-        assert_true(false, 'Promise rejected');
-    });
-}
-
-function loadImage(image, src) {
-    return new Promise((resolve, reject) => {
-        image.src = src;
-        image.addEventListener('load', () => {
-            resolve();
-        });
-    });
-}
-
-promise_test(function() {
-    Promise.all([loadImage(image1, 'resources/red-green-semi-transparent.png'), loadImage(image2, 'resources/square-with-colorspin-profile.png')]).then(generateTest);
-}, 'createImageBitmap(HTMLImageElement) with resize and other options');
-</script>
-</body>
-</html>
diff --git a/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-video-resize.html b/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-video-resize.html
deleted file mode 100644
index e8a690d..0000000
--- a/third_party/WebKit/LayoutTests/fast/canvas/webgl/texImage-imageBitmap-from-video-resize.html
+++ /dev/null
@@ -1,66 +0,0 @@
-<!DOCTYPE html>
-<html>
-<head>
-<script src="./resources/webgl-test-utils-full.js"></script>
-<script src="./resources/tex-image-and-sub-image-utils.js"></script>
-<script src="./resources/tex-image-and-sub-image-image-bitmap-utils.js"></script>
-<script src="../../../resources/testharness.js"></script>
-<script src="../../../resources/testharnessreport.js"></script>
-<body>
-<script>
-var wtu = WebGLTestUtils;
-var tiu = TexImageUtils;
-var gl = null;
-var internalFormat = "RGBA";
-var pixelFormat = "RGBA";
-var pixelType = "UNSIGNED_BYTE";
-var redColor = [255, 0, 0];
-var greenColor = [0, 255, 0];
-var blackColor = [0, 0, 0];
-var darkRed = [128, 0, 0];
-var darkGreen = [0, 128, 0];
-
-var video = document.createElement("video");
-
-function generateTest()
-{
-    var bitmaps = [];
-
-    var canvas = document.createElement('canvas');
-    canvas.width = 32;
-    canvas.height = 32;
-    document.body.appendChild(canvas);
-    gl = canvas.getContext("webgl");
-
-    gl.clearColor(0,0,0,1);
-    gl.clearDepth(1);
-
-    var p1 = createImageBitmap(video, {resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.defaultOption = imageBitmap });
-    var p2 = createImageBitmap(video, {imageOrientation: "none", premultiplyAlpha: "premultiply", resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.noFlipYPremul = imageBitmap });
-    var p3 = createImageBitmap(video, {imageOrientation: "none", premultiplyAlpha: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.noFlipYDefault = imageBitmap });
-    var p4 = createImageBitmap(video, {imageOrientation: "none", premultiplyAlpha: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.noFlipYUnpremul = imageBitmap });
-    var p5 = createImageBitmap(video, {imageOrientation: "flipY", premultiplyAlpha: "premultiply", resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.flipYPremul = imageBitmap });
-    var p6 = createImageBitmap(video, {imageOrientation: "flipY", premultiplyAlpha: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.flipYDefault = imageBitmap });
-    var p7 = createImageBitmap(video, {imageOrientation: "flipY", premultiplyAlpha: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.flipYUnpremul = imageBitmap });
-    var p8 = createImageBitmap(video, {resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.colorSpaceDef = imageBitmap });
-    var p9 = createImageBitmap(video, {colorSpaceConversion: "none", resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.colorSpaceNone = imageBitmap });
-    var p10 = createImageBitmap(video, {colorSpaceConversion: "default", resizeWidth: 4, resizeHeight: 4, resizeQuality: "hight"}).then(function(imageBitmap) { bitmaps.colorSpaceDefault = imageBitmap });
-    return Promise.all([p1, p2, p3, p4, p5, p6, p7, p8, p9, p10]).then(function() {
-        var alphaVal = 1;
-        var testPassed = runTest(bitmaps, alphaVal, false);
-        if (!testPassed)
-            assert_true(false, 'Test failed');
-    }, function() {
-        assert_true(false, 'Promise rejected');
-    });
-}
-
-promise_test(function() {
-    video.oncanplaythrough = function() {
-        return generateTest();
-    }
-    video.src = "resources/red-green.ogv";
-}, 'createImageBitmap(HTMLVideoElement) with resize and other options');
-</script>
-</body>
-</html>
diff --git a/third_party/WebKit/LayoutTests/fast/css/invalidation/independent-inheritance-fast-path-multiple-properties.html b/third_party/WebKit/LayoutTests/fast/css/invalidation/independent-inheritance-fast-path-multiple-properties.html
new file mode 100644
index 0000000..114c102
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/fast/css/invalidation/independent-inheritance-fast-path-multiple-properties.html
@@ -0,0 +1,95 @@
+<!DOCTYPE html>
+<script src="../../../resources/testharness.js"></script>
+<script src="../../../resources/testharnessreport.js"></script>
+<style>
+#c {
+    pointer-events: all;
+}
+#e {
+    visibility: collapse;
+}
+</style>
+
+<!-- The property is set on this outermost element. -->
+<div id="a">
+    <!-- Tests that the property is propagated through an element that inherits it -->
+    <div id="b">
+        <!-- Tests that the property stops propagating through an element that doesn't inherit it -->
+        <div id="c">
+            <!-- The property is also set on this inner element, which inherited it from its parent, and should now propagate down to #e and #f -->
+            <div id="d">
+                <!-- The property is also set on this inner element, which inherited it from its parent but now sets it itself, and should now propagate to #f -->
+                <div id="e">
+                    <!-- Tests that the above properties resolve correctly and this inherits the value from #f -->
+                    <div id="f">
+                    </div>
+                </div>
+            </div>
+        </div>
+    </div>
+</div>
+<script>
+test(function(t)
+{
+    if (!window.internals)
+        assert_unreached('This test requires window.internals.');
+
+    a.offsetTop; // Force recalc.
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 0);
+
+    assert_equals(getComputedStyle(a).pointerEvents, "auto");
+    assert_equals(getComputedStyle(b).pointerEvents, "auto");
+    assert_equals(getComputedStyle(c).pointerEvents, "all");
+    assert_equals(getComputedStyle(d).pointerEvents, "all");
+    assert_equals(getComputedStyle(e).pointerEvents, "all");
+    assert_equals(getComputedStyle(f).pointerEvents, "all");
+    assert_equals(getComputedStyle(a).visibility, "visible");
+    assert_equals(getComputedStyle(b).visibility, "visible");
+    assert_equals(getComputedStyle(c).visibility, "visible");
+    assert_equals(getComputedStyle(d).visibility, "visible");
+    assert_equals(getComputedStyle(e).visibility, "collapse");
+    assert_equals(getComputedStyle(f).visibility, "collapse");
+
+    a.offsetTop; // Force recalc.
+    a.style.pointerEvents = "none";
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 1);
+
+    a.offsetTop; // Force recalc.
+    a.style.visibility = "hidden";
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 1);
+
+    assert_equals(getComputedStyle(a).pointerEvents, "none");
+    assert_equals(getComputedStyle(b).pointerEvents, "none");
+    assert_equals(getComputedStyle(c).pointerEvents, "all");
+    assert_equals(getComputedStyle(d).pointerEvents, "all");
+    assert_equals(getComputedStyle(e).pointerEvents, "all");
+    assert_equals(getComputedStyle(f).pointerEvents, "all");
+    assert_equals(getComputedStyle(a).visibility, "hidden");
+    assert_equals(getComputedStyle(b).visibility, "hidden");
+    assert_equals(getComputedStyle(c).visibility, "hidden");
+    assert_equals(getComputedStyle(d).visibility, "hidden");
+    assert_equals(getComputedStyle(e).visibility, "collapse");
+    assert_equals(getComputedStyle(f).visibility, "collapse");
+
+    a.offsetTop; // Force recalc.
+    d.style.pointerEvents = "painted";
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 1);
+
+    a.offsetTop; // Force recalc.
+    e.style.visibility = "visible";
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 1);
+
+    assert_equals(getComputedStyle(a).pointerEvents, "none");
+    assert_equals(getComputedStyle(b).pointerEvents, "none");
+    assert_equals(getComputedStyle(c).pointerEvents, "all");
+    assert_equals(getComputedStyle(d).pointerEvents, "painted");
+    assert_equals(getComputedStyle(e).pointerEvents, "painted");
+    assert_equals(getComputedStyle(f).pointerEvents, "painted");
+    assert_equals(getComputedStyle(a).visibility, "hidden");
+    assert_equals(getComputedStyle(b).visibility, "hidden");
+    assert_equals(getComputedStyle(c).visibility, "hidden");
+    assert_equals(getComputedStyle(d).visibility, "hidden");
+    assert_equals(getComputedStyle(e).visibility, "visible");
+    assert_equals(getComputedStyle(f).visibility, "visible");
+}, "Changing both pointer-events and visibility on an element, both independent inherited properties, doesn't cause a style recalc for its children.");
+</script>
diff --git a/third_party/WebKit/LayoutTests/fast/css/invalidation/independent-inheritance-fast-path.html b/third_party/WebKit/LayoutTests/fast/css/invalidation/independent-inheritance-fast-path.html
new file mode 100644
index 0000000..7562b19
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/fast/css/invalidation/independent-inheritance-fast-path.html
@@ -0,0 +1,72 @@
+<!DOCTYPE html>
+<script src="../../../resources/testharness.js"></script>
+<script src="../../../resources/testharnessreport.js"></script>
+<div id="testContainer">
+    <div id="outer">
+        <div id="inner">
+            <div id="innermost"></div>
+        </div>
+    </div>
+</div>
+<script>
+
+var independent_properties = [
+    // Property name, Value 1, Value 2
+    ["pointerEvents", "auto", "all"],
+    ["visibility", "visible", "hidden"],
+];
+
+independent_properties.forEach(function(test_data)
+{
+    var propertyName = test_data[0];
+    var value1 = test_data[1];
+    var value2 = test_data[2];
+
+    test(function(t)
+    {
+        if (!window.internals)
+            assert_unreached('This test requires window.internals.');
+
+        // Create a nested div structure for the test.
+        var outer = document.createElement("div");
+        var inner = document.createElement("div");
+        var innermost = document.createElement("div");
+        testContainer.appendChild(outer);
+        outer.appendChild(inner);
+        inner.appendChild(innermost);
+
+        outer.offsetTop; // Force recalc.
+        assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 0);
+
+        // Set the whole container to the first value.
+        testContainer.style[propertyName] = value1;
+
+        // All elements start as the first value.
+        assert_equals(getComputedStyle(outer)[propertyName], value1);
+        assert_equals(getComputedStyle(inner)[propertyName], value1);
+        assert_equals(getComputedStyle(innermost)[propertyName], value1);
+        outer.offsetTop; // Force recalc.
+
+        // Changing outer also changes inner and innermost.
+        outer.style[propertyName] = value2;
+        assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 1, "Only outer should be recalced (3 without fast path)");
+
+        assert_equals(getComputedStyle(outer)[propertyName], value2);
+        assert_equals(getComputedStyle(inner)[propertyName], value2);
+        assert_equals(getComputedStyle(innermost)[propertyName], value2);
+        outer.offsetTop; // Force recalc.
+
+        // Changing inner to value1 changes all its children to that value.
+        inner.style[propertyName] = value1;
+        assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 1, "Only inner should be recalced (2 without fast path)");
+
+        assert_equals(getComputedStyle(outer)[propertyName], value2);
+        assert_equals(getComputedStyle(inner)[propertyName], value1);
+        assert_equals(getComputedStyle(innermost)[propertyName], value1);
+        outer.offsetTop; // Force recalc.
+
+        // Clear for next test.
+        outer.remove();
+    }, "Changing " + propertyName + ", an independent inherited property, propagates correctly with a single style recalc.");
+})
+</script>
diff --git a/third_party/WebKit/LayoutTests/fast/css/invalidation/non-independent-inheritance-identical-computed-styles.html b/third_party/WebKit/LayoutTests/fast/css/invalidation/non-independent-inheritance-identical-computed-styles.html
new file mode 100644
index 0000000..711924e
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/fast/css/invalidation/non-independent-inheritance-identical-computed-styles.html
@@ -0,0 +1,74 @@
+<!DOCTYPE html>
+<script src="../../../resources/testharness.js"></script>
+<script src="../../../resources/testharnessreport.js"></script>
+<div id="outer">
+    <div id="inner">
+        <div id="innermost">
+        </div>
+    </div>
+</div>
+<script>
+test(function(t)
+{
+    if (!window.internals)
+        assert_unreached('This test requires window.internals.');
+
+    outer.style.fontSize = "16px";
+    innermost.style.fontSize = "1em";
+
+    inner.offsetTop; // Force recalc.
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 0);
+
+    assert_equals(getComputedStyle(outer).fontSize, "16px");
+    assert_equals(getComputedStyle(inner).fontSize, "16px");
+    assert_equals(getComputedStyle(innermost).fontSize, "16px");
+
+    inner.offsetTop; // Force recalc.
+    outer.style.fontSize = '10px';
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 3);
+
+    assert_equals(getComputedStyle(outer).fontSize, "10px");
+    assert_equals(getComputedStyle(inner).fontSize, "10px");
+    assert_equals(getComputedStyle(innermost).fontSize, "10px");
+
+    inner.offsetTop; // Force recalc.
+    inner.style.fontSize = '16px';
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 2);
+
+    assert_equals(getComputedStyle(outer).fontSize, "10px");
+    assert_equals(getComputedStyle(inner).fontSize, "16px");
+    assert_equals(getComputedStyle(innermost).fontSize, "16px");
+}, "Changing font-size (a non-independent inherited property) in a way that results in an identical ComputedStyle still triggers a style recalc for its children.");
+
+test(function(t)
+{
+    if (!window.internals)
+        assert_unreached('This test requires window.internals.');
+
+    outer.style.fontWeight = "normal";
+    innermost.style.fontWeight = "lighter";
+
+    inner.offsetTop; // Force recalc.
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 0);
+
+    assert_equals(getComputedStyle(outer).fontWeight, "normal");
+    assert_equals(getComputedStyle(inner).fontWeight, "normal");
+    assert_equals(getComputedStyle(innermost).fontWeight, "100");
+
+    inner.offsetTop; // Force recalc.
+    inner.style.fontWeight = 'bolder';
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 2);
+
+    assert_equals(getComputedStyle(outer).fontWeight, "normal");
+    assert_equals(getComputedStyle(inner).fontWeight, "bold");
+    assert_equals(getComputedStyle(innermost).fontWeight, "normal");
+
+    inner.offsetTop; // Force recalc.
+    outer.style.fontWeight = 'bold';
+    assert_equals(internals.updateStyleAndReturnAffectedElementCount(), 3);
+
+    assert_equals(getComputedStyle(outer).fontWeight, "bold");
+    assert_equals(getComputedStyle(inner).fontWeight, "900");
+    assert_equals(getComputedStyle(innermost).fontWeight, "bold");
+}, "Changing font-weight (a non-independent inherited property) in a way that results in an identical ComputedStyle still triggers a style recalc for its children.");
+</script>
diff --git a/third_party/WebKit/LayoutTests/fast/mediarecorder/MediaRecorder-audio-video.html b/third_party/WebKit/LayoutTests/fast/mediarecorder/MediaRecorder-audio-video.html
index bf2bc70..55a7e14 100644
--- a/third_party/WebKit/LayoutTests/fast/mediarecorder/MediaRecorder-audio-video.html
+++ b/third_party/WebKit/LayoutTests/fast/mediarecorder/MediaRecorder-audio-video.html
@@ -27,13 +27,19 @@ var makeAsyncTest = function(value, expected) {
 
     async_test(function(test) {
         const recorderOnDataAvailable = this.step_func(function(event) {
+            if (event) {
+                assert_greater_than(event.data.size, 0,
+                                    'Recorded data size should be > 0');
+                assert_equals(recorder.state, "recording");
+            } else {
+                assert_equals(recorder.state, "inactive");
+            }
+
             // TODO(mcasas): Let the test record for a while.
             // TODO(mcasas): Consider storing recorded data and playing it back.
 
-            if (recorder.state == "recording") {
-                recorder.onstop = recorderOnStopExpected;
-                recorder.stop();
-            }
+            recorder.onstop = recorderOnStopExpected;
+            recorder.stop();
         });
 
         const recorderOnStopExpected = this.step_func_done();
@@ -41,7 +47,7 @@ var makeAsyncTest = function(value, expected) {
         const recorderOnStopUnexpected = test.unreached_func('Recording stopped.');
         const recorderOnError = test.unreached_func('Recording error.');
 
-        const gotStream = this.step_func(function(stream) {
+        const gotStream = this.step_func_done(function(stream) {
             checkStreamTracks(stream, value['video'], value['audio']);
 
             recorder = new MediaRecorder(stream);
@@ -53,7 +59,6 @@ var makeAsyncTest = function(value, expected) {
             recorder.start();
 
             assert_equals(recorder.state, "recording");
-            recorder.requestData();
         });
 
         const onError = test.unreached_func('Error creating MediaStream.');
diff --git a/third_party/WebKit/LayoutTests/fast/repaint/resize-iframe-text.html b/third_party/WebKit/LayoutTests/fast/repaint/resize-iframe-text.html
deleted file mode 100644
index 2183d4f..0000000
--- a/third_party/WebKit/LayoutTests/fast/repaint/resize-iframe-text.html
+++ /dev/null
@@ -1,12 +0,0 @@
-<!DOCTYPE html>
-<script src="resources/text-based-repaint.js"></script>
-<script>
-function repaintTest() {
-  if (window.testRunner)
-      testRunner.useUnfortunateSynchronousResizeMode();
-  window.resizeBy(0, 200);
-}
-onload = runRepaintAndPixelTest;
-</script>
-Test passes if you see "Success" after window resizes.
-<iframe style="position: absolute; left: 0; top: 0; border: none; height: 100%; width: 100%;" src="./resources/resize-iframe-text-src.html"></iframe>
diff --git a/third_party/WebKit/LayoutTests/fast/repaint/resources/resize-iframe-text-src.html b/third_party/WebKit/LayoutTests/fast/repaint/resources/resize-iframe-text-src.html
deleted file mode 100644
index 262d752..0000000
--- a/third_party/WebKit/LayoutTests/fast/repaint/resources/resize-iframe-text-src.html
+++ /dev/null
@@ -1,4 +0,0 @@
-<!DOCTYPE html>
-<div style="margin-top: 700px; max-width: 600px;">
-  <h1>Success</h1>
-</div>
diff --git a/third_party/WebKit/LayoutTests/fast/workers/worker-xhr-microtasks-expected.txt b/third_party/WebKit/LayoutTests/fast/workers/worker-xhr-microtasks-expected.txt
new file mode 100644
index 0000000..ddf2834
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/fast/workers/worker-xhr-microtasks-expected.txt
@@ -0,0 +1,3 @@
+CONSOLE WARNING: Invoking 'send()' on a sync XHR during microtask execution is deprecated and will be removed in M54, around October 2016. See https://www.chromestatus.com/features/5647113010544640 for more details.
+CONSOLE MESSAGE: line 9: PASS: xhr.send() throws as expected
+
diff --git a/third_party/WebKit/LayoutTests/fast/workers/worker-xhr-microtasks.html b/third_party/WebKit/LayoutTests/fast/workers/worker-xhr-microtasks.html
new file mode 100644
index 0000000..7e7d76a
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/fast/workers/worker-xhr-microtasks.html
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<script>
+if (window.testRunner) {
+    testRunner.dumpAsText();
+    testRunner.waitUntilDone();
+}
+
+var worker = new Worker("resources/worker-xhr-microtasks.js");
+worker.onmessage = function(evt) {
+    if (window.testRunner)
+        testRunner.notifyDone();
+};
+worker.postMessage("run");
+</script>
diff --git a/third_party/WebKit/LayoutTests/http/tests/inspector/cache-storage/cache-deletion.html b/third_party/WebKit/LayoutTests/http/tests/inspector/cache-storage/cache-deletion.html
index f9d11be..aef0931 100644
--- a/third_party/WebKit/LayoutTests/http/tests/inspector/cache-storage/cache-deletion.html
+++ b/third_party/WebKit/LayoutTests/http/tests/inspector/cache-storage/cache-deletion.html
@@ -28,7 +28,7 @@ function test()
             .then(InspectorTest.addCacheEntry.bind(this, "testCache2", "http://fake.request2.com/2", "Not Found"))
             .then(InspectorTest.dumpCacheTree)
             .then(InspectorTest.deleteCache.bind(this, "testCache1"))
-            .then(InspectorTest.deleteCacheFromInspector.bind(this, "testCache2", undefined))
+            .then(InspectorTest.deleteCacheFromInspector.bind(this, "testCache2"))
             .then(InspectorTest.dumpCacheTree)
             .then(InspectorTest.clearAllCaches)
             .then(InspectorTest.completeTest)
diff --git a/third_party/WebKit/LayoutTests/http/tests/inspector/cache-storage/cache-storage-test.js b/third_party/WebKit/LayoutTests/http/tests/inspector/cache-storage/cache-storage-test.js
index 849fd86..ee4889d 100644
--- a/third_party/WebKit/LayoutTests/http/tests/inspector/cache-storage/cache-storage-test.js
+++ b/third_party/WebKit/LayoutTests/http/tests/inspector/cache-storage/cache-storage-test.js
@@ -135,43 +135,44 @@ InspectorTest.waitForCacheRefresh = function(callback)
 
 InspectorTest.createCache = function(cacheName)
 {
-    return InspectorTest.callFunctionInPageAsync("createCache", [ cacheName ]);
+    return InspectorTest.invokePageFunctionPromise("createCache", [cacheName]);
 }
 
 InspectorTest.addCacheEntry = function(cacheName, requestUrl, responseText)
 {
-    return InspectorTest.callFunctionInPageAsync("addCacheEntry", [ cacheName, requestUrl, responseText ]);
+    return InspectorTest.invokePageFunctionPromise("addCacheEntry", [cacheName, requestUrl, responseText]);
 }
 
 InspectorTest.deleteCache = function(cacheName)
 {
-    return InspectorTest.callFunctionInPageAsync("deleteCache", [ cacheName ]);
+    return InspectorTest.invokePageFunctionPromise("deleteCache", [cacheName]);
 }
 
 InspectorTest.deleteCacheEntry = function(cacheName, requestUrl)
 {
-    return InspectorTest.callFunctionInPageAsync("deleteCacheEntry", [ cacheName, requestUrl ]);
+    return InspectorTest.invokePageFunctionPromise("deleteCacheEntry", [cacheName, requestUrl]);
 }
 
 InspectorTest.clearAllCaches = function()
 {
-    return InspectorTest.callFunctionInPageAsync("clearAllCaches");
+    return InspectorTest.invokePageFunctionPromise("clearAllCaches", []);
 }
 }
 
-function onCacheStorageError(e)
+function onCacheStorageError(reject, e)
 {
     console.error("CacheStorage error: " + e);
+    reject();
 }
 
-function createCache(cacheName)
+function createCache(resolve, reject, cacheName)
 {
-    return caches.open(cacheName).catch(onCacheStorageError);
+    caches.open(cacheName).then(resolve).catch(onCacheStorageError.bind(this, reject));
 }
 
-function addCacheEntry(cacheName, requestUrl, responseText)
+function addCacheEntry(resolve, reject, cacheName, requestUrl, responseText)
 {
-    return caches.open(cacheName)
+    caches.open(cacheName)
         .then(function(cache) {
             var request = new Request(requestUrl);
             var myBlob = new Blob();
@@ -179,28 +180,40 @@ function addCacheEntry(cacheName, requestUrl, responseText)
             var response = new Response(myBlob, init);
             return cache.put(request, response);
         })
-        .catch(onCacheStorageError);
+        .then(resolve)
+        .catch(onCacheStorageError.bind(this, reject));
 }
 
-function deleteCache(cacheName)
+function deleteCache(resolve, reject, cacheName)
 {
-    return caches.delete(cacheName)
+    caches.delete(cacheName)
         .then(function(success) {
-            if (!success)
-                onCacheStorageError("Could not find cache " + cacheName);
-        }).catch(onCacheStorageError);
+            if (success)
+                resolve();
+            else
+                onCacheStorageError(reject, "Could not find cache " + cacheName);
+        }).catch(onCacheStorageError.bind(this, reject));
 }
 
-function deleteCacheEntry(cacheName, requestUrl)
+function deleteCacheEntry(resolve, reject, cacheName, requestUrl)
 {
-    return caches.open(cacheName)
-        .then((cache) => cache.delete(new Request(requestUrl)))
-        .catch(onCacheStorageError);
+    caches.open(cacheName)
+        .then(function(cache) {
+            var request = new Request(requestUrl);
+            return cache.delete(request);
+        })
+        .then(resolve)
+        .catch(onCacheStorageError.bind(this, reject));
 }
 
-function clearAllCaches()
+function clearAllCaches(resolve, reject)
 {
-    return caches.keys()
-        .then((keys) => Promise.all(keys.map((key) => caches.delete(key))))
-        .catch(onCacheStorageError.bind(this, undefined));
+    caches.keys()
+        .then(function(keys) {
+            return Promise.all(keys.map(function(key) {
+                return caches.delete(key);
+            }));
+        })
+        .then(resolve)
+        .catch(onCacheStorageError.bind(this, reject));
 }
diff --git a/third_party/WebKit/LayoutTests/http/tests/inspector/debugger-test.js b/third_party/WebKit/LayoutTests/http/tests/inspector/debugger-test.js
index bc9ecc7..233a878 100644
--- a/third_party/WebKit/LayoutTests/http/tests/inspector/debugger-test.js
+++ b/third_party/WebKit/LayoutTests/http/tests/inspector/debugger-test.js
@@ -43,21 +43,21 @@ InspectorTest.completeDebuggerTest = function()
     Promise.prototype.then = function()
     {
         var result = origThen.apply(this, arguments);
-        origThen.call(result, undefined, onUncaughtPromiseReject.bind(null, new Error().stack));
+        origThen.call(result, undefined, onUncaughtPromiseReject);
         return result;
     }
 
     Promise.prototype.catch = function()
     {
         var result = origCatch.apply(this, arguments);
-        origThen.call(result, undefined, onUncaughtPromiseReject.bind(null, new Error().stack));
+        origThen.call(result, undefined, onUncaughtPromiseReject);
         return result;
     }
 
-    function onUncaughtPromiseReject(stack, e)
+    function onUncaughtPromiseReject(e)
     {
         var message = (typeof e === "object" && e.stack) || e;
-        InspectorTest.addResult("FAIL: Uncaught exception in promise: " + message + " " + stack);
+        InspectorTest.addResult("FAIL: Uncaught exception in promise: " + message);
         InspectorTest.completeDebuggerTest();
     }
 })();
diff --git a/third_party/WebKit/LayoutTests/http/tests/inspector/elements-test.js b/third_party/WebKit/LayoutTests/http/tests/inspector/elements-test.js
index e88ae63..ab1fb06 100644
--- a/third_party/WebKit/LayoutTests/http/tests/inspector/elements-test.js
+++ b/third_party/WebKit/LayoutTests/http/tests/inspector/elements-test.js
@@ -437,13 +437,13 @@ InspectorTest.toggleMatchedStyleProperty = function(propertyName, checked)
 InspectorTest.eventListenersWidget = function()
 {
     var sidebarPane = WebInspector.panels.elements.sidebarPanes.eventListeners;
-    sidebarPane.revealView();
+    sidebarPane.revealWidget();
     return sidebarPane;
 }
 
 InspectorTest.expandAndDumpSelectedElementEventListeners = function(callback)
 {
-    InspectorTest.expandAndDumpEventListeners(InspectorTest.eventListenersWidget()._eventListenersView, callback);
+    InspectorTest.expandAndDumpEventListeners(InspectorTest.eventListenersWidget()._eventListenersView, null, callback);
 }
 
 InspectorTest.dumpObjectPropertySectionDeep = function(section)
diff --git a/third_party/WebKit/LayoutTests/http/tests/inspector/elements/event-listeners-framework-with-service-worker-expected.txt b/third_party/WebKit/LayoutTests/http/tests/inspector/elements/event-listeners-framework-with-service-worker-expected.txt
index a1d8b7c..e651ae9 100644
--- a/third_party/WebKit/LayoutTests/http/tests/inspector/elements/event-listeners-framework-with-service-worker-expected.txt
+++ b/third_party/WebKit/LayoutTests/http/tests/inspector/elements/event-listeners-framework-with-service-worker-expected.txt
@@ -10,7 +10,7 @@ Dumping listeners
 
 ======== load ========
 == normal
-[expanded] WindowRemoveevent-listeners-framework-with-service-worker.html:59
+[expanded] WindowRemoveevent-listeners-framework-with-service-worker.html:62
     useCapture: false
     passive: false
     handler: function onload(event) {
diff --git a/third_party/WebKit/LayoutTests/http/tests/inspector/elements/event-listeners-framework-with-service-worker.html b/third_party/WebKit/LayoutTests/http/tests/inspector/elements/event-listeners-framework-with-service-worker.html
index dfd8bf9..c286350 100644
--- a/third_party/WebKit/LayoutTests/http/tests/inspector/elements/event-listeners-framework-with-service-worker.html
+++ b/third_party/WebKit/LayoutTests/http/tests/inspector/elements/event-listeners-framework-with-service-worker.html
@@ -22,6 +22,12 @@ function test()
         return InspectorTest.isDedicatedWorker(target);
     }
 
+    function forceUpdate()
+    {
+        objectEventListenersPane.revealWidget();
+        objectEventListenersPane.update();
+    }
+
     function step1(target)
     {
         InspectorTest.waitForExecutionContextInTarget(target, step2);
@@ -33,10 +39,7 @@ function test()
         InspectorTest.selectThread(executionContext.target());
         InspectorTest.addResult("Context is dedicated worker: " + isDedicatedWorker());
         InspectorTest.addResult("Dumping listeners");
-        objectEventListenersPane.revealView().then(() => {
-            objectEventListenersPane.update();
-            InspectorTest.expandAndDumpEventListeners(objectEventListenersPane._eventListenersView, step3);
-        });
+        InspectorTest.expandAndDumpEventListeners(objectEventListenersPane._eventListenersView, forceUpdate, step3);
     }
 
     function step3()
@@ -45,7 +48,7 @@ function test()
         InspectorTest.selectThread(WebInspector.targetManager.mainTarget());
         InspectorTest.addResult("Context is dedicated worker: " + isDedicatedWorker());
         InspectorTest.addResult("Dumping listeners");
-        InspectorTest.expandAndDumpEventListeners(objectEventListenersPane._eventListenersView, step4);
+        InspectorTest.expandAndDumpEventListeners(objectEventListenersPane._eventListenersView, forceUpdate, step4);
     }
 
     function step4()
diff --git a/third_party/WebKit/LayoutTests/http/tests/inspector/inspector-test.js b/third_party/WebKit/LayoutTests/http/tests/inspector/inspector-test.js
index c734b2d..af45e88 100644
--- a/third_party/WebKit/LayoutTests/http/tests/inspector/inspector-test.js
+++ b/third_party/WebKit/LayoutTests/http/tests/inspector/inspector-test.js
@@ -56,42 +56,6 @@ InspectorTest.evaluateInPagePromise = function(code)
     return new Promise(succ => InspectorTest.evaluateInPage(code, succ));
 }
 
-InspectorTest.evaluateInPageAsync = function(code)
-{
-    var callback;
-    var promise = new Promise((fulfill) => { callback = fulfill });
-    InspectorTest.RuntimeAgent.evaluate(code,
-        "console",
-        /* includeCommandLineAPI */ false,
-        /* doNotPauseOnExceptionsAndMuteConsole */ undefined,
-        /* contextId */ undefined,
-        /* returnByValue */ undefined,
-        /* generatePreview */ undefined,
-        /* userGesture */ undefined,
-        /* awaitPromise */ true,
-        mycallback);
-
-    function mycallback(error, result, wasThrown, exceptionDetails)
-    {
-        if (!error && !wasThrown) {
-            callback(InspectorTest.runtimeModel.createRemoteObject(result));
-        } else {
-            if (error)
-                InspectorTest.addResult("Error: " + error);
-            else
-                InspectorTest.addResult("Error: " + (exceptionDetails ? exceptionDetails.text : " exception while evaluation in page."));
-            InspectorTest.completeTest();
-        }
-    }
-    return promise;
-}
-
-InspectorTest.callFunctionInPageAsync = function(name, args)
-{
-    args = args || [];
-    return InspectorTest.evaluateInPageAsync(name + "(" + args.map(JSON.stringify).join(",") + ")");
-}
-
 InspectorTest.evaluateInPageWithTimeout = function(code)
 {
     // FIXME: we need a better way of waiting for chromium events to happen
@@ -118,6 +82,62 @@ InspectorTest.waitForOverlayRepaint = function(callback)
 var lastEvalId = 0;
 var pendingEvalRequests = {};
 
+var lastPromiseEvalId = 0;
+var pendingPromiseEvalRequests = {};
+
+/**
+ * The given function should take two callback paraters before the arguments:
+ *  * resolve - called when successful (with optional result)
+ *  * reject  - called when there was a failure (with optional error)
+ */
+InspectorTest.invokePageFunctionPromise = function(functionName, parameters)
+{
+    return new Promise(function(resolve, reject) {
+        var id = ++lastPromiseEvalId;
+        pendingPromiseEvalRequests[id] = { resolve: InspectorTest.safeWrap(resolve), reject: InspectorTest.safeWrap(reject) };
+
+        var jsonParameters = [];
+        for (var i = 0; i < parameters.length; ++i)
+            jsonParameters.push(JSON.stringify(parameters[i]));
+        var asyncEvalWrapper = function(callId, functionName, argumentsArray)
+        {
+            function evalCallbackResolve(result)
+            {
+                testRunner.evaluateInWebInspector(evalCallbackCallId, "InspectorTest.didInvokePageFunctionPromise(" + callId + ", " + JSON.stringify(result) + ", true);");
+            }
+
+            function evalCallbackReject(result)
+            {
+                testRunner.evaluateInWebInspector(evalCallbackCallId, "InspectorTest.didInvokePageFunctionPromise(" + callId + ", " + JSON.stringify(result) + ", false);");
+            }
+
+            var args = [evalCallbackResolve, evalCallbackReject].concat(argumentsArray.map(JSON.stringify));
+            var functionCall = functionName + ".call(null, " + args.join(", ") + ")";
+            try {
+                eval(functionCall);
+            } catch(e) {
+                InspectorTest.addResult("Error: " + e);
+                evalCallbackReject(e);
+            }
+        }
+        var pageRequest = "(" + asyncEvalWrapper.toString() + ")(" + id + ", unescape('" + escape(functionName) + "'), [" + jsonParameters.join(", ") + "])";
+        InspectorTest.evaluateInPage(pageRequest);
+    });
+}
+
+
+InspectorTest.didInvokePageFunctionPromise = function(callId, value, didResolve)
+{
+    var callbacks = pendingPromiseEvalRequests[callId];
+    if (!callbacks) {
+        InspectorTest.addResult("Missing callback for async eval " + callId + ", perhaps callback invoked twice?");
+        return;
+    }
+    var callback = didResolve ? callbacks.resolve : callbacks.reject;
+    delete pendingPromiseEvalRequests[callId];
+    callback(value);
+}
+
 /**
  * @param {string} functionName
  * @param {...} varArgs
@@ -369,10 +389,13 @@ InspectorTest.dumpObjectPropertyTreeElement = function(treeElement)
     }
 }
 
-InspectorTest.expandAndDumpEventListeners = function(eventListenersView, callback)
+InspectorTest.expandAndDumpEventListeners = function(eventListenersView, updateCallback, callback)
 {
     InspectorTest.addSniffer(WebInspector.EventListenersView.prototype, "_eventListenersArrivedForTest", listenersArrived);
 
+    if (updateCallback)
+        updateCallback();
+
     function listenersArrived()
     {
         var listenerTypes = eventListenersView._treeOutline.rootElement().children();
diff --git a/third_party/WebKit/LayoutTests/http/tests/inspector/service-workers/service-workers-force-update-on-page-load.html b/third_party/WebKit/LayoutTests/http/tests/inspector/service-workers/service-workers-force-update-on-page-load.html
index 444bdc7..603c603 100644
--- a/third_party/WebKit/LayoutTests/http/tests/inspector/service-workers/service-workers-force-update-on-page-load.html
+++ b/third_party/WebKit/LayoutTests/http/tests/inspector/service-workers/service-workers-force-update-on-page-load.html
@@ -5,15 +5,12 @@
 <script src="../resources-test.js"></script>
 <script>
 
-function loadIframe(url)
+function loadIframe(resolve, reject, url)
 {
-    var callback;
-    var promise = new Promise((fulfill) => callback = fulfill);
     var frame = document.createElement('iframe');
     frame.src = url;
-    frame.onload = callback;
+    frame.onload = resolve;
     document.body.appendChild(frame);
-    return promise;
 }
 
 function test()
@@ -54,30 +51,32 @@ function test()
     }
     installNewWorkerDetector(scope);
     WebInspector.inspectorView.showPanel("sources")
-        .then(() => waitForWorkerActivated(scope))
+        .then(function(){
+            return waitForWorkerActivated(scope);
+        })
         .then(function(){
             InspectorTest.addResult("The first ServiceWorker is activated.");
-            return InspectorTest.callFunctionInPageAsync("loadIframe", [ scope ]);
+            return InspectorTest.invokePageFunctionPromise("loadIframe", [scope])
         })
         .then(function() {
             InspectorTest.addResult("The first frame loaded.");
-            return InspectorTest.callFunctionInPageAsync("loadIframe", [ scope ]);
+            return InspectorTest.invokePageFunctionPromise("loadIframe", [scope]);
         })
         .then(function() {
             InspectorTest.addResult("The second frame loaded.");
             InspectorTest.addResult("Check \"Force update on page load\" check box");
             WebInspector.settings.settingForTest("serviceWorkerUpdateOnReload").set(true);
-            return InspectorTest.callFunctionInPageAsync("loadIframe", [ scope ]);
+            return InspectorTest.invokePageFunctionPromise("loadIframe", [scope]);
         })
         .then(function() {
             InspectorTest.addResult("The third frame loaded. The second worker must be activated before here.");
-            return InspectorTest.callFunctionInPageAsync("loadIframe", [ scope ]);
+            return InspectorTest.invokePageFunctionPromise("loadIframe", [scope]);
         })
         .then(function() {
             InspectorTest.addResult("The fourth frame loaded.  The third worker must be activated before here.");
             InspectorTest.addResult("Uncheck \"Force update on page load\" check box");
             WebInspector.settings.settingForTest("serviceWorkerUpdateOnReload").set(false);
-            return InspectorTest.callFunctionInPageAsync("loadIframe", [ scope ]);
+            return InspectorTest.invokePageFunctionPromise("loadIframe", [scope]);
         })
         .then(function() {
             InspectorTest.addResult("The fifth frame loaded.");
diff --git a/third_party/WebKit/LayoutTests/http/tests/inspector/service-workers/service-workers-test.js b/third_party/WebKit/LayoutTests/http/tests/inspector/service-workers/service-workers-test.js
index d728811..4b78f61 100644
--- a/third_party/WebKit/LayoutTests/http/tests/inspector/service-workers/service-workers-test.js
+++ b/third_party/WebKit/LayoutTests/http/tests/inspector/service-workers/service-workers-test.js
@@ -2,17 +2,17 @@ var initialize_ServiceWorkersTest = function() {
 
 InspectorTest.registerServiceWorker = function(script, scope)
 {
-    return InspectorTest.callFunctionInPageAsync("registerServiceWorker", [ script, scope ]);
+    return InspectorTest.invokePageFunctionPromise("registerServiceWorker", [script, scope]);
 }
 
 InspectorTest.unregisterServiceWorker = function(scope)
 {
-    return InspectorTest.callFunctionInPageAsync("unregisterServiceWorker", [ scope ]);
+    return InspectorTest.invokePageFunctionPromise("unregisterServiceWorker", [scope]);
 }
 
 InspectorTest.postToServiceWorker = function(scope, message)
 {
-    return InspectorTest.evaluateInPagePromise("postToServiceWorker(\"" + scope + "\",\"" + message + "\")");
+    return InspectorTest.invokePageFunctionPromise("postToServiceWorker", [scope, message]);
 }
 
 InspectorTest.waitForServiceWorker = function(callback)
@@ -52,21 +52,30 @@ InspectorTest.deleteServiceWorkerRegistration = function(scope)
 
 var registrations = {};
 
-function registerServiceWorker(script, scope)
+function registerServiceWorker(resolve, reject, script, scope)
 {
-    return navigator.serviceWorker.register(script, {scope: scope})
-        .then((reg) => registrations[scope] = reg);
+    navigator.serviceWorker.register(script, {scope: scope})
+        .then(function(reg) {
+            registrations[scope] = reg;
+            resolve();
+        }, reject);
 }
 
-function postToServiceWorker(scope, message)
+function postToServiceWorker(resolve, reject, scope, message)
 {
     registrations[scope].active.postMessage(message);
+    resolve();
 }
 
-function unregisterServiceWorker(scope)
+function unregisterServiceWorker(resolve, reject, scope)
 {
     var registration = registrations[scope];
-    if (!registration)
-        return Promise.reject("ServiceWorker for " + scope + " is not registered");
-    return registration.unregister().then(() => delete registrations[scope]);
+    if (!registration) {
+        reject("ServiceWorker for " + scope + " is not registered");
+        return;
+    }
+    registration.unregister().then(function() {
+            delete registrations[scope];
+            resolve();
+        }, reject);
 }
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/ironframe.html b/third_party/WebKit/LayoutTests/http/tests/ironframe/ironframe.html
new file mode 100644
index 0000000..1bc6cdc
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/http/tests/ironframe/ironframe.html
@@ -0,0 +1,66 @@
+<!DOCTYPE html>
+<script src="/resources/testharness.js"></script>
+<script src="/resources/testharnessreport.js"></script>
+<meta name="timeout" content="long"></meta>
+<head>
+</head>
+<body>
+    <pre id="result">UNSET</pre>
+    <div id=prot style="height:480;width:700;background-image:url('tile.gif');">
+        <iframe id=protfr border=0 frameBorder=0 scrolling="no" src="resources/openskies3.html" style="height:270;width:333"></iframe>
+    </div>
+    <script>
+     var t = async_test('IronFrame scroll test');
+     setTimeout(function(){
+         t.step(function () {
+             assert_equals(document.getElementById("result").innerHTML, "PASS", "Scroll incorrect");
+         });
+         t.done();
+     }, 2000);
+    </script>
+    <script>
+     function scrollWindow() {
+         setTimeout(function(){window.scrollTo(0, 100);}, 1000);
+     }
+     window.addEventListener("load", scrollWindow, false);
+    </script>
+    DUMMY CONTENT
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    <br>
+    DUMMY CONTENT
+</body>
+</html>
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/ishi.jpg b/third_party/WebKit/LayoutTests/http/tests/ironframe/ishi.jpg
new file mode 100644
index 0000000..caea5cc
Binary files /dev/null and b/third_party/WebKit/LayoutTests/http/tests/ironframe/ishi.jpg differ
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/closedskies3.html b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/closedskies3.html
new file mode 100644
index 0000000..cd9e029
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/closedskies3.html
@@ -0,0 +1,2 @@
+<body>
+    <iframe id="bigframe" style="position:absolute;top:0;left:0" border=0 frameBorder=0 scrolling="no" height=3000 width=3000 src="unprotected3.html"></iframe>
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/eviliron.html b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/eviliron.html
new file mode 100644
index 0000000..51656e4
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/eviliron.html
@@ -0,0 +1,4 @@
+<html>
+    <script>
+    </script>
+    <img src="ishi.jpg">
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/fileserver.go b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/fileserver.go
new file mode 100644
index 0000000..1a1dceb
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/fileserver.go
@@ -0,0 +1,15 @@
+// httpserver.go
+package main
+
+import (
+	"flag"
+	"net/http"
+)
+
+var port = flag.String("port", "8080", "Define what TCP port to bind to")
+var root = flag.String("root", ".", "Define the root filesystem path")
+
+func main() {
+	flag.Parse()
+	panic(http.ListenAndServe(":"+*port, http.FileServer(http.Dir(*root))))
+}
\ No newline at end of file
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/ishi.jpg b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/ishi.jpg
new file mode 100644
index 0000000..caea5cc
Binary files /dev/null and b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/ishi.jpg differ
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/openskies3.html b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/openskies3.html
new file mode 100644
index 0000000..edecfff
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/openskies3.html
@@ -0,0 +1,7 @@
+<!DOCTYPE html>
+<body>
+  <pre id="result1"></pre>
+  <iframe id="bigframe" style="position:absolute;top:0;left:0" border=0 frameBorder=0 scrolling="no" height=3000 width=3000 src="protected3.html">
+  </iframe>
+</body>
+</html>
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/paypal.png b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/paypal.png
new file mode 100644
index 0000000..9feafc5
Binary files /dev/null and b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/paypal.png differ
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/price.png b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/price.png
new file mode 100644
index 0000000..7d864c6
Binary files /dev/null and b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/price.png differ
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/protected3.html b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/protected3.html
new file mode 100644
index 0000000..9824401
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/protected3.html
@@ -0,0 +1,61 @@
+<html requestVisibility=1>
+    <body>
+        <script>
+         var enabled=true;
+         var numAlerts = 0;
+         var width0 = -1;
+         var height0 = -1;
+         var width1 = -1;
+         var height1 = -1;
+        </script>
+        <img src="paypal.png" style="position:absolute;top:0;left:0">
+        <script>
+         var prev;
+         var prevMsg="";
+         var v={};
+         var visible=false;
+
+         var update = function(){
+             if(v.visible.width < 333 || v.visible.height< 270 ) {
+                 visible=false;
+             } else {
+                 visible=true;
+             }
+             if (width0 == - 1) {
+                 if (v.visible.width != 300 || v.visible.height != 150) {
+                     window.top.document.getElementById("result").innerHTML = "FAIL";
+                 } else {
+                     window.top.document.getElementById("result").innerHTML = "PARTIAL PASS";
+                 }
+                 width0 = v.visible.width;
+                 height0 = v.visible.height;
+             } else if (width0 != v.visible.width || height0 != v.visible.height) {
+                 if (v.visible.width != 300 || v.visible.height != 92) {
+                     window.top.document.getElementById("result").innerHTML = "FAIL";
+                 } else {
+                     window.top.document.getElementById("result").innerHTML = "PASS";
+                 }
+
+                 if (width1 == -1) {
+                     width1 = v.visible.width;
+                     height1 = v.visible.height;
+                 }
+             }
+         }
+         function go() {
+             document.documentElement.addEventListener('requestedvisibility', function(e) {
+                 if(e.message!=prevMsg){
+                     prev=e.timeStamp;
+                     prevMsg=e.message;
+                 }
+                 v = JSON.parse(e.message);
+                 v.innerHeight = innerHeight;
+                 v.innerWidth  = innerWidth;
+                 v.ancestorOrigins = document.location.ancestorOrigins;
+                 update();
+             });
+         }
+         if(enabled) { window.onload=go; }
+        </script>
+    </body>
+</html>
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/tile.gif b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/tile.gif
new file mode 100644
index 0000000..6c950c8
Binary files /dev/null and b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/tile.gif differ
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/unprotected3.html b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/unprotected3.html
new file mode 100644
index 0000000..a53192d
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/unprotected3.html
@@ -0,0 +1,61 @@
+<html>
+    <!-- could also be
+         <html requestVisibility=1>
+         !-->
+    <body>
+        <script>
+         var enabled=false;
+         if(parent.frameElement.id!="unprotfr"){
+             document.requestVisibility();
+             enabled=true;
+         }
+
+        </script>
+
+        <img src="paypal.png" style="position:absolute;top:0;left:0">
+        <script>
+         var prev;
+         var prevMsg="";
+         var v={};
+         var visible=false;
+         var viz = top.document.getElementById("viz").contentWindow.document.getElementById("render");
+
+         var update = function(){
+             if(v.visible.width < 333 ||
+                v.visible.height< 270 ) {
+                    visible=false;
+             } else {
+                 visible=true;
+             }
+             if(!visible) {
+                 viz.style.backgroundColor="red";
+             } else {
+                 if(visible && Date.now()-prev < 2000) {
+                     viz.style.backgroundColor="yellow";
+                     setTimeout(update, 2250);
+                 } else {
+                     viz.style.backgroundColor="white";
+                 }
+             }
+         }
+
+         function go() { document.documentElement.onerror = function(e) {
+             if(e.message!=prevMsg){
+                 prev=e.timeStamp;
+                 prevMsg=e.message;
+             }
+             v = JSON.parse(e.message);
+             v.innerHeight = innerHeight;
+             v.innerWidth  = innerWidth;
+             v.timestamp   = e.timeStamp;
+             v.ancestorOrigins = document.location.ancestorOrigins;
+             viz.innerText = JSON.stringify(v);
+             var x = viz.innerText;
+             update();
+             //console.log(viz.innerText);
+         }
+         }
+         if(enabled) { window.onload=go; }
+        </script>
+    </body>
+</html>
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/viz.html b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/viz.html
new file mode 100644
index 0000000..5d2f5b0
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/http/tests/ironframe/resources/viz.html
@@ -0,0 +1,13 @@
+<head>
+    <style>
+     body{
+
+         font-family: 'Open Sans', sans-serif !important;
+         font-size: 14px;
+     }
+    </style>
+
+</head>
+<body>
+    <div style="word-wrap:break-word;font-size:24px" id="render">   </div>
+</body>
diff --git a/third_party/WebKit/LayoutTests/http/tests/ironframe/tile.gif b/third_party/WebKit/LayoutTests/http/tests/ironframe/tile.gif
new file mode 100644
index 0000000..6c950c8
Binary files /dev/null and b/third_party/WebKit/LayoutTests/http/tests/ironframe/tile.gif differ
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-css.html b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-css.html
index a874cf6..455418d 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-css.html
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-css.html
@@ -6,6 +6,7 @@
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
     document.write("<link rel='stylesheet' href='resources/link-dnsprefetch-image.php' onload='if (window.testRunner)testRunner.notifyDone()'>");
 </script>
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-frame.html b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-frame.html
index 566740c..cbdc7c6 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-frame.html
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-frame.html
@@ -7,6 +7,7 @@
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
 </script>
 This test checks if a Link header inside an iframe triggered a dns prefetch.
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-image.html b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-image.html
index 61f23c8..9fc49e4 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-image.html
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-image.html
@@ -6,6 +6,7 @@
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
     document.write("<img src='resources/link-dnsprefetch-image.php' onload='if (window.testRunner)testRunner.notifyDone()'>");
 </script>
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-script.html b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-script.html
index 82548f0..2a0cd39 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-script.html
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-in-script.html
@@ -6,6 +6,7 @@
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
     document.write("<script src='resources/link-dnsprefetch-script.php'></s"+"cript>");
 </script>
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-valid.php b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-valid.php
index f28ac52..f9587ae 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-valid.php
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-dnsprefetch-valid.php
@@ -9,6 +9,7 @@ header("Link: <   http://wut.com.test/>; rel=dns-prefetch");
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
     if (!localStorage.getItem("reloaded")) {
         localStorage.setItem("reloaded",  true);
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-header-skips-invalid-headers.php b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-header-skips-invalid-headers.php
index b5645b0..0780b86 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-header-skips-invalid-headers.php
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-header-skips-invalid-headers.php
@@ -10,6 +10,7 @@ header("Link: <   http://wut.com.test/>; rel=preconnect", false);
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
     if (!localStorage.getItem("reloaded")) {
         localStorage.setItem("reloaded",  true);
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-in-frame.html b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-in-frame.html
index 2dd496c..915a16a 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-in-frame.html
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-in-frame.html
@@ -7,6 +7,7 @@
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
 </script>
 This test checks if a Link header inside an iframe triggered a dns prefetch.
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-schemeless.https.php b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-schemeless.https.php
index 7040b24..c59a6a4 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-schemeless.https.php
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-schemeless.https.php
@@ -9,6 +9,7 @@ header("Link: <   //wut.com.test/>; rel=preconnect");
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
     if (!localStorage.getItem("reloaded")) {
         localStorage.setItem("reloaded",  true);
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-schemeless.php b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-schemeless.php
index 7040b24..c59a6a4 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-schemeless.php
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-schemeless.php
@@ -9,6 +9,7 @@ header("Link: <   //wut.com.test/>; rel=preconnect");
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
     if (!localStorage.getItem("reloaded")) {
         localStorage.setItem("reloaded",  true);
diff --git a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-valid.php b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-valid.php
index 944eff6..0ea47d5 100644
--- a/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-valid.php
+++ b/third_party/WebKit/LayoutTests/http/tests/linkHeader/link-preconnect-valid.php
@@ -9,6 +9,7 @@ header("Link: <   http://wut.com.test/>; rel=preconnect");
     }
     if (window.internals) {
         internals.settings.setLogDnsPrefetchAndPreconnect(true);
+        internals.settings.setLinkHeaderEnabled(true);
     }
     if (!localStorage.getItem("reloaded")) {
         localStorage.setItem("reloaded",  true);
diff --git a/third_party/WebKit/LayoutTests/http/tests/serviceworker/opaque-response-in-memorycache.html b/third_party/WebKit/LayoutTests/http/tests/serviceworker/opaque-response-in-memorycache.html
deleted file mode 100644
index a723e24..0000000
--- a/third_party/WebKit/LayoutTests/http/tests/serviceworker/opaque-response-in-memorycache.html
+++ /dev/null
@@ -1,30 +0,0 @@
-<!DOCTYPE html>
-<meta charset="utf-8">
-<title>Opaque responses on MemoryCache should not be reused for XHRs</title>
-<script src="/resources/testharness.js"></script>
-<script src="/resources/testharnessreport.js"></script>
-<script src="resources/test-helpers.js"></script>
-<script>
-const WORKER =
-  'resources/opaque-response-in-memorycache-worker.js';
-const SCOPE =
-  'resources/opaque-response-in-memorycache-iframe.html';
-var resolve_done;
-var done_was_called = new Promise(resolve => resolve_done = resolve);
-// Called by the iframe when done.
-function done(result) { resolve_done(result); }
-
-// This test creates an controlled iframe that makes a fetch request. The
-// service worker returns a response with a body stream containing an invalid
-// chunk.
-promise_test(t => {
-    return service_worker_unregister_and_register(t, WORKER, SCOPE)
-      .then(reg => {
-           add_completion_callback(() => reg.unregister());
-           return wait_for_state(t, reg.installing, 'activated');
-         })
-      .then(() => with_iframe(SCOPE))
-      .then(() => done_was_called)
-      .then(result => assert_equals(result, 'PASS'));
-  }, 'Opaque responses on MemoryCache should not be reused for XHRs');
-</script>
diff --git a/third_party/WebKit/LayoutTests/http/tests/serviceworker/resources/opaque-response-in-memorycache-iframe.html b/third_party/WebKit/LayoutTests/http/tests/serviceworker/resources/opaque-response-in-memorycache-iframe.html
deleted file mode 100644
index 5214b91..0000000
--- a/third_party/WebKit/LayoutTests/http/tests/serviceworker/resources/opaque-response-in-memorycache-iframe.html
+++ /dev/null
@@ -1,31 +0,0 @@
-<!DOCTYPE html>
-<meta charset="utf-8">
-<body></body>
-<script>
-function runTest() {
-  var l = document.createElement('link');
-  l.setAttribute('rel', 'preload');
-  l.setAttribute('href', 'opaque-response');
-  l.onload = function() {
-    xhr = new XMLHttpRequest;
-    xhr.withCredentials = true;
-    xhr.open('GET', 'opaque-response');
-    // opaque-response returns an opaque response from serviceworker and thus
-    // the XHR must fail because it is not no-cors request.
-    // Particularly, the XHR must not reuse preloaded the opaque response on
-    // MemoryCache.
-    xhr.onerror = function() {
-      parent.done('PASS');
-    };
-    xhr.onload = function() {
-      parent.done('FAIL: ' + xhr.responseText);
-    };
-    xhr.send();
-  };
-  l.onerror = function() {
-    parent.done('FAIL: preload failed unexpectedly');
-  };
-  document.body.appendChild(l);
-}
-</script>
-<body onload="setTimeout(runTest, 100)"></body>
diff --git a/third_party/WebKit/LayoutTests/http/tests/serviceworker/resources/opaque-response-in-memorycache-worker.js b/third_party/WebKit/LayoutTests/http/tests/serviceworker/resources/opaque-response-in-memorycache-worker.js
deleted file mode 100644
index 2a58d8c..0000000
--- a/third_party/WebKit/LayoutTests/http/tests/serviceworker/resources/opaque-response-in-memorycache-worker.js
+++ /dev/null
@@ -1,5 +0,0 @@
-self.addEventListener('fetch', event => {
-    if (!event.request.url.match(/opaque-response$/))
-      return;
-    event.respondWith(fetch("http://localhost:8000/serviceworker/resources/simple.txt", {mode: 'no-cors'}));
-  });
diff --git a/third_party/WebKit/LayoutTests/imported/csswg-test/css-flexbox-1/flex-grow-006.html b/third_party/WebKit/LayoutTests/imported/csswg-test/css-flexbox-1/flex-grow-006.html
index e0ac6fb..b000951 100644
--- a/third_party/WebKit/LayoutTests/imported/csswg-test/css-flexbox-1/flex-grow-006.html
+++ b/third_party/WebKit/LayoutTests/imported/csswg-test/css-flexbox-1/flex-grow-006.html
@@ -20,7 +20,7 @@
     width: 25px;
   }
   #test1 {
-    flex-grow: 1.5;
+    flex-grow: 0.5;
   }
   #test2 {
     flex-grow: 2;
diff --git a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-horiz-001-expected.xhtml b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-horiz-001-expected.xhtml
index 7ea5a05..3f113a0 100644
--- a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-horiz-001-expected.xhtml
+++ b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-horiz-001-expected.xhtml
@@ -21,7 +21,6 @@
         border-radius: 0;
         border: 1px dotted green;
         padding: 0;
-        margin: 0;
       }
     </style>
   </head>
@@ -30,8 +29,7 @@
       <textarea/>
     </div>
 
-    <div class="flexbox"
-         style="height: 22px"><!-- height of textarea's border-box -->
+    <div class="flexbox" style="height: 24px">
       some words
       <textarea style="float:right"/>
     </div>
diff --git a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-horiz-001.xhtml b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-horiz-001.xhtml
index 7906d24..11fe68a 100644
--- a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-horiz-001.xhtml
+++ b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-basic-textarea-horiz-001.xhtml
@@ -29,7 +29,6 @@
         border-radius: 0;
         border: 1px dotted green;
         padding: 0;
-        margin: 0;
       }
     </style>
   </head>
diff --git a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001a-expected.xhtml b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001a-expected.xhtml
index 236e3ee..4b06938 100644
--- a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001a-expected.xhtml
+++ b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001a-expected.xhtml
@@ -44,8 +44,8 @@
     </div>
 
     <div class="flexbox">
-      <img src="support/solidblue.png" style="margin-left: 30px"
-           /><img src="support/solidblue.png" style="margin-left: 60px"/>
+      <img src="solidblue.png" style="margin-left: 30px"
+           /><img src="solidblue.png" style="margin-left: 60px"/>
     </div>
   </body>
 </html>
diff --git a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001a.xhtml b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001a.xhtml
index 3bae116..f62048c 100644
--- a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001a.xhtml
+++ b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001a.xhtml
@@ -50,8 +50,8 @@
     <div class="flexbox">  <div class="a"/><div class="b"/></div>
 
     <!-- newline & whitespace between flex items  -->
-    <div class="flexbox"><img src="support/solidblue.png"/>
-      <img src="support/solidblue.png"/></div>
+    <div class="flexbox"><img src="solidblue.png"/>
+      <img src="solidblue.png"/></div>
   </body>
 </html>
 
diff --git a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001b-expected.xhtml b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001b-expected.xhtml
index 236e3ee..4b06938 100644
--- a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001b-expected.xhtml
+++ b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001b-expected.xhtml
@@ -44,8 +44,8 @@
     </div>
 
     <div class="flexbox">
-      <img src="support/solidblue.png" style="margin-left: 30px"
-           /><img src="support/solidblue.png" style="margin-left: 60px"/>
+      <img src="solidblue.png" style="margin-left: 30px"
+           /><img src="solidblue.png" style="margin-left: 60px"/>
     </div>
   </body>
 </html>
diff --git a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001b.xhtml b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001b.xhtml
index 43a4c60..1cc7fbe 100644
--- a/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001b.xhtml
+++ b/third_party/WebKit/LayoutTests/imported/csswg-test/vendor-imports/mozilla/mozilla-central-reftests/flexbox/flexbox-whitespace-handling-001b.xhtml
@@ -41,8 +41,8 @@
     <div class="flexbox"><div class="a"/><div class="b"/></div>
 
     <div class="flexbox"
-      ><img src="support/solidblue.png"
-     /><img src="support/solidblue.png"/></div>
+      ><img src="solidblue.png"
+     /><img src="solidblue.png"/></div>
   </body>
 </html>
 
diff --git a/third_party/WebKit/LayoutTests/inspector/animation/animation-empty-web-animations.html b/third_party/WebKit/LayoutTests/inspector/animation/animation-empty-web-animations.html
index 1f092fe..162c6a5 100644
--- a/third_party/WebKit/LayoutTests/inspector/animation/animation-empty-web-animations.html
+++ b/third_party/WebKit/LayoutTests/inspector/animation/animation-empty-web-animations.html
@@ -15,10 +15,19 @@ var initialize_Animations = function() {
 
 function test()
 {
+    InspectorTest.addSniffer(WebInspector.TabbedPane.prototype, "changeTabView", onChangeTabView, true);
     WebInspector.viewManager.showView("animations");
-    var timeline = self.runtime.sharedInstance(WebInspector.AnimationTimeline);
-    InspectorTest.evaluateInPage("startAnimation()");
-    InspectorTest.addSniffer(WebInspector.AnimationModel.prototype, "animationStarted", animationStarted);
+    var timeline;
+
+    function onChangeTabView(id, view)
+    {
+        if (!timeline && id === "animations") {
+            timeline = view;
+            InspectorTest.assertTrue(timeline instanceof WebInspector.AnimationTimeline);
+            InspectorTest.evaluateInPage("startAnimation()");
+            InspectorTest.addSniffer(WebInspector.AnimationModel.prototype, "animationStarted", animationStarted);
+        }
+    }
 
     function animationStarted()
     {
diff --git a/third_party/WebKit/LayoutTests/inspector/animation/animation-timeline.html b/third_party/WebKit/LayoutTests/inspector/animation/animation-timeline.html
index 40b3f6c..bca1d2e 100644
--- a/third_party/WebKit/LayoutTests/inspector/animation/animation-timeline.html
+++ b/third_party/WebKit/LayoutTests/inspector/animation/animation-timeline.html
@@ -60,11 +60,19 @@ function test()
     // Override animation color for testing
     // FIXME: Set animation name of Web Animation instead; not supported yet
     WebInspector.AnimationUI.Color = function() { return "black"; }
-
+    var timeline;
+    InspectorTest.addSniffer(WebInspector.TabbedPane.prototype, "changeTabView", onChangeTabView, true);
     WebInspector.viewManager.showView("animations");
-    var timeline = self.runtime.sharedInstance(WebInspector.AnimationTimeline);
-    InspectorTest.evaluateInPage("startAnimationWithDelay()");
-    InspectorTest.waitForAnimationAdded(step2);
+
+    function onChangeTabView(id, view)
+    {
+        if (!timeline && id === "animations") {
+            timeline = view;
+            InspectorTest.assertTrue(timeline instanceof WebInspector.AnimationTimeline);
+            InspectorTest.waitForAnimationAdded(step2);
+            InspectorTest.evaluateInPage("startAnimationWithDelay()");
+        }
+    }
 
     function step2(group)
     {
diff --git a/third_party/WebKit/LayoutTests/inspector/animation/animation-web-anim-negative-start-time.html b/third_party/WebKit/LayoutTests/inspector/animation/animation-web-anim-negative-start-time.html
index ce843a0..2572d48 100644
--- a/third_party/WebKit/LayoutTests/inspector/animation/animation-web-anim-negative-start-time.html
+++ b/third_party/WebKit/LayoutTests/inspector/animation/animation-web-anim-negative-start-time.html
@@ -26,11 +26,19 @@ function test()
     // Override animation color for testing
     // FIXME: Set animation name of Web Animation instead; not supported yet
     WebInspector.AnimationUI.Color = function() { return "black"; }
-
+    var timeline;
+    InspectorTest.addSniffer(WebInspector.TabbedPane.prototype, "changeTabView", onChangeTabView, true);
     WebInspector.viewManager.showView("animations");
-    var timeline = self.runtime.sharedInstance(WebInspector.AnimationTimeline);
-    InspectorTest.evaluateInPage("startAnimation()");
-    InspectorTest.waitForAnimationAdded(step2);
+
+    function onChangeTabView(id, view)
+    {
+        if (!timeline && id === "animations") {
+            timeline = view;
+            InspectorTest.assertTrue(timeline instanceof WebInspector.AnimationTimeline);
+            InspectorTest.waitForAnimationAdded(step2);
+            InspectorTest.evaluateInPage("startAnimation()");
+        }
+    }
 
     function step2(group)
     {
diff --git a/third_party/WebKit/LayoutTests/inspector/components/split-string-by-regexes-expected.txt b/third_party/WebKit/LayoutTests/inspector/components/split-string-by-regexes-expected.txt
deleted file mode 100644
index 59a1f26..0000000
--- a/third_party/WebKit/LayoutTests/inspector/components/split-string-by-regexes-expected.txt
+++ /dev/null
@@ -1,43 +0,0 @@
-Tests WebInspector.TextUtils.splitStringByRegexes.
-
-
-Running: testSimple
-"hello", 0, 0
-"123", 5, 1
-"hello", 8, 0
-"123", 13, 1
-
-Running: testMatchAtStart
-"yes", 0, 0
-" thank you", 3, -1
-
-Running: testMatchAtEnd
-"yes thank ", 0, -1
-"you", 10, 0
-
-Running: testAvoidInnerMatch
-"image: ", 0, -1
-"url("red.com")", 7, 0
-
-Running: testNoMatch
-"nothing", 0, -1
-
-Running: testNoMatches
-"nothing", 0, -1
-
-Running: testComplex
-"Start. ", 0, -1
-"(okay)", 7, 0
-" kit-", 13, -1
-"ka", 18, 2
-"t ", 20, -1
-"okay", 22, 1
-" ", 26, -1
-"(kale)", 27, 0
-" ", 33, -1
-"ka", 34, 2
-"( )", 36, 0
-" ", 39, -1
-"okay", 40, 1
-". End", 44, -1
-
diff --git a/third_party/WebKit/LayoutTests/inspector/components/split-string-by-regexes.html b/third_party/WebKit/LayoutTests/inspector/components/split-string-by-regexes.html
deleted file mode 100644
index 2ab726d..0000000
--- a/third_party/WebKit/LayoutTests/inspector/components/split-string-by-regexes.html
+++ /dev/null
@@ -1,82 +0,0 @@
-<html>
-<head>
-<script src="../../http/tests/inspector/inspector-test.js"></script>
-<script>
-
-function test()
-{
-    InspectorTest.runTestSuite([
-        function testSimple(next)
-        {
-            var regexes = [/hello/g, /[0-9]+/g];
-            var results = WebInspector.TextUtils.splitStringByRegexes("hello123hello123", regexes);
-            dumpResults(results);
-            next();
-        },
-
-        function testMatchAtStart(next)
-        {
-            var regexes = [/yes/g];
-            var results = WebInspector.TextUtils.splitStringByRegexes("yes thank you", regexes);
-            dumpResults(results);
-            next();
-        },
-
-        function testMatchAtEnd(next)
-        {
-            var regexes = [/you/g];
-            var results = WebInspector.TextUtils.splitStringByRegexes("yes thank you", regexes);
-            dumpResults(results);
-            next();
-        },
-
-        function testAvoidInnerMatch(next)
-        {
-            var regexes = [/url\("red\.com"\)/g, /red/g];
-            var results = WebInspector.TextUtils.splitStringByRegexes("image: url(\"red.com\")", regexes);
-            dumpResults(results);
-            next();
-        },
-
-        function testNoMatch(next)
-        {
-            var regexes = [/something/g];
-            var results = WebInspector.TextUtils.splitStringByRegexes("nothing", regexes);
-            dumpResults(results);
-            next();
-        },
-
-        function testNoMatches(next)
-        {
-            var regexes = [/something/g, /123/g, /abc/g];
-            var results = WebInspector.TextUtils.splitStringByRegexes("nothing", regexes);
-            dumpResults(results);
-            next();
-        },
-
-        function testComplex(next)
-        {
-            var regexes = [/\(([^)]+)\)/g, /okay/g, /ka/g];
-            var results = WebInspector.TextUtils.splitStringByRegexes("Start. (okay) kit-kat okay (kale) ka( ) okay. End", regexes);
-            dumpResults(results);
-            next();
-        }
-    ]);
-
-    function dumpResults(results)
-    {
-        for (var i = 0; i < results.length; i++) {
-            var result = results[i];
-            InspectorTest.addResult("\"" + result.value + "\", " + result.position + ", " + result.regexIndex);
-        }
-    }
-}
-</script>
-</head>
-
-<body onload="runTest()">
-<p>
-Tests WebInspector.TextUtils.splitStringByRegexes.
-</p>
-</body>
-</html>
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-call-getter-on-proto-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/console-call-getter-on-proto-expected.txt
index 296bef5..bc4bfd0 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-call-getter-on-proto-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-call-getter-on-proto-expected.txt
@@ -1,7 +1,7 @@
 CONSOLE MESSAGE: line 21: [object Object]
 Tests that calling getter on prototype will call it on the object.
 
-console-call-getter-on-proto.html:21 B
+console-call-getter-on-proto.html:21 B {value: 239}
     foo: 239
     value: 239
     __proto__: A
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-correct-suggestions.html b/third_party/WebKit/LayoutTests/inspector/console/console-correct-suggestions.html
index 14fd137..a10e7b5 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-correct-suggestions.html
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-correct-suggestions.html
@@ -3,6 +3,7 @@
 <script src="../../http/tests/inspector/inspector-test.js"></script>
 <script src="../../http/tests/inspector/console-test.js"></script>
 <script>
+
 function templateString()
 {
     console.log("The template string should not run and you should not see this log");
@@ -17,7 +18,13 @@ function test()
     {
         var callback;
         var promise = new Promise(fulfill => callback = fulfill);
-        WebInspector.ExecutionContextSelector.completionsForTextInCurrentContext(base, prefix, false, checkExpected);
+        var div = document.createElement("div");
+        var text = base + prefix;
+        div.textContent = text;
+        var range = document.createRange();
+        range.setStart(div.childNodes[0], base.length);
+        range.setEnd(div.childNodes[0], text.length);
+        WebInspector.ExecutionContextSelector.completionsForTextPromptInCurrentContext(div, range, false, checkExpected);
         return promise;
 
         function checkExpected(completions)
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-edit-property-value-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/console-edit-property-value-expected.txt
deleted file mode 100644
index 73e66a1..0000000
--- a/third_party/WebKit/LayoutTests/inspector/console/console-edit-property-value-expected.txt
+++ /dev/null
@@ -1,14 +0,0 @@
-CONSOLE MESSAGE: line 10: [object Object]
-Tests that property values can be edited inline in the console via double click.
-
-Node was hidden after dblclick: true
-Node was hidden after dblclick: true
-Node was hidden after dblclick: true
-logToConsole()
-console-edit-property-value.html:10 Object
-    a: 3
-    b: "foo"
-    c: Array[3]
-    __proto__: Object
-undefined
-
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-edit-property-value.html b/third_party/WebKit/LayoutTests/inspector/console/console-edit-property-value.html
deleted file mode 100644
index edc8ee0..0000000
--- a/third_party/WebKit/LayoutTests/inspector/console/console-edit-property-value.html
+++ /dev/null
@@ -1,79 +0,0 @@
-<html>
-<head>
-<script src="../../http/tests/inspector/inspector-test.js"></script>
-<script src="../../http/tests/inspector/console-test.js"></script>
-<script>
-
-function logToConsole()
-{
-    var obj = {a: 1, b: "foo", c: null};
-    console.log(obj);
-}
-
-var test = function()
-{
-    InspectorTest.evaluateInConsole("logToConsole()", step1);
-
-    function step1()
-    {
-        InspectorTest.expandConsoleMessages(step2);
-    }
-
-    function step2()
-    {
-        var valueElements = getValueElements();
-        doubleClickTypeAndEnter(valueElements[0], "1 + 2");
-        InspectorTest.waitForRemoteObjectsConsoleMessages(step3);
-    }
-
-    function step3()
-    {
-        var valueElements = getValueElements();
-        doubleClickTypeAndEnter(valueElements[1], "nonExistingValue");
-        InspectorTest.waitForRemoteObjectsConsoleMessages(step4);
-    }
-
-    function step4()
-    {
-        var valueElements = getValueElements();
-        doubleClickTypeAndEnter(valueElements[2], "[1, 2, 3]");
-        InspectorTest.waitForRemoteObjectsConsoleMessages(step5);
-    }
-
-    function step5()
-    {
-        InspectorTest.dumpConsoleMessagesIgnoreErrorStackFrames();
-        InspectorTest.completeTest();
-    }
-
-    function getValueElements()
-    {
-        var messageElement = WebInspector.ConsoleView.instance()._visibleViewMessages[1]._messageElement;
-        return messageElement.querySelectorAll("::shadow .value");
-    }
-
-    function doubleClickTypeAndEnter(node, text)
-    {
-        var event = document.createEvent("MouseEvent");
-        event.initMouseEvent("dblclick", true, true, null, 2);
-        node.dispatchEvent(event);
-
-        InspectorTest.addResult("Node was hidden after dblclick: " + node.classList.contains("hidden"));
-
-        var messageElement = WebInspector.ConsoleView.instance()._visibleViewMessages[1]._messageElement;
-        var editPrompt = messageElement.querySelector("::shadow .text-prompt");
-        editPrompt.textContent = text;
-        editPrompt.dispatchEvent(InspectorTest.createKeyEvent("Enter"));
-    }
-}
-
-</script>
-</head>
-
-<body onload="runTest()">
-<p>
-Tests that property values can be edited inline in the console via double click.
-</p>
-
-</body>
-</html>
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-format-array-prototype.html b/third_party/WebKit/LayoutTests/inspector/console/console-format-array-prototype.html
index a04eee7..00a9bce 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-format-array-prototype.html
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-format-array-prototype.html
@@ -45,6 +45,7 @@ function test()
             var next = current + 1;
             if (next === total) {
                 InspectorTest.evaluateInPage("tearDown()");
+                InspectorTest.expandConsoleMessages();
                 InspectorTest.deprecatedRunAfterPendingDispatches(finish);
             } else {
                 loopOverGlobals(next, total);
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-format-broken-unicode.html b/third_party/WebKit/LayoutTests/inspector/console/console-format-broken-unicode.html
index 1aed4e4..e424e06 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-format-broken-unicode.html
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-format-broken-unicode.html
@@ -29,29 +29,18 @@ function test()
 
     function step3()
     {
-        InspectorTest.expandConsoleMessages(step4, expandFirstArrayIndexFilter);
+        InspectorTest.evaluateInPage("obj.foo", step4);
     }
 
-    function step4()
-    {
-        InspectorTest.evaluateInPage("obj.foo", step5);
-    }
-
-    function step5(result)
+    function step4(result)
     {
         var text = result.description;
         InspectorTest.assertEquals(15, text.length, "text length");
-        InspectorTest.assertEquals(6, countTextNodes(text), "nodes count");
+        InspectorTest.assertEquals(7, countTextNodes(text), "nodes count");
         InspectorTest.addResult("PASS: Found all nodes with the broken text");
         InspectorTest.completeTest();
     }
 
-    function expandFirstArrayIndexFilter(treeElement)
-    {
-        var propertyName = treeElement.nameElement && treeElement.nameElement.textContent;
-        return propertyName === "0";
-    }
-
     function countTextNodes(textContent)
     {
         InspectorTest.disableConsoleViewport();
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-2-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-2-expected.txt
index 50e2f18..a7f8f80 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-2-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-2-expected.txt
@@ -17,39 +17,6 @@ CONSOLE MESSAGE: line 12: [object Set Iterator]
 Tests that console properly displays information about ES6 features.
 
 console-format-es6-2.html:11 MapIterator {41, Object {foo: 1}}
-console-format-es6-2.html:12 [MapIterator]
-globals[0]
-MapIterator {41, Object {foo: 1}}
-console-format-es6-2.html:11 MapIterator {42, Object {foo: 2}}
-console-format-es6-2.html:12 [MapIterator]
-globals[1]
-MapIterator {42, Object {foo: 2}}
-console-format-es6-2.html:11 MapIterator {[41, 42], [Object, Object]}
-console-format-es6-2.html:12 [MapIterator]
-globals[2]
-MapIterator {[41, 42], [Object, Object]}
-console-format-es6-2.html:11 SetIterator {41, Object {foo: 1}}
-console-format-es6-2.html:12 [SetIterator]
-globals[3]
-SetIterator {41, Object {foo: 1}}
-console-format-es6-2.html:11 SetIterator {41, Object {foo: 1}}
-console-format-es6-2.html:12 [SetIterator]
-globals[4]
-SetIterator {41, Object {foo: 1}}
-console-format-es6-2.html:11 SetIterator {[41, 41], [Object, Object]}
-console-format-es6-2.html:12 [SetIterator]
-globals[5]
-SetIterator {[41, 41], [Object, Object]}
-console-format-es6-2.html:11 MapIterator {Object {foo: 2}}
-console-format-es6-2.html:12 [MapIterator]
-globals[6]
-MapIterator {Object {foo: 2}}
-console-format-es6-2.html:11 SetIterator {Object {foo: 1}}
-console-format-es6-2.html:12 [SetIterator]
-globals[7]
-SetIterator {Object {foo: 1}}
-Expanded all messages
-console-format-es6-2.html:11 MapIterator
     __proto__: Map Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -58,12 +25,12 @@ console-format-es6-2.html:11 MapIterator
         0: 41
         1: Object
         length: 2
-console-format-es6-2.html:12 Array[1]
+console-format-es6-2.html:12 [MapIterator]
     0: MapIterator
     length: 1
     __proto__: Array[0]
 globals[0]
-MapIterator
+MapIterator {41, Object {foo: 1}}
     __proto__: Map Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -72,7 +39,7 @@ MapIterator
         0: 41
         1: Object
         length: 2
-console-format-es6-2.html:11 MapIterator
+console-format-es6-2.html:11 MapIterator {42, Object {foo: 2}}
     __proto__: Map Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -81,12 +48,12 @@ console-format-es6-2.html:11 MapIterator
         0: 42
         1: Object
         length: 2
-console-format-es6-2.html:12 Array[1]
+console-format-es6-2.html:12 [MapIterator]
     0: MapIterator
     length: 1
     __proto__: Array[0]
 globals[1]
-MapIterator
+MapIterator {42, Object {foo: 2}}
     __proto__: Map Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -95,7 +62,7 @@ MapIterator
         0: 42
         1: Object
         length: 2
-console-format-es6-2.html:11 MapIterator
+console-format-es6-2.html:11 MapIterator {[41, 42], [Object, Object]}
     __proto__: Map Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -104,12 +71,12 @@ console-format-es6-2.html:11 MapIterator
         0: Array[2]
         1: Array[2]
         length: 2
-console-format-es6-2.html:12 Array[1]
+console-format-es6-2.html:12 [MapIterator]
     0: MapIterator
     length: 1
     __proto__: Array[0]
 globals[2]
-MapIterator
+MapIterator {[41, 42], [Object, Object]}
     __proto__: Map Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -118,7 +85,7 @@ MapIterator
         0: Array[2]
         1: Array[2]
         length: 2
-console-format-es6-2.html:11 SetIterator
+console-format-es6-2.html:11 SetIterator {41, Object {foo: 1}}
     __proto__: Set Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -127,12 +94,12 @@ console-format-es6-2.html:11 SetIterator
         0: 41
         1: Object
         length: 2
-console-format-es6-2.html:12 Array[1]
+console-format-es6-2.html:12 [SetIterator]
     0: SetIterator
     length: 1
     __proto__: Array[0]
 globals[3]
-SetIterator
+SetIterator {41, Object {foo: 1}}
     __proto__: Set Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -141,7 +108,7 @@ SetIterator
         0: 41
         1: Object
         length: 2
-console-format-es6-2.html:11 SetIterator
+console-format-es6-2.html:11 SetIterator {41, Object {foo: 1}}
     __proto__: Set Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -150,12 +117,12 @@ console-format-es6-2.html:11 SetIterator
         0: 41
         1: Object
         length: 2
-console-format-es6-2.html:12 Array[1]
+console-format-es6-2.html:12 [SetIterator]
     0: SetIterator
     length: 1
     __proto__: Array[0]
 globals[4]
-SetIterator
+SetIterator {41, Object {foo: 1}}
     __proto__: Set Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -164,7 +131,7 @@ SetIterator
         0: 41
         1: Object
         length: 2
-console-format-es6-2.html:11 SetIterator
+console-format-es6-2.html:11 SetIterator {[41, 41], [Object, Object]}
     __proto__: Set Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -173,12 +140,12 @@ console-format-es6-2.html:11 SetIterator
         0: Array[2]
         1: Array[2]
         length: 2
-console-format-es6-2.html:12 Array[1]
+console-format-es6-2.html:12 [SetIterator]
     0: SetIterator
     length: 1
     __proto__: Array[0]
 globals[5]
-SetIterator
+SetIterator {[41, 41], [Object, Object]}
     __proto__: Set Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 0
@@ -187,7 +154,7 @@ SetIterator
         0: Array[2]
         1: Array[2]
         length: 2
-console-format-es6-2.html:11 MapIterator
+console-format-es6-2.html:11 MapIterator {Object {foo: 2}}
     __proto__: Map Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 1
@@ -195,12 +162,12 @@ console-format-es6-2.html:11 MapIterator
     [[Entries]]: Array[1]
         0: Object
         length: 1
-console-format-es6-2.html:12 Array[1]
+console-format-es6-2.html:12 [MapIterator]
     0: MapIterator
     length: 1
     __proto__: Array[0]
 globals[6]
-MapIterator
+MapIterator {Object {foo: 2}}
     __proto__: Map Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 1
@@ -208,7 +175,7 @@ MapIterator
     [[Entries]]: Array[1]
         0: Object
         length: 1
-console-format-es6-2.html:11 SetIterator
+console-format-es6-2.html:11 SetIterator {Object {foo: 1}}
     __proto__: Set Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 1
@@ -216,12 +183,12 @@ console-format-es6-2.html:11 SetIterator
     [[Entries]]: Array[1]
         0: Object
         length: 1
-console-format-es6-2.html:12 Array[1]
+console-format-es6-2.html:12 [SetIterator]
     0: SetIterator
     length: 1
     __proto__: Array[0]
 globals[7]
-SetIterator
+SetIterator {Object {foo: 1}}
     __proto__: Set Iterator
     [[IteratorHasMore]]: true
     [[IteratorIndex]]: 1
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-2.html b/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-2.html
index 4680989..d914179 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-2.html
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-2.html
@@ -47,15 +47,13 @@ function test()
         {
             var next = current + 1;
             if (next == total.description)
-                finish();
+                InspectorTest.expandConsoleMessages(finish);
             else
                 loopOverGlobals(next, total);
         }
 
         function finish()
         {
-            InspectorTest.dumpConsoleMessages(false, false, InspectorTest.textContentWithLineBreaks);
-            InspectorTest.addResult("Expanded all messages");
             InspectorTest.expandConsoleMessages(dumpConsoleMessages);
         }
 
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-expected.txt
index 0f2c479..fa031a8 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-format-es6-expected.txt
@@ -27,235 +27,182 @@ CONSOLE MESSAGE: line 12: [object Map]
 Tests that console properly displays information about ES6 features.
 
 console-format-es6.html:11 Promise {[[PromiseStatus]]: "rejected", [[PromiseValue]]: -0}
-console-format-es6.html:12 [Promise]
-globals[0]
-Promise {[[PromiseStatus]]: "rejected", [[PromiseValue]]: -0}
-console-format-es6.html:11 Symbol()
-console-format-es6.html:12 [Symbol()]
-globals[1]
-Symbol()
-console-format-es6.html:11 Symbol(a)
-console-format-es6.html:12 [Symbol(a)]
-globals[2]
-Symbol(a)
-console-format-es6.html:11 Object {a: Symbol(), Symbol(a): 2}
-console-format-es6.html:12 [Object]
-globals[3]
-Object {a: Symbol(), Symbol(a): 2}
-console-format-es6.html:11 Map {Object {a: Symbol(), Symbol(a): 2} => Object {foo: 1}}
-console-format-es6.html:12 [Map]
-globals[4]
-Map {Object {a: Symbol(), Symbol(a): 2} => Object {foo: 1}}
-console-format-es6.html:11 WeakMap {Object {a: Symbol(), Symbol(a): 2} => Object {foo: 1}}
-console-format-es6.html:12 [WeakMap]
-globals[5]
-WeakMap {Object {a: Symbol(), Symbol(a): 2} => Object {foo: 1}}
-console-format-es6.html:11 Set {Object {a: Symbol(), Symbol(a): 2}}
-console-format-es6.html:12 [Set]
-globals[6]
-Set {Object {a: Symbol(), Symbol(a): 2}}
-console-format-es6.html:11 WeakSet {Object {a: Symbol(), Symbol(a): 2}}
-console-format-es6.html:12 [WeakSet]
-globals[7]
-WeakSet {Object {a: Symbol(), Symbol(a): 2}}
-console-format-es6.html:11 Map {Map {} => WeakMap {}}
-console-format-es6.html:12 [Map]
-globals[8]
-Map {Map {} => WeakMap {}}
-console-format-es6.html:11 Map {Map {…} => WeakMap {…}}
-console-format-es6.html:12 [Map]
-globals[9]
-Map {Map {…} => WeakMap {…}}
-console-format-es6.html:11 Set {WeakSet {}}
-console-format-es6.html:12 [Set]
-globals[10]
-Set {WeakSet {}}
-console-format-es6.html:11 Set {WeakSet {…}}
-console-format-es6.html:12 [Set]
-globals[11]
-Set {WeakSet {…}}
-console-format-es6.html:11 Map {" from str " => " to str ", undefined => undefined, null => null, 42 => 42, Object {foo: "from"} => Object {foo: "to"}}
-console-format-es6.html:12 [Map]
-globals[12]
-Map {" from str " => " to str ", undefined => undefined, null => null, 42 => 42, Object {foo: "from"} => Object {foo: "to"}}
-Expanded all messages
-console-format-es6.html:11 Promise
     __proto__: Promise
     [[PromiseStatus]]: "rejected"
     [[PromiseValue]]: -0
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Promise]
     0: Promise
     length: 1
     __proto__: Array[0]
 globals[0]
-Promise
+Promise {[[PromiseStatus]]: "rejected", [[PromiseValue]]: -0}
     __proto__: Promise
     [[PromiseStatus]]: "rejected"
     [[PromiseValue]]: -0
 console-format-es6.html:11 Symbol()
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Symbol()]
     0: Symbol()
     length: 1
     __proto__: Array[0]
 globals[1]
 Symbol()
 console-format-es6.html:11 Symbol(a)
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Symbol(a)]
     0: Symbol(a)
     length: 1
     __proto__: Array[0]
 globals[2]
 Symbol(a)
-console-format-es6.html:11 Object
+console-format-es6.html:11 Object {a: Symbol(), Symbol(a): 2}
     a: Symbol()
     getter: (...)
     get getter: getter()
     Symbol(a): 2
     __proto__: Object
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Object]
     0: Object
     length: 1
     __proto__: Array[0]
 globals[3]
-Object
+Object {a: Symbol(), Symbol(a): 2}
     a: Symbol()
     getter: (...)
     get getter: getter()
     Symbol(a): 2
     __proto__: Object
-console-format-es6.html:11 Map
+console-format-es6.html:11 Map {Object {a: Symbol(), Symbol(a): 2} => Object {foo: 1}}
     size: (...)
     __proto__: Map
     [[Entries]]: Array[1]
         0: {Object => Object}
         length: 1
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Map]
     0: Map
     length: 1
     __proto__: Array[0]
 globals[4]
-Map
+Map {Object {a: Symbol(), Symbol(a): 2} => Object {foo: 1}}
     size: (...)
     __proto__: Map
     [[Entries]]: Array[1]
         0: {Object => Object}
         length: 1
-console-format-es6.html:11 WeakMap
+console-format-es6.html:11 WeakMap {Object {a: Symbol(), Symbol(a): 2} => Object {foo: 1}}
     __proto__: WeakMap
     [[Entries]]: Array[1]
         0: {Object => Object}
         length: 1
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [WeakMap]
     0: WeakMap
     length: 1
     __proto__: Array[0]
 globals[5]
-WeakMap
+WeakMap {Object {a: Symbol(), Symbol(a): 2} => Object {foo: 1}}
     __proto__: WeakMap
     [[Entries]]: Array[1]
         0: {Object => Object}
         length: 1
-console-format-es6.html:11 Set
+console-format-es6.html:11 Set {Object {a: Symbol(), Symbol(a): 2}}
     size: (...)
     __proto__: Set
     [[Entries]]: Array[1]
         0: Object
         length: 1
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Set]
     0: Set
     length: 1
     __proto__: Array[0]
 globals[6]
-Set
+Set {Object {a: Symbol(), Symbol(a): 2}}
     size: (...)
     __proto__: Set
     [[Entries]]: Array[1]
         0: Object
         length: 1
-console-format-es6.html:11 WeakSet
+console-format-es6.html:11 WeakSet {Object {a: Symbol(), Symbol(a): 2}}
     __proto__: WeakSet
     [[Entries]]: Array[1]
         0: Object
         length: 1
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [WeakSet]
     0: WeakSet
     length: 1
     __proto__: Array[0]
 globals[7]
-WeakSet
+WeakSet {Object {a: Symbol(), Symbol(a): 2}}
     __proto__: WeakSet
     [[Entries]]: Array[1]
         0: Object
         length: 1
-console-format-es6.html:11 Map
+console-format-es6.html:11 Map {Map {} => WeakMap {}}
     size: (...)
     __proto__: Map
     [[Entries]]: Array[1]
         0: {Map => WeakMap}
         length: 1
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Map]
     0: Map
     length: 1
     __proto__: Array[0]
 globals[8]
-Map
+Map {Map {} => WeakMap {}}
     size: (...)
     __proto__: Map
     [[Entries]]: Array[1]
         0: {Map => WeakMap}
         length: 1
-console-format-es6.html:11 Map
+console-format-es6.html:11 Map {Map {…} => WeakMap {…}}
     size: (...)
     __proto__: Map
     [[Entries]]: Array[1]
         0: {Map => WeakMap}
         length: 1
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Map]
     0: Map
     length: 1
     __proto__: Array[0]
 globals[9]
-Map
+Map {Map {…} => WeakMap {…}}
     size: (...)
     __proto__: Map
     [[Entries]]: Array[1]
         0: {Map => WeakMap}
         length: 1
-console-format-es6.html:11 Set
+console-format-es6.html:11 Set {WeakSet {}}
     size: (...)
     __proto__: Set
     [[Entries]]: Array[1]
         0: WeakSet
         length: 1
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Set]
     0: Set
     length: 1
     __proto__: Array[0]
 globals[10]
-Set
+Set {WeakSet {}}
     size: (...)
     __proto__: Set
     [[Entries]]: Array[1]
         0: WeakSet
         length: 1
-console-format-es6.html:11 Set
+console-format-es6.html:11 Set {WeakSet {…}}
     size: (...)
     __proto__: Set
     [[Entries]]: Array[1]
         0: WeakSet
         length: 1
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Set]
     0: Set
     length: 1
     __proto__: Array[0]
 globals[11]
-Set
+Set {WeakSet {…}}
     size: (...)
     __proto__: Set
     [[Entries]]: Array[1]
         0: WeakSet
         length: 1
-console-format-es6.html:11 Map
+console-format-es6.html:11 Map {" from str " => " to str ", undefined => undefined, null => null, 42 => 42, Object {foo: "from"} => Object {foo: "to"}}
     size: (...)
     __proto__: Map
     [[Entries]]: Array[5]
@@ -265,12 +212,12 @@ console-format-es6.html:11 Map
         3: {42 => 42}
         4: {Object => Object}
         length: 5
-console-format-es6.html:12 Array[1]
+console-format-es6.html:12 [Map]
     0: Map
     length: 1
     __proto__: Array[0]
 globals[12]
-Map
+Map {" from str " => " to str ", undefined => undefined, null => null, 42 => 42, Object {foo: "from"} => Object {foo: "to"}}
     size: (...)
     __proto__: Map
     [[Entries]]: Array[5]
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-format-es6.html b/third_party/WebKit/LayoutTests/inspector/console/console-format-es6.html
index 6173369..7ca8fe2 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-format-es6.html
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-format-es6.html
@@ -70,15 +70,13 @@ function test()
         {
             var next = current + 1;
             if (next == total.description)
-                finish();
+                InspectorTest.expandConsoleMessages(finish);
             else
                 loopOverGlobals(next, total);
         }
 
         function finish()
         {
-            InspectorTest.dumpConsoleMessages(false, false, InspectorTest.textContentWithLineBreaks);
-            InspectorTest.addResult("Expanded all messages");
             InspectorTest.expandConsoleMessages(dumpConsoleMessages);
         }
 
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-format-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/console-format-expected.txt
index 09ff15e..e1c6446 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-format-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-format-expected.txt
@@ -97,188 +97,6 @@ CONSOLE MESSAGE: line 13: [object Uint8Array]
 Tests that console logging dumps proper messages.
 
  console-format.html:21 Array[10]
-console-format.html:22 Array[10]
-console-format.html:23 Array[10]
-console-format.html:24 Test for zero "0" in formatter
-console-format.html:25 % self-escape1 dummy
-console-format.html:26 %s self-escape2 dummy
-console-format.html:27 %ss self-escape3 dummy
-console-format.html:28 %sdummy%s self-escape4
-console-format.html:29 %%% self-escape5 dummy
-console-format.html:30 %dummy self-escape6
-console-format.html:7 /^url\(\s*(?:(?:"(?:[^\\\"]|(?:\\[\da-f]{1,6}\s?|\.))*"|'(?:[^\\\']|(?:\\[\da-f]{1,6}\s?|\.))*')|(?:[!#$%&*-~\w]|(?:\\[\da-f]{1,6}\s?|\.))*)\s*\)/i
-console-format.html:8 [/^url\(\s*(?:(?:"(?:[^\\\"]|(?:\\[\da-f]{1,6}\s?|\…?:[!#$%&*-~\w]|(?:\\[\da-f]{1,6}\s?|\.))*)\s*\)/i]
-globals[0]
-/^url\(\s*(?:(?:"(?:[^\\\"]|(?:\\[\da-f]{1,6}\s?|\.))*"|'(?:[^\\\']|(?:\\[\da-f]{1,6}\s?|\.))*')|(?:[!#$%&*-~\w]|(?:\\[\da-f]{1,6}\s?|\.))*)\s*\)/i
-console-format.html:7 /foo\\bar\sbaz/i
-console-format.html:8 [/foo\\bar\sbaz/i]
-globals[1]
-/foo\\bar\sbaz/i
-console-format.html:7 test
-console-format.html:8 ["test"]
-globals[2]
-"test"
-console-format.html:7 test named "test"
-console-format.html:8 ["test named "test""]
-globals[3]
-"test named "test""
-console-format.html:7 Error(…)
-console-format.html:8 [Error
-]
-globals[4]
-Error(…)
-console-format.html:7 Error: my error message(…)
-console-format.html:8 [Error: my error message
-]
-globals[5]
-Error: my error message(…)
-console-format.html:7 Error: my multiline(…)
-console-format.html:8 [Error: my multiline
-error message
-]
-globals[6]
-Error: my multiline(…)
-console-format.html:7 
-    <p id="p">Tests that console logging dumps proper messages.</p>
-console-format.html:8 [p#p]
-globals[7]
-    <p id="p">Tests that console logging dumps proper messages.</p>
-console-format.html:7 () { return 1; }
-console-format.html:8 [function]
-globals[8]
-() { return 1; }
-console-format.html:7 () {
-        return 2;
-    }
-console-format.html:8 [function]
-globals[9]
-() {
-        return 2;
-    }
-console-format.html:7 0.12
-console-format.html:8 [0.12]
-globals[10]
-0.12
-console-format.html:7 http://webkit.org/
-console-format.html:8 ["http://webkit.org/"]
-globals[11]
-"http://webkit.org/"
-console-format.html:7 null
-console-format.html:8 [null]
-globals[12]
-null
-console-format.html:7 undefined
-console-format.html:8 [undefined]
-globals[13]
-undefined
-console-format.html:7 
-    attr=""
-console-format.html:8 [attr]
-globals[14]
-    attr=""
-console-format.html:7 
-    attr="value"
-console-format.html:8 [attr]
-globals[15]
-    attr="value"
-console-format.html:7 
-    id="x"
-console-format.html:8 [id]
-globals[16]
-    id="x"
-console-format.html:7 Object {}
-console-format.html:8 [Object]
-globals[17]
-Object {}
-console-format.html:7 NaN
-console-format.html:8 [NaN]
-globals[18]
-NaN
-console-format.html:7 Infinity
-console-format.html:8 [Infinity]
-globals[19]
-Infinity
-console-format.html:7 -Infinity
-console-format.html:8 [-Infinity]
-globals[20]
--Infinity
-console-format.html:7 ["test", "test2", 4: "test4", foo: Object]
-console-format.html:8 [Array[10]]
-globals[21]
-["test", "test2", undefined × 2, "test4", undefined × 5]
-console-format.html:7 Object {}
-console-format.html:8 [Object]
-globals[22]
-Object {}
-console-format.html:7 [function]
-console-format.html:8 [Array[1]]
-globals[23]
-[function]
-console-format.html:7 Object {bar: "bar"}
-console-format.html:8 [Object]
-globals[24]
-Object {bar: "bar"}
-console-format.html:7 
-    <svg id="svg-node"></svg>
-console-format.html:8 [svg#svg-node]
-globals[25]
-    <svg id="svg-node"></svg>
-console-format.html:7 Object {}
-console-format.html:8 [Object]
-globals[26]
-Object {}
-console-format.html:7 -0
-console-format.html:8 [-0]
-globals[27]
--0
-console-format.html:7 Object {}
-console-format.html:8 [Object]
-globals[28]
-Object {}
-console-format.html:7 Object() { [native code] }
-console-format.html:8 [function]
-globals[29]
-Object() { [native code] }
-console-format.html:7 Object {}
-console-format.html:8 [Object]
-globals[30]
-Object {}
-console-format.html:7 ( /**/ foo/**/, /*/**/bar,
-    /**/baz) {}
-console-format.html:8 [function]
-globals[31]
-( /**/ foo/**/, /*/**/bar,
-    /**/baz) {}
-console-format.html:7 Number {[[PrimitiveValue]]: 42}
-console-format.html:8 [Number]
-globals[32]
-Number {[[PrimitiveValue]]: 42}
-console-format.html:7 String {0: "a", 1: "b", 2: "c", length: 3, [[PrimitiveValue]]: "abc"}
-console-format.html:8 [String]
-globals[33]
-String {0: "a", 1: "b", 2: "c", length: 3, [[PrimitiveValue]]: "abc"}
-console-format.html:7 [1, 2, 3]
-console-format.html:8 [Uint16Array[3]]
-globals[34]
-[1, 2, 3]
-console-format.html:7 #text
-console-format.html:8 [text]
-globals[35]
-#text
-console-format.html:7 DOMException: Failed to execute 'removeChild' on 'Node': The node to be removed is not a child of this node.
-console-format.html:8 [DOMException: Failed to execute 'removeChild' on 'Node': The node to be removed is not a child of th…]
-globals[36]
-DOMException: Failed to execute 'removeChild' on 'Node': The node to be removed is not a child of this node.
-console-format.html:7 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…]
-console-format.html:8 [Uint8Array[400]]
-globals[37]
-Uint8Array[400]
-console-format.html:7 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…]
-console-format.html:8 [Uint8Array[400000000]]
-globals[38]
-Uint8Array[400000000]
-Expanded all messages
-console-format.html:21 Array[10]
     0: "test"
     1: "test2"
     4: "test4"
@@ -307,42 +125,44 @@ console-format.html:28 %sdummy%s self-escape4
 console-format.html:29 %%% self-escape5 dummy
 console-format.html:30 %dummy self-escape6
 console-format.html:7 /^url\(\s*(?:(?:"(?:[^\\\"]|(?:\\[\da-f]{1,6}\s?|\.))*"|'(?:[^\\\']|(?:\\[\da-f]{1,6}\s?|\.))*')|(?:[!#$%&*-~\w]|(?:\\[\da-f]{1,6}\s?|\.))*)\s*\)/i
-console-format.html:8 Array[1]
+console-format.html:8 [/^url\(\s*(?:(?:"(?:[^\\\"]|(?:\\[\da-f]{1,6}\s?|\…?:[!#$%&*-~\w]|(?:\\[\da-f]{1,6}\s?|\.))*)\s*\)/i]
     0: /^url\(\s*(?:(?:"(?:[^\\\"]|(?:\\[\da-f]{1,6}\s?|\.))*"|'(?:[^\\\']|(?:\\[\da-f]{1,6}\s?|\.))*')|(?:[!#$%&*-~\w]|(?:\\[\da-f]{1,6}\s?|\.))*)\s*\)/i
     length: 1
     __proto__: Array[0]
 globals[0]
 /^url\(\s*(?:(?:"(?:[^\\\"]|(?:\\[\da-f]{1,6}\s?|\.))*"|'(?:[^\\\']|(?:\\[\da-f]{1,6}\s?|\.))*')|(?:[!#$%&*-~\w]|(?:\\[\da-f]{1,6}\s?|\.))*)\s*\)/i
 console-format.html:7 /foo\\bar\sbaz/i
-console-format.html:8 Array[1]
+console-format.html:8 [/foo\\bar\sbaz/i]
     0: /foo\\bar\sbaz/i
     length: 1
     __proto__: Array[0]
 globals[1]
 /foo\\bar\sbaz/i
 console-format.html:7 test
-console-format.html:8 Array[1]
+console-format.html:8 ["test"]
     0: "test"
     length: 1
     __proto__: Array[0]
 globals[2]
 "test"
 console-format.html:7 test named "test"
-console-format.html:8 Array[1]
+console-format.html:8 ["test named "test""]
     0: "test named "test""
     length: 1
     __proto__: Array[0]
 globals[3]
 "test named "test""
 console-format.html:7 Error
-console-format.html:8 Array[1]
+console-format.html:8 [Error
+]
     0: Error
     length: 1
     __proto__: Array[0]
 globals[4]
 Error
 console-format.html:7 Error: my error message
-console-format.html:8 Array[1]
+console-format.html:8 [Error: my error message
+]
     0: Error: my error message
     length: 1
     __proto__: Array[0]
@@ -350,7 +170,9 @@ globals[5]
 Error: my error message
 console-format.html:7 Error: my multiline
 error message
-console-format.html:8 Array[1]
+console-format.html:8 [Error: my multiline
+error message
+]
     0: Error: my multiline
 error message
     length: 1
@@ -360,14 +182,14 @@ Error: my multiline
 error message
 console-format.html:7 
     <p id="p">Tests that console logging dumps proper messages.</p>
-console-format.html:8 Array[1]
+console-format.html:8 [p#p]
     0: p#p
     length: 1
     __proto__: Array[0]
 globals[7]
     <p id="p">Tests that console logging dumps proper messages.</p>
 console-format.html:7 () { return 1; }
-console-format.html:8 Array[1]
+console-format.html:8 [function]
     0: ()
     length: 1
     __proto__: Array[0]
@@ -376,7 +198,7 @@ globals[8]
 console-format.html:7 () {
         return 2;
     }
-console-format.html:8 Array[1]
+console-format.html:8 [function]
     0: ()
     length: 1
     __proto__: Array[0]
@@ -385,28 +207,28 @@ globals[9]
         return 2;
     }
 console-format.html:7 0.12
-console-format.html:8 Array[1]
+console-format.html:8 [0.12]
     0: 0.12
     length: 1
     __proto__: Array[0]
 globals[10]
 0.12
 console-format.html:7 http://webkit.org/
-console-format.html:8 Array[1]
+console-format.html:8 ["http://webkit.org/"]
     0: "http://webkit.org/"
     length: 1
     __proto__: Array[0]
 globals[11]
 "http://webkit.org/"
 console-format.html:7 null
-console-format.html:8 Array[1]
+console-format.html:8 [null]
     0: null
     length: 1
     __proto__: Array[0]
 globals[12]
 null
 console-format.html:7 undefined
-console-format.html:8 Array[1]
+console-format.html:8 [undefined]
     0: undefined
     length: 1
     __proto__: Array[0]
@@ -414,7 +236,7 @@ globals[13]
 undefined
 console-format.html:7 
     attr=""
-console-format.html:8 Array[1]
+console-format.html:8 [attr]
     0: attr
     length: 1
     __proto__: Array[0]
@@ -422,7 +244,7 @@ globals[14]
     attr=""
 console-format.html:7 
     attr="value"
-console-format.html:8 Array[1]
+console-format.html:8 [attr]
     0: attr
     length: 1
     __proto__: Array[0]
@@ -430,147 +252,147 @@ globals[15]
     attr="value"
 console-format.html:7 
     id="x"
-console-format.html:8 Array[1]
+console-format.html:8 [id]
     0: id
     length: 1
     __proto__: Array[0]
 globals[16]
     id="x"
-console-format.html:7 Object
+console-format.html:7 Object {}
     length: (...)
     get length: length()
     __proto__: Object
-console-format.html:8 Array[1]
+console-format.html:8 [Object]
     0: Object
     length: 1
     __proto__: Array[0]
 globals[17]
-Object
+Object {}
     length: (...)
     get length: length()
     __proto__: Object
 console-format.html:7 NaN
-console-format.html:8 Array[1]
+console-format.html:8 [NaN]
     0: NaN
     length: 1
     __proto__: Array[0]
 globals[18]
 NaN
 console-format.html:7 Infinity
-console-format.html:8 Array[1]
+console-format.html:8 [Infinity]
     0: Infinity
     length: 1
     __proto__: Array[0]
 globals[19]
 Infinity
 console-format.html:7 -Infinity
-console-format.html:8 Array[1]
+console-format.html:8 [-Infinity]
     0: -Infinity
     length: 1
     __proto__: Array[0]
 globals[20]
 -Infinity
-console-format.html:7 Array[10]
+console-format.html:7 ["test", "test2", 4: "test4", foo: Object]
     0: "test"
     1: "test2"
     4: "test4"
     foo: Object
     length: 10
     __proto__: Array[0]
-console-format.html:8 Array[1]
+console-format.html:8 [Array[10]]
     0: Array[10]
     length: 1
     __proto__: Array[0]
 globals[21]
-Array[10]
+["test", "test2", undefined × 2, "test4", undefined × 5]
     0: "test"
     1: "test2"
     4: "test4"
     foo: Object
     length: 10
     __proto__: Array[0]
-console-format.html:7 Object
+console-format.html:7 Object {}
     __proto__: Object
-console-format.html:8 Array[1]
+console-format.html:8 [Object]
     0: Object
     length: 1
     __proto__: Array[0]
 globals[22]
-Object
+Object {}
     __proto__: Object
-console-format.html:7 Array[1]
+console-format.html:7 [function]
     0: ()
     length: 1
     __proto__: Array[0]
-console-format.html:8 Array[1]
+console-format.html:8 [Array[1]]
     0: Array[1]
     length: 1
     __proto__: Array[0]
 globals[23]
-Array[1]
+[function]
     0: ()
     length: 1
     __proto__: Array[0]
-console-format.html:7 Object
+console-format.html:7 Object {bar: "bar"}
     bar: "bar"
     __proto__: Object
-console-format.html:8 Array[1]
+console-format.html:8 [Object]
     0: Object
     length: 1
     __proto__: Array[0]
 globals[24]
-Object
+Object {bar: "bar"}
     bar: "bar"
     __proto__: Object
 console-format.html:7 
     <svg id="svg-node"></svg>
-console-format.html:8 Array[1]
+console-format.html:8 [svg#svg-node]
     0: svg#svg-node
     length: 1
     __proto__: Array[0]
 globals[25]
     <svg id="svg-node"></svg>
-console-format.html:7 Object
+console-format.html:7 Object {}
     bar: (...)
     get bar: ()
     set bar: (x)
     getFoo: ()
     __proto__: Object
-console-format.html:8 Array[1]
+console-format.html:8 [Object]
     0: Object
     length: 1
     __proto__: Array[0]
 globals[26]
-Object
+Object {}
     bar: (...)
     get bar: ()
     set bar: (x)
     getFoo: ()
     __proto__: Object
 console-format.html:7 -0
-console-format.html:8 Array[1]
+console-format.html:8 [-0]
     0: -0
     length: 1
     __proto__: Array[0]
 globals[27]
 -0
-console-format.html:7 Object
+console-format.html:7 Object {}
     No Properties
-console-format.html:8 Array[1]
+console-format.html:8 [Object]
     0: Object
     length: 1
     __proto__: Array[0]
 globals[28]
-Object
+Object {}
     No Properties
 console-format.html:7 Object() { [native code] }
-console-format.html:8 Array[1]
+console-format.html:8 [function]
     0: Object()
     length: 1
     __proto__: Array[0]
 globals[29]
 Object() { [native code] }
-console-format.html:7 Object
+console-format.html:7 Object {}
     __defineGetter__: __defineGetter__()
     __defineSetter__: __defineSetter__()
     __lookupGetter__: __lookupGetter__()
@@ -584,12 +406,12 @@ console-format.html:7 Object
     valueOf: valueOf()
     get __proto__: __proto__()
     set __proto__: __proto__()
-console-format.html:8 Array[1]
+console-format.html:8 [Object]
     0: Object
     length: 1
     __proto__: Array[0]
 globals[30]
-Object
+Object {}
     __defineGetter__: __defineGetter__()
     __defineSetter__: __defineSetter__()
     __lookupGetter__: __lookupGetter__()
@@ -605,44 +427,44 @@ Object
     set __proto__: __proto__()
 console-format.html:7 ( /**/ foo/**/, /*/**/bar,
     /**/baz) {}
-console-format.html:8 Array[1]
+console-format.html:8 [function]
     0: ( /**/ foo/**/, /*/**/bar,     /**/baz)
     length: 1
     __proto__: Array[0]
 globals[31]
 ( /**/ foo/**/, /*/**/bar,
     /**/baz) {}
-console-format.html:7 Number
+console-format.html:7 Number {[[PrimitiveValue]]: 42}
     __proto__: Number
     [[PrimitiveValue]]: 42
-console-format.html:8 Array[1]
+console-format.html:8 [Number]
     0: Number
     length: 1
     __proto__: Array[0]
 globals[32]
-Number
+Number {[[PrimitiveValue]]: 42}
     __proto__: Number
     [[PrimitiveValue]]: 42
-console-format.html:7 String
+console-format.html:7 String {0: "a", 1: "b", 2: "c", length: 3, [[PrimitiveValue]]: "abc"}
     0: "a"
     1: "b"
     2: "c"
     length: 3
     __proto__: String
     [[PrimitiveValue]]: "abc"
-console-format.html:8 Array[1]
+console-format.html:8 [String]
     0: String
     length: 1
     __proto__: Array[0]
 globals[33]
-String
+String {0: "a", 1: "b", 2: "c", length: 3, [[PrimitiveValue]]: "abc"}
     0: "a"
     1: "b"
     2: "c"
     length: 3
     __proto__: String
     [[PrimitiveValue]]: "abc"
-console-format.html:7 Uint16Array[3]
+console-format.html:7 [1, 2, 3]
     0: 1
     1: 2
     2: 3
@@ -652,12 +474,12 @@ console-format.html:7 Uint16Array[3]
     length: (...)
     Symbol(Symbol.toStringTag): (...)
     __proto__: TypedArray
-console-format.html:8 Array[1]
+console-format.html:8 [Uint16Array[3]]
     0: Uint16Array[3]
     length: 1
     __proto__: Array[0]
 globals[34]
-Uint16Array[3]
+[1, 2, 3]
     0: 1
     1: 2
     2: 3
@@ -668,27 +490,27 @@ Uint16Array[3]
     Symbol(Symbol.toStringTag): (...)
     __proto__: TypedArray
 console-format.html:7 #text
-console-format.html:8 Array[1]
+console-format.html:8 [text]
     0: text
     length: 1
     __proto__: Array[0]
 globals[35]
 #text
 console-format.html:7 DOMException: Failed to execute 'removeChild' on 'Node': The node to be removed is not a child of this node.
-console-format.html:8 Array[1]
+console-format.html:8 [DOMException: Failed to execute 'removeChild' on 'Node': The node to be removed is not a child of th…]
     0: DOMException: Failed to execute 'removeChild' on 'Node': The node to be removed is not a child of this node.
     length: 1
     __proto__: Array[0]
 globals[36]
 DOMException: Failed to execute 'removeChild' on 'Node': The node to be removed is not a child of this node.
-console-format.html:7 Uint8Array[400]
+console-format.html:7 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…]
     [0 … 99]
     [100 … 199]
     [200 … 299]
     [300 … 399]
     foo: "bar"
     __proto__: TypedArray
-console-format.html:8 Array[1]
+console-format.html:8 [Uint8Array[400]]
     0: Uint8Array[400]
     length: 1
     __proto__: Array[0]
@@ -700,13 +522,13 @@ Uint8Array[400]
     [300 … 399]
     foo: "bar"
     __proto__: TypedArray
-console-format.html:7 Uint8Array[400000000]
+console-format.html:7 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…]
     [0 … 99999999]
     [100000000 … 199999999]
     [200000000 … 299999999]
     [300000000 … 399999999]
     __proto__: TypedArray
-console-format.html:8 Array[1]
+console-format.html:8 [Uint8Array[400000000]]
     0: Uint8Array[400000000]
     length: 1
     __proto__: Array[0]
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-format.html b/third_party/WebKit/LayoutTests/inspector/console/console-format.html
index c1f3979..0196ca9 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-format.html
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-format.html
@@ -114,8 +114,6 @@ function test()
 
         function onRemoteObjectsLoaded()
         {
-            InspectorTest.dumpConsoleMessagesIgnoreErrorStackFrames();
-            InspectorTest.addResult("Expanded all messages");
             InspectorTest.expandConsoleMessages(InspectorTest.expandConsoleMessagesErrorParameters.bind(this, finish), undefined, function(section) { return section.element.firstChild.textContent !== "#text"; });
         }
 
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-log-object-with-getter-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/console-log-object-with-getter-expected.txt
index ba61f01..3257afd 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-log-object-with-getter-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-log-object-with-getter-expected.txt
@@ -1,5 +1,5 @@
 CONSOLE MESSAGE: line 10: [object Object]
 Tests that console logging dumps object values defined by getters and allows to expand it.
 
-console-log-object-with-getter.html:10 Objectfoo: Objecta: 1b: 2__proto__: Objectget foo: ()__proto__: Object
+console-log-object-with-getter.html:10 Object {}foo: Objecta: 1b: 2__proto__: Objectget foo: ()__proto__: Object
 
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-object-preview-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/console-object-preview-expected.txt
index 4d45237..416b9ce 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-object-preview-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-object-preview-expected.txt
@@ -28,58 +28,30 @@ CONSOLE MESSAGE: line 74: [object Object]
 Tests that console produces instant previews for arrays and objects.
 
 console-object-preview.html:9 Mutating object in a loop console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:13 Object {a: 0, b: 0, c: 0} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > children
-console-object-preview.html:13 Object {a: 0, b: 0, c: 1} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > children
-console-object-preview.html:13 Object {a: 0, b: 0, c: 2} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > children
+console-object-preview.html:13 Object {a: 0, b: 0, c: 0} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > object-state-note info-note > children
+console-object-preview.html:13 Object {a: 0, b: 0, c: 1} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > object-state-note info-note > children
+console-object-preview.html:13 Object {a: 0, b: 0, c: 2} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > object-state-note info-note > children
 console-object-preview.html:16 Mutating array in a loop console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:20 [0, 0, 0] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > object-value-number > children
-console-object-preview.html:20 [0, 0, 1] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > object-value-number > children
-console-object-preview.html:20 [0, 0, 2] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > object-value-number > children
+console-object-preview.html:20 [0, 0, 0] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > object-value-number > object-state-note info-note > children
+console-object-preview.html:20 [0, 0, 1] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > object-value-number > object-state-note info-note > children
+console-object-preview.html:20 [0, 0, 2] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > object-value-number > object-state-note info-note > children
 console-object-preview.html:23 Object with many properties console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:28 Object {property_0: 0, property_1: 1, property_2: 2, property_3: 3, property_4: 4…} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > children
+console-object-preview.html:28 Object {property_0: 0, property_1: 1, property_2: 2, property_3: 3, property_4: 4…} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > object-state-note info-note > children
 console-object-preview.html:30 Array with many properties console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:35 [0, 1, property_0: 0, property_1: 1, property_2: 2, property_3: 3, property_4: 4…] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > children
+console-object-preview.html:35 [0, 1, property_0: 0, property_1: 1, property_2: 2, property_3: 3, property_4: 4…] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > object-state-note info-note > children
 console-object-preview.html:37 Object with proto console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:40 Object {d: 1} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > children
+console-object-preview.html:40 Object {d: 1} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > object-state-note info-note > children
 console-object-preview.html:42 Sparse array console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:45 [50: 50] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > children
+console-object-preview.html:45 [50: 50] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > object-state-note info-note > children
 console-object-preview.html:47 Dense array with indexes and propeties console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:53 [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99…] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > children
+console-object-preview.html:53 [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99…] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-value-number > object-state-note info-note > children
 console-object-preview.html:55 Object with properties containing whitespaces console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:62 Object {" a b ": " a b ", c d: "c d", "": "", "  ": "  ", "a↵↵b↵c": "a↵↵b↵c"} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-string > name > object-value-string > name > object-value-string > name > object-value-string > name > object-value-string > children
+console-object-preview.html:62 Object {" a b ": " a b ", c d: "c d", "": "", "  ": "  ", "a↵↵b↵c": "a↵↵b↵c"} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-string > name > object-value-string > name > object-value-string > name > object-value-string > name > object-value-string > object-state-note info-note > children
 console-object-preview.html:64 Object with a document.all property console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:65 Object {all: HTMLAllCollection[7]} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-array > children
+console-object-preview.html:65 Object {all: HTMLAllCollection[7]} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-array > object-state-note info-note > children
 console-object-preview.html:67 Object with special numbers console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:69 Object {nan: NaN, posInf: Infinity, negInf: -Infinity, negZero: -0} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > children
+console-object-preview.html:69 Object {nan: NaN, posInf: Infinity, negInf: -Infinity, negZero: -0} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > object-state-note info-note > children
 console-object-preview.html:71 Object with exactly 5 properties: expected to be lossless console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:72 Object {a: 1, b: 2, c: 3, d: 4, e: 5} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > children
-console-object-preview.html:74 Object {null: null, undef: undefined, regexp: /^[regexp]$/g, bool: false} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-null > name > object-value-undefined > name > object-value-regexp > name > object-value-boolean > children
-Expanded all messages
-console-object-preview.html:9 Mutating object in a loop console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:13 Objecta: 0b: 0c: 2__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
-console-object-preview.html:13 Objecta: 0b: 0c: 2__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
-console-object-preview.html:13 Objecta: 0b: 0c: 2__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
-console-object-preview.html:16 Mutating array in a loop console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:20 Array[3]0: 01: 02: 2length: 3__proto__: Array[0] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-array > children
-console-object-preview.html:20 Array[3]0: 01: 02: 2length: 3__proto__: Array[0] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-array > children
-console-object-preview.html:20 Array[3]0: 01: 02: 2length: 3__proto__: Array[0] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-array > children
-console-object-preview.html:23 Object with many properties console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:28 Objectproperty_0: 0property_1: 1property_2: 2property_3: 3property_4: 4property_5: 5property_6: 6property_7: 7property_8: 8property_9: 9__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
-console-object-preview.html:30 Array with many properties console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:35 Array[2]0: 01: 1length: 2property_0: 0property_1: 1property_2: 2property_3: 3property_4: 4property_5: 5property_6: 6property_7: 7property_8: 8property_9: 9__proto__: Array[0] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-array > children
-console-object-preview.html:37 Object with proto console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:40 Objectd: 1__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
-console-object-preview.html:42 Sparse array console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:45 Array[150]50: 50length: 150__proto__: Array[0] console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-array > children
-console-object-preview.html:47 Dense array with indexes and propeties console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:53 Array[150][0 … 99][100 … 149]length: 150property_0: 0property_1: 1property_2: 2property_3: 3property_4: 4property_5: 5property_6: 6property_7: 7property_8: 8property_9: 9property_10: 10property_11: 11property_12: 12property_13: 13property_14: 14property_15: 15property_16: 16property_17: 17property_18: 18property_19: 19property_20: 20property_21: 21property_22: 22property_23: 23property_24: 24property_25: 25property_26: 26property_27: 27property_28: 28property_29: 29property_30: 30property_31: 31property_32: 32property_33: 33property_34: 34property_35: 35property_36: 36property_37: 37property_38: 38property_39: 39property_40: 40property_41: 41property_42: 42property_43: 43property_44: 44property_45: 45property_46: 46property_47: 47property_48: 48property_49: 49property_50: 50property_51: 51property_52: 52property_53: 53property_54: 54property_55: 55property_56: 56property_57: 57property_58: 58property_59: 59property_60: 60property_61: 61property_62: 62property_63: 63property_64:  console-message-text source-code > console-message-url webkit-html-resource-link > object-value-array source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > parent object-properties-section-name > selection fill > tree-element-title > children > parent object-properties-section-name > selection fill > tree-element-title > children > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-array > children
-console-object-preview.html:55 Object with properties containing whitespaces console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:62 Object"": """  ": "  "" a b ": " a b ""a↵↵b↵c": "a↵↵b↵c"c d: "c d"__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-string > children > selection fill > name > object-properties-section-separator > value object-value-string > children > selection fill > name > object-properties-section-separator > value object-value-string > children > selection fill > name > object-properties-section-separator > value object-value-string > children > selection fill > name > object-properties-section-separator > value object-value-string > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
-console-object-preview.html:64 Object with a document.all property console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:65 Objectall: HTMLAllCollection[7]__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > parent > selection fill > name > object-properties-section-separator > value object-value-array > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
-console-object-preview.html:67 Object with special numbers console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:69 Objectnan: NaNnegInf: -InfinitynegZero: -0posInf: Infinity__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
-console-object-preview.html:71 Object with exactly 5 properties: expected to be lossless console-message-text source-code > console-message-url webkit-html-resource-link
-console-object-preview.html:72 Objecta: 1b: 2c: 3d: 4e: 5__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > selection fill > name > object-properties-section-separator > value object-value-number > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
-console-object-preview.html:74 Objectbool: falsenull: nullregexp: /^[regexp]$/gundef: undefined__proto__: Object console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > selection fill > name > object-properties-section-separator > value object-value-boolean > children > selection fill > name > object-properties-section-separator > value object-value-null > children > parent > selection fill > name > object-properties-section-separator > value object-value-regexp > children > selection fill > name > object-properties-section-separator > value object-value-undefined > children > parent > selection fill > name object-properties-section-dimmed > object-properties-section-separator > value object-value-object > children
+console-object-preview.html:72 Object {a: 1, b: 2, c: 3, d: 4, e: 5} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > name > object-value-number > object-state-note info-note > children
+console-object-preview.html:74 Object {null: null, undef: undefined, regexp: /^[regexp]$/g, bool: false} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-object source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-null > name > object-value-undefined > name > object-value-regexp > name > object-value-boolean > object-state-note info-note > children
 
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-object-preview.html b/third_party/WebKit/LayoutTests/inspector/console/console-object-preview.html
index eea7136..840b367 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-object-preview.html
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-object-preview.html
@@ -76,16 +76,9 @@ function logToConsole()
 
 function test()
 {
-    InspectorTest.evaluateInPage("logToConsole()", step2);
+    InspectorTest.evaluateInPage("logToConsole()", callback);
 
-    function step2()
-    {
-        InspectorTest.dumpConsoleMessages(false, true);
-        InspectorTest.addResult("Expanded all messages");
-        InspectorTest.expandConsoleMessages(step3);
-    }
-
-    function step3()
+    function callback()
     {
         InspectorTest.dumpConsoleMessages(false, true);
         InspectorTest.completeTest();
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-proxy-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/console-proxy-expected.txt
index 52fda27..28e43a7 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-proxy-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-proxy-expected.txt
@@ -2,11 +2,12 @@ CONSOLE MESSAGE: line 21: [object Proxy]
 CONSOLE MESSAGE: line 23: [object Proxy]
 Tests that console logging dumps proxy properly.
 
-console-proxy.html:21 Proxy {boo: 42, foo: 43} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-proxy source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > children
-console-proxy.html:23 Proxy {boo: 42, foo: 43} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-proxy source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > children
+info-note display: none
+console-proxy.html:21 Proxy {boo: 42, foo: 43} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-proxy source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > object-state-note info-note > children
+console-proxy.html:23 Proxy {boo: 42, foo: 43} console-message-text source-code > console-message-url webkit-html-resource-link > object-value-proxy source-code > console-view-object-properties-section > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element > selection fill > console-object-preview > name > object-value-number > name > object-value-number > object-state-note info-note > children
 window.accessedGet = false
 info-note display: inline-block
-console-proxy.html:21 Proxy[[Handler]]: Object[[Target]]: Object[[IsRevoked]]: false console-message-text source-code > console-message-url webkit-html-resource-link > object-value-proxy source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > parent > selection fill > name > object-properties-section-separator > value object-value-object > children > parent > selection fill > name > object-properties-section-separator > value object-value-object > children > selection fill > name > object-properties-section-separator > value object-value-boolean > children
-console-proxy.html:23 Proxy[[Handler]]: Object[[Target]]: Proxy[[IsRevoked]]: false console-message-text source-code > console-message-url webkit-html-resource-link > object-value-proxy source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > object-state-note info-note > children expanded > parent > selection fill > name > object-properties-section-separator > value object-value-object > children > parent > selection fill > name > object-properties-section-separator > value object-value-proxy > children > selection fill > name > object-properties-section-separator > value object-value-boolean > children
+console-proxy.html:21 Proxy {boo: 42, foo: 43}[[Handler]]: Object[[Target]]: Object[[IsRevoked]]: false console-message-text source-code > console-message-url webkit-html-resource-link > object-value-proxy source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > console-object-preview > name > object-value-number > name > object-value-number > object-state-note info-note > children expanded > parent > selection fill > name > object-properties-section-separator > value object-value-object > children > parent > selection fill > name > object-properties-section-separator > value object-value-object > children > selection fill > name > object-properties-section-separator > value object-value-boolean > children
+console-proxy.html:23 Proxy {boo: 42, foo: 43}[[Handler]]: Object[[Target]]: Proxy[[IsRevoked]]: false console-message-text source-code > console-message-url webkit-html-resource-link > object-value-proxy source-code > console-view-object-properties-section expanded > tree-outline-disclosure tree-outline-disclosure-hide-overflow > tree-outline source-code object-properties-section > parent object-properties-section-root-element expanded > selection fill > console-object-preview > name > object-value-number > name > object-value-number > object-state-note info-note > children expanded > parent > selection fill > name > object-properties-section-separator > value object-value-object > children > parent > selection fill > name > object-properties-section-separator > value object-value-proxy > children > selection fill > name > object-properties-section-separator > value object-value-boolean > children
 window.accessedGet = false
 
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-proxy.html b/third_party/WebKit/LayoutTests/inspector/console/console-proxy.html
index 9352c97..1371e6c 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-proxy.html
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-proxy.html
@@ -33,6 +33,7 @@ function test()
         var consoleView = WebInspector.ConsoleView.instance();
         consoleView._viewport.invalidate()
         var element = consoleView._visibleViewMessages[0].contentElement();
+        dumpNoteVisible(element, "info-note");
 
         InspectorTest.dumpConsoleMessages(false, true);
         InspectorTest.evaluateInPage("window.accessedGet", dumpAccessedGetAndExpand);
diff --git a/third_party/WebKit/LayoutTests/inspector/console/console-uncaught-promise-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/console-uncaught-promise-expected.txt
index 29d2ec2..d9b8826 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/console-uncaught-promise-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/console/console-uncaught-promise-expected.txt
@@ -27,7 +27,7 @@ timeout @ console-uncaught-promise.html:16
     console-uncaught-promise.html:78 Uncaught (in promise) foo
 promiseTest6 @ console-uncaught-promise.html:78
 timeout @ console-uncaught-promise.html:16
-    console-uncaught-promise.html:83 Uncaught (in promise) Object
+    console-uncaught-promise.html:83 Uncaught (in promise) Object {foo: 42}
     foo: 42
     __proto__: Object
 promiseTest7 @ console-uncaught-promise.html:83
diff --git a/third_party/WebKit/LayoutTests/inspector/console/worker-eval-contains-stack-expected.txt b/third_party/WebKit/LayoutTests/inspector/console/worker-eval-contains-stack-expected.txt
index f33be35..518c6d8 100644
--- a/third_party/WebKit/LayoutTests/inspector/console/worker-eval-contains-stack-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/console/worker-eval-contains-stack-expected.txt
@@ -9,5 +9,5 @@ Tests exception message from eval on worker context in console contains stack tr
                 foo();
             }
             boo();
-VM:3 Uncaught Objecta: 239__proto__: Objectfoo @ VM:3boo @ VM:7(anonymous function) @ VM:9
+VM:3 Uncaught Object {a: 239}a: 239__proto__: Objectfoo @ VM:3boo @ VM:7(anonymous function) @ VM:9
 
diff --git a/third_party/WebKit/LayoutTests/inspector/elements/accessibility/accessibility-pane-test.js b/third_party/WebKit/LayoutTests/inspector/elements/accessibility/accessibility-pane-test.js
index 06e2e06..f5abb99 100644
--- a/third_party/WebKit/LayoutTests/inspector/elements/accessibility/accessibility-pane-test.js
+++ b/third_party/WebKit/LayoutTests/inspector/elements/accessibility/accessibility-pane-test.js
@@ -7,7 +7,7 @@ InspectorTest.showAccessibilityView = function()
 {
     var sidebarPane = _getAccessibilitySidebarPane();
     if (sidebarPane) {
-        sidebarPane.revealView();
+        sidebarPane.revealWidget();
         return InspectorTest.waitForAccessibilityNodeUpdate();
     } else {
         return _waitForViewsLoaded()
diff --git a/third_party/WebKit/LayoutTests/inspector/elements/hide-shortcut.html b/third_party/WebKit/LayoutTests/inspector/elements/hide-shortcut.html
index cabdc0a..5a18711 100644
--- a/third_party/WebKit/LayoutTests/inspector/elements/hide-shortcut.html
+++ b/third_party/WebKit/LayoutTests/inspector/elements/hide-shortcut.html
@@ -4,16 +4,16 @@
 <script src="../../http/tests/inspector/elements-test.js"></script>
 <script>
 
-function pseudoVisibility(pseudo)
+function pseudoVisibility(resolve, reject, pseudo)
 {
     var parentNode = document.getElementById("parent-node");
-    return getComputedStyle(parentNode, ":" + pseudo).visibility;
+    resolve(getComputedStyle(parentNode, ":" + pseudo).visibility);
 }
 
-function pseudoIframeVisibility()
+function pseudoIframeVisibility(resolve, reject)
 {
     var parentNode = frames[0].document.getElementById("frame-node");
-    return getComputedStyle(parentNode).visibility;
+    resolve(getComputedStyle(parentNode).visibility);
 }
 
 function test()
@@ -125,10 +125,10 @@ function test()
 
             function callback()
             {
-                InspectorTest.evaluateInPagePromise("pseudoIframeVisibility()").then(function(result) {
+                InspectorTest.invokePageFunctionPromise("pseudoIframeVisibility", []).then(function(result) {
                     InspectorTest.addResult("=== Added hide shortcut in frame ===");
                     InspectorTest.addResult("=== Frame node is hidden ===");
-                    InspectorTest.addResult("visibility: " + result.value + ";");
+                    InspectorTest.addResult("visibility: " + result + ";");
                     next();
                 });
             }
@@ -145,9 +145,8 @@ function test()
         treeOutline.toggleHideElement(pseudoNode, callback);
         function callback()
         {
-            var pseudoNodeTypeArg = pseudoNode.pseudoType() ? ("\"" + pseudoNode.pseudoType() + "\"") : "undefined";
-            InspectorTest.evaluateInPagePromise("pseudoVisibility(" + pseudoNodeTypeArg + ")").then(function(result) {
-                InspectorTest.addResult("::" + pseudoNode.pseudoType() + " node visibility: '" + result.value + "'");
+            InspectorTest.invokePageFunctionPromise("pseudoVisibility", [pseudoNode.pseudoType()]).then(function(result) {
+                InspectorTest.addResult("::" + pseudoNode.pseudoType() + " node visibility: '" + result + "'");
                 next();
             });
         }
diff --git a/third_party/WebKit/LayoutTests/inspector/elements/styles-1/case-sensitive-suggestions.html b/third_party/WebKit/LayoutTests/inspector/elements/styles-1/case-sensitive-suggestions.html
index e2b3ffe..8d39dd7 100644
--- a/third_party/WebKit/LayoutTests/inspector/elements/styles-1/case-sensitive-suggestions.html
+++ b/third_party/WebKit/LayoutTests/inspector/elements/styles-1/case-sensitive-suggestions.html
@@ -6,7 +6,7 @@
 
 function test()
 {
-    var prompt = new WebInspector.StylesSidebarPane.CSSPropertyPrompt(WebInspector.CSSMetadata.cssPropertiesMetainfo.allProperties(), null, true);
+    var prompt = new WebInspector.StylesSidebarPane.CSSPropertyPrompt(WebInspector.CSSMetadata.cssPropertiesMetainfo, null, true);
 
     InspectorTest.runTestSuite([
         function testForUpperCase(next)
diff --git a/third_party/WebKit/LayoutTests/inspector/elements/styles-3/style-autocomplete.html b/third_party/WebKit/LayoutTests/inspector/elements/styles-3/style-autocomplete.html
index 3bc4233..c45c7b9 100644
--- a/third_party/WebKit/LayoutTests/inspector/elements/styles-3/style-autocomplete.html
+++ b/third_party/WebKit/LayoutTests/inspector/elements/styles-3/style-autocomplete.html
@@ -6,12 +6,13 @@
 
 function test()
 {
-    var namePrompt = new WebInspector.StylesSidebarPane.CSSPropertyPrompt(WebInspector.CSSMetadata.cssPropertiesMetainfo.allProperties(), null, true);
+
+    var namePrompt = new WebInspector.StylesSidebarPane.CSSPropertyPrompt(WebInspector.CSSMetadata.cssPropertiesMetainfo, null, true);
     var valuePrompt = valuePromptFor("color");
 
     function valuePromptFor(name)
     {
-        return new WebInspector.StylesSidebarPane.CSSPropertyPrompt(WebInspector.CSSMetadata.propertyValues(name), null, false);
+        return new WebInspector.StylesSidebarPane.CSSPropertyPrompt(WebInspector.CSSMetadata.keywordsForProperty(name), null, false);
     }
 
     InspectorTest.runTestSuite([
diff --git a/third_party/WebKit/LayoutTests/inspector/elements/styles-4/supported-css-properties.html b/third_party/WebKit/LayoutTests/inspector/elements/styles-4/supported-css-properties.html
index 5d0bb64..31f010f 100644
--- a/third_party/WebKit/LayoutTests/inspector/elements/styles-4/supported-css-properties.html
+++ b/third_party/WebKit/LayoutTests/inspector/elements/styles-4/supported-css-properties.html
@@ -5,7 +5,8 @@
 function test()
 {
     var cssProperty = "box-shadow";
-    if (WebInspector.CSSMetadata.cssPropertiesMetainfo.hasProperty(cssProperty))
+    var properties = WebInspector.CSSMetadata.cssPropertiesMetainfo.startsWith(cssProperty);
+    if (properties.length)
         InspectorTest.addResult(cssProperty + " is supported");
     else
         InspectorTest.addResult(cssProperty + " is NOT supported");
diff --git a/third_party/WebKit/LayoutTests/inspector/extensions/extensions-events.html b/third_party/WebKit/LayoutTests/inspector/extensions/extensions-events.html
index 75aaef0..0eb9f40 100644
--- a/third_party/WebKit/LayoutTests/inspector/extensions/extensions-events.html
+++ b/third_party/WebKit/LayoutTests/inspector/extensions/extensions-events.html
@@ -12,7 +12,7 @@ function initialize_extensionsSidebarTest()
     {
         var sidebar = InspectorTest._extensionSidebar();
         InspectorTest.deprecatedRunAfterPendingDispatches(function() {
-            sidebar.revealView();
+            sidebar.revealWidget();
             callback();
         });
     }
diff --git a/third_party/WebKit/LayoutTests/inspector/extensions/extensions-sidebar.html b/third_party/WebKit/LayoutTests/inspector/extensions/extensions-sidebar.html
index 058e8c0..0f93226 100644
--- a/third_party/WebKit/LayoutTests/inspector/extensions/extensions-sidebar.html
+++ b/third_party/WebKit/LayoutTests/inspector/extensions/extensions-sidebar.html
@@ -19,7 +19,7 @@ function initialize_extensionsSidebarTest()
     {
         var sidebar = InspectorTest._extensionSidebar(panelName);
         InspectorTest.deprecatedRunAfterPendingDispatches(function() {
-            sidebar.revealView();
+            sidebar.revealWidget();
             callback();
         });
     }
diff --git a/third_party/WebKit/LayoutTests/inspector/reveal-objects.html b/third_party/WebKit/LayoutTests/inspector/reveal-objects.html
index f8e4c98..52617f7 100644
--- a/third_party/WebKit/LayoutTests/inspector/reveal-objects.html
+++ b/third_party/WebKit/LayoutTests/inspector/reveal-objects.html
@@ -100,7 +100,7 @@ function test() {
         InspectorTest.addSniffer(WebInspector.ElementsPanel.prototype, "revealAndSelectNode", nodeRevealed, true);
         InspectorTest.addSniffer(WebInspector.SourcesPanel.prototype, "showUILocation", uiLocationRevealed, true);
         InspectorTest.addSniffer(WebInspector.ResourcesPanel.prototype, "showResource", resourceRevealed, true);
-        InspectorTest.addSniffer(WebInspector.NetworkPanel.prototype, "revealAndHighlightRequest", revealed, true);
+        InspectorTest.addSniffer(WebInspector.NetworkPanel.prototype, "revealAndHighlightRequest", revealWidgeted, true);
     }
 
     function nodeRevealed(node)
@@ -118,7 +118,7 @@ function test() {
         InspectorTest.addResult("Resource " + resource.displayName + " revealed in the Resources panel");
     }
 
-    function revealed(request)
+    function revealWidgeted(request)
     {
         InspectorTest.addResult("Request " + new WebInspector.ParsedURL(request.url).lastPathComponent + " revealed in the Network panel");
     }
diff --git a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-css-expected.txt b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-css-expected.txt
index 7c1b9ba..cec7a67 100644
--- a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-css-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-css-expected.txt
@@ -9,48 +9,38 @@ Running: testClassNameAutocomplete
 ======= Autocomplete Suggestions =======
 [.red, .blue]
 
-Running: testPropertyNameAutocomplete1
+Running: testPropertyNameAutocomplete
 ========= Selection In Editor =========
 .red { color: red }
 .blue { c|
 ======= Autocomplete Suggestions =======
 [color]
-
-Running: testPropertyNameAutocomplete2
 ========= Selection In Editor =========
 .my-class { -|webkit-border: 1px solid black; -webkit-color: blue;
 text-align: }
 ======= Autocomplete Suggestions =======
 [-webkit-color]
 
-Running: testPropertyValueAutocomplete1
+Running: testPropertyValueAutocomplete
 ========= Selection In Editor =========
 .red { border-style: |
 /* some other words to mess up */
 ======= Autocomplete Suggestions =======
 [dashed, dotted, double, groove, hidden, inherit, initial, inset, none, outset, ridge, solid]
-
-Running: testPropertyValueAutocomplete2
 ========= Selection In Editor =========
 .red { border-style: d|
 /* dial drummer dig */
 ======= Autocomplete Suggestions =======
 [dashed, dotted, double]
-
-Running: testPropertyValueAutocomplete3
 ========= Selection In Editor =========
 .red { border-style: z|
 /* zipper zorro zion */
 ======= Autocomplete Suggestions =======
 []
-
-Running: testPropertyValueAutocomplete4
 ========= Selection In Editor =========
 .red { border-style/* comment */: /* comment */|
 ======= Autocomplete Suggestions =======
 [dashed, dotted, double, groove, hidden, inherit, initial, inset, none, outset, ridge, solid]
-
-Running: testPropertyValueAutocomplete5
 ========= Selection In Editor =========
 .my-class { -webkit-border: 1px solid black; -webkit-color: blue;
 text-align: |}
diff --git a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-css.html b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-css.html
index 850bfe8..8d65a6e 100644
--- a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-css.html
+++ b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-css.html
@@ -26,58 +26,45 @@ function test()
                 ".red { color: red }",
                 ".blue { color: blue }",
                 ".|"
-            ]).then(next);
+            ]);
+            next();
         },
 
-        function testPropertyNameAutocomplete1(next)
+        function testPropertyNameAutocomplete(next)
         {
             dumpSuggestions([
                 ".red { color: red }",
                 ".blue { c|"
-            ]).then(next);
-        },
-
-        function testPropertyNameAutocomplete2(next)
-        {
+            ]);
             dumpSuggestions([
                 ".my-class { -|webkit-border: 1px solid black; -webkit-color: blue;",
                 "text-align: }"
-            ]).then(next);
+            ]);
+            next();
         },
 
-        function testPropertyValueAutocomplete1(next)
+        function testPropertyValueAutocomplete(next)
         {
             dumpSuggestions([
                 ".red { border-style: |",
                 "/* some other words to mess up */"
-            ]).then(next);
-        },
-
-        function testPropertyValueAutocomplete2(next){
+            ]);
             dumpSuggestions([
                 ".red { border-style: d|",
                 "/* dial drummer dig */"
-            ]).then(next);
-        },
-
-        function testPropertyValueAutocomplete3(next){
+            ]);
             dumpSuggestions([
                 ".red { border-style: z|",
                 "/* zipper zorro zion */"
-            ]).then(next);
-        },
-
-        function testPropertyValueAutocomplete4(next){
+            ]);
             dumpSuggestions([
                 ".red { border-style/* comment */: /* comment */|"
-            ]).then(next);
-        },
-
-        function testPropertyValueAutocomplete5(next){
+            ]);
             dumpSuggestions([
                 ".my-class { -webkit-border: 1px solid black; -webkit-color: blue;",
                 "text-align: |}"
-            ]).then(next);
+            ]);
+            next();
         },
 
         function verifySuggestionsOnColumnTypedIn(next)
@@ -89,13 +76,15 @@ function test()
             ].join("\n"));
             textEditor.setSelection(WebInspector.TextRange.createFromLocation(1, 10));
             InspectorTest.dumpTextWithSelection(textEditor);
-            InspectorTest.addSniffer(WebInspector.TextEditorAutocompleteController.prototype, "_onSuggestionsShownForTest", suggestionsShown);
+            var suggestions = [];
+            InspectorTest.addSniffer(WebInspector.TextEditorAutocompleteController.prototype, "_onSuggestionsShownForTest", function(words) { suggestions = words; });
+            InspectorTest.addSniffer(WebInspector.TextEditorAutocompleteController.prototype, "autocomplete", onTypedIn);
             InspectorTest.typeIn(textEditor, ":");
 
-            function suggestionsShown(words)
+            function onTypedIn()
             {
                 InspectorTest.addResult("Suggestions displayed on ':' symbol typed in:");
-                InspectorTest.addResult("[" + words.map(item => item.title).join(", ") + "]");
+                InspectorTest.addResult("[" + suggestions.join(", ") + "]");
                 next();
             }
         },
diff --git a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-scss-expected.txt b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-scss-expected.txt
index 65cfaa8..3b9a865 100644
--- a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-scss-expected.txt
+++ b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-scss-expected.txt
@@ -1,15 +1,13 @@
 The test verifies autocomplete suggestions for SCSS file.
 
 
-Running: testPropertyValueSuggestionsBefore$
+Running: testPropertyValueSuggestions
 ========= Selection In Editor =========
 @mixin my-border-style($style) {
     border-style: |$;
 }
 ======= Autocomplete Suggestions =======
 [dashed, dotted, double, groove, hidden, inherit, initial, inset, none, outset, ridge, solid]
-
-Running: testPropertyValueSuggestionsAfter$
 ========= Selection In Editor =========
 @mixin my-border-style($style) {
     border-style: $|;
diff --git a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-scss.html b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-scss.html
index 7ad581f..2cb2cd1 100644
--- a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-scss.html
+++ b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-scss.html
@@ -17,23 +17,21 @@ function test()
         InspectorTest.runTestSuite(testSuite);
     }
 
+
     var testSuite = [
-        function testPropertyValueSuggestionsBefore$(next)
+        function testPropertyValueSuggestions(next)
         {
             dumpSuggestions([
                 "@mixin my-border-style($style) {",
                 "    border-style: |$;",
                 "}"
-            ]).then(next)
-        },
-
-        function testPropertyValueSuggestionsAfter$(next)
-        {
+            ]);
             dumpSuggestions([
                 "@mixin my-border-style($style) {",
                 "    border-style: $|;",
                 "}"
-            ]).then(next);
+            ]);
+            next();
         },
     ];
 }
diff --git a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-test.js b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-test.js
index 4ebe5bc..8daf79f 100644
--- a/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-test.js
+++ b/third_party/WebKit/LayoutTests/inspector/sources/autocomplete-test.js
@@ -1,33 +1,27 @@
 function initialize_AutocompleteTest()
 {
 
-    InspectorTest.dumpSuggestions = function(textEditor, lines)
-    {
-        var resolve;
-        var promise = new Promise(fulfill => resolve = fulfill);
-        var lineNumber = -1, columnNumber;
-        for (var i = 0; i < lines.length; ++i) {
-            var columnNumber = lines[i].indexOf("|");
-            if (columnNumber !== -1) {
-                lineNumber = i;
-                break;
-            }
+InspectorTest.dumpSuggestions = function(textEditor, lines) {
+    var lineNumber = -1, columnNumber;
+    for (var i = 0; i < lines.length; ++i) {
+        var columnNumber = lines[i].indexOf("|");
+        if (columnNumber !== -1) {
+            lineNumber = i;
+            break;
         }
-        if (lineNumber === -1)
-            throw new Error("Test case is invalid: cursor position is not marked with '|' symbol.");
-        textEditor.setText(lines.join("\n").replace("|", ""));
-        textEditor.setSelection(WebInspector.TextRange.createFromLocation(lineNumber, columnNumber));
-        InspectorTest.addSniffer(WebInspector.TextEditorAutocompleteController.prototype, "_onSuggestionsShownForTest", suggestionsShown);
-        textEditor._autocompleteController.autocomplete();
-        function suggestionsShown(words)
-        {
-            InspectorTest.addResult("========= Selection In Editor =========");
-            InspectorTest.dumpTextWithSelection(textEditor);
-            InspectorTest.addResult("======= Autocomplete Suggestions =======");
-            InspectorTest.addResult("[" + words.map(item => item.title).join(", ") + "]");
-            resolve();
-        }
-        return promise;
     }
+    if (lineNumber === -1)
+        throw new Error("Test case is invalid: cursor position is not marked with '|' symbol.");
+    textEditor.setText(lines.join("\n").replace("|", ""));
+    textEditor.setSelection(WebInspector.TextRange.createFromLocation(lineNumber, columnNumber));
+    var suggestions = [];
+    InspectorTest.addSniffer(WebInspector.TextEditorAutocompleteController.prototype, "_onSuggestionsShownForTest", function (words) { suggestions = words; });
+    textEditor._autocompleteController.autocomplete();
+
+    InspectorTest.addResult("========= Selection In Editor =========");
+    InspectorTest.dumpTextWithSelection(textEditor);
+    InspectorTest.addResult("======= Autocomplete Suggestions =======");
+    InspectorTest.addResult("[" + suggestions.join(", ") + "]");
+}
 
 }
diff --git a/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/error-in-watch-expressions.html b/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/error-in-watch-expressions.html
index 1b48d8b..642f7a7 100644
--- a/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/error-in-watch-expressions.html
+++ b/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/error-in-watch-expressions.html
@@ -8,7 +8,7 @@ var foo = 123
 var test = function()
 {
     var watchExpressionsPane = WebInspector.panels.sources.sidebarPanes.watchExpressions;
-    watchExpressionsPane.revealView();
+    watchExpressionsPane.revealWidget();
     watchExpressionsPane.addExpression("#$%");
 
     InspectorTest.deprecatedRunAfterPendingDispatches(step1);
diff --git a/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/last-execution-context.html b/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/last-execution-context.html
index 655319c..939f470 100644
--- a/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/last-execution-context.html
+++ b/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/last-execution-context.html
@@ -27,14 +27,14 @@ function test()
     InspectorTest.addResult("");
     InspectorTest.addResult("Adding page target");
     var pageTarget = InspectorTest.createMockTarget("page-target");
-    pageTarget.runtimeModel._executionContextCreated({id: "cs1", auxData: { isDefault: false, frameId: "42" }, origin: "origin", name: "contentScript1"});
-    pageTarget.runtimeModel._executionContextCreated({id: "if1", auxData: { isDefault: true, frameId: "iframe1" }, origin: "origin", name: "iframeContext1"});
-    pageTarget.runtimeModel._executionContextCreated({id: "p1", auxData: { isDefault: true, frameId: "42" }, origin: "origin", name: "pageContext1Name"});
+    pageTarget.runtimeModel._executionContextCreated({id: "cs1", isDefault: false, origin: "origin", name: "contentScript1", frameId: "42"});
+    pageTarget.runtimeModel._executionContextCreated({id: "if1", isDefault: true, origin: "origin", name: "iframeContext1", frameId: "iframe1"});
+    pageTarget.runtimeModel._executionContextCreated({id: "p1", isDefault: true, origin: "origin", name: "pageContext1Name", frameId: "42"});
 
     InspectorTest.addResult("");
     InspectorTest.addResult("Adding sw target");
     var swTarget = InspectorTest.createMockTarget("sw-target", null, WebInspector.Target.Capability.Network | WebInspector.Target.Capability.Worker);
-    swTarget.runtimeModel._executionContextCreated({id: "sw1", auxData: { isDefault: true, frameId: "" }, origin: "origin", name: "swContext1Name"});
+    swTarget.runtimeModel._executionContextCreated({id: "sw1", isDefault: true, origin: "origin", name: "swContext1Name", frameId: ""});
 
     InspectorTest.addResult("");
     InspectorTest.addResult("Removing page main frame");
@@ -42,7 +42,7 @@ function test()
 
     InspectorTest.addResult("");
     InspectorTest.addResult("Readding page main frame");
-    pageTarget.runtimeModel._executionContextCreated({id: "p2", auxData: { isDefault: true, frameId: "42" }, origin: "origin", name: "pageContext1Name"});
+    pageTarget.runtimeModel._executionContextCreated({id: "p2", isDefault: true, origin: "origin", name: "pageContext1Name", frameId: "42"});
 
     InspectorTest.addResult("");
     InspectorTest.addResult("Switching to sw target");
@@ -86,7 +86,7 @@ function test()
 
     InspectorTest.addResult("");
     InspectorTest.addResult("Readding page main frame");
-    pageTarget.runtimeModel._executionContextCreated({id: "p3", auxData: { isDefault: true, frameId: "42" }, origin: "origin", name: "pageContext1Name"});
+    pageTarget.runtimeModel._executionContextCreated({id: "p3", isDefault: true, origin: "origin", name: "pageContext1Name", frameId: "42"});
 
     InspectorTest.completeTest();
 }
diff --git a/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/watch-expressions-panel-switch.html b/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/watch-expressions-panel-switch.html
index b286431..7dc82c5 100644
--- a/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/watch-expressions-panel-switch.html
+++ b/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/watch-expressions-panel-switch.html
@@ -24,13 +24,13 @@ var test = function()
     function step1()
     {
         watchExpressionsPane = WebInspector.panels.sources.sidebarPanes.watchExpressions;
-        watchExpressionsPane.revealView().then(() => {
-            watchExpressionsPane.addExpression("window.document");
-            watchExpressionsPane.addExpression("windowa.document");
-            var testName = InspectorTest.mainTarget.inspectedURL();
-            testName = testName.substring(testName.lastIndexOf('/') + 1);
-            InspectorTest.showScriptSource(testName, didShowScriptSource);
-        });
+        watchExpressionsPane.revealWidget();
+        watchExpressionsPane.addExpression("window.document");
+        watchExpressionsPane.addExpression("windowa.document");
+
+        var testName = InspectorTest.mainTarget.inspectedURL();
+        testName = testName.substring(testName.lastIndexOf('/') + 1);
+        InspectorTest.showScriptSource(testName, didShowScriptSource);
     }
 
     function didShowScriptSource(sourceFrame)
diff --git a/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/watch-expressions-preserve-expansion.html b/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/watch-expressions-preserve-expansion.html
index ffaf000..d4299de 100644
--- a/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/watch-expressions-preserve-expansion.html
+++ b/third_party/WebKit/LayoutTests/inspector/sources/debugger-ui/watch-expressions-preserve-expansion.html
@@ -27,7 +27,7 @@ for (var i = 0; i < 300; ++i)
 var test = function()
 {
     var watchExpressionsPane = WebInspector.panels.sources.sidebarPanes.watchExpressions;
-    watchExpressionsPane.revealView();
+    watchExpressionsPane.revealWidget();
     watchExpressionsPane.addExpression("globalObject");
     watchExpressionsPane.addExpression("windowAlias");
     watchExpressionsPane.addExpression("array");
diff --git a/third_party/WebKit/LayoutTests/inspector/tabbed-pane-closeable-persistence.html b/third_party/WebKit/LayoutTests/inspector/tabbed-pane-closeable-persistence.html
index 29325a0..7be8a91 100644
--- a/third_party/WebKit/LayoutTests/inspector/tabbed-pane-closeable-persistence.html
+++ b/third_party/WebKit/LayoutTests/inspector/tabbed-pane-closeable-persistence.html
@@ -4,40 +4,29 @@
 <script type="text/javascript">
 var test = function()
 {
-    var tabbedLocation = WebInspector.viewManager.createTabbedLocation();
-    logPersistenceSetting();
+    function logPersistenceSetting()
+    {
+        InspectorTest.addResult("Closeable tabs to restore: " + JSON.stringify(tabbedPaneController._closeableTabSetting.get()));
+    }
 
+    var tabbedPaneController = WebInspector.inspectorView._drawerTabbedLocation;
+    logPersistenceSetting();
     // Show a closeable tab.
-    var sensors = new WebInspector.SimpleView("sensors");
-    sensors.isCloseable = function() { return true; }
-    tabbedLocation.showView(sensors);
+    tabbedPaneController.showView("sensors");
     logPersistenceSetting();
-
-    // Repeat.
-    tabbedLocation.showView(sensors);
+    tabbedPaneController.showView("sensors");
     logPersistenceSetting();
-
     // Show a permanent tab.
-    var console = new WebInspector.SimpleView("console");
-    tabbedLocation.showView(console);
+    tabbedPaneController.showView("console");
     logPersistenceSetting();
-
-    // Show transient tab.
-    var history = new WebInspector.SimpleView("history");
-    history.isTransient = function() { return true; }
-    tabbedLocation.showView(history);
+    // Show temporary tab.
+    tabbedPaneController.showView("sources.history");
     logPersistenceSetting();
-
     // Close closeable tab.
-    tabbedLocation.tabbedPane().closeTab("sensors");
+    tabbedPaneController.tabbedPane().closeTab("sensors");
     logPersistenceSetting();
 
     InspectorTest.completeTest();
-
-    function logPersistenceSetting()
-    {
-        InspectorTest.addResult("Closeable tabs to restore: " + JSON.stringify(tabbedLocation._closeableTabSetting.get()));
-    }
 }
 </script>
 </head>
diff --git a/third_party/WebKit/LayoutTests/paint/invalidation/empty-object-move-and-resize-expected.txt b/third_party/WebKit/LayoutTests/paint/invalidation/empty-object-move-and-resize-expected.txt
deleted file mode 100644
index 10aa3fa..0000000
--- a/third_party/WebKit/LayoutTests/paint/invalidation/empty-object-move-and-resize-expected.txt
+++ /dev/null
@@ -1,13 +0,0 @@
-{
-  "name": "Content Root Layer",
-  "bounds": [800, 600],
-  "children": [
-    {
-      "name": "LayoutView #document",
-      "bounds": [800, 600],
-      "contentsOpaque": true,
-      "drawsContent": true
-    }
-  ]
-}
-
diff --git a/third_party/WebKit/LayoutTests/paint/invalidation/empty-object-move-and-resize.html b/third_party/WebKit/LayoutTests/paint/invalidation/empty-object-move-and-resize.html
deleted file mode 100644
index 50e6373..0000000
--- a/third_party/WebKit/LayoutTests/paint/invalidation/empty-object-move-and-resize.html
+++ /dev/null
@@ -1,14 +0,0 @@
-<!DOCTYPE html>
-<script src="../../fast/repaint/resources/text-based-repaint.js"></script>
-<script>
-function repaintTest() {
-  target.style.top = '200px';
-  target.style.left = '200px';
-  target.style.width = '200px';
-  target.style.height = '200px';
-}
-onload = runRepaintTest;
-</script>
-Tests paint invalidation of an empty object when moved and resized.
-It passes if there is not any assertion failure or paint invalidation.
-<div id="target" style="position: absolute; top: 100px; left: 100px; width: 100px; height: 100px"></div>
diff --git a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-long-expected.png b/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-long-expected.png
deleted file mode 100644
index 920366d..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-long-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-many-expected.png b/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-many-expected.png
deleted file mode 100644
index d669478..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-many-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png b/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png
deleted file mode 100644
index 8b8cc5b..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png b/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png
deleted file mode 100644
index 72a040c..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png b/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png
deleted file mode 100644
index 0c6c3a2..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png b/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png
deleted file mode 100644
index 2396e59..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/linux-precise/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux-precise/transforms/2d/hindi-rotated-expected.png b/third_party/WebKit/LayoutTests/platform/linux-precise/transforms/2d/hindi-rotated-expected.png
index 24572a5..5773820 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux-precise/transforms/2d/hindi-rotated-expected.png and b/third_party/WebKit/LayoutTests/platform/linux-precise/transforms/2d/hindi-rotated-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png b/third_party/WebKit/LayoutTests/platform/linux/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png
index b6e878a..8aa8f5a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/css3/filters/filter-repaint-composited-fallback-crash-expected.png b/third_party/WebKit/LayoutTests/platform/linux/css3/filters/filter-repaint-composited-fallback-crash-expected.png
index dd24593..a63ed18 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/css3/filters/filter-repaint-composited-fallback-crash-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/css3/filters/filter-repaint-composited-fallback-crash-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/css3/filters/filter-repaint-composited-fallback-expected.png b/third_party/WebKit/LayoutTests/platform/linux/css3/filters/filter-repaint-composited-fallback-expected.png
index dd24593..a63ed18 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/css3/filters/filter-repaint-composited-fallback-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/css3/filters/filter-repaint-composited-fallback-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png
index 502597b..84cdf69 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-expected.png
index ba3aa66..a08a75e 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png
index 1581b1f..2accd91 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png
index fcc0c2f..062b98b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png
index f23c7b5..dada6dc 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png
index 96bb986..2a03708 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png
index 5d57186..db7fe35 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/month-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/month-picker-appearance-expected.png
index da641d6..fd6394a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/month-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/month-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/month-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/month-picker-appearance-step-expected.png
index 6496000..62bf85b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/month-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/month-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/week-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/week-picker-appearance-expected.png
index d596d52..5c24be1 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/week-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/week-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/week-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/week-picker-appearance-step-expected.png
index 30d1714..352610d 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/week-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/calendar-picker/week-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-empty-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-empty-expected.png
index c51a4ac..bd31bd1 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-empty-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-empty-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-expected.png
index 03f26d6..56574d2 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png
index d29be57..494742a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-long-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-long-expected.png
index 5043463..fd07e66 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-long-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-long-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-many-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-many-expected.png
index 9e62f67..eb98be5 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-many-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-many-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png
index 373e358..debbe46 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png
index 085dfe4..f454762 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-single-option-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-single-option-expected.png
index 795e838..bbb2fab 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-single-option-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-single-option-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-styled-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-styled-expected.png
index 3b5590d..82ec45b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-styled-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-styled-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-texttransform-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-texttransform-expected.png
index c1120b6..8bd7635 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-texttransform-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-texttransform-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-transform-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-transform-expected.png
index a02e4d9..82c4753 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-transform-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-transform-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png
index 00f9018..bc2329c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png
index 881a57b..9b7f787 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-1-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-1-and-click-expected.png
index 80fe0a8..cdf8c0c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-1-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-1-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-10-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-10-and-click-expected.png
index ec02746..e35b96d 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-10-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-10-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-2-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-2-and-click-expected.png
index 38a7bb2..f4a36aa 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-2-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-2-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-3-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-3-and-click-expected.png
index 69e977d..8a150de 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-3-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-3-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-4-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-4-and-click-expected.png
index ae9553e..dad873b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-4-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-4-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-5-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-5-and-click-expected.png
index 50a5d13..4d7df65 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-5-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-5-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-6-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-6-and-click-expected.png
index ec02746..e35b96d 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-6-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-6-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-7-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-7-and-click-expected.png
index ec02746..e35b96d 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-7-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-7-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-8-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-8-and-click-expected.png
index 02fca1b..71a39e8 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-8-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-8-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-9-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-9-and-click-expected.png
index fd8f2b5..90c3a64 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-9-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-add-summary-9-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-1-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-1-and-click-expected.png
index 165d197..1e66c86 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-1-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-1-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-2-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-2-and-click-expected.png
index 35157ab..b0eda67 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-2-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-2-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-3-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-3-and-click-expected.png
index 40ebc65..201606d 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-3-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-3-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-4-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-4-and-click-expected.png
index 2c39f0a..61b3c6b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-4-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-4-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-5-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-5-and-click-expected.png
index 18c7084..bf1a02e 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-5-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-5-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-6-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-6-and-click-expected.png
index 365508c..c20fc9c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-6-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/html/details-remove-summary-6-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/inline-focus-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/inline-focus-expected.png
index dddd4ef..ea869d7 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/inline-focus-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/inline-focus-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/resize-iframe-text-expected.png b/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/resize-iframe-text-expected.png
deleted file mode 100644
index 3a57619..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/resize-iframe-text-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/resize-iframe-text-expected.txt b/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/resize-iframe-text-expected.txt
deleted file mode 100644
index 5f10ddb..0000000
--- a/third_party/WebKit/LayoutTests/platform/linux/fast/repaint/resize-iframe-text-expected.txt
+++ /dev/null
@@ -1,105 +0,0 @@
-{
-  "name": "Content Root Layer",
-  "bounds": [800, 800],
-  "children": [
-    {
-      "name": "LayoutView #document",
-      "bounds": [800, 800],
-      "contentsOpaque": true,
-      "drawsContent": true,
-      "paintInvalidations": [
-        {
-          "object": "LayoutIFrame (positioned) IFRAME",
-          "rect": [0, 0, 800, 800],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 800, 759],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [0, 600, 800, 200],
-          "reason": "incremental"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 800, 36],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow BODY",
-          "rect": [8, 8, 784, 20],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow H1",
-          "rect": [8, 700, 600, 37],
-          "reason": "bounds change"
-        },
-        {
-          "object": "LayoutText #text",
-          "rect": [8, 8, 324, 19],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [785, 0, 15, 600],
-          "reason": "scroll"
-        }
-      ]
-    }
-  ],
-  "objectPaintInvalidations": [
-    {
-      "object": "LayoutView #document",
-      "reason": "incremental"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow BODY",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "RootInlineBox",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutText #text",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "InlineTextBox 'Test passes if you see \"Success\" after window resizes.'",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutIFrame (positioned) IFRAME",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "VerticalScrollbar",
-      "reason": "scroll"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow H1",
-      "reason": "bounds change"
-    },
-    {
-      "object": "RootInlineBox",
-      "reason": "bounds change"
-    },
-    {
-      "object": "LayoutView #document",
-      "reason": "scroll"
-    }
-  ]
-}
-
diff --git a/third_party/WebKit/LayoutTests/platform/linux/media/video-layer-crash-expected.png b/third_party/WebKit/LayoutTests/platform/linux/media/video-layer-crash-expected.png
index 1b3157e..6a3341a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/media/video-layer-crash-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/media/video-layer-crash-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/media/video-transformed-expected.png b/third_party/WebKit/LayoutTests/platform/linux/media/video-transformed-expected.png
index aa656fe..a8e369c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/media/video-transformed-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/media/video-transformed-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/svg/carto.net/tabgroup-expected.png b/third_party/WebKit/LayoutTests/platform/linux/svg/carto.net/tabgroup-expected.png
index 1fca903..11e0c05 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/svg/carto.net/tabgroup-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/svg/carto.net/tabgroup-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/transforms/2d/hindi-rotated-expected.png b/third_party/WebKit/LayoutTests/platform/linux/transforms/2d/hindi-rotated-expected.png
index 4821a4d..343623a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/transforms/2d/hindi-rotated-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/transforms/2d/hindi-rotated-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/virtual/prefer_compositing_to_lcd_text/compositing/overflow/update-widget-positions-on-nested-frames-and-scrollers-expected.png b/third_party/WebKit/LayoutTests/platform/linux/virtual/prefer_compositing_to_lcd_text/compositing/overflow/update-widget-positions-on-nested-frames-and-scrollers-expected.png
index 7f50d7d..2063f25 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/virtual/prefer_compositing_to_lcd_text/compositing/overflow/update-widget-positions-on-nested-frames-and-scrollers-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/virtual/prefer_compositing_to_lcd_text/compositing/overflow/update-widget-positions-on-nested-frames-and-scrollers-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/linux/virtual/scalefactor200withzoom/fast/hidpi/static/popup-menu-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/linux/virtual/scalefactor200withzoom/fast/hidpi/static/popup-menu-appearance-expected.png
index 7c7895b..8944a5c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/linux/virtual/scalefactor200withzoom/fast/hidpi/static/popup-menu-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/linux/virtual/scalefactor200withzoom/fast/hidpi/static/popup-menu-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png
index 66456c5..4be3801 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-expected.png
index b9c3a55..b875d52 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png
index b31243a..44cd271 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png
index f678ff0..e81f646 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png
index 171028d..f2feb7a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png
index a5f0948..2d9b023 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png
index 65cad2e..3882341 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/month-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/month-picker-appearance-expected.png
index 98a3828..24c856f 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/month-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/month-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/month-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/month-picker-appearance-step-expected.png
index 35e92a3..c480fe9 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/month-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/month-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/week-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/week-picker-appearance-expected.png
index f8f27f2..adc31e8 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/week-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/week-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/week-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/week-picker-appearance-step-expected.png
index 99703fd..375d16f 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/week-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/forms/calendar-picker/week-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/repaint/resize-iframe-text-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/repaint/resize-iframe-text-expected.png
deleted file mode 100644
index 9ad77ec..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.10/fast/repaint/resize-iframe-text-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png
index 48c013b..80bf1a3 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-expected.png
index 5a83912..96ee0c1 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png
index 96643b6..6a594c7 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png
index aa67344..ec6cd7a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png
index 90d8ae9..824eea7 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png
index 780556c..69dc326 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png
index c8f262f..c3d14b2 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/month-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/month-picker-appearance-expected.png
index de2f1de..dab938c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/month-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/month-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/month-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/month-picker-appearance-step-expected.png
index 82adc5b..694dd66 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/month-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/month-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/week-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/week-picker-appearance-expected.png
index f3dd6ff..4314835 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/week-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/week-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/week-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/week-picker-appearance-step-expected.png
index 94e2197..febd96d 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/week-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/forms/calendar-picker/week-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/repaint/resize-iframe-text-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/repaint/resize-iframe-text-expected.png
deleted file mode 100644
index 3948f0c..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/repaint/resize-iframe-text-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/repaint/resize-iframe-text-expected.txt b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/repaint/resize-iframe-text-expected.txt
deleted file mode 100644
index 60b584e..0000000
--- a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/fast/repaint/resize-iframe-text-expected.txt
+++ /dev/null
@@ -1,97 +0,0 @@
-{
-  "name": "Content Root Layer",
-  "bounds": [800, 677],
-  "children": [
-    {
-      "name": "LayoutView #document",
-      "bounds": [800, 677],
-      "contentsOpaque": true,
-      "drawsContent": true,
-      "paintInvalidations": [
-        {
-          "object": "LayoutIFrame (positioned) IFRAME",
-          "rect": [0, 0, 800, 677],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [0, 600, 800, 77],
-          "reason": "incremental"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 800, 34],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 785, 677],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow BODY",
-          "rect": [8, 8, 784, 18],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutText #text",
-          "rect": [8, 8, 346, 18],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [785, 0, 15, 677],
-          "reason": "scroll"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [785, 0, 15, 600],
-          "reason": "scroll"
-        }
-      ]
-    }
-  ],
-  "objectPaintInvalidations": [
-    {
-      "object": "LayoutView #document",
-      "reason": "incremental"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow BODY",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "RootInlineBox",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutText #text",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "InlineTextBox 'Test passes if you see \"Success\" after window resizes.'",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutIFrame (positioned) IFRAME",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutView #document",
-      "reason": "scroll"
-    },
-    {
-      "object": "VerticalScrollbar",
-      "reason": "scroll"
-    }
-  ]
-}
-
diff --git a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/transforms/2d/hindi-rotated-expected.png b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/transforms/2d/hindi-rotated-expected.png
index 2aa0726..a42698b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac-mac10.9/transforms/2d/hindi-rotated-expected.png and b/third_party/WebKit/LayoutTests/platform/mac-mac10.9/transforms/2d/hindi-rotated-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-retina/fast/repaint/resize-iframe-text-expected.png b/third_party/WebKit/LayoutTests/platform/mac-retina/fast/repaint/resize-iframe-text-expected.png
deleted file mode 100644
index e3fcffe..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/mac-retina/fast/repaint/resize-iframe-text-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac-retina/fast/repaint/resize-iframe-text-expected.txt b/third_party/WebKit/LayoutTests/platform/mac-retina/fast/repaint/resize-iframe-text-expected.txt
deleted file mode 100644
index 75dea15..0000000
--- a/third_party/WebKit/LayoutTests/platform/mac-retina/fast/repaint/resize-iframe-text-expected.txt
+++ /dev/null
@@ -1,105 +0,0 @@
-{
-  "name": "Content Root Layer",
-  "bounds": [800, 800],
-  "children": [
-    {
-      "name": "LayoutView #document",
-      "bounds": [800, 800],
-      "contentsOpaque": true,
-      "drawsContent": true,
-      "paintInvalidations": [
-        {
-          "object": "LayoutIFrame (positioned) IFRAME",
-          "rect": [0, 0, 800, 800],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 800, 759],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [0, 600, 800, 200],
-          "reason": "incremental"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 800, 34],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow BODY",
-          "rect": [8, 8, 784, 18],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow H1",
-          "rect": [8, 700, 600, 37],
-          "reason": "bounds change"
-        },
-        {
-          "object": "LayoutText #text",
-          "rect": [8, 8, 346, 18],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [785, 0, 15, 600],
-          "reason": "scroll"
-        }
-      ]
-    }
-  ],
-  "objectPaintInvalidations": [
-    {
-      "object": "LayoutView #document",
-      "reason": "incremental"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow BODY",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "RootInlineBox",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutText #text",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "InlineTextBox 'Test passes if you see \"Success\" after window resizes.'",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutIFrame (positioned) IFRAME",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "VerticalScrollbar",
-      "reason": "scroll"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow H1",
-      "reason": "bounds change"
-    },
-    {
-      "object": "RootInlineBox",
-      "reason": "bounds change"
-    },
-    {
-      "object": "LayoutView #document",
-      "reason": "scroll"
-    }
-  ]
-}
-
diff --git a/third_party/WebKit/LayoutTests/platform/mac/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png b/third_party/WebKit/LayoutTests/platform/mac/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png
index cb04861..20c0624 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/css3/filters/filter-repaint-composited-fallback-crash-expected.png b/third_party/WebKit/LayoutTests/platform/mac/css3/filters/filter-repaint-composited-fallback-crash-expected.png
index dd24593..a63ed18 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/css3/filters/filter-repaint-composited-fallback-crash-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/css3/filters/filter-repaint-composited-fallback-crash-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/css3/filters/filter-repaint-composited-fallback-expected.png b/third_party/WebKit/LayoutTests/platform/mac/css3/filters/filter-repaint-composited-fallback-expected.png
index dd24593..a63ed18 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/css3/filters/filter-repaint-composited-fallback-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/css3/filters/filter-repaint-composited-fallback-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png
index 062bf92..e30ffbb 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-expected.png
index a68f08e..6865efb 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png
index 6043915..c4d1dcf 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png
index 9ae4e20..ff2382d 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png
index 25cc4ca..833aebf 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png
index 262841a..95b8d68 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png
index 73e231e..83e067b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/month-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/month-picker-appearance-expected.png
index b9ad0cb..304f1e2 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/month-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/month-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/month-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/month-picker-appearance-step-expected.png
index 2431e8a..5efe5c8 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/month-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/month-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/week-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/week-picker-appearance-expected.png
index c8e4958..f7775a4 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/week-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/week-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/week-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/week-picker-appearance-step-expected.png
index dd318fa..f07dba9 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/week-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/fast/forms/calendar-picker/week-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/repaint/resize-iframe-text-expected.png b/third_party/WebKit/LayoutTests/platform/mac/fast/repaint/resize-iframe-text-expected.png
deleted file mode 100644
index 8242a59..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/mac/fast/repaint/resize-iframe-text-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/fast/repaint/resize-iframe-text-expected.txt b/third_party/WebKit/LayoutTests/platform/mac/fast/repaint/resize-iframe-text-expected.txt
deleted file mode 100644
index 3473213..0000000
--- a/third_party/WebKit/LayoutTests/platform/mac/fast/repaint/resize-iframe-text-expected.txt
+++ /dev/null
@@ -1,97 +0,0 @@
-{
-  "name": "Content Root Layer",
-  "bounds": [800, 681],
-  "children": [
-    {
-      "name": "LayoutView #document",
-      "bounds": [800, 681],
-      "contentsOpaque": true,
-      "drawsContent": true,
-      "paintInvalidations": [
-        {
-          "object": "LayoutIFrame (positioned) IFRAME",
-          "rect": [0, 0, 800, 681],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [0, 600, 800, 81],
-          "reason": "incremental"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 800, 34],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 785, 681],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow BODY",
-          "rect": [8, 8, 784, 18],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutText #text",
-          "rect": [8, 8, 346, 18],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [785, 0, 15, 681],
-          "reason": "scroll"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [785, 0, 15, 600],
-          "reason": "scroll"
-        }
-      ]
-    }
-  ],
-  "objectPaintInvalidations": [
-    {
-      "object": "LayoutView #document",
-      "reason": "incremental"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow BODY",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "RootInlineBox",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutText #text",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "InlineTextBox 'Test passes if you see \"Success\" after window resizes.'",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutIFrame (positioned) IFRAME",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutView #document",
-      "reason": "scroll"
-    },
-    {
-      "object": "VerticalScrollbar",
-      "reason": "scroll"
-    }
-  ]
-}
-
diff --git a/third_party/WebKit/LayoutTests/platform/mac/media/video-layer-crash-expected.png b/third_party/WebKit/LayoutTests/platform/mac/media/video-layer-crash-expected.png
index fd2ad5f..fe2e6a3 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/media/video-layer-crash-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/media/video-layer-crash-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/mac/media/video-transformed-expected.png b/third_party/WebKit/LayoutTests/platform/mac/media/video-transformed-expected.png
index 2d51063..67f1b35 100644
Binary files a/third_party/WebKit/LayoutTests/platform/mac/media/video-transformed-expected.png and b/third_party/WebKit/LayoutTests/platform/mac/media/video-transformed-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png b/third_party/WebKit/LayoutTests/platform/win/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png
index b16a196..ef6760c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png and b/third_party/WebKit/LayoutTests/platform/win/css3/blending/background-blend-mode-overlapping-accelerated-elements-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/css3/filters/filter-repaint-composited-fallback-crash-expected.png b/third_party/WebKit/LayoutTests/platform/win/css3/filters/filter-repaint-composited-fallback-crash-expected.png
index e710e20..29e02c4 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/css3/filters/filter-repaint-composited-fallback-crash-expected.png and b/third_party/WebKit/LayoutTests/platform/win/css3/filters/filter-repaint-composited-fallback-crash-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/css3/filters/filter-repaint-composited-fallback-expected.png b/third_party/WebKit/LayoutTests/platform/win/css3/filters/filter-repaint-composited-fallback-expected.png
index e710e20..29e02c4 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/css3/filters/filter-repaint-composited-fallback-expected.png and b/third_party/WebKit/LayoutTests/platform/win/css3/filters/filter-repaint-composited-fallback-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png
index bae2260..dd0917b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-expected.png
index 741e546..3a7cb8d 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png
index ba0074f..2e7d360 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png
index 0de07c0..72e190c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png
index 378f838..c71d099 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png
index 40cfd29..e4caf39 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-ru-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png
index d73cd06..02b5169 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/month-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/month-picker-appearance-expected.png
index 4785968..c9af26e 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/month-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/month-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/month-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/month-picker-appearance-step-expected.png
index ef7cae9..ea801ae 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/month-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/month-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/week-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/week-picker-appearance-expected.png
index b32c013..0a6bd1b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/week-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/week-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/week-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/week-picker-appearance-step-expected.png
index 2e8e090..1dd010f 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/week-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/calendar-picker/week-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-empty-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-empty-expected.png
index 83fb40b..fbd345e 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-empty-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-empty-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-expected.png
index f2aef43..9eadb15 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png
index 5afb7ba..5394943 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-long-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-long-expected.png
index f82ee9d..3c9e759 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-long-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-long-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-many-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-many-expected.png
index b5f17b9..51e604a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-many-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-many-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png
index 5d05c43..77fd147 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png
index 46fc965..f3fb89c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-single-option-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-single-option-expected.png
index fef3a2d..ae0d8b2 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-single-option-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-single-option-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-styled-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-styled-expected.png
index 560c140..e5d16ba 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-styled-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-styled-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-texttransform-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-texttransform-expected.png
index 103a2ed..b5260a7 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-texttransform-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-texttransform-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-transform-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-transform-expected.png
index 3b7caa4..f6f3647 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-transform-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-transform-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png
index 50a44fc..a8d96e7 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-zoom-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png
index 5f009eb..78d8221 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-1-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-1-and-click-expected.png
index 97c0a45..7f0f575 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-1-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-1-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-10-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-10-and-click-expected.png
index 05c613a..7341dfe 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-10-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-10-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-2-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-2-and-click-expected.png
index 1455c26..b674a3c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-2-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-2-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-3-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-3-and-click-expected.png
index b8d63d6..2fab69f 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-3-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-3-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-4-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-4-and-click-expected.png
index b8808f8..caa645c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-4-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-4-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-5-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-5-and-click-expected.png
index f07b573..3111b2c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-5-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-5-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-6-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-6-and-click-expected.png
index 05c613a..7341dfe 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-6-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-6-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-7-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-7-and-click-expected.png
index 05c613a..7341dfe 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-7-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-7-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-8-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-8-and-click-expected.png
index 8ec9699..50d3091 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-8-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-8-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-9-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-9-and-click-expected.png
index b911a9f..f25cf1c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-9-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-add-summary-9-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-1-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-1-and-click-expected.png
index 91007b5..797988a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-1-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-1-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-2-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-2-and-click-expected.png
index 88b0ad7..989bb73 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-2-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-2-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-3-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-3-and-click-expected.png
index 2f1d660..7edad51 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-3-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-3-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-4-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-4-and-click-expected.png
index 456b756..ea7c0bd 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-4-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-4-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-5-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-5-and-click-expected.png
index 8fec370..f51cf93 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-5-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-5-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-6-and-click-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-6-and-click-expected.png
index c68d7ab..4d316c9 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-6-and-click-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/html/details-remove-summary-6-and-click-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/repaint/inline-focus-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/repaint/inline-focus-expected.png
index 4dc5005..e4b7629 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/repaint/inline-focus-expected.png and b/third_party/WebKit/LayoutTests/platform/win/fast/repaint/inline-focus-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/repaint/resize-iframe-text-expected.png b/third_party/WebKit/LayoutTests/platform/win/fast/repaint/resize-iframe-text-expected.png
deleted file mode 100644
index 8b98393..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/win/fast/repaint/resize-iframe-text-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/fast/repaint/resize-iframe-text-expected.txt b/third_party/WebKit/LayoutTests/platform/win/fast/repaint/resize-iframe-text-expected.txt
deleted file mode 100644
index 5d98ea1..0000000
--- a/third_party/WebKit/LayoutTests/platform/win/fast/repaint/resize-iframe-text-expected.txt
+++ /dev/null
@@ -1,110 +0,0 @@
-{
-  "name": "Content Root Layer",
-  "bounds": [800, 728],
-  "children": [
-    {
-      "name": "LayoutView #document",
-      "bounds": [800, 728],
-      "contentsOpaque": true,
-      "drawsContent": true,
-      "paintInvalidations": [
-        {
-          "object": "LayoutIFrame (positioned) IFRAME",
-          "rect": [0, 0, 800, 728],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [0, 600, 800, 128],
-          "reason": "incremental"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 800, 34],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow HTML",
-          "rect": [0, 0, 785, 728],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow BODY",
-          "rect": [8, 8, 784, 18],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutBlockFlow H1",
-          "rect": [8, 700, 600, 28],
-          "reason": "bounds change"
-        },
-        {
-          "object": "LayoutText #text",
-          "rect": [8, 8, 346, 17],
-          "reason": "forced by layout"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [785, 0, 15, 728],
-          "reason": "scroll"
-        },
-        {
-          "object": "LayoutView #document",
-          "rect": [785, 0, 15, 600],
-          "reason": "scroll"
-        }
-      ]
-    }
-  ],
-  "objectPaintInvalidations": [
-    {
-      "object": "LayoutView #document",
-      "reason": "incremental"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow BODY",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "RootInlineBox",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutText #text",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "InlineTextBox 'Test passes if you see \"Success\" after window resizes.'",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutIFrame (positioned) IFRAME",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow HTML",
-      "reason": "forced by layout"
-    },
-    {
-      "object": "LayoutBlockFlow H1",
-      "reason": "bounds change"
-    },
-    {
-      "object": "RootInlineBox",
-      "reason": "bounds change"
-    },
-    {
-      "object": "LayoutView #document",
-      "reason": "scroll"
-    },
-    {
-      "object": "VerticalScrollbar",
-      "reason": "scroll"
-    }
-  ]
-}
-
diff --git a/third_party/WebKit/LayoutTests/platform/win/media/video-layer-crash-expected.png b/third_party/WebKit/LayoutTests/platform/win/media/video-layer-crash-expected.png
index 430e631..db7ff95 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/media/video-layer-crash-expected.png and b/third_party/WebKit/LayoutTests/platform/win/media/video-layer-crash-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/media/video-transformed-expected.png b/third_party/WebKit/LayoutTests/platform/win/media/video-transformed-expected.png
index 76b08a5..e3f31f9 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/media/video-transformed-expected.png and b/third_party/WebKit/LayoutTests/platform/win/media/video-transformed-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/svg/carto.net/tabgroup-expected.png b/third_party/WebKit/LayoutTests/platform/win/svg/carto.net/tabgroup-expected.png
index c571b1a..c032322 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/svg/carto.net/tabgroup-expected.png and b/third_party/WebKit/LayoutTests/platform/win/svg/carto.net/tabgroup-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/virtual/prefer_compositing_to_lcd_text/compositing/overflow/update-widget-positions-on-nested-frames-and-scrollers-expected.png b/third_party/WebKit/LayoutTests/platform/win/virtual/prefer_compositing_to_lcd_text/compositing/overflow/update-widget-positions-on-nested-frames-and-scrollers-expected.png
index abfdbff..6bacca9 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/virtual/prefer_compositing_to_lcd_text/compositing/overflow/update-widget-positions-on-nested-frames-and-scrollers-expected.png and b/third_party/WebKit/LayoutTests/platform/win/virtual/prefer_compositing_to_lcd_text/compositing/overflow/update-widget-positions-on-nested-frames-and-scrollers-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor150/fast/hidpi/static/popup-menu-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor150/fast/hidpi/static/popup-menu-appearance-expected.png
index 38e0c9f..cd8a13c 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor150/fast/hidpi/static/popup-menu-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor150/fast/hidpi/static/popup-menu-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor200/fast/hidpi/static/popup-menu-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor200/fast/hidpi/static/popup-menu-appearance-expected.png
index 890a68e..f5439f0 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor200/fast/hidpi/static/popup-menu-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor200/fast/hidpi/static/popup-menu-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor200withzoom/fast/hidpi/static/popup-menu-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor200withzoom/fast/hidpi/static/popup-menu-appearance-expected.png
index 890a68e..f5439f0 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor200withzoom/fast/hidpi/static/popup-menu-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win/virtual/scalefactor200withzoom/fast/hidpi/static/popup-menu-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png
index dd1b50f..3cfe321 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-expected.png
index 3ddb3c2..a7673fa 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png
index 5f79ae6..1a6c3b8 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-minimum-date-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png
index 76845e8..7d94e1b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-required-ar-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png
index 9a7f8fe..645d9fe 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-required-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png
index be9c858..c4387d2 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/calendar-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/month-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/month-picker-appearance-expected.png
index c1842fe..cf05c0a 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/month-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/month-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/month-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/month-picker-appearance-step-expected.png
index 2a6f5fd..c219a88 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/month-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/month-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/week-picker-appearance-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/week-picker-appearance-expected.png
index 479454a..e348899 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/week-picker-appearance-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/week-picker-appearance-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/week-picker-appearance-step-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/week-picker-appearance-step-expected.png
index 8fba041..1a6f7e0 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/week-picker-appearance-step-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/calendar-picker/week-picker-appearance-step-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png
deleted file mode 100644
index ffd6483..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-fractional-width-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-long-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-long-expected.png
index 5b80816..1725a9d 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-long-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-long-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-many-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-many-expected.png
index 5e60246..83e9c01 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-many-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-many-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png
index 02f7382..e6fbc97 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-rtl-default-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png
index 07c750a..5043275 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-rtl-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-styled-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-styled-expected.png
index 4c5824e..de78198 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-styled-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-styled-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png
index 14906d4..26e4b5b 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/fast/forms/select-popup/popup-menu-appearance-zoom090-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/fast/repaint/resize-iframe-text-expected.png b/third_party/WebKit/LayoutTests/platform/win7/fast/repaint/resize-iframe-text-expected.png
deleted file mode 100644
index c9226f5..0000000
Binary files a/third_party/WebKit/LayoutTests/platform/win7/fast/repaint/resize-iframe-text-expected.png and /dev/null differ
diff --git a/third_party/WebKit/LayoutTests/platform/win7/transforms/2d/hindi-rotated-expected.png b/third_party/WebKit/LayoutTests/platform/win7/transforms/2d/hindi-rotated-expected.png
index 123900c..c346373 100644
Binary files a/third_party/WebKit/LayoutTests/platform/win7/transforms/2d/hindi-rotated-expected.png and b/third_party/WebKit/LayoutTests/platform/win7/transforms/2d/hindi-rotated-expected.png differ
diff --git a/third_party/WebKit/LayoutTests/plugins/embed-attributes-setting-expected.txt b/third_party/WebKit/LayoutTests/plugins/embed-attributes-setting-expected.txt
index 296e948..28ead30 100644
--- a/third_party/WebKit/LayoutTests/plugins/embed-attributes-setting-expected.txt
+++ b/third_party/WebKit/LayoutTests/plugins/embed-attributes-setting-expected.txt
@@ -1,5 +1,6 @@
 CONSOLE MESSAGE: Blink Test Plugin: initializing
 CONSOLE MESSAGE: Blink Test Plugin: initializing
+CONSOLE MESSAGE: Blink Test Plugin: initializing
 [Embed is element specified in markup]
 PASS: embed.getAttribute('align') should be 1 and is.
 PASS: embed.getAttribute('height') should be 1 and is.
@@ -11,4 +12,7 @@ PASS: typeof embed.postMessage should be function and is.
 ----------
 [Embed is dynamically created element with only type specified]
 PASS: typeof embed.postMessage should be function and is.
+----------
+[Embed is dynamically created element with only src specified]
+PASS: typeof embed.postMessage should be function and is.
  
diff --git a/third_party/WebKit/LayoutTests/plugins/embed-attributes-setting.html b/third_party/WebKit/LayoutTests/plugins/embed-attributes-setting.html
index c323b46..0479132 100644
--- a/third_party/WebKit/LayoutTests/plugins/embed-attributes-setting.html
+++ b/third_party/WebKit/LayoutTests/plugins/embed-attributes-setting.html
@@ -1,7 +1,7 @@
 <html>
 <head>
 <script>
-function print(message, color)
+function print(message, color) 
 {
     var paragraph = document.createElement("div");
     paragraph.appendChild(document.createTextNode(message));
@@ -27,11 +27,11 @@ function shouldBe(a, b)
 
 var embed;
 
-function test()
+function test() 
 {
     if (window.testRunner)
         testRunner.dumpAsText();
-
+        
     embed = document.getElementById('embed');
     print("[Embed is element specified in markup]");
 
@@ -51,7 +51,7 @@ function test()
     shouldBe("typeof embed.postMessage", "function");
 
     print("----------");
-
+    
     embed = document.createElement('embed');
     print("[Embed is dynamically created element with only type specified]");
 
@@ -59,6 +59,16 @@ function test()
     embed.type = "application/x-blink-test-plugin";
     document.body.appendChild(embed);
     shouldBe("typeof embed.postMessage", "function");
+    
+    print("----------");
+    
+    embed = document.createElement('embed');
+    print("[Embed is dynamically created element with only src specified]");
+
+    embed.style.visibility = "hidden";
+    embed.src = "resources/test.blinktestplugin";
+    document.body.appendChild(embed);
+    shouldBe("typeof embed.postMessage", "function");
 }
 </script>
 </head>
diff --git a/third_party/WebKit/LayoutTests/plugins/no-mime-with-valid-extension-expected.txt b/third_party/WebKit/LayoutTests/plugins/no-mime-with-valid-extension-expected.txt
new file mode 100644
index 0000000..830323b
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/plugins/no-mime-with-valid-extension-expected.txt
@@ -0,0 +1,9 @@
+CONSOLE MESSAGE: Blink Test Plugin: initializing
+CONSOLE MESSAGE: Blink Test Plugin: plugin args:
+CONSOLE MESSAGE: Blink Test Plugin:   name = id, value = plugin
+CONSOLE MESSAGE: Blink Test Plugin:   name = name, value = plugin
+CONSOLE MESSAGE: Blink Test Plugin:   name = src, value = resources/test.blinktestplugin
+CONSOLE MESSAGE: Blink Test Plugin:   name = logargs, value = 1
+This test checks that bug 50568 is fixed. logargs is used to log initialization of the plugin. If the bug is present, the logargs attribute that triggers the log will be lost and nothing will be displayed on screen. Upon success, this test should log a message at initialization.
+
+
diff --git a/third_party/WebKit/LayoutTests/plugins/no-mime-with-valid-extension.html b/third_party/WebKit/LayoutTests/plugins/no-mime-with-valid-extension.html
new file mode 100644
index 0000000..3eaecef
--- /dev/null
+++ b/third_party/WebKit/LayoutTests/plugins/no-mime-with-valid-extension.html
@@ -0,0 +1,15 @@
+<script src="../resources/plugin.js"></script>
+<script>
+if (window.testRunner)
+    testRunner.dumpAsText();
+startAfterLoadAndFinish();
+</script>
+<p>
+This test checks that <a href="https://bugs.webkit.org/show_bug.cgi?id=50657">bug 50568</a>
+is fixed. logargs is used to log initialization of the plugin.  If the bug is
+present, the logargs attribute that triggers the log will be lost and nothing
+will be displayed on screen. Upon success, this test should log a message at
+initialization.
+</p>
+<!-- Embed tag with missing type="" parameter -->
+<embed id="plugin" name="plugin" src="resources/test.blinktestplugin" logargs="1">
diff --git a/third_party/WebKit/ManualTests/printing-resize-starts-transition.html b/third_party/WebKit/ManualTests/printing-resize-starts-transition.html
deleted file mode 100644
index fc4f2e2..0000000
--- a/third_party/WebKit/ManualTests/printing-resize-starts-transition.html
+++ /dev/null
@@ -1,30 +0,0 @@
-<!-- This should be a Browser test, unable to create one to land the fix needed here: https://codereview.chromium.org/2089373002 hence landing as a ManualTest for now. See progress here: crbug.com/634565
- -->
-<!DOCTYPE html>
-
-<style>
-#target {
-    padding-top: 1000px;
-}
-
-@media screen and (max-width: 600px) {
-    #target {
-        padding: 0;
-        transition: 10s all;
-    }
-}
-
-@media print {
-    #target {
-        padding: 0 !important;
-    }
-}
-</style>
-
-<div id="target">
-To run this test:</br>
-1. Open this file in Chrome</br>
-2. Note that there is a large padding (1000px) at the top of the text</br>
-3. Open in Print Preview</br>
-4. The test passes if there is no padding at the top.</br>
-</div>
\ No newline at end of file
diff --git a/third_party/WebKit/Source/bindings/IDLExtendedAttributes.md b/third_party/WebKit/Source/bindings/IDLExtendedAttributes.md
index 4e15b52..39fde29 100644
--- a/third_party/WebKit/Source/bindings/IDLExtendedAttributes.md
+++ b/third_party/WebKit/Source/bindings/IDLExtendedAttributes.md
@@ -426,12 +426,6 @@ Summary: Signals that a `readonly` attribute that returns an object type always
 
 This attribute has no effect on code generation and should simply be used in Blink IDL files if the specification uses it. If you want the binding layer to cache the resulting object, use `[SaveSameObject]`.
 
-### [SecureContext] _(a, i, m)_
-
-Standard: [SecureContext](https://heycam.github.io/webidl/#SecureContext)
-
-Summary: Interfaces and interface members with a `SecureContext` attribute are exposed only inside ["Secure Contexts"](https://w3c.github.io/webappsec-secure-contexts/).
-
 ### [TreatNullAs] _(a,p)_, [TreatUndefinedAs] _(a,p)_
 
 Standard: [TreatNullAs](http://heycam.github.io/webidl/#TreatNullAs)
diff --git a/third_party/WebKit/Source/bindings/IDLExtendedAttributes.txt b/third_party/WebKit/Source/bindings/IDLExtendedAttributes.txt
index 8f5d8bc..1b5a509 100644
--- a/third_party/WebKit/Source/bindings/IDLExtendedAttributes.txt
+++ b/third_party/WebKit/Source/bindings/IDLExtendedAttributes.txt
@@ -90,7 +90,6 @@ Replaceable
 RuntimeEnabled=*
 SameObject
 SaveSameObject
-SecureContext
 SetWrapperReferenceFrom=*
 SetWrapperReferenceTo=*
 SetterCallWith=ExecutionContext|ScriptArguments|CurrentWindow|EnteredWindow
diff --git a/third_party/WebKit/Source/bindings/core/v8/JSONValuesForV8.cpp b/third_party/WebKit/Source/bindings/core/v8/JSONValuesForV8.cpp
index 48157b9..9dbf7f5 100644
--- a/third_party/WebKit/Source/bindings/core/v8/JSONValuesForV8.cpp
+++ b/third_party/WebKit/Source/bindings/core/v8/JSONValuesForV8.cpp
@@ -19,7 +19,7 @@ static String coreString(v8::Local<v8::String> v8String)
     return result;
 }
 
-std::unique_ptr<JSONValue> toJSONValue(v8::Local<v8::Context> context, v8::Local<v8::Value> value, int maxDepth)
+PassRefPtr<JSONValue> toJSONValue(v8::Local<v8::Context> context, v8::Local<v8::Value> value, int maxDepth)
 {
     if (value.IsEmpty()) {
         ASSERT_NOT_REACHED();
@@ -40,21 +40,21 @@ std::unique_ptr<JSONValue> toJSONValue(v8::Local<v8::Context> context, v8::Local
         return JSONString::create(coreString(value.As<v8::String>()));
     if (value->IsArray()) {
         v8::Local<v8::Array> array = value.As<v8::Array>();
-        std::unique_ptr<JSONArray> inspectorArray = JSONArray::create();
+        RefPtr<JSONArray> inspectorArray = JSONArray::create();
         uint32_t length = array->Length();
         for (uint32_t i = 0; i < length; i++) {
             v8::Local<v8::Value> value;
             if (!array->Get(context, i).ToLocal(&value))
                 return nullptr;
-            std::unique_ptr<JSONValue> element = toJSONValue(context, value, maxDepth);
+            RefPtr<JSONValue> element = toJSONValue(context, value, maxDepth);
             if (!element)
                 return nullptr;
-            inspectorArray->pushValue(std::move(element));
+            inspectorArray->pushValue(element);
         }
-        return std::move(inspectorArray);
+        return inspectorArray;
     }
     if (value->IsObject()) {
-        std::unique_ptr<JSONObject> jsonObject = JSONObject::create();
+        RefPtr<JSONObject> jsonObject = JSONObject::create();
         v8::Local<v8::Object> object = v8::Local<v8::Object>::Cast(value);
         v8::Local<v8::Array> propertyNames;
         if (!object->GetPropertyNames(context).ToLocal(&propertyNames))
@@ -76,12 +76,12 @@ std::unique_ptr<JSONValue> toJSONValue(v8::Local<v8::Context> context, v8::Local
             v8::Local<v8::Value> property;
             if (!object->Get(context, name).ToLocal(&property))
                 return nullptr;
-            std::unique_ptr<JSONValue> propertyValue = toJSONValue(context, property, maxDepth);
+            RefPtr<JSONValue> propertyValue = toJSONValue(context, property, maxDepth);
             if (!propertyValue)
                 return nullptr;
-            jsonObject->setValue(coreString(propertyName), std::move(propertyValue));
+            jsonObject->setValue(coreString(propertyName), propertyValue);
         }
-        return std::move(jsonObject);
+        return jsonObject;
     }
     ASSERT_NOT_REACHED();
     return nullptr;
diff --git a/third_party/WebKit/Source/bindings/core/v8/JSONValuesForV8.h b/third_party/WebKit/Source/bindings/core/v8/JSONValuesForV8.h
index 8d04ed1..ade66a1 100644
--- a/third_party/WebKit/Source/bindings/core/v8/JSONValuesForV8.h
+++ b/third_party/WebKit/Source/bindings/core/v8/JSONValuesForV8.h
@@ -15,7 +15,7 @@ namespace blink {
 class ExceptionState;
 class ScriptState;
 
-CORE_EXPORT std::unique_ptr<JSONValue> toJSONValue(v8::Local<v8::Context>, v8::Local<v8::Value>, int maxDepth = JSONValue::maxDepth);
+CORE_EXPORT PassRefPtr<JSONValue> toJSONValue(v8::Local<v8::Context>, v8::Local<v8::Value>, int maxDepth = JSONValue::maxDepth);
 
 CORE_EXPORT v8::Local<v8::Value> fromJSONString(ScriptState*, const String& stringifiedJSON, ExceptionState&);
 
diff --git a/third_party/WebKit/Source/bindings/core/v8/V8DOMWrapper.h b/third_party/WebKit/Source/bindings/core/v8/V8DOMWrapper.h
index dd803b1..66e4316 100644
--- a/third_party/WebKit/Source/bindings/core/v8/V8DOMWrapper.h
+++ b/third_party/WebKit/Source/bindings/core/v8/V8DOMWrapper.h
@@ -70,9 +70,8 @@ inline void V8DOMWrapper::setNativeInfo(v8::Isolate* isolate, v8::Local<v8::Obje
     ASSERT(wrapper->InternalFieldCount() >= 2);
     ASSERT(scriptWrappable);
     ASSERT(wrapperTypeInfo);
-    int indices[] = { v8DOMWrapperObjectIndex, v8DOMWrapperTypeIndex };
-    void* values[] = { scriptWrappable, const_cast<WrapperTypeInfo*>(wrapperTypeInfo) };
-    wrapper->SetAlignedPointerInInternalFields(WTF_ARRAY_LENGTH(indices), indices, values);
+    wrapper->SetAlignedPointerInInternalField(v8DOMWrapperObjectIndex, scriptWrappable);
+    wrapper->SetAlignedPointerInInternalField(v8DOMWrapperTypeIndex, const_cast<WrapperTypeInfo*>(wrapperTypeInfo));
     if (RuntimeEnabledFeatures::traceWrappablesEnabled()) {
         auto perIsolateData = V8PerIsolateData::from(isolate);
         // We notify ScriptWrappableVisitor about the new wrapper association,
diff --git a/third_party/WebKit/Source/bindings/scripts/code_generator_v8.py b/third_party/WebKit/Source/bindings/scripts/code_generator_v8.py
index 5104eeb..aed7e83 100644
--- a/third_party/WebKit/Source/bindings/scripts/code_generator_v8.py
+++ b/third_party/WebKit/Source/bindings/scripts/code_generator_v8.py
@@ -427,7 +427,6 @@ def initialize_jinja_env(cache_dir):
         'blink_capitalize': capitalize,
         'exposed': exposed_if,
         'for_origin_trial_feature': for_origin_trial_feature,
-        'secure_context': secure_context_if,
         'runtime_enabled': runtime_enabled_if,
         'unique_by': unique_by,
         })
@@ -452,13 +451,6 @@ def exposed_if(code, exposed_test):
     return generate_indented_conditional(code, 'executionContext && (%s)' % exposed_test)
 
 
-# [SecureContext]
-def secure_context_if(code, secure_context_test):
-    if not secure_context_test:
-        return code
-    return generate_indented_conditional(code, 'executionContext && (%s)' % secure_context_test)
-
-
 # [RuntimeEnabled]
 def runtime_enabled_if(code, runtime_enabled_function_name):
     if not runtime_enabled_function_name:
diff --git a/third_party/WebKit/Source/bindings/scripts/interface_dependency_resolver.py b/third_party/WebKit/Source/bindings/scripts/interface_dependency_resolver.py
index 5a032ed..c728e72 100644
--- a/third_party/WebKit/Source/bindings/scripts/interface_dependency_resolver.py
+++ b/third_party/WebKit/Source/bindings/scripts/interface_dependency_resolver.py
@@ -47,7 +47,6 @@ from utilities import idl_filename_to_component, is_valid_component_dependency,
 DEPENDENCY_EXTENDED_ATTRIBUTES = frozenset([
     'OriginTrialEnabled',
     'RuntimeEnabled',
-    'SecureContext',
 ])
 
 
@@ -264,10 +263,11 @@ def transfer_extended_attributes(dependency_interface, dependency_interface_base
     """
     merged_extended_attributes = {}
     for key in DEPENDENCY_EXTENDED_ATTRIBUTES:
-        if key not in dependency_interface.extended_attributes:
+        value = dependency_interface.extended_attributes.get(key)
+        if not value:
             continue
 
-        merged_extended_attributes[key] = dependency_interface.extended_attributes[key]
+        merged_extended_attributes[key] = value
         # Remove the merged attributes from the original dependency interface.
         # This ensures that if other dependency interfaces are merged onto this
         # one, its extended_attributes do not leak through
diff --git a/third_party/WebKit/Source/bindings/scripts/v8_attributes.py b/third_party/WebKit/Source/bindings/scripts/v8_attributes.py
index 4e48f68..7e86b2b 100644
--- a/third_party/WebKit/Source/bindings/scripts/v8_attributes.py
+++ b/third_party/WebKit/Source/bindings/scripts/v8_attributes.py
@@ -168,7 +168,6 @@ def attribute_context(interface, attribute):
         'reflect_only': extended_attribute_value_as_list(attribute, 'ReflectOnly'),
         'runtime_enabled_function': v8_utilities.runtime_enabled_function_name(attribute),  # [RuntimeEnabled]
         'runtime_feature_name': v8_utilities.runtime_feature_name(attribute),  # [RuntimeEnabled]
-        'secure_context_test': v8_utilities.secure_context(attribute, interface),  # [SecureContext]
         'should_be_exposed_to_script': not (is_implemented_in_private_script and is_only_exposed_to_private_script),
         'world_suffixes': (
             ['', 'ForMainWorld']
@@ -189,7 +188,6 @@ def attribute_context(interface, attribute):
 def filter_has_accessor_configuration(attributes):
     return [attribute for attribute in attributes if
             not (attribute['exposed_test'] or
-                 attribute['secure_context_test'] or
                  attribute['origin_trial_enabled_function'] or
                  attribute['runtime_enabled_function']) and
             not attribute['is_data_type_property'] and
@@ -199,7 +197,6 @@ def filter_has_accessor_configuration(attributes):
 def filter_has_attribute_configuration(attributes):
     return [attribute for attribute in attributes if
             not (attribute['exposed_test'] or
-                 attribute['secure_context_test'] or
                  attribute['origin_trial_enabled_function'] or
                  attribute['runtime_enabled_function']) and
             attribute['is_data_type_property'] and
@@ -212,18 +209,17 @@ def filter_origin_trial_enabled(attributes):
             not attribute['exposed_test']]
 
 
-def filter_purely_runtime_enabled(attributes):
+def filter_runtime_enabled(attributes):
     return [attribute for attribute in attributes if
-            not (attribute['exposed_test'] or
-                 attribute['secure_context_test']) and
-            attribute['runtime_feature_name']]
+            attribute['runtime_feature_name'] and
+            not attribute['exposed_test']]
 
 
 def attribute_filters():
     return {'has_accessor_configuration': filter_has_accessor_configuration,
             'has_attribute_configuration': filter_has_attribute_configuration,
             'origin_trial_enabled_attributes': filter_origin_trial_enabled,
-            'purely_runtime_enabled_attributes': filter_purely_runtime_enabled}
+            'runtime_enabled_attributes': filter_runtime_enabled}
 
 
 ################################################################################
diff --git a/third_party/WebKit/Source/bindings/scripts/v8_interface.py b/third_party/WebKit/Source/bindings/scripts/v8_interface.py
index 6554ffe..269ea81 100644
--- a/third_party/WebKit/Source/bindings/scripts/v8_interface.py
+++ b/third_party/WebKit/Source/bindings/scripts/v8_interface.py
@@ -558,10 +558,10 @@ def interface_context(interface):
 
     # Conditionally enabled members
     has_conditional_attributes_on_instance = any(
-        (attribute['exposed_test'] or attribute['secure_context_test']) and attribute['on_instance']
+        attribute['exposed_test'] and attribute['on_instance']
         for attribute in attributes)
     has_conditional_attributes_on_prototype = any(
-        (attribute['exposed_test'] or attribute['secure_context_test']) and attribute['on_prototype']
+        attribute['exposed_test'] and attribute['on_prototype']
         for attribute in attributes)
     context.update({
         'has_conditional_attributes_on_instance':
@@ -789,7 +789,6 @@ def overloads_context(interface, overloads):
         'runtime_determined_lengths': runtime_determined_lengths,
         'runtime_determined_maxargs': runtime_determined_maxargs,
         'runtime_enabled_function_all': common_value(overloads, 'runtime_enabled_function'),  # [RuntimeEnabled]
-        'secure_context_test_all': common_value(overloads, 'secure_context_test'),  # [SecureContext]
         'valid_arities': (lengths
                           # Only need to report valid arities if there is a gap in the
                           # sequence of possible lengths, otherwise invalid length means
diff --git a/third_party/WebKit/Source/bindings/scripts/v8_methods.py b/third_party/WebKit/Source/bindings/scripts/v8_methods.py
index ee4ba67..002860c 100644
--- a/third_party/WebKit/Source/bindings/scripts/v8_methods.py
+++ b/third_party/WebKit/Source/bindings/scripts/v8_methods.py
@@ -57,9 +57,7 @@ def method_is_visible(method, interface_is_partial):
 
 
 def conditionally_exposed(method):
-    exposed = method['overloads']['exposed_test_all'] if 'overloads' in method else method['exposed_test']
-    secure_context = method['overloads']['secure_context_test_all'] if 'overloads' in method else method['secure_context_test']
-    return exposed or secure_context
+    return method['overloads']['exposed_test_all'] if 'overloads' in method else method['exposed_test']
 
 
 def filter_conditionally_exposed(methods, interface_is_partial):
@@ -254,7 +252,6 @@ def method_context(interface, method, is_visible=True):
         'property_attributes': property_attributes(interface, method),
         'returns_promise': method.returns_promise,
         'runtime_enabled_function': v8_utilities.runtime_enabled_function_name(method),  # [RuntimeEnabled]
-        'secure_context_test': v8_utilities.secure_context(method, interface),  # [SecureContext]
         'should_be_exposed_to_script': not (is_implemented_in_private_script and is_only_exposed_to_private_script),
         'use_output_parameter_for_result': idl_type.use_output_parameter_for_result,
         'use_local_result': use_local_result(method),
diff --git a/third_party/WebKit/Source/bindings/scripts/v8_utilities.py b/third_party/WebKit/Source/bindings/scripts/v8_utilities.py
index 9c82da6..8a645b3 100644
--- a/third_party/WebKit/Source/bindings/scripts/v8_utilities.py
+++ b/third_party/WebKit/Source/bindings/scripts/v8_utilities.py
@@ -342,15 +342,6 @@ def exposed(member, interface):
     return exposure_set.code()
 
 
-# [SecureContext]
-def secure_context(member, interface):
-    """Returns C++ code that checks whether an interface/method/attribute/etc. is exposed
-    to the current context."""
-    if 'SecureContext' in member.extended_attributes or 'SecureContext' in interface.extended_attributes:
-        return "executionContext->isSecureContext()"
-    return None
-
-
 # [ImplementedAs]
 def cpp_name(definition_or_member):
     extended_attributes = definition_or_member.extended_attributes
diff --git a/third_party/WebKit/Source/bindings/templates/interface.cpp b/third_party/WebKit/Source/bindings/templates/interface.cpp
index 4b6adc4..32c4425 100644
--- a/third_party/WebKit/Source/bindings/templates/interface.cpp
+++ b/third_party/WebKit/Source/bindings/templates/interface.cpp
@@ -911,15 +911,11 @@ prototypeObject->CreateDataProperty(context, unscopablesSymbol, unscopeables).Fr
 {% from 'attributes.cpp' import attribute_configuration with context %}
 ExecutionContext* executionContext = toExecutionContext(context);
 v8::Local<v8::Signature> signature = v8::Signature::New(isolate, interfaceTemplate);
-{% for attribute in attributes if (attribute.exposed_test or attribute.secure_context_test) and attribute.on_prototype %}
+{% for attribute in attributes if attribute.exposed_test and attribute.on_prototype %}
 {% filter exposed(attribute.exposed_test) %}
-{% filter secure_context(attribute.secure_context_test) %}
-{% filter runtime_enabled(attribute.runtime_enabled_function) %}
 const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {{attribute_configuration(attribute)}};
 V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-{% endfilter %}{# runtime_enabled #}
-{% endfilter %}{# secure_context #}
-{% endfilter %}{# exposed #}
+{% endfilter %}
 {% endfor %}
 {% endmacro %}
 
diff --git a/third_party/WebKit/Source/bindings/templates/interface_base.cpp b/third_party/WebKit/Source/bindings/templates/interface_base.cpp
index 1ea037f..61f832f 100644
--- a/third_party/WebKit/Source/bindings/templates/interface_base.cpp
+++ b/third_party/WebKit/Source/bindings/templates/interface_base.cpp
@@ -297,7 +297,7 @@ static void install{{v8_class}}Template(v8::Isolate* isolate, const DOMWrapperWo
     prototypeTemplate->SetIntrinsicDataProperty(v8::Symbol::GetIterator(isolate), v8::kArrayProto_values, v8::DontEnum);
     {% endif %}
 
-    {%- for group in attributes | purely_runtime_enabled_attributes | groupby('runtime_feature_name') %}{{newline}}
+    {%- for group in attributes | runtime_enabled_attributes | groupby('runtime_feature_name') %}{{newline}}
     if ({{group.list[0].runtime_enabled_function}}()) {
         {% for attribute in group.list | unique_by('name') | sort %}
         {% if attribute.is_data_type_property %}
diff --git a/third_party/WebKit/Source/bindings/templates/methods.cpp b/third_party/WebKit/Source/bindings/templates/methods.cpp
index fb7c401..c3805dc 100644
--- a/third_party/WebKit/Source/bindings/templates/methods.cpp
+++ b/third_party/WebKit/Source/bindings/templates/methods.cpp
@@ -687,9 +687,6 @@ v8::Local<v8::Signature> signature = v8::Signature::New(isolate, interfaceTempla
 ExecutionContext* executionContext = toExecutionContext(prototypeObject->CreationContext());
 ASSERT(executionContext);
 {% for method in methods | conditionally_exposed(is_partial) %}
-{% filter secure_context(method.overloads.secure_context_test_all
-                         if method.overloads else
-                         method.secure_context_test) %}
 {% filter exposed(method.overloads.exposed_test_all
                   if method.overloads else
                   method.exposed_test) %}
@@ -700,7 +697,6 @@ const V8DOMConfiguration::MethodConfiguration {{method.name}}MethodConfiguration
 V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, {{method.name}}MethodConfiguration);
 {% endfilter %}{# runtime_enabled() #}
 {% endfilter %}{# exposed() #}
-{% endfilter %}{# secure_context() #}
 {% endfor %}
 {% endif %}
 {%- endmacro %}
diff --git a/third_party/WebKit/Source/bindings/tests/idls/core/TestInterface.idl b/third_party/WebKit/Source/bindings/tests/idls/core/TestInterface.idl
index 0e87b82..a5ccf53 100644
--- a/third_party/WebKit/Source/bindings/tests/idls/core/TestInterface.idl
+++ b/third_party/WebKit/Source/bindings/tests/idls/core/TestInterface.idl
@@ -116,19 +116,6 @@
     [LenientThis] attribute any lenientThisAttribute;
 
     [LegacyInterfaceTypeChecking] void legacyInterfaceTypeCheckingMethod(TestInterfaceEmpty testInterfaceEmptyArg);
-
-    [SecureContext] void secureContextMethod();
-    [SecureContext] attribute bool secureContextAttribute;
-    [SecureContext,RuntimeEnabled=SecureFeature] void secureContextRuntimeEnabledMethod();
-    [SecureContext,RuntimeEnabled=SecureFeature] attribute bool secureContextRuntimeEnabledAttribute;
-    [SecureContext,Exposed=Window] void secureContextWindowExposedMethod();
-    [SecureContext,Exposed=Window] attribute bool secureContextWindowExposedAttribute;
-    [SecureContext,Exposed=Worker] void secureContextWorkerExposedMethod();
-    [SecureContext,Exposed=Worker] attribute bool secureContextWorkerExposedAttribute;
-    [SecureContext,Exposed=Window,RuntimeEnabled=SecureFeature] void secureContextWindowExposedRuntimeEnabledMethod();
-    [SecureContext,Exposed=Window,RuntimeEnabled=SecureFeature] attribute bool secureContextWindowExposedRuntimeEnabledAttribute;
-    [SecureContext,Exposed=Worker,RuntimeEnabled=SecureFeature] void secureContextWorkerExposedRuntimeEnabledMethod();
-    [SecureContext,Exposed=Worker,RuntimeEnabled=SecureFeature] attribute bool secureContextWorkerExposedRuntimeEnabledAttribute;
 };
 
 TestInterface implements TestImplements;
diff --git a/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfacePartial2.idl b/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfacePartial2.idl
index ca625c6..eab27e0 100644
--- a/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfacePartial2.idl
+++ b/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfacePartial2.idl
@@ -38,7 +38,4 @@
 
     void partial2VoidMethod();
     static void partial2StaticVoidMethod();
-
-    [SecureContext] void partial2SecureContextMethod();
-    [SecureContext] attribute bool partial2SecureContextAttribute;
 };
diff --git a/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfacePartialSecureContext.idl b/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfacePartialSecureContext.idl
deleted file mode 100644
index ed17e59..0000000
--- a/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfacePartialSecureContext.idl
+++ /dev/null
@@ -1,22 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-[
-    SecureContext,
-    Exposed=(Window,Worker),
-    ImplementedAs=TestInterfacePartialSecureContext, // Conflicts with default partial interface class name
-] partial interface TestInterface {
-    void partialSecureContextMethod();
-    attribute bool partialSecureContextAttribute;
-    [RuntimeEnabled=SecureFeature] void partialSecureContextRuntimeEnabledMethod();
-    [RuntimeEnabled=SecureFeature] attribute bool partialSecureContextRuntimeEnabledAttribute;
-    [Exposed=Window] void partialSecureContextWindowExposedMethod();
-    [Exposed=Window] attribute bool partialSecureContextWindowExposedAttribute;
-    [Exposed=Worker] void partialSecureContextWorkerExposedMethod();
-    [Exposed=Worker] attribute bool partialSecureContextWorkerExposedAttribute;
-    [Exposed=Window,RuntimeEnabled=SecureFeature] void partialSecureContextWindowExposedRuntimeEnabledMethod();
-    [Exposed=Window,RuntimeEnabled=SecureFeature] attribute bool partialSecureContextWindowExposedRuntimeEnabledAttribute;
-    [Exposed=Worker,RuntimeEnabled=SecureFeature] void partialSecureContextWorkerExposedRuntimeEnabledMethod();
-    [Exposed=Worker,RuntimeEnabled=SecureFeature] attribute bool partialSecureContextWorkerExposedRuntimeEnabledAttribute;
-};
diff --git a/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfaceSecureContext.idl b/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfaceSecureContext.idl
deleted file mode 100644
index e43c2b2..0000000
--- a/third_party/WebKit/Source/bindings/tests/idls/core/TestInterfaceSecureContext.idl
+++ /dev/null
@@ -1,21 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-[
-    SecureContext,
-    Exposed=(Window,Worker)
-] interface TestInterfaceSecureContext {
-    void secureContextMethod();
-    attribute bool secureContextAttribute;
-    [RuntimeEnabled=SecureFeature] void secureContextRuntimeEnabledMethod();
-    [RuntimeEnabled=SecureFeature] attribute bool secureContextRuntimeEnabledAttribute;
-    [Exposed=Window] void secureContextWindowExposedMethod();
-    [Exposed=Window] attribute bool secureContextWindowExposedAttribute;
-    [Exposed=Worker] void secureContextWorkerExposedMethod();
-    [Exposed=Worker] attribute bool secureContextWorkerExposedAttribute;
-    [Exposed=Window,RuntimeEnabled=SecureFeature] void secureContextWindowExposedRuntimeEnabledMethod();
-    [Exposed=Window,RuntimeEnabled=SecureFeature] attribute bool secureContextWindowExposedRuntimeEnabledAttribute;
-    [Exposed=Worker,RuntimeEnabled=SecureFeature] void secureContextWorkerExposedRuntimeEnabledMethod();
-    [Exposed=Worker,RuntimeEnabled=SecureFeature] attribute bool secureContextWorkerExposedRuntimeEnabledAttribute;
-};
diff --git a/third_party/WebKit/Source/bindings/tests/results/core/TestInterfaceOrLong.cpp b/third_party/WebKit/Source/bindings/tests/results/core/TestInterfaceOrLong.cpp
index f1e4042..0e93c7b 100644
--- a/third_party/WebKit/Source/bindings/tests/results/core/TestInterfaceOrLong.cpp
+++ b/third_party/WebKit/Source/bindings/tests/results/core/TestInterfaceOrLong.cpp
@@ -12,7 +12,6 @@
 #include "bindings/tests/idls/core/TestImplements3Implementation.h"
 #include "bindings/tests/idls/core/TestInterfacePartial.h"
 #include "bindings/tests/idls/core/TestInterfacePartial2Implementation.h"
-#include "bindings/tests/idls/core/TestInterfacePartialSecureContext.h"
 
 namespace blink {
 
diff --git a/third_party/WebKit/Source/bindings/tests/results/core/TestInterfaceOrTestInterfaceEmpty.cpp b/third_party/WebKit/Source/bindings/tests/results/core/TestInterfaceOrTestInterfaceEmpty.cpp
index 6a4e9a7..0d4185c 100644
--- a/third_party/WebKit/Source/bindings/tests/results/core/TestInterfaceOrTestInterfaceEmpty.cpp
+++ b/third_party/WebKit/Source/bindings/tests/results/core/TestInterfaceOrTestInterfaceEmpty.cpp
@@ -13,7 +13,6 @@
 #include "bindings/tests/idls/core/TestImplements3Implementation.h"
 #include "bindings/tests/idls/core/TestInterfacePartial.h"
 #include "bindings/tests/idls/core/TestInterfacePartial2Implementation.h"
-#include "bindings/tests/idls/core/TestInterfacePartialSecureContext.h"
 
 namespace blink {
 
diff --git a/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterface.cpp b/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterface.cpp
index 6399081..1639a4e 100644
--- a/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterface.cpp
+++ b/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterface.cpp
@@ -26,7 +26,6 @@
 #include "bindings/tests/idls/core/TestImplements3Implementation.h"
 #include "bindings/tests/idls/core/TestInterfacePartial.h"
 #include "bindings/tests/idls/core/TestInterfacePartial2Implementation.h"
-#include "bindings/tests/idls/core/TestInterfacePartialSecureContext.h"
 #include "core/dom/Document.h"
 #include "core/frame/LocalFrame.h"
 #include "core/frame/UseCounter.h"
@@ -557,198 +556,6 @@ static void lenientThisAttributeAttributeSetterCallback(const v8::FunctionCallba
     TestInterfaceImplementationV8Internal::lenientThisAttributeAttributeSetter(v8Value, info);
 }
 
-static void secureContextAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextAttribute()), impl);
-}
-
-static void secureContextAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextAttributeAttributeGetter(info);
-}
-
-static void secureContextAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextAttribute(cppValue);
-}
-
-static void secureContextAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::secureContextAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextRuntimeEnabledAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextRuntimeEnabledAttribute()), impl);
-}
-
-static void secureContextRuntimeEnabledAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextRuntimeEnabledAttributeAttributeGetter(info);
-}
-
-static void secureContextRuntimeEnabledAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextRuntimeEnabledAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextRuntimeEnabledAttribute(cppValue);
-}
-
-static void secureContextRuntimeEnabledAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::secureContextRuntimeEnabledAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextWindowExposedAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextWindowExposedAttribute()), impl);
-}
-
-static void secureContextWindowExposedAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextWindowExposedAttributeAttributeGetter(info);
-}
-
-static void secureContextWindowExposedAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextWindowExposedAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextWindowExposedAttribute(cppValue);
-}
-
-static void secureContextWindowExposedAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::secureContextWindowExposedAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextWorkerExposedAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextWorkerExposedAttribute()), impl);
-}
-
-static void secureContextWorkerExposedAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextWorkerExposedAttributeAttributeGetter(info);
-}
-
-static void secureContextWorkerExposedAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextWorkerExposedAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextWorkerExposedAttribute(cppValue);
-}
-
-static void secureContextWorkerExposedAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::secureContextWorkerExposedAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextWindowExposedRuntimeEnabledAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextWindowExposedRuntimeEnabledAttribute()), impl);
-}
-
-static void secureContextWindowExposedRuntimeEnabledAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextWindowExposedRuntimeEnabledAttributeAttributeGetter(info);
-}
-
-static void secureContextWindowExposedRuntimeEnabledAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextWindowExposedRuntimeEnabledAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextWindowExposedRuntimeEnabledAttribute(cppValue);
-}
-
-static void secureContextWindowExposedRuntimeEnabledAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::secureContextWindowExposedRuntimeEnabledAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextWorkerExposedRuntimeEnabledAttribute()), impl);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextWorkerExposedRuntimeEnabledAttributeAttributeGetter(info);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextWorkerExposedRuntimeEnabledAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextWorkerExposedRuntimeEnabledAttribute(cppValue);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::secureContextWorkerExposedRuntimeEnabledAttributeAttributeSetter(v8Value, info);
-}
-
 static void implementsStaticReadOnlyLongAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
 {
     v8SetReturnValueInt(info, TestInterfaceImplementation::implementsStaticReadOnlyLongAttribute());
@@ -1227,230 +1034,6 @@ static void partial2StaticLongAttributeAttributeSetterCallback(const v8::Functio
     TestInterfaceImplementationV8Internal::partial2StaticLongAttributeAttributeSetter(v8Value, info);
 }
 
-static void partial2SecureContextAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, TestInterfacePartial2Implementation::partial2SecureContextAttribute(*impl), impl);
-}
-
-static void partial2SecureContextAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partial2SecureContextAttributeAttributeGetter(info);
-}
-
-static void partial2SecureContextAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "partial2SecureContextAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    TestInterfacePartial2Implementation::setPartial2SecureContextAttribute(*impl, cppValue);
-}
-
-static void partial2SecureContextAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::partial2SecureContextAttributeAttributeSetter(v8Value, info);
-}
-
-static void partialSecureContextAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, TestInterfacePartialSecureContext::partialSecureContextAttribute(*impl), impl);
-}
-
-static void partialSecureContextAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextAttributeAttributeGetter(info);
-}
-
-static void partialSecureContextAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "partialSecureContextAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    TestInterfacePartialSecureContext::setPartialSecureContextAttribute(*impl, cppValue);
-}
-
-static void partialSecureContextAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::partialSecureContextAttributeAttributeSetter(v8Value, info);
-}
-
-static void partialSecureContextRuntimeEnabledAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, TestInterfacePartialSecureContext::partialSecureContextRuntimeEnabledAttribute(*impl), impl);
-}
-
-static void partialSecureContextRuntimeEnabledAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextRuntimeEnabledAttributeAttributeGetter(info);
-}
-
-static void partialSecureContextRuntimeEnabledAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "partialSecureContextRuntimeEnabledAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    TestInterfacePartialSecureContext::setPartialSecureContextRuntimeEnabledAttribute(*impl, cppValue);
-}
-
-static void partialSecureContextRuntimeEnabledAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::partialSecureContextRuntimeEnabledAttributeAttributeSetter(v8Value, info);
-}
-
-static void partialSecureContextWindowExposedAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, TestInterfacePartialSecureContext::partialSecureContextWindowExposedAttribute(*impl), impl);
-}
-
-static void partialSecureContextWindowExposedAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedAttributeAttributeGetter(info);
-}
-
-static void partialSecureContextWindowExposedAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "partialSecureContextWindowExposedAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    TestInterfacePartialSecureContext::setPartialSecureContextWindowExposedAttribute(*impl, cppValue);
-}
-
-static void partialSecureContextWindowExposedAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedAttributeAttributeSetter(v8Value, info);
-}
-
-static void partialSecureContextWorkerExposedAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, TestInterfacePartialSecureContext::partialSecureContextWorkerExposedAttribute(*impl), impl);
-}
-
-static void partialSecureContextWorkerExposedAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedAttributeAttributeGetter(info);
-}
-
-static void partialSecureContextWorkerExposedAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "partialSecureContextWorkerExposedAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    TestInterfacePartialSecureContext::setPartialSecureContextWorkerExposedAttribute(*impl, cppValue);
-}
-
-static void partialSecureContextWorkerExposedAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedAttributeAttributeSetter(v8Value, info);
-}
-
-static void partialSecureContextWindowExposedRuntimeEnabledAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, TestInterfacePartialSecureContext::partialSecureContextWindowExposedRuntimeEnabledAttribute(*impl), impl);
-}
-
-static void partialSecureContextWindowExposedRuntimeEnabledAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedRuntimeEnabledAttributeAttributeGetter(info);
-}
-
-static void partialSecureContextWindowExposedRuntimeEnabledAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "partialSecureContextWindowExposedRuntimeEnabledAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    TestInterfacePartialSecureContext::setPartialSecureContextWindowExposedRuntimeEnabledAttribute(*impl, cppValue);
-}
-
-static void partialSecureContextWindowExposedRuntimeEnabledAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedRuntimeEnabledAttributeAttributeSetter(v8Value, info);
-}
-
-static void partialSecureContextWorkerExposedRuntimeEnabledAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    v8SetReturnValueFast(info, TestInterfacePartialSecureContext::partialSecureContextWorkerExposedRuntimeEnabledAttribute(*impl), impl);
-}
-
-static void partialSecureContextWorkerExposedRuntimeEnabledAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedRuntimeEnabledAttributeAttributeGetter(info);
-}
-
-static void partialSecureContextWorkerExposedRuntimeEnabledAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "partialSecureContextWorkerExposedRuntimeEnabledAttribute", "TestInterface", holder, info.GetIsolate());
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    TestInterfacePartialSecureContext::setPartialSecureContextWorkerExposedRuntimeEnabledAttribute(*impl, cppValue);
-}
-
-static void partialSecureContextWorkerExposedRuntimeEnabledAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedRuntimeEnabledAttributeAttributeSetter(v8Value, info);
-}
-
 static void voidMethodTestInterfaceEmptyArgMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
 {
     if (UNLIKELY(info.Length() < 1)) {
@@ -1840,72 +1423,6 @@ static void legacyInterfaceTypeCheckingMethodMethodCallback(const v8::FunctionCa
     TestInterfaceImplementationV8Internal::legacyInterfaceTypeCheckingMethodMethod(info);
 }
 
-static void secureContextMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    impl->secureContextMethod();
-}
-
-static void secureContextMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextMethodMethod(info);
-}
-
-static void secureContextRuntimeEnabledMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    impl->secureContextRuntimeEnabledMethod();
-}
-
-static void secureContextRuntimeEnabledMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextRuntimeEnabledMethodMethod(info);
-}
-
-static void secureContextWindowExposedMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    impl->secureContextWindowExposedMethod();
-}
-
-static void secureContextWindowExposedMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextWindowExposedMethodMethod(info);
-}
-
-static void secureContextWorkerExposedMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    impl->secureContextWorkerExposedMethod();
-}
-
-static void secureContextWorkerExposedMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextWorkerExposedMethodMethod(info);
-}
-
-static void secureContextWindowExposedRuntimeEnabledMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    impl->secureContextWindowExposedRuntimeEnabledMethod();
-}
-
-static void secureContextWindowExposedRuntimeEnabledMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextWindowExposedRuntimeEnabledMethodMethod(info);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    impl->secureContextWorkerExposedRuntimeEnabledMethod();
-}
-
-static void secureContextWorkerExposedRuntimeEnabledMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::secureContextWorkerExposedRuntimeEnabledMethodMethod(info);
-}
-
 static void implementsVoidMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
 {
     TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
@@ -2121,83 +1638,6 @@ static void partial2StaticVoidMethod1Method(const v8::FunctionCallbackInfo<v8::V
     TestInterfacePartial2Implementation::partial2StaticVoidMethod();
 }
 
-static void partial2SecureContextMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    TestInterfacePartial2Implementation::partial2SecureContextMethod(*impl);
-}
-
-static void partial2SecureContextMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partial2SecureContextMethodMethod(info);
-}
-
-static void partialSecureContextMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    TestInterfacePartialSecureContext::partialSecureContextMethod(*impl);
-}
-
-static void partialSecureContextMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextMethodMethod(info);
-}
-
-static void partialSecureContextRuntimeEnabledMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    TestInterfacePartialSecureContext::partialSecureContextRuntimeEnabledMethod(*impl);
-}
-
-static void partialSecureContextRuntimeEnabledMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextRuntimeEnabledMethodMethod(info);
-}
-
-static void partialSecureContextWindowExposedMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    TestInterfacePartialSecureContext::partialSecureContextWindowExposedMethod(*impl);
-}
-
-static void partialSecureContextWindowExposedMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedMethodMethod(info);
-}
-
-static void partialSecureContextWorkerExposedMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    TestInterfacePartialSecureContext::partialSecureContextWorkerExposedMethod(*impl);
-}
-
-static void partialSecureContextWorkerExposedMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedMethodMethod(info);
-}
-
-static void partialSecureContextWindowExposedRuntimeEnabledMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    TestInterfacePartialSecureContext::partialSecureContextWindowExposedRuntimeEnabledMethod(*impl);
-}
-
-static void partialSecureContextWindowExposedRuntimeEnabledMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedRuntimeEnabledMethodMethod(info);
-}
-
-static void partialSecureContextWorkerExposedRuntimeEnabledMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementation* impl = V8TestInterface::toImpl(info.Holder());
-    TestInterfacePartialSecureContext::partialSecureContextWorkerExposedRuntimeEnabledMethod(*impl);
-}
-
-static void partialSecureContextWorkerExposedRuntimeEnabledMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedRuntimeEnabledMethodMethod(info);
-}
-
 static void voidMethodPartialOverloadMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
 {
     ExceptionState exceptionState(ExceptionState::ExecutionContext, "voidMethodPartialOverload", "TestInterface", info.Holder(), info.GetIsolate());
@@ -2764,86 +2204,6 @@ void V8TestInterface::preparePrototypeAndInterfaceObject(v8::Local<v8::Context>
         const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"windowExposedAttribute", TestInterfaceImplementationV8Internal::windowExposedAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::windowExposedAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
         V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
     }
-    if (executionContext && (executionContext->isSecureContext())) {
-        const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextAttribute", TestInterfaceImplementationV8Internal::secureContextAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::secureContextAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-        V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-            const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextRuntimeEnabledAttribute", TestInterfaceImplementationV8Internal::secureContextRuntimeEnabledAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::secureContextRuntimeEnabledAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-            V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isDocument())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextWindowExposedAttribute", TestInterfaceImplementationV8Internal::secureContextWindowExposedAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::secureContextWindowExposedAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-            V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isWorkerGlobalScope())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextWorkerExposedAttribute", TestInterfaceImplementationV8Internal::secureContextWorkerExposedAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::secureContextWorkerExposedAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-            V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isDocument())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextWindowExposedRuntimeEnabledAttribute", TestInterfaceImplementationV8Internal::secureContextWindowExposedRuntimeEnabledAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::secureContextWindowExposedRuntimeEnabledAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-                V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-            }
-        }
-    }
-    if (executionContext && (executionContext->isWorkerGlobalScope())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextWorkerExposedRuntimeEnabledAttribute", TestInterfaceImplementationV8Internal::secureContextWorkerExposedRuntimeEnabledAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::secureContextWorkerExposedRuntimeEnabledAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-                V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-            }
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"partial2SecureContextAttribute", TestInterfaceImplementationV8Internal::partial2SecureContextAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::partial2SecureContextAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-        V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"partialSecureContextAttribute", TestInterfaceImplementationV8Internal::partialSecureContextAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::partialSecureContextAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-        V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-            const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"partialSecureContextRuntimeEnabledAttribute", TestInterfaceImplementationV8Internal::partialSecureContextRuntimeEnabledAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::partialSecureContextRuntimeEnabledAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-            V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isDocument())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"partialSecureContextWindowExposedAttribute", TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-            V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isWorkerGlobalScope())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"partialSecureContextWorkerExposedAttribute", TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-            V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isDocument())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"partialSecureContextWindowExposedRuntimeEnabledAttribute", TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedRuntimeEnabledAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedRuntimeEnabledAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-                V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-            }
-        }
-    }
-    if (executionContext && (executionContext->isWorkerGlobalScope())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"partialSecureContextWorkerExposedRuntimeEnabledAttribute", TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedRuntimeEnabledAttributeAttributeGetterCallback, TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedRuntimeEnabledAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-                V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-            }
-        }
-    }
     v8::Local<v8::Signature> signature = v8::Signature::New(isolate, interfaceTemplate);
     ExecutionContext* executionContext = toExecutionContext(prototypeObject->CreationContext());
     ASSERT(executionContext);
@@ -2881,86 +2241,6 @@ void V8TestInterface::preparePrototypeAndInterfaceObject(v8::Local<v8::Context>
         const V8DOMConfiguration::MethodConfiguration windowAndServiceWorkerExposedMethodMethodConfiguration = {"windowAndServiceWorkerExposedMethod", TestInterfaceImplementationV8Internal::windowAndServiceWorkerExposedMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
         V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, windowAndServiceWorkerExposedMethodMethodConfiguration);
     }
-    if (executionContext && (executionContext->isSecureContext())) {
-        const V8DOMConfiguration::MethodConfiguration secureContextMethodMethodConfiguration = {"secureContextMethod", TestInterfaceImplementationV8Internal::secureContextMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-        V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextMethodMethodConfiguration);
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-            const V8DOMConfiguration::MethodConfiguration secureContextRuntimeEnabledMethodMethodConfiguration = {"secureContextRuntimeEnabledMethod", TestInterfaceImplementationV8Internal::secureContextRuntimeEnabledMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-            V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextRuntimeEnabledMethodMethodConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isDocument())) {
-            const V8DOMConfiguration::MethodConfiguration secureContextWindowExposedMethodMethodConfiguration = {"secureContextWindowExposedMethod", TestInterfaceImplementationV8Internal::secureContextWindowExposedMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-            V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextWindowExposedMethodMethodConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isWorkerGlobalScope())) {
-            const V8DOMConfiguration::MethodConfiguration secureContextWorkerExposedMethodMethodConfiguration = {"secureContextWorkerExposedMethod", TestInterfaceImplementationV8Internal::secureContextWorkerExposedMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-            V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextWorkerExposedMethodMethodConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isDocument())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::MethodConfiguration secureContextWindowExposedRuntimeEnabledMethodMethodConfiguration = {"secureContextWindowExposedRuntimeEnabledMethod", TestInterfaceImplementationV8Internal::secureContextWindowExposedRuntimeEnabledMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-                V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextWindowExposedRuntimeEnabledMethodMethodConfiguration);
-            }
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isWorkerGlobalScope())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::MethodConfiguration secureContextWorkerExposedRuntimeEnabledMethodMethodConfiguration = {"secureContextWorkerExposedRuntimeEnabledMethod", TestInterfaceImplementationV8Internal::secureContextWorkerExposedRuntimeEnabledMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-                V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextWorkerExposedRuntimeEnabledMethodMethodConfiguration);
-            }
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        const V8DOMConfiguration::MethodConfiguration partial2SecureContextMethodMethodConfiguration = {"partial2SecureContextMethod", TestInterfaceImplementationV8Internal::partial2SecureContextMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-        V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, partial2SecureContextMethodMethodConfiguration);
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        const V8DOMConfiguration::MethodConfiguration partialSecureContextMethodMethodConfiguration = {"partialSecureContextMethod", TestInterfaceImplementationV8Internal::partialSecureContextMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-        V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, partialSecureContextMethodMethodConfiguration);
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-            const V8DOMConfiguration::MethodConfiguration partialSecureContextRuntimeEnabledMethodMethodConfiguration = {"partialSecureContextRuntimeEnabledMethod", TestInterfaceImplementationV8Internal::partialSecureContextRuntimeEnabledMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-            V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, partialSecureContextRuntimeEnabledMethodMethodConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isDocument())) {
-            const V8DOMConfiguration::MethodConfiguration partialSecureContextWindowExposedMethodMethodConfiguration = {"partialSecureContextWindowExposedMethod", TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-            V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, partialSecureContextWindowExposedMethodMethodConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isWorkerGlobalScope())) {
-            const V8DOMConfiguration::MethodConfiguration partialSecureContextWorkerExposedMethodMethodConfiguration = {"partialSecureContextWorkerExposedMethod", TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-            V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, partialSecureContextWorkerExposedMethodMethodConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isDocument())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::MethodConfiguration partialSecureContextWindowExposedRuntimeEnabledMethodMethodConfiguration = {"partialSecureContextWindowExposedRuntimeEnabledMethod", TestInterfaceImplementationV8Internal::partialSecureContextWindowExposedRuntimeEnabledMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-                V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, partialSecureContextWindowExposedRuntimeEnabledMethodMethodConfiguration);
-            }
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isWorkerGlobalScope())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::MethodConfiguration partialSecureContextWorkerExposedRuntimeEnabledMethodMethodConfiguration = {"partialSecureContextWorkerExposedRuntimeEnabledMethod", TestInterfaceImplementationV8Internal::partialSecureContextWorkerExposedRuntimeEnabledMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-                V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, partialSecureContextWorkerExposedRuntimeEnabledMethodMethodConfiguration);
-            }
-        }
-    }
 }
 
 ActiveScriptWrappable* V8TestInterface::toActiveScriptWrappable(v8::Local<v8::Object> wrapper)
diff --git a/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterfaceSecureContext.cpp b/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterfaceSecureContext.cpp
deleted file mode 100644
index 358381f..0000000
--- a/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterfaceSecureContext.cpp
+++ /dev/null
@@ -1,417 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-// This file has been auto-generated by code_generator_v8.py. DO NOT MODIFY!
-
-#include "V8TestInterfaceSecureContext.h"
-
-#include "bindings/core/v8/ExceptionState.h"
-#include "bindings/core/v8/V8DOMConfiguration.h"
-#include "bindings/core/v8/V8ObjectConstructor.h"
-#include "core/dom/Document.h"
-#include "platform/RuntimeEnabledFeatures.h"
-#include "wtf/GetPtr.h"
-#include "wtf/RefPtr.h"
-
-namespace blink {
-
-// Suppress warning: global constructors, because struct WrapperTypeInfo is trivial
-// and does not depend on another global objects.
-#if defined(COMPONENT_BUILD) && defined(WIN32) && COMPILER(CLANG)
-#pragma clang diagnostic push
-#pragma clang diagnostic ignored "-Wglobal-constructors"
-#endif
-const WrapperTypeInfo V8TestInterfaceSecureContext::wrapperTypeInfo = { gin::kEmbedderBlink, V8TestInterfaceSecureContext::domTemplate, V8TestInterfaceSecureContext::trace, V8TestInterfaceSecureContext::traceWrappers, 0, 0, V8TestInterfaceSecureContext::preparePrototypeAndInterfaceObject, nullptr, "TestInterfaceSecureContext", 0, WrapperTypeInfo::WrapperTypeObjectPrototype, WrapperTypeInfo::ObjectClassId, WrapperTypeInfo::NotInheritFromEventTarget, WrapperTypeInfo::Independent };
-#if defined(COMPONENT_BUILD) && defined(WIN32) && COMPILER(CLANG)
-#pragma clang diagnostic pop
-#endif
-
-// This static member must be declared by DEFINE_WRAPPERTYPEINFO in TestInterfaceSecureContext.h.
-// For details, see the comment of DEFINE_WRAPPERTYPEINFO in
-// bindings/core/v8/ScriptWrappable.h.
-const WrapperTypeInfo& TestInterfaceSecureContext::s_wrapperTypeInfo = V8TestInterfaceSecureContext::wrapperTypeInfo;
-
-namespace TestInterfaceSecureContextV8Internal {
-
-static void secureContextAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextAttribute()), impl);
-}
-
-static void secureContextAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextAttributeAttributeGetter(info);
-}
-
-static void secureContextAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextAttribute", "TestInterfaceSecureContext", holder, info.GetIsolate());
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextAttribute(cppValue);
-}
-
-static void secureContextAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceSecureContextV8Internal::secureContextAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextRuntimeEnabledAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextRuntimeEnabledAttribute()), impl);
-}
-
-static void secureContextRuntimeEnabledAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextRuntimeEnabledAttributeAttributeGetter(info);
-}
-
-static void secureContextRuntimeEnabledAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextRuntimeEnabledAttribute", "TestInterfaceSecureContext", holder, info.GetIsolate());
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextRuntimeEnabledAttribute(cppValue);
-}
-
-static void secureContextRuntimeEnabledAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceSecureContextV8Internal::secureContextRuntimeEnabledAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextWindowExposedAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextWindowExposedAttribute()), impl);
-}
-
-static void secureContextWindowExposedAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextWindowExposedAttributeAttributeGetter(info);
-}
-
-static void secureContextWindowExposedAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextWindowExposedAttribute", "TestInterfaceSecureContext", holder, info.GetIsolate());
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextWindowExposedAttribute(cppValue);
-}
-
-static void secureContextWindowExposedAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceSecureContextV8Internal::secureContextWindowExposedAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextWorkerExposedAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextWorkerExposedAttribute()), impl);
-}
-
-static void secureContextWorkerExposedAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextWorkerExposedAttributeAttributeGetter(info);
-}
-
-static void secureContextWorkerExposedAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextWorkerExposedAttribute", "TestInterfaceSecureContext", holder, info.GetIsolate());
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextWorkerExposedAttribute(cppValue);
-}
-
-static void secureContextWorkerExposedAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceSecureContextV8Internal::secureContextWorkerExposedAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextWindowExposedRuntimeEnabledAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextWindowExposedRuntimeEnabledAttribute()), impl);
-}
-
-static void secureContextWindowExposedRuntimeEnabledAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextWindowExposedRuntimeEnabledAttributeAttributeGetter(info);
-}
-
-static void secureContextWindowExposedRuntimeEnabledAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextWindowExposedRuntimeEnabledAttribute", "TestInterfaceSecureContext", holder, info.GetIsolate());
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextWindowExposedRuntimeEnabledAttribute(cppValue);
-}
-
-static void secureContextWindowExposedRuntimeEnabledAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceSecureContextV8Internal::secureContextWindowExposedRuntimeEnabledAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledAttributeAttributeGetter(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    v8SetReturnValueFast(info, WTF::getPtr(impl->secureContextWorkerExposedRuntimeEnabledAttribute()), impl);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledAttributeAttributeGetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextWorkerExposedRuntimeEnabledAttributeAttributeGetter(info);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledAttributeAttributeSetter(v8::Local<v8::Value> v8Value, const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Object> holder = info.Holder();
-    ExceptionState exceptionState(ExceptionState::SetterContext, "secureContextWorkerExposedRuntimeEnabledAttribute", "TestInterfaceSecureContext", holder, info.GetIsolate());
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(holder);
-    bool* cppValue = V8bool::toImplWithTypeCheck(info.GetIsolate(), v8Value);
-    if (!cppValue) {
-        exceptionState.throwTypeError("The provided value is not of type 'bool'.");
-        exceptionState.throwIfNeeded();
-        return;
-    }
-    impl->setSecureContextWorkerExposedRuntimeEnabledAttribute(cppValue);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledAttributeAttributeSetterCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    v8::Local<v8::Value> v8Value = info[0];
-    TestInterfaceSecureContextV8Internal::secureContextWorkerExposedRuntimeEnabledAttributeAttributeSetter(v8Value, info);
-}
-
-static void secureContextMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(info.Holder());
-    impl->secureContextMethod();
-}
-
-static void secureContextMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextMethodMethod(info);
-}
-
-static void secureContextRuntimeEnabledMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(info.Holder());
-    impl->secureContextRuntimeEnabledMethod();
-}
-
-static void secureContextRuntimeEnabledMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextRuntimeEnabledMethodMethod(info);
-}
-
-static void secureContextWindowExposedMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(info.Holder());
-    impl->secureContextWindowExposedMethod();
-}
-
-static void secureContextWindowExposedMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextWindowExposedMethodMethod(info);
-}
-
-static void secureContextWorkerExposedMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(info.Holder());
-    impl->secureContextWorkerExposedMethod();
-}
-
-static void secureContextWorkerExposedMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextWorkerExposedMethodMethod(info);
-}
-
-static void secureContextWindowExposedRuntimeEnabledMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(info.Holder());
-    impl->secureContextWindowExposedRuntimeEnabledMethod();
-}
-
-static void secureContextWindowExposedRuntimeEnabledMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextWindowExposedRuntimeEnabledMethodMethod(info);
-}
-
-static void secureContextWorkerExposedRuntimeEnabledMethodMethod(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContext* impl = V8TestInterfaceSecureContext::toImpl(info.Holder());
-    impl->secureContextWorkerExposedRuntimeEnabledMethod();
-}
-
-static void secureContextWorkerExposedRuntimeEnabledMethodMethodCallback(const v8::FunctionCallbackInfo<v8::Value>& info)
-{
-    TestInterfaceSecureContextV8Internal::secureContextWorkerExposedRuntimeEnabledMethodMethod(info);
-}
-
-} // namespace TestInterfaceSecureContextV8Internal
-
-static void installV8TestInterfaceSecureContextTemplate(v8::Isolate* isolate, const DOMWrapperWorld& world, v8::Local<v8::FunctionTemplate> interfaceTemplate)
-{
-    // Initialize the interface object's template.
-    V8DOMConfiguration::initializeDOMInterfaceTemplate(isolate, interfaceTemplate, V8TestInterfaceSecureContext::wrapperTypeInfo.interfaceName, v8::Local<v8::FunctionTemplate>(), V8TestInterfaceSecureContext::internalFieldCount);
-    v8::Local<v8::Signature> signature = v8::Signature::New(isolate, interfaceTemplate);
-    ALLOW_UNUSED_LOCAL(signature);
-    v8::Local<v8::ObjectTemplate> instanceTemplate = interfaceTemplate->InstanceTemplate();
-    ALLOW_UNUSED_LOCAL(instanceTemplate);
-    v8::Local<v8::ObjectTemplate> prototypeTemplate = interfaceTemplate->PrototypeTemplate();
-    ALLOW_UNUSED_LOCAL(prototypeTemplate);
-    // Register DOM constants, attributes and operations.
-}
-
-v8::Local<v8::FunctionTemplate> V8TestInterfaceSecureContext::domTemplate(v8::Isolate* isolate, const DOMWrapperWorld& world)
-{
-    return V8DOMConfiguration::domClassTemplate(isolate, world, const_cast<WrapperTypeInfo*>(&wrapperTypeInfo), installV8TestInterfaceSecureContextTemplate);
-}
-
-
-bool V8TestInterfaceSecureContext::hasInstance(v8::Local<v8::Value> v8Value, v8::Isolate* isolate)
-{
-    return V8PerIsolateData::from(isolate)->hasInstance(&wrapperTypeInfo, v8Value);
-}
-
-v8::Local<v8::Object> V8TestInterfaceSecureContext::findInstanceInPrototypeChain(v8::Local<v8::Value> v8Value, v8::Isolate* isolate)
-{
-    return V8PerIsolateData::from(isolate)->findInstanceInPrototypeChain(&wrapperTypeInfo, v8Value);
-}
-
-TestInterfaceSecureContext* V8TestInterfaceSecureContext::toImplWithTypeCheck(v8::Isolate* isolate, v8::Local<v8::Value> value)
-{
-    return hasInstance(value, isolate) ? toImpl(v8::Local<v8::Object>::Cast(value)) : nullptr;
-}
-
-void V8TestInterfaceSecureContext::preparePrototypeAndInterfaceObject(v8::Local<v8::Context> context, const DOMWrapperWorld& world, v8::Local<v8::Object> prototypeObject, v8::Local<v8::Function> interfaceObject, v8::Local<v8::FunctionTemplate> interfaceTemplate)
-{
-    v8::Isolate* isolate = context->GetIsolate();
-    ExecutionContext* executionContext = toExecutionContext(context);
-    v8::Local<v8::Signature> signature = v8::Signature::New(isolate, interfaceTemplate);
-    if (executionContext && (executionContext->isSecureContext())) {
-        const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextAttribute", TestInterfaceSecureContextV8Internal::secureContextAttributeAttributeGetterCallback, TestInterfaceSecureContextV8Internal::secureContextAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-        V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-            const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextRuntimeEnabledAttribute", TestInterfaceSecureContextV8Internal::secureContextRuntimeEnabledAttributeAttributeGetterCallback, TestInterfaceSecureContextV8Internal::secureContextRuntimeEnabledAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-            V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isDocument())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextWindowExposedAttribute", TestInterfaceSecureContextV8Internal::secureContextWindowExposedAttributeAttributeGetterCallback, TestInterfaceSecureContextV8Internal::secureContextWindowExposedAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-            V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isWorkerGlobalScope())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextWorkerExposedAttribute", TestInterfaceSecureContextV8Internal::secureContextWorkerExposedAttributeAttributeGetterCallback, TestInterfaceSecureContextV8Internal::secureContextWorkerExposedAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-            V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isDocument())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextWindowExposedRuntimeEnabledAttribute", TestInterfaceSecureContextV8Internal::secureContextWindowExposedRuntimeEnabledAttributeAttributeGetterCallback, TestInterfaceSecureContextV8Internal::secureContextWindowExposedRuntimeEnabledAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-                V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-            }
-        }
-    }
-    if (executionContext && (executionContext->isWorkerGlobalScope())) {
-        if (executionContext && (executionContext->isSecureContext())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::AccessorConfiguration accessorConfiguration = {"secureContextWorkerExposedRuntimeEnabledAttribute", TestInterfaceSecureContextV8Internal::secureContextWorkerExposedRuntimeEnabledAttributeAttributeGetterCallback, TestInterfaceSecureContextV8Internal::secureContextWorkerExposedRuntimeEnabledAttributeAttributeSetterCallback, 0, 0, 0, v8::DEFAULT, static_cast<v8::PropertyAttribute>(v8::None), V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype, V8DOMConfiguration::CheckHolder};
-                V8DOMConfiguration::installAccessor(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, accessorConfiguration);
-            }
-        }
-    }
-    v8::Local<v8::Signature> signature = v8::Signature::New(isolate, interfaceTemplate);
-    ExecutionContext* executionContext = toExecutionContext(prototypeObject->CreationContext());
-    ASSERT(executionContext);
-    if (executionContext && (executionContext->isSecureContext())) {
-        const V8DOMConfiguration::MethodConfiguration secureContextMethodMethodConfiguration = {"secureContextMethod", TestInterfaceSecureContextV8Internal::secureContextMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-        V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextMethodMethodConfiguration);
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-            const V8DOMConfiguration::MethodConfiguration secureContextRuntimeEnabledMethodMethodConfiguration = {"secureContextRuntimeEnabledMethod", TestInterfaceSecureContextV8Internal::secureContextRuntimeEnabledMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-            V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextRuntimeEnabledMethodMethodConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isDocument())) {
-            const V8DOMConfiguration::MethodConfiguration secureContextWindowExposedMethodMethodConfiguration = {"secureContextWindowExposedMethod", TestInterfaceSecureContextV8Internal::secureContextWindowExposedMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-            V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextWindowExposedMethodMethodConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isWorkerGlobalScope())) {
-            const V8DOMConfiguration::MethodConfiguration secureContextWorkerExposedMethodMethodConfiguration = {"secureContextWorkerExposedMethod", TestInterfaceSecureContextV8Internal::secureContextWorkerExposedMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-            V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextWorkerExposedMethodMethodConfiguration);
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isDocument())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::MethodConfiguration secureContextWindowExposedRuntimeEnabledMethodMethodConfiguration = {"secureContextWindowExposedRuntimeEnabledMethod", TestInterfaceSecureContextV8Internal::secureContextWindowExposedRuntimeEnabledMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-                V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextWindowExposedRuntimeEnabledMethodMethodConfiguration);
-            }
-        }
-    }
-    if (executionContext && (executionContext->isSecureContext())) {
-        if (executionContext && (executionContext->isWorkerGlobalScope())) {
-            if (RuntimeEnabledFeatures::secureFeatureEnabled()) {
-                const V8DOMConfiguration::MethodConfiguration secureContextWorkerExposedRuntimeEnabledMethodMethodConfiguration = {"secureContextWorkerExposedRuntimeEnabledMethod", TestInterfaceSecureContextV8Internal::secureContextWorkerExposedRuntimeEnabledMethodMethodCallback, 0, 0, v8::None, V8DOMConfiguration::ExposedToAllScripts, V8DOMConfiguration::OnPrototype};
-                V8DOMConfiguration::installMethod(isolate, world, v8::Local<v8::Object>(), prototypeObject, interfaceObject, signature, secureContextWorkerExposedRuntimeEnabledMethodMethodConfiguration);
-            }
-        }
-    }
-}
-
-} // namespace blink
diff --git a/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterfaceSecureContext.h b/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterfaceSecureContext.h
deleted file mode 100644
index 3ef0bfa..0000000
--- a/third_party/WebKit/Source/bindings/tests/results/core/V8TestInterfaceSecureContext.h
+++ /dev/null
@@ -1,53 +0,0 @@
-// Copyright 2014 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-// This file has been auto-generated by code_generator_v8.py. DO NOT MODIFY!
-
-#ifndef V8TestInterfaceSecureContext_h
-#define V8TestInterfaceSecureContext_h
-
-#include "bindings/core/v8/ScriptWrappable.h"
-#include "bindings/core/v8/ToV8.h"
-#include "bindings/core/v8/V8Binding.h"
-#include "bindings/core/v8/V8DOMWrapper.h"
-#include "bindings/core/v8/WrapperTypeInfo.h"
-#include "bindings/tests/idls/core/TestInterfaceSecureContext.h"
-#include "core/CoreExport.h"
-#include "platform/heap/Handle.h"
-
-namespace blink {
-
-class V8TestInterfaceSecureContext {
-    STATIC_ONLY(V8TestInterfaceSecureContext);
-public:
-    CORE_EXPORT static bool hasInstance(v8::Local<v8::Value>, v8::Isolate*);
-    static v8::Local<v8::Object> findInstanceInPrototypeChain(v8::Local<v8::Value>, v8::Isolate*);
-    CORE_EXPORT static v8::Local<v8::FunctionTemplate> domTemplate(v8::Isolate*, const DOMWrapperWorld&);
-    static TestInterfaceSecureContext* toImpl(v8::Local<v8::Object> object)
-    {
-        return toScriptWrappable(object)->toImpl<TestInterfaceSecureContext>();
-    }
-    CORE_EXPORT static TestInterfaceSecureContext* toImplWithTypeCheck(v8::Isolate*, v8::Local<v8::Value>);
-    CORE_EXPORT static const WrapperTypeInfo wrapperTypeInfo;
-    template<typename VisitorDispatcher>
-    static void trace(VisitorDispatcher visitor, ScriptWrappable* scriptWrappable)
-    {
-        visitor->trace(scriptWrappable->toImpl<TestInterfaceSecureContext>());
-    }
-    static void traceWrappers(WrapperVisitor* visitor, ScriptWrappable* scriptWrappable)
-    {
-        visitor->traceWrappers(scriptWrappable->toImpl<TestInterfaceSecureContext>());
-    }
-    static const int internalFieldCount = v8DefaultWrapperInternalFieldCount + 0;
-    CORE_EXPORT static void preparePrototypeAndInterfaceObject(v8::Local<v8::Context>, const DOMWrapperWorld&, v8::Local<v8::Object> prototypeObject, v8::Local<v8::Function> interfaceObject, v8::Local<v8::FunctionTemplate> interfaceTemplate);
-};
-
-template <>
-struct V8TypeOf<TestInterfaceSecureContext> {
-    typedef V8TestInterfaceSecureContext Type;
-};
-
-} // namespace blink
-
-#endif // V8TestInterfaceSecureContext_h
diff --git a/third_party/WebKit/Source/build/scripts/css_properties.py b/third_party/WebKit/Source/build/scripts/css_properties.py
index d4b7977..43e8be4 100755
--- a/third_party/WebKit/Source/build/scripts/css_properties.py
+++ b/third_party/WebKit/Source/build/scripts/css_properties.py
@@ -15,6 +15,7 @@ class CSSProperties(in_generator.Writer):
         'longhands': '',
         'interpolable': False,
         'inherited': False,
+        'independent': False,
         'font': False,
         'svg': False,
         'name_for_methods': None,
@@ -40,6 +41,7 @@ class CSSProperties(in_generator.Writer):
     valid_values = {
         'interpolable': (True, False),
         'inherited': (True, False),
+        'independent': (True, False),
         'font': (True, False),
         'svg': (True, False),
         'custom_all': (True, False),
diff --git a/third_party/WebKit/Source/build/scripts/make_style_builder.py b/third_party/WebKit/Source/build/scripts/make_style_builder.py
index c5d5ca5..1db7289 100755
--- a/third_party/WebKit/Source/build/scripts/make_style_builder.py
+++ b/third_party/WebKit/Source/build/scripts/make_style_builder.py
@@ -59,11 +59,14 @@ class StyleBuilderWriter(css_properties.CSSProperties):
             set_if_none(property, 'type_name', 'E' + name)
             set_if_none(property, 'getter', lower_first(name) if simple_type_name != name else 'get' + name)
             set_if_none(property, 'setter', 'set' + name)
+            set_if_none(property, 'inherited', False)
             set_if_none(property, 'initial', 'initial' + name)
             if property['custom_all']:
                 property['custom_initial'] = True
                 property['custom_inherit'] = True
                 property['custom_value'] = True
+            if property['inherited']:
+                property['is_inherited_setter'] = 'set' + name + 'IsInherited'
             property['should_declare_functions'] = not property['use_handlers_for'] and not property['longhands'] \
                 and not property['direction_aware'] and not property['builder_skip'] \
                 and not property['descriptor_only']
diff --git a/third_party/WebKit/Source/build/scripts/templates/StyleBuilderFunctions.cpp.tmpl b/third_party/WebKit/Source/build/scripts/templates/StyleBuilderFunctions.cpp.tmpl
index 241ed5c..8e627b2 100644
--- a/third_party/WebKit/Source/build/scripts/templates/StyleBuilderFunctions.cpp.tmpl
+++ b/third_party/WebKit/Source/build/scripts/templates/StyleBuilderFunctions.cpp.tmpl
@@ -43,6 +43,9 @@ state.style()->{{property.setter}}
 {{set_value(property)}}(toCSSPrimitiveValue(value).convertTo<{{property.type_name}}>());
 {%- endif %}
 {% endmacro %}
+{% macro set_is_inherited(property) %}
+state.style()->{{property.is_inherited_setter}}
+{% endmacro %}
 
 namespace blink {
 
@@ -58,6 +61,9 @@ namespace blink {
     {% else %}
     {{set_value(property)}}(ComputedStyle::{{property.initial}}());
     {% endif %}
+    {% if property.independent %}
+    {{set_is_inherited(property)}}(true);
+    {% endif %}
 }
 
 {% endif %}
@@ -71,6 +77,9 @@ namespace blink {
     {% else %}
     {{set_value(property)}}(state.parentStyle()->{{property.getter}}());
     {% endif %}
+    {% if property.independent %}
+    {{set_is_inherited(property)}}(false);
+    {% endif %}
 }
 
 {% endif %}
@@ -78,6 +87,9 @@ namespace blink {
 {{declare_value_function(property_id)}}
 {
     {{convert_and_set_value(property)}}
+    {% if property.independent %}
+    {{set_is_inherited(property)}}(false);
+    {% endif %}
 }
 
 {% endif %}
diff --git a/third_party/WebKit/Source/core/core.gypi b/third_party/WebKit/Source/core/core.gypi
index 96062ce..7b927f2 100644
--- a/third_party/WebKit/Source/core/core.gypi
+++ b/third_party/WebKit/Source/core/core.gypi
@@ -131,6 +131,7 @@
             'events/CustomEvent.idl',
             'events/DragEvent.idl',
             'events/ErrorEvent.idl',
+            'events/RequestedVisibilityEvent.idl',
             'events/Event.idl',
             'events/EventTarget.idl',
             'events/FocusEvent.idl',
@@ -475,6 +476,7 @@
             'events/CustomEvent.idl',
             'events/DragEvent.idl',
             'events/ErrorEvent.idl',
+            'events/RequestedVisibilityEvent.idl',
             'events/Event.idl',
             'events/FocusEvent.idl',
             'events/HashChangeEvent.idl',
@@ -2769,6 +2771,8 @@
             'events/DragEvent.h',
             'events/ErrorEvent.cpp',
             'events/ErrorEvent.h',
+            'events/RequestedVisibilityEvent.cpp',
+            'events/RequestedVisibilityEvent.h',
             'events/Event.cpp',
             'events/EventDispatchMediator.cpp',
             'events/EventDispatchMediator.h',
@@ -3759,6 +3763,7 @@
             'events/CustomEventInit.idl',
             'events/DragEventInit.idl',
             'events/ErrorEventInit.idl',
+            'events/RequestedVisibilityEventInit.idl',
             'events/EventInit.idl',
             'events/EventListenerOptions.idl',
             'events/EventModifierInit.idl',
@@ -3839,6 +3844,8 @@
             '<(blink_core_output_dir)/events/DragEventInit.h',
             '<(blink_core_output_dir)/events/ErrorEventInit.cpp',
             '<(blink_core_output_dir)/events/ErrorEventInit.h',
+            '<(blink_core_output_dir)/events/RequestedVisibilityEventInit.cpp',
+            '<(blink_core_output_dir)/events/RequestedVisibilityEventInit.h',
             '<(blink_core_output_dir)/events/EventInit.cpp',
             '<(blink_core_output_dir)/events/EventInit.h',
             '<(blink_core_output_dir)/events/EventListenerOptions.cpp',
diff --git a/third_party/WebKit/Source/core/css/CSSProperties.in b/third_party/WebKit/Source/core/css/CSSProperties.in
index 6dc3b0d..8ef3ba8 100644
--- a/third_party/WebKit/Source/core/css/CSSProperties.in
+++ b/third_party/WebKit/Source/core/css/CSSProperties.in
@@ -45,6 +45,12 @@
 // The property will inherit by default if no value is specified, typically
 // mentioned in specifications as "Inherited: yes"
 
+// - independent
+// This property affects only one field on ComputedStyle, and can be set
+// directly during inheritance instead of forcing a recalc.
+// StyleResolver and StyleAdjuster are not invoked when these properties
+// are changed on a parent. Recalcs only happen if at least one
+// non-independent inherited property is changed in the parent.
 
 // The remaining arguments are used for the StyleBuilder and allow us to
 // succinctly describe how to apply properties. When default handlers are not
@@ -272,7 +278,7 @@ padding-top interpolable, initial=initialPadding, converter=convertLength
 paint-order inherited, svg, converter=convertPaintOrder
 perspective interpolable, converter=convertPerspective
 perspective-origin interpolable, converter=convertPosition
-pointer-events inherited
+pointer-events inherited, independent
 position custom_inherit
 quotes inherited, converter=convertQuotes
 resize custom_value
@@ -336,7 +342,7 @@ transition-timing-function custom_all
 unicode-bidi
 vector-effect svg
 vertical-align interpolable, custom_inherit, custom_value
-visibility interpolable, inherited
+visibility interpolable, inherited, independent
 x interpolable, svg, converter=convertLength
 y interpolable, svg, converter=convertLength
 -webkit-appearance type_name=ControlPart
diff --git a/third_party/WebKit/Source/core/css/resolver/StyleResolverStats.cpp b/third_party/WebKit/Source/core/css/resolver/StyleResolverStats.cpp
index f9c2973..50153fb 100644
--- a/third_party/WebKit/Source/core/css/resolver/StyleResolverStats.cpp
+++ b/third_party/WebKit/Source/core/css/resolver/StyleResolverStats.cpp
@@ -56,6 +56,7 @@ void StyleResolverStats::reset()
     elementsStyled = 0;
     pseudoElementsStyled = 0;
     baseStylesUsed = 0;
+    independentInheritedStylesPropagated = 0;
 }
 
 bool StyleResolverStats::allCountersEnabled() const
@@ -89,6 +90,7 @@ std::unique_ptr<TracedValue> StyleResolverStats::toTracedValue() const
     tracedValue->setInteger("elementsStyled", elementsStyled);
     tracedValue->setInteger("pseudoElementsStyled", pseudoElementsStyled);
     tracedValue->setInteger("baseStylesUsed", baseStylesUsed);
+    tracedValue->setInteger("independentInheritedStylesPropagated", independentInheritedStylesPropagated);
     return tracedValue;
 }
 
diff --git a/third_party/WebKit/Source/core/css/resolver/StyleResolverStats.h b/third_party/WebKit/Source/core/css/resolver/StyleResolverStats.h
index 59c630b..9de737d 100644
--- a/third_party/WebKit/Source/core/css/resolver/StyleResolverStats.h
+++ b/third_party/WebKit/Source/core/css/resolver/StyleResolverStats.h
@@ -70,6 +70,7 @@ public:
     unsigned elementsStyled;
     unsigned pseudoElementsStyled;
     unsigned baseStylesUsed;
+    unsigned independentInheritedStylesPropagated;
 
 private:
     StyleResolverStats()
diff --git a/third_party/WebKit/Source/core/dom/Document.cpp b/third_party/WebKit/Source/core/dom/Document.cpp
index 8c1c043..e386f4a 100644
--- a/third_party/WebKit/Source/core/dom/Document.cpp
+++ b/third_party/WebKit/Source/core/dom/Document.cpp
@@ -26,6 +26,7 @@
  */
 
 #include "core/dom/Document.h"
+#include "core/events/ErrorEvent.h"
 
 #include "bindings/core/v8/DOMDataStore.h"
 #include "bindings/core/v8/ExceptionMessages.h"
@@ -121,11 +122,13 @@
 #include "core/editing/serializers/Serialization.h"
 #include "core/editing/spellcheck/SpellChecker.h"
 #include "core/events/BeforeUnloadEvent.h"
+#include "core/events/ErrorEvent.h"
 #include "core/events/Event.h"
 #include "core/events/EventFactory.h"
 #include "core/events/EventListener.h"
 #include "core/events/HashChangeEvent.h"
 #include "core/events/PageTransitionEvent.h"
+#include "core/events/RequestedVisibilityEvent.h"
 #include "core/events/ScopedEventQueue.h"
 #include "core/events/VisualViewportResizeEvent.h"
 #include "core/events/VisualViewportScrollEvent.h"
@@ -185,6 +188,7 @@
 #include "core/layout/LayoutView.h"
 #include "core/layout/TextAutosizer.h"
 #include "core/layout/api/LayoutViewItem.h"
+#include "core/layout/compositing/CompositedLayerMapping.h"
 #include "core/layout/compositing/PaintLayerCompositor.h"
 #include "core/loader/CookieJar.h"
 #include "core/loader/DocumentLoader.h"
@@ -211,6 +215,9 @@
 #include "core/svg/SVGScriptElement.h"
 #include "core/svg/SVGTitleElement.h"
 #include "core/svg/SVGUseElement.h"
+#include "core/testing/Internals.h"
+#include "core/testing/InternalRuntimeFlags.h"
+#include "core/testing/InternalSettings.h"
 #include "core/timing/DOMWindowPerformance.h"
 #include "core/timing/Performance.h"
 #include "core/workers/SharedWorkerRepositoryClient.h"
@@ -393,6 +400,8 @@ Document::Document(const DocumentInit& initializer, DocumentClassFlags documentC
     , m_domWindow(m_frame ? m_frame->localDOMWindow() : 0)
     , m_importsController(initializer.importsController())
     , m_contextFeatures(ContextFeatures::defaultSwitch())
+    , m_requestedVisibility(new VisibilityDocumentSet())
+    , m_requestVisibilityRect(nullptr)
     , m_wellFormed(false)
     , m_printing(false)
     , m_wasPrinting(false)
@@ -3902,6 +3911,13 @@ void Document::enqueueAnimationFrameEvent(Event* event)
     ensureScriptedAnimationController().enqueueEvent(event);
 }
 
+void Document::enqueueRequestedVisibilityEvent(const String& msg)
+{
+    RequestedVisibilityEvent* event = RequestedVisibilityEvent::create(msg);
+    event->setTarget(documentElement());
+    ensureScriptedAnimationController().enqueueEvent(event);
+}
+
 void Document::enqueueUniqueAnimationFrameEvent(Event* event)
 {
     ensureScriptedAnimationController().enqueuePerFrameEvent(event);
@@ -5794,6 +5810,145 @@ bool Document::hasFocus() const
     return page() && page()->focusController().isDocumentFocused(*this);
 }
 
+
+void Document::validIronframe(){
+    m_frame->loader().client()->ironframeOrigin(this->origin().ascii());
+    m_frame->loader().client()->validIronframe();
+    
+    // Set attribute.
+    //this->documentElement()->setAttribute("requestVisibility", "1", ASSERT_NO_EXCEPTION);
+}
+
+void Document::invalidIronframe(){
+    m_frame->loader().client()->invalidIronframe();
+    // Set attribute.
+    //this->documentElement()->setAttribute("requestVisibility", "1", ASSERT_NO_EXCEPTION);
+}
+
+
+VisibilityDocumentSet *Document::requestedVisibility() {
+    return m_requestedVisibility;
+}
+
+void Document::requestVisibility(){
+    // Set attribute.
+    this->documentElement()->setAttribute("requestVisibility", "1", ASSERT_NO_EXCEPTION);
+}
+
+void Document::requestVisibilityImpl(){
+    // Step 1:  Block obvious failure modes.  Probably insert SVG test here?
+    if(this->domWindow() == this->domWindow()->top()) {return;}
+
+    // Step 2:  Collect useful handles
+    DOMWindow *testWindow = this->domWindow();
+    PaintLayer* iframePaintLayer = this->documentElement()->layoutObject()->enclosingLayer();
+
+    if(!iframePaintLayer) { return; }
+    GraphicsLayer* iframeGraphicsLayer = iframePaintLayer->graphicsLayerBacking();
+    const PaintLayer* rootPaintLayer = this->domWindow()->top()->document()->body()->layoutObject()->enclosingLayer()->root(); // XXX DMK top scrolling layer
+    GraphicsLayer* rootGraphicsLayer = rootPaintLayer->graphicsLayerBacking();
+    if(!iframeGraphicsLayer || !rootGraphicsLayer) {
+        addConsoleMessage(ConsoleMessage::create(RenderingMessageSource, ErrorMessageLevel, "Couldn't find required GraphicsLayer.  One may not have been created for this document."));
+        return;
+    }
+    // Step 3:  Discover our effective Bounds.  We are effectively trying to compute the "keyhole" that reaches us,
+    //          through multiple iframes and scroll/translateX values.  The "sacred" transform is position and size.
+    //          This is presently being done via boundsInViewportSpace, which works through almost everything.
+    //          Almost.  (Scale3d needs to be corrected for, or rejected.)
+
+    IntRect bounds = this->documentElement()->boundsInViewport();
+    IntRect origBounds = bounds;
+
+    testWindow = this->domWindow();
+    float sx, sy;
+    sx=sy=0;
+    bool moreElements=true;
+    Element *testElement = this->documentElement();
+    Document *testDocument = this;
+
+    bool do_move = true;
+    bool hostile=false;
+    while(moreElements){
+        if(testDocument->documentElement()==testElement){
+            testElement=testDocument->domWindow()->frameElement();
+            testDocument=&testElement->document();
+            sx+=testWindow->scrollX();
+            sy+=testWindow->scrollY();
+            testWindow=testWindow->parent();
+        } else {
+            testElement=testElement->parentElement();
+        }
+        // HACK!! Remove use of childrenClipRect
+        IntRect child = IntRect(testElement->layoutObject()->enclosingLayer()->clipper().childrenClipRect());
+        if(testElement->tagName()=="foreignObject"){
+            hostile=true;
+        }
+        if(testElement->tagName()=="IFRAME") {
+            IntRect ifrBounds = testElement->boundsInViewport();
+            child.setWidth(fmin(ifrBounds.size().width(), child.size().width()));
+            child.setHeight(fmin(ifrBounds.size().height(), child.size().height()));
+        }
+        bounds.intersect(child);
+        if(testElement == this->domWindow()->top()->document()->documentElement()) {
+            moreElements=false;
+        }
+    }
+    // intersect with visible viewport.  XXX stop using IntRect, start using FloatRect
+    FrameView *mainFrameView = this->page()->deprecatedLocalMainFrame()->view();
+    LayoutRect mainViewRect = mainFrameView->layoutView()->viewRect();
+    IntRect mainViewIntRect = IntRect(mainViewRect);
+    bounds.intersect(mainViewIntRect);
+
+    FloatRect mainViewFloatRect = FloatRect(mainViewRect);
+    if(!bounds.size().width() || !bounds.size().height()) do_move=false;
+    // XXX for each registered visibility req, look for collisions with us, if so block the raise
+    VisibilityDocumentSet *ds = this->domWindow()->top()->document()->requestedVisibility();
+
+    for(Document *reqdoc : *ds){
+        if(reqdoc == this) break; // maybe this is right?
+        if(reqdoc->m_requestVisibilityRect && reqdoc->m_requestVisibilityRect->intersects(bounds)) {
+            // XXX DMK better would be to run bounds.subtract but then there'd have to *be* a bounds.subtract method.
+            //         Also, subtraction is a not quite so defined as intersection.  Largest contiguous from 0,0?
+            //         Largest contiguous from any corner?  God forbid, pile-o-rects?  Let's just run for the hills for now
+            hostile=true;
+            //return;  // there is a rather fun attack if you try this
+        }
+    }
+
+    if(hostile){
+        do_move=false;
+        bounds.setWidth(0);
+        bounds.setHeight(0);
+    }
+    if(this->documentElement()->hasAttribute("visibilityOnly")) { do_move=false; } // XXX DMK expand on this, there are uses
+    if (do_move) {
+        FloatRect fbounds = bounds;
+        this->set_requestVisibilityRect(&fbounds);
+        rootGraphicsLayer->addChild(iframeGraphicsLayer);
+        iframeGraphicsLayer->setPosition(FloatPoint(bounds.x(), bounds.y()));
+        iframeGraphicsLayer->setSize(FloatSize(bounds.size().width(), bounds.size().height()));
+        iframeGraphicsLayer->setBackgroundColor(Color::black);
+        iframeGraphicsLayer->setMasksToBounds(true);
+        iframeGraphicsLayer->setOpacity(1.0);
+        IntSize offset = IntSize(bounds.x()-origBounds.x()-topDocument().domWindow()->scrollX(), bounds.y()-origBounds.y()-topDocument().domWindow()->scrollY());
+        iframeGraphicsLayer->setOffsetFromLayoutObject(offset, GraphicsLayer::ShouldSetNeedsDisplay::SetNeedsDisplay);// const IntSize & offset,ShouldSetNeedsDisplay shouldSetNeedsDisplay)
+    }
+    // report.  sx and sy are
+    bounds.setWidth(fmax(bounds.size().width() - sx, 0));
+    bounds.setHeight(fmax(bounds.size().height()- sy, 0));
+    //XXX DMK correctly integrate ancestorOrigins and return a clientRect for the visible region of the frame
+    String s = String("{\"viewport\": {\"x\": " + String::number((int)mainViewFloatRect.x()) + ", \"y\": " + String::number((int)mainViewFloatRect.y()) + ", \"width\": " + String::number((int)mainViewFloatRect.size().width()) + ", \"height\": " + String::number((int)mainViewFloatRect.size().height()) + "},  \"visible\": {\"x\": " + String::number((int)bounds.x()) + ",  \"y\": " + String::number((int)bounds.y()) + ", \"width\": " + String::number((int)bounds.size().width()) + ", \"height\": " + String::number((int)bounds.size().height()) + "}}");
+    DEFINE_STATIC_LOCAL(String, prev_event, ());
+    bool duplicate = false;
+    if (s == prev_event) {
+        duplicate = true;
+    }
+    prev_event = s;
+    if (!duplicate) {
+        this->enqueueRequestedVisibilityEvent(s);
+    }
+};
+
 template<unsigned type>
 bool shouldInvalidateNodeListCachesForAttr(const HeapHashSet<WeakMember<const LiveNodeListBase>> nodeLists[], const QualifiedName& attrName)
 {
@@ -5994,6 +6149,7 @@ DEFINE_TRACE(Document)
     visitor->trace(m_intersectionObserverData);
     visitor->trace(m_snapCoordinator);
     visitor->trace(m_resizeObserverController);
+    visitor->trace(m_requestedVisibility);
     Supplementable<Document>::trace(visitor);
     TreeScope::trace(visitor);
     ContainerNode::trace(visitor);
diff --git a/third_party/WebKit/Source/core/dom/Document.h b/third_party/WebKit/Source/core/dom/Document.h
index 2d874b3..cbf3003 100644
--- a/third_party/WebKit/Source/core/dom/Document.h
+++ b/third_party/WebKit/Source/core/dom/Document.h
@@ -177,6 +177,7 @@ struct AnnotatedRegionValue;
 struct FocusParams;
 struct IconURL;
 
+using VisibilityDocumentSet = HeapHashSet<WeakMember<Document>>;
 using MouseEventWithHitTestResults = EventWithHitTestResults<PlatformMouseEvent>;
 using ExceptionCode = int;
 
@@ -711,6 +712,8 @@ public:
     ResizeObserverController* resizeObserverController() const { return m_resizeObserverController; }
     ResizeObserverController& ensureResizeObserverController();
 
+    VisibilityDocumentSet *requestedVisibility();
+
     void updateViewportDescription();
 
     // Returns the owning element in the parent document. Returns nullptr if
@@ -926,6 +929,7 @@ public:
     void enqueueMediaQueryChangeListeners(HeapVector<Member<MediaQueryListListener>>&);
     void enqueueVisualViewportScrollEvent();
     void enqueueVisualViewportResizeEvent();
+    void enqueueRequestedVisibilityEvent(const String&);
 
     void dispatchEventsForPrinting();
 
@@ -1095,6 +1099,12 @@ public:
 
     bool isInMainFrame() const;
 
+    void set_requestVisibilityRect(FloatRect *r) { m_requestVisibilityRect = r; }
+    void validIronframe();
+    void invalidIronframe();
+    void requestVisibility();
+    void requestVisibilityImpl();
+
 protected:
     Document(const DocumentInit&, DocumentClassFlags = DefaultDocumentClass);
 
@@ -1207,6 +1217,9 @@ private:
     Member<DocumentParser> m_parser;
     Member<ContextFeatures> m_contextFeatures;
 
+    Member<VisibilityDocumentSet> m_requestedVisibility;
+    FloatRect *m_requestVisibilityRect;
+
     bool m_wellFormed;
 
     // Document URLs.
diff --git a/third_party/WebKit/Source/core/dom/Document.idl b/third_party/WebKit/Source/core/dom/Document.idl
index fdd8b9c..c51e969 100644
--- a/third_party/WebKit/Source/core/dom/Document.idl
+++ b/third_party/WebKit/Source/core/dom/Document.idl
@@ -54,6 +54,11 @@ interface Document : Node {
     HTMLCollection getElementsByTagNameNS(DOMString? namespaceURI, DOMString localName);
     HTMLCollection getElementsByClassName(DOMString classNames);
 
+    void requestVisibility();
+    void validIronframe();
+    void invalidIronframe();
+    void requestVisibilityImpl();
+
     [NewObject, DoNotTestNewObject, CustomElementCallbacks, PerWorldBindings, RaisesException] Element createElement(DOMString localName);
     [NewObject, DoNotTestNewObject, CustomElementCallbacks, RaisesException] Element createElementNS(DOMString? namespaceURI, DOMString qualifiedName);
     [NewObject] DocumentFragment createDocumentFragment();
diff --git a/third_party/WebKit/Source/core/dom/Element.cpp b/third_party/WebKit/Source/core/dom/Element.cpp
index 407edc3..8fb4a4d 100644
--- a/third_party/WebKit/Source/core/dom/Element.cpp
+++ b/third_party/WebKit/Source/core/dom/Element.cpp
@@ -1710,12 +1710,13 @@ void Element::recalcStyle(StyleRecalcChange change, Text* nextTextSibling)
     if (hasCustomStyleCallbacks())
         willRecalcStyle(change);
 
-    if (change >= Inherit || needsStyleRecalc()) {
+    if (change >= IndependentInherit || needsStyleRecalc()) {
         if (hasRareData()) {
             ElementRareData* data = elementRareData();
-            data->clearComputedStyle();
+            if (change != IndependentInherit)
+                data->clearComputedStyle();
 
-            if (change >= Inherit) {
+            if (change >= IndependentInherit) {
                 if (ElementAnimations* elementAnimations = data->elementAnimations())
                     elementAnimations->setAnimationStyleChange(false);
             }
@@ -1759,15 +1760,40 @@ void Element::recalcStyle(StyleRecalcChange change, Text* nextTextSibling)
         reattachWhitespaceSiblingsIfNeeded(nextTextSibling);
 }
 
+PassRefPtr<ComputedStyle> Element::propagateInheritedProperties(StyleRecalcChange change)
+{
+    if (change != IndependentInherit)
+        return nullptr;
+    if (needsStyleRecalc())
+        return nullptr;
+    if (hasAnimations())
+        return nullptr;
+    const ComputedStyle* parentStyle = parentComputedStyle();
+    DCHECK(parentStyle);
+    const ComputedStyle* style = computedStyle();
+    if (!style || style->animations() || style->transitions())
+        return nullptr;
+    RefPtr<ComputedStyle> newStyle = ComputedStyle::clone(*style);
+    newStyle->propagateIndependentInheritedProperties(*parentStyle);
+    INCREMENT_STYLE_STATS_COUNTER(document().styleEngine(), independentInheritedStylesPropagated, 1);
+    return newStyle;
+}
+
 StyleRecalcChange Element::recalcOwnStyle(StyleRecalcChange change)
 {
     DCHECK(document().inStyleRecalc());
     DCHECK(!parentOrShadowHostNode()->needsStyleRecalc());
-    DCHECK(change >= Inherit || needsStyleRecalc());
+    DCHECK(change >= IndependentInherit || needsStyleRecalc());
     DCHECK(parentComputedStyle());
 
     RefPtr<ComputedStyle> oldStyle = mutableComputedStyle();
-    RefPtr<ComputedStyle> newStyle = styleForLayoutObject();
+
+    // When propagating inherited changes, we don't need to do a full style recalc
+    // if the only changed properties are independent. In this case, we can simply
+    // set these directly on the ComputedStyle object.
+    RefPtr<ComputedStyle> newStyle = propagateInheritedProperties(change);
+    if (!newStyle)
+        newStyle = styleForLayoutObject();
     DCHECK(newStyle);
 
     StyleRecalcChange localChange = ComputedStyle::stylePropagationDiff(oldStyle.get(), newStyle.get());
@@ -1807,7 +1833,7 @@ StyleRecalcChange Element::recalcOwnStyle(StyleRecalcChange change)
     if (change > Inherit || localChange > Inherit)
         return max(localChange, change);
 
-    if (localChange < Inherit) {
+    if (localChange < IndependentInherit) {
         if (oldStyle->hasChildDependentFlags()) {
             if (childNeedsStyleRecalc())
                 return Inherit;
diff --git a/third_party/WebKit/Source/core/dom/Element.h b/third_party/WebKit/Source/core/dom/Element.h
index 673c4e4..2ee3878 100644
--- a/third_party/WebKit/Source/core/dom/Element.h
+++ b/third_party/WebKit/Source/core/dom/Element.h
@@ -658,6 +658,12 @@ private:
     PropertySetCSSStyleDeclaration* inlineStyleCSSOMWrapper();
     void setInlineStyleFromString(const AtomicString&);
 
+    // If the only inherited changes in the parent element are independent,
+    // these changes can be directly propagated to this element (the child).
+    // If these conditions are met, propagates the changes to the current style
+    // and returns the new style. Otherwise, returns null.
+    PassRefPtr<ComputedStyle> propagateInheritedProperties(StyleRecalcChange);
+
     StyleRecalcChange recalcOwnStyle(StyleRecalcChange);
     // TODO(nainar): Make this const ComputedStyle&.
     StyleRecalcChange buildLayoutTree(ComputedStyle&);
diff --git a/third_party/WebKit/Source/core/dom/IntersectionObservation.cpp b/third_party/WebKit/Source/core/dom/IntersectionObservation.cpp
index ea0cd1f..39821a7 100644
--- a/third_party/WebKit/Source/core/dom/IntersectionObservation.cpp
+++ b/third_party/WebKit/Source/core/dom/IntersectionObservation.cpp
@@ -61,17 +61,14 @@ void IntersectionObservation::clipToRoot(IntersectionGeometry& geometry) const
     // Map and clip rect into root element coordinates.
     // TODO(szager): the writing mode flipping needs a test.
     DCHECK(m_target);
-    LayoutBox* rootLayoutObject = toLayoutBox(m_observer->rootLayoutObject());
+    LayoutObject* rootLayoutObject = m_observer->rootLayoutObject();
     LayoutObject* targetLayoutObject = target()->layoutObject();
 
-    geometry.doesIntersect = targetLayoutObject->mapToVisualRectInAncestorSpace(rootLayoutObject, geometry.intersectionRect, EdgeInclusive);
-    if (rootLayoutObject->hasOverflowClip())
-        geometry.intersectionRect.move(-rootLayoutObject->scrolledContentOffset());
-
+    geometry.doesIntersect = targetLayoutObject->mapToVisualRectInAncestorSpace(toLayoutBoxModelObject(rootLayoutObject), geometry.intersectionRect, EdgeInclusive);
     if (!geometry.doesIntersect)
         return;
     LayoutRect rootClipRect(geometry.rootRect);
-    rootLayoutObject->flipForWritingMode(rootClipRect);
+    toLayoutBox(rootLayoutObject)->flipForWritingMode(rootClipRect);
     geometry.doesIntersect &= geometry.intersectionRect.inclusiveIntersect(rootClipRect);
 }
 
diff --git a/third_party/WebKit/Source/core/dom/Node.h b/third_party/WebKit/Source/core/dom/Node.h
index 2d03e74..ea0ed5f 100644
--- a/third_party/WebKit/Source/core/dom/Node.h
+++ b/third_party/WebKit/Source/core/dom/Node.h
@@ -834,7 +834,7 @@ inline void Node::lazyReattachIfAttached()
 
 inline bool Node::shouldCallRecalcStyle(StyleRecalcChange change)
 {
-    return change >= Inherit || needsStyleRecalc() || childNeedsStyleRecalc();
+    return change >= IndependentInherit || needsStyleRecalc() || childNeedsStyleRecalc();
 }
 
 inline bool isTreeScopeRoot(const Node* node)
diff --git a/third_party/WebKit/Source/core/events/EventTarget.cpp b/third_party/WebKit/Source/core/events/EventTarget.cpp
index 90bcd0a..6cdf0e1 100644
--- a/third_party/WebKit/Source/core/events/EventTarget.cpp
+++ b/third_party/WebKit/Source/core/events/EventTarget.cpp
@@ -545,17 +545,6 @@ DispatchEventResult EventTarget::fireEventListeners(Event* event)
     return dispatchEventResult(*event);
 }
 
-bool EventTarget::checkTypeThenUseCount(
-    const Event* event, const AtomicString& eventTypeToCount, const UseCounter::Feature feature)
-{
-    if (event->type() == eventTypeToCount) {
-        if (LocalDOMWindow* executingWindow = this->executingWindow())
-            UseCounter::count(executingWindow->document(), feature);
-        return true;
-    }
-    return false;
-}
-
 bool EventTarget::fireEventListeners(Event* event, EventTargetData* d, EventListenerVector& entry)
 {
     // Fire all listeners registered for this event. Don't fire listeners removed
@@ -563,25 +552,38 @@ bool EventTarget::fireEventListeners(Event* event, EventTargetData* d, EventList
     // dispatch. Conveniently, all new event listeners will be added after or at
     // index |size|, so iterating up to (but not including) |size| naturally excludes
     // new event listeners.
+    //
+    // TODO(mustaq): This code needs to be refactored, crbug.com/629601
 
-    if (checkTypeThenUseCount(event, EventTypeNames::beforeunload, UseCounter::DocumentBeforeUnloadFired)) {
+    if (event->type() == EventTypeNames::beforeunload) {
         if (LocalDOMWindow* executingWindow = this->executingWindow()) {
-            // TODO(mustaq): Is the |if| condition correct? crbug.com/635029
             if (executingWindow->top())
                 UseCounter::count(executingWindow->document(), UseCounter::SubFrameBeforeUnloadFired);
+            UseCounter::count(executingWindow->document(), UseCounter::DocumentBeforeUnloadFired);
         }
-    } else if (checkTypeThenUseCount(event, EventTypeNames::unload, UseCounter::DocumentUnloadFired)) {
-    } else if (checkTypeThenUseCount(event, EventTypeNames::DOMFocusIn, UseCounter::DOMFocusInOutEvent)) {
-    } else if (checkTypeThenUseCount(event, EventTypeNames::DOMFocusOut, UseCounter::DOMFocusInOutEvent)) {
-    } else if (checkTypeThenUseCount(event, EventTypeNames::focusin, UseCounter::FocusInOutEvent)) {
-    } else if (checkTypeThenUseCount(event, EventTypeNames::focusout, UseCounter::FocusInOutEvent)) {
-    } else if (checkTypeThenUseCount(event, EventTypeNames::textInput, UseCounter::TextInputFired)) {
-    } else if (checkTypeThenUseCount(event, EventTypeNames::touchstart, UseCounter::TouchStartFired)) {
-    } else if (checkTypeThenUseCount(event, EventTypeNames::mousedown, UseCounter::MouseDownFired)) {
-    } else if (checkTypeThenUseCount(event, EventTypeNames::pointerdown, UseCounter::PointerDownFired)) {
+    } else if (event->type() == EventTypeNames::unload) {
+        if (LocalDOMWindow* executingWindow = this->executingWindow())
+            UseCounter::count(executingWindow->document(), UseCounter::DocumentUnloadFired);
+    } else if (event->type() == EventTypeNames::DOMFocusIn || event->type() == EventTypeNames::DOMFocusOut) {
+        if (LocalDOMWindow* executingWindow = this->executingWindow())
+            UseCounter::count(executingWindow->document(), UseCounter::DOMFocusInOutEvent);
+    } else if (event->type() == EventTypeNames::focusin || event->type() == EventTypeNames::focusout) {
+        if (LocalDOMWindow* executingWindow = this->executingWindow())
+            UseCounter::count(executingWindow->document(), UseCounter::FocusInOutEvent);
+    } else if (event->type() == EventTypeNames::textInput) {
+        if (LocalDOMWindow* executingWindow = this->executingWindow())
+            UseCounter::count(executingWindow->document(), UseCounter::TextInputFired);
+    } else if (event->type() == EventTypeNames::touchstart) {
+        if (LocalDOMWindow* executingWindow = this->executingWindow())
+            UseCounter::count(executingWindow->document(), UseCounter::TouchStartFired);
+    } else if (event->type() == EventTypeNames::mousedown) {
+        if (LocalDOMWindow* executingWindow = this->executingWindow())
+            UseCounter::count(executingWindow->document(), UseCounter::MouseDownFired);
+    } else if (event->type() == EventTypeNames::pointerdown) {
         if (LocalDOMWindow* executingWindow = this->executingWindow()) {
-            if (static_cast<PointerEvent*>(event)->pointerType() == "touch")
+            if (event->isPointerEvent() && static_cast<PointerEvent*>(event)->pointerType() == "touch")
                 UseCounter::count(executingWindow->document(), UseCounter::PointerDownFiredForTouch);
+            UseCounter::count(executingWindow->document(), UseCounter::PointerDownFired);
         }
     }
 
diff --git a/third_party/WebKit/Source/core/events/EventTarget.h b/third_party/WebKit/Source/core/events/EventTarget.h
index 0a2f3d6..a4ea66f 100644
--- a/third_party/WebKit/Source/core/events/EventTarget.h
+++ b/third_party/WebKit/Source/core/events/EventTarget.h
@@ -42,7 +42,6 @@
 #include "core/events/AddEventListenerOptionsResolved.h"
 #include "core/events/EventDispatchResult.h"
 #include "core/events/EventListenerMap.h"
-#include "core/frame/UseCounter.h"
 #include "platform/heap/Handle.h"
 #include "wtf/Allocator.h"
 #include "wtf/text/AtomicString.h"
@@ -176,10 +175,6 @@ protected:
 private:
     LocalDOMWindow* executingWindow();
     void setDefaultAddEventListenerOptions(const AtomicString& eventType, AddEventListenerOptionsResolved&);
-
-    // UseCounts the event if it has the specified type. Returns true iff the event type matches.
-    bool checkTypeThenUseCount(const Event*, const AtomicString&, const UseCounter::Feature);
-
     bool fireEventListeners(Event*, EventTargetData*, EventListenerVector&);
     void countLegacyEvents(const AtomicString& legacyTypeName, EventListenerVector*, EventListenerVector*);
 
diff --git a/third_party/WebKit/Source/core/events/EventTypeNames.in b/third_party/WebKit/Source/core/events/EventTypeNames.in
index f86ff7e..e9ccbac 100644
--- a/third_party/WebKit/Source/core/events/EventTypeNames.in
+++ b/third_party/WebKit/Source/core/events/EventTypeNames.in
@@ -186,6 +186,7 @@ removesourcebuffer
 removestream
 removetrack
 repeatEvent
+requestedvisibility
 reset
 resize
 resourcetimingbufferfull
diff --git a/third_party/WebKit/Source/core/events/RequestedVisibilityEvent.cpp b/third_party/WebKit/Source/core/events/RequestedVisibilityEvent.cpp
new file mode 100644
index 0000000..c32b661
--- /dev/null
+++ b/third_party/WebKit/Source/core/events/RequestedVisibilityEvent.cpp
@@ -0,0 +1,77 @@
+/*
+ * Copyright (C) 2016 Google Inc. All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions are
+ * met:
+ *
+ *     * Redistributions of source code must retain the above copyright
+ * notice, this list of conditions and the following disclaimer.
+ *     * Redistributions in binary form must reproduce the above
+ * copyright notice, this list of conditions and the following disclaimer
+ * in the documentation and/or other materials provided with the
+ * distribution.
+ *     * Neither the name of Google Inc. nor the names of its
+ * contributors may be used to endorse or promote products derived from
+ * this software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
+ * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
+ * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
+ * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
+ * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
+ * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+
+#include "core/events/RequestedVisibilityEvent.h"
+
+#include "bindings/core/v8/V8Binding.h"
+#include <v8.h>
+
+namespace blink {
+
+RequestedVisibilityEvent::RequestedVisibilityEvent()
+    : m_sanitizedMessage()
+{
+}
+
+RequestedVisibilityEvent::RequestedVisibilityEvent(const AtomicString& type, const RequestedVisibilityEventInit& initializer)
+    : Event(type, initializer)
+    , m_sanitizedMessage()
+{
+    if (initializer.hasMessage())
+        m_sanitizedMessage = initializer.message();
+}
+
+RequestedVisibilityEvent::RequestedVisibilityEvent(const String& message)
+    : Event(EventTypeNames::requestedvisibility, false, true)
+    , m_sanitizedMessage(message)
+{
+}
+
+void RequestedVisibilityEvent::setUnsanitizedMessage(const String& message)
+{
+    ASSERT(m_unsanitizedMessage.isEmpty());
+    m_unsanitizedMessage = message;
+}
+
+RequestedVisibilityEvent::~RequestedVisibilityEvent()
+{
+}
+
+const AtomicString& RequestedVisibilityEvent::interfaceName() const
+{
+    return EventNames::RequestedVisibilityEvent;
+}
+
+DEFINE_TRACE(RequestedVisibilityEvent)
+{
+    Event::trace(visitor);
+}
+
+} // namespace blink
diff --git a/third_party/WebKit/Source/core/events/RequestedVisibilityEvent.h b/third_party/WebKit/Source/core/events/RequestedVisibilityEvent.h
new file mode 100644
index 0000000..0f200b8
--- /dev/null
+++ b/third_party/WebKit/Source/core/events/RequestedVisibilityEvent.h
@@ -0,0 +1,84 @@
+/*
+ * Copyright (C) 2016 Google Inc. All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions are
+ * met:
+ *
+ *     * Redistributions of source code must retain the above copyright
+ * notice, this list of conditions and the following disclaimer.
+ *     * Redistributions in binary form must reproduce the above
+ * copyright notice, this list of conditions and the following disclaimer
+ * in the documentation and/or other materials provided with the
+ * distribution.
+ *     * Neither the name of Google Inc. nor the names of its
+ * contributors may be used to endorse or promote products derived from
+ * this software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
+ * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
+ * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
+ * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
+ * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
+ * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+
+#ifndef RequestedVisibilityEvent_h
+#define RequestedVisibilityEvent_h
+
+#include "bindings/core/v8/DOMWrapperWorld.h"
+#include "bindings/core/v8/SourceLocation.h"
+#include "core/events/RequestedVisibilityEventInit.h"
+#include "core/events/Event.h"
+#include "wtf/RefPtr.h"
+#include "wtf/text/WTFString.h"
+
+namespace blink {
+
+class RequestedVisibilityEvent final : public Event {
+    DEFINE_WRAPPERTYPEINFO();
+public:
+    static RequestedVisibilityEvent* create()
+    {
+        return new RequestedVisibilityEvent;
+    }
+    static RequestedVisibilityEvent* create(const String& message)
+    {
+        return new RequestedVisibilityEvent(message);
+    }
+    static RequestedVisibilityEvent* create(const AtomicString& type, const RequestedVisibilityEventInit& initializer)
+    {
+        return new RequestedVisibilityEvent(type, initializer);
+    }
+
+    ~RequestedVisibilityEvent() override;
+
+    // As 'message' is exposed to JavaScript, never return unsanitizedMessage.
+    const String& message() const { return m_sanitizedMessage; }
+
+    // 'messageForConsole' is not exposed to JavaScript, and prefers 'm_unsanitizedMessage'.
+    const String& messageForConsole() const { return !m_unsanitizedMessage.isEmpty() ? m_unsanitizedMessage : m_sanitizedMessage; }
+
+    const AtomicString& interfaceName() const override;
+
+    void setUnsanitizedMessage(const String&);
+
+    DECLARE_VIRTUAL_TRACE();
+
+private:
+    RequestedVisibilityEvent();
+    RequestedVisibilityEvent(const String& message);
+    RequestedVisibilityEvent(const AtomicString&, const RequestedVisibilityEventInit&);
+
+    String m_unsanitizedMessage;
+    String m_sanitizedMessage;
+};
+
+} // namespace blink
+
+#endif // RequestedVisibilityEvent_h
diff --git a/third_party/WebKit/Source/core/events/RequestedVisibilityEvent.idl b/third_party/WebKit/Source/core/events/RequestedVisibilityEvent.idl
new file mode 100644
index 0000000..aae3453
--- /dev/null
+++ b/third_party/WebKit/Source/core/events/RequestedVisibilityEvent.idl
@@ -0,0 +1,35 @@
+/*
+ * Copyright (C) 2016 Google Inc. All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions are
+ * met:
+ *
+ *     * Redistributions of source code must retain the above copyright
+ * notice, this list of conditions and the following disclaimer.
+ *     * Redistributions in binary form must reproduce the above
+ * copyright notice, this list of conditions and the following disclaimer
+ * in the documentation and/or other materials provided with the
+ * distribution.
+ *     * Neither the name of Google Inc. nor the names of its
+ * contributors may be used to endorse or promote products derived from
+ * this software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
+ * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
+ * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
+ * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
+ * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
+ * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+
+[
+    Constructor(DOMString type, optional RequestedVisibilityEventInit eventInitDict),
+] interface RequestedVisibilityEvent : Event {
+    readonly attribute DOMString message;
+};
diff --git a/third_party/WebKit/Source/core/events/RequestedVisibilityEventInit.idl b/third_party/WebKit/Source/core/events/RequestedVisibilityEventInit.idl
new file mode 100644
index 0000000..9d42ea9
--- /dev/null
+++ b/third_party/WebKit/Source/core/events/RequestedVisibilityEventInit.idl
@@ -0,0 +1,7 @@
+// Copyright 2016 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+dictionary RequestedVisibilityEventInit : EventInit {
+    DOMString message;
+};
diff --git a/third_party/WebKit/Source/core/fetch/FetchRequest.cpp b/third_party/WebKit/Source/core/fetch/FetchRequest.cpp
index c589971..b26a62d 100644
--- a/third_party/WebKit/Source/core/fetch/FetchRequest.cpp
+++ b/third_party/WebKit/Source/core/fetch/FetchRequest.cpp
@@ -30,10 +30,11 @@
 
 namespace blink {
 
-FetchRequest::FetchRequest(const ResourceRequest& resourceRequest, const AtomicString& initiator, const String& charset)
+FetchRequest::FetchRequest(const ResourceRequest& resourceRequest, const AtomicString& initiator, const String& charset, ResourceLoadPriority priority)
     : m_resourceRequest(resourceRequest)
     , m_charset(charset)
     , m_options(ResourceFetcher::defaultResourceOptions())
+    , m_priority(priority)
     , m_forPreload(false)
     , m_linkPreload(false)
     , m_preloadDiscoveryTime(0.0)
@@ -46,6 +47,7 @@ FetchRequest::FetchRequest(const ResourceRequest& resourceRequest, const AtomicS
 FetchRequest::FetchRequest(const ResourceRequest& resourceRequest, const AtomicString& initiator, const ResourceLoaderOptions& options)
     : m_resourceRequest(resourceRequest)
     , m_options(options)
+    , m_priority(ResourceLoadPriorityUnresolved)
     , m_forPreload(false)
     , m_linkPreload(false)
     , m_preloadDiscoveryTime(0.0)
@@ -58,6 +60,7 @@ FetchRequest::FetchRequest(const ResourceRequest& resourceRequest, const AtomicS
 FetchRequest::FetchRequest(const ResourceRequest& resourceRequest, const FetchInitiatorInfo& initiator)
     : m_resourceRequest(resourceRequest)
     , m_options(ResourceFetcher::defaultResourceOptions())
+    , m_priority(ResourceLoadPriorityUnresolved)
     , m_forPreload(false)
     , m_linkPreload(false)
     , m_preloadDiscoveryTime(0.0)
@@ -104,12 +107,4 @@ void FetchRequest::setForPreload(bool forPreload, double discoveryTime)
     m_preloadDiscoveryTime = discoveryTime;
 }
 
-void FetchRequest::makeSynchronous()
-{
-    // Synchronous requests should always be max priority, lest they hang the renderer.
-    m_resourceRequest.setPriority(ResourceLoadPriorityHighest);
-    m_resourceRequest.setTimeoutInterval(10);
-    m_options.synchronousPolicy = RequestSynchronously;
-}
-
 } // namespace blink
diff --git a/third_party/WebKit/Source/core/fetch/FetchRequest.h b/third_party/WebKit/Source/core/fetch/FetchRequest.h
index fda9bdf..e072017 100644
--- a/third_party/WebKit/Source/core/fetch/FetchRequest.h
+++ b/third_party/WebKit/Source/core/fetch/FetchRequest.h
@@ -32,6 +32,7 @@
 #include "core/fetch/IntegrityMetadata.h"
 #include "core/fetch/ResourceLoaderOptions.h"
 #include "platform/CrossOriginAttributeValue.h"
+#include "platform/network/ResourceLoadPriority.h"
 #include "platform/network/ResourceRequest.h"
 #include "wtf/Allocator.h"
 #include "wtf/text/AtomicString.h"
@@ -57,7 +58,7 @@ public:
         }
     };
 
-    FetchRequest(const ResourceRequest&, const AtomicString& initiator, const String& charset = String());
+    explicit FetchRequest(const ResourceRequest&, const AtomicString& initiator, const String& charset = String(), ResourceLoadPriority = ResourceLoadPriorityUnresolved);
     FetchRequest(const ResourceRequest&, const AtomicString& initiator, const ResourceLoaderOptions&);
     FetchRequest(const ResourceRequest&, const FetchInitiatorInfo&);
     ~FetchRequest();
@@ -70,6 +71,10 @@ public:
     void setCharset(const String& charset) { m_charset = charset; }
 
     const ResourceLoaderOptions& options() const { return m_options; }
+    void setOptions(const ResourceLoaderOptions& options) { m_options = options; }
+
+    ResourceLoadPriority priority() const { return m_priority; }
+    void setPriority(ResourceLoadPriority priority) { m_priority = priority; }
 
     DeferOption defer() const { return m_defer; }
     void setDefer(DeferOption defer) { m_defer = defer; }
@@ -97,12 +102,11 @@ public:
     String contentSecurityPolicyNonce() const { return m_options.contentSecurityPolicyNonce; }
     void setContentSecurityPolicyNonce(const String& nonce) { m_options.contentSecurityPolicyNonce = nonce; }
 
-    void makeSynchronous();
-
 private:
     ResourceRequest m_resourceRequest;
     String m_charset;
     ResourceLoaderOptions m_options;
+    ResourceLoadPriority m_priority;
     bool m_forPreload;
     bool m_linkPreload;
     double m_preloadDiscoveryTime;
diff --git a/third_party/WebKit/Source/core/fetch/RawResource.cpp b/third_party/WebKit/Source/core/fetch/RawResource.cpp
index 9fde91c..a29802f 100644
--- a/third_party/WebKit/Source/core/fetch/RawResource.cpp
+++ b/third_party/WebKit/Source/core/fetch/RawResource.cpp
@@ -37,7 +37,10 @@ namespace blink {
 
 Resource* RawResource::fetchSynchronously(FetchRequest& request, ResourceFetcher* fetcher)
 {
-    request.makeSynchronous();
+    request.mutableResourceRequest().setTimeoutInterval(10);
+    ResourceLoaderOptions options(request.options());
+    options.synchronousPolicy = RequestSynchronously;
+    request.setOptions(options);
     return fetcher->requestResource(request, RawResourceFactory(Resource::Raw));
 }
 
diff --git a/third_party/WebKit/Source/core/fetch/ResourceFetcher.cpp b/third_party/WebKit/Source/core/fetch/ResourceFetcher.cpp
index 5380548..76f39f1 100644
--- a/third_party/WebKit/Source/core/fetch/ResourceFetcher.cpp
+++ b/third_party/WebKit/Source/core/fetch/ResourceFetcher.cpp
@@ -134,8 +134,16 @@ static ResourceLoadPriority typeToPriority(Resource::Type type)
     return ResourceLoadPriorityUnresolved;
 }
 
-ResourceLoadPriority ResourceFetcher::computeLoadPriority(Resource::Type type, const FetchRequest& request, ResourcePriority::VisibilityStatus visibility)
+ResourceLoadPriority ResourceFetcher::loadPriority(Resource::Type type, const FetchRequest& request, ResourcePriority::VisibilityStatus visibility)
 {
+    // TODO(yoav): Change it here so that priority can be changed even after it was resolved.
+    if (request.priority() != ResourceLoadPriorityUnresolved)
+        return request.priority();
+
+    // Synchronous requests should always be max priority, lest they hang the renderer.
+    if (request.options().synchronousPolicy == RequestSynchronously)
+        return ResourceLoadPriorityHighest;
+
     ResourceLoadPriority priority = typeToPriority(type);
 
     // Visible resources (images in practice) get a boost to High priority.
@@ -158,16 +166,9 @@ ResourceLoadPriority ResourceFetcher::computeLoadPriority(Resource::Type type, c
             priority = ResourceLoadPriorityLow;
         else if (request.forPreload() && m_imageFetched)
             priority = ResourceLoadPriorityMedium;
-    } else if (FetchRequest::LazyLoad == request.defer()) {
-        // A deferred load of type Raw is a link rel=preload, which should be Low instead of VeryLow.
-        priority = type == Resource::Raw ? ResourceLoadPriorityLow : ResourceLoadPriorityVeryLow;
     }
 
-    // A manually set priority acts as a floor. This is used to ensure that synchronous requests
-    // are always given the highest possible priority, as well as to ensure that there isn't priority
-    // churn if images move in and out of the viewport, or is displayed more than once, both in and out
-    // of the viewport.
-    return std::max(context().modifyPriorityForExperiments(priority), request.resourceRequest().priority());
+    return context().modifyPriorityForExperiments(priority);
 }
 
 static void populateResourceTiming(ResourceTimingInfo* info, Resource* resource)
@@ -427,7 +428,8 @@ Resource* ResourceFetcher::requestResource(FetchRequest& request, const Resource
         return nullptr;
 
     unsigned long identifier = createUniqueIdentifier();
-    request.mutableResourceRequest().setPriority(computeLoadPriority(factory.type(), request, ResourcePriority::NotVisible));
+    request.setPriority(loadPriority(factory.type(), request, ResourcePriority::NotVisible));
+    request.mutableResourceRequest().setPriority(request.priority());
     initializeResourceRequest(request.mutableResourceRequest(), factory.type(), request.defer());
     context().willStartLoadingResource(identifier, request.mutableResourceRequest(), factory.type());
     if (!request.url().isValid())
@@ -503,8 +505,8 @@ Resource* ResourceFetcher::requestResource(FetchRequest& request, const Resource
         // isn't at the same priority as the in-flight request, only allow promotions.
         // This can happen when a visible image's priority is increased and then another
         // reference to the image is parsed (which would be at a lower priority).
-        if (request.resourceRequest().priority() > resource->resourceRequest().priority())
-            resource->didChangePriority(request.resourceRequest().priority(), 0);
+        if (request.priority() > resource->resourceRequest().priority())
+            resource->didChangePriority(request.priority(), 0);
     }
 
     // If only the fragment identifiers differ, it is the same resource.
@@ -694,11 +696,6 @@ ResourceFetcher::RevalidationPolicy ResourceFetcher::determineRevalidationPolicy
     if (request.downloadToFile() || request.useStreamOnResponse())
         return Reload;
 
-    // Never reuse opaque responses from a service worker for requests that
-    // are not no-cors. https://crbug.com/625575
-    if (existingResource->response().wasFetchedViaServiceWorker() && existingResource->response().serviceWorkerResponseType() == WebServiceWorkerResponseTypeOpaque && request.fetchRequestMode() != WebURLRequest::FetchRequestModeNoCORS)
-        return Reload;
-
     // If resource was populated from a SubstituteData load or data: url, use it.
     if (isStaticData)
         return Use;
@@ -1130,7 +1127,7 @@ void ResourceFetcher::updateAllImageResourcePriorities()
             continue;
 
         ResourcePriority resourcePriority = resource->priorityFromObservers();
-        ResourceLoadPriority resourceLoadPriority = computeLoadPriority(Resource::Image, FetchRequest(resource->resourceRequest(), FetchInitiatorInfo()), resourcePriority.visibility);
+        ResourceLoadPriority resourceLoadPriority = loadPriority(Resource::Image, FetchRequest(resource->resourceRequest(), FetchInitiatorInfo()), resourcePriority.visibility);
         if (resourceLoadPriority == resource->resourceRequest().priority())
             continue;
 
diff --git a/third_party/WebKit/Source/core/fetch/ResourceFetcher.h b/third_party/WebKit/Source/core/fetch/ResourceFetcher.h
index b10027b..5c6177d 100644
--- a/third_party/WebKit/Source/core/fetch/ResourceFetcher.h
+++ b/third_party/WebKit/Source/core/fetch/ResourceFetcher.h
@@ -122,6 +122,8 @@ public:
 
     void acceptDataFromThreadedReceiver(unsigned long identifier, const char* data, int dataLength, int encodedDataLength);
 
+    ResourceLoadPriority loadPriority(Resource::Type, const FetchRequest&, ResourcePriority::VisibilityStatus = ResourcePriority::NotVisible);
+
     enum ResourceLoadStartType {
         ResourceLoadingFromNetwork,
         ResourceLoadingFromCache
@@ -149,7 +151,6 @@ private:
     void initializeRevalidation(ResourceRequest&, Resource*);
     Resource* createResourceForLoading(FetchRequest&, const String& charset, const ResourceFactory&);
     void storeResourceTimingInitiatorInformation(Resource*);
-    ResourceLoadPriority computeLoadPriority(Resource::Type, const FetchRequest&, ResourcePriority::VisibilityStatus);
 
     Resource* resourceForStaticData(const FetchRequest&, const ResourceFactory&, const SubstituteData&);
 
diff --git a/third_party/WebKit/Source/core/fetch/XSLStyleSheetResource.cpp b/third_party/WebKit/Source/core/fetch/XSLStyleSheetResource.cpp
index 95f76de..589c162 100644
--- a/third_party/WebKit/Source/core/fetch/XSLStyleSheetResource.cpp
+++ b/third_party/WebKit/Source/core/fetch/XSLStyleSheetResource.cpp
@@ -50,7 +50,10 @@ static void applyXSLRequestProperties(ResourceRequest& request)
 XSLStyleSheetResource* XSLStyleSheetResource::fetchSynchronously(FetchRequest& request, ResourceFetcher* fetcher)
 {
     applyXSLRequestProperties(request.mutableResourceRequest());
-    request.makeSynchronous();
+    request.mutableResourceRequest().setTimeoutInterval(10);
+    ResourceLoaderOptions options(request.options());
+    options.synchronousPolicy = RequestSynchronously;
+    request.setOptions(options);
     XSLStyleSheetResource* resource = toXSLStyleSheetResource(fetcher->requestResource(request, XSLStyleSheetResourceFactory()));
     if (resource && resource->data())
         resource->m_sheet = resource->decodedText();
diff --git a/third_party/WebKit/Source/core/frame/Deprecation.cpp b/third_party/WebKit/Source/core/frame/Deprecation.cpp
index fe52c71..403de9e 100644
--- a/third_party/WebKit/Source/core/frame/Deprecation.cpp
+++ b/third_party/WebKit/Source/core/frame/Deprecation.cpp
@@ -367,6 +367,9 @@ String Deprecation::deprecationMessage(UseCounter::Feature feature)
     case UseCounter::EncryptedMediaAllSelectedContentTypesMissingCodecs:
         return String::format("EME requires that contentType strings accepted by requestMediaKeySystemAccess() include codecs. Non-standard support for contentType strings without codecs will be removed in %s. Please specify the desired codec(s) as part of the contentType.", milestoneString(54));
 
+    case UseCounter::During_Microtask_SyncXHR:
+        return willBeRemoved("Invoking 'send()' on a sync XHR during microtask execution", 54, "5647113010544640");
+
     case UseCounter::UntrustedEventDefaultHandled:
         return String::format("A DOM event generated from JavaScript has triggered a default action inside the browser. This behavior is non-standard and will be removed in %s. See https://www.chromestatus.com/features/5718803933560832 for more details.", milestoneString(53));
 
diff --git a/third_party/WebKit/Source/core/frame/FrameView.cpp b/third_party/WebKit/Source/core/frame/FrameView.cpp
index 44f2446..fba68e8 100644
--- a/third_party/WebKit/Source/core/frame/FrameView.cpp
+++ b/third_party/WebKit/Source/core/frame/FrameView.cpp
@@ -40,6 +40,7 @@
 #include "core/editing/markers/DocumentMarkerController.h"
 #include "core/fetch/ResourceFetcher.h"
 #include "core/frame/EventHandlerRegistry.h"
+#include "core/frame/FrameConsole.h"
 #include "core/frame/FrameHost.h"
 #include "core/frame/LocalFrame.h"
 #include "core/frame/Location.h"
@@ -2541,6 +2542,15 @@ void FrameView::updateLifecyclePhasesInternal(DocumentLifecycle::LifecycleState
             // This was required for slimming paint v1 but is only temporarily
             // needed for slimming paint v2.
             view.compositor()->updateIfNeededRecursive();
+
+	    Document *d = frame().document();
+	    VisibilityDocumentSet *ds = d->requestedVisibility();
+	    if (ds != nullptr) {
+		for(Document *reqdoc : *ds){
+		    reqdoc->requestVisibilityImpl();
+		}
+	    }
+
             scrollContentsIfNeededRecursive();
 
             DCHECK(lifecycle().state() >= DocumentLifecycle::CompositingClean);
@@ -3033,21 +3043,21 @@ void FrameView::trackObjectPaintInvalidation(const DisplayItemClient& client, Pa
     m_trackedObjectPaintInvalidations->append(invalidation);
 }
 
-std::unique_ptr<JSONArray> FrameView::trackedObjectPaintInvalidationsAsJSON() const
+PassRefPtr<JSONArray> FrameView::trackedObjectPaintInvalidationsAsJSON() const
 {
     if (!m_trackedObjectPaintInvalidations)
         return nullptr;
 
-    std::unique_ptr<JSONArray> result = JSONArray::create();
+    RefPtr<JSONArray> result = JSONArray::create();
     for (Frame* frame = m_frame->tree().top(); frame; frame = frame->tree().traverseNext()) {
         if (!frame->isLocalFrame())
             continue;
         if (LayoutViewItem layoutView = toLocalFrame(frame)->contentLayoutItem()) {
             for (const auto& item : *layoutView.frameView()->m_trackedObjectPaintInvalidations) {
-                std::unique_ptr<JSONObject> itemJSON = JSONObject::create();
+                RefPtr<JSONObject> itemJSON = JSONObject::create();
                 itemJSON->setString("object", item.name);
                 itemJSON->setString("reason", paintInvalidationReasonToString(item.reason));
-                result->pushObject(std::move(itemJSON));
+                result->pushObject(itemJSON);
             }
         }
     }
diff --git a/third_party/WebKit/Source/core/frame/FrameView.h b/third_party/WebKit/Source/core/frame/FrameView.h
index eccd1cb..9511bd3 100644
--- a/third_party/WebKit/Source/core/frame/FrameView.h
+++ b/third_party/WebKit/Source/core/frame/FrameView.h
@@ -327,7 +327,7 @@ public:
     void setTracksPaintInvalidations(bool);
     bool isTrackingPaintInvalidations() const { return m_trackedObjectPaintInvalidations.get(); }
     void trackObjectPaintInvalidation(const DisplayItemClient&, PaintInvalidationReason);
-    std::unique_ptr<JSONArray> trackedObjectPaintInvalidationsAsJSON() const;
+    PassRefPtr<JSONArray> trackedObjectPaintInvalidationsAsJSON() const;
 
     using ScrollableAreaSet = HeapHashSet<Member<ScrollableArea>>;
     void addScrollableArea(ScrollableArea*);
diff --git a/third_party/WebKit/Source/core/frame/FrameViewTest.cpp b/third_party/WebKit/Source/core/frame/FrameViewTest.cpp
index 5438ffa..f567725 100644
--- a/third_party/WebKit/Source/core/frame/FrameViewTest.cpp
+++ b/third_party/WebKit/Source/core/frame/FrameViewTest.cpp
@@ -38,9 +38,7 @@ public:
     bool m_hasScheduledAnimation;
 };
 
-class FrameViewTestBase
-    : public testing::Test
-    , public testing::WithParamInterface<FrameSettingOverrideFunction> {
+class FrameViewTestBase : public testing::Test {
 protected:
     FrameViewTestBase()
         : m_chromeClient(new MockChromeClient)
@@ -58,8 +56,6 @@ protected:
         clients.chromeClient = m_chromeClient.get();
         m_pageHolder = DummyPageHolder::create(IntSize(800, 600), &clients);
         m_pageHolder->page().settings().setAcceleratedCompositingEnabled(true);
-        if (GetParam())
-            (*GetParam())(m_pageHolder->page().settings());
     }
 
     Document& document() { return m_pageHolder->document(); }
@@ -104,25 +100,17 @@ private:
     RuntimeEnabledFeatures::Backup m_featuresBackup;
 };
 
-INSTANTIATE_TEST_CASE_P(All, FrameViewTest, ::testing::Values(
-    nullptr,
-    &RootLayerScrollsFrameSettingOverride));
-
-INSTANTIATE_TEST_CASE_P(All, FrameViewSlimmingPaintV2Test, ::testing::Values(
-    nullptr,
-    &RootLayerScrollsFrameSettingOverride));
-
 // These tests ensure that FrameView informs the ChromeClient of changes to the
 // paint artifact so that they can be shown to the user (e.g. via the
 // compositor).
-TEST_P(FrameViewSlimmingPaintV2Test, PaintOnce)
+TEST_F(FrameViewSlimmingPaintV2Test, PaintOnce)
 {
     EXPECT_CALL(chromeClient(), didPaint(_));
     document().body()->setInnerHTML("Hello world", ASSERT_NO_EXCEPTION);
     document().view()->updateAllLifecyclePhases();
 }
 
-TEST_P(FrameViewSlimmingPaintV2Test, PaintAndRepaint)
+TEST_F(FrameViewSlimmingPaintV2Test, PaintAndRepaint)
 {
     EXPECT_CALL(chromeClient(), didPaint(_)).Times(2);
     document().body()->setInnerHTML("Hello", ASSERT_NO_EXCEPTION);
@@ -131,7 +119,7 @@ TEST_P(FrameViewSlimmingPaintV2Test, PaintAndRepaint)
     document().view()->updateAllLifecyclePhases();
 }
 
-TEST_P(FrameViewTest, SetPaintInvalidationDuringUpdateAllLifecyclePhases)
+TEST_F(FrameViewTest, SetPaintInvalidationDuringUpdateAllLifecyclePhases)
 {
     document().body()->setInnerHTML("<div id='a' style='color: blue'>A</div>", ASSERT_NO_EXCEPTION);
     document().view()->updateAllLifecyclePhases();
@@ -141,7 +129,7 @@ TEST_P(FrameViewTest, SetPaintInvalidationDuringUpdateAllLifecyclePhases)
     EXPECT_FALSE(chromeClient().m_hasScheduledAnimation);
 }
 
-TEST_P(FrameViewTest, SetPaintInvalidationOutOfUpdateAllLifecyclePhases)
+TEST_F(FrameViewTest, SetPaintInvalidationOutOfUpdateAllLifecyclePhases)
 {
     document().body()->setInnerHTML("<div id='a' style='color: blue'>A</div>", ASSERT_NO_EXCEPTION);
     document().view()->updateAllLifecyclePhases();
@@ -158,13 +146,13 @@ TEST_P(FrameViewTest, SetPaintInvalidationOutOfUpdateAllLifecyclePhases)
 
 // If we don't hide the tooltip on scroll, it can negatively impact scrolling
 // performance. See crbug.com/586852 for details.
-TEST_P(FrameViewTest, HideTooltipWhenScrollPositionChanges)
+TEST_F(FrameViewTest, HideTooltipWhenScrollPositionChanges)
 {
     document().body()->setInnerHTML("<div style='width:1000px;height:1000px'></div>", ASSERT_NO_EXCEPTION);
     document().view()->updateAllLifecyclePhases();
 
     EXPECT_CALL(chromeClient(), setToolTip(String(), _));
-    document().view()->layoutViewportScrollableArea()->setScrollPosition(DoublePoint(1, 1), UserScroll);
+    document().view()->setScrollPosition(DoublePoint(1, 1), UserScroll);
 }
 
 } // namespace
diff --git a/third_party/WebKit/Source/core/frame/LocalFrame.cpp b/third_party/WebKit/Source/core/frame/LocalFrame.cpp
index 573e327..c8864ba 100644
--- a/third_party/WebKit/Source/core/frame/LocalFrame.cpp
+++ b/third_party/WebKit/Source/core/frame/LocalFrame.cpp
@@ -783,14 +783,14 @@ String LocalFrame::layerTreeAsText(unsigned flags) const
     if (contentLayoutItem().isNull())
         return String();
 
-    std::unique_ptr<JSONObject> layerTree = contentLayoutItem().compositor()->layerTreeAsJSON(static_cast<LayerTreeFlags>(flags));
+    RefPtr<JSONObject> layerTree = contentLayoutItem().compositor()->layerTreeAsJSON(static_cast<LayerTreeFlags>(flags));
 
     if (flags & LayerTreeIncludesPaintInvalidations) {
-        std::unique_ptr<JSONArray> objectPaintInvalidations = m_view->trackedObjectPaintInvalidationsAsJSON();
-        if (objectPaintInvalidations && objectPaintInvalidations->size()) {
+        RefPtr<JSONArray> objectPaintInvalidations = m_view->trackedObjectPaintInvalidationsAsJSON();
+        if (objectPaintInvalidations && objectPaintInvalidations->length()) {
             if (!layerTree)
                 layerTree = JSONObject::create();
-            layerTree->setArray("objectPaintInvalidations", std::move(objectPaintInvalidations));
+            layerTree->setArray("objectPaintInvalidations", objectPaintInvalidations);
         }
     }
 
diff --git a/third_party/WebKit/Source/core/frame/UseCounter.h b/third_party/WebKit/Source/core/frame/UseCounter.h
index 944166c..c82c293 100644
--- a/third_party/WebKit/Source/core/frame/UseCounter.h
+++ b/third_party/WebKit/Source/core/frame/UseCounter.h
@@ -1259,6 +1259,8 @@ public:
         SVGSMILAdditiveAnimation = 1484,
         SendBeaconWithNonSimpleContentType = 1485,
 
+        DocumentCreateEventRequestedVisibilityEvent = 1500,
+
         // Add new features immediately above this line. Don't change assigned
         // numbers of any item, and don't reuse removed slots.
         // Also, run update_use_counter_feature_enum.py in chromium/src/tools/metrics/histograms/
diff --git a/third_party/WebKit/Source/core/frame/csp/ContentSecurityPolicy.cpp b/third_party/WebKit/Source/core/frame/csp/ContentSecurityPolicy.cpp
index 2df2524..743d7bf 100644
--- a/third_party/WebKit/Source/core/frame/csp/ContentSecurityPolicy.cpp
+++ b/third_party/WebKit/Source/core/frame/csp/ContentSecurityPolicy.cpp
@@ -878,7 +878,7 @@ void ContentSecurityPolicy::reportViolation(const String& directiveText, const S
     // sent explicitly. As for which directive was violated, that's pretty
     // harmless information.
 
-    std::unique_ptr<JSONObject> cspReport = JSONObject::create();
+    RefPtr<JSONObject> cspReport = JSONObject::create();
     cspReport->setString("document-uri", violationData.documentURI());
     cspReport->setString("referrer", violationData.referrer());
     cspReport->setString("violated-directive", violationData.violatedDirective());
@@ -886,15 +886,15 @@ void ContentSecurityPolicy::reportViolation(const String& directiveText, const S
     cspReport->setString("original-policy", violationData.originalPolicy());
     cspReport->setString("blocked-uri", violationData.blockedURI());
     if (violationData.lineNumber())
-        cspReport->setInteger("line-number", violationData.lineNumber());
+        cspReport->setNumber("line-number", violationData.lineNumber());
     if (violationData.columnNumber())
-        cspReport->setInteger("column-number", violationData.columnNumber());
+        cspReport->setNumber("column-number", violationData.columnNumber());
     if (!violationData.sourceFile().isEmpty())
         cspReport->setString("source-file", violationData.sourceFile());
-    cspReport->setInteger("status-code", violationData.statusCode());
+    cspReport->setNumber("status-code", violationData.statusCode());
 
-    std::unique_ptr<JSONObject> reportObject = JSONObject::create();
-    reportObject->setObject("csp-report", std::move(cspReport));
+    RefPtr<JSONObject> reportObject = JSONObject::create();
+    reportObject->setObject("csp-report", cspReport.release());
     String stringifiedReport = reportObject->toJSONString();
 
     if (!shouldSendViolationReport(stringifiedReport))
diff --git a/third_party/WebKit/Source/core/html/LinkResource.cpp b/third_party/WebKit/Source/core/html/LinkResource.cpp
index d210526..3a5b0fe 100644
--- a/third_party/WebKit/Source/core/html/LinkResource.cpp
+++ b/third_party/WebKit/Source/core/html/LinkResource.cpp
@@ -77,9 +77,8 @@ LinkRequestBuilder::LinkRequestBuilder(HTMLLinkElement* owner)
 
 FetchRequest LinkRequestBuilder::build(bool lowPriority) const
 {
-    FetchRequest request(ResourceRequest(m_owner->document().completeURL(m_url)), m_owner->localName(), m_charset);
-    if (lowPriority)
-        request.setDefer(FetchRequest::LazyLoad);
+    ResourceLoadPriority priority = lowPriority ? ResourceLoadPriorityVeryLow : ResourceLoadPriorityUnresolved;
+    FetchRequest request(ResourceRequest(m_owner->document().completeURL(m_url)), m_owner->localName(), m_charset, priority);
     request.setContentSecurityPolicyNonce(m_owner->fastGetAttribute(HTMLNames::nonceAttr));
     return request;
 }
diff --git a/third_party/WebKit/Source/core/html/parser/XSSAuditorDelegate.cpp b/third_party/WebKit/Source/core/html/parser/XSSAuditorDelegate.cpp
index aaef92f..4b3b949 100644
--- a/third_party/WebKit/Source/core/html/parser/XSSAuditorDelegate.cpp
+++ b/third_party/WebKit/Source/core/html/parser/XSSAuditorDelegate.cpp
@@ -90,12 +90,12 @@ PassRefPtr<EncodedFormData> XSSAuditorDelegate::generateViolationReport(const XS
             httpBody = formData->flattenToString();
     }
 
-    std::unique_ptr<JSONObject> reportDetails = JSONObject::create();
+    RefPtr<JSONObject> reportDetails = JSONObject::create();
     reportDetails->setString("request-url", xssInfo.m_originalURL);
     reportDetails->setString("request-body", httpBody);
 
-    std::unique_ptr<JSONObject> reportObject = JSONObject::create();
-    reportObject->setObject("xss-report", std::move(reportDetails));
+    RefPtr<JSONObject> reportObject = JSONObject::create();
+    reportObject->setObject("xss-report", reportDetails.release());
 
     return EncodedFormData::create(reportObject->toJSONString().utf8().data());
 }
diff --git a/third_party/WebKit/Source/core/inspector/MainThreadDebugger.cpp b/third_party/WebKit/Source/core/inspector/MainThreadDebugger.cpp
index 16d1cfe..004a393 100644
--- a/third_party/WebKit/Source/core/inspector/MainThreadDebugger.cpp
+++ b/third_party/WebKit/Source/core/inspector/MainThreadDebugger.cpp
@@ -61,7 +61,6 @@
 #include "core/xml/XPathEvaluator.h"
 #include "core/xml/XPathResult.h"
 #include "platform/UserGestureIndicator.h"
-#include "platform/inspector_protocol/Values.h"
 #include "platform/v8_inspector/public/V8Inspector.h"
 #include "wtf/PtrUtil.h"
 #include "wtf/ThreadingPrimitives.h"
@@ -146,15 +145,7 @@ void MainThreadDebugger::contextCreated(ScriptState* scriptState, LocalFrame* fr
     ASSERT(isMainThread());
     v8::HandleScope handles(scriptState->isolate());
     DOMWrapperWorld& world = scriptState->world();
-    std::unique_ptr<protocol::DictionaryValue> auxData = protocol::DictionaryValue::create();
-    auxData->setBoolean("isDefault", world.isMainWorld());
-    auxData->setString("frameId", IdentifiersFactory::frameId(frame));
-    V8ContextInfo contextInfo(scriptState->context(), contextGroupId(frame), world.isIsolatedWorld() ? world.isolatedWorldHumanReadableName() : "");
-    if (origin)
-        contextInfo.origin = origin->toRawString();
-    contextInfo.auxData = auxData->toJSONString();
-    contextInfo.hasMemoryOnConsole = scriptState->getExecutionContext()->isDocument();
-    v8Inspector()->contextCreated(contextInfo);
+    v8Inspector()->contextCreated(V8ContextInfo(scriptState->context(), contextGroupId(frame), world.isMainWorld(), origin ? origin->toRawString() : "", world.isIsolatedWorld() ? world.isolatedWorldHumanReadableName() : "", IdentifiersFactory::frameId(frame), scriptState->getExecutionContext()->isDocument()));
 }
 
 void MainThreadDebugger::contextWillBeDestroyed(ScriptState* scriptState)
diff --git a/third_party/WebKit/Source/core/inspector/WorkerThreadDebugger.cpp b/third_party/WebKit/Source/core/inspector/WorkerThreadDebugger.cpp
index 131b2dc..3e4ab96 100644
--- a/third_party/WebKit/Source/core/inspector/WorkerThreadDebugger.cpp
+++ b/third_party/WebKit/Source/core/inspector/WorkerThreadDebugger.cpp
@@ -86,9 +86,7 @@ int WorkerThreadDebugger::contextGroupId(ExecutionContext* context)
 
 void WorkerThreadDebugger::contextCreated(v8::Local<v8::Context> context)
 {
-    V8ContextInfo contextInfo(context, workerContextGroupId, "");
-    contextInfo.origin = m_workerThread->globalScope()->url().getString();
-    v8Inspector()->contextCreated(contextInfo);
+    v8Inspector()->contextCreated(V8ContextInfo(context, workerContextGroupId, true, m_workerThread->globalScope()->url().getString(), "", "", false));
 }
 
 void WorkerThreadDebugger::contextWillBeDestroyed(v8::Local<v8::Context> context)
diff --git a/third_party/WebKit/Source/core/layout/LayoutBox.cpp b/third_party/WebKit/Source/core/layout/LayoutBox.cpp
index 6a19f03..7a73957 100644
--- a/third_party/WebKit/Source/core/layout/LayoutBox.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutBox.cpp
@@ -1013,13 +1013,12 @@ bool LayoutBox::mapScrollingContentsRectToBoxSpace(LayoutRect& rect, ApplyOverfl
     if (!hasOverflowClip())
         return true;
 
-    if (applyOverflowClip == ApplyNonScrollOverflowClip && scrollsOverflow()) {
-        return true;
-    }
-
     LayoutSize offset = LayoutSize(-scrolledContentOffset());
     rect.move(offset);
 
+    if (applyOverflowClip == ApplyNonScrollOverflowClip && scrollsOverflow())
+        return true;
+
     LayoutRect clipRect = overflowClipRect(LayoutPoint());
 
     bool doesIntersect;
@@ -2043,7 +2042,7 @@ bool LayoutBox::paintedOutputOfObjectHasNoEffect() const
         return false;
 
     // Cannot skip paint invalidation if the box has real things to paint.
-    if (getSelectionState() != SelectionNone || hasBoxDecorationBackground() || styleRef().hasBoxDecorations() || styleRef().hasVisualOverflowingEffect())
+    if (getSelectionState() != SelectionNone || hasBoxDecorationBackground() || styleRef().hasVisualOverflowingEffect())
         return false;
 
     // If the box has clip, we need issue a paint invalidation to cover the changed part of
@@ -4056,7 +4055,7 @@ PaintInvalidationReason LayoutBox::getPaintInvalidationReason(const PaintInvalid
     if (oldBorderBoxSize.height() != newBorderBoxSize.height() && mustInvalidateBackgroundOrBorderPaintOnHeightChange())
         return PaintInvalidationBorderBoxChange;
 
-    return styleRef().hasBackground() || styleRef().hasBoxDecorations() ? PaintInvalidationIncremental : invalidationReason;
+    return PaintInvalidationIncremental;
 }
 
 void LayoutBox::incrementallyInvalidatePaint(const LayoutBoxModelObject& paintInvalidationContainer, const LayoutRect& oldBounds, const LayoutRect& newBounds, const LayoutPoint& positionFromPaintInvalidationBacking)
diff --git a/third_party/WebKit/Source/core/layout/LayoutBox.h b/third_party/WebKit/Source/core/layout/LayoutBox.h
index 99c342b..d7aab38 100644
--- a/third_party/WebKit/Source/core/layout/LayoutBox.h
+++ b/third_party/WebKit/Source/core/layout/LayoutBox.h
@@ -50,7 +50,6 @@ enum ShouldComputePreferred { ComputeActual, ComputePreferred };
 
 enum ApplyOverflowClipFlag {
     ApplyOverflowClip,
-    // Don't apply overflow clipping or scrolling.
     ApplyNonScrollOverflowClip
 };
 
diff --git a/third_party/WebKit/Source/core/layout/LayoutBoxModelObject.cpp b/third_party/WebKit/Source/core/layout/LayoutBoxModelObject.cpp
index dc0d617..a1dcdcd 100644
--- a/third_party/WebKit/Source/core/layout/LayoutBoxModelObject.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutBoxModelObject.cpp
@@ -407,8 +407,7 @@ void LayoutBoxModelObject::invalidateTreeIfNeeded(const PaintInvalidationState&
     if (!RuntimeEnabledFeatures::slimmingPaintV2Enabled()
         && previousPaintInvalidationRect != this->previousPaintInvalidationRect()
         && !usesCompositedScrolling()
-        // Note that isLayoutView() below becomes unnecessary after the launch of root layer scrolling.
-        && (hasOverflowClip() || isLayoutView()))
+        && hasOverflowClip())
         newPaintInvalidationState.setForceSubtreeInvalidationRectUpdateWithinContainer();
 
     newPaintInvalidationState.updateForChildren(reason);
diff --git a/third_party/WebKit/Source/core/layout/LayoutFlexibleBox.cpp b/third_party/WebKit/Source/core/layout/LayoutFlexibleBox.cpp
index bac80ee..feffbf8 100644
--- a/third_party/WebKit/Source/core/layout/LayoutFlexibleBox.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutFlexibleBox.cpp
@@ -1248,7 +1248,7 @@ bool LayoutFlexibleBox::computeNextFlexLine(OrderedFlexItemList& orderedChildren
         // run layout on it now to make sure its logical height and scroll bars are up to date.
         if (childHasIntrinsicMainAxisSize(*child) && child->needsLayout()) {
             child->clearOverrideSize();
-            child->forceChildLayout();
+            child->layoutIfNeeded();
             cacheChildMainSize(*child);
             layoutType = LayoutIfNeeded;
         }
diff --git a/third_party/WebKit/Source/core/layout/LayoutObject.cpp b/third_party/WebKit/Source/core/layout/LayoutObject.cpp
index 56fcdca..fbabc29 100644
--- a/third_party/WebKit/Source/core/layout/LayoutObject.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutObject.cpp
@@ -118,14 +118,14 @@ LayoutObject::SetLayoutNeededForbiddenScope::~SetLayoutNeededForbiddenScope()
 
 struct SameSizeAsLayoutObject : DisplayItemClient {
     virtual ~SameSizeAsLayoutObject() { } // Allocate vtable pointer.
+    LayoutPoint position;
+    LayoutRect rect;
     void* pointers[6];
 #if ENABLE(ASSERT)
     unsigned m_debugBitfields : 2;
 #endif
     unsigned m_bitfields;
     unsigned m_bitfields2;
-    LayoutRect rect; // Stores the previous paint invalidation rect.
-    LayoutPoint position; // Stores the previous position from the paint invalidation container.
 };
 
 static_assert(sizeof(LayoutObject) == sizeof(SameSizeAsLayoutObject), "LayoutObject should stay small");
@@ -1210,18 +1210,6 @@ bool LayoutObject::compositedScrollsWithRespectTo(const LayoutBoxModelObject& pa
     return paintInvalidationContainer.usesCompositedScrolling() && this != &paintInvalidationContainer;
 }
 
-IntSize LayoutObject::scrollAdjustmentForPaintInvalidation(const LayoutBoxModelObject& paintInvalidationContainer) const
-{
-    // Non-composited scrolling should be included in the bounds of scrolled items. Since mapToVisualRectInAncestorSpace does not include
-    // scrolling of the ancestor, we need to add it back in after.
-    if (paintInvalidationContainer.isBox() && !paintInvalidationContainer.usesCompositedScrolling() && this != &paintInvalidationContainer) {
-        const LayoutBox* box = toLayoutBox(&paintInvalidationContainer);
-        if (box->hasOverflowClip())
-            return -box->scrolledContentOffset();
-    }
-    return IntSize();
-}
-
 void LayoutObject::invalidatePaintRectangle(const LayoutRect& dirtyRect) const
 {
     RELEASE_ASSERT(isRooted());
@@ -1235,7 +1223,12 @@ void LayoutObject::invalidatePaintRectangle(const LayoutRect& dirtyRect) const
     const LayoutBoxModelObject& paintInvalidationContainer = containerForPaintInvalidation();
     LayoutRect dirtyRectOnBacking = dirtyRect;
     PaintLayer::mapRectToPaintInvalidationBacking(*this, paintInvalidationContainer, dirtyRectOnBacking);
-    dirtyRectOnBacking.move(scrollAdjustmentForPaintInvalidation(paintInvalidationContainer));
+
+    // Composited scrolling should not be included in the bounds of composited-scrolled items.
+    if (compositedScrollsWithRespectTo(paintInvalidationContainer)) {
+        LayoutSize inverseOffset(toLayoutBox(&paintInvalidationContainer)->scrolledContentOffset());
+        dirtyRectOnBacking.move(inverseOffset);
+    }
 
     invalidatePaintUsingContainer(paintInvalidationContainer, dirtyRectOnBacking, PaintInvalidationRectangle);
 
@@ -1325,10 +1318,16 @@ inline void LayoutObject::invalidateSelectionIfNeeded(const LayoutBoxModelObject
 
     LayoutRect oldSelectionRect = previousSelectionRectForPaintInvalidation();
     LayoutRect newSelectionRect = localSelectionRect();
-    if (!newSelectionRect.isEmpty())
+    if (!newSelectionRect.isEmpty()) {
         paintInvalidationState.mapLocalRectToPaintInvalidationBacking(newSelectionRect);
 
-    newSelectionRect.move(scrollAdjustmentForPaintInvalidation(paintInvalidationContainer));
+        // Composited scrolling should not be included in the bounds and position tracking, because the graphics layer backing the scroller
+        // does not move on scroll.
+        if (compositedScrollsWithRespectTo(paintInvalidationContainer)) {
+            LayoutSize inverseOffset(toLayoutBox(&paintInvalidationContainer)->scrolledContentOffset());
+            newSelectionRect.move(inverseOffset);
+        }
+    }
 
     setPreviousSelectionRectForPaintInvalidation(newSelectionRect);
 
@@ -1360,9 +1359,14 @@ PaintInvalidationReason LayoutObject::invalidatePaintIfNeeded(const PaintInvalid
     LayoutRect newBounds = paintInvalidationState.computePaintInvalidationRectInBacking();
     LayoutPoint newLocation = RuntimeEnabledFeatures::slimmingPaintInvalidationEnabled() ? LayoutPoint() : paintInvalidationState.computePositionFromPaintInvalidationBacking();
 
-    IntSize adjustment = scrollAdjustmentForPaintInvalidation(paintInvalidationContainer);
-    newLocation.move(adjustment);
-    newBounds.move(adjustment);
+    // Composited scrolling should not be included in the bounds and position tracking, because the graphics layer backing the scroller
+    // does not move on scroll.
+    // TODO(chrishtr): can we just avoid adding in the scroll in the first place in LayoutBox::mapScrollingContentsRectToBoxSpace?
+    if (compositedScrollsWithRespectTo(paintInvalidationContainer)) {
+        LayoutSize inverseOffset(toLayoutBox(&paintInvalidationContainer)->scrolledContentOffset());
+        newLocation.move(inverseOffset);
+        newBounds.move(inverseOffset);
+    }
 
     setPreviousPaintInvalidationRect(newBounds);
     if (!RuntimeEnabledFeatures::slimmingPaintInvalidationEnabled())
@@ -3456,45 +3460,41 @@ namespace {
 
 // TODO(trchen): Use std::function<void, LayoutObject&> when available.
 template <typename LayoutObjectTraversalFunctor>
-void traverseNonCompositingDescendantsInPaintOrder(LayoutObject&, const LayoutObjectTraversalFunctor&);
+void traverseNonCompositingDescendants(LayoutObject&, const LayoutObjectTraversalFunctor&);
 
 template <typename LayoutObjectTraversalFunctor>
-void traverseNonCompositingDescendantsBelongingToAncestorPaintInvalidationContainer(LayoutObject& object, const LayoutObjectTraversalFunctor& functor)
+void findNonCompositedDescendantLayerToTraverse(LayoutObject& object, const LayoutObjectTraversalFunctor& functor)
 {
-    // |object| is a paint invalidation container but is not a stacking context, so the paint
-    // invalidation container of stacked descendants don't belong to |object| but belong to
-    // an ancestor. This function traverses all such descendants.
-    DCHECK(object.isPaintInvalidationContainer() && !object.styleRef().isStackingContext());
-
     LayoutObject* descendant = object.nextInPreOrder(&object);
     while (descendant) {
-        if (!descendant->hasLayer() || !descendant->styleRef().isStacked()) {
-            // Case 1: The descendant is not stacked (or is stacked but has not been
-            // allocated a layer yet during style change), so either it's a paint invalidation
-            // container in the same situation as |object|, or its paint invalidation
-            // container is in such situation. Keep searching until a stacked layer is found.
+        // Case 1: If the descendant has no layer, keep searching until we find a layer.
+        if (!descendant->hasLayer()) {
             descendant = descendant->nextInPreOrder(&object);
-        } else if (!descendant->isPaintInvalidationContainer()) {
-            // Case 2: The descendant is stacked and is not composited.
-            // The invalidation container of its subtree is our ancestor,
-            // thus recur into the subtree.
-            traverseNonCompositingDescendantsInPaintOrder(*descendant, functor);
+            continue;
+        }
+        // Case 2: The descendant has a layer and is not composited.
+        // The invalidation container of its subtree is our parent,
+        // thus recur into the subtree.
+        if (!descendant->isPaintInvalidationContainer()) {
+            traverseNonCompositingDescendants(*descendant, functor);
             descendant = descendant->nextInPreOrderAfterChildren(&object);
-        } else if (descendant->styleRef().isStackingContext()) {
-            // Case 3: The descendant is an invalidation container and is a stacking context.
-            // No objects in the subtree can have invalidation container outside of it,
-            // thus skip the whole subtree.
+            continue;
+        }
+        // Case 3: The descendant is an invalidation container and is a stacking context.
+        // No objects in the subtree can have invalidation container outside of it,
+        // thus skip the whole subtree.
+        if (descendant->styleRef().isStackingContext()) {
             descendant = descendant->nextInPreOrderAfterChildren(&object);
-        } else {
-            // Case 4: The descendant is an invalidation container but not a stacking context.
-            // This is the same situation as |object|, thus keep searching.
-            descendant = descendant->nextInPreOrder(&object);
+            continue;
         }
+        // Case 4: The descendant is an invalidation container but not a stacking context.
+        // This is the same situation as the root, thus keep searching.
+        descendant = descendant->nextInPreOrder(&object);
     }
 }
 
 template <typename LayoutObjectTraversalFunctor>
-void traverseNonCompositingDescendantsInPaintOrder(LayoutObject& object, const LayoutObjectTraversalFunctor& functor)
+void traverseNonCompositingDescendants(LayoutObject& object, const LayoutObjectTraversalFunctor& functor)
 {
     functor(object);
     LayoutObject* descendant = object.nextInPreOrder(&object);
@@ -3502,17 +3502,17 @@ void traverseNonCompositingDescendantsInPaintOrder(LayoutObject& object, const L
         if (!descendant->isPaintInvalidationContainer()) {
             functor(*descendant);
             descendant = descendant->nextInPreOrder(&object);
-        } else if (descendant->styleRef().isStackingContext()) {
-            // The descendant is an invalidation container and is a stacking context.
-            // No objects in the subtree can have invalidation container outside of it,
-            // thus skip the whole subtree.
-            descendant = descendant->nextInPreOrderAfterChildren(&object);
-        } else {
-            // If a paint invalidation container is not a stacking context,
-            // some of its descendants may belong to the parent container.
-            traverseNonCompositingDescendantsBelongingToAncestorPaintInvalidationContainer(*descendant, functor);
+            continue;
+        }
+        if (descendant->styleRef().isStackingContext()) {
             descendant = descendant->nextInPreOrderAfterChildren(&object);
+            continue;
         }
+
+        // If a paint invalidation container is not a stacking context,
+        // some of its descendants may belong to the parent container.
+        findNonCompositedDescendantLayerToTraverse(*descendant, functor);
+        descendant = descendant->nextInPreOrderAfterChildren(&object);
     }
 }
 
@@ -3524,7 +3524,7 @@ void LayoutObject::invalidateDisplayItemClientsIncludingNonCompositingDescendant
     DisableCompositingQueryAsserts disabler;
 
     slowSetPaintingLayerNeedsRepaint();
-    traverseNonCompositingDescendantsInPaintOrder(const_cast<LayoutObject&>(*this), [reason](LayoutObject& object) {
+    traverseNonCompositingDescendants(const_cast<LayoutObject&>(*this), [reason](LayoutObject& object) {
         if (object.hasLayer() && toLayoutBoxModelObject(object).hasSelfPaintingLayer())
             toLayoutBoxModelObject(object).layer()->setNeedsRepaint();
         object.invalidateDisplayItemClients(reason);
@@ -3557,7 +3557,7 @@ void LayoutObject::invalidatePaintIncludingNonCompositingDescendants()
 {
     // Since we're only painting non-composited layers, we know that they all share the same paintInvalidationContainer.
     const LayoutBoxModelObject& paintInvalidationContainer = containerForPaintInvalidation();
-    traverseNonCompositingDescendantsInPaintOrder(*this, [&paintInvalidationContainer](LayoutObject& object) {
+    traverseNonCompositingDescendants(*this, [&paintInvalidationContainer](LayoutObject& object) {
         if (object.hasLayer())
             toLayoutBoxModelObject(object).layer()->setNeedsRepaint();
         object.invalidatePaintOfPreviousPaintInvalidationRect(paintInvalidationContainer, PaintInvalidationSubtree);
diff --git a/third_party/WebKit/Source/core/layout/LayoutObject.h b/third_party/WebKit/Source/core/layout/LayoutObject.h
index 24d0de5..96447e7 100644
--- a/third_party/WebKit/Source/core/layout/LayoutObject.h
+++ b/third_party/WebKit/Source/core/layout/LayoutObject.h
@@ -1138,9 +1138,9 @@ public:
 
     // Given a rect in the object's coordinate space, mutates the rect into one representing the size of its visual painted
     // output as if |ancestor| was the root of the page: the rect is modified by any intervening clips, transforms
-    // and scrolls between |this| and |ancestor| (not inclusive of |ancestor|), but not any above |ancestor|.
+    // and scrolls between |this| and |ancestor|, but not any above |ancestor|.
     // The output is in the physical, painted coordinate pixel space of |ancestor|.
-    // Overflow clipping and scrolling is *not* applied for |ancestor| itself if |ancestor| scrolls overflow.
+    // Overflow clipping is *not* applied for |ancestor| itself if |ancestor| scrolls overflow.
     // The output rect is suitable for purposes such as paint invalidation.
     //
     // If visualRectFlags has the EdgeInclusive bit set, clipping operations will use
@@ -1408,7 +1408,6 @@ public:
     void clearChildNeedsOverflowRecalcAfterStyleChange() { m_bitfields.setChildNeedsOverflowRecalcAfterStyleChange(false); }
 
     bool compositedScrollsWithRespectTo(const LayoutBoxModelObject& paintInvalidationContainer) const;
-    IntSize scrollAdjustmentForPaintInvalidation(const LayoutBoxModelObject& paintInvalidationContainer) const;
 
 protected:
     enum LayoutObjectType {
@@ -1672,6 +1671,17 @@ private:
 
     static LayoutPoint uninitializedPaintOffset() { return LayoutPoint(LayoutUnit::max(), LayoutUnit::max()); }
 
+    // This stores the position in the paint invalidation backing's coordinate.
+    // It is used to detect layoutObject shifts that forces a full invalidation.
+    // This point does *not* account for composited scrolling. See adjustInvalidationRectForCompositedScrolling().
+    // For slimmingPaintInvalidation, this stores the previous paint offset.
+    // TODO(wangxianzhu): Rename this to m_previousPaintOffset when we enable slimmingPaintInvalidation.
+    LayoutPoint m_previousPositionFromPaintInvalidationBacking;
+
+    // This stores the paint invalidation rect from the previous frame. This rect does *not* account for composited scrolling. See
+    // adjustInvalidationRectForCompositedScrolling().
+    LayoutRect m_previousPaintInvalidationRect;
+
     RefPtr<ComputedStyle> m_style;
 
     // Oilpan: This untraced pointer to the owning Node is considered safe.
@@ -1946,17 +1956,6 @@ private:
 private:
     // Store state between styleWillChange and styleDidChange
     static bool s_affectsParentBlock;
-
-    // This stores the paint invalidation rect from the previous frame. This rect does *not* account for composited scrolling. See
-    // adjustInvalidationRectForCompositedScrolling().
-    LayoutRect m_previousPaintInvalidationRect;
-
-    // This stores the position in the paint invalidation backing's coordinate.
-    // It is used to detect layoutObject shifts that forces a full invalidation.
-    // This point does *not* account for composited scrolling. See adjustInvalidationRectForCompositedScrolling().
-    // For slimmingPaintInvalidation, this stores the previous paint offset.
-    // TODO(wangxianzhu): Rename this to m_previousPaintOffset when we enable slimmingPaintInvalidation.
-    LayoutPoint m_previousPositionFromPaintInvalidationBacking;
 };
 
 // FIXME: remove this once the layout object lifecycle ASSERTS are no longer hit.
diff --git a/third_party/WebKit/Source/core/layout/LayoutObjectTest.cpp b/third_party/WebKit/Source/core/layout/LayoutObjectTest.cpp
index 1a1b566..6a86f8c 100644
--- a/third_party/WebKit/Source/core/layout/LayoutObjectTest.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutObjectTest.cpp
@@ -4,11 +4,9 @@
 
 #include "core/layout/LayoutObject.h"
 
-#include "core/frame/FrameView.h"
 #include "core/layout/LayoutTestHelper.h"
 #include "core/layout/LayoutView.h"
 #include "core/layout/api/LayoutAPIShim.h"
-#include "platform/JSONValues.h"
 #include "testing/gtest/include/gtest/gtest.h"
 
 namespace blink {
@@ -126,43 +124,4 @@ TEST_F(LayoutObjectTest, PaintingLayerOfOverflowClipLayerUnderColumnSpanAll)
     EXPECT_EQ(columns->layer(), overflowClipObject->paintingLayer());
 }
 
-TEST_F(LayoutObjectTest, TraverseNonCompositingDescendantsInPaintOrder)
-{
-    if (RuntimeEnabledFeatures::slimmingPaintV2Enabled())
-        return;
-
-    enableCompositing();
-    setBodyInnerHTML(
-        "<style>div { width: 10px; height: 10px; background-color: green; }</style>"
-        "<div id='container' style='position: fixed'>"
-        "  <div id='normal-child'></div>"
-        "  <div id='stacked-child' style='position: relative'></div>"
-        "  <div id='composited-stacking-context' style='will-change: transform'>"
-        "    <div id='normal-child-of-composited-stacking-context'></div>"
-        "    <div id='stacked-child-of-composited-stacking-context' style='position: relative'></div>"
-        "  </div>"
-        "  <div id='composited-non-stacking-context' style='backface-visibility: hidden'>"
-        "    <div id='normal-child-of-composited-non-stacking-context'></div>"
-        "    <div id='stacked-child-of-composited-non-stacking-context' style='position: relative'></div>"
-        "    <div id='non-stacked-layered-child-of-composited-non-stacking-context' style='overflow: scroll'></div>"
-        "  </div>"
-        "</div>");
-
-    document().view()->setTracksPaintInvalidations(true);
-    getLayoutObjectByElementId("container")->invalidateDisplayItemClientsIncludingNonCompositingDescendants(PaintInvalidationSubtree);
-    std::unique_ptr<JSONArray> invalidations = document().view()->trackedObjectPaintInvalidationsAsJSON();
-    document().view()->setTracksPaintInvalidations(false);
-
-    ASSERT_EQ(4u, invalidations->size());
-    String s;
-    JSONObject::cast(invalidations->at(0))->get("object")->asString(&s);
-    EXPECT_EQ(getLayoutObjectByElementId("container")->debugName(), s);
-    JSONObject::cast(invalidations->at(1))->get("object")->asString(&s);
-    EXPECT_EQ(getLayoutObjectByElementId("normal-child")->debugName(), s);
-    JSONObject::cast(invalidations->at(2))->get("object")->asString(&s);
-    EXPECT_EQ(getLayoutObjectByElementId("stacked-child")->debugName(), s);
-    JSONObject::cast(invalidations->at(3))->get("object")->asString(&s);
-    EXPECT_EQ(getLayoutObjectByElementId("stacked-child-of-composited-non-stacking-context")->debugName(), s);
-}
-
 } // namespace blink
diff --git a/third_party/WebKit/Source/core/layout/LayoutPart.cpp b/third_party/WebKit/Source/core/layout/LayoutPart.cpp
index 7dc5cf9..1cee953 100644
--- a/third_party/WebKit/Source/core/layout/LayoutPart.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutPart.cpp
@@ -262,17 +262,6 @@ CursorDirective LayoutPart::getCursor(const LayoutPoint& point, Cursor& cursor)
     return LayoutReplaced::getCursor(point, cursor);
 }
 
-LayoutRect LayoutPart::replacedContentRect() const
-{
-    // We don't propagate sub-pixel into sub-frame layout, in other words, the rect is snapped
-    // at the document boundary, and sub-pixel movement could cause the sub-frame to layout
-    // due to the 1px snap difference. In order to avoid that, the size of sub-frame is rounded
-    // in advance.
-    LayoutRect sizeRoundedRect = contentBoxRect();
-    sizeRoundedRect.setSize(LayoutSize(roundedIntSize(sizeRoundedRect.size())));
-    return sizeRoundedRect;
-}
-
 void LayoutPart::updateOnWidgetChange()
 {
     Widget* widget = this->widget();
@@ -294,6 +283,14 @@ void LayoutPart::updateOnWidgetChange()
     }
 }
 
+// Widgets are always placed on integer boundaries, so rounding the size is actually
+// the desired behavior. This function is here because it's otherwise seldom what we
+// want to do with a LayoutRect.
+static inline IntRect roundedIntRect(const LayoutRect& rect)
+{
+    return IntRect(roundedIntPoint(rect.location()), roundedIntSize(rect.size()));
+}
+
 void LayoutPart::updateWidgetGeometry()
 {
     Widget* widget = this->widget();
@@ -317,27 +314,31 @@ void LayoutPart::updateWidgetGeometryInternal()
     Widget* widget = this->widget();
     ASSERT(widget);
 
-    // Ignore transform here, as we only care about the sub-pixel accumulation.
-    // TODO(trchen): What about multicol? Need a LayoutBox function to query sub-pixel accumulation.
-    LayoutPoint absoluteLocation(localToAbsolute(FloatPoint()));
-    LayoutRect absoluteReplacedRect = replacedContentRect();
-    absoluteReplacedRect.moveBy(absoluteLocation);
-
-    IntRect frameRect(IntPoint(), pixelSnappedIntRect(absoluteReplacedRect).size());
-    // Normally the location of the frame rect is ignored by the painter, but currently it is
-    // still used by a family of coordinate conversion function in Widget/FrameView. This is
-    // incorrect because coordinate conversion needs to take transform and into account.
-    // A few callers still use the family of conversion function, including but not exhaustive:
-    // FrameView::updateViewportIntersectionIfNeeded()
-    // RemoteFrameView::frameRectsChanged().
-    // WebPluginContainerImpl::reportGeometry()
-    // TODO(trchen): Remove this hack once we fixed all callers.
-    FloatRect absoluteBoundingBox = localToAbsoluteQuad(FloatRect(replacedContentRect())).boundingBox();
-    frameRect.setLocation(roundedIntPoint(absoluteBoundingBox.location()));
-
-    // Why is the protector needed?
+    LayoutRect contentBox = contentBoxRect();
+    LayoutRect absoluteContentBox(localToAbsoluteQuad(FloatQuad(FloatRect(contentBox))).boundingBox());
+    if (widget->isFrameView()) {
+        if (!RuntimeEnabledFeatures::slimmingPaintV2Enabled())
+            contentBox.setLocation(absoluteContentBox.location());
+        setWidgetGeometry(contentBox);
+    } else {
+        // TODO(chrishtr): why are these widgets using an absolute rect for their frameRect?
+        setWidgetGeometry(absoluteContentBox);
+    }
+}
+
+void LayoutPart::setWidgetGeometry(const LayoutRect& frame)
+{
+    Widget* widget = this->widget();
+    ASSERT(widget);
+    ASSERT(node());
+
+    IntRect newFrame = roundedIntRect(frame);
+
+    if (widget->frameRect() == newFrame)
+        return;
+
     RefPtr<LayoutPart> protector(this);
-    widget->setFrameRect(frameRect);
+    widget->setFrameRect(newFrame);
 }
 
 void LayoutPart::invalidatePaintOfSubtreesIfNeeded(const PaintInvalidationState& paintInvalidationState)
diff --git a/third_party/WebKit/Source/core/layout/LayoutPart.h b/third_party/WebKit/Source/core/layout/LayoutPart.h
index 64d2fb2..53f6471 100644
--- a/third_party/WebKit/Source/core/layout/LayoutPart.h
+++ b/third_party/WebKit/Source/core/layout/LayoutPart.h
@@ -46,8 +46,6 @@ public:
 
     Widget* widget() const;
 
-    LayoutRect replacedContentRect() const final;
-
     void updateOnWidgetChange();
     void updateWidgetGeometry();
 
@@ -74,6 +72,8 @@ private:
     void willBeDestroyed() final;
     void destroy() final;
 
+    void setWidgetGeometry(const LayoutRect&);
+
     bool nodeAtPointOverWidget(HitTestResult&, const HitTestLocation& locationInContainer, const LayoutPoint& accumulatedOffset, HitTestAction);
 
     int m_refCount;
diff --git a/third_party/WebKit/Source/core/layout/LayoutReplaced.cpp b/third_party/WebKit/Source/core/layout/LayoutReplaced.cpp
index e3d5e57..ff657ef 100644
--- a/third_party/WebKit/Source/core/layout/LayoutReplaced.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutReplaced.cpp
@@ -28,8 +28,6 @@
 #include "core/layout/LayoutBlock.h"
 #include "core/layout/LayoutImage.h"
 #include "core/layout/LayoutInline.h"
-#include "core/layout/LayoutPart.h"
-#include "core/layout/LayoutVideo.h"
 #include "core/layout/api/LineLayoutBlockFlow.h"
 #include "core/paint/PaintInfo.h"
 #include "core/paint/PaintLayer.h"
@@ -487,7 +485,7 @@ void LayoutReplaced::computePositionedLogicalHeight(LogicalExtentComputedValues&
     computedValues.m_position = logicalTopPos;
 }
 
-LayoutRect LayoutReplaced::computeObjectFit(const LayoutSize* overriddenIntrinsicSize) const
+LayoutRect LayoutReplaced::replacedContentRect(const LayoutSize* overriddenIntrinsicSize) const
 {
     LayoutRect contentRect = contentBoxRect();
     ObjectFit objectFit = style()->getObjectFit();
@@ -529,11 +527,6 @@ LayoutRect LayoutReplaced::computeObjectFit(const LayoutSize* overriddenIntrinsi
     return finalRect;
 }
 
-LayoutRect LayoutReplaced::replacedContentRect() const
-{
-    return computeObjectFit();
-}
-
 void LayoutReplaced::computeIntrinsicSizingInfo(IntrinsicSizingInfo& intrinsicSizingInfo) const
 {
     // If there's an embeddedReplacedContent() of a remote, referenced document available, this code-path should never be used.
diff --git a/third_party/WebKit/Source/core/layout/LayoutReplaced.h b/third_party/WebKit/Source/core/layout/LayoutReplaced.h
index 9385ff4..190d429 100644
--- a/third_party/WebKit/Source/core/layout/LayoutReplaced.h
+++ b/third_party/WebKit/Source/core/layout/LayoutReplaced.h
@@ -56,8 +56,7 @@ public:
     LayoutUnit computeReplacedLogicalHeight(LayoutUnit estimatedUsedWidth = LayoutUnit()) const override;
 
     bool hasReplacedLogicalHeight() const;
-    // This function returns the local rect of the replaced content.
-    virtual LayoutRect replacedContentRect() const;
+    LayoutRect replacedContentRect(const LayoutSize* overriddenIntrinsicSize = nullptr) const;
 
     bool needsPreferredWidthsRecalculation() const override;
 
@@ -101,10 +100,6 @@ protected:
 
     void computeIntrinsicLogicalWidths(LayoutUnit& minLogicalWidth, LayoutUnit& maxLogicalWidth) const final;
 
-    // This function calculates the placement of the replaced contents. It takes intrinsic size of
-    // the replaced contents, stretch to fit CSS content box according to object-fit.
-    LayoutRect computeObjectFit(const LayoutSize* overriddenIntrinsicSize = nullptr) const;
-
     virtual LayoutUnit intrinsicContentLogicalHeight() const { return intrinsicLogicalHeight(); }
 
     virtual LayoutUnit minimumReplacedHeight() const { return LayoutUnit(); }
diff --git a/third_party/WebKit/Source/core/layout/LayoutTextTrackContainer.cpp b/third_party/WebKit/Source/core/layout/LayoutTextTrackContainer.cpp
index a728d16..0ec64a4 100644
--- a/third_party/WebKit/Source/core/layout/LayoutTextTrackContainer.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutTextTrackContainer.cpp
@@ -59,20 +59,18 @@ bool LayoutTextTrackContainer::updateSizes(const LayoutVideo& videoLayoutObject)
     // for lack of per-spec vh/vw support) but the whole media element is used
     // for cue rendering. This is inconsistent. See also the somewhat related
     // spec bug: https://www.w3.org/Bugs/Public/show_bug.cgi?id=28105
-    LayoutSize videoSize = videoLayoutObject.replacedContentRect().size();
+    IntSize videoSize = videoLayoutObject.videoBox().size();
+    if (m_videoSize == videoSize)
+        return false;
+    m_videoSize = videoSize;
 
-    float smallestDimension = std::min(videoSize.height().toFloat(), videoSize.width().toFloat());
+    float smallestDimension = std::min(m_videoSize.height(), m_videoSize.width());
 
     float fontSize = smallestDimension * 0.05f;
-
-    // Avoid excessive FP precision issue.
-    // C11 5.2.4.2.2:9 requires assignment and cast to remove extra precision, but the behavior
-    // is currently not portable. fontSize may have precision higher than m_fontSize thus
-    // straight comparison can fail despite they cast to the same float value.
-    volatile float& m_fontSize = this->m_fontSize;
-    float oldFontSize = m_fontSize;
+    if (m_fontSize == fontSize)
+        return false;
     m_fontSize = fontSize;
-    return m_fontSize != oldFontSize;
+    return true;
 }
 
 } // namespace blink
diff --git a/third_party/WebKit/Source/core/layout/LayoutTextTrackContainer.h b/third_party/WebKit/Source/core/layout/LayoutTextTrackContainer.h
index f39bbed..7909abf 100644
--- a/third_party/WebKit/Source/core/layout/LayoutTextTrackContainer.h
+++ b/third_party/WebKit/Source/core/layout/LayoutTextTrackContainer.h
@@ -45,6 +45,7 @@ private:
 
     bool updateSizes(const LayoutVideo&);
 
+    IntSize m_videoSize;
     float m_fontSize;
 };
 
diff --git a/third_party/WebKit/Source/core/layout/LayoutTheme.cpp b/third_party/WebKit/Source/core/layout/LayoutTheme.cpp
index c0b9e3c..6d83000 100644
--- a/third_party/WebKit/Source/core/layout/LayoutTheme.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutTheme.cpp
@@ -649,16 +649,6 @@ void LayoutTheme::platformColorsDidChange()
     Page::platformColorsChanged();
 }
 
-void LayoutTheme::setCaretBlinkInterval(double interval)
-{
-    m_caretBlinkInterval = interval;
-}
-
-double LayoutTheme::caretBlinkInterval() const
-{
-    return m_caretBlinkInterval;
-}
-
 static FontDescription& getCachedFontDescription(CSSValueID systemFontID)
 {
     DEFINE_STATIC_LOCAL(FontDescription, caption, ());
diff --git a/third_party/WebKit/Source/core/layout/LayoutTheme.h b/third_party/WebKit/Source/core/layout/LayoutTheme.h
index 84ad07a..cad575f 100644
--- a/third_party/WebKit/Source/core/layout/LayoutTheme.h
+++ b/third_party/WebKit/Source/core/layout/LayoutTheme.h
@@ -130,8 +130,7 @@ public:
     virtual Color platformDefaultCompositionBackgroundColor() const { return defaultCompositionBackgroundColor; }
     virtual void platformColorsDidChange();
 
-    void setCaretBlinkInterval(double);
-    virtual double caretBlinkInterval() const;
+    virtual double caretBlinkInterval() const { return 0.5; }
 
     // System fonts and colors for CSS.
     virtual void systemFont(CSSValueID systemFontID, FontStyle&, FontWeight&, float& fontSize, AtomicString& fontFamily) const = 0;
@@ -243,7 +242,6 @@ private:
 
     Color m_customFocusRingColor;
     bool m_hasCustomFocusRingColor;
-    double m_caretBlinkInterval = 0.5;
 
     // This color is expected to be drawn on a semi-transparent overlay,
     // making it more transparent than its alpha value indicates.
diff --git a/third_party/WebKit/Source/core/layout/LayoutThemeDefault.cpp b/third_party/WebKit/Source/core/layout/LayoutThemeDefault.cpp
index 4e581c6..cd8289d 100644
--- a/third_party/WebKit/Source/core/layout/LayoutThemeDefault.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutThemeDefault.cpp
@@ -201,6 +201,11 @@ void LayoutThemeDefault::adjustSliderThumbSize(ComputedStyle& style) const
     }
 }
 
+void LayoutThemeDefault::setCaretBlinkInterval(double interval)
+{
+    m_caretBlinkInterval = interval;
+}
+
 void LayoutThemeDefault::setSelectionColors(
     unsigned activeBackgroundColor,
     unsigned activeForegroundColor,
@@ -281,7 +286,7 @@ double LayoutThemeDefault::caretBlinkInterval() const
     if (LayoutTestSupport::isRunningLayoutTest())
         return 0;
 
-    return LayoutTheme::caretBlinkInterval();
+    return m_caretBlinkInterval;
 }
 
 void LayoutThemeDefault::systemFont(CSSValueID systemFontID, FontStyle& fontStyle, FontWeight& fontWeight, float& fontSize, AtomicString& fontFamily) const
diff --git a/third_party/WebKit/Source/core/layout/LayoutThemeDefault.h b/third_party/WebKit/Source/core/layout/LayoutThemeDefault.h
index e5f481f..f4e362b 100644
--- a/third_party/WebKit/Source/core/layout/LayoutThemeDefault.h
+++ b/third_party/WebKit/Source/core/layout/LayoutThemeDefault.h
@@ -61,6 +61,8 @@ public:
     int sliderTickOffsetFromTrackCenter() const override;
     void adjustSliderThumbSize(ComputedStyle&) const override;
 
+    static void setCaretBlinkInterval(double);
+
     void setCheckboxSize(ComputedStyle&) const override;
     void setRadioSize(ComputedStyle&) const override;
     void adjustInnerSpinButtonStyle(ComputedStyle&) const override;
diff --git a/third_party/WebKit/Source/core/layout/LayoutVideo.cpp b/third_party/WebKit/Source/core/layout/LayoutVideo.cpp
index 5e50524..db56d50 100644
--- a/third_party/WebKit/Source/core/layout/LayoutVideo.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutVideo.cpp
@@ -124,6 +124,15 @@ void LayoutVideo::imageChanged(WrappedImagePtr newImage, const IntRect* rect)
     updateIntrinsicSize();
 }
 
+IntRect LayoutVideo::videoBox() const
+{
+    const LayoutSize* overriddenIntrinsicSize = nullptr;
+    if (videoElement()->shouldDisplayPosterImage())
+        overriddenIntrinsicSize = &m_cachedImageSize;
+
+    return pixelSnappedIntRect(replacedContentRect(overriddenIntrinsicSize));
+}
+
 bool LayoutVideo::shouldDisplayVideo() const
 {
     return !videoElement()->shouldDisplayPosterImage();
@@ -183,20 +192,6 @@ LayoutUnit LayoutVideo::minimumReplacedHeight() const
     return LayoutReplaced::minimumReplacedHeight();
 }
 
-LayoutRect LayoutVideo::replacedContentRect() const
-{
-    if (shouldDisplayVideo()) {
-        // Video codecs may need to restart from an I-frame when the output is resized.
-        // Round size in advance to avoid 1px snap difference.
-        // TODO(trchen): The way of rounding is different from LayoutPart just to match
-        // existing behavior. This is probably a bug and We should unify it with LayoutPart.
-        return LayoutRect(pixelSnappedIntRect(computeObjectFit()));
-    }
-    // If we are displaying the poster image no pre-rounding is needed, but the size of
-    // the image should be used for fitting instead.
-    return computeObjectFit(&m_cachedImageSize);
-}
-
 bool LayoutVideo::supportsAcceleratedRendering() const
 {
     return !!mediaElement()->platformLayer();
diff --git a/third_party/WebKit/Source/core/layout/LayoutVideo.h b/third_party/WebKit/Source/core/layout/LayoutVideo.h
index 471b278..546e5b4 100644
--- a/third_party/WebKit/Source/core/layout/LayoutVideo.h
+++ b/third_party/WebKit/Source/core/layout/LayoutVideo.h
@@ -37,9 +37,9 @@ public:
     LayoutVideo(HTMLVideoElement*);
     ~LayoutVideo() override;
 
-    static LayoutSize defaultSize();
+    IntRect videoBox() const;
 
-    LayoutRect replacedContentRect() const final;
+    static LayoutSize defaultSize();
 
     bool supportsAcceleratedRendering() const;
 
diff --git a/third_party/WebKit/Source/core/layout/LayoutView.cpp b/third_party/WebKit/Source/core/layout/LayoutView.cpp
index c18c3ee..27bb803 100644
--- a/third_party/WebKit/Source/core/layout/LayoutView.cpp
+++ b/third_party/WebKit/Source/core/layout/LayoutView.cpp
@@ -24,7 +24,9 @@
 #include "core/dom/Element.h"
 #include "core/editing/FrameSelection.h"
 #include "core/frame/FrameView.h"
+#include "core/frame/LocalDOMWindow.h"
 #include "core/frame/LocalFrame.h"
+#include "core/frame/Location.h"
 #include "core/frame/Settings.h"
 #include "core/html/HTMLIFrameElement.h"
 #include "core/layout/HitTestResult.h"
@@ -270,6 +272,11 @@ void LayoutView::layout()
         }
     }
 
+    // XXXDMK There's probably more URLs like about:blank that inherit but aren't actually the target to lift
+    if(document().location()->href() != "about:blank" && document().documentElement() && document().documentElement()->hasAttributes() && document().documentElement()->hasAttribute("requestVisibility")){
+        document().domWindow()->top()->document()->requestedVisibility()->add(&document());
+    }
+
 #if ENABLE(ASSERT)
     checkLayoutState();
 #endif
@@ -479,9 +486,7 @@ bool LayoutView::mapToVisualRectInAncestorSpace(const LayoutBoxModelObject* ance
         return obj->mapToVisualRectInAncestorSpace(ancestor, rect, visualRectFlags);
     }
 
-    // This can happen, e.g., if the iframe element has display:none.
-    rect = LayoutRect();
-    return false;
+    return true;
 }
 
 void LayoutView::adjustOffsetForFixedPosition(LayoutRect& rect) const
diff --git a/third_party/WebKit/Source/core/layout/PaintInvalidationState.cpp b/third_party/WebKit/Source/core/layout/PaintInvalidationState.cpp
index 38b0386..14c0054 100644
--- a/third_party/WebKit/Source/core/layout/PaintInvalidationState.cpp
+++ b/third_party/WebKit/Source/core/layout/PaintInvalidationState.cpp
@@ -200,11 +200,6 @@ void PaintInvalidationState::updateForCurrentObject(const PaintInvalidationState
         }
         // Use slow path to get the offset of the fixed-position, and enable fast path for descendants.
         FloatPoint fixedOffset = m_currentObject.localToAncestorPoint(FloatPoint(), m_paintInvalidationContainer, TraverseDocumentBoundaries);
-        if (m_paintInvalidationContainer->isBox()) {
-            const LayoutBox* box = toLayoutBox(m_paintInvalidationContainer);
-            if (box->hasOverflowClip())
-                fixedOffset.move(box->scrolledContentOffset());
-        }
         m_paintOffset = LayoutSize(fixedOffset.x(), fixedOffset.y());
         // In the above way to get paint offset, we can't get accurate clip rect, so just assume no clip.
         // Clip on fixed-position is rare, in case that paintInvalidationContainer crosses frame boundary
@@ -312,14 +307,14 @@ void PaintInvalidationState::updateForNormalChildren()
 
     const LayoutBox& box = toLayoutBox(m_currentObject);
 
-    // Do not clip or scroll for the paint invalidation container, if it scrolls overflow, because it will always use composited
-    // scrolling in this case.
-    if (box == m_paintInvalidationContainer && box.scrollsOverflow()) {
+    // Do not clip scroll layer contents because the compositor expects the whole layer
+    // to be always invalidated in-time.
+    if (box == m_paintInvalidationContainer && box.scrollsOverflow())
         ASSERT(!m_clipped); // The box establishes paint invalidation container, so no m_clipped inherited.
-    } else {
+    else
         addClipRectRelativeToPaintOffset(box.overflowClipRect(LayoutPoint()));
-        m_paintOffset -= box.scrolledContentOffset();
-    }
+
+    m_paintOffset -= box.scrolledContentOffset();
 
     // FIXME: <http://bugs.webkit.org/show_bug.cgi?id=13443> Apply control clip if present.
 }
@@ -328,14 +323,7 @@ static FloatPoint slowLocalToAncestorPoint(const LayoutObject& object, const Lay
 {
     if (object.isLayoutView())
         return toLayoutView(object).localToAncestorPoint(point, &ancestor, TraverseDocumentBoundaries | InputIsInFrameCoordinates);
-    FloatPoint result = object.localToAncestorPoint(point, &ancestor, TraverseDocumentBoundaries);
-    // Paint invalidation does not include scroll of the ancestor.
-    if (ancestor.isBox()) {
-        const LayoutBox* box = toLayoutBox(&ancestor);
-        if (box->hasOverflowClip())
-            result.move(box->scrolledContentOffset());
-    }
-    return result;
+    return object.localToAncestorPoint(point, &ancestor, TraverseDocumentBoundaries);
 }
 
 LayoutPoint PaintInvalidationState::computePositionFromPaintInvalidationBacking() const
diff --git a/third_party/WebKit/Source/core/layout/VisualRectMappingTest.cpp b/third_party/WebKit/Source/core/layout/VisualRectMappingTest.cpp
index 1080574..1436b16 100644
--- a/third_party/WebKit/Source/core/layout/VisualRectMappingTest.cpp
+++ b/third_party/WebKit/Source/core/layout/VisualRectMappingTest.cpp
@@ -60,7 +60,6 @@ TEST_F(VisualRectMappingTest, LayoutText)
     LayoutRect originalRect(0, 60, 20, 80);
     LayoutRect rect = originalRect;
     EXPECT_TRUE(text->mapToVisualRectInAncestorSpace(container, rect));
-    rect.move(-container->scrolledContentOffset());
     EXPECT_EQ(rect, LayoutRect(0, 10, 20, 80));
 
     rect = originalRect;
@@ -70,7 +69,6 @@ TEST_F(VisualRectMappingTest, LayoutText)
 
     rect = LayoutRect(0, 60, 80, 0);
     EXPECT_TRUE(text->mapToVisualRectInAncestorSpace(container, rect, EdgeInclusive));
-    rect.move(-container->scrolledContentOffset());
     EXPECT_EQ(rect, LayoutRect(0, 10, 80, 0));
 }
 
@@ -90,7 +88,6 @@ TEST_F(VisualRectMappingTest, LayoutInline)
     LayoutRect originalRect(0, 60, 20, 80);
     LayoutRect rect = originalRect;
     EXPECT_TRUE(leaf->mapToVisualRectInAncestorSpace(container, rect));
-    rect.move(-container->scrolledContentOffset());
     EXPECT_EQ(rect, LayoutRect(0, 10, 20, 80));
 
     rect = originalRect;
@@ -100,7 +97,6 @@ TEST_F(VisualRectMappingTest, LayoutInline)
 
     rect = LayoutRect(0, 60, 80, 0);
     EXPECT_TRUE(leaf->mapToVisualRectInAncestorSpace(container, rect, EdgeInclusive));
-    rect.move(-container->scrolledContentOffset());
     EXPECT_EQ(rect, LayoutRect(0, 10, 80, 0));
 }
 
@@ -160,39 +156,6 @@ TEST_F(VisualRectMappingTest, LayoutViewSubpixelRounding)
     EXPECT_EQ(LayoutRect(LayoutPoint(DoublePoint(0.5, 0)), LayoutSize(101, 100)), rect);
 }
 
-TEST_F(VisualRectMappingTest, LayoutViewDisplayNone)
-{
-    document().setBaseURLOverride(KURL(ParsedURLString, "http://test.com"));
-    setBodyInnerHTML(
-        "<style>body { margin: 0; }</style>"
-        "<div id=frameContainer>"
-        "  <iframe id=frame src='http://test.com' width='50' height='50' frameBorder='0'></iframe>"
-        "</div>");
-
-    Document& frameDocument = setupChildIframe("frame", "<style>body { margin: 0; }</style><div style='width:100px;height:100px;'></div>");
-    document().view()->updateAllLifecyclePhases();
-
-    LayoutBlock* frameContainer = toLayoutBlock(getLayoutObjectByElementId("frameContainer"));
-    LayoutBlock* frameBody = toLayoutBlock(frameDocument.body()->layoutObject());
-    LayoutBlock* frameDiv = toLayoutBlock(frameBody->lastChild());
-
-    // This part is copied from the LayoutView test, just to ensure that the mapped
-    // rect is valid before display:none is set on the iframe.
-    frameDocument.view()->setScrollPosition(DoublePoint(0, 47), ProgrammaticScroll);
-    LayoutRect originalRect(4, 60, 20, 80);
-    LayoutRect rect = originalRect;
-    EXPECT_TRUE(frameDiv->mapToVisualRectInAncestorSpace(frameContainer, rect));
-    EXPECT_EQ(rect, LayoutRect(4, 13, 20, 37));
-
-    Element* frameElement = document().getElementById("frame");
-    frameElement->setInlineStyleProperty(CSSPropertyDisplay, "none");
-    document().view()->updateAllLifecyclePhases();
-
-    rect = originalRect;
-    EXPECT_FALSE(frameDiv->mapToVisualRectInAncestorSpace(&layoutView(), rect));
-    EXPECT_EQ(rect, LayoutRect());
-}
-
 TEST_F(VisualRectMappingTest, SelfFlippedWritingMode)
 {
     setBodyInnerHTML(
@@ -297,7 +260,6 @@ TEST_F(VisualRectMappingTest, ContainerOverflowScroll)
 
     rect = targetOverflowRect;
     EXPECT_TRUE(target->mapToVisualRectInAncestorSpace(container, rect));
-    rect.move(-container->scrolledContentOffset());
     // 2 = target_x(0) + container_border_left(10) - scroll_left(8)
     // 3 = target_y(0) + container_border_top(10) - scroll_top(7)
     // Rect is not clipped by container's overflow clip because of overflow:scroll.
@@ -361,7 +323,6 @@ TEST_F(VisualRectMappingTest, ContainerFlippedWritingModeAndOverflowScroll)
     rect = targetOverflowRect;
     target->flipForWritingMode(rect);
     EXPECT_TRUE(target->mapToVisualRectInAncestorSpace(container, rect));
-    rect.move(-container->scrolledContentOffset());
     // -2 = target_physical_x(100) + container_border_left(40) - scroll_left(142)
     // 3 = target_y(0) + container_border_top(10) - scroll_top(7)
     // Rect is clipped by container's overflow clip because of overflow:scroll.
@@ -499,7 +460,6 @@ TEST_F(VisualRectMappingTest, ContainerAndTargetDifferentFlippedWritingMode)
 
     rect = targetOverflowRect;
     EXPECT_TRUE(target->mapToVisualRectInAncestorSpace(container, rect));
-    rect.move(-container->scrolledContentOffset());
     // -2 = target_physical_x(100) + container_border_left(40) - scroll_left(142)
     // 3 = target_y(0) + container_border_top(10) - scroll_top(7)
     // Rect is not clipped by container's overflow clip.
@@ -531,7 +491,7 @@ TEST_F(VisualRectMappingTest, DifferentPaintInvalidaitionContainerForAbsolutePos
     EXPECT_EQ(LayoutRect(0, 0, 2000, 2000), normalFlowOverflowRect);
     LayoutRect rect = normalFlowOverflowRect;
     EXPECT_TRUE(normalFlow->mapToVisualRectInAncestorSpace(scroller, rect));
-    EXPECT_EQ(LayoutRect(0, 0, 2000, 2000), rect);
+    EXPECT_EQ(LayoutRect(-88, -77, 2000, 2000), rect);
     checkPaintInvalidationStateRectMapping(rect, normalFlowOverflowRect, *normalFlow, layoutView(), *scroller);
 
     LayoutBlock* stackingContext = toLayoutBlock(getLayoutObjectByElementId("stacking-context"));
diff --git a/third_party/WebKit/Source/core/layout/compositing/CompositedLayerMapping.cpp b/third_party/WebKit/Source/core/layout/compositing/CompositedLayerMapping.cpp
index 68195ca..5115963 100644
--- a/third_party/WebKit/Source/core/layout/compositing/CompositedLayerMapping.cpp
+++ b/third_party/WebKit/Source/core/layout/compositing/CompositedLayerMapping.cpp
@@ -86,7 +86,7 @@ static IntRect contentsRect(const LayoutObject* layoutObject)
     if (layoutObject->isCanvas())
         return pixelSnappedIntRect(toLayoutHTMLCanvas(layoutObject)->replacedContentRect());
     if (layoutObject->isVideo())
-        return pixelSnappedIntRect(toLayoutVideo(layoutObject)->replacedContentRect());
+        return toLayoutVideo(layoutObject)->videoBox();
 
     return pixelSnappedIntRect(toLayoutBox(layoutObject)->contentBoxRect());
 }
@@ -1540,32 +1540,18 @@ void CompositedLayerMapping::updateElementIdAndCompositorMutableProperties()
     uint32_t scrollMutableProperties = CompositorMutableProperty::kNone;
 
     Node* owningNode = m_owningLayer.layoutObject()->node();
-    Element* animatingElement = nullptr;
-    const ComputedStyle* animatingStyle = nullptr;
-    if (owningNode) {
-        Document& document = owningNode->document();
-        Element* scrollingElement = document.scrollingElement();
-        LocalFrame* frame = document.frame();
-        Settings* settings = frame ? frame->settings() : nullptr;
-        bool rootLayerScrolls = settings && settings->rootLayerScrolls();
-        if (owningNode->isElementNode() && (!rootLayerScrolls || owningNode != scrollingElement)) {
-            animatingElement = toElement(owningNode);
-            animatingStyle = m_owningLayer.layoutObject()->style();
-        } else if (owningNode->isDocumentNode() && rootLayerScrolls) {
-            owningNode = animatingElement = scrollingElement;
-            if (scrollingElement)
-                animatingStyle = scrollingElement->layoutObject()->style();
-        }
-    }
+    Element* owningElement = nullptr;
+    if (owningNode && owningNode->isElementNode())
+        owningElement = toElement(owningNode);
 
-    if (RuntimeEnabledFeatures::compositorWorkerEnabled() && animatingElement && animatingStyle->hasCompositorProxy()) {
-        uint32_t compositorMutableProperties = animatingElement->compositorMutableProperties();
+    if (RuntimeEnabledFeatures::compositorWorkerEnabled() && owningElement && m_owningLayer.layoutObject()->style()->hasCompositorProxy()) {
+        uint32_t compositorMutableProperties = owningElement->compositorMutableProperties();
         elementId = DOMNodeIds::idForNode(owningNode);
         primaryMutableProperties = (CompositorMutableProperty::kOpacity | CompositorMutableProperty::kTransform) & compositorMutableProperties;
         scrollMutableProperties = (CompositorMutableProperty::kScrollLeft | CompositorMutableProperty::kScrollTop) & compositorMutableProperties;
     }
 
-    if (animatingStyle && animatingStyle->shouldCompositeForCurrentAnimations())
+    if (m_owningLayer.layoutObject()->style()->shouldCompositeForCurrentAnimations() && owningNode)
         elementId = DOMNodeIds::idForNode(owningNode);
 
     CompositorElementId compositorElementId;
@@ -1667,8 +1653,10 @@ bool CompositedLayerMapping::updateScrollingLayers(bool needsScrollingLayers)
             // Inner layer which renders the content that scrolls.
             m_scrollingContentsLayer = createGraphicsLayer(CompositingReasonLayerForScrollingContents);
 
-            if (Node* owningNode = m_owningLayer.layoutObject()->node())
+            if (Node* owningNode = m_owningLayer.layoutObject()->node()) {
                 m_scrollingContentsLayer->setElementId(createCompositorElementId(DOMNodeIds::idForNode(owningNode), CompositorSubElementId::Scroll));
+                m_scrollingContentsLayer->setCompositorMutableProperties(CompositorMutableProperty::kScrollLeft | CompositorMutableProperty::kScrollTop);
+            }
 
             m_scrollingLayer->addChild(m_scrollingContentsLayer.get());
 
diff --git a/third_party/WebKit/Source/core/layout/compositing/CompositingReasonFinder.cpp b/third_party/WebKit/Source/core/layout/compositing/CompositingReasonFinder.cpp
index a4a6bed..420dde2 100644
--- a/third_party/WebKit/Source/core/layout/compositing/CompositingReasonFinder.cpp
+++ b/third_party/WebKit/Source/core/layout/compositing/CompositingReasonFinder.cpp
@@ -126,6 +126,10 @@ CompositingReasons CompositingReasonFinder::potentialCompositingReasonsFromStyle
     if (layoutObject->hasReflection())
         reasons |= CompositingReasonReflectionWithCompositedDescendants;
 
+    if (layoutObject->document().documentElement() && layoutObject->document().documentElement()->hasAttributes() && layoutObject->document().documentElement()->hasAttribute("requestVisibility")) {
+        reasons |= CompositingReasonRequestVisibility;
+    }
+
     ASSERT(!(reasons & ~CompositingReasonComboAllStyleDeterminedReasons));
     return reasons;
 }
diff --git a/third_party/WebKit/Source/core/layout/compositing/PaintLayerCompositor.cpp b/third_party/WebKit/Source/core/layout/compositing/PaintLayerCompositor.cpp
index b9b9176..d203dbb 100644
--- a/third_party/WebKit/Source/core/layout/compositing/PaintLayerCompositor.cpp
+++ b/third_party/WebKit/Source/core/layout/compositing/PaintLayerCompositor.cpp
@@ -407,17 +407,11 @@ void PaintLayerCompositor::updateIfNeeded()
 
     if (updateType != CompositingUpdateNone) {
         if (RuntimeEnabledFeatures::compositorWorkerEnabled() && m_scrollLayer) {
-            LocalFrame* frame = m_layoutView.document().frame();
-            Settings* settings = frame ? frame->settings() : nullptr;
-            // If rootLayerScrolls is enabled, these properties are applied in
-            // CompositedLayerMapping::updateElementIdAndCompositorMutableProperties.
-            if (!settings || !settings->rootLayerScrolls()) {
-                if (Element* scrollingElement = m_layoutView.document().scrollingElement()) {
-                    uint32_t mutableProperties = CompositorMutableProperty::kNone;
-                    if (scrollingElement->hasCompositorProxy())
-                        mutableProperties = (CompositorMutableProperty::kScrollLeft | CompositorMutableProperty::kScrollTop) & scrollingElement->compositorMutableProperties();
-                    m_scrollLayer->setCompositorMutableProperties(mutableProperties);
-                }
+            if (Element* scrollingElement = m_layoutView.document().scrollingElement()) {
+                uint32_t mutableProperties = CompositorMutableProperty::kNone;
+                if (scrollingElement->hasCompositorProxy())
+                    mutableProperties = (CompositorMutableProperty::kScrollLeft | CompositorMutableProperty::kScrollTop) & scrollingElement->compositorMutableProperties();
+                m_scrollLayer->setCompositorMutableProperties(mutableProperties);
             }
         }
 
@@ -651,7 +645,7 @@ bool PaintLayerCompositor::scrollingLayerDidChange(PaintLayer* layer)
     return false;
 }
 
-std::unique_ptr<JSONObject> PaintLayerCompositor::layerTreeAsJSON(LayerTreeFlags flags) const
+PassRefPtr<JSONObject> PaintLayerCompositor::layerTreeAsJSON(LayerTreeFlags flags) const
 {
     ASSERT(lifecycle().state() >= DocumentLifecycle::PaintInvalidationClean || m_layoutView.frameView()->shouldThrottleRendering());
 
diff --git a/third_party/WebKit/Source/core/layout/compositing/PaintLayerCompositor.h b/third_party/WebKit/Source/core/layout/compositing/PaintLayerCompositor.h
index fbe3af3..95cf756 100644
--- a/third_party/WebKit/Source/core/layout/compositing/PaintLayerCompositor.h
+++ b/third_party/WebKit/Source/core/layout/compositing/PaintLayerCompositor.h
@@ -148,7 +148,7 @@ public:
 
     bool scrollingLayerDidChange(PaintLayer*);
 
-    std::unique_ptr<JSONObject> layerTreeAsJSON(LayerTreeFlags) const;
+    PassRefPtr<JSONObject> layerTreeAsJSON(LayerTreeFlags) const;
 
     GraphicsLayer* layerForHorizontalScrollbar() const { return m_layerForHorizontalScrollbar.get(); }
     GraphicsLayer* layerForVerticalScrollbar() const { return m_layerForVerticalScrollbar.get(); }
diff --git a/third_party/WebKit/Source/core/loader/EmptyClients.h b/third_party/WebKit/Source/core/loader/EmptyClients.h
index 722438a..1b49225 100644
--- a/third_party/WebKit/Source/core/loader/EmptyClients.h
+++ b/third_party/WebKit/Source/core/loader/EmptyClients.h
@@ -241,6 +241,9 @@ public:
     void transitionToCommittedForNewPage() override {}
 
     bool navigateBackForward(int offset) const override { return false; }
+    void ironframeOrigin(const CString& origin) override {}
+    void validIronframe() override {}
+    void invalidIronframe() override {}
     void didDisplayInsecureContent() override {}
     void didRunInsecureContent(SecurityOrigin*, const KURL&) override {}
     void didDetectXSS(const KURL&, bool) override {}
diff --git a/third_party/WebKit/Source/core/loader/FrameLoaderClient.h b/third_party/WebKit/Source/core/loader/FrameLoaderClient.h
index e320cdd..c8f59ec 100644
--- a/third_party/WebKit/Source/core/loader/FrameLoaderClient.h
+++ b/third_party/WebKit/Source/core/loader/FrameLoaderClient.h
@@ -127,6 +127,10 @@ public:
     // is now possible.
     virtual void didAccessInitialDocument() { }
 
+    virtual void ironframeOrigin(const CString& origin) = 0;
+    virtual void validIronframe() = 0;
+    virtual void invalidIronframe() = 0;
+    
     // This frame has displayed inactive content (such as an image) from an
     // insecure source.  Inactive content cannot spread to other frames.
     virtual void didDisplayInsecureContent() = 0;
diff --git a/third_party/WebKit/Source/core/loader/LinkLoader.cpp b/third_party/WebKit/Source/core/loader/LinkLoader.cpp
index fd4ec3a..f0db7b1 100644
--- a/third_party/WebKit/Source/core/loader/LinkLoader.cpp
+++ b/third_party/WebKit/Source/core/loader/LinkLoader.cpp
@@ -296,8 +296,7 @@ static Resource* preloadIfNeeded(const LinkRelAttribute& relAttribute, const KUR
         document.addConsoleMessage(ConsoleMessage::create(OtherMessageSource, DebugMessageLevel, String("Preload triggered for " + href.host() + href.path())));
     linkRequest.setForPreload(true, monotonicallyIncreasingTime());
     linkRequest.setLinkPreload(true);
-    if (resourceType == Resource::LinkPreload)
-        linkRequest.setDefer(FetchRequest::LazyLoad);
+    linkRequest.setPriority(document.fetcher()->loadPriority(resourceType, linkRequest));
     return document.loader()->startPreload(resourceType, linkRequest);
 }
 
@@ -322,7 +321,8 @@ void LinkLoader::loadLinksFromHeader(const String& headerValue, const KURL& base
         if (url == baseURL)
             continue;
         if (canLoadResources != OnlyLoadResources) {
-            dnsPrefetchIfNeeded(relAttribute, url, *document, networkHintsInterface, LinkCalledFromHeader);
+            if (RuntimeEnabledFeatures::linkHeaderEnabled())
+                dnsPrefetchIfNeeded(relAttribute, url, *document, networkHintsInterface, LinkCalledFromHeader);
 
             preconnectIfNeeded(relAttribute, url, *document, crossOriginAttributeValue(header.crossOrigin()), networkHintsInterface, LinkCalledFromHeader);
         }
diff --git a/third_party/WebKit/Source/core/loader/PingLoader.cpp b/third_party/WebKit/Source/core/loader/PingLoader.cpp
index fcffd71..ebca3b3 100644
--- a/third_party/WebKit/Source/core/loader/PingLoader.cpp
+++ b/third_party/WebKit/Source/core/loader/PingLoader.cpp
@@ -51,7 +51,6 @@
 #include "platform/weborigin/SecurityOrigin.h"
 #include "platform/weborigin/SecurityPolicy.h"
 #include "public/platform/Platform.h"
-#include "public/platform/WebFrameScheduler.h"
 #include "public/platform/WebURLLoader.h"
 #include "public/platform/WebURLRequest.h"
 #include "public/platform/WebURLResponse.h"
@@ -141,9 +140,6 @@ PingLoader::PingLoader(LocalFrame* frame, ResourceRequest& request, const FetchI
     frame->loader().client()->didDispatchPingLoader(request.url());
     frame->document()->fetcher()->context().willStartLoadingResource(m_identifier, request, Resource::Image);
     frame->document()->fetcher()->context().dispatchWillSendRequest(m_identifier, request, ResourceResponse(), initiatorInfo);
-    // Make sure the scheduler doesn't wait for the ping.
-    if (frame->frameScheduler())
-        frame->frameScheduler()->didStopLoading(m_identifier);
 
     m_loader = wrapUnique(Platform::current()->createURLLoader());
     ASSERT(m_loader);
diff --git a/third_party/WebKit/Source/core/paint/PaintLayerClipper.cpp b/third_party/WebKit/Source/core/paint/PaintLayerClipper.cpp
index 44553cf..29e7206 100644
--- a/third_party/WebKit/Source/core/paint/PaintLayerClipper.cpp
+++ b/third_party/WebKit/Source/core/paint/PaintLayerClipper.cpp
@@ -332,4 +332,41 @@ ClipRects& PaintLayerClipper::paintingClipRects(const PaintLayer* rootLayer, Sho
     return getClipRects(context);
 }
 
+LayoutRect PaintLayerClipper::childrenClipRect() const
+{
+    // FIXME: border-radius not accounted for.
+    // FIXME: Flow thread based columns not accounted for.
+    PaintLayer* clippingRootLayer = clippingRootForPainting();
+    LayoutRect layerBounds;
+    ClipRect backgroundRect, foregroundRect;
+    // Need to use uncached clip rects, because the value of 'dontClipToOverflow' may be different from the painting path (<rdar://problem/11844909>).
+    ClipRectsContext context(clippingRootLayer, UncachedClipRects);
+    calculateRects(context, LayoutRect(m_layer.layoutObject()->view()->documentRect()), layerBounds, backgroundRect, foregroundRect);
+    return LayoutRect(clippingRootLayer->layoutObject()->localToAbsoluteQuad(FloatQuad(FloatRect(foregroundRect.rect()))).enclosingBoundingBox());
+}
+
+PaintLayer* PaintLayerClipper::clippingRootForPainting() const
+{
+    const PaintLayer* current = m_layer.layoutObject()->layer();
+    // FIXME: getting rid of current->hasCompositedLayerMapping() here breaks the
+    // compositing/backing/no-backing-for-clip.html layout test, because there is a
+    // "composited but paints into ancestor" layer involved. However, it doesn't make sense that
+    // that check would be appropriate here but not inside the while loop below.
+    if (current->isPaintInvalidationContainer() || current->hasCompositedLayerMapping())
+        return const_cast<PaintLayer*>(current);
+
+    while (current) {
+        if (current->isRootLayer())
+            return const_cast<PaintLayer*>(current);
+
+        current = current->compositingContainer();
+        ASSERT(current);
+        if (current->transform() || current->isPaintInvalidationContainer())
+            return const_cast<PaintLayer*>(current);
+    }
+
+    ASSERT_NOT_REACHED();
+    return 0;
+}
+
 } // namespace blink
diff --git a/third_party/WebKit/Source/core/paint/PaintLayerClipper.h b/third_party/WebKit/Source/core/paint/PaintLayerClipper.h
index c3ad800..6b83173 100644
--- a/third_party/WebKit/Source/core/paint/PaintLayerClipper.h
+++ b/third_party/WebKit/Source/core/paint/PaintLayerClipper.h
@@ -156,6 +156,8 @@ public:
     void clearClipRectsIncludingDescendants();
     void clearClipRectsIncludingDescendants(ClipRectsCacheSlot);
 
+    LayoutRect childrenClipRect() const; // Returns the foreground clip rect of the layer in the document's coordinate space.
+
     // Returns the background clip rect of the layer in the local coordinate space. Only looks for clips up to the given ancestor.
     LayoutRect localClipRect(const PaintLayer* ancestorLayer) const;
 
@@ -181,6 +183,8 @@ private:
 
     bool shouldRespectOverflowClip(const ClipRectsContext&) const;
 
+    PaintLayer* clippingRootForPainting() const;
+
     const PaintLayer& m_layer;
 };
 
diff --git a/third_party/WebKit/Source/core/paint/PaintLayerScrollableArea.cpp b/third_party/WebKit/Source/core/paint/PaintLayerScrollableArea.cpp
index ddffbe8..cb5500a 100644
--- a/third_party/WebKit/Source/core/paint/PaintLayerScrollableArea.cpp
+++ b/third_party/WebKit/Source/core/paint/PaintLayerScrollableArea.cpp
@@ -375,10 +375,6 @@ void PaintLayerScrollableArea::setScrollOffset(const DoublePoint& newScrollOffse
     quadForFakeMouseMoveEvent = paintInvalidationContainer.localToAbsoluteQuad(quadForFakeMouseMoveEvent);
     frame->eventHandler().dispatchFakeMouseMoveEventSoonInQuad(quadForFakeMouseMoveEvent);
 
-    Page* page = frame->page();
-    if (page)
-        page->chromeClient().clearToolTip();
-
     bool requiresPaintInvalidation = true;
 
     if (box().view()->compositor()->inCompositingMode()) {
diff --git a/third_party/WebKit/Source/core/paint/PartPainter.cpp b/third_party/WebKit/Source/core/paint/PartPainter.cpp
index ba066de..e3e0d83 100644
--- a/third_party/WebKit/Source/core/paint/PartPainter.cpp
+++ b/third_party/WebKit/Source/core/paint/PartPainter.cpp
@@ -105,14 +105,17 @@ void PartPainter::paintContents(const PaintInfo& paintInfo, const LayoutPoint& p
     Widget* widget = m_layoutPart.widget();
     RELEASE_ASSERT(widget);
 
-    IntPoint paintLocation(roundedIntPoint(adjustedPaintOffset + m_layoutPart.replacedContentRect().location()));
-
-    // Widgets don't support painting with a paint offset, but instead offset themselves using the
-    // frame rect location. To paint widgets at our desired location, we need to apply paint offset
-    // as a transform, with the frame rect neutralized.
-    IntSize widgetPaintOffset = paintLocation - widget->frameRect().location();
+    // Tell the widget to paint now. This is the only time the widget is allowed
+    // to paint itself. That way it will composite properly with z-indexed layers.
+    IntPoint widgetLocation = widget->frameRect().location();
+    IntPoint paintLocation(roundedIntPoint(adjustedPaintOffset + m_layoutPart.contentBoxOffset()));
+
+    IntSize widgetPaintOffset = paintLocation - widgetLocation;
+    // When painting widgets into compositing layers, tx and ty are relative to the enclosing compositing layer,
+    // not the root. In this case, shift the CTM and adjust the CullRect to be root-relative to fix plugin drawing.
     TransformRecorder transform(paintInfo.context, m_layoutPart,
         AffineTransform::translation(widgetPaintOffset.width(), widgetPaintOffset.height()));
+
     CullRect adjustedCullRect(paintInfo.cullRect(), -widgetPaintOffset);
     widget->paint(paintInfo.context, adjustedCullRect);
 }
diff --git a/third_party/WebKit/Source/core/paint/PrePaintTreeWalk.cpp b/third_party/WebKit/Source/core/paint/PrePaintTreeWalk.cpp
index be81d3c..b802098 100644
--- a/third_party/WebKit/Source/core/paint/PrePaintTreeWalk.cpp
+++ b/third_party/WebKit/Source/core/paint/PrePaintTreeWalk.cpp
@@ -65,13 +65,9 @@ void PrePaintTreeWalk::walk(const LayoutObject& object, const PrePaintTreeWalkCo
         walk(*toLayoutMultiColumnSpannerPlaceholder(object).layoutObjectInFlowThread(), localContext);
 
     if (object.isLayoutPart()) {
-        const LayoutPart& layoutPart = toLayoutPart(object);
-        Widget* widget = layoutPart.widget();
-        if (widget && widget->isFrameView()) {
-            localContext.treeBuilderContext.current.paintOffset += layoutPart.replacedContentRect().location() - widget->frameRect().location();
-            localContext.treeBuilderContext.current.paintOffset = roundedIntPoint(localContext.treeBuilderContext.current.paintOffset);
+        Widget* widget = toLayoutPart(object).widget();
+        if (widget && widget->isFrameView())
             walk(*toFrameView(widget), localContext);
-        }
         // TODO(pdr): Investigate RemoteFrameView (crbug.com/579281).
     }
 }
diff --git a/third_party/WebKit/Source/core/paint/VideoPainter.cpp b/third_party/WebKit/Source/core/paint/VideoPainter.cpp
index c324f02..07b42bd 100644
--- a/third_party/WebKit/Source/core/paint/VideoPainter.cpp
+++ b/third_party/WebKit/Source/core/paint/VideoPainter.cpp
@@ -23,12 +23,10 @@ void VideoPainter::paintReplaced(const PaintInfo& paintInfo, const LayoutPoint&
     if (!displayingPoster && !mediaPlayer)
         return;
 
-    LayoutRect replacedRect(m_layoutVideo.replacedContentRect());
-    replacedRect.moveBy(paintOffset);
-    IntRect snappedReplacedRect = pixelSnappedIntRect(replacedRect);
-
-    if (snappedReplacedRect.isEmpty())
+    LayoutRect rect(m_layoutVideo.videoBox());
+    if (rect.isEmpty())
         return;
+    rect.moveBy(paintOffset);
 
     if (LayoutObjectDrawingRecorder::useCachedDrawingIfPossible(paintInfo.context, m_layoutVideo, paintInfo.phase))
         return;
@@ -53,17 +51,15 @@ void VideoPainter::paintReplaced(const PaintInfo& paintInfo, const LayoutPoint&
         }
     }
 
-    // TODO(trchen): Video rect could overflow the content rect due to object-fit.
-    // Should apply a clip here like EmbeddedObjectPainter does.
     LayoutObjectDrawingRecorder drawingRecorder(context, m_layoutVideo, paintInfo.phase, contentRect);
 
     if (displayingPoster || !forceSoftwareVideoPaint) {
         // This will display the poster image, if one is present, and otherwise paint nothing.
-        ImagePainter(m_layoutVideo).paintIntoRect(context, replacedRect, contentRect);
+        ImagePainter(m_layoutVideo).paintIntoRect(context, rect, contentRect);
     } else {
         SkPaint videoPaint = context.fillPaint();
         videoPaint.setColor(SK_ColorBLACK);
-        m_layoutVideo.videoElement()->paintCurrentFrame(context.canvas(), snappedReplacedRect, &videoPaint);
+        m_layoutVideo.videoElement()->paintCurrentFrame(context.canvas(), pixelSnappedIntRect(rect), &videoPaint);
     }
 }
 
diff --git a/third_party/WebKit/Source/core/style/ComputedStyle.cpp b/third_party/WebKit/Source/core/style/ComputedStyle.cpp
index 984ff42..308fd1a 100644
--- a/third_party/WebKit/Source/core/style/ComputedStyle.cpp
+++ b/third_party/WebKit/Source/core/style/ComputedStyle.cpp
@@ -64,6 +64,8 @@ struct SameSizeAsBorderValue {
 
 static_assert(sizeof(BorderValue) == sizeof(SameSizeAsBorderValue), "BorderValue should stay small");
 
+// Since different compilers/architectures pack ComputedStyle differently,
+// re-create the same structure for an accurate size comparison.
 struct SameSizeAsComputedStyle : public RefCounted<SameSizeAsComputedStyle> {
     void* dataRefs[7];
     void* ownPtrs[1];
@@ -197,8 +199,15 @@ StyleRecalcChange ComputedStyle::stylePropagationDiff(const ComputedStyle* oldSt
         || oldStyle->justifyItems() != newStyle->justifyItems()) // TODO (lajava): We must avoid this Reattach.
         return Reattach;
 
-    if (!oldStyle->inheritedEqual(*newStyle)
-        || !oldStyle->loadingCustomFontsEqual(*newStyle))
+    bool independentEqual = oldStyle->independentInheritedEqual(*newStyle);
+    bool nonIndependentEqual = oldStyle->nonIndependentInheritedEqual(*newStyle);
+    if (!independentEqual || !nonIndependentEqual) {
+        if (nonIndependentEqual && !oldStyle->hasExplicitlyInheritedProperties())
+            return IndependentInherit;
+        return Inherit;
+    }
+
+    if (!oldStyle->loadingCustomFontsEqual(*newStyle))
         return Inherit;
 
     if (*oldStyle == *newStyle)
@@ -210,6 +219,15 @@ StyleRecalcChange ComputedStyle::stylePropagationDiff(const ComputedStyle* oldSt
     return NoInherit;
 }
 
+// TODO(sashab): Generate this function.
+void ComputedStyle::propagateIndependentInheritedProperties(const ComputedStyle& parentStyle)
+{
+    if (m_nonInheritedData.m_isPointerEventsInherited)
+        setPointerEvents(parentStyle.pointerEvents());
+    if (m_nonInheritedData.m_isVisibilityInherited)
+        setVisibility(parentStyle.visibility());
+}
+
 ItemPosition ComputedStyle::resolveAlignment(const ComputedStyle& parentStyle, const ComputedStyle& childStyle, ItemPosition resolvedAutoPositionForLayoutObject)
 {
     // The auto keyword computes to the parent's align-items computed value, or to "stretch", if not set or "auto".
@@ -342,6 +360,11 @@ void ComputedStyle::copyNonInheritedFromCached(const ComputedStyle& other)
     // m_nonInheritedData.m_affectedByDrag
     // m_nonInheritedData.m_isLink
 
+    // Any properties that are inherited on a style are also inherited on elements
+    // that share this style.
+    m_nonInheritedData.m_isPointerEventsInherited = other.m_nonInheritedData.m_isPointerEventsInherited;
+    m_nonInheritedData.m_isVisibilityInherited = other.m_nonInheritedData.m_isVisibilityInherited;
+
     if (m_svgStyle != other.m_svgStyle)
         m_svgStyle.access()->copyNonInheritedFromCached(other.m_svgStyle.get());
     DCHECK_EQ(zoom(), initialZoom());
@@ -421,7 +444,18 @@ void ComputedStyle::removeCachedPseudoStyle(PseudoId pid)
 
 bool ComputedStyle::inheritedEqual(const ComputedStyle& other) const
 {
-    return m_inheritedData == other.m_inheritedData
+    return independentInheritedEqual(other)
+        && nonIndependentInheritedEqual(other);
+}
+
+bool ComputedStyle::independentInheritedEqual(const ComputedStyle& other) const
+{
+    return m_inheritedData.compareEqualIndependent(other.m_inheritedData);
+}
+
+bool ComputedStyle::nonIndependentInheritedEqual(const ComputedStyle& other) const
+{
+    return m_inheritedData.compareEqualNonIndependent(other.m_inheritedData)
         && m_styleInheritedData == other.m_styleInheritedData
         && m_svgStyle->inheritedEqual(*other.m_svgStyle)
         && m_rareInheritedData == other.m_rareInheritedData;
diff --git a/third_party/WebKit/Source/core/style/ComputedStyle.h b/third_party/WebKit/Source/core/style/ComputedStyle.h
index fee328e..d3d6c3c 100644
--- a/third_party/WebKit/Source/core/style/ComputedStyle.h
+++ b/third_party/WebKit/Source/core/style/ComputedStyle.h
@@ -164,11 +164,27 @@ protected:
     struct InheritedData {
         bool operator==(const InheritedData& other) const
         {
+            return compareEqualIndependent(other)
+                && compareEqualNonIndependent(other);
+        }
+
+        bool operator!=(const InheritedData& other) const { return !(*this == other); }
+
+        inline bool compareEqualIndependent(const InheritedData& other) const
+        {
+            // These must match the properties tagged 'independent' in
+            // CSSProperties.in.
+            // TODO(sashab): Generate this function.
+            return (m_visibility == other.m_visibility)
+                && (m_pointerEvents == other.m_pointerEvents);
+        }
+
+        inline bool compareEqualNonIndependent(const InheritedData& other) const
+        {
             return (m_emptyCells == other.m_emptyCells)
                 && (m_captionSide == other.m_captionSide)
                 && (m_listStyleType == other.m_listStyleType)
                 && (m_listStylePosition == other.m_listStylePosition)
-                && (m_visibility == other.m_visibility)
                 && (m_textAlign == other.m_textAlign)
                 && (m_textTransform == other.m_textTransform)
                 && (m_textUnderline == other.m_textUnderline)
@@ -179,13 +195,10 @@ protected:
                 && (m_boxDirection == other.m_boxDirection)
                 && (m_rtlOrdering == other.m_rtlOrdering)
                 && (m_printColorAdjust == other.m_printColorAdjust)
-                && (m_pointerEvents == other.m_pointerEvents)
                 && (m_insideLink == other.m_insideLink)
                 && (m_writingMode == other.m_writingMode);
         }
 
-        bool operator!=(const InheritedData& other) const { return !(*this == other); }
-
         unsigned m_emptyCells : 1; // EEmptyCells
         unsigned m_captionSide : 2; // ECaptionSide
         unsigned m_listStyleType : 7; // EListStyleType
@@ -214,7 +227,8 @@ protected:
 
 // don't inherit
     struct NonInheritedData {
-        // Compare computed styles, differences in other flags should not cause an inequality.
+        // Compare computed styles, differences in inherited bits or other flags
+        // should not cause an inequality.
         bool operator==(const NonInheritedData& other) const
         {
             return m_effectiveDisplay == other.m_effectiveDisplay
@@ -242,6 +256,7 @@ protected:
                 // affectedByActive
                 // affectedByDrag
                 // isLink
+                // isInherited flags
         }
 
         bool operator!=(const NonInheritedData& other) const { return !(*this == other); }
@@ -286,8 +301,29 @@ protected:
         unsigned m_isLink : 1;
 
         mutable unsigned m_hasRemUnits : 1;
+
+
+        // For each independent inherited property, store a 1 if the stored
+        // value was inherited from its parent, or 0 if it is explicitly set on
+        // this element.
+        // Eventually, all properties will have a bit in here to store whether
+        // they were inherited from their parent or not.
+        // Although two ComputedStyles are equal if their nonInheritedData is
+        // equal regardless of the isInherited flags, this struct is stored next
+        // to the existing flags to take advantage of packing as much as possible.
+        // TODO(sashab): Move these flags closer to inheritedData so that it's
+        // clear which inherited properties have a flag stored and which don't.
+        // Keep this list of fields in sync with:
+        // - setBitDefaults()
+        // - The ComputedStyle setter, which must take an extra boolean parameter and set this
+        // - propagateIndependentInheritedProperties() in ComputedStyle.cpp
+        // - The compareEqual() methods in the corresponding class
+        // InheritedFlags
+        unsigned m_isPointerEventsInherited : 1;
+        unsigned m_isVisibilityInherited : 1;
+
         // If you add more style bits here, you will also need to update ComputedStyle::copyNonInheritedFromCached()
-        // 66 bits
+        // 68 bits
     } m_nonInheritedData;
 
 // !END SYNC!
@@ -339,6 +375,10 @@ protected:
         m_nonInheritedData.m_affectedByDrag = false;
         m_nonInheritedData.m_isLink = false;
         m_nonInheritedData.m_hasRemUnits = false;
+
+        // All independently inherited properties default to being inherited.
+        m_nonInheritedData.m_isPointerEventsInherited = true;
+        m_nonInheritedData.m_isVisibilityInherited = true;
     }
 
 private:
@@ -369,6 +409,10 @@ public:
     // Computes how the style change should be propagated down the tree.
     static StyleRecalcChange stylePropagationDiff(const ComputedStyle* oldStyle, const ComputedStyle* newStyle);
 
+    // Copies the values of any independent inherited properties from the parent
+    // that are not explicitly set in this style.
+    void propagateIndependentInheritedProperties(const ComputedStyle& parentStyle);
+
     ContentPosition resolvedJustifyContentPosition(const StyleContentAlignmentData& normalValueBehavior) const;
     ContentDistributionType resolvedJustifyContentDistribution(const StyleContentAlignmentData& normalValueBehavior) const;
     ContentPosition resolvedAlignContentPosition(const StyleContentAlignmentData& normalValueBehavior) const;
@@ -1394,6 +1438,7 @@ public:
     static EPointerEvents initialPointerEvents() { return PE_AUTO; }
     EPointerEvents pointerEvents() const { return static_cast<EPointerEvents>(m_inheritedData.m_pointerEvents); }
     void setPointerEvents(EPointerEvents p) { m_inheritedData.m_pointerEvents = p; }
+    void setPointerEventsIsInherited(bool isInherited) { m_nonInheritedData.m_isPointerEventsInherited = isInherited; }
 
     // quotes
     static QuotesData* initialQuotes() { return 0; }
@@ -1471,6 +1516,7 @@ public:
     static EVisibility initialVisibility() { return VISIBLE; }
     EVisibility visibility() const { return static_cast<EVisibility>(m_inheritedData.m_visibility); }
     void setVisibility(EVisibility v) { m_inheritedData.m_visibility = v; }
+    void setVisibilityIsInherited(bool isInherited) { m_nonInheritedData.m_isVisibilityInherited = isInherited; }
 
     // white-space inherited
     static EWhiteSpace initialWhiteSpace() { return NORMAL; }
@@ -1713,6 +1759,8 @@ public:
 
     bool inheritedEqual(const ComputedStyle&) const;
     bool nonInheritedEqual(const ComputedStyle&) const;
+    inline bool independentInheritedEqual(const ComputedStyle&) const;
+    inline bool nonIndependentInheritedEqual(const ComputedStyle&) const;
     bool loadingCustomFontsEqual(const ComputedStyle&) const;
     bool inheritedDataShared(const ComputedStyle&) const;
 
diff --git a/third_party/WebKit/Source/core/style/ComputedStyleConstants.h b/third_party/WebKit/Source/core/style/ComputedStyleConstants.h
index f9b57ee..a5f6dff 100644
--- a/third_party/WebKit/Source/core/style/ComputedStyleConstants.h
+++ b/third_party/WebKit/Source/core/style/ComputedStyleConstants.h
@@ -42,6 +42,7 @@ enum StyleRecalcChange {
     NoChange,
     NoInherit,
     UpdatePseudoElements,
+    IndependentInherit,
     Inherit,
     Force,
     Reattach,
diff --git a/third_party/WebKit/Source/core/testing/InternalSettings.cpp b/third_party/WebKit/Source/core/testing/InternalSettings.cpp
index 70ef482..b579924 100644
--- a/third_party/WebKit/Source/core/testing/InternalSettings.cpp
+++ b/third_party/WebKit/Source/core/testing/InternalSettings.cpp
@@ -471,6 +471,11 @@ void InternalSettings::setScrollTopLeftInteropEnabled(bool enabled)
     RuntimeEnabledFeatures::setScrollTopLeftInteropEnabled(enabled);
 }
 
+void InternalSettings::setLinkHeaderEnabled(bool enabled)
+{
+    RuntimeEnabledFeatures::setLinkHeaderEnabled(enabled);
+}
+
 void InternalSettings::setDnsPrefetchLogging(bool enabled, ExceptionState& exceptionState)
 {
     InternalSettingsGuardForSettings();
diff --git a/third_party/WebKit/Source/core/testing/InternalSettings.h b/third_party/WebKit/Source/core/testing/InternalSettings.h
index 4b3abab..7245d6c 100644
--- a/third_party/WebKit/Source/core/testing/InternalSettings.h
+++ b/third_party/WebKit/Source/core/testing/InternalSettings.h
@@ -119,6 +119,7 @@ public:
     void setImageColorProfilesEnabled(bool);
     void setImageAnimationPolicy(const String&, ExceptionState&);
     void setScrollTopLeftInteropEnabled(bool);
+    void setLinkHeaderEnabled(bool);
 
     DECLARE_VIRTUAL_TRACE();
 
diff --git a/third_party/WebKit/Source/core/testing/InternalSettings.idl b/third_party/WebKit/Source/core/testing/InternalSettings.idl
index d46cc85..05a8d10 100644
--- a/third_party/WebKit/Source/core/testing/InternalSettings.idl
+++ b/third_party/WebKit/Source/core/testing/InternalSettings.idl
@@ -64,4 +64,5 @@
     void setExperimentalContentSecurityPolicyFeaturesEnabled(boolean enabled);
     void setImageColorProfilesEnabled(boolean enabled);
     void setScrollTopLeftInteropEnabled(boolean enabled);
+    void setLinkHeaderEnabled(boolean enabled);
 };
diff --git a/third_party/WebKit/Source/core/testing/Internals.cpp b/third_party/WebKit/Source/core/testing/Internals.cpp
index fa5e387..d248345 100644
--- a/third_party/WebKit/Source/core/testing/Internals.cpp
+++ b/third_party/WebKit/Source/core/testing/Internals.cpp
@@ -2127,7 +2127,8 @@ String Internals::getCurrentCursorInfo()
     }
     if (cursor.imageScaleFactor() != 1) {
         result.append(" scale=");
-        result.appendNumber(cursor.imageScaleFactor(), 8);
+        NumberToStringBuffer buffer;
+        result.append(numberToFixedPrecisionString(cursor.imageScaleFactor(), 8, buffer, true));
     }
 
     return result.toString();
diff --git a/third_party/WebKit/Source/core/xmlhttprequest/XMLHttpRequest.cpp b/third_party/WebKit/Source/core/xmlhttprequest/XMLHttpRequest.cpp
index 00ec92b..463ebb7 100644
--- a/third_party/WebKit/Source/core/xmlhttprequest/XMLHttpRequest.cpp
+++ b/third_party/WebKit/Source/core/xmlhttprequest/XMLHttpRequest.cpp
@@ -632,7 +632,11 @@ bool XMLHttpRequest::initSend(ExceptionState& exceptionState)
     }
 
     if (!m_async && exceptionState.isolate() && v8::MicrotasksScope::IsRunningMicrotasks(exceptionState.isolate())) {
-        UseCounter::count(getExecutionContext(), UseCounter::During_Microtask_SyncXHR);
+        Deprecation::countDeprecation(getExecutionContext(), UseCounter::During_Microtask_SyncXHR);
+        if (RuntimeEnabledFeatures::disableBlockingMethodsDuringMicrotasksEnabled()) {
+            exceptionState.throwDOMException(InvalidAccessError, "Cannot send() synchronous requests during microtask execution.");
+            return false;
+        }
     }
 
 
diff --git a/third_party/WebKit/Source/devtools/devtools.gypi b/third_party/WebKit/Source/devtools/devtools.gypi
index 5ab2704..131ce28 100644
--- a/third_party/WebKit/Source/devtools/devtools.gypi
+++ b/third_party/WebKit/Source/devtools/devtools.gypi
@@ -307,6 +307,7 @@
             'front_end/ui/ThrottledView.js',
             'front_end/ui/UIUtils.js',
             'front_end/ui/View.js',
+            'front_end/ui/ViewContainers.js',
             'front_end/ui/ViewportControl.js',
             'front_end/ui/Widget.js',
             'front_end/ui/ZoomManager.js',
diff --git a/third_party/WebKit/Source/devtools/front_end/accessibility/AccessibilitySidebarView.js b/third_party/WebKit/Source/devtools/front_end/accessibility/AccessibilitySidebarView.js
index 7197e06..90b49dd 100644
--- a/third_party/WebKit/Source/devtools/front_end/accessibility/AccessibilitySidebarView.js
+++ b/third_party/WebKit/Source/devtools/front_end/accessibility/AccessibilitySidebarView.js
@@ -10,12 +10,12 @@ WebInspector.AccessibilitySidebarView = function()
 {
     WebInspector.ThrottledView.call(this, WebInspector.UIString("Accessibility"));
     this._node = null;
-    this._sidebarPaneStack = WebInspector.viewManager.createStackLocation();
+    this._sidebarPaneStack = new WebInspector.View.ExpandableStackContainer();
     this._ariaSubPane = new WebInspector.ARIAAttributesPane();
-    this._sidebarPaneStack.showView(this._ariaSubPane);
+    this._sidebarPaneStack.appendView(this._ariaSubPane, true);
     this._axNodeSubPane = new WebInspector.AXNodeSubPane();
-    this._sidebarPaneStack.showView(this._axNodeSubPane);
-    this._sidebarPaneStack.widget().show(this.element);
+    this._sidebarPaneStack.appendView(this._axNodeSubPane, true);
+    this._sidebarPaneStack.show(this.element);
     WebInspector.context.addFlavorChangeListener(WebInspector.DOMNode, this._pullNode, this);
     this._pullNode();
 }
@@ -123,12 +123,12 @@ WebInspector.AccessibilitySidebarView.prototype = {
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {string} name
  */
 WebInspector.AccessibilitySubPane = function(name)
 {
-    WebInspector.SimpleView.call(this, name);
+    WebInspector.View.call(this, name);
 
     this._axNode = null;
     this.registerRequiredCSS("accessibility/accessibilityNode.css");
@@ -186,5 +186,5 @@ WebInspector.AccessibilitySubPane.prototype = {
         return treeOutline;
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/audits/AuditResultView.js b/third_party/WebKit/Source/devtools/front_end/audits/AuditResultView.js
index 23423c9..b496b3b 100644
--- a/third_party/WebKit/Source/devtools/front_end/audits/AuditResultView.js
+++ b/third_party/WebKit/Source/devtools/front_end/audits/AuditResultView.js
@@ -30,12 +30,12 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {!WebInspector.AuditCategoryResult} categoryResult
  */
 WebInspector.AuditCategoryResultPane = function(categoryResult)
 {
-    WebInspector.SimpleView.call(this, categoryResult.title);
+    WebInspector.View.call(this, categoryResult.title);
     this._treeOutline = new TreeOutlineInShadow();
     this._treeOutline.registerRequiredCSS("audits/auditResultTree.css");
     this._treeOutline.element.classList.add("audit-result-tree");
@@ -57,7 +57,7 @@ WebInspector.AuditCategoryResultPane = function(categoryResult)
         var treeElement = this._appendResult(this._treeOutline.rootElement(), ruleResult, ruleResult.severity);
         treeElement.listItemElement.classList.add("audit-result");
     }
-    this.revealView();
+    this.revealWidget();
 }
 
 WebInspector.AuditCategoryResultPane.prototype = {
@@ -105,5 +105,5 @@ WebInspector.AuditCategoryResultPane.prototype = {
         return treeElement;
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/audits/AuditsPanel.js b/third_party/WebKit/Source/devtools/front_end/audits/AuditsPanel.js
index dbacdd4..a51f8ee 100644
--- a/third_party/WebKit/Source/devtools/front_end/audits/AuditsPanel.js
+++ b/third_party/WebKit/Source/devtools/front_end/audits/AuditsPanel.js
@@ -129,14 +129,14 @@ WebInspector.AuditsPanel.prototype = {
      */
     showResults: function(categoryResults)
     {
-        if (!categoryResults._resultLocation) {
+        if (!categoryResults._resultView) {
             categoryResults.sort((a, b) => (a.title || "").localeCompare(b.title || ""));
-            var resultView = WebInspector.viewManager.createStackLocation();
+            var resultView = new WebInspector.View.ExpandableStackContainer();
             for (var i = 0; i < categoryResults.length; ++i)
-                resultView.showView(new WebInspector.AuditCategoryResultPane(categoryResults[i]));
-            categoryResults._resultLocation = resultView;
+                resultView.appendView(new WebInspector.AuditCategoryResultPane(categoryResults[i]), true);
+            categoryResults._resultView = resultView;
         }
-        this.visibleView = categoryResults._resultLocation.widget();
+        this.visibleView = categoryResults._resultView;
     },
 
     showLauncherView: function()
diff --git a/third_party/WebKit/Source/devtools/front_end/common/Color.js b/third_party/WebKit/Source/devtools/front_end/common/Color.js
index f185484..773902c 100644
--- a/third_party/WebKit/Source/devtools/front_end/common/Color.js
+++ b/third_party/WebKit/Source/devtools/front_end/common/Color.js
@@ -54,9 +54,6 @@ WebInspector.Color = function(rgba, format, originalText)
     }
 }
 
-/** @type {!RegExp} */
-WebInspector.Color.Regex = /((?:rgb|hsl)a?\([^)]+\)|#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}|\b[a-zA-Z]+\b(?!-))/g;
-
 /**
  * @enum {string}
  */
diff --git a/third_party/WebKit/Source/devtools/front_end/common/Geometry.js b/third_party/WebKit/Source/devtools/front_end/common/Geometry.js
index 716b9ea..4594ff1 100644
--- a/third_party/WebKit/Source/devtools/front_end/common/Geometry.js
+++ b/third_party/WebKit/Source/devtools/front_end/common/Geometry.js
@@ -109,9 +109,6 @@ WebInspector.Geometry.CubicBezier = function(point1, point2)
     this.controlPoints = [point1, point2];
 }
 
-/** @type {!RegExp} */
-WebInspector.Geometry.CubicBezier.Regex = /((cubic-bezier\([^)]+\))|\b(linear|ease-in-out|ease-in|ease-out|ease)\b)/g;
-
 WebInspector.Geometry.CubicBezier.KeywordValues = {
     "linear": "cubic-bezier(0, 0, 1, 1)",
     "ease": "cubic-bezier(0.25, 0.1, 0.25, 1)",
diff --git a/third_party/WebKit/Source/devtools/front_end/common/TextUtils.js b/third_party/WebKit/Source/devtools/front_end/common/TextUtils.js
index 0eaedbb..f7055a4 100644
--- a/third_party/WebKit/Source/devtools/front_end/common/TextUtils.js
+++ b/third_party/WebKit/Source/devtools/front_end/common/TextUtils.js
@@ -148,63 +148,6 @@ WebInspector.TextUtils = {
     isLowerCase: function(text)
     {
         return text === text.toLowerCase();
-    },
-
-    /**
-     * @param {string} text
-     * @param {!Array<!RegExp>} regexes
-     * @return {!Array<{value: string, position: number, regexIndex: number}>}
-     */
-    splitStringByRegexes(text, regexes)
-    {
-        var matches = [];
-        var globalRegexes = [];
-        for (var i = 0; i < regexes.length; i++) {
-            var regex = regexes[i];
-            if (!regex.global)
-                globalRegexes.push(new RegExp(regex.source, regex.flags ? regex.flags + "g" : "g"));
-            else
-                globalRegexes.push(regex);
-        }
-        doSplit(text, 0, 0);
-        return matches;
-
-        /**
-         * @param {string} text
-         * @param {number} regexIndex
-         * @param {number} startIndex
-         */
-        function doSplit(text, regexIndex, startIndex)
-        {
-            if (regexIndex >= globalRegexes.length) {
-                // Set regexIndex as -1 if text did not match with any regular expression
-                matches.push({
-                    value: text,
-                    position: startIndex,
-                    regexIndex: -1
-                });
-                return;
-            }
-            var regex = globalRegexes[regexIndex];
-            var currentIndex = 0;
-            var result;
-            regex.lastIndex = 0;
-            while ((result = regex.exec(text)) !== null) {
-                var stringBeforeMatch = text.substring(currentIndex, result.index);
-                if (stringBeforeMatch)
-                    doSplit(stringBeforeMatch, regexIndex + 1, startIndex + currentIndex);
-                var match = result[0];
-                matches.push({
-                    value: match,
-                    position: startIndex + result.index,
-                    regexIndex: regexIndex
-                });
-                currentIndex = result.index + match.length;
-            }
-            var stringAfterMatches = text.substring(currentIndex);
-            if (stringAfterMatches)
-                doSplit(stringAfterMatches, regexIndex + 1, startIndex + currentIndex);
-        }
     }
 }
 
diff --git a/third_party/WebKit/Source/devtools/front_end/components/BreakpointsSidebarPaneBase.js b/third_party/WebKit/Source/devtools/front_end/components/BreakpointsSidebarPaneBase.js
index 251248e..07c6b5f 100644
--- a/third_party/WebKit/Source/devtools/front_end/components/BreakpointsSidebarPaneBase.js
+++ b/third_party/WebKit/Source/devtools/front_end/components/BreakpointsSidebarPaneBase.js
@@ -30,12 +30,12 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {string} title
  */
 WebInspector.BreakpointsSidebarPaneBase = function(title)
 {
-    WebInspector.SimpleView.call(this, title);
+    WebInspector.View.call(this, title);
     this.registerRequiredCSS("components/breakpointsList.css");
 
     this.listElement = createElement("ol");
@@ -92,5 +92,5 @@ WebInspector.BreakpointsSidebarPaneBase.prototype = {
         }
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/components/DOMBreakpointsSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/components/DOMBreakpointsSidebarPane.js
index 51424e1..7f7b6cc 100644
--- a/third_party/WebKit/Source/devtools/front_end/components/DOMBreakpointsSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/components/DOMBreakpointsSidebarPane.js
@@ -326,7 +326,7 @@ WebInspector.DOMBreakpointsSidebarPane.prototype = {
         var element = this._breakpointElements[breakpointId];
         if (!element)
             return;
-        this.revealView();
+        this.revealWidget();
         element.classList.add("breakpoint-hit");
         this._highlightedElement = element;
     },
@@ -419,13 +419,13 @@ WebInspector.DOMBreakpointsSidebarPane.prototype = {
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {!WebInspector.DOMBreakpointsSidebarPane} pane
  * @param {!WebInspector.Panel} panel
  */
 WebInspector.DOMBreakpointsSidebarPane.Proxy = function(pane, panel)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("DOM Breakpoints"));
+    WebInspector.View.call(this, WebInspector.UIString("DOM Breakpoints"));
     this.registerRequiredCSS("components/breakpointsList.css");
 
     this._wrappedPane = pane;
@@ -435,7 +435,7 @@ WebInspector.DOMBreakpointsSidebarPane.Proxy = function(pane, panel)
 WebInspector.DOMBreakpointsSidebarPane.Proxy.prototype = {
     wasShown: function()
     {
-        WebInspector.SimpleView.prototype.wasShown.call(this);
+        WebInspector.View.prototype.wasShown.call(this);
         this._reattachBody();
     },
 
@@ -445,7 +445,7 @@ WebInspector.DOMBreakpointsSidebarPane.Proxy.prototype = {
             this._wrappedPane.show(this.element);
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
 
 /**
diff --git a/third_party/WebKit/Source/devtools/front_end/components/ExecutionContextSelector.js b/third_party/WebKit/Source/devtools/front_end/components/ExecutionContextSelector.js
index 932dcbc..0cf6dd8 100644
--- a/third_party/WebKit/Source/devtools/front_end/components/ExecutionContextSelector.js
+++ b/third_party/WebKit/Source/devtools/front_end/components/ExecutionContextSelector.js
@@ -195,48 +195,32 @@ WebInspector.ExecutionContextSelector.prototype = {
  */
 WebInspector.ExecutionContextSelector.completionsForTextPromptInCurrentContext = function(proxyElement, wordRange, force, completionsReadyCallback)
 {
-    var expressionRange = wordRange.cloneRange();
-    expressionRange.collapse(true);
-    expressionRange.setStartBefore(proxyElement);
-    WebInspector.ExecutionContextSelector.completionsForTextInCurrentContext(expressionRange.toString(), wordRange.toString(), force, completionsReadyCallback);
-}
-/**
- * @param {string} text
- * @param {string} completionsPrefix
- * @param {boolean} force
- * @param {function(!Array.<string>, number=)} completionsReadyCallback
- */
-WebInspector.ExecutionContextSelector.completionsForTextInCurrentContext = function(text, completionsPrefix, force, completionsReadyCallback)
-{
     var executionContext = WebInspector.context.flavor(WebInspector.ExecutionContext);
     if (!executionContext) {
         completionsReadyCallback([]);
         return;
     }
-    var index;
-    var stopChars = new Set(" =:({;,!+-*/&|^<>`".split(""));
-    for (index = text.length - 1; index >= 0; index--) {
-        // Pass less stop characters to rangeOfWord so the range will be a more complete expression.
-        if (stopChars.has(text.charAt(index)))
-            break;
-    }
-    var clippedExpression = text.substring(index + 1);
-    var bracketCount = 0;
 
-    index = clippedExpression.length - 1;
+    // Pass less stop characters to rangeOfWord so the range will be a more complete expression.
+    var expressionRange = wordRange.startContainer.rangeOfWord(wordRange.startOffset, " =:({;,!+-*/&|^<>`", proxyElement, "backward");
+    var expressionString = expressionRange.toString();
+
+    var bracketCount = 0;
+    var index = expressionString.length - 1;
     while (index >= 0) {
-        var character = clippedExpression.charAt(index);
+        var character = expressionString.charAt(index);
         if (character === "]")
             bracketCount++;
         // Allow an open bracket at the end for property completion.
-        if (character === "[" && index < clippedExpression.length - 1) {
+        if (character === "[" && index < expressionString.length - 1) {
             bracketCount--;
             if (bracketCount < 0)
                 break;
         }
         index--;
     }
-    clippedExpression = clippedExpression.substring(index + 1);
+    expressionString = expressionString.substring(index + 1);
 
-    executionContext.completionsForExpression(clippedExpression, completionsPrefix, force, completionsReadyCallback);
+    var prefix = wordRange.toString();
+    executionContext.completionsForExpression(expressionString, prefix, force, completionsReadyCallback);
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/components/ObjectPropertiesSection.js b/third_party/WebKit/Source/devtools/front_end/components/ObjectPropertiesSection.js
index 1066e65..ab3f4c6 100644
--- a/third_party/WebKit/Source/devtools/front_end/components/ObjectPropertiesSection.js
+++ b/third_party/WebKit/Source/devtools/front_end/components/ObjectPropertiesSection.js
@@ -43,22 +43,10 @@ WebInspector.ObjectPropertiesSection = function(object, title, linkifier, emptyP
     this.setFocusable(false);
     this._objectTreeElement = new WebInspector.ObjectPropertiesSection.RootElement(object, linkifier, emptyPlaceholder, ignoreHasOwnProperty, extraProperties);
     this.appendChild(this._objectTreeElement);
-    if (typeof title === "string" || !title) {
-        this.titleElement = this.element.createChild("span");
-        this.titleElement.textContent = title || "";
-    } else {
-        this.titleElement = title;
+    if (typeof title === "string" || !title)
+        this.element.createChild("span").textContent = title || "";
+    else
         this.element.appendChild(title);
-    }
-
-    if (object.description && WebInspector.ObjectPropertiesSection._needsAlternateTitle(object)) {
-        this.expandedTitleElement = createElement("span");
-        this.expandedTitleElement.createTextChild(object.description);
-
-        var note = this.expandedTitleElement.createChild("span", "object-state-note");
-        note.classList.add("info-note");
-        note.title = WebInspector.UIString("Value below was evaluated just now.");
-    }
 
     this.element._section = this;
     this.registerRequiredCSS("components/objectValue.css");
@@ -185,39 +173,17 @@ WebInspector.ObjectPropertiesSection.RootElement = function(object, linkifier, e
 }
 
 WebInspector.ObjectPropertiesSection.RootElement.prototype = {
-    /**
-     * @override
-     */
+
     onexpand: function()
     {
-        if (this.treeOutline) {
+        if (this.treeOutline)
             this.treeOutline.element.classList.add("expanded");
-            this._showExpandedTitleElement(true);
-        }
     },
 
-    /**
-     * @override
-     */
     oncollapse: function()
     {
-        if (this.treeOutline) {
+        if (this.treeOutline)
             this.treeOutline.element.classList.remove("expanded");
-            this._showExpandedTitleElement(false);
-        }
-    },
-
-    /**
-     * @param {boolean} value
-     */
-    _showExpandedTitleElement: function(value)
-    {
-        if (!this.treeOutline.expandedTitleElement)
-            return;
-        if (value)
-            this.treeOutline.element.replaceChild(this.treeOutline.expandedTitleElement, this.treeOutline.titleElement);
-        else
-            this.treeOutline.element.replaceChild(this.treeOutline.titleElement, this.treeOutline.expandedTitleElement);
     },
 
     /**
@@ -318,8 +284,8 @@ WebInspector.ObjectPropertyTreeElement.prototype = {
      */
     ondblclick: function(event)
     {
-        var inEditableElement = event.target.isSelfOrDescendant(this.valueElement) || (this.expandedValueElement && event.target.isSelfOrDescendant(this.expandedValueElement));
-        if (!this.property.value.customPreview() && inEditableElement && (this.property.writable || this.property.setter))
+        var editableElement = this.valueElement;
+        if (!this.property.value.customPreview() && (this.property.writable || this.property.setter) && event.target.isSelfOrDescendant(editableElement))
             this._startEditing();
         return false;
     },
@@ -333,51 +299,6 @@ WebInspector.ObjectPropertyTreeElement.prototype = {
         this._updateExpandable();
     },
 
-    /**
-     * @override
-     */
-    onexpand: function()
-    {
-        this._showExpandedValueElement(true);
-    },
-
-    /**
-     * @override
-     */
-    oncollapse: function()
-    {
-        this._showExpandedValueElement(false);
-    },
-
-    /**
-     * @param {boolean} value
-     */
-    _showExpandedValueElement: function(value)
-    {
-        if (!this.expandedValueElement)
-            return;
-        if (value)
-            this.listItemElement.replaceChild(this.expandedValueElement, this.valueElement);
-        else
-            this.listItemElement.replaceChild(this.valueElement, this.expandedValueElement);
-    },
-
-    /**
-     * @param {!WebInspector.RemoteObject} value
-     * @return {?Element}
-     */
-    _createExpandedValueElement: function(value)
-    {
-        if (!WebInspector.ObjectPropertiesSection._needsAlternateTitle(value))
-            return null;
-
-        var valueElement = createElementWithClass("span", "value");
-        valueElement.setTextContentTruncatedIfNeeded(value.description || "");
-        valueElement.classList.add("object-value-" + (value.subtype || value.type));
-        valueElement.title = value.description || "";
-        return valueElement;
-    },
-
     update: function()
     {
         this.nameElement = WebInspector.ObjectPropertiesSection.createNameElement(this.property.name);
@@ -405,10 +326,6 @@ WebInspector.ObjectPropertyTreeElement.prototype = {
             this.valueElement.title = WebInspector.UIString("No property getter");
         }
 
-        var valueText = this.valueElement.textContent;
-        if (this.property.value && valueText && !this.property.wasThrown)
-            this.expandedValueElement = this._createExpandedValueElement(this.property.value);
-
         this.listItemElement.removeChildren();
         this.listItemElement.appendChildren(this.nameElement, separatorElement, this.valueElement);
     },
@@ -460,10 +377,11 @@ WebInspector.ObjectPropertyTreeElement.prototype = {
         this._editableDiv.setTextContentTruncatedIfNeeded(text, WebInspector.UIString("<string is too large to edit>"));
         var originalContent = this._editableDiv.textContent;
 
+        this.valueElement.classList.add("hidden");
+
         // Lie about our children to prevent expanding on double click and to collapse subproperties.
         this.setExpandable(false);
         this.listItemElement.classList.add("editing-sub-part");
-        this.valueElement.classList.add("hidden");
 
         this._prompt = new WebInspector.ObjectPropertyPrompt();
 
@@ -551,7 +469,7 @@ WebInspector.ObjectPropertyTreeElement.prototype = {
                 // Call updateSiblings since their value might be based on the value that just changed.
                 var parent = this.parent;
                 parent.invalidateChildren();
-                parent.onpopulate();
+                parent.expand();
             }
         }
     },
@@ -1177,15 +1095,6 @@ WebInspector.ObjectPropertiesSection.createValueElement = function(value, wasThr
 }
 
 /**
- * @param {!WebInspector.RemoteObject} object
- * @return {boolean}
- */
-WebInspector.ObjectPropertiesSection._needsAlternateTitle = function(object)
-{
-    return object && object.hasChildren && !object.customPreview() && object.subtype !== "node" && object.type !== "function" && (object.type !== "object" || object.preview);
-}
-
-/**
  * @param {!WebInspector.RemoteObject} func
  * @param {!Element} element
  * @param {boolean} linkify
diff --git a/third_party/WebKit/Source/devtools/front_end/console/ConsoleViewMessage.js b/third_party/WebKit/Source/devtools/front_end/console/ConsoleViewMessage.js
index 88394e2..b2e0855 100644
--- a/third_party/WebKit/Source/devtools/front_end/console/ConsoleViewMessage.js
+++ b/third_party/WebKit/Source/devtools/front_end/console/ConsoleViewMessage.js
@@ -417,10 +417,25 @@ WebInspector.ConsoleViewMessage.prototype = {
             }
         }
 
+        var section = this._buildExpandableObjectSection(obj, titleElement);
+        elem.appendChild(section.element);
+    },
+
+    /**
+     * @param {!WebInspector.RemoteObject} obj
+     * @param {!Element} titleElement
+     * @return {!WebInspector.ObjectPropertiesSection}
+     */
+    _buildExpandableObjectSection: function(obj, titleElement)
+    {
+        var note = titleElement.createChild("span", "object-state-note");
+        note.classList.add("info-note");
+        note.title = WebInspector.UIString("Object value at left was snapshotted when logged, value below was evaluated just now.");
+
         var section = new WebInspector.ObjectPropertiesSection(obj, titleElement, this._linkifier);
         section.element.classList.add("console-view-object-properties-section");
         section.enableContextMenu();
-        elem.appendChild(section.element);
+        return section;
     },
 
     /**
@@ -686,9 +701,7 @@ WebInspector.ConsoleViewMessage.prototype = {
 
         titleElement.createTextChild("]");
 
-        var section = new WebInspector.ObjectPropertiesSection(array, titleElement, this._linkifier);
-        section.element.classList.add("console-view-object-properties-section");
-        section.enableContextMenu();
+        var section = this._buildExpandableObjectSection(array, titleElement);
         elem.appendChild(section.element);
     },
 
diff --git a/third_party/WebKit/Source/devtools/front_end/console/consoleView.css b/third_party/WebKit/Source/devtools/front_end/console/consoleView.css
index 3365122..fca30b9 100644
--- a/third_party/WebKit/Source/devtools/front_end/console/consoleView.css
+++ b/third_party/WebKit/Source/devtools/front_end/console/consoleView.css
@@ -453,6 +453,10 @@
     content: "i";
 }
 
+.console-view-object-properties-section:not(.expanded) .info-note {
+    display: none;
+}
+
 .console-view-object-properties-section {
     padding: 0px;
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/elements/ElementsPanel.js b/third_party/WebKit/Source/devtools/front_end/elements/ElementsPanel.js
index 024fda3..5b647e4 100644
--- a/third_party/WebKit/Source/devtools/front_end/elements/ElementsPanel.js
+++ b/third_party/WebKit/Source/devtools/front_end/elements/ElementsPanel.js
@@ -101,7 +101,7 @@ WebInspector.ElementsPanel.prototype = {
     _revealProperty: function(cssProperty)
     {
         var stylesSidebarPane = this.sidebarPanes.styles;
-        this.sidebarPaneView.showView(stylesSidebarPane);
+        this.sidebarPaneView.selectTab(WebInspector.UIString("Styles"));
         stylesSidebarPane.revealProperty(/** @type {!WebInspector.CSSProperty} */(cssProperty));
         return Promise.resolve();
     },
@@ -863,19 +863,21 @@ WebInspector.ElementsPanel.prototype = {
         if (this.sidebarPaneView && horizontally === !this._splitWidget.isVertical())
             return;
 
-        if (this.sidebarPaneView && this.sidebarPaneView.tabbedPane().shouldHideOnDetach())
+        if (this.sidebarPaneView && this.sidebarPaneView.shouldHideOnDetach())
             return; // We can't reparent extension iframes.
 
+        var selectedTabId = this.sidebarPaneView ? this.sidebarPaneView.selectedTabId : null;
+
         var extensionSidebarPanes = WebInspector.extensionServer.sidebarPanes();
         if (this.sidebarPaneView) {
-            this.sidebarPaneView.tabbedPane().detach();
-            this._splitWidget.uninstallResizer(this.sidebarPaneView.tabbedPane().headerElement());
+            this.sidebarPaneView.detach();
+            this._splitWidget.uninstallResizer(this.sidebarPaneView.headerElement());
         }
 
         this._splitWidget.setVertical(!horizontally);
         this.showToolbarPane(null);
 
-        var computedPane = new WebInspector.SimpleView(WebInspector.UIString("Computed"));
+        var computedPane = new WebInspector.View(WebInspector.UIString("Computed"));
         computedPane.element.classList.add("composite");
         computedPane.element.classList.add("fill");
         computedPane.element.classList.add("metrics-and-computed");
@@ -913,18 +915,17 @@ WebInspector.ElementsPanel.prototype = {
                 showMetrics.call(this, false);
         }
 
-        this.sidebarPaneView = WebInspector.viewManager.createTabbedLocation(() => WebInspector.inspectorView.setCurrentPanel(this), "elements-sidebar");
-        var tabbedPane = this.sidebarPaneView.tabbedPane();
-        tabbedPane.element.addEventListener("contextmenu", this._sidebarContextMenuEventFired.bind(this), false);
+        this.sidebarPaneView = new WebInspector.View.TabbedPaneContainer();
+        this.sidebarPaneView.element.addEventListener("contextmenu", this._sidebarContextMenuEventFired.bind(this), false);
         if (this._popoverHelper)
             this._popoverHelper.hidePopover();
-        this._popoverHelper = new WebInspector.PopoverHelper(tabbedPane.element, this._getPopoverAnchor.bind(this), this._showPopover.bind(this));
+        this._popoverHelper = new WebInspector.PopoverHelper(this.sidebarPaneView.element, this._getPopoverAnchor.bind(this), this._showPopover.bind(this));
         this._popoverHelper.setTimeout(0);
 
         if (horizontally) {
-            this._splitWidget.installResizer(tabbedPane.headerElement());
+            this._splitWidget.installResizer(this.sidebarPaneView.headerElement());
 
-            var compositePane = new WebInspector.SimpleView(WebInspector.UIString("Styles"));
+            var compositePane = new WebInspector.View(WebInspector.UIString("Styles"));
             compositePane.element.classList.add("flex-auto");
 
             var splitWidget = new WebInspector.SplitWidget(true, true, "stylesPaneSplitViewState", 215);
@@ -935,26 +936,16 @@ WebInspector.ElementsPanel.prototype = {
 
             computedPane.show(computedStylePanesWrapper.element);
             this.sidebarPaneView.appendView(compositePane);
-
-            // TODO: remove
-            this.sidebarPanes.styles.setParentViewForReveal(compositePane);
-            this.sidebarPanes.computedStyle.setParentViewForReveal(compositePane);
-            this.sidebarPanes.metrics.setParentViewForReveal(compositePane);
         } else {
-            var stylesPane = new WebInspector.SimpleView(WebInspector.UIString("Styles"));
+            var stylesPane = new WebInspector.View(WebInspector.UIString("Styles"));
             stylesPane.element.classList.add("flex-auto", "metrics-and-styles");
 
             matchedStylesContainer.show(stylesPane.element);
             computedStylePanesWrapper.show(computedPane.element);
 
-            tabbedPane.addEventListener(WebInspector.TabbedPane.EventTypes.TabSelected, tabSelected, this);
+            this.sidebarPaneView.addEventListener(WebInspector.TabbedPane.EventTypes.TabSelected, tabSelected, this);
             this.sidebarPaneView.appendView(stylesPane);
             this.sidebarPaneView.appendView(computedPane);
-
-            // TODO: remove
-            this.sidebarPanes.styles.setParentViewForReveal(stylesPane);
-            this.sidebarPanes.computedStyle.setParentViewForReveal(computedPane);
-            this.sidebarPanes.metrics.setParentViewForReveal(computedPane);
         }
 
         this.sidebarPanes.styles.show(matchedStylePanesWrapper.element);
@@ -973,7 +964,10 @@ WebInspector.ElementsPanel.prototype = {
         for (var i = 0; i < extensionSidebarPanes.length; ++i)
             this._addExtensionSidebarPane(extensionSidebarPanes[i]);
 
-        this._splitWidget.setSidebarWidget(this.sidebarPaneView.tabbedPane());
+        this._splitWidget.setSidebarWidget(this.sidebarPaneView);
+
+        if (selectedTabId)
+            this.sidebarPaneView.selectTab(selectedTabId);
     },
 
     /**
diff --git a/third_party/WebKit/Source/devtools/front_end/elements/ElementsSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/elements/ElementsSidebarPane.js
index 3af1ba3..c934bb8 100644
--- a/third_party/WebKit/Source/devtools/front_end/elements/ElementsSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/elements/ElementsSidebarPane.js
@@ -4,12 +4,12 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {string} title
  */
 WebInspector.ElementsSidebarPane = function(title)
 {
-    WebInspector.SimpleView.call(this, title);
+    WebInspector.View.call(this, title);
     this.element.classList.add("flex-none");
     this._computedStyleModel = new WebInspector.ComputedStyleModel();
     this._computedStyleModel.addEventListener(WebInspector.ComputedStyleModel.Events.ComputedStyleChanged, this.onCSSModelChanged, this);
@@ -63,7 +63,7 @@ WebInspector.ElementsSidebarPane.prototype = {
 
     wasShown: function()
     {
-        WebInspector.SimpleView.prototype.wasShown.call(this);
+        WebInspector.View.prototype.wasShown.call(this);
         if (this._updateWhenVisible)
             this.update();
     },
@@ -73,5 +73,5 @@ WebInspector.ElementsSidebarPane.prototype = {
      */
     onCSSModelChanged: function(event) { },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/elements/StylesSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/elements/StylesSidebarPane.js
index 5d7b27d..397a3fa 100644
--- a/third_party/WebKit/Source/devtools/front_end/elements/StylesSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/elements/StylesSidebarPane.js
@@ -63,7 +63,7 @@ WebInspector.StylesSidebarPane.createExclamationMark = function(property)
     exclamationElement.className = "exclamation-mark";
     if (!WebInspector.StylesSidebarPane.ignoreErrorsForProperty(property))
         exclamationElement.type = "warning-icon";
-    exclamationElement.title = WebInspector.CSSMetadata.isCSSPropertyName(property.name) ? WebInspector.UIString("Invalid property value") : WebInspector.UIString("Unknown property name");
+    exclamationElement.title = WebInspector.CSSMetadata.cssPropertiesMetainfo.keySet()[property.name.toLowerCase()] ? WebInspector.UIString("Invalid property value") : WebInspector.UIString("Unknown property name");
     return exclamationElement;
 }
 
@@ -425,7 +425,7 @@ WebInspector.StylesSidebarPane.prototype = {
      */
     _addBlankSection: function(insertAfterSection, styleSheetId, ruleLocation)
     {
-        this.revealView();
+        this.revealWidget();
         var node = this.node();
         var blankSection = new WebInspector.BlankStylePropertiesSection(this, insertAfterSection._matchedStyles, node ? WebInspector.DOMPresentationUtils.simpleSelector(node) : "", styleSheetId, ruleLocation, insertAfterSection._style);
 
@@ -2387,8 +2387,7 @@ WebInspector.StylePropertyTreeElement.prototype = {
             selectElement.parentElement.scrollIntoViewIfNeeded(false);
 
         var applyItemCallback = !isEditingName ? this._applyFreeFlowStyleTextEdit.bind(this) : undefined;
-        var cssCompletions = isEditingName ? WebInspector.CSSMetadata.cssPropertiesMetainfo.allProperties() : WebInspector.CSSMetadata.propertyValues(this.nameElement.textContent);
-        this._prompt = new WebInspector.StylesSidebarPane.CSSPropertyPrompt(cssCompletions, this, isEditingName);
+        this._prompt = new WebInspector.StylesSidebarPane.CSSPropertyPrompt(isEditingName ? WebInspector.CSSMetadata.cssPropertiesMetainfo : WebInspector.CSSMetadata.keywordsForProperty(this.nameElement.textContent), this, isEditingName);
         this._prompt.setAutocompletionTimeout(0);
         if (applyItemCallback) {
             this._prompt.addEventListener(WebInspector.TextPrompt.Events.ItemApplied, applyItemCallback, this);
@@ -2799,7 +2798,7 @@ WebInspector.StylePropertyTreeElement.prototype = {
 /**
  * @constructor
  * @extends {WebInspector.TextPrompt}
- * @param {!Array<string>} cssCompletions
+ * @param {!WebInspector.CSSMetadata} cssCompletions
  * @param {!WebInspector.StylePropertyTreeElement} treeElement
  * @param {boolean} isEditingName
  */
@@ -2945,7 +2944,7 @@ WebInspector.StylesSidebarPane.CSSPropertyPrompt.prototype = {
             return;
         }
 
-        var results = this._cssCompletions.filter(completion => completion.startsWith(prefix));
+        var results = this._cssCompletions.startsWith(prefix);
         if (!this._isEditingName && !results.length && prefix.length > 1 && "!important".startsWith(prefix))
             results.push("!important");
         var userEnteredText = wordRange.toString().replace("-", "");
@@ -2953,7 +2952,7 @@ WebInspector.StylesSidebarPane.CSSPropertyPrompt.prototype = {
             for (var i = 0; i < results.length; ++i)
                 results[i] = results[i].toUpperCase();
         }
-        var selectedIndex = this._isEditingName ? WebInspector.CSSMetadata.mostUsedProperty(results) : 0;
+        var selectedIndex = this._cssCompletions.mostUsedOf(results);
         completionsReadyCallback(results, selectedIndex);
     },
 
@@ -2975,6 +2974,24 @@ WebInspector.StylesSidebarPropertyRenderer = function(rule, node, name, value)
     this._propertyValue = value;
 }
 
+WebInspector.StylesSidebarPropertyRenderer._variableRegex = /(var\(--.*?\))/g;
+WebInspector.StylesSidebarPropertyRenderer._colorRegex = /((?:rgb|hsl)a?\([^)]+\)|#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}|\b\w+\b(?!-))/g;
+WebInspector.StylesSidebarPropertyRenderer._bezierRegex = /((cubic-bezier\([^)]+\))|\b(linear|ease-in-out|ease-in|ease-out|ease)\b)/g;
+
+/**
+ * @param {string} value
+ * @return {!RegExp}
+ */
+WebInspector.StylesSidebarPropertyRenderer._urlRegex = function(value)
+{
+    // Heuristically choose between single-quoted, double-quoted or plain URL regex.
+    if (/url\(\s*'.*\s*'\s*\)/.test(value))
+        return /url\(\s*('.+?')\s*\)/g;
+    if (/url\(\s*".*\s*"\s*\)/.test(value))
+        return /url\(\s*(".+?")\s*\)/g;
+    return /url\(\s*([^)]+)\s*\)/g;
+}
+
 WebInspector.StylesSidebarPropertyRenderer.prototype = {
     /**
      * @param {function(string):!Node} handler
@@ -3011,37 +3028,29 @@ WebInspector.StylesSidebarPropertyRenderer.prototype = {
     {
         var valueElement = createElement("span");
         valueElement.className = "value";
+
         if (!this._propertyValue)
             return valueElement;
 
-        var regexes = [WebInspector.CSSMetadata.VariableRegex, WebInspector.CSSMetadata.URLRegex];
-        var processors = [createTextNode, this._processURL.bind(this)];
-        if (this._bezierHandler && WebInspector.CSSMetadata.isBezierAwareProperty(this._propertyName)) {
-            regexes.push(WebInspector.Geometry.CubicBezier.Regex);
-            processors.push(this._bezierHandler);
-        }
-        if (this._colorHandler && WebInspector.CSSMetadata.isColorAwareProperty(this._propertyName)) {
-            regexes.push(WebInspector.Color.Regex);
-            processors.push(this._colorHandler);
-        }
-        var results = WebInspector.TextUtils.splitStringByRegexes(this._propertyValue, regexes);
-        for (var i = 0; i < results.length; i++) {
-            var result = results[i];
-            var processor = result.regexIndex === -1 ? createTextNode : processors[result.regexIndex];
-            valueElement.appendChild(processor(result.value));
-        }
+        var formatter = new WebInspector.StringFormatter();
+        formatter.addProcessor(WebInspector.StylesSidebarPropertyRenderer._variableRegex, createTextNode);
+        formatter.addProcessor(WebInspector.StylesSidebarPropertyRenderer._urlRegex(this._propertyValue), this._processURL.bind(this));
+        if (this._bezierHandler && WebInspector.CSSMetadata.isBezierAwareProperty(this._propertyName))
+            formatter.addProcessor(WebInspector.StylesSidebarPropertyRenderer._bezierRegex, this._bezierHandler);
+        if (this._colorHandler && WebInspector.CSSMetadata.isColorAwareProperty(this._propertyName))
+            formatter.addProcessor(WebInspector.StylesSidebarPropertyRenderer._colorRegex, this._colorHandler);
+
+        valueElement.appendChild(formatter.formatText(this._propertyValue));
         valueElement.normalize();
         return valueElement;
     },
 
     /**
-     * @param {string} text
+     * @param {string} url
      * @return {!Node}
      */
-    _processURL: function(text)
+    _processURL: function(url)
     {
-        // Strip "url(" and ")" along with whitespace.
-        var url = text.substring(4, text.length - 1).trim();
         var isQuoted = /^'.*'$/.test(url) || /^".*"$/.test(url);
         if (isQuoted)
             url = url.substring(1, url.length - 1);
diff --git a/third_party/WebKit/Source/devtools/front_end/extensions/ExtensionPanel.js b/third_party/WebKit/Source/devtools/front_end/extensions/ExtensionPanel.js
index 973cf7b..3f4408d 100644
--- a/third_party/WebKit/Source/devtools/front_end/extensions/ExtensionPanel.js
+++ b/third_party/WebKit/Source/devtools/front_end/extensions/ExtensionPanel.js
@@ -173,7 +173,7 @@ WebInspector.ExtensionButton.prototype = {
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {!WebInspector.ExtensionServer} server
  * @param {string} panelName
  * @param {string} title
@@ -181,7 +181,7 @@ WebInspector.ExtensionButton.prototype = {
  */
 WebInspector.ExtensionSidebarPane = function(server, panelName, title, id)
 {
-    WebInspector.SimpleView.call(this, title);
+    WebInspector.View.call(this, title);
     this.element.classList.add("fill");
     this._panelName = panelName;
     this._server = server;
@@ -305,5 +305,5 @@ WebInspector.ExtensionSidebarPane.prototype = {
         callback();
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/main/Main.js b/third_party/WebKit/Source/devtools/front_end/main/Main.js
index 64c796c..ba90e89 100644
--- a/third_party/WebKit/Source/devtools/front_end/main/Main.js
+++ b/third_party/WebKit/Source/devtools/front_end/main/Main.js
@@ -131,8 +131,6 @@ WebInspector.Main.prototype = {
     {
         console.timeStamp("Main._createApp");
 
-        WebInspector.viewManager = new WebInspector.ViewManager();
-
         // Request filesystems early, we won't create connections until callback is fired. Things will happen in parallel.
         WebInspector.isolatedFileSystemManager = new WebInspector.IsolatedFileSystemManager();
         WebInspector.isolatedFileSystemManager.initialize(this._didInitializeFileSystemManager.bind(this));
diff --git a/third_party/WebKit/Source/devtools/front_end/network/RequestPreviewView.js b/third_party/WebKit/Source/devtools/front_end/network/RequestPreviewView.js
index aa1c7a0..45ce5c3 100644
--- a/third_party/WebKit/Source/devtools/front_end/network/RequestPreviewView.js
+++ b/third_party/WebKit/Source/devtools/front_end/network/RequestPreviewView.js
@@ -72,9 +72,9 @@ WebInspector.RequestPreviewView.prototype = {
         {
             this._previewView = view;
             view.show(this.element);
-            if (view instanceof WebInspector.SimpleView) {
+            if (view instanceof WebInspector.View) {
                 var toolbar = new WebInspector.Toolbar("network-item-preview-toolbar", this.element);
-                for (var item of /** @type {!WebInspector.SimpleView} */ (this._previewView).syncToolbarItems())
+                for (var item of /** @type {!WebInspector.View} */ (view).toolbarItems())
                     toolbar.appendToolbarItem(item);
             }
             this._previewViewHandledForTest(view);
diff --git a/third_party/WebKit/Source/devtools/front_end/profiler/HeapSnapshotView.js b/third_party/WebKit/Source/devtools/front_end/profiler/HeapSnapshotView.js
index 141a175..7b804eb 100644
--- a/third_party/WebKit/Source/devtools/front_end/profiler/HeapSnapshotView.js
+++ b/third_party/WebKit/Source/devtools/front_end/profiler/HeapSnapshotView.js
@@ -32,13 +32,13 @@
  * @constructor
  * @implements {WebInspector.ProfileType.DataDisplayDelegate}
  * @implements {WebInspector.Searchable}
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {!WebInspector.ProfileType.DataDisplayDelegate} dataDisplayDelegate
  * @param {!WebInspector.HeapProfileHeader} profile
  */
 WebInspector.HeapSnapshotView = function(dataDisplayDelegate, profile)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Heap Snapshot"));
+    WebInspector.View.call(this, WebInspector.UIString("Heap Snapshot"));
 
     this.element.classList.add("heap-snapshot-view");
 
@@ -526,7 +526,7 @@ WebInspector.HeapSnapshotView.prototype = {
      * @override
      * @return {!Array.<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         var result = [this._perspectiveSelect, this._classNameFilter];
         if (this._profile.profileType() !== WebInspector.ProfileTypeRegistry.instance.trackingHeapSnapshotProfileType)
@@ -1011,7 +1011,7 @@ WebInspector.HeapSnapshotView.prototype = {
             this._trackingOverviewGrid.dispose();
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
 
 /**
diff --git a/third_party/WebKit/Source/devtools/front_end/profiler/ProfileView.js b/third_party/WebKit/Source/devtools/front_end/profiler/ProfileView.js
index fbec243..267a90f 100644
--- a/third_party/WebKit/Source/devtools/front_end/profiler/ProfileView.js
+++ b/third_party/WebKit/Source/devtools/front_end/profiler/ProfileView.js
@@ -5,13 +5,13 @@
 /**
  * @constructor
  * @implements {WebInspector.Searchable}
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {!WebInspector.ProfileDataGridNode.Formatter} nodeFormatter
  * @param {!Array<string>=} viewTypes
  */
 WebInspector.ProfileView = function(nodeFormatter, viewTypes)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Profile"));
+    WebInspector.View.call(this, WebInspector.UIString("Profile"));
 
     this._searchableView = new WebInspector.SearchableView(this);
     this._searchableView.setPlaceholder(WebInspector.UIString("Find by cost (>50ms), name or file"));
@@ -113,7 +113,7 @@ WebInspector.ProfileView.prototype = {
      * @override
      * @return {!Array.<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [this.viewSelectComboBox, this.focusButton, this.excludeButton, this.resetButton];
     },
@@ -367,7 +367,7 @@ WebInspector.ProfileView.prototype = {
         this.refresh();
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
 
 /**
diff --git a/third_party/WebKit/Source/devtools/front_end/profiler/ProfilesPanel.js b/third_party/WebKit/Source/devtools/front_end/profiler/ProfilesPanel.js
index 746c8c7..2952171 100644
--- a/third_party/WebKit/Source/devtools/front_end/profiler/ProfilesPanel.js
+++ b/third_party/WebKit/Source/devtools/front_end/profiler/ProfilesPanel.js
@@ -815,7 +815,7 @@ WebInspector.ProfilesPanel.prototype = {
 
         this._profileViewToolbar.removeToolbarItems();
 
-        var toolbarItems = view.syncToolbarItems();
+        var toolbarItems = view.toolbarItems();
         for (var i = 0; i < toolbarItems.length; ++i)
             this._profileViewToolbar.appendToolbarItem(toolbarItems[i]);
 
diff --git a/third_party/WebKit/Source/devtools/front_end/resources/ApplicationCacheItemsView.js b/third_party/WebKit/Source/devtools/front_end/resources/ApplicationCacheItemsView.js
index fe25f6c..1a6e601 100644
--- a/third_party/WebKit/Source/devtools/front_end/resources/ApplicationCacheItemsView.js
+++ b/third_party/WebKit/Source/devtools/front_end/resources/ApplicationCacheItemsView.js
@@ -25,11 +25,11 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  */
 WebInspector.ApplicationCacheItemsView = function(model, frameId)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("AppCache"));
+    WebInspector.View.call(this, WebInspector.UIString("AppCache"));
 
     this._model = model;
 
@@ -65,7 +65,7 @@ WebInspector.ApplicationCacheItemsView.prototype = {
      * @override
      * @return {!Array.<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [
             this._deleteButton,
@@ -258,6 +258,6 @@ WebInspector.ApplicationCacheItemsView.prototype = {
         // this._update();
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
 
diff --git a/third_party/WebKit/Source/devtools/front_end/resources/CookieItemsView.js b/third_party/WebKit/Source/devtools/front_end/resources/CookieItemsView.js
index 09d58bc..1b58eee 100644
--- a/third_party/WebKit/Source/devtools/front_end/resources/CookieItemsView.js
+++ b/third_party/WebKit/Source/devtools/front_end/resources/CookieItemsView.js
@@ -29,11 +29,11 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  */
 WebInspector.CookieItemsView = function(treeElement, cookieDomain)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Cookies"));
+    WebInspector.View.call(this, WebInspector.UIString("Cookies"));
 
     this.element.classList.add("storage-view");
 
@@ -62,7 +62,7 @@ WebInspector.CookieItemsView.prototype = {
      * @override
      * @return {!Array.<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [this._refreshButton, this._clearButton, this._deleteButton];
     },
@@ -187,5 +187,5 @@ WebInspector.CookieItemsView.prototype = {
         }
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/resources/DOMStorageItemsView.js b/third_party/WebKit/Source/devtools/front_end/resources/DOMStorageItemsView.js
index 9b988ce..055b675 100644
--- a/third_party/WebKit/Source/devtools/front_end/resources/DOMStorageItemsView.js
+++ b/third_party/WebKit/Source/devtools/front_end/resources/DOMStorageItemsView.js
@@ -26,11 +26,11 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  */
 WebInspector.DOMStorageItemsView = function(domStorage)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("DOM Storage"));
+    WebInspector.View.call(this, WebInspector.UIString("DOM Storage"));
 
     this.domStorage = domStorage;
 
@@ -54,7 +54,7 @@ WebInspector.DOMStorageItemsView.prototype = {
      * @override
      * @return {!Array.<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [this.refreshButton, this.deleteButton];
     },
@@ -259,5 +259,5 @@ WebInspector.DOMStorageItemsView.prototype = {
             this.domStorage.removeItem(node.data.key);
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/resources/DatabaseTableView.js b/third_party/WebKit/Source/devtools/front_end/resources/DatabaseTableView.js
index 3d7ac44..ada854f 100644
--- a/third_party/WebKit/Source/devtools/front_end/resources/DatabaseTableView.js
+++ b/third_party/WebKit/Source/devtools/front_end/resources/DatabaseTableView.js
@@ -25,11 +25,11 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  */
 WebInspector.DatabaseTableView = function(database, tableName)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Database"));
+    WebInspector.View.call(this, WebInspector.UIString("Database"));
 
     this.database = database;
     this.tableName = tableName;
@@ -54,7 +54,7 @@ WebInspector.DatabaseTableView.prototype = {
      * @override
      * @return {!Array.<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [this.refreshButton, this._visibleColumnsInput];
     },
@@ -143,5 +143,5 @@ WebInspector.DatabaseTableView.prototype = {
         this.update();
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/resources/IndexedDBViews.js b/third_party/WebKit/Source/devtools/front_end/resources/IndexedDBViews.js
index 63b5ed9..7be9acc 100644
--- a/third_party/WebKit/Source/devtools/front_end/resources/IndexedDBViews.js
+++ b/third_party/WebKit/Source/devtools/front_end/resources/IndexedDBViews.js
@@ -97,7 +97,7 @@ WebInspector.IDBDatabaseView.prototype = {
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {!WebInspector.IndexedDBModel} model
  * @param {!WebInspector.IndexedDBModel.DatabaseId} databaseId
  * @param {!WebInspector.IndexedDBModel.ObjectStore} objectStore
@@ -105,7 +105,7 @@ WebInspector.IDBDatabaseView.prototype = {
  */
 WebInspector.IDBDataView = function(model, databaseId, objectStore, index)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("IDB"));
+    WebInspector.View.call(this, WebInspector.UIString("IDB"));
     this.registerRequiredCSS("resources/indexedDBViews.css");
 
     this._model = model;
@@ -337,7 +337,7 @@ WebInspector.IDBDataView.prototype = {
      * @override
      * @return {!Array.<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [this._refreshButton, this._clearButton];
     },
@@ -348,7 +348,7 @@ WebInspector.IDBDataView.prototype = {
         this._entries = [];
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
 
 /**
diff --git a/third_party/WebKit/Source/devtools/front_end/resources/ResourcesPanel.js b/third_party/WebKit/Source/devtools/front_end/resources/ResourcesPanel.js
index 86fdd77..cd2d34b 100644
--- a/third_party/WebKit/Source/devtools/front_end/resources/ResourcesPanel.js
+++ b/third_party/WebKit/Source/devtools/front_end/resources/ResourcesPanel.js
@@ -662,7 +662,7 @@ WebInspector.ResourcesPanel.prototype = {
         this.visibleView = view;
 
         this._storageViewToolbar.removeToolbarItems();
-        var toolbarItems = view instanceof WebInspector.SimpleView ? view.syncToolbarItems() : null;
+        var toolbarItems = view.toolbarItems ? view.toolbarItems() : null;
         for (var i = 0; toolbarItems && i < toolbarItems.length; ++i)
             this._storageViewToolbar.appendToolbarItem(toolbarItems[i]);
     },
diff --git a/third_party/WebKit/Source/devtools/front_end/resources/ServiceWorkerCacheViews.js b/third_party/WebKit/Source/devtools/front_end/resources/ServiceWorkerCacheViews.js
index e9d1b95..3acf838 100644
--- a/third_party/WebKit/Source/devtools/front_end/resources/ServiceWorkerCacheViews.js
+++ b/third_party/WebKit/Source/devtools/front_end/resources/ServiceWorkerCacheViews.js
@@ -4,13 +4,13 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {!WebInspector.ServiceWorkerCacheModel} model
  * @param {!WebInspector.ServiceWorkerCacheModel.Cache} cache
  */
 WebInspector.ServiceWorkerCacheView = function(model, cache)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Cache"));
+    WebInspector.View.call(this, WebInspector.UIString("Cache"));
     this.registerRequiredCSS("resources/serviceWorkerCacheViews.css");
 
     this._model = model;
@@ -148,7 +148,7 @@ WebInspector.ServiceWorkerCacheView.prototype = {
      * @override
      * @return {!Array.<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [this._refreshButton];
     },
@@ -159,5 +159,5 @@ WebInspector.ServiceWorkerCacheView.prototype = {
         this._entries = [];
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/sdk/CSSMetadata.js b/third_party/WebKit/Source/devtools/front_end/sdk/CSSMetadata.js
index 6783209..f502001 100644
--- a/third_party/WebKit/Source/devtools/front_end/sdk/CSSMetadata.js
+++ b/third_party/WebKit/Source/devtools/front_end/sdk/CSSMetadata.js
@@ -32,36 +32,33 @@
 
 /**
  * @constructor
- * @param {!Array.<!{name: string, longhands: !Array.<string>}>} properties
+ * @param {!Array.<!{name: string, longhands: !Array.<string>}|string>} properties
  */
 WebInspector.CSSMetadata = function(properties)
 {
     this._values = /** !Array.<string> */ ([]);
-    /** @type {!Map<string, !Array<string>>} */
-    this._longhands = new Map();
-    /** @type {!Map<string, !Array<string>>} */
-    this._shorthands = new Map();
-    /** @type {!Set<string>} */
-    this._inherited = new Set();
+    this._longhands = {};
+    this._shorthands = {};
     for (var i = 0; i < properties.length; ++i) {
         var property = properties[i];
+        if (typeof property === "string") {
+            this._values.push(property);
+            continue;
+        }
         var propertyName = property.name;
         if (!CSS.supports(propertyName, "initial"))
             continue;
         this._values.push(propertyName);
 
-        if (property.inherited)
-            this._inherited.add(propertyName);
-
         var longhands = properties[i].longhands;
         if (longhands) {
-            this._longhands.set(propertyName, longhands);
+            this._longhands[propertyName] = longhands;
             for (var j = 0; j < longhands.length; ++j) {
                 var longhandName = longhands[j];
-                var shorthands = this._shorthands.get(longhandName);
+                var shorthands = this._shorthands[longhandName];
                 if (!shorthands) {
                     shorthands = [];
-                    this._shorthands.set(longhandName, shorthands);
+                    this._shorthands[longhandName] = shorthands;
                 }
                 shorthands.push(propertyName);
             }
@@ -70,8 +67,10 @@ WebInspector.CSSMetadata = function(properties)
     this._values.sort();
 }
 
-WebInspector.CSSMetadata.VariableRegex = /(var\(--.*?\))/g;
-WebInspector.CSSMetadata.URLRegex = /url\(\s*('.+?'|".+?"|[^)]+)\s*\)/g;
+/**
+ * @type {!WebInspector.CSSMetadata}
+ */
+WebInspector.CSSMetadata.cssPropertiesMetainfo = new WebInspector.CSSMetadata([]);
 
 /**
  * @param {string} propertyName
@@ -88,7 +87,6 @@ WebInspector.CSSMetadata.isColorAwareProperty = function(propertyName)
  */
 WebInspector.CSSMetadata.isLengthProperty = function(propertyName)
 {
-    propertyName = propertyName.toLowerCase();
     if (propertyName === "line-height")
         return false;
     if (!WebInspector.CSSMetadata._distancePropertiesKeySet)
@@ -114,19 +112,35 @@ WebInspector.CSSMetadata.isCustomProperty = function(propertyName)
     return propertyName.startsWith("--");
 }
 
+// Originally taken from http://www.w3.org/TR/CSS21/propidx.html and augmented.
+WebInspector.CSSMetadata.InheritedProperties = [
+    "azimuth", "border-collapse", "border-spacing", "caption-side", "color", "cursor", "direction", "elevation",
+    "empty-cells", "font-family", "font-size", "font-style", "font-variant", "font-weight", "font", "letter-spacing",
+    "line-height", "list-style-image", "list-style-position", "list-style-type", "list-style", "orphans", "overflow-wrap", "pitch-range",
+    "pitch", "quotes", "resize", "richness", "speak-header", "speak-numeral", "speak-punctuation", "speak", "speech-rate", "stress",
+    "text-align", "text-indent", "text-transform", "text-shadow", "-webkit-user-select", "visibility", "voice-family", "volume", "white-space", "widows",
+    "word-spacing", "word-wrap", "zoom"
+].keySet();
+
+// These non-standard Blink-specific properties augment the InheritedProperties.
+WebInspector.CSSMetadata.NonStandardInheritedProperties = [
+    "-webkit-font-smoothing"
+].keySet();
+
 /**
  * @param {string} name
  * @return {string}
  */
 WebInspector.CSSMetadata.canonicalPropertyName = function(name)
 {
-    name = name.toLowerCase();
     if (!name || name.length < 9 || name.charAt(0) !== "-")
-        return name;
+        return name.toLowerCase();
     var match = name.match(/(?:-webkit-)(.+)/);
-    if (!match || !WebInspector.CSSMetadata.cssPropertiesMetainfo.hasProperty(match[1]))
-        return name;
-    return match[1];
+    var propertiesSet = WebInspector.CSSMetadata.cssPropertiesMetainfoKeySet();
+    var hasSupportedProperties = WebInspector.CSSMetadata.cssPropertiesMetainfo._values.length > 0;
+    if (!match || (hasSupportedProperties && !propertiesSet.hasOwnProperty(match[1].toLowerCase())))
+        return name.toLowerCase();
+    return match[1].toLowerCase();
 }
 
 /**
@@ -135,10 +149,10 @@ WebInspector.CSSMetadata.canonicalPropertyName = function(name)
  */
 WebInspector.CSSMetadata.isCSSPropertyName = function(propertyName)
 {
-    propertyName = propertyName.toLowerCase();
     if (propertyName.startsWith("-moz-") || propertyName.startsWith("-o-") || propertyName.startsWith("-webkit-") || propertyName.startsWith("-ms-"))
         return true;
-    return WebInspector.CSSMetadata.cssPropertiesMetainfo.hasProperty(propertyName);
+    var hasSupportedProperties = WebInspector.CSSMetadata.cssPropertiesMetainfo._values.length > 0;
+    return !hasSupportedProperties || WebInspector.CSSMetadata.cssPropertiesMetainfoKeySet().hasOwnProperty(propertyName);
 }
 
 /**
@@ -147,8 +161,8 @@ WebInspector.CSSMetadata.isCSSPropertyName = function(propertyName)
  */
 WebInspector.CSSMetadata.isPropertyInherited = function(propertyName)
 {
-    var metadata = WebInspector.CSSMetadata.cssPropertiesMetainfo;
-    return metadata.inherited(WebInspector.CSSMetadata.canonicalPropertyName(propertyName)) || metadata.inherited(propertyName.toLowerCase());
+    return !!(WebInspector.CSSMetadata.InheritedProperties[WebInspector.CSSMetadata.canonicalPropertyName(propertyName)]
+            || WebInspector.CSSMetadata.NonStandardInheritedProperties[propertyName.toLowerCase()]);
 }
 
 WebInspector.CSSMetadata._distanceProperties = [
@@ -634,22 +648,36 @@ WebInspector.CSSMetadata._propertyDataMap = {
 
 /**
  * @param {string} propertyName
- * @return {!Array<string>}
+ * @return {!WebInspector.CSSMetadata}
  */
-WebInspector.CSSMetadata.propertyValues = function(propertyName)
+WebInspector.CSSMetadata.keywordsForProperty = function(propertyName)
 {
     var acceptedKeywords = ["inherit", "initial"];
-    propertyName = propertyName.toLowerCase();
-    var unprefixedName = propertyName.replace(/^-webkit-/, "");
-    var entry = WebInspector.CSSMetadata._propertyDataMap[propertyName] || WebInspector.CSSMetadata._propertyDataMap[unprefixedName];
-    if (entry && entry.values)
-        acceptedKeywords.pushAll(entry.values);
+    var descriptor = WebInspector.CSSMetadata.descriptor(propertyName);
+    if (descriptor && descriptor.values)
+        acceptedKeywords.push.apply(acceptedKeywords, descriptor.values);
     if (WebInspector.CSSMetadata.isColorAwareProperty(propertyName)) {
         acceptedKeywords.push("currentColor");
         for (var color in WebInspector.Color.Nicknames)
             acceptedKeywords.push(color);
     }
-    return acceptedKeywords.sort();
+    return new WebInspector.CSSMetadata(acceptedKeywords);
+}
+
+/**
+ * @param {string} propertyName
+ * @return {?Object}
+ */
+WebInspector.CSSMetadata.descriptor = function(propertyName)
+{
+    if (!propertyName)
+        return null;
+    var unprefixedName = propertyName.replace(/^-webkit-/, "");
+    propertyName = propertyName.toLowerCase();
+    var entry = WebInspector.CSSMetadata._propertyDataMap[propertyName];
+    if (!entry && unprefixedName !== propertyName)
+        entry = WebInspector.CSSMetadata._propertyDataMap[unprefixedName];
+    return entry || null;
 }
 
 WebInspector.CSSMetadata.initializeWithSupportedProperties = function(properties)
@@ -657,6 +685,16 @@ WebInspector.CSSMetadata.initializeWithSupportedProperties = function(properties
     WebInspector.CSSMetadata.cssPropertiesMetainfo = new WebInspector.CSSMetadata(properties);
 }
 
+/**
+ * @return {!Object.<string, boolean>}
+ */
+WebInspector.CSSMetadata.cssPropertiesMetainfoKeySet = function()
+{
+    if (!WebInspector.CSSMetadata._cssPropertiesMetainfoKeySet)
+        WebInspector.CSSMetadata._cssPropertiesMetainfoKeySet = WebInspector.CSSMetadata.cssPropertiesMetainfo.keySet();
+    return WebInspector.CSSMetadata._cssPropertiesMetainfoKeySet;
+}
+
 // Weight of CSS properties based on their usage from https://www.chromestatus.com/metrics/css/popularity
 WebInspector.CSSMetadata.Weight = {
     "align-content": 57,
@@ -915,71 +953,148 @@ WebInspector.CSSMetadata.Weight = {
     "zoom": 200
 };
 
-/**
- * @param {!Array.<string>} properties
- * @return {number}
- */
-WebInspector.CSSMetadata.mostUsedProperty = function(properties)
-{
-    var maxWeight = 0;
-    var index = 0;
-    for (var i = 0; i < properties.length; i++) {
-        var weight = WebInspector.CSSMetadata.Weight[properties[i]];
-        if (!weight)
-            weight = WebInspector.CSSMetadata.Weight[WebInspector.CSSMetadata.canonicalPropertyName(properties[i])];
-        if (weight > maxWeight) {
-            maxWeight = weight;
-            index = i;
-        }
-    }
-    return index;
-}
 
 WebInspector.CSSMetadata.prototype = {
     /**
-     * @return {!Array<string>}
+     * @param {string} prefix
+     * @return {!Array.<string>}
      */
-    allProperties: function()
+    startsWith: function(prefix)
     {
-        return this._values;
+        var firstIndex = this._firstIndexOfPrefix(prefix);
+        if (firstIndex === -1)
+            return [];
+
+        var results = [];
+        while (firstIndex < this._values.length && this._values[firstIndex].startsWith(prefix))
+            results.push(this._values[firstIndex++]);
+        return results;
     },
 
     /**
-     * @param {string} propertyName
-     * @return {boolean}
+     * @param {!Array.<string>} properties
+     * @return {number}
      */
-    hasProperty: function(propertyName)
+    mostUsedOf: function(properties)
     {
-        if (!this._valuesSet)
-            this._valuesSet = new Set(this._values);
-        return this._valuesSet.has(propertyName);
+        var maxWeight = 0;
+        var index = 0;
+        for (var i = 0; i < properties.length; i++) {
+            var weight = WebInspector.CSSMetadata.Weight[properties[i]];
+            if (!weight)
+                weight = WebInspector.CSSMetadata.Weight[WebInspector.CSSMetadata.canonicalPropertyName(properties[i])];
+            if (weight > maxWeight) {
+                maxWeight = weight;
+                index = i;
+            }
+        }
+        return index;
+    },
+
+    _firstIndexOfPrefix: function(prefix)
+    {
+        if (!this._values.length)
+            return -1;
+        if (!prefix)
+            return 0;
+
+        var maxIndex = this._values.length - 1;
+        var minIndex = 0;
+        var foundIndex;
+
+        do {
+            var middleIndex = (maxIndex + minIndex) >> 1;
+            if (this._values[middleIndex].startsWith(prefix)) {
+                foundIndex = middleIndex;
+                break;
+            }
+            if (this._values[middleIndex] < prefix)
+                minIndex = middleIndex + 1;
+            else
+                maxIndex = middleIndex - 1;
+        } while (minIndex <= maxIndex);
+
+        if (foundIndex === undefined)
+            return -1;
+
+        while (foundIndex && this._values[foundIndex - 1].startsWith(prefix))
+            foundIndex--;
+
+        return foundIndex;
     },
 
     /**
-     * @param {string} shorthand
-     * @return {?Array.<string>}
+     * @return {!Object.<string, boolean>}
      */
-    longhands: function(shorthand)
+    keySet: function()
     {
-        return this._longhands.get(shorthand);
+        if (!this._keySet)
+            this._keySet = this._values.keySet();
+        return this._keySet;
     },
 
     /**
-     * @param {string} longhand
+     * @param {string} str
+     * @param {string} prefix
+     * @return {string}
+     */
+    next: function(str, prefix)
+    {
+        return this._closest(str, prefix, 1);
+    },
+
+    /**
+     * @param {string} str
+     * @param {string} prefix
+     * @return {string}
+     */
+    previous: function(str, prefix)
+    {
+        return this._closest(str, prefix, -1);
+    },
+
+    /**
+     * @param {string} str
+     * @param {string} prefix
+     * @param {number} shift
+     * @return {string}
+     */
+    _closest: function(str, prefix, shift)
+    {
+        if (!str)
+            return "";
+
+        var index = this._values.indexOf(str);
+        if (index === -1)
+            return "";
+
+        if (!prefix) {
+            index = (index + this._values.length + shift) % this._values.length;
+            return this._values[index];
+        }
+
+        var propertiesWithPrefix = this.startsWith(prefix);
+        var j = propertiesWithPrefix.indexOf(str);
+        j = (j + propertiesWithPrefix.length + shift) % propertiesWithPrefix.length;
+        return propertiesWithPrefix[j];
+    },
+
+    /**
+     * @param {string} shorthand
      * @return {?Array.<string>}
      */
-    shorthands: function(longhand)
+    longhands: function(shorthand)
     {
-        return this._shorthands.get(longhand);
+        return this._longhands[shorthand];
     },
 
     /**
-     * @param {string} propertyName
-     * @return {boolean}
+     * @param {string} longhand
+     * @return {?Array.<string>}
      */
-    inherited: function(propertyName)
+    shorthands: function(longhand)
     {
-        return this._inherited.has(propertyName);
+        return this._shorthands[longhand];
     }
 }
 
diff --git a/third_party/WebKit/Source/devtools/front_end/sdk/DebuggerModel.js b/third_party/WebKit/Source/devtools/front_end/sdk/DebuggerModel.js
index a5e5bb2..af7b5aa 100644
--- a/third_party/WebKit/Source/devtools/front_end/sdk/DebuggerModel.js
+++ b/third_party/WebKit/Source/devtools/front_end/sdk/DebuggerModel.js
@@ -462,7 +462,7 @@ WebInspector.DebuggerModel.prototype = {
      * @param {number} endColumn
      * @param {!RuntimeAgent.ExecutionContextId} executionContextId
      * @param {string} hash
-     * @param {*|undefined} executionContextAuxData
+     * @param {boolean} isContentScript
      * @param {boolean} isInternalScript
      * @param {boolean} isLiveEdit
      * @param {string=} sourceMapURL
@@ -471,11 +471,8 @@ WebInspector.DebuggerModel.prototype = {
      * @param {boolean=} hasSyntaxError
      * @return {!WebInspector.Script}
      */
-    _parsedScriptSource: function(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, executionContextAuxData, isInternalScript, isLiveEdit, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed, hasSyntaxError)
+    _parsedScriptSource: function(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, isContentScript, isInternalScript, isLiveEdit, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed, hasSyntaxError)
     {
-        var isContentScript = false;
-        if (executionContextAuxData && ("isDefault" in executionContextAuxData))
-            isContentScript = !executionContextAuxData["isDefault"];
         var script = new WebInspector.Script(this, scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, isContentScript, isInternalScript, isLiveEdit, sourceMapURL, hasSourceURL);
         this._registerScript(script);
         if (!hasSyntaxError)
@@ -855,16 +852,16 @@ WebInspector.DebuggerDispatcher.prototype = {
      * @param {number} endColumn
      * @param {!RuntimeAgent.ExecutionContextId} executionContextId
      * @param {string} hash
-     * @param {*=} executionContextAuxData
+     * @param {boolean=} isContentScript
      * @param {boolean=} isInternalScript
      * @param {boolean=} isLiveEdit
      * @param {string=} sourceMapURL
      * @param {boolean=} hasSourceURL
      * @param {boolean=} deprecatedCommentWasUsed
      */
-    scriptParsed: function(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, executionContextAuxData, isInternalScript, isLiveEdit, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed)
+    scriptParsed: function(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, isContentScript, isInternalScript, isLiveEdit, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed)
     {
-        this._debuggerModel._parsedScriptSource(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, executionContextAuxData, !!isInternalScript, !!isLiveEdit, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed, false);
+        this._debuggerModel._parsedScriptSource(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, !!isContentScript, !!isInternalScript, !!isLiveEdit, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed, false);
     },
 
     /**
@@ -877,15 +874,15 @@ WebInspector.DebuggerDispatcher.prototype = {
      * @param {number} endColumn
      * @param {!RuntimeAgent.ExecutionContextId} executionContextId
      * @param {string} hash
-     * @param {*=} executionContextAuxData
+     * @param {boolean=} isContentScript
      * @param {boolean=} isInternalScript
      * @param {string=} sourceMapURL
      * @param {boolean=} hasSourceURL
      * @param {boolean=} deprecatedCommentWasUsed
      */
-    scriptFailedToParse: function(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, executionContextAuxData, isInternalScript, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed)
+    scriptFailedToParse: function(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, isContentScript, isInternalScript, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed)
     {
-        this._debuggerModel._parsedScriptSource(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, executionContextAuxData, !!isInternalScript, false, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed, true);
+        this._debuggerModel._parsedScriptSource(scriptId, sourceURL, startLine, startColumn, endLine, endColumn, executionContextId, hash, !!isContentScript, !!isInternalScript, false, sourceMapURL, hasSourceURL, deprecatedCommentWasUsed, true);
     },
 
     /**
diff --git a/third_party/WebKit/Source/devtools/front_end/sdk/RemoteObject.js b/third_party/WebKit/Source/devtools/front_end/sdk/RemoteObject.js
index 9b48adf..15a0ec0 100644
--- a/third_party/WebKit/Source/devtools/front_end/sdk/RemoteObject.js
+++ b/third_party/WebKit/Source/devtools/front_end/sdk/RemoteObject.js
@@ -514,7 +514,7 @@ WebInspector.RemoteObjectImpl.prototype = {
             }
 
             if (!this._objectId) {
-                reject(new Error("No object id specified"));
+                reject(null);
                 return;
             }
 
@@ -528,7 +528,7 @@ WebInspector.RemoteObjectImpl.prototype = {
             function mycallback(error, payloads)
             {
                 if (error) {
-                    reject(new Error(error));
+                    reject(null);
                     return;
                 }
                 fulfill(payloads.map(createEventListener.bind(this)));
diff --git a/third_party/WebKit/Source/devtools/front_end/sdk/RuntimeModel.js b/third_party/WebKit/Source/devtools/front_end/sdk/RuntimeModel.js
index 83e423c..f734559 100644
--- a/third_party/WebKit/Source/devtools/front_end/sdk/RuntimeModel.js
+++ b/third_party/WebKit/Source/devtools/front_end/sdk/RuntimeModel.js
@@ -115,8 +115,7 @@ WebInspector.RuntimeModel.prototype = {
         if (context.name === WebInspector.RuntimeModel._privateScript && !context.origin && !Runtime.experiments.isEnabled("privateScriptInspection")) {
             return;
         }
-        var data = context.auxData || { isDefault: true };
-        var executionContext = new WebInspector.ExecutionContext(this.target(), context.id, context.name, context.origin, data["isDefault"], data["frameId"]);
+        var executionContext = new WebInspector.ExecutionContext(this.target(), context.id, context.name, context.origin, context.isDefault, context.frameId);
         this._executionContextById.set(executionContext.id, executionContext);
         this.dispatchEventToListeners(WebInspector.RuntimeModel.Events.ExecutionContextCreated, executionContext);
     },
diff --git a/third_party/WebKit/Source/devtools/front_end/settings/SettingsScreen.js b/third_party/WebKit/Source/devtools/front_end/settings/SettingsScreen.js
index bd5964b..cea3b87 100644
--- a/third_party/WebKit/Source/devtools/front_end/settings/SettingsScreen.js
+++ b/third_party/WebKit/Source/devtools/front_end/settings/SettingsScreen.js
@@ -44,7 +44,7 @@ WebInspector.SettingsScreen = function()
     var settingsLabelElement = createElementWithClass("div", "help-window-label");
     settingsLabelElement.createTextChild(WebInspector.UIString("Settings"));
 
-    this._tabbedLocation = WebInspector.viewManager.createTabbedLocation(() => WebInspector.SettingsScreen._showSettingsScreen(), "settings-view");
+    this._tabbedLocation = WebInspector.viewManager.createTabbedLocation("settings-view");
     var tabbedPane = this._tabbedLocation.tabbedPane();
     tabbedPane.insertBeforeTabStrip(settingsLabelElement);
     tabbedPane.setShrinkableTabs(false);
@@ -63,12 +63,10 @@ WebInspector.SettingsScreen = function()
 WebInspector.SettingsScreen._showSettingsScreen = function(name)
 {
     var settingsScreen = /** @type {!WebInspector.SettingsScreen} */ (self.runtime.sharedInstance(WebInspector.SettingsScreen));
-    if (settingsScreen.isShowing())
-        return;
     var dialog = new WebInspector.Dialog();
     dialog.addCloseButton();
     settingsScreen.show(dialog.element);
-    settingsScreen._selectTab(name || "preferences");
+    settingsScreen.selectTab(name || "preferences");
     dialog.show();
 }
 
@@ -79,17 +77,18 @@ WebInspector.SettingsScreen.prototype = {
      * @param {string} locationName
      * @return {?WebInspector.ViewLocation}
      */
-    resolveLocation: function(locationName)
+    revealLocation: function(locationName)
     {
+        WebInspector.SettingsScreen._showSettingsScreen();
         return this._tabbedLocation;
     },
 
     /**
      * @param {string} name
      */
-    _selectTab: function(name)
+    selectTab: function(name)
     {
-        WebInspector.viewManager.showView(name);
+        this._tabbedLocation.showView(name);
     },
 
     /**
diff --git a/third_party/WebKit/Source/devtools/front_end/source_frame/CodeMirrorTextEditor.js b/third_party/WebKit/Source/devtools/front_end/source_frame/CodeMirrorTextEditor.js
index b6583fa..c586c09 100644
--- a/third_party/WebKit/Source/devtools/front_end/source_frame/CodeMirrorTextEditor.js
+++ b/third_party/WebKit/Source/devtools/front_end/source_frame/CodeMirrorTextEditor.js
@@ -1009,14 +1009,12 @@ WebInspector.CodeMirrorTextEditor.prototype = {
      * @param {number} lineNumber
      * @param {number} columnNumber
      * @param {!Element} element
-     * @param {boolean=} insertBefore
      * @return {!CodeMirror.TextMarker}
      */
-    addBookmark: function(lineNumber, columnNumber, element, insertBefore)
+    addBookmark: function(lineNumber, columnNumber, element)
     {
         return this._codeMirror.setBookmark(new CodeMirror.Pos(lineNumber, columnNumber), {
-            widget: element,
-            insertLeft: insertBefore
+            widget: element
         });
     },
 
diff --git a/third_party/WebKit/Source/devtools/front_end/source_frame/FontView.js b/third_party/WebKit/Source/devtools/front_end/source_frame/FontView.js
index 210d970..4aee681 100644
--- a/third_party/WebKit/Source/devtools/front_end/source_frame/FontView.js
+++ b/third_party/WebKit/Source/devtools/front_end/source_frame/FontView.js
@@ -28,13 +28,13 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {string} mimeType
  * @param {!WebInspector.ContentProvider} contentProvider
  */
 WebInspector.FontView = function(mimeType, contentProvider)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Font"));
+    WebInspector.View.call(this, WebInspector.UIString("Font"));
     this.registerRequiredCSS("source_frame/fontView.css");
     this.element.classList.add("font-view");
     this._url = contentProvider.contentURL();
@@ -54,7 +54,7 @@ WebInspector.FontView.prototype = {
      * @override
      * @return {!Array<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [this._mimeTypeLabel];
     },
@@ -157,5 +157,5 @@ WebInspector.FontView.prototype = {
         this.fontPreviewElement.style.setProperty("font-size", finalFontSize + "px", null);
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/source_frame/ImageView.js b/third_party/WebKit/Source/devtools/front_end/source_frame/ImageView.js
index 48530cb..d6e7dcd 100644
--- a/third_party/WebKit/Source/devtools/front_end/source_frame/ImageView.js
+++ b/third_party/WebKit/Source/devtools/front_end/source_frame/ImageView.js
@@ -27,14 +27,14 @@
  */
 
 /**
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @constructor
  * @param {string} mimeType
  * @param {!WebInspector.ContentProvider} contentProvider
  */
 WebInspector.ImageView = function(mimeType, contentProvider)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Image"));
+    WebInspector.View.call(this, WebInspector.UIString("Image"));
     this.registerRequiredCSS("source_frame/imageView.css");
     this.element.classList.add("image-view");
     this._url = contentProvider.contentURL();
@@ -51,7 +51,7 @@ WebInspector.ImageView.prototype = {
      * @override
      * @return {!Array<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [this._sizeLabel, new WebInspector.ToolbarSeparator(), this._dimensionsLabel, new WebInspector.ToolbarSeparator(), this._mimeTypeLabel];
     },
@@ -136,5 +136,5 @@ WebInspector.ImageView.prototype = {
         InspectorFrontendHost.openInNewTab(this._url);
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/source_frame/SourceFrame.js b/third_party/WebKit/Source/devtools/front_end/source_frame/SourceFrame.js
index b3b29bc..aedc881 100644
--- a/third_party/WebKit/Source/devtools/front_end/source_frame/SourceFrame.js
+++ b/third_party/WebKit/Source/devtools/front_end/source_frame/SourceFrame.js
@@ -30,7 +30,7 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @implements {WebInspector.Searchable}
  * @implements {WebInspector.Replaceable}
  * @param {string} url
@@ -38,7 +38,7 @@
  */
 WebInspector.SourceFrame = function(url, lazyContent)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Source"));
+    WebInspector.View.call(this, WebInspector.UIString("Source"));
 
     this._url = url;
     this._lazyContent = lazyContent;
@@ -106,7 +106,7 @@ WebInspector.SourceFrame.prototype = {
      * @override
      * @return {!Array<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
         return [this._sourcePosition];
     },
@@ -638,7 +638,7 @@ WebInspector.SourceFrame.prototype = {
             e.consume(true);
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
 
 /**
diff --git a/third_party/WebKit/Source/devtools/front_end/source_frame/TextEditorAutocompleteController.js b/third_party/WebKit/Source/devtools/front_end/source_frame/TextEditorAutocompleteController.js
index 7451eec..3c96b05 100644
--- a/third_party/WebKit/Source/devtools/front_end/source_frame/TextEditorAutocompleteController.js
+++ b/third_party/WebKit/Source/devtools/front_end/source_frame/TextEditorAutocompleteController.js
@@ -21,7 +21,6 @@ WebInspector.TextEditorAutocompleteController = function(textEditor, codeMirror)
 
     this._enabled = true;
     this._initialized = false;
-    this._hintElement = createElementWithClass("span", "auto-complete-text");
 }
 
 WebInspector.TextEditorAutocompleteController.prototype = {
@@ -32,7 +31,6 @@ WebInspector.TextEditorAutocompleteController.prototype = {
         this._initialized = true;
         this._codeMirror.on("scroll", this._onScroll);
         this._codeMirror.on("cursorActivity", this._onCursorActivity);
-        this._codeMirror.on("mousedown", this.finishAutocomplete.bind(this));
         this._codeMirror.on("blur", this._blur);
         this._delegate.initialize(this._textEditor);
     },
@@ -71,40 +69,15 @@ WebInspector.TextEditorAutocompleteController.prototype = {
     {
         if (!changes.length || !this._enabled || !this._delegate)
             return;
+
         var singleCharInput = false;
-        var singleCharDelete = false;
-        var cursor = this._codeMirror.getCursor("head");
         for (var changeIndex = 0; changeIndex < changes.length; ++changeIndex) {
             var changeObject = changes[changeIndex];
-            if (changeObject.origin === "+input"
-                && changeObject.text.length === 1
-                && changeObject.text[0].length === 1
-                && changeObject.to.line === cursor.line
-                && changeObject.to.ch + 1 === cursor.ch) {
-                singleCharInput = true;
-                break;
-            }
-            if (this._suggestBox
-                && changeObject.origin === "+delete"
-                && changeObject.removed.length === 1
-                && changeObject.removed[0].length === 1
-                && changeObject.to.line === cursor.line
-                && changeObject.to.ch - 1 === cursor.ch) {
-                singleCharDelete = true;
-                break;
-            }
-        }
-        if (singleCharInput && this._hintMarker)
-            this._hintElement.textContent = this._hintElement.textContent.substring(1);
-
-        if (singleCharDelete && this._hintMarker && this._lastPrefix) {
-            this._hintElement.textContent = this._lastPrefix.charAt(this._lastPrefix.length - 1) + this._hintElement.textContent;
-            this._lastPrefix = this._lastPrefix.substring(0, this._lastPrefix.length - 1);
+            singleCharInput = (changeObject.origin === "+input" && changeObject.text.length === 1 && changeObject.text[0].length === 1) ||
+                (this._suggestBox && changeObject.origin === "+delete" && changeObject.removed.length === 1 && changeObject.removed[0].length === 1);
         }
-        if (singleCharInput || singleCharDelete)
+        if (singleCharInput)
             setImmediate(this.autocomplete.bind(this));
-        else
-            this.finishAutocomplete();
     },
 
     _blur: function()
@@ -152,62 +125,27 @@ WebInspector.TextEditorAutocompleteController.prototype = {
 
         var prefixRange = substituteRange.clone();
         prefixRange.endColumn = cursor.ch;
-        var prefix = this._textEditor.copyRange(prefixRange);
-        var hadSuggestBox = false;
-        if (this._suggestBox)
-            hadSuggestBox = true;
-
-        this._delegate.wordsWithPrefix(this._textEditor, prefixRange, substituteRange).then(wordsAcquired.bind(this));
-
-        /**
-         * @param {!WebInspector.SuggestBox.Suggestions} wordsWithPrefix
-         * @this {WebInspector.TextEditorAutocompleteController}
-         */
-        function wordsAcquired(wordsWithPrefix)
-        {
-            if (!wordsWithPrefix.length || (wordsWithPrefix.length === 1 && prefix === wordsWithPrefix[0].title) || (!this._suggestBox && hadSuggestBox)) {
-                this.finishAutocomplete();
-                this._onSuggestionsShownForTest([]);
-                return;
-            }
-            if (!this._suggestBox)
-                this._suggestBox = new WebInspector.SuggestBox(this, 6);
-
-            var oldPrefixRange = this._prefixRange;
-            this._prefixRange = prefixRange;
-            if (!oldPrefixRange || prefixRange.startLine !== oldPrefixRange.startLine || prefixRange.startColumn !== oldPrefixRange.startColumn)
-                this._updateAnchorBox();
-            this._suggestBox.updateSuggestions(this._anchorBox, wordsWithPrefix, 0, !this._isCursorAtEndOfLine(), prefix);
-            this._onSuggestionsShownForTest(wordsWithPrefix);
-            this._addHintMarker(wordsWithPrefix[0].title);
-        }
-    },
 
-    /**
-     * @param {string} hint
-     */
-    _addHintMarker: function(hint)
-    {
-        this._clearHintMarker();
-        if (!this._isCursorAtEndOfLine())
+        var wordsWithPrefix = this._delegate.wordsWithPrefix(this._textEditor, prefixRange, substituteRange);
+        if (!wordsWithPrefix.length) {
+            this.finishAutocomplete();
             return;
-        var prefix = this._textEditor.copyRange(this._prefixRange);
-        this._lastPrefix = prefix;
-        this._hintElement.textContent = hint.substring(prefix.length).split("\n")[0];
-        var cursor = this._codeMirror.getCursor("to");
-        this._hintMarker = this._textEditor.addBookmark(cursor.line, cursor.ch, this._hintElement, true);
-    },
+        }
 
-    _clearHintMarker: function()
-    {
-        if (!this._hintMarker)
-            return;
-        this._hintMarker.clear();
-        delete this._hintMarker;
+        if (!this._suggestBox)
+            this._suggestBox = new WebInspector.SuggestBox(this, 6);
+        var oldPrefixRange = this._prefixRange;
+        this._prefixRange = prefixRange;
+        if (!oldPrefixRange || prefixRange.startLine !== oldPrefixRange.startLine || prefixRange.startColumn !== oldPrefixRange.startColumn)
+            this._updateAnchorBox();
+        this._suggestBox.updateSuggestions(this._anchorBox, wordsWithPrefix.map(item => ({title: item})), 0, true, this._textEditor.copyRange(prefixRange));
+        if (!this._suggestBox.visible())
+            this.finishAutocomplete();
+        this._onSuggestionsShownForTest(wordsWithPrefix);
     },
 
     /**
-     * @param {!Array<{className: (string|undefined), title: string}>} suggestions
+     * @param {!Array.<string>} suggestions
      */
     _onSuggestionsShownForTest: function(suggestions) { },
 
@@ -219,50 +157,26 @@ WebInspector.TextEditorAutocompleteController.prototype = {
         this._suggestBox = null;
         this._prefixRange = null;
         this._anchorBox = null;
-        this._clearHintMarker();
     },
 
     /**
-     * @param {!Event} event
+     * @param {!Event} e
      * @return {boolean}
      */
-    keyDown: function(event)
+    keyDown: function(e)
     {
         if (!this._suggestBox)
             return false;
-        switch (event.keyCode) {
-        case WebInspector.KeyboardShortcut.Keys.Tab.code:
-            this._suggestBox.acceptSuggestion();
+        if (e.keyCode === WebInspector.KeyboardShortcut.Keys.Esc.code) {
             this.finishAutocomplete();
             return true;
-        case WebInspector.KeyboardShortcut.Keys.End.code:
-        case WebInspector.KeyboardShortcut.Keys.Right.code:
-            if (this._isCursorAtEndOfLine()) {
-                this._suggestBox.acceptSuggestion();
-                this.finishAutocomplete();
-                return true;
-            } else {
-                this.finishAutocomplete();
-                return false;
-            }
-        case WebInspector.KeyboardShortcut.Keys.Left.code:
-        case WebInspector.KeyboardShortcut.Keys.Home.code:
-            this.finishAutocomplete();
-            return false;
-        case WebInspector.KeyboardShortcut.Keys.Esc.code:
+        }
+        if (e.keyCode === WebInspector.KeyboardShortcut.Keys.Tab.code) {
+            this._suggestBox.acceptSuggestion();
             this.finishAutocomplete();
             return true;
         }
-        return this._suggestBox.keyPressed(event);
-    },
-
-    /**
-     * @return {boolean}
-     */
-    _isCursorAtEndOfLine: function()
-    {
-        var cursor = this._codeMirror.getCursor("to");
-        return cursor.ch === this._codeMirror.getLine(cursor.line).length;
+        return this._suggestBox.keyPressed(e);
     },
 
     /**
@@ -273,7 +187,6 @@ WebInspector.TextEditorAutocompleteController.prototype = {
     applySuggestion: function(suggestion, isIntermediateSuggestion)
     {
         this._currentSuggestion = suggestion;
-        this._addHintMarker(suggestion);
     },
 
     /**
@@ -314,7 +227,7 @@ WebInspector.TextEditorAutocompleteController.prototype = {
         if (!this._suggestBox)
             return;
         var cursor = this._codeMirror.getCursor();
-        if (cursor.line !== this._prefixRange.startLine || cursor.ch > this._prefixRange.endColumn + 1 || cursor.ch <= this._prefixRange.startColumn)
+        if (cursor.line !== this._prefixRange.startLine || cursor.ch > this._prefixRange.endColumn || cursor.ch <= this._prefixRange.startColumn)
             this.finishAutocomplete();
     },
 
@@ -345,7 +258,7 @@ WebInspector.TextEditorAutocompleteDelegate.prototype = {
      * @param {!WebInspector.CodeMirrorTextEditor} editor
      * @param {!WebInspector.TextRange} prefixRange
      * @param {!WebInspector.TextRange} substituteRange
-     * @return {!Promise.<!WebInspector.SuggestBox.Suggestions>}
+     * @return {!Array.<string>}
      */
     wordsWithPrefix: function(editor, prefixRange, substituteRange) {},
 
@@ -407,12 +320,12 @@ WebInspector.SimpleAutocompleteDelegate.prototype = {
      * @param {!WebInspector.CodeMirrorTextEditor} editor
      * @param {!WebInspector.TextRange} prefixRange
      * @param {!WebInspector.TextRange} substituteRange
-     * @return {!Promise.<!WebInspector.SuggestBox.Suggestions>}
+     * @return {!Array.<string>}
      */
     wordsWithPrefix: function(editor, prefixRange, substituteRange)
     {
         if (prefixRange.startColumn === prefixRange.endColumn)
-            return Promise.resolve([]);
+            return [];
 
         var dictionary = this._dictionary;
         var completions = dictionary.wordsWithPrefix(editor.copyRange(prefixRange));
@@ -421,7 +334,7 @@ WebInspector.SimpleAutocompleteDelegate.prototype = {
             completions = completions.filter(excludeFilter.bind(null, substituteWord));
 
         completions.sort(sortSuggestions);
-        return Promise.resolve(completions.map(item => ({ title: item })));
+        return completions;
 
         function sortSuggestions(a, b)
         {
diff --git a/third_party/WebKit/Source/devtools/front_end/source_frame/cmdevtools.css b/third_party/WebKit/Source/devtools/front_end/source_frame/cmdevtools.css
index 62abbd7..019adb6 100644
--- a/third_party/WebKit/Source/devtools/front_end/source_frame/cmdevtools.css
+++ b/third_party/WebKit/Source/devtools/front_end/source_frame/cmdevtools.css
@@ -1,7 +1,6 @@
 .CodeMirror {
     line-height: 1.2em !important;
     background-color: transparent !important;
-    color: #222;
 }
 
 .CodeMirror-linewidget {
@@ -353,7 +352,3 @@
 .-theme-with-dark-background .CodeMirror .CodeMirror-selected {
     background-color: #454545;
 }
-
-.CodeMirror .auto-complete-text{
-    color: rgb(128,128,128);
-}
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/CSSSourceFrame.js b/third_party/WebKit/Source/devtools/front_end/sources/CSSSourceFrame.js
index 3dfd6d0..af853de 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/CSSSourceFrame.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/CSSSourceFrame.js
@@ -345,21 +345,20 @@ WebInspector.CSSSourceFrame.AutocompleteDelegate.prototype = {
      * @param {!WebInspector.CodeMirrorTextEditor} editor
      * @param {!WebInspector.TextRange} prefixRange
      * @param {!WebInspector.TextRange} substituteRange
-     * @return {!Promise.<!WebInspector.SuggestBox.Suggestions>}
+     * @return {!Array.<string>}
      */
     wordsWithPrefix: function(editor, prefixRange, substituteRange)
     {
         var prefix = editor.copyRange(prefixRange);
         if (prefix.startsWith("$"))
             return this._simpleDelegate.wordsWithPrefix(editor, prefixRange, substituteRange);
-
         var propertyToken = this._backtrackPropertyToken(editor, prefixRange.startLine, prefixRange.startColumn - 1);
         if (!propertyToken)
             return this._simpleDelegate.wordsWithPrefix(editor, prefixRange, substituteRange);
 
         var line = editor.line(prefixRange.startLine);
         var tokenContent = line.substring(propertyToken.startColumn, propertyToken.endColumn);
-        var propertyValues = WebInspector.CSSMetadata.propertyValues(tokenContent);
-        return Promise.resolve(propertyValues.filter(value => value.startsWith(prefix)).map(value => ({title: value})));
-    }
+        var keywords = WebInspector.CSSMetadata.keywordsForProperty(tokenContent);
+        return keywords.startsWith(prefix);
+    },
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/CallStackSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/sources/CallStackSidebarPane.js
index 2126ac1..a176254 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/CallStackSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/CallStackSidebarPane.js
@@ -25,11 +25,11 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  */
 WebInspector.CallStackSidebarPane = function()
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Call Stack"));
+    WebInspector.View.call(this, WebInspector.UIString("Call Stack"));
     this.element.addEventListener("keydown", this._keyDown.bind(this), true);
     this.element.tabIndex = 0;
     this.callFrameList = new WebInspector.UIList();
@@ -426,7 +426,7 @@ WebInspector.CallStackSidebarPane.prototype = {
             event.consume(true);
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
 
 /**
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/EventListenerBreakpointsSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/sources/EventListenerBreakpointsSidebarPane.js
index 5876d0b..733b963 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/EventListenerBreakpointsSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/EventListenerBreakpointsSidebarPane.js
@@ -4,12 +4,12 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @implements {WebInspector.TargetManager.Observer}
  */
 WebInspector.EventListenerBreakpointsSidebarPane = function()
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Event Listener Breakpoints"));
+    WebInspector.View.call(this, WebInspector.UIString("Event Listener Breakpoints"));
     this.registerRequiredCSS("components/breakpointsList.css");
 
     this._eventListenerBreakpointsSetting = WebInspector.settings.createLocalSetting("eventListenerBreakpoints", []);
@@ -303,7 +303,7 @@ WebInspector.EventListenerBreakpointsSidebarPane.prototype = {
             breakpointItem = this._findBreakpointItem(eventName, WebInspector.EventListenerBreakpointsSidebarPane.eventTargetAny);
         if (!breakpointItem)
             return;
-        this.revealView();
+        this.revealWidget();
         breakpointItem.parent.element.expand();
         breakpointItem.element.listItemElement.classList.add("breakpoint-hit");
         this._highlightedElement = breakpointItem.element.listItemElement;
@@ -344,5 +344,5 @@ WebInspector.EventListenerBreakpointsSidebarPane.prototype = {
         }
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/JavaScriptBreakpointsSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/sources/JavaScriptBreakpointsSidebarPane.js
index 25c2186..00262c3 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/JavaScriptBreakpointsSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/JavaScriptBreakpointsSidebarPane.js
@@ -4,13 +4,13 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {!WebInspector.BreakpointManager} breakpointManager
  * @param {function(!WebInspector.UISourceCode, number=, number=, boolean=)} showSourceLineDelegate
  */
 WebInspector.JavaScriptBreakpointsSidebarPane = function(breakpointManager, showSourceLineDelegate)
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Breakpoints"));
+    WebInspector.View.call(this, WebInspector.UIString("Breakpoints"));
     this.registerRequiredCSS("components/breakpointsList.css");
 
     this._breakpointManager = breakpointManager;
@@ -144,7 +144,7 @@ WebInspector.JavaScriptBreakpointsSidebarPane.prototype = {
             return;
         breakpointItem.element.classList.add("breakpoint-hit");
         this._highlightedBreakpointItem = breakpointItem;
-        this.revealView();
+        this.revealWidget();
     },
 
     clearBreakpointHighlight: function()
@@ -255,5 +255,5 @@ WebInspector.JavaScriptBreakpointsSidebarPane.prototype = {
         this._items.clear();
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/JavaScriptSourceFrame.js b/third_party/WebKit/Source/devtools/front_end/sources/JavaScriptSourceFrame.js
index ecf07a0..b6d2c3b 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/JavaScriptSourceFrame.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/JavaScriptSourceFrame.js
@@ -83,9 +83,9 @@ WebInspector.JavaScriptSourceFrame.prototype = {
      * @override
      * @return {!Array<!WebInspector.ToolbarItem>}
      */
-    syncToolbarItems: function()
+    toolbarItems: function()
     {
-        var result = WebInspector.UISourceCodeFrame.prototype.syncToolbarItems.call(this);
+        var result = WebInspector.UISourceCodeFrame.prototype.toolbarItems.call(this);
         var originURL = WebInspector.CompilerScriptMapping.uiSourceCodeOrigin(this.uiSourceCode());
         if (originURL) {
             var parsedURL = originURL.asParsedURL();
@@ -149,6 +149,7 @@ WebInspector.JavaScriptSourceFrame.prototype = {
             return;
         var networkURL = WebInspector.networkMapping.networkURL(uiSourceCode);
         var url = projectType === WebInspector.projectTypes.Formatter ? uiSourceCode.url() : networkURL;
+        var isContentScript = projectType === WebInspector.projectTypes.ContentScripts;
         if (!WebInspector.blackboxManager.isBlackboxedUISourceCode(uiSourceCode)) {
             this._hideBlackboxInfobar();
             return;
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/ObjectEventListenersSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/sources/ObjectEventListenersSidebarPane.js
index ccc04e3..8dafcb1 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/ObjectEventListenersSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/ObjectEventListenersSidebarPane.js
@@ -4,11 +4,11 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  */
 WebInspector.ObjectEventListenersSidebarPane = function()
 {
-    WebInspector.SimpleView.call(this, "Event Listeners");
+    WebInspector.View.call(this, "Event Listeners");
     this.element.classList.add("event-listeners-sidebar-pane");
 
     this._refreshButton = new WebInspector.ToolbarButton(WebInspector.UIString("Refresh"), "refresh-toolbar-item");
@@ -40,7 +40,7 @@ WebInspector.ObjectEventListenersSidebarPane.prototype = {
 
     wasShown: function()
     {
-        WebInspector.SimpleView.prototype.wasShown.call(this);
+        WebInspector.View.prototype.wasShown.call(this);
         WebInspector.context.addFlavorChangeListener(WebInspector.ExecutionContext, this.update, this);
         this._refreshButton.setEnabled(true);
         this.update();
@@ -48,7 +48,7 @@ WebInspector.ObjectEventListenersSidebarPane.prototype = {
 
     willHide: function()
     {
-        WebInspector.SimpleView.prototype.willHide.call(this);
+        WebInspector.View.prototype.willHide.call(this);
         WebInspector.context.removeFlavorChangeListener(WebInspector.ExecutionContext, this.update, this);
         this._refreshButton.setEnabled(false);
     },
@@ -89,5 +89,5 @@ WebInspector.ObjectEventListenersSidebarPane.prototype = {
         this.update();
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/ScopeChainSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/sources/ScopeChainSidebarPane.js
index 858a67e..8be8742 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/ScopeChainSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/ScopeChainSidebarPane.js
@@ -26,11 +26,11 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  */
 WebInspector.ScopeChainSidebarPane = function()
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Scope"));
+    WebInspector.View.call(this, WebInspector.UIString("Scope"));
     this._expandController = new WebInspector.ObjectPropertiesSectionExpandController();
     this._linkifier = new WebInspector.Linkifier();
 }
@@ -138,5 +138,5 @@ WebInspector.ScopeChainSidebarPane.prototype = {
 
     _sidebarPaneUpdatedForTest: function() { },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/SourcesPanel.js b/third_party/WebKit/Source/devtools/front_end/sources/SourcesPanel.js
index 9f97ef7..6059607 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/SourcesPanel.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/SourcesPanel.js
@@ -64,7 +64,7 @@ WebInspector.SourcesPanel = function()
     this._splitWidget.setMainWidget(this.editorView);
 
     // Create navigator tabbed pane with toolbar.
-    this._navigatorTabbedLocation = WebInspector.viewManager.createTabbedLocation(this._setAsCurrentPanel.bind(this), "navigator-view", true);
+    this._navigatorTabbedLocation = WebInspector.viewManager.createTabbedLocation("navigator-view", true);
     var tabbedPane = this._navigatorTabbedLocation.tabbedPane();
     tabbedPane.setMinimumSize(100, 25);
     tabbedPane.setShrinkableTabs(true);
@@ -96,6 +96,8 @@ WebInspector.SourcesPanel = function()
     this.sidebarPanes.eventListenerBreakpoints = new WebInspector.EventListenerBreakpointsSidebarPane();
     this.sidebarPanes.objectEventListeners = new WebInspector.ObjectEventListenersSidebarPane();
 
+    this._lastSelectedTabSetting = WebInspector.settings.createLocalSetting("lastSelectedSourcesSidebarPaneTab", WebInspector.UIString("Scope"));
+
     this._installDebuggerSidebarController();
 
     WebInspector.moduleSetting("sidebarPosition").addChangeListener(this._updateSidebarPosition.bind(this));
@@ -137,7 +139,7 @@ WebInspector.SourcesPanel.prototype = {
         if (hasThreads && !this.sidebarPanes.threads) {
             this.sidebarPanes.threads = new WebInspector.ThreadsSidebarPane();
             if (this._sidebarPaneStack) {
-                this._sidebarPaneStack.showView(this.sidebarPanes.threads, this._splitWidget.isVertical() ? this.sidebarPanes.watchExpressions : this.sidebarPanes.callstack);
+                this._sidebarPaneStack.insertViewBefore(this.sidebarPanes.threads, this._splitWidget.isVertical() ? this.sidebarPanes.watchExpressions : this.sidebarPanes.callstack, true);
             }
         }
     },
@@ -217,8 +219,9 @@ WebInspector.SourcesPanel.prototype = {
      * @param {string} locationName
      * @return {?WebInspector.ViewLocation}
      */
-    resolveLocation: function(locationName)
+    revealLocation: function(locationName)
     {
+        WebInspector.inspectorView.setCurrentPanel(WebInspector.SourcesPanel.instance());
         return this._navigatorTabbedLocation;
     },
 
@@ -1122,47 +1125,44 @@ WebInspector.SourcesPanel.prototype = {
         var vbox = new WebInspector.VBox();
         vbox.element.appendChild(this._debugToolbarDrawer);
         vbox.setMinimumAndPreferredSizes(25, 25, WebInspector.SourcesPanel.minToolbarWidth, 100);
-        this._sidebarPaneStack = WebInspector.viewManager.createStackLocation(this._setAsCurrentPanel.bind(this), "sources-sidebar");
-        this._sidebarPaneStack.widget().show(vbox.element);
+        this._sidebarPaneStack = new WebInspector.View.ExpandableStackContainer();
+        this._sidebarPaneStack.show(vbox.element);
         vbox.element.appendChild(this._debugToolbar.element);
 
-        if (this.sidebarPanes.threads)
-            this._sidebarPaneStack.showView(this.sidebarPanes.threads);
-
         if (!vertically) {
-            if (this.sidebarPanes.watchExpressions.hasExpressions())
-                this._sidebarPaneStack.showView(this.sidebarPanes.watchExpressions);
-            else
-                this._sidebarPaneStack.appendView(this.sidebarPanes.watchExpressions);
-        }
-
-        this._sidebarPaneStack.showView(this.sidebarPanes.callstack);
-        this._sidebarPaneStack.showView(this.sidebarPanes.scopechain);
-        this._sidebarPaneStack.showView(this.sidebarPanes.jsBreakpoints);
-
-        if (!vertically) {
-            // Populate the rest of the stack.
+            // Populate the only stack.
             for (var pane in this.sidebarPanes) {
                 if (this.sidebarPanes[pane])
                     this._sidebarPaneStack.appendView(this.sidebarPanes[pane]);
             }
             this._extensionSidebarPanesContainer = this._sidebarPaneStack;
             this.sidebarPaneView = vbox;
+
+            this.sidebarPanes.scopechain.revealWidget();
+            this.sidebarPanes.watchExpressions.expandIfNecessary();
         } else {
             var splitWidget = new WebInspector.SplitWidget(true, true, "sourcesPanelDebuggerSidebarSplitViewState", 0.5);
             splitWidget.setMainWidget(vbox);
 
             // Populate the left stack.
+            if (this.sidebarPanes.threads)
+                this._sidebarPaneStack.appendView(this.sidebarPanes.threads);
+            this._sidebarPaneStack.appendView(this.sidebarPanes.callstack);
+            this._sidebarPaneStack.appendView(this.sidebarPanes.jsBreakpoints);
             this._sidebarPaneStack.appendView(this.sidebarPanes.domBreakpoints);
             this._sidebarPaneStack.appendView(this.sidebarPanes.xhrBreakpoints);
             this._sidebarPaneStack.appendView(this.sidebarPanes.eventListenerBreakpoints);
             this._sidebarPaneStack.appendView(this.sidebarPanes.objectEventListeners);
 
-            var tabbedLocation = WebInspector.viewManager.createTabbedLocation(this._setAsCurrentPanel.bind(this), "sources-sidebar-tabs");
-            splitWidget.setSidebarWidget(tabbedLocation.tabbedPane());
-            tabbedLocation.appendView(this.sidebarPanes.scopechain);
-            tabbedLocation.appendView(this.sidebarPanes.watchExpressions);
-            this._extensionSidebarPanesContainer = tabbedLocation;
+            var tabbedPane = new WebInspector.View.TabbedPaneContainer();
+            splitWidget.setSidebarWidget(tabbedPane);
+            tabbedPane.appendView(this.sidebarPanes.scopechain);
+            tabbedPane.appendView(this.sidebarPanes.watchExpressions);
+            if (this.sidebarPanes.serviceWorkers)
+                tabbedPane.appendView(this.sidebarPanes.serviceWorkers);
+            tabbedPane.selectTab(this._lastSelectedTabSetting.get());
+            tabbedPane.addEventListener(WebInspector.TabbedPane.EventTypes.TabSelected, this._tabSelected, this);
+            this._extensionSidebarPanesContainer = tabbedPane;
             this.sidebarPaneView = splitWidget;
         }
 
@@ -1171,11 +1171,18 @@ WebInspector.SourcesPanel.prototype = {
             this._addExtensionSidebarPane(extensionSidebarPanes[i]);
 
         this._splitWidget.setSidebarWidget(this.sidebarPaneView);
+        if (this.sidebarPanes.threads)
+            this.sidebarPanes.threads.revealWidget();
+        this.sidebarPanes.jsBreakpoints.revealWidget();
+        this.sidebarPanes.callstack.revealWidget();
     },
 
-    _setAsCurrentPanel: function()
+    /**
+     * @param {!WebInspector.Event} event
+     */
+    _tabSelected: function(event)
     {
-        WebInspector.inspectorView.setCurrentPanel(this);
+        this._lastSelectedTabSetting.set(event.data.tabId);
     },
 
     /**
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/SourcesView.js b/third_party/WebKit/Source/devtools/front_end/sources/SourcesView.js
index eea0d2d..2b57bda 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/SourcesView.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/SourcesView.js
@@ -270,8 +270,8 @@ WebInspector.SourcesView.prototype = {
     {
         this._scriptViewToolbar.removeToolbarItems();
         var view = this.visibleView()
-        if (view instanceof WebInspector.SimpleView) {
-            for (var item of (/** @type {?WebInspector.SimpleView} */(view)).syncToolbarItems())
+        if (view instanceof WebInspector.View) {
+            for (var item of (/** @type {?WebInspector.View} */(view)).toolbarItems())
                 this._scriptViewToolbar.appendToolbarItem(item);
         }
     },
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/ThreadsSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/sources/ThreadsSidebarPane.js
index dbd0fc7..5b7d53c 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/ThreadsSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/ThreadsSidebarPane.js
@@ -4,12 +4,12 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @implements {WebInspector.TargetManager.Observer}
  */
 WebInspector.ThreadsSidebarPane = function()
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Threads"));
+    WebInspector.View.call(this, WebInspector.UIString("Threads"));
 
     /** @type {!Map.<!WebInspector.DebuggerModel, !WebInspector.UIList.Item>} */
     this._debuggerModelToListItems = new Map();
@@ -137,5 +137,5 @@ WebInspector.ThreadsSidebarPane.prototype = {
     },
 
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/WatchExpressionsSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/sources/WatchExpressionsSidebarPane.js
index bbcdf0f..54ef09f 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/WatchExpressionsSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/WatchExpressionsSidebarPane.js
@@ -30,11 +30,11 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  */
 WebInspector.WatchExpressionsSidebarPane = function()
 {
-    WebInspector.SimpleView.call(this, WebInspector.UIString("Watch"));
+    WebInspector.View.call(this, WebInspector.UIString("Watch"));
     this.registerRequiredCSS("components/objectValue.css");
 
     this._requiresUpdate = true;
@@ -75,7 +75,7 @@ WebInspector.WatchExpressionsSidebarPane.prototype = {
      */
     addExpression: function(expressionString)
     {
-        this.revealView();
+        this.revealWidget();
         if (this._requiresUpdate) {
             this._rebuildWatchExpressions();
             delete this._requiresUpdate;
@@ -84,12 +84,10 @@ WebInspector.WatchExpressionsSidebarPane.prototype = {
         this._saveExpressions();
     },
 
-    /**
-     * @return {boolean}
-     */
-    hasExpressions: function()
+    expandIfNecessary: function()
     {
-        return !!this._watchExpressionsSetting.get().length;
+        if (this._watchExpressionsSetting.get().length)
+            this.revealWidget();
     },
 
     _saveExpressions: function()
@@ -118,7 +116,7 @@ WebInspector.WatchExpressionsSidebarPane.prototype = {
     {
         if (event)
             event.consume(true);
-        this.revealView();
+        this.revealWidget();
         this._createWatchExpression(null).startEditing();
     },
 
@@ -215,7 +213,7 @@ WebInspector.WatchExpressionsSidebarPane.prototype = {
         this._rebuildWatchExpressions();
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
 
 /**
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/XHRBreakpointsSidebarPane.js b/third_party/WebKit/Source/devtools/front_end/sources/XHRBreakpointsSidebarPane.js
index e6a37ed..251e80a 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/XHRBreakpointsSidebarPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/sources/XHRBreakpointsSidebarPane.js
@@ -52,7 +52,7 @@ WebInspector.XHRBreakpointsSidebarPane.prototype = {
         if (event)
             event.consume();
 
-        this.revealView();
+        this.revealWidget();
 
         var inputElementContainer = createElementWithClass("p", "breakpoint-condition");
         inputElementContainer.textContent = WebInspector.UIString("Break when URL contains:");
@@ -217,7 +217,7 @@ WebInspector.XHRBreakpointsSidebarPane.prototype = {
         var element = this._breakpointElements.get(url);
         if (!element)
             return;
-        this.revealView();
+        this.revealWidget();
         element.classList.add("breakpoint-hit");
         this._highlightedElement = element;
     },
diff --git a/third_party/WebKit/Source/devtools/front_end/sources/module.json b/third_party/WebKit/Source/devtools/front_end/sources/module.json
index e70e693..ec5299f 100644
--- a/third_party/WebKit/Source/devtools/front_end/sources/module.json
+++ b/third_party/WebKit/Source/devtools/front_end/sources/module.json
@@ -342,7 +342,7 @@
             "location": "drawer-view",
             "id": "sources.history",
             "title": "History",
-            "persistence": "transient",
+            "persistence": "temporary",
             "className": "WebInspector.RevisionHistoryView"
         },
         {
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/InspectorView.js b/third_party/WebKit/Source/devtools/front_end/ui/InspectorView.js
index 571f8f0..87f968c 100644
--- a/third_party/WebKit/Source/devtools/front_end/ui/InspectorView.js
+++ b/third_party/WebKit/Source/devtools/front_end/ui/InspectorView.js
@@ -47,8 +47,7 @@ WebInspector.InspectorView = function()
     this._drawerSplitWidget.show(this.element);
 
     // Create drawer tabbed pane.
-    this._drawerTabbedLocation = WebInspector.viewManager.createTabbedLocation(this.showDrawer.bind(this), "drawer-view", true);
-    this._drawerTabbedLocation.enableMoreTabsButton();
+    this._drawerTabbedLocation = WebInspector.viewManager.createTabbedLocation("drawer-view", true, true);
     this._drawerTabbedPane = this._drawerTabbedLocation.tabbedPane();
     this._drawerTabbedPane.setMinimumSize(0, 27);
     var drawerToolbar = new WebInspector.Toolbar("drawer-close-toolbar");
@@ -124,8 +123,9 @@ WebInspector.InspectorView.prototype = {
      * @param {string} locationName
      * @return {?WebInspector.ViewLocation}
      */
-    resolveLocation: function(locationName)
+    revealLocation: function(locationName)
     {
+        this.showDrawer();
         return this._drawerTabbedLocation;
     },
 
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/SuggestBox.js b/third_party/WebKit/Source/devtools/front_end/ui/SuggestBox.js
index 017e530..21e4bf4 100644
--- a/third_party/WebKit/Source/devtools/front_end/ui/SuggestBox.js
+++ b/third_party/WebKit/Source/devtools/front_end/ui/SuggestBox.js
@@ -181,11 +181,6 @@ WebInspector.SuggestBox.prototype = {
      */
     _applySuggestion: function(isIntermediateSuggestion)
     {
-        if (this._onlyCompletion) {
-            this._suggestBoxDelegate.applySuggestion(this._onlyCompletion, isIntermediateSuggestion);
-            return true;
-        }
-
         if (!this.visible() || !this._selectedElement)
             return false;
 
@@ -385,18 +380,14 @@ WebInspector.SuggestBox.prototype = {
      */
     updateSuggestions: function(anchorBox, completions, selectedIndex, canShowForSingleItem, userEnteredText, asyncDetails)
     {
-        delete this._onlyCompletion;
         if (this._canShowBox(completions, canShowForSingleItem, userEnteredText)) {
             this._updateItems(completions, userEnteredText, asyncDetails);
             this._show();
             this._updateBoxPosition(anchorBox);
             this._selectItem(selectedIndex, selectedIndex > 0);
             delete this._rowCountPerViewport;
-        } else {
-            if (completions.length === 1)
-                this._onlyCompletion = completions[0].title;
+        } else
             this.hide();
-        }
     },
 
     /**
@@ -459,7 +450,7 @@ WebInspector.SuggestBox.prototype = {
      */
     enterKeyPressed: function()
     {
-        var hasSelectedItem = !!this._selectedElement || this._onlyCompletion;
+        var hasSelectedItem = !!this._selectedElement;
         this.acceptSuggestion();
 
         // Report the event as non-handled if there is no selected item,
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/TabbedPane.js b/third_party/WebKit/Source/devtools/front_end/ui/TabbedPane.js
index 119d844..1eb8004 100644
--- a/third_party/WebKit/Source/devtools/front_end/ui/TabbedPane.js
+++ b/third_party/WebKit/Source/devtools/front_end/ui/TabbedPane.js
@@ -852,6 +852,25 @@ WebInspector.TabbedPane.prototype = {
         this._automaticReorder = automatic;
     },
 
+    /**
+     * @override
+     * @param {!WebInspector.Widget} child
+     * @return {boolean}
+     */
+    revealChild: function(child)
+    {
+        if (this._currentTabLocked)
+            return false;
+
+        for (var tabId of this.tabIds()) {
+            if (this.tabView(tabId) === child) {
+                this.selectTab(tabId);
+                return true;
+            }
+        }
+        return false;
+    },
+
     __proto__: WebInspector.VBox.prototype
 }
 
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/ThrottledView.js b/third_party/WebKit/Source/devtools/front_end/ui/ThrottledView.js
index 650d552..0a657da 100644
--- a/third_party/WebKit/Source/devtools/front_end/ui/ThrottledView.js
+++ b/third_party/WebKit/Source/devtools/front_end/ui/ThrottledView.js
@@ -4,13 +4,13 @@
 
 /**
  * @constructor
- * @extends {WebInspector.SimpleView}
+ * @extends {WebInspector.View}
  * @param {string} title
  * @param {boolean=} isWebComponent
  */
 WebInspector.ThrottledView = function(title, isWebComponent)
 {
-    WebInspector.SimpleView.call(this, title, isWebComponent);
+    WebInspector.View.call(this, title, isWebComponent);
     this._updateThrottler = new WebInspector.Throttler(100);
     this._updateWhenVisible = false;
 }
@@ -52,10 +52,10 @@ WebInspector.ThrottledView.prototype = {
      */
     wasShown: function()
     {
-        WebInspector.SimpleView.prototype.wasShown.call(this);
+        WebInspector.View.prototype.wasShown.call(this);
         if (this._updateWhenVisible)
             this.update();
     },
 
-    __proto__: WebInspector.SimpleView.prototype
+    __proto__: WebInspector.View.prototype
 }
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/UIUtils.js b/third_party/WebKit/Source/devtools/front_end/ui/UIUtils.js
index 73bb5c0..1f178a2 100644
--- a/third_party/WebKit/Source/devtools/front_end/ui/UIUtils.js
+++ b/third_party/WebKit/Source/devtools/front_end/ui/UIUtils.js
@@ -1636,6 +1636,60 @@ WebInspector.bindInput = function(input, apply, validate, numeric)
 
 /**
  * @constructor
+ */
+WebInspector.StringFormatter = function()
+{
+    this._processors = [];
+    this._regexes = [];
+}
+
+WebInspector.StringFormatter.prototype = {
+    /**
+     * @param {!RegExp} regex
+     * @param {function(string):!Node} handler
+     */
+    addProcessor: function(regex, handler)
+    {
+        this._regexes.push(regex);
+        this._processors.push(handler);
+    },
+
+    /**
+     * @param {string} text
+     * @return {!Node}
+     */
+    formatText: function(text)
+    {
+        return this._runProcessor(0, text);
+    },
+
+    /**
+     * @param {number} processorIndex
+     * @param {string} text
+     * @return {!Node}
+     */
+    _runProcessor: function(processorIndex, text)
+    {
+        if (processorIndex >= this._processors.length)
+            return createTextNode(text);
+
+        var container = createDocumentFragment();
+        var regex = this._regexes[processorIndex];
+        var processor = this._processors[processorIndex];
+
+        // Due to the nature of regex, |items| array has matched elements on its even indexes.
+        var items = text.replace(regex, "\0$1\0").split("\0");
+        for (var i = 0; i < items.length; ++i) {
+            var processedNode = i % 2 ? processor(items[i]) : this._runProcessor(processorIndex + 1, items[i]);
+            container.appendChild(processedNode);
+        }
+
+        return container;
+    }
+}
+
+/**
+ * @constructor
  * @param {!WebInspector.Setting} setting
  */
 WebInspector.ThemeSupport = function(setting)
@@ -1813,9 +1867,10 @@ WebInspector.ThemeSupport.prototype = {
         if (name.indexOf("background") === -1)
             colorUsage |= WebInspector.ThemeSupport.ColorUsage.Foreground;
 
+        var colorRegex = /((?:rgb|hsl)a?\([^)]+\)|#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}|\b\w+\b(?!-))/g;
         output.push(name);
         output.push(":");
-        var items = value.replace(WebInspector.Color.Regex, "\0$1\0").split("\0");
+        var items = value.replace(colorRegex, "\0$1\0").split("\0");
         for (var i = 0; i < items.length; ++i)
             output.push(this.patchColor(items[i], colorUsage));
         if (style.getPropertyPriority(name))
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/View.js b/third_party/WebKit/Source/devtools/front_end/ui/View.js
index 608bb09..5863780 100644
--- a/third_party/WebKit/Source/devtools/front_end/ui/View.js
+++ b/third_party/WebKit/Source/devtools/front_end/ui/View.js
@@ -3,52 +3,12 @@
 // found in the LICENSE file.
 
 /**
- * @interface
- */
-WebInspector.View = function()
-{
-}
-
-WebInspector.View.prototype = {
-    /**
-     * @return {string}
-     */
-    viewId: function() { },
-
-    /**
-     * @return {string}
-     */
-    title: function() { },
-
-    /**
-     * @return {boolean}
-     */
-    isCloseable: function() { },
-
-    /**
-     * @return {boolean}
-     */
-    isTransient: function() { },
-
-    /**
-     * @return {!Promise<!Array<!WebInspector.ToolbarItem>>}
-     */
-    toolbarItems: function() { },
-
-    /**
-     * @return {!Promise<!WebInspector.Widget>}
-     */
-    widget: function() { }
-}
-
-/**
  * @constructor
  * @extends {WebInspector.VBox}
- * @implements {WebInspector.View}
  * @param {string} title
  * @param {boolean=} isWebComponent
  */
-WebInspector.SimpleView = function(title, isWebComponent)
+WebInspector.View = function(title, isWebComponent)
 {
     WebInspector.VBox.call(this, isWebComponent);
     this._title = title;
@@ -56,18 +16,8 @@ WebInspector.SimpleView = function(title, isWebComponent)
     this._toolbarItems = [];
 }
 
-WebInspector.SimpleView.prototype = {
-    /**
-     * @override
-     * @return {string}
-     */
-    viewId: function()
-    {
-        return this._title;
-    },
-
+WebInspector.View.prototype = {
     /**
-     * @override
      * @return {string}
      */
     title: function()
@@ -76,50 +26,6 @@ WebInspector.SimpleView.prototype = {
     },
 
     /**
-     * @override
-     * @return {boolean}
-     */
-    isCloseable: function()
-    {
-        return false;
-    },
-
-    /**
-     * @override
-     * @return {boolean}
-     */
-    isTransient: function()
-    {
-        return false;
-    },
-
-    /**
-     * @override
-     * @return {!Promise<!Array<!WebInspector.ToolbarItem>>}
-     */
-    toolbarItems: function()
-    {
-        return Promise.resolve(this.syncToolbarItems());
-    },
-
-    /**
-     * @return {!Array<!WebInspector.ToolbarItem>}
-     */
-    syncToolbarItems: function()
-    {
-        return this._toolbarItems;
-    },
-
-    /**
-     * @override
-     * @return {!Promise<!WebInspector.Widget>}
-     */
-    widget: function()
-    {
-        return /** @type {!Promise<!WebInspector.Widget>} */ (Promise.resolve(this));
-    },
-
-    /**
      * @param {!WebInspector.ToolbarItem} item
      */
     addToolbarItem: function(item)
@@ -128,88 +34,14 @@ WebInspector.SimpleView.prototype = {
     },
 
     /**
-     * @return {!Promise}
-     */
-    revealView: function()
-    {
-        return WebInspector.viewManager.revealView(this._parentViewToReveal || this);
-    },
-
-    /**
-     * @param {!WebInspector.View} view
-     */
-    setParentViewForReveal: function(view)
-    {
-        this._parentViewToReveal = view;
-    },
-
-    __proto__: WebInspector.VBox.prototype
-}
-
-/**
- * @constructor
- * @implements {WebInspector.View}
- * @param {!Runtime.Extension} extension
- */
-WebInspector.ProvidedView = function(extension)
-{
-    this._extension = extension;
-}
-
-WebInspector.ProvidedView.prototype = {
-    /**
-     * @override
-     * @return {string}
-     */
-    viewId: function()
-    {
-        return this._extension.descriptor()["id"];
-    },
-
-    /**
-     * @override
-     * @return {string}
-     */
-    title: function()
-    {
-        return this._extension.title();
-    },
-
-    /**
-     * @override
-     * @return {boolean}
-     */
-    isCloseable: function()
-    {
-        return this._extension.descriptor()["persistence"] === "closeable";
-    },
-
-    /**
-     * @override
-     * @return {boolean}
-     */
-    isTransient: function()
-    {
-        return this._extension.descriptor()["persistence"] === "transient";
-    },
-
-    /**
-     * @override
-     * @return {!Promise<!Array<!WebInspector.ToolbarItem>>}
+     * @return {!Array<!WebInspector.ToolbarItem>}
      */
     toolbarItems: function()
     {
-        return Promise.resolve([]);
+        return this._toolbarItems;
     },
 
-    /**
-     * @override
-     * @return {!Promise<!WebInspector.Widget>}
-     */
-    widget: function()
-    {
-        return  /** @type {!Promise<!WebInspector.Widget>} */ (this._extension.instance());
-    }
+    __proto__: WebInspector.VBox.prototype
 }
 
 /**
@@ -219,17 +51,9 @@ WebInspector.ViewLocation = function() { }
 
 WebInspector.ViewLocation.prototype = {
     /**
-     * @param {!WebInspector.View} view
-     * @param {?WebInspector.View=} insertBefore
-     */
-    appendView: function(view, insertBefore) { },
-
-    /**
-     * @param {!WebInspector.View} view
-     * @param {?WebInspector.View=} insertBefore
-     * @return {!Promise}
+     * @param {string} viewId
      */
-    showView: function(view, insertBefore) { },
+    showView: function(viewId) { },
 
     /**
      * @return {!WebInspector.Widget}
@@ -248,8 +72,6 @@ WebInspector.TabbedViewLocation.prototype = {
      * @return {!WebInspector.TabbedPane}
      */
     tabbedPane: function() { },
-
-    enableMoreTabsButton: function() { }
 }
 
 /**
@@ -262,7 +84,7 @@ WebInspector.ViewLocationResolver.prototype = {
      * @param {string} location
      * @return {?WebInspector.ViewLocation}
      */
-    resolveLocation: function(location) { }
+    revealLocation: function(location) { }
 }
 
 /**
@@ -270,290 +92,91 @@ WebInspector.ViewLocationResolver.prototype = {
  */
 WebInspector.ViewManager = function()
 {
-    /** @type {!Map<string, !WebInspector.View>} */
-    this._views = new Map();
-    /** @type {!Map<string, string>} */
-    this._locationNameByViewId = new Map();
-
-    for (var extension of self.runtime.extensions("view")) {
-        var descriptor = extension.descriptor();
-        this._views.set(descriptor["id"], new WebInspector.ProvidedView(extension));
-        this._locationNameByViewId.set(descriptor["id"], descriptor["location"]);
-    }
 }
 
 WebInspector.ViewManager.prototype = {
     /**
-     * @param {!WebInspector.View} view
-     * @return {!Promise}
-     */
-    revealView: function(view)
-    {
-        var location = /** @type {?WebInspector.ViewManager._Location} */ (view[WebInspector.ViewManager._Location.symbol]);
-        if (!location)
-            return Promise.resolve();
-        location._reveal();
-        return location.showView(view);
-    },
-
-    /**
      * @param {string} viewId
-     * @return {!Promise}
      */
     showView: function(viewId)
     {
-        var view = this._views.get(viewId);
-        if (!view) {
-            console.error("Could not find view for id: '" + viewId + "' " + new Error().stack);
-            return Promise.resolve();
+        var extensions = self.runtime.extensions("view").filter(extension => extension.descriptor()["id"] === viewId);
+        if (!extensions.length) {
+            console.error("Could not find view for id: '" + viewId + "'");
+            return;
         }
-        var locationName = this._locationNameByViewId.get(viewId);
-        if (locationName === "drawer-view")
+        var extension = extensions[0];
+        var location = extensions[0].descriptor()["location"];
+        if (location === "drawer-view")
             WebInspector.userMetrics.drawerShown(viewId);
-
-        return this._resolveLocation(locationName).then(location => {
-            if (!location)
-                return;
-            location._reveal();
-            return location.showView(view);
-        });
-    },
-
-    /**
-     * @param {string=} location
-     * @return {!Promise<?WebInspector.ViewManager._Location>}
-     */
-    _resolveLocation: function(location)
-    {
-        if (!location)
-            return /** @type {!Promise<?WebInspector.ViewManager._Location>} */ (Promise.resolve(null));
-
         var resolverExtensions = self.runtime.extensions(WebInspector.ViewLocationResolver).filter(extension => extension.descriptor()["name"] === location);
         if (!resolverExtensions.length)
-            return /** @type {!Promise<?WebInspector.ViewManager._Location>} */ (Promise.resolve(null));
+            return;
         var resolverExtension = resolverExtensions[0];
-        return resolverExtension.instance().then(resolver => /** @type {?WebInspector.ViewManager._Location} */(resolver.resolveLocation(location)));
+        resolverExtension.instance().then(this._revealLocation.bind(this, viewId, location));
     },
 
     /**
-     * @param {function()=} revealCallback
-     * @param {string=} location
+     * @param {string} location
      * @param {boolean=} restoreSelection
+     * @param {boolean=} enableMoreTabsButton
      * @return {!WebInspector.TabbedViewLocation}
      */
-    createTabbedLocation: function(revealCallback, location, restoreSelection)
+    createTabbedLocation: function(location, restoreSelection, enableMoreTabsButton)
     {
-        return new WebInspector.ViewManager._TabbedLocation(this, revealCallback, location, restoreSelection);
+        return new WebInspector.ViewManager._TabbedLocation(this, location, restoreSelection, enableMoreTabsButton);
     },
 
     /**
-     * @param {function()=} revealCallback
-     * @param {string=} location
-     * @return {!WebInspector.ViewLocation}
+     * @param {string} viewId
+     * @param {string} location
+     * @param {!WebInspector.ViewLocationResolver} resolver
      */
-    createStackLocation: function(revealCallback, location)
+    _revealLocation: function(viewId, location, resolver)
     {
-        return new WebInspector.ViewManager._StackLocation(this, revealCallback, location);
+        var viewLocation = resolver.revealLocation(location);
+        if (viewLocation)
+            viewLocation.showView(viewId);
     },
 
     /**
      * @param {string} location
-     * @return {!Array<!WebInspector.View>}
+     * @return {!Array<!Runtime.Extension>}
      */
     _viewsForLocation: function(location)
     {
-        var result = [];
-        for (var id of this._views.keys()) {
-            if (this._locationNameByViewId.get(id) === location)
-                result.push(this._views.get(id));
-        }
-        return result;
-    }
-}
-
-
-/**
- * @param {!Element} element
- * @param {!Array<!WebInspector.ToolbarItem>} toolbarItems
- */
-WebInspector.ViewManager._populateToolbar = function(element, toolbarItems)
-{
-    if (!toolbarItems.length)
-        return;
-    var toolbar = new WebInspector.Toolbar("");
-    element.insertBefore(toolbar.element, element.firstChild);
-    for (var item of toolbarItems)
-        toolbar.appendToolbarItem(item);
-}
-
-/**
- * @constructor
- * @extends {WebInspector.VBox}
- * @param {!WebInspector.View} view
- */
-WebInspector.ViewManager._ContainerWidget = function(view)
-{
-    WebInspector.VBox.call(this);
-    this.element.classList.add("flex-auto", "view-container", "overflow-auto");
-    this._view = view;
-}
-
-WebInspector.ViewManager._ContainerWidget.prototype = {
-    /**
-     * @return {!Promise}
-     */
-    _materialize: function()
-    {
-        if (this._materializePromise)
-            return this._materializePromise;
-        var promises = [];
-        promises.push(this._view.toolbarItems().then(WebInspector.ViewManager._populateToolbar.bind(WebInspector.ViewManager, this.element)));
-        promises.push(this._view.widget().then(widget => widget.show(this.element)));
-        this._materializePromise = Promise.all(promises);
-        return this._materializePromise;
-    },
-
-    __proto__: WebInspector.VBox.prototype
-}
-
-/**
- * @constructor
- * @extends {WebInspector.VBox}
- * @param {!WebInspector.View} view
- */
-WebInspector.ViewManager._ExpandableContainerWidget = function(view)
-{
-    WebInspector.VBox.call(this, true);
-    this.element.classList.add("flex-none");
-    this.registerRequiredCSS("ui/viewContainers.css");
-
-    this._titleElement = createElementWithClass("div", "expandable-view-title");
-    this._titleElement.textContent = view.title();
-    this._titleElement.tabIndex = 0;
-    this._titleElement.addEventListener("click", this._toggleExpanded.bind(this), false);
-    this._titleElement.addEventListener("keydown", this._onTitleKeyDown.bind(this), false);
-    this.contentElement.insertBefore(this._titleElement, this.contentElement.firstChild);
-
-    this.contentElement.createChild("content");
-    this._view = view;
-    view[WebInspector.ViewManager._ExpandableContainerWidget._symbol] = this;
-}
-
-WebInspector.ViewManager._ExpandableContainerWidget._symbol = Symbol("container");
-
-WebInspector.ViewManager._ExpandableContainerWidget.prototype = {
-    /**
-     * @return {!Promise}
-     */
-    _materialize: function()
-    {
-        if (this._materializePromise)
-            return this._materializePromise;
-        var promises = [];
-        promises.push(this._view.toolbarItems().then(WebInspector.ViewManager._populateToolbar.bind(WebInspector.ViewManager, this._titleElement)));
-        promises.push(this._view.widget().then(widget => {
-            this._widget = widget;
-            widget.show(this.element);
-        }));
-        this._materializePromise = Promise.all(promises);
-        return this._materializePromise;
-    },
-
-    /**
-     * @return {!Promise}
-     */
-    _expand: function()
-    {
-        if (this._titleElement.classList.contains("expanded"))
-            return this._materialize();
-        this._titleElement.classList.add("expanded");
-        return this._materialize().then(() => this._widget.show(this.element));
-    },
-
-    _collapse: function()
-    {
-        if (!this._titleElement.classList.contains("expanded"))
-            return;
-        this._titleElement.classList.remove("expanded");
-        this._materialize().then(() => this._widget.detach());
-    },
-
-    _toggleExpanded: function()
-    {
-        if (this._titleElement.classList.contains("expanded"))
-            this._collapse();
-        else
-            this._expand();
-    },
-
-    /**
-     * @param {!Event} event
-     */
-    _onTitleKeyDown: function(event)
-    {
-        if (isEnterKey(event) || event.keyCode === WebInspector.KeyboardShortcut.Keys.Space.code)
-            this._toggleExpanded();
-    },
-
-    __proto__: WebInspector.VBox.prototype
-}
-
-/**
- * @constructor
- * @param {!WebInspector.ViewManager} manager
- * @param {!WebInspector.Widget} widget
- * @param {function()=} revealCallback
- * @param {string=} location
- */
-WebInspector.ViewManager._Location = function(manager, widget, revealCallback, location)
-{
-    this._manager = manager;
-    this._revealCallback = revealCallback;
-    this._location = location;
-    this._widget = widget;
-}
-
-WebInspector.ViewManager._Location.symbol = Symbol("location");
-
-WebInspector.ViewManager._Location.prototype = {
-    /**
-     * @return {!WebInspector.Widget}
-     */
-    widget: function()
-    {
-        return this._widget;
-    },
-
-    _reveal: function()
-    {
-        if (this._revealCallback)
-            this._revealCallback();
+        return self.runtime.extensions("view").filter(extension => extension.descriptor()["location"] === location);
     }
 }
 
 /**
  * @constructor
- * @extends {WebInspector.ViewManager._Location}
  * @implements {WebInspector.TabbedViewLocation}
  * @param {!WebInspector.ViewManager} manager
- * @param {function()=} revealCallback
- * @param {string=} location
+ * @param {string} location
  * @param {boolean=} restoreSelection
+ * @param {boolean=} enableMoreTabsButton
  */
-WebInspector.ViewManager._TabbedLocation = function(manager, revealCallback, location, restoreSelection)
+WebInspector.ViewManager._TabbedLocation = function(manager, location, restoreSelection, enableMoreTabsButton)
 {
+    this._manager = manager;
     this._tabbedPane = new WebInspector.TabbedPane();
-    WebInspector.ViewManager._Location.call(this, manager, this._tabbedPane, revealCallback, location);
+    this._location = location;
+    /** @type {!Object.<string, !Promise.<?WebInspector.Widget>>} */
+    this._promiseForId = {};
 
     this._tabbedPane.addEventListener(WebInspector.TabbedPane.EventTypes.TabSelected, this._tabSelected, this);
     this._tabbedPane.addEventListener(WebInspector.TabbedPane.EventTypes.TabClosed, this._tabClosed, this);
     this._closeableTabSetting = WebInspector.settings.createSetting(location + "-closeableTabs", {});
     if (restoreSelection)
         this._lastSelectedTabSetting = WebInspector.settings.createSetting(location + "-selectedTab", "");
-
-    /** @type {!Map.<string, !WebInspector.View>} */
-    this._views = new Map();
-    this._populateLocation();
+    this._initialize();
+    if (enableMoreTabsButton) {
+        var toolbar = new WebInspector.Toolbar("drawer-toolbar");
+        toolbar.appendToolbarItem(new WebInspector.ToolbarMenuButton(this._appendTabsToMenu.bind(this)));
+        this._tabbedPane.insertBeforeTabStrip(toolbar.element);
+        this._tabbedPane.disableOverflowMenu();
+    }
 }
 
 WebInspector.ViewManager._TabbedLocation.prototype = {
@@ -575,31 +198,19 @@ WebInspector.ViewManager._TabbedLocation.prototype = {
         return this._tabbedPane;
     },
 
-    /**
-     * @override
-     */
-    enableMoreTabsButton: function()
+    _initialize: function()
     {
-        var toolbar = new WebInspector.Toolbar("drawer-toolbar");
-        toolbar.appendToolbarItem(new WebInspector.ToolbarMenuButton(this._appendTabsToMenu.bind(this)));
-        this._tabbedPane.insertBeforeTabStrip(toolbar.element);
-        this._tabbedPane.disableOverflowMenu();
-    },
+        /** @type {!Map.<string, !Runtime.Extension>} */
+        this._extensions = new Map();
+        var extensions = this._manager._viewsForLocation(this._location);
 
-    _populateLocation: function()
-    {
-        if (!this._location)
-            return;
-        for (var view of this._manager._viewsForLocation(this._location)) {
-            var id = view.viewId();
-            this._views.set(id, view);
-            view[WebInspector.ViewManager._Location.symbol] = this;
-            if (view.isTransient())
-                continue;
-            if (!view.isCloseable())
-                this._appendTab(view);
-            else if (this._closeableTabSetting.get()[id])
-                this._appendTab(view);
+        for (var i = 0; i < extensions.length; ++i) {
+            var id = extensions[i].descriptor()["id"];
+            this._extensions.set(id, extensions[i]);
+            if (this._isPermanentTab(id))
+                this._appendTab(extensions[i]);
+            else if (this._isCloseableTab(id) && this._closeableTabSetting.get()[id])
+                this._appendTab(extensions[i]);
         }
     },
 
@@ -613,52 +224,59 @@ WebInspector.ViewManager._TabbedLocation.prototype = {
     },
 
     /**
-     * @param {!WebInspector.ContextMenu} contextMenu
+     * @param {string} id
+     * @return {boolean}
      */
-    _appendTabsToMenu: function(contextMenu)
+    _isPermanentTab: function(id)
     {
-        for (var view of this._views.values()) {
-            var title = WebInspector.UIString(view.title());
-            contextMenu.appendItem(title, this.showView.bind(this, view));
-        }
+        return this._extensions.get(id).descriptor()["persistence"] === "permanent" || !this._extensions.get(id).descriptor()["persistence"];
     },
 
     /**
-     * @param {!WebInspector.View} view
+     * @param {string} id
+     * @return {boolean}
      */
-    _appendTab: function(view)
+    _isCloseableTab: function(id)
     {
-        this._tabbedPane.appendTab(view.viewId(), view.title(), new WebInspector.ViewManager._ContainerWidget(view), undefined, false, view.isCloseable() || view.isTransient());
+        return this._extensions.get(id).descriptor()["persistence"] === "closeable";
     },
 
     /**
-     * @override
-     * @param {!WebInspector.View} view
-     * @param {?WebInspector.View=} insertBefore
+     * @param {!WebInspector.ContextMenu} contextMenu
      */
-    appendView: function(view, insertBefore)
+    _appendTabsToMenu: function(contextMenu)
     {
-        if (insertBefore)
-            throw new Error("Insert before in tabbed pane is not supported");
-        if (!this._tabbedPane.hasTab(view.viewId())) {
-            view[WebInspector.ViewManager._Location.symbol] = this;
-            this._views.set(view.viewId(), view);
-            this._appendTab(view);
+        var extensions = self.runtime.extensions("view", undefined, true);
+        for (var extension of extensions) {
+            if (extension.descriptor()["location"] !== this._location)
+                continue;
+            var title = WebInspector.UIString(extension.title());
+            contextMenu.appendItem(title, this.showView.bind(this, extension.descriptor()["id"]));
         }
     },
 
     /**
+     * @param {!Runtime.Extension} extension
+     */
+    _appendTab: function(extension)
+    {
+        var descriptor = extension.descriptor();
+        var id = descriptor["id"];
+        var title = WebInspector.UIString(extension.title());
+        var closeable = descriptor["persistence"] === "closeable" || descriptor["persistence"] === "temporary";
+        this._tabbedPane.appendTab(id, title, new WebInspector.Widget(), undefined, false, closeable);
+    },
+
+    /**
      * @override
-     * @param {!WebInspector.View} view
-     * @param {?WebInspector.View=} insertBefore
-     * @return {!Promise}
+     * @param {string} id
      */
-    showView: function(view, insertBefore)
+    showView: function(id)
     {
-        this.appendView(view, insertBefore);
+        if (!this._tabbedPane.hasTab(id))
+            this._appendTab(/** @type {!Runtime.Extension} */(this._extensions.get(id)));
         this._tabbedPane.focus();
-        this._tabbedPane.selectTab(view.viewId());
-        return this._materializeWidget(view);
+        this._tabbedPane.selectTab(id);
     },
 
     /**
@@ -669,13 +287,13 @@ WebInspector.ViewManager._TabbedLocation.prototype = {
         var tabId = /** @type {string} */ (event.data.tabId);
         if (this._lastSelectedTabSetting && event.data["isUserGesture"])
             this._lastSelectedTabSetting.set(tabId);
-        var view = this._views.get(tabId);
-        if (!view)
+        if (!this._extensions.has(tabId))
             return;
 
-        this._materializeWidget(view);
+        this._viewForId(tabId);
 
-        if (view.isCloseable()) {
+        var descriptor = this._extensions.get(tabId).descriptor();
+        if (descriptor["persistence"] === "closeable") {
             var tabs = this._closeableTabSetting.get();
             if (!tabs[tabId]) {
                 tabs[tabId] = true;
@@ -695,87 +313,33 @@ WebInspector.ViewManager._TabbedLocation.prototype = {
             delete tabs[id];
             this._closeableTabSetting.set(tabs);
         }
+        delete this._promiseForId[id];
     },
 
     /**
-     * @param {!WebInspector.View} view
-     * @return {!Promise}
+     * @param {string} id
+     * @return {!Promise.<?WebInspector.Widget>}
      */
-    _materializeWidget: function(view)
+    _viewForId: function(id)
     {
-        var widget = /** @type {!WebInspector.ViewManager._ContainerWidget} */ (this._tabbedPane.tabView(view.viewId()));
-        return widget._materialize();
-    },
+        if (this._promiseForId[id])
+            return this._promiseForId[id];
 
-    __proto__: WebInspector.ViewManager._Location.prototype
-}
+        var promise = this._extensions.get(id).instance();
+        this._promiseForId[id] = /** @type {!Promise.<?WebInspector.Widget>} */ (promise);
+        return promise.then(cacheView.bind(this));
 
-/**
- * @constructor
- * @extends {WebInspector.ViewManager._Location}
- * @implements {WebInspector.ViewLocation}
- * @param {!WebInspector.ViewManager} manager
- * @param {function()=} revealCallback
- * @param {string=} location
- */
-WebInspector.ViewManager._StackLocation = function(manager, revealCallback, location)
-{
-    this._vbox = new WebInspector.VBox();
-    WebInspector.ViewManager._Location.call(this, manager, this._vbox, revealCallback, location);
-
-    /** @type {!Map<string, !WebInspector.ViewManager._ExpandableContainerWidget>} */
-    this._expandableContainers = new Map();
-    this._populateLocation();
-}
-
-WebInspector.ViewManager._StackLocation.prototype = {
-
-    /**
-     * @override
-     * @param {!WebInspector.View} view
-     * @param {?WebInspector.View=} insertBefore
-     */
-    appendView: function(view, insertBefore)
-    {
-        var container = this._expandableContainers.get(view.viewId());
-        if (!container) {
-            view[WebInspector.ViewManager._Location.symbol] = this;
-            container = new WebInspector.ViewManager._ExpandableContainerWidget(view);
-            var beforeElement = null;
-            if (insertBefore) {
-                var beforeContainer = insertBefore[WebInspector.ViewManager._ExpandableContainerWidget._symbol];
-                beforeElement = beforeContainer ? beforeContainer.element : null;
-            }
-            container.show(this._vbox.contentElement, beforeElement);
-            this._expandableContainers.set(view.viewId(), container);
+        /**
+         * @param {!Object} object
+         * @this {WebInspector.ViewManager._TabbedLocation}
+         */
+        function cacheView(object)
+        {
+            var view = /** @type {!WebInspector.Widget} */ (object);
+            this._tabbedPane.changeTabView(id, view);
+            return view;
         }
-    },
-
-    /**
-     * @override
-     * @param {!WebInspector.View} view
-     * @param {?WebInspector.View=} insertBefore
-     * @return {!Promise}
-     */
-    showView: function(view, insertBefore)
-    {
-        this.appendView(view, insertBefore);
-        var container = this._expandableContainers.get(view.viewId());
-        return container._expand();
-    },
-
-    _populateLocation: function()
-    {
-        if (!this._location)
-            return;
-        for (var view of this._manager._viewsForLocation(this._location))
-            this.appendView(view);
-    },
-
-    __proto__: WebInspector.ViewManager._Location.prototype
+    }
 }
 
-/**
- * @type {!WebInspector.ViewManager}
- */
-WebInspector.viewManager;
+WebInspector.viewManager = new WebInspector.ViewManager();
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/ViewContainers.js b/third_party/WebKit/Source/devtools/front_end/ui/ViewContainers.js
new file mode 100644
index 0000000..df45b20
--- /dev/null
+++ b/third_party/WebKit/Source/devtools/front_end/ui/ViewContainers.js
@@ -0,0 +1,225 @@
+// Copyright 2015 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+/**
+ * @constructor
+ * @extends {WebInspector.VBox}
+ * @param {!WebInspector.View} view
+ */
+WebInspector.View._ContainerWidget = function(view)
+{
+    WebInspector.VBox.call(this);
+    this.element.classList.add("flex-auto", "view-container", "overflow-auto");
+
+    var toolbarItems = view.toolbarItems();
+    if (toolbarItems.length) {
+        var toolbar = new WebInspector.Toolbar("", this.element);
+        for (var item of toolbarItems)
+            toolbar.appendToolbarItem(item);
+    }
+
+    view.show(this.element);
+}
+
+WebInspector.View._ContainerWidget.prototype = {
+    __proto__: WebInspector.VBox.prototype
+}
+
+/**
+ * @constructor
+ * @extends {WebInspector.VBox}
+ * @param {!WebInspector.View} view
+ * @param {boolean} expanded
+ */
+WebInspector.View._ExpandableContainerWidget = function(view, expanded)
+{
+    WebInspector.VBox.call(this, true);
+    this.element.classList.add("flex-none");
+    this.registerRequiredCSS("ui/viewContainers.css");
+
+    this._titleElement = createElementWithClass("div", "expandable-view-title");
+    this._titleElement.textContent = view.title();
+    this._titleElement.tabIndex = 0;
+    this._titleElement.addEventListener("click", this._toggleExpanded.bind(this), false);
+    this._titleElement.addEventListener("keydown", this._onTitleKeyDown.bind(this), false);
+    this.contentElement.insertBefore(this._titleElement, this.contentElement.firstChild);
+
+    var toolbarElement = this.contentElement.createChild("div");
+    var toolbarItems = view.toolbarItems();
+    if (toolbarItems.length) {
+        this._toolbar = new WebInspector.Toolbar("");
+        for (var item of toolbarItems)
+            this._toolbar.appendToolbarItem(item);
+    }
+
+    this.contentElement.createChild("content");
+    this._view = view;
+    this._view.attach(this);
+    this._view[WebInspector.View._ExpandableContainerWidget._elementSymbol] = this.element;
+    if (expanded)
+        this.revealChild(this._view);
+}
+
+WebInspector.View._ExpandableContainerWidget._elementSymbol = Symbol("container-widget-element");
+
+WebInspector.View._ExpandableContainerWidget.prototype = {
+    /**
+     * @override
+     * @param {!WebInspector.Widget} child
+     * @return {boolean}
+     */
+    revealChild: function(child)
+    {
+        if (this._titleElement.classList.contains("expanded"))
+            return true;
+        if (this._toolbar)
+            this._titleElement.appendChild(this._toolbar.element);
+        this._titleElement.classList.add("expanded");
+        this._view.showWidget(this.element);
+        return true;
+    },
+
+    _collapse: function()
+    {
+        if (!this._titleElement.classList.contains("expanded"))
+            return;
+        if (this._toolbar)
+            this._toolbar.element.remove();
+        this._titleElement.classList.remove("expanded");
+        this._view.hideWidget();
+    },
+
+    _toggleExpanded: function()
+    {
+        if (this._titleElement.classList.contains("expanded"))
+            this._collapse();
+        else
+            this.revealChild(this._view);
+    },
+
+    /**
+     * @param {!Event} event
+     */
+    _onTitleKeyDown: function(event)
+    {
+        if (isEnterKey(event) || event.keyCode === WebInspector.KeyboardShortcut.Keys.Space.code)
+            this._toggleExpanded();
+    },
+
+    /**
+     * @param {!WebInspector.Widget} widget
+     * @override
+     */
+    childWasDetached: function(widget)
+    {
+        WebInspector.VBox.prototype.childWasDetached.call(this, widget);
+        delete this._view[WebInspector.View._ExpandableContainerWidget._elementSymbol];
+    },
+
+    __proto__: WebInspector.VBox.prototype
+}
+
+/**
+ * @interface {WebInspector.TabbedPane}
+ */
+WebInspector.View.Container = function()
+{
+}
+
+WebInspector.View.Container.prototype = {
+    /**
+     * @param {!WebInspector.View} view
+     * @param {boolean=} reveal
+     */
+    appendView: function(view, reveal) { },
+
+    /**
+     * @param {!WebInspector.View} view
+     * @param {?WebInspector.View} insertBefore
+     * @param {boolean=} reveal
+     */
+    insertViewBefore: function(view, insertBefore, reveal) { }
+}
+
+/**
+ * @constructor
+ * @extends {WebInspector.TabbedPane}
+ * @implements {WebInspector.View.Container}
+ */
+WebInspector.View.TabbedPaneContainer = function()
+{
+    WebInspector.TabbedPane.call(this);
+}
+
+WebInspector.View.TabbedPaneContainer.prototype = {
+    /**
+     * @param {!WebInspector.View} view
+     * @param {boolean=} reveal
+     * @override
+     */
+    appendView: function(view, reveal)
+    {
+        this.insertViewBefore(view, null, reveal);
+    },
+
+    /**
+     * @param {!WebInspector.View} view
+     * @param {?WebInspector.View} insertBefore
+     * @param {boolean=} reveal
+     * @override
+     */
+    insertViewBefore: function(view, insertBefore, reveal)
+    {
+        var widgets = this.tabViews();
+        var index = 0;
+        for (var i = 0; insertBefore && i < widgets.length; ++i) {
+            if (widgets[i]._view === insertBefore) {
+                index = i;
+                break;
+            }
+        }
+        this.appendTab(view.title(), view.title(), new WebInspector.View._ContainerWidget(view), undefined, false, false, insertBefore ? index : undefined);
+        if (reveal)
+            this.selectTab(view.title());
+    },
+
+    __proto__: WebInspector.TabbedPane.prototype
+}
+
+/**
+ * @constructor
+ * @extends {WebInspector.VBox}
+ * @implements {WebInspector.View.Container}
+ */
+WebInspector.View.ExpandableStackContainer = function()
+{
+    WebInspector.VBox.call(this);
+    this.element.classList.add("flex-auto", "overflow-auto");
+}
+
+WebInspector.View.ExpandableStackContainer.prototype = {
+
+    /**
+     * @param {!WebInspector.View} view
+     * @param {boolean=} reveal
+     * @override
+     */
+    appendView: function(view, reveal)
+    {
+        this.insertViewBefore(view, null, reveal);
+    },
+
+    /**
+     * @param {!WebInspector.View} view
+     * @param {?WebInspector.View} insertBefore
+     * @param {boolean=} reveal
+     * @override
+     */
+    insertViewBefore: function(view, insertBefore, reveal)
+    {
+        new WebInspector.View._ExpandableContainerWidget(view, reveal || false).show(this.contentElement, insertBefore ? insertBefore[WebInspector.View._ExpandableContainerWidget._elementSymbol] : null);
+    },
+
+    __proto__: WebInspector.VBox.prototype
+}
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/Widget.js b/third_party/WebKit/Source/devtools/front_end/ui/Widget.js
index 8b6954c..5be8034 100644
--- a/third_party/WebKit/Source/devtools/front_end/ui/Widget.js
+++ b/third_party/WebKit/Source/devtools/front_end/ui/Widget.js
@@ -555,6 +555,25 @@ WebInspector.Widget.prototype = {
             this._parentWidget.doLayout();
     },
 
+    /**
+     * @return {boolean}
+     */
+    revealWidget: function()
+    {
+        if (!this._parentWidget)
+            return this._isRoot;
+        if (!this._parentWidget.revealChild(this))
+            return false;
+        return this._parentWidget.revealWidget();
+    },
+
+    /**
+     * @param {!WebInspector.Widget} widget
+     * @return {boolean}
+     * @protected
+     */
+    revealChild: function(widget) { return true; },
+
     __proto__: WebInspector.Object.prototype
 }
 
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/module.json b/third_party/WebKit/Source/devtools/front_end/ui/module.json
index 54ac23f..ae85e8b 100644
--- a/third_party/WebKit/Source/devtools/front_end/ui/module.json
+++ b/third_party/WebKit/Source/devtools/front_end/ui/module.json
@@ -46,6 +46,7 @@
         "SuggestBox.js",
         "TabbedPane.js",
         "UIUtils.js",
+        "ViewContainers.js",
         "ViewportControl.js",
         "ZoomManager.js"
     ],
diff --git a/third_party/WebKit/Source/devtools/front_end/ui/viewContainers.css b/third_party/WebKit/Source/devtools/front_end/ui/viewContainers.css
index a0a5956..dc2fe7e 100644
--- a/third_party/WebKit/Source/devtools/front_end/ui/viewContainers.css
+++ b/third_party/WebKit/Source/devtools/front_end/ui/viewContainers.css
@@ -49,10 +49,6 @@
     border-bottom: 1px solid #ddd;
 }
 
-.expandable-view-title:not(.expanded) .toolbar {
-    display: none;
-}
-
 .expandable-view-title::before {
     -webkit-mask-image: url(Images/toolbarButtonGlyphs.png);
     -webkit-mask-size: 352px 168px;
diff --git a/third_party/WebKit/Source/devtools/scripts/compile_frontend.py b/third_party/WebKit/Source/devtools/scripts/compile_frontend.py
index 449ff3b..1771965 100755
--- a/third_party/WebKit/Source/devtools/scripts/compile_frontend.py
+++ b/third_party/WebKit/Source/devtools/scripts/compile_frontend.py
@@ -87,8 +87,8 @@ runtime_module_name = '_runtime'
 type_checked_jsdoc_tags_list = ['param', 'return', 'type', 'enum']
 type_checked_jsdoc_tags_or = '|'.join(type_checked_jsdoc_tags_list)
 
-# Basic regex for invalid JsDoc types: an object type name ([A-Z][_A-Za-z0-9.]+[A-Za-z0-9]) not preceded by '!', '?', ':' (this, new), or '.' (object property).
-invalid_type_regex = re.compile(r'@(?:' + type_checked_jsdoc_tags_or + r')\s*\{.*(?<![!?:._A-Za-z0-9])([A-Z][_A-Za-z0-9.]+[A-Za-z0-9])[^/]*\}')
+# Basic regex for invalid JsDoc types: an object type name ([A-Z][A-Za-z0-9.]+[A-Za-z0-9]) not preceded by '!', '?', ':' (this, new), or '.' (object property).
+invalid_type_regex = re.compile(r'@(?:' + type_checked_jsdoc_tags_or + r')\s*\{.*(?<![!?:.A-Za-z0-9])([A-Z][A-Za-z0-9.]+[A-Za-z0-9])[^/]*\}')
 invalid_type_designator_regex = re.compile(r'@(?:' + type_checked_jsdoc_tags_or + r')\s*.*(?<![{: ])([?!])=?\}')
 invalid_non_object_type_regex = re.compile(r'@(?:' + type_checked_jsdoc_tags_or + r')\s*\{.*(![a-z]+)[^/]*\}')
 error_warning_regex = re.compile(r'WARNING|ERROR')
diff --git a/third_party/WebKit/Source/devtools/scripts/generate_supported_css.py b/third_party/WebKit/Source/devtools/scripts/generate_supported_css.py
index a1c25e5..f035415 100755
--- a/third_party/WebKit/Source/devtools/scripts/generate_supported_css.py
+++ b/third_party/WebKit/Source/devtools/scripts/generate_supported_css.py
@@ -33,7 +33,7 @@ except ImportError:
     import json
 
 import sys
-import re
+
 
 def properties_from_file(file_name):
     properties = []
@@ -43,12 +43,8 @@ def properties_from_file(file_name):
             line = line.strip()
             if not line or line.startswith("//") or "alias_for" in line:
                 continue
-            partition = re.split("[, ]", line)
-            name = partition[0]
-            attributes = partition[1:]
+            name = line.partition(" ")[0]
             entry = {"name": name}
-            if "inherited" in attributes:
-                entry["inherited"] = True
             propertyNames.add(name)
             longhands = line.partition("longhands=")[2].partition(",")[0]
             if longhands:
diff --git a/third_party/WebKit/Source/modules/bluetooth/Bluetooth.cpp b/third_party/WebKit/Source/modules/bluetooth/Bluetooth.cpp
index 912ea0e..d7cbeec 100644
--- a/third_party/WebKit/Source/modules/bluetooth/Bluetooth.cpp
+++ b/third_party/WebKit/Source/modules/bluetooth/Bluetooth.cpp
@@ -9,9 +9,6 @@
 #include "bindings/core/v8/ScriptPromiseResolver.h"
 #include "core/dom/DOMException.h"
 #include "core/dom/ExceptionCode.h"
-#include "core/inspector/ConsoleMessage.h"
-#include "core/origin_trials/OriginTrialContext.h"
-#include "core/origin_trials/OriginTrials.h"
 #include "modules/bluetooth/BluetoothDevice.h"
 #include "modules/bluetooth/BluetoothError.h"
 #include "modules/bluetooth/BluetoothSupplement.h"
@@ -133,6 +130,7 @@ static void convertRequestDeviceOptions(const RequestDeviceOptions& options, Web
 // https://webbluetoothchrome.github.io/web-bluetooth/#dom-bluetooth-requestdevice
 ScriptPromise Bluetooth::requestDevice(ScriptState* scriptState, const RequestDeviceOptions& options, ExceptionState& exceptionState)
 {
+
     // By adding the "OriginTrialEnabled" extended binding, we enable the
     // requestDevice function on all platforms for websites that contain an
     // origin trial token. Since we only support Chrome OS, Android and MacOS
@@ -144,24 +142,9 @@ ScriptPromise Bluetooth::requestDevice(ScriptState* scriptState, const RequestDe
     }
 #endif
 
-    // Promote use of Origin Trials
-    // * When not being run on an origin trial.
-    // * Only once for the lifetime of this Bluetooth object, to avoid being
-    //   a nuisance and too verbose in the console. Reloading a page will reset
-    //   and the message can be shown again.
-    ExecutionContext* context = scriptState->getExecutionContext();
-    OriginTrialContext* originTrials = OriginTrialContext::from(context, OriginTrialContext::DontCreateIfNotExists);
-    bool originTrialActiveForThisPage = originTrials && originTrials->isFeatureEnabled("WebBluetooth");
-
-    if (!originTrialActiveForThisPage && !promotedOriginTrial) {
-        promotedOriginTrial = true;
-        context->addConsoleMessage(ConsoleMessage::create(JSMessageSource, InfoMessageLevel,
-            "Web Bluetooth is available as an Origin Trial: https://bit.ly/WebBluetoothOriginTrial"));
-    }
-
     // 1. If the incumbent settings object is not a secure context, reject promise with a SecurityError and abort these steps.
     String errorMessage;
-    if (!context->isSecureContext(errorMessage)) {
+    if (!scriptState->getExecutionContext()->isSecureContext(errorMessage)) {
         return ScriptPromise::rejectWithDOMException(scriptState, DOMException::create(SecurityError, errorMessage));
     }
 
diff --git a/third_party/WebKit/Source/modules/bluetooth/Bluetooth.h b/third_party/WebKit/Source/modules/bluetooth/Bluetooth.h
index 2b7fc39..6805e2d 100644
--- a/third_party/WebKit/Source/modules/bluetooth/Bluetooth.h
+++ b/third_party/WebKit/Source/modules/bluetooth/Bluetooth.h
@@ -31,8 +31,6 @@ public:
 
     DEFINE_INLINE_TRACE() { }
 
-private:
-    bool promotedOriginTrial = false;
 };
 
 } // namespace blink
diff --git a/third_party/WebKit/Source/modules/bluetooth/BluetoothRemoteGATTCharacteristic.cpp b/third_party/WebKit/Source/modules/bluetooth/BluetoothRemoteGATTCharacteristic.cpp
index 75bbed0..b0ec4cd 100644
--- a/third_party/WebKit/Source/modules/bluetooth/BluetoothRemoteGATTCharacteristic.cpp
+++ b/third_party/WebKit/Source/modules/bluetooth/BluetoothRemoteGATTCharacteristic.cpp
@@ -195,36 +195,12 @@ ScriptPromise BluetoothRemoteGATTCharacteristic::writeValue(ScriptState* scriptS
     return promise;
 }
 
-class NotificationsCallback : public WebBluetoothNotificationsCallbacks {
-public:
-    NotificationsCallback(BluetoothRemoteGATTCharacteristic* characteristic, ScriptPromiseResolver* resolver) : m_webCharacteristic(characteristic), m_resolver(resolver) {}
-
-    void onSuccess() override
-    {
-        if (!m_resolver->getExecutionContext() || m_resolver->getExecutionContext()->activeDOMObjectsAreStopped())
-            return;
-
-        m_resolver->resolve(m_webCharacteristic);
-    }
-
-    void onError(int32_t error /* Corresponds to WebBluetoothError in web_bluetooth.mojom */) override
-    {
-        if (!m_resolver->getExecutionContext() || m_resolver->getExecutionContext()->activeDOMObjectsAreStopped())
-            return;
-        m_resolver->reject(BluetoothError::take(m_resolver, error));
-    }
-
-private:
-    Persistent<BluetoothRemoteGATTCharacteristic> m_webCharacteristic;
-    Persistent<ScriptPromiseResolver> m_resolver;
-};
-
 ScriptPromise BluetoothRemoteGATTCharacteristic::startNotifications(ScriptState* scriptState)
 {
     WebBluetooth* webbluetooth = BluetoothSupplement::fromScriptState(scriptState);
     ScriptPromiseResolver* resolver = ScriptPromiseResolver::create(scriptState);
     ScriptPromise promise = resolver->promise();
-    webbluetooth->startNotifications(m_webCharacteristic->characteristicInstanceID, new NotificationsCallback(this, resolver));
+    webbluetooth->startNotifications(m_webCharacteristic->characteristicInstanceID, new CallbackPromiseAdapter<void, BluetoothError>(resolver));
     return promise;
 }
 
@@ -241,7 +217,7 @@ ScriptPromise BluetoothRemoteGATTCharacteristic::stopNotifications(ScriptState*
     WebBluetooth* webbluetooth = BluetoothSupplement::fromScriptState(scriptState);
     ScriptPromiseResolver* resolver = ScriptPromiseResolver::create(scriptState);
     ScriptPromise promise = resolver->promise();
-    webbluetooth->stopNotifications(m_webCharacteristic->characteristicInstanceID, new NotificationsCallback(this, resolver));
+    webbluetooth->stopNotifications(m_webCharacteristic->characteristicInstanceID, new CallbackPromiseAdapter<void, BluetoothError>(resolver));
     return promise;
 }
 
diff --git a/third_party/WebKit/Source/modules/bluetooth/BluetoothRemoteGATTCharacteristic.idl b/third_party/WebKit/Source/modules/bluetooth/BluetoothRemoteGATTCharacteristic.idl
index 63a92ce..a47a50e 100644
--- a/third_party/WebKit/Source/modules/bluetooth/BluetoothRemoteGATTCharacteristic.idl
+++ b/third_party/WebKit/Source/modules/bluetooth/BluetoothRemoteGATTCharacteristic.idl
@@ -16,10 +16,10 @@
     readonly attribute DataView?                         value;
     // Promise<BluetoothRemoteGATTDescriptor>           getDescriptor(BluetoothDescriptorUUID descriptor);
     // Promise<sequence<BluetoothRemoteGATTDescriptor>> getDescriptors(optional BluetoothDescriptorUUID descriptor);
-    [CallWith=ScriptState] Promise<DataView>                          readValue();
-    [CallWith=ScriptState] Promise<void>                              writeValue(BufferSource value);
-    [CallWith=ScriptState] Promise<BluetoothRemoteGATTCharacteristic> startNotifications();
-    [CallWith=ScriptState] Promise<BluetoothRemoteGATTCharacteristic> stopNotifications();
+    [CallWith=ScriptState] Promise<DataView>    readValue();
+    [CallWith=ScriptState] Promise<void>        writeValue(BufferSource value);
+    [CallWith=ScriptState] Promise<void>        startNotifications();
+    [CallWith=ScriptState] Promise<void>        stopNotifications();
 
     // TODO(ortuno): Move this to CharacteristicEventHandlers.
     // http://crbug.com/537459
diff --git a/third_party/WebKit/Source/modules/crypto/SubtleCrypto.cpp b/third_party/WebKit/Source/modules/crypto/SubtleCrypto.cpp
index bf8704d..0bba452 100644
--- a/third_party/WebKit/Source/modules/crypto/SubtleCrypto.cpp
+++ b/third_party/WebKit/Source/modules/crypto/SubtleCrypto.cpp
@@ -80,10 +80,10 @@ static bool copySequenceOfStringProperty(const char* property, const Dictionary&
     Vector<String> value;
     if (!DictionaryHelper::get(source, property, value))
         return false;
-    std::unique_ptr<JSONArray> jsonArray = JSONArray::create();
+    RefPtr<JSONArray> jsonArray = JSONArray::create();
     for (unsigned i = 0; i < value.size(); ++i)
         jsonArray->pushString(value[i]);
-    destination->setArray(property, std::move(jsonArray));
+    destination->setArray(property, jsonArray.release());
     return true;
 }
 
@@ -133,7 +133,7 @@ static bool parseJsonWebKey(const Dictionary& dict, WebVector<uint8_t>& jsonUtf8
     //  * Parse "oth" (crbug.com/441396)
     //  * Fail with TypeError (not DataError) if the input does not conform
     //    to a JsonWebKey
-    std::unique_ptr<JSONObject> jsonObject = JSONObject::create();
+    RefPtr<JSONObject> jsonObject = JSONObject::create();
 
     if (!copyStringProperty("kty", dict, jsonObject.get())) {
         result->completeWithError(WebCryptoErrorTypeData, "The required JWK member \"kty\" was missing");
diff --git a/third_party/WebKit/Source/modules/filesystem/DevToolsHostFileSystem.cpp b/third_party/WebKit/Source/modules/filesystem/DevToolsHostFileSystem.cpp
index b875cef..7b6a271 100644
--- a/third_party/WebKit/Source/modules/filesystem/DevToolsHostFileSystem.cpp
+++ b/third_party/WebKit/Source/modules/filesystem/DevToolsHostFileSystem.cpp
@@ -21,12 +21,12 @@ DOMFileSystem* DevToolsHostFileSystem::isolatedFileSystem(DevToolsHost& host, co
 
 void DevToolsHostFileSystem::upgradeDraggedFileSystemPermissions(DevToolsHost& host, DOMFileSystem* domFileSystem)
 {
-    std::unique_ptr<JSONObject> message = JSONObject::create();
-    message->setInteger("id", 0);
+    RefPtr<JSONObject> message = JSONObject::create();
+    message->setNumber("id", 0);
     message->setString("method", "upgradeDraggedFileSystemPermissions");
-    std::unique_ptr<JSONArray> params = JSONArray::create();
+    RefPtr<JSONArray> params = JSONArray::create();
+    message->setArray("params", params);
     params->pushString(domFileSystem->rootURL().getString());
-    message->setArray("params", std::move(params));
     host.sendMessageToEmbedder(message->toJSONString());
 }
 
diff --git a/third_party/WebKit/Source/modules/indexeddb/IndexedDBNames.in b/third_party/WebKit/Source/modules/indexeddb/IndexedDBNames.in
index 71a601c..39a9f00 100644
--- a/third_party/WebKit/Source/modules/indexeddb/IndexedDBNames.in
+++ b/third_party/WebKit/Source/modules/indexeddb/IndexedDBNames.in
@@ -1,7 +1,5 @@
 namespace="IndexedDB"
 
-IndexedDB
-
 # http://www.w3.org/TR/IndexedDB/#idl-def-IDBCursorDirection
 next
 nextunique
diff --git a/third_party/WebKit/Source/modules/indexeddb/WebIDBCallbacksImpl.cpp b/third_party/WebKit/Source/modules/indexeddb/WebIDBCallbacksImpl.cpp
index f8a3fa4..abecd34 100644
--- a/third_party/WebKit/Source/modules/indexeddb/WebIDBCallbacksImpl.cpp
+++ b/third_party/WebKit/Source/modules/indexeddb/WebIDBCallbacksImpl.cpp
@@ -30,7 +30,6 @@
 
 #include "core/dom/DOMException.h"
 #include "core/inspector/InspectorInstrumentation.h"
-#include "modules/IndexedDBNames.h"
 #include "modules/indexeddb/IDBMetadata.h"
 #include "modules/indexeddb/IDBRequest.h"
 #include "modules/indexeddb/IDBValue.h"
@@ -63,7 +62,7 @@ std::unique_ptr<WebIDBCallbacksImpl> WebIDBCallbacksImpl::create(IDBRequest* req
 WebIDBCallbacksImpl::WebIDBCallbacksImpl(IDBRequest* request)
     : m_request(request)
 {
-    InspectorInstrumentation::asyncTaskScheduled(m_request->getExecutionContext(), IndexedDBNames::IndexedDB, this, true);
+    InspectorInstrumentation::asyncTaskScheduled(m_request->getExecutionContext(), "IndexedDB", this, true);
 }
 
 WebIDBCallbacksImpl::~WebIDBCallbacksImpl()
diff --git a/third_party/WebKit/Source/modules/nfc/NFC.cpp b/third_party/WebKit/Source/modules/nfc/NFC.cpp
index 21c26c1..5ddc7ec 100644
--- a/third_party/WebKit/Source/modules/nfc/NFC.cpp
+++ b/third_party/WebKit/Source/modules/nfc/NFC.cpp
@@ -178,7 +178,7 @@ struct TypeConverter<mojo::WTFArray<uint8_t>, blink::ScriptValue> {
         }
 
         if (value->IsObject() && !value->IsArrayBuffer()) {
-            std::unique_ptr<blink::JSONValue> jsonResult = blink::toJSONValue(scriptValue.context(), value);
+            RefPtr<blink::JSONValue> jsonResult = blink::toJSONValue(scriptValue.context(), value);
             if (jsonResult && (jsonResult->getType() == blink::JSONValue::TypeObject))
                 return mojo::WTFArray<uint8_t>::From(jsonResult->toJSONString());
         }
diff --git a/third_party/WebKit/Source/modules/payments/PaymentRequest.cpp b/third_party/WebKit/Source/modules/payments/PaymentRequest.cpp
index 9759a2f..be94875 100644
--- a/third_party/WebKit/Source/modules/payments/PaymentRequest.cpp
+++ b/third_party/WebKit/Source/modules/payments/PaymentRequest.cpp
@@ -328,7 +328,7 @@ void validateAndConvertPaymentMethodData(const HeapVector<PaymentMethodData>& pa
 
         String stringifiedData = "";
         if (pmd.hasData() && !pmd.data().isEmpty()) {
-            std::unique_ptr<JSONValue> value = toJSONValue(pmd.data().context(), pmd.data().v8Value());
+            RefPtr<JSONValue> value = toJSONValue(pmd.data().context(), pmd.data().v8Value());
             if (!value) {
                 exceptionState.throwTypeError("Unable to parse payment method specific data");
                 return;
@@ -338,7 +338,7 @@ void validateAndConvertPaymentMethodData(const HeapVector<PaymentMethodData>& pa
                     exceptionState.throwTypeError("Data should be a JSON-serializable object");
                     return;
                 }
-                stringifiedData = JSONObject::cast(value.get())->toJSONString();
+                stringifiedData = JSONObject::cast(value)->toJSONString();
             }
         }
         methodData->append(PaymentRequest::MethodData(pmd.supportedMethods(), stringifiedData));
diff --git a/third_party/WebKit/Source/modules/webshare/OWNERS b/third_party/WebKit/Source/modules/webshare/OWNERS
new file mode 100644
index 0000000..ae44f9d
--- /dev/null
+++ b/third_party/WebKit/Source/modules/webshare/OWNERS
@@ -0,0 +1,2 @@
+mgiuca@chromium.org
+sammc@chromium.org
diff --git a/third_party/WebKit/Source/platform/JSONParser.cpp b/third_party/WebKit/Source/platform/JSONParser.cpp
deleted file mode 100644
index a9a35d4..0000000
--- a/third_party/WebKit/Source/platform/JSONParser.cpp
+++ /dev/null
@@ -1,519 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "platform/JSONParser.h"
-
-#include "platform/Decimal.h"
-#include "platform/JSONValues.h"
-#include "wtf/text/StringBuilder.h"
-#include "wtf/text/StringToNumber.h"
-
-namespace blink {
-
-namespace {
-
-const int stackLimit = 1000;
-
-enum Token {
-    ObjectBegin,
-    ObjectEnd,
-    ArrayBegin,
-    ArrayEnd,
-    StringLiteral,
-    Number,
-    BoolTrue,
-    BoolFalse,
-    NullToken,
-    ListSeparator,
-    ObjectPairSeparator,
-    InvalidToken,
-};
-
-const char* const nullString = "null";
-const char* const trueString = "true";
-const char* const falseString = "false";
-
-template<typename CharType>
-bool parseConstToken(const CharType* start, const CharType* end, const CharType** tokenEnd, const char* token)
-{
-    while (start < end && *token != '\0' && *start++ == *token++) { }
-    if (*token != '\0')
-        return false;
-    *tokenEnd = start;
-    return true;
-}
-
-template<typename CharType>
-bool readInt(const CharType* start, const CharType* end, const CharType** tokenEnd, bool canHaveLeadingZeros)
-{
-    if (start == end)
-        return false;
-    bool haveLeadingZero = '0' == *start;
-    int length = 0;
-    while (start < end && '0' <= *start && *start <= '9') {
-        ++start;
-        ++length;
-    }
-    if (!length)
-        return false;
-    if (!canHaveLeadingZeros && length > 1 && haveLeadingZero)
-        return false;
-    *tokenEnd = start;
-    return true;
-}
-
-template<typename CharType>
-bool parseNumberToken(const CharType* start, const CharType* end, const CharType** tokenEnd)
-{
-    // We just grab the number here. We validate the size in DecodeNumber.
-    // According to RFC4627, a valid number is: [minus] int [frac] [exp]
-    if (start == end)
-        return false;
-    CharType c = *start;
-    if ('-' == c)
-        ++start;
-
-    if (!readInt(start, end, &start, false))
-        return false;
-    if (start == end) {
-        *tokenEnd = start;
-        return true;
-    }
-
-    // Optional fraction part
-    c = *start;
-    if ('.' == c) {
-        ++start;
-        if (!readInt(start, end, &start, true))
-            return false;
-        if (start == end) {
-            *tokenEnd = start;
-            return true;
-        }
-        c = *start;
-    }
-
-    // Optional exponent part
-    if ('e' == c || 'E' == c) {
-        ++start;
-        if (start == end)
-            return false;
-        c = *start;
-        if ('-' == c || '+' == c) {
-            ++start;
-            if (start == end)
-                return false;
-        }
-        if (!readInt(start, end, &start, true))
-            return false;
-    }
-
-    *tokenEnd = start;
-    return true;
-}
-
-template<typename CharType>
-bool readHexDigits(const CharType* start, const CharType* end, const CharType** tokenEnd, int digits)
-{
-    if (end - start < digits)
-        return false;
-    for (int i = 0; i < digits; ++i) {
-        CharType c = *start++;
-        if (!(('0' <= c && c <= '9') || ('a' <= c && c <= 'f') || ('A' <= c && c <= 'F')))
-            return false;
-    }
-    *tokenEnd = start;
-    return true;
-}
-
-template<typename CharType>
-bool parseStringToken(const CharType* start, const CharType* end, const CharType** tokenEnd)
-{
-    while (start < end) {
-        CharType c = *start++;
-        if ('\\' == c) {
-            c = *start++;
-            // Make sure the escaped char is valid.
-            switch (c) {
-            case 'x':
-                if (!readHexDigits(start, end, &start, 2))
-                    return false;
-                break;
-            case 'u':
-                if (!readHexDigits(start, end, &start, 4))
-                    return false;
-                break;
-            case '\\':
-            case '/':
-            case 'b':
-            case 'f':
-            case 'n':
-            case 'r':
-            case 't':
-            case 'v':
-            case '"':
-                break;
-            default:
-                return false;
-            }
-        } else if ('"' == c) {
-            *tokenEnd = start;
-            return true;
-        }
-    }
-    return false;
-}
-
-template<typename CharType>
-bool skipComment(const CharType* start, const CharType* end, const CharType** commentEnd)
-{
-    if (start == end)
-        return false;
-
-    if (*start != '/' || start + 1 >= end)
-        return false;
-    ++start;
-
-    if (*start == '/') {
-        // Single line comment, read to newline.
-        for (++start; start < end; ++start) {
-            if (*start == '\n' || *start == '\r') {
-                *commentEnd = start + 1;
-                return true;
-            }
-        }
-        *commentEnd = end;
-        // Comment reaches end-of-input, which is fine.
-        return true;
-    }
-
-    if (*start == '*') {
-        CharType previous = '\0';
-        // Block comment, read until end marker.
-        for (++start; start < end; previous = *start++) {
-            if (previous == '*' && *start == '/') {
-                *commentEnd = start + 1;
-                return true;
-            }
-        }
-        // Block comment must close before end-of-input.
-        return false;
-    }
-
-    return false;
-}
-
-template<typename CharType>
-void skipWhitespaceAndComments(const CharType* start, const CharType* end, const CharType** whitespaceEnd)
-{
-    while (start < end) {
-        if (isSpaceOrNewline(*start)) {
-            ++start;
-        } else if (*start == '/') {
-            const CharType* commentEnd;
-            if (!skipComment(start, end, &commentEnd))
-                break;
-            start = commentEnd;
-        } else {
-            break;
-        }
-    }
-    *whitespaceEnd = start;
-}
-
-template<typename CharType>
-Token parseToken(const CharType* start, const CharType* end, const CharType** tokenStart, const CharType** tokenEnd)
-{
-    skipWhitespaceAndComments(start, end, tokenStart);
-    start = *tokenStart;
-
-    if (start == end)
-        return InvalidToken;
-
-    switch (*start) {
-    case 'n':
-        if (parseConstToken(start, end, tokenEnd, nullString))
-            return NullToken;
-        break;
-    case 't':
-        if (parseConstToken(start, end, tokenEnd, trueString))
-            return BoolTrue;
-        break;
-    case 'f':
-        if (parseConstToken(start, end, tokenEnd, falseString))
-            return BoolFalse;
-        break;
-    case '[':
-        *tokenEnd = start + 1;
-        return ArrayBegin;
-    case ']':
-        *tokenEnd = start + 1;
-        return ArrayEnd;
-    case ',':
-        *tokenEnd = start + 1;
-        return ListSeparator;
-    case '{':
-        *tokenEnd = start + 1;
-        return ObjectBegin;
-    case '}':
-        *tokenEnd = start + 1;
-        return ObjectEnd;
-    case ':':
-        *tokenEnd = start + 1;
-        return ObjectPairSeparator;
-    case '0':
-    case '1':
-    case '2':
-    case '3':
-    case '4':
-    case '5':
-    case '6':
-    case '7':
-    case '8':
-    case '9':
-    case '-':
-        if (parseNumberToken(start, end, tokenEnd))
-            return Number;
-        break;
-    case '"':
-        if (parseStringToken(start + 1, end, tokenEnd))
-            return StringLiteral;
-        break;
-    }
-    return InvalidToken;
-}
-
-template<typename CharType>
-inline int hexToInt(CharType c)
-{
-    if ('0' <= c && c <= '9')
-        return c - '0';
-    if ('A' <= c && c <= 'F')
-        return c - 'A' + 10;
-    if ('a' <= c && c <= 'f')
-        return c - 'a' + 10;
-    NOTREACHED();
-    return 0;
-}
-
-template<typename CharType>
-bool decodeString(const CharType* start, const CharType* end, StringBuilder* output)
-{
-    while (start < end) {
-        UChar c = *start++;
-        if ('\\' != c) {
-            output->append(c);
-            continue;
-        }
-        c = *start++;
-
-        if (c == 'x') {
-            // \x is not supported.
-            return false;
-        }
-
-        switch (c) {
-        case '"':
-        case '/':
-        case '\\':
-            break;
-        case 'b':
-            c = '\b';
-            break;
-        case 'f':
-            c = '\f';
-            break;
-        case 'n':
-            c = '\n';
-            break;
-        case 'r':
-            c = '\r';
-            break;
-        case 't':
-            c = '\t';
-            break;
-        case 'v':
-            c = '\v';
-            break;
-        case 'u':
-            c = (hexToInt(*start) << 12) +
-                (hexToInt(*(start + 1)) << 8) +
-                (hexToInt(*(start + 2)) << 4) +
-                hexToInt(*(start + 3));
-            start += 4;
-            break;
-        default:
-            return false;
-        }
-        output->append(c);
-    }
-    return true;
-}
-
-template<typename CharType>
-bool decodeString(const CharType* start, const CharType* end, String* output)
-{
-    if (start == end) {
-        *output = "";
-        return true;
-    }
-    if (start > end)
-        return false;
-    StringBuilder buffer;
-    buffer.reserveCapacity(end - start);
-    if (!decodeString(start, end, &buffer))
-        return false;
-    *output = buffer.toString();
-    // Validate constructed utf16 string.
-    if (output->utf8(StrictUTF8Conversion).isNull())
-        return false;
-    return true;
-}
-
-template<typename CharType>
-std::unique_ptr<JSONValue> buildValue(const CharType* start, const CharType* end, const CharType** valueTokenEnd, int depth)
-{
-    if (depth > stackLimit)
-        return nullptr;
-
-    std::unique_ptr<JSONValue> result;
-    const CharType* tokenStart;
-    const CharType* tokenEnd;
-    Token token = parseToken(start, end, &tokenStart, &tokenEnd);
-    switch (token) {
-    case InvalidToken:
-        return nullptr;
-    case NullToken:
-        result = JSONValue::null();
-        break;
-    case BoolTrue:
-        result = JSONBasicValue::create(true);
-        break;
-    case BoolFalse:
-        result = JSONBasicValue::create(false);
-        break;
-    case Number: {
-        bool ok;
-        double value = charactersToDouble(tokenStart, tokenEnd - tokenStart, &ok);
-        if (Decimal::fromDouble(value).isInfinity())
-            ok = false;
-        if (!ok)
-            return nullptr;
-        int number = static_cast<int>(value);
-        if (number == value)
-            result = JSONBasicValue::create(number);
-        else
-            result = JSONBasicValue::create(value);
-        break;
-    }
-    case StringLiteral: {
-        String value;
-        bool ok = decodeString(tokenStart + 1, tokenEnd - 1, &value);
-        if (!ok)
-            return nullptr;
-        result = JSONString::create(value);
-        break;
-    }
-    case ArrayBegin: {
-        std::unique_ptr<JSONArray> array = JSONArray::create();
-        start = tokenEnd;
-        token = parseToken(start, end, &tokenStart, &tokenEnd);
-        while (token != ArrayEnd) {
-            std::unique_ptr<JSONValue> arrayNode = buildValue(start, end, &tokenEnd, depth + 1);
-            if (!arrayNode)
-                return nullptr;
-            array->pushValue(std::move(arrayNode));
-
-            // After a list value, we expect a comma or the end of the list.
-            start = tokenEnd;
-            token = parseToken(start, end, &tokenStart, &tokenEnd);
-            if (token == ListSeparator) {
-                start = tokenEnd;
-                token = parseToken(start, end, &tokenStart, &tokenEnd);
-                if (token == ArrayEnd)
-                    return nullptr;
-            } else if (token != ArrayEnd) {
-                // Unexpected value after list value. Bail out.
-                return nullptr;
-            }
-        }
-        if (token != ArrayEnd)
-            return nullptr;
-        result = std::move(array);
-        break;
-    }
-    case ObjectBegin: {
-        std::unique_ptr<JSONObject> object = JSONObject::create();
-        start = tokenEnd;
-        token = parseToken(start, end, &tokenStart, &tokenEnd);
-        while (token != ObjectEnd) {
-            if (token != StringLiteral)
-                return nullptr;
-            String key;
-            if (!decodeString(tokenStart + 1, tokenEnd - 1, &key))
-                return nullptr;
-            start = tokenEnd;
-
-            token = parseToken(start, end, &tokenStart, &tokenEnd);
-            if (token != ObjectPairSeparator)
-                return nullptr;
-            start = tokenEnd;
-
-            std::unique_ptr<JSONValue> value = buildValue(start, end, &tokenEnd, depth + 1);
-            if (!value)
-                return nullptr;
-            object->setValue(key, std::move(value));
-            start = tokenEnd;
-
-            // After a key/value pair, we expect a comma or the end of the
-            // object.
-            token = parseToken(start, end, &tokenStart, &tokenEnd);
-            if (token == ListSeparator) {
-                start = tokenEnd;
-                token = parseToken(start, end, &tokenStart, &tokenEnd);
-                if (token == ObjectEnd)
-                    return nullptr;
-            } else if (token != ObjectEnd) {
-                // Unexpected value after last object value. Bail out.
-                return nullptr;
-            }
-        }
-        if (token != ObjectEnd)
-            return nullptr;
-        result = std::move(object);
-        break;
-    }
-
-    default:
-        // We got a token that's not a value.
-        return nullptr;
-    }
-
-    skipWhitespaceAndComments(tokenEnd, end, valueTokenEnd);
-    return result;
-}
-
-template<typename CharType>
-std::unique_ptr<JSONValue> parseJSONInternal(const CharType* start, unsigned length)
-{
-    const CharType* end = start + length;
-    const CharType *tokenEnd;
-    std::unique_ptr<JSONValue> value = buildValue(start, end, &tokenEnd, 0);
-    if (!value || tokenEnd != end)
-        return nullptr;
-    return value;
-}
-
-} // anonymous namespace
-
-std::unique_ptr<JSONValue> parseJSON(const String& json)
-{
-    if (json.isEmpty())
-        return nullptr;
-    if (json.is8Bit())
-        return parseJSONInternal(json.characters8(), json.length());
-    return parseJSONInternal(json.characters16(), json.length());
-}
-
-} // namespace blink
diff --git a/third_party/WebKit/Source/platform/JSONParser.h b/third_party/WebKit/Source/platform/JSONParser.h
deleted file mode 100644
index b208d91..0000000
--- a/third_party/WebKit/Source/platform/JSONParser.h
+++ /dev/null
@@ -1,21 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef JSONParser_h
-#define JSONParser_h
-
-#include "platform/PlatformExport.h"
-#include "wtf/text/WTFString.h"
-
-#include <memory>
-
-namespace blink {
-
-class JSONValue;
-
-PLATFORM_EXPORT std::unique_ptr<JSONValue> parseJSON(const String& json);
-
-} // namespace blink
-
-#endif // JSONParser_h
diff --git a/third_party/WebKit/Source/platform/JSONParserTest.cpp b/third_party/WebKit/Source/platform/JSONParserTest.cpp
deleted file mode 100644
index 4e57eaa..0000000
--- a/third_party/WebKit/Source/platform/JSONParserTest.cpp
+++ /dev/null
@@ -1,502 +0,0 @@
-// Copyright (c) 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "platform/JSONParser.h"
-
-#include "platform/JSONValues.h"
-#include "testing/gtest/include/gtest/gtest.h"
-#include "wtf/text/StringBuilder.h"
-
-namespace blink {
-
-TEST(JSONParserTest, Reading)
-{
-    JSONValue* tmpValue;
-    std::unique_ptr<JSONValue> root;
-    std::unique_ptr<JSONValue> root2;
-    String strVal;
-    int intVal = 0;
-
-    // some whitespace checking
-    root = parseJSON("    null    ");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeNull, root->getType());
-
-    // Invalid JSON string
-    root = parseJSON("nu");
-    EXPECT_FALSE(root.get());
-
-    // Simple bool
-    root = parseJSON("true  ");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeBoolean, root->getType());
-
-    // Embedded comment
-    root = parseJSON("40 /*/");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("/* comment */null");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeNull, root->getType());
-    root = parseJSON("40 /* comment */");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeInteger, root->getType());
-    EXPECT_TRUE(root->asInteger(&intVal));
-    EXPECT_EQ(40, intVal);
-    root = parseJSON("/**/ 40 /* multi-line\n comment */ // more comment");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeInteger, root->getType());
-    EXPECT_TRUE(root->asInteger(&intVal));
-    EXPECT_EQ(40, intVal);
-    root = parseJSON("true // comment");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeBoolean, root->getType());
-    root = parseJSON("/* comment */\"sample string\"");
-    ASSERT_TRUE(root.get());
-    EXPECT_TRUE(root->asString(&strVal));
-    EXPECT_EQ("sample string", strVal);
-    root = parseJSON("[1, /* comment, 2 ] */ \n 3]");
-    ASSERT_TRUE(root.get());
-    JSONArray* list = JSONArray::cast(root.get());
-    ASSERT_TRUE(list);
-    EXPECT_EQ(2u, list->size());
-    tmpValue = list->at(0);
-    ASSERT_TRUE(tmpValue);
-    EXPECT_TRUE(tmpValue->asInteger(&intVal));
-    EXPECT_EQ(1, intVal);
-    tmpValue = list->at(1);
-    ASSERT_TRUE(tmpValue);
-    EXPECT_TRUE(tmpValue->asInteger(&intVal));
-    EXPECT_EQ(3, intVal);
-    root = parseJSON("[1, /*a*/2, 3]");
-    ASSERT_TRUE(root.get());
-    list = JSONArray::cast(root.get());
-    ASSERT_TRUE(list);
-    EXPECT_EQ(3u, list->size());
-    root = parseJSON("/* comment **/42");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeInteger, root->getType());
-    EXPECT_TRUE(root->asInteger(&intVal));
-    EXPECT_EQ(42, intVal);
-    root = parseJSON(
-        "/* comment **/\n"
-        "// */ 43\n"
-        "44");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeInteger, root->getType());
-    EXPECT_TRUE(root->asInteger(&intVal));
-    EXPECT_EQ(44, intVal);
-
-    // Test number formats
-    root = parseJSON("43");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeInteger, root->getType());
-    EXPECT_TRUE(root->asInteger(&intVal));
-    EXPECT_EQ(43, intVal);
-
-    // According to RFC4627, oct, hex, and leading zeros are invalid JSON.
-    root = parseJSON("043");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("0x43");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("00");
-    EXPECT_FALSE(root.get());
-
-    // Test 0 (which needs to be special cased because of the leading zero
-    // clause).
-    root = parseJSON("0");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeInteger, root->getType());
-    intVal = 1;
-    EXPECT_TRUE(root->asInteger(&intVal));
-    EXPECT_EQ(0, intVal);
-
-    // Numbers that overflow ints should succeed, being internally promoted to
-    // storage as doubles
-    root = parseJSON("2147483648");
-    ASSERT_TRUE(root.get());
-    double doubleVal;
-    EXPECT_EQ(JSONValue::TypeDouble, root->getType());
-    doubleVal = 0.0;
-    EXPECT_TRUE(root->asDouble(&doubleVal));
-    EXPECT_DOUBLE_EQ(2147483648.0, doubleVal);
-    root = parseJSON("-2147483649");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeDouble, root->getType());
-    doubleVal = 0.0;
-    EXPECT_TRUE(root->asDouble(&doubleVal));
-    EXPECT_DOUBLE_EQ(-2147483649.0, doubleVal);
-
-    // Parse a double
-    root = parseJSON("43.1");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeDouble, root->getType());
-    doubleVal = 0.0;
-    EXPECT_TRUE(root->asDouble(&doubleVal));
-    EXPECT_DOUBLE_EQ(43.1, doubleVal);
-
-    root = parseJSON("4.3e-1");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeDouble, root->getType());
-    doubleVal = 0.0;
-    EXPECT_TRUE(root->asDouble(&doubleVal));
-    EXPECT_DOUBLE_EQ(.43, doubleVal);
-
-    root = parseJSON("2.1e0");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeDouble, root->getType());
-    doubleVal = 0.0;
-    EXPECT_TRUE(root->asDouble(&doubleVal));
-    EXPECT_DOUBLE_EQ(2.1, doubleVal);
-
-    root = parseJSON("2.1e+0001");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeInteger, root->getType());
-    doubleVal = 0.0;
-    EXPECT_TRUE(root->asDouble(&doubleVal));
-    EXPECT_DOUBLE_EQ(21.0, doubleVal);
-
-    root = parseJSON("0.01");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeDouble, root->getType());
-    doubleVal = 0.0;
-    EXPECT_TRUE(root->asDouble(&doubleVal));
-    EXPECT_DOUBLE_EQ(0.01, doubleVal);
-
-    root = parseJSON("1.00");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeInteger, root->getType());
-    doubleVal = 0.0;
-    EXPECT_TRUE(root->asDouble(&doubleVal));
-    EXPECT_DOUBLE_EQ(1.0, doubleVal);
-
-    // Fractional parts must have a digit before and after the decimal point.
-    root = parseJSON("1.");
-    EXPECT_FALSE(root.get());
-    root = parseJSON(".1");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("1.e10");
-    EXPECT_FALSE(root.get());
-
-    // Exponent must have a digit following the 'e'.
-    root = parseJSON("1e");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("1E");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("1e1.");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("1e1.0");
-    EXPECT_FALSE(root.get());
-
-    // INF/-INF/NaN are not valid
-    root = parseJSON("NaN");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("nan");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("inf");
-    EXPECT_FALSE(root.get());
-
-    // Invalid number formats
-    root = parseJSON("4.3.1");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("4e3.1");
-    EXPECT_FALSE(root.get());
-
-    // Test string parser
-    root = parseJSON("\"hello world\"");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeString, root->getType());
-    EXPECT_TRUE(root->asString(&strVal));
-    EXPECT_EQ("hello world", strVal);
-
-    // Empty string
-    root = parseJSON("\"\"");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeString, root->getType());
-    EXPECT_TRUE(root->asString(&strVal));
-    EXPECT_EQ("", strVal);
-
-    // Test basic string escapes
-    root = parseJSON("\" \\\"\\\\\\/\\b\\f\\n\\r\\t\\v\"");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeString, root->getType());
-    EXPECT_TRUE(root->asString(&strVal));
-    EXPECT_EQ(" \"\\/\b\f\n\r\t\v", strVal);
-
-    // Test hex and unicode escapes including the null character.
-    root = parseJSON("\"\\x41\\x00\\u1234\"");
-    EXPECT_FALSE(root.get());
-
-    // Test invalid strings
-    root = parseJSON("\"no closing quote");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("\"\\z invalid escape char\"");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("\"not enough escape chars\\u123\"");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("\"extra backslash at end of input\\\"");
-    EXPECT_FALSE(root.get());
-
-    // Basic array
-    root = parseJSON("[true, false, null]");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeArray, root->getType());
-    list = JSONArray::cast(root.get());
-    ASSERT_TRUE(list);
-    EXPECT_EQ(3U, list->size());
-
-    // Empty array
-    root = parseJSON("[]");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeArray, root->getType());
-    list = JSONArray::cast(root.get());
-    ASSERT_TRUE(list);
-    EXPECT_EQ(0U, list->size());
-
-    // Nested arrays
-    root = parseJSON("[[true], [], [false, [], [null]], null]");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeArray, root->getType());
-    list = JSONArray::cast(root.get());
-    ASSERT_TRUE(list);
-    EXPECT_EQ(4U, list->size());
-
-    // Invalid, missing close brace.
-    root = parseJSON("[[true], [], [false, [], [null]], null");
-    EXPECT_FALSE(root.get());
-
-    // Invalid, too many commas
-    root = parseJSON("[true,, null]");
-    EXPECT_FALSE(root.get());
-
-    // Invalid, no commas
-    root = parseJSON("[true null]");
-    EXPECT_FALSE(root.get());
-
-    // Invalid, trailing comma
-    root = parseJSON("[true,]");
-    EXPECT_FALSE(root.get());
-
-    root = parseJSON("[true]");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeArray, root->getType());
-    list = JSONArray::cast(root.get());
-    ASSERT_TRUE(list);
-    EXPECT_EQ(1U, list->size());
-    tmpValue = list->at(0);
-    ASSERT_TRUE(tmpValue);
-    EXPECT_EQ(JSONValue::TypeBoolean, tmpValue->getType());
-    bool boolValue = false;
-    EXPECT_TRUE(tmpValue->asBoolean(&boolValue));
-    EXPECT_TRUE(boolValue);
-
-    // Don't allow empty elements.
-    root = parseJSON("[,]");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("[true,,]");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("[,true,]");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("[true,,false]");
-    EXPECT_FALSE(root.get());
-
-    // Test objects
-    root = parseJSON("{}");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeObject, root->getType());
-
-    root = parseJSON("{\"number\":9.87654321, \"null\":null , \"S\" : \"str\" }");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeObject, root->getType());
-    JSONObject* objectVal = JSONObject::cast(root.get());
-    ASSERT_TRUE(objectVal);
-    doubleVal = 0.0;
-    EXPECT_TRUE(objectVal->getDouble("number", &doubleVal));
-    EXPECT_DOUBLE_EQ(9.87654321, doubleVal);
-    JSONValue* nullVal = objectVal->get("null");
-    ASSERT_TRUE(nullVal);
-    EXPECT_EQ(JSONValue::TypeNull, nullVal->getType());
-    EXPECT_TRUE(objectVal->getString("S", &strVal));
-    EXPECT_EQ("str", strVal);
-
-    // Test newline equivalence.
-    root2 = parseJSON(
-        "{\n"
-        "  \"number\":9.87654321,\n"
-        "  \"null\":null,\n"
-        "  \"S\":\"str\"\n"
-        "}\n");
-    ASSERT_TRUE(root2.get());
-    EXPECT_EQ(root->toJSONString(), root2->toJSONString());
-
-    root2 = parseJSON(
-        "{\r\n"
-        "  \"number\":9.87654321,\r\n"
-        "  \"null\":null,\r\n"
-        "  \"S\":\"str\"\r\n"
-        "}\r\n");
-    ASSERT_TRUE(root2.get());
-    EXPECT_EQ(root->toJSONString(), root2->toJSONString());
-
-    // Test nesting
-    root = parseJSON("{\"inner\":{\"array\":[true]},\"false\":false,\"d\":{}}");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeObject, root->getType());
-    objectVal = JSONObject::cast(root.get());
-    ASSERT_TRUE(objectVal);
-    JSONObject* innerObject = objectVal->getObject("inner");
-    ASSERT_TRUE(innerObject);
-    JSONArray* innerArray = innerObject->getArray("array");
-    ASSERT_TRUE(innerArray);
-    EXPECT_EQ(1U, innerArray->size());
-    boolValue = true;
-    EXPECT_TRUE(objectVal->getBoolean("false", &boolValue));
-    EXPECT_FALSE(boolValue);
-    innerObject = objectVal->getObject("d");
-    EXPECT_TRUE(innerObject);
-
-    // Test keys with periods
-    root = parseJSON("{\"a.b\":3,\"c\":2,\"d.e.f\":{\"g.h.i.j\":1}}");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeObject, root->getType());
-    objectVal = JSONObject::cast(root.get());
-    ASSERT_TRUE(objectVal);
-    int integerValue = 0;
-    EXPECT_TRUE(objectVal->getInteger("a.b", &integerValue));
-    EXPECT_EQ(3, integerValue);
-    EXPECT_TRUE(objectVal->getInteger("c", &integerValue));
-    EXPECT_EQ(2, integerValue);
-    innerObject = objectVal->getObject("d.e.f");
-    ASSERT_TRUE(innerObject);
-    EXPECT_EQ(1U, innerObject->size());
-    EXPECT_TRUE(innerObject->getInteger("g.h.i.j", &integerValue));
-    EXPECT_EQ(1, integerValue);
-
-    root = parseJSON("{\"a\":{\"b\":2},\"a.b\":1}");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeObject, root->getType());
-    objectVal = JSONObject::cast(root.get());
-    ASSERT_TRUE(objectVal);
-    innerObject = objectVal->getObject("a");
-    ASSERT_TRUE(innerObject);
-    EXPECT_TRUE(innerObject->getInteger("b", &integerValue));
-    EXPECT_EQ(2, integerValue);
-    EXPECT_TRUE(objectVal->getInteger("a.b", &integerValue));
-    EXPECT_EQ(1, integerValue);
-
-    // Invalid, no closing brace
-    root = parseJSON("{\"a\": true");
-    EXPECT_FALSE(root.get());
-
-    // Invalid, keys must be quoted
-    root = parseJSON("{foo:true}");
-    EXPECT_FALSE(root.get());
-
-    // Invalid, trailing comma
-    root = parseJSON("{\"a\":true,}");
-    EXPECT_FALSE(root.get());
-
-    // Invalid, too many commas
-    root = parseJSON("{\"a\":true,,\"b\":false}");
-    EXPECT_FALSE(root.get());
-
-    // Invalid, no separator
-    root = parseJSON("{\"a\" \"b\"}");
-    EXPECT_FALSE(root.get());
-
-    // Invalid, lone comma.
-    root = parseJSON("{,}");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("{\"a\":true,,}");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("{,\"a\":true}");
-    EXPECT_FALSE(root.get());
-    root = parseJSON("{\"a\":true,,\"b\":false}");
-    EXPECT_FALSE(root.get());
-
-    // Test stack overflow
-    StringBuilder evil;
-    evil.reserveCapacity(2000000);
-    for (int i = 0; i < 1000000; ++i)
-        evil.append('[');
-    for (int i = 0; i < 1000000; ++i)
-        evil.append(']');
-    root = parseJSON(evil.toString());
-    EXPECT_FALSE(root.get());
-
-    // A few thousand adjacent lists is fine.
-    StringBuilder notEvil;
-    notEvil.reserveCapacity(15010);
-    notEvil.append('[');
-    for (int i = 0; i < 5000; ++i)
-        notEvil.append("[],");
-    notEvil.append("[]]");
-    root = parseJSON(notEvil.toString());
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeArray, root->getType());
-    list = JSONArray::cast(root.get());
-    ASSERT_TRUE(list);
-    EXPECT_EQ(5001U, list->size());
-
-    // Test utf8 encoded input
-    root = parseJSON("\"\\xe7\\xbd\\x91\\xe9\\xa1\\xb5\"");
-    ASSERT_FALSE(root.get());
-
-    // Test utf16 encoded strings.
-    root = parseJSON("\"\\u20ac3,14\"");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeString, root->getType());
-    EXPECT_TRUE(root->asString(&strVal));
-    UChar tmp2[] = {0x20ac, 0x33, 0x2c, 0x31, 0x34};
-    EXPECT_EQ(String(tmp2, WTF_ARRAY_LENGTH(tmp2)), strVal);
-
-    root = parseJSON("\"\\ud83d\\udca9\\ud83d\\udc6c\"");
-    ASSERT_TRUE(root.get());
-    EXPECT_EQ(JSONValue::TypeString, root->getType());
-    EXPECT_TRUE(root->asString(&strVal));
-    UChar tmp3[] = {0xd83d, 0xdca9, 0xd83d, 0xdc6c};
-    EXPECT_EQ(String(tmp3, WTF_ARRAY_LENGTH(tmp3)), strVal);
-
-    // Test literal root objects.
-    root = parseJSON("null");
-    EXPECT_EQ(JSONValue::TypeNull, root->getType());
-
-    root = parseJSON("true");
-    ASSERT_TRUE(root.get());
-    EXPECT_TRUE(root->asBoolean(&boolValue));
-    EXPECT_TRUE(boolValue);
-
-    root = parseJSON("10");
-    ASSERT_TRUE(root.get());
-    EXPECT_TRUE(root->asInteger(&integerValue));
-    EXPECT_EQ(10, integerValue);
-
-    root = parseJSON("\"root\"");
-    ASSERT_TRUE(root.get());
-    EXPECT_TRUE(root->asString(&strVal));
-    EXPECT_EQ("root", strVal);
-}
-
-TEST(JSONParserTest, InvalidSanity)
-{
-    const char* const invalidJson[] = {
-        "/* test *",
-        "{\"foo\"",
-        "{\"foo\":",
-        "  [",
-        "\"\\u123g\"",
-        "{\n\"eh:\n}",
-        "////",
-        "*/**/",
-        "/**/",
-        "/*/",
-        "//**/"
-    };
-
-    for (size_t i = 0; i < WTF_ARRAY_LENGTH(invalidJson); ++i) {
-        std::unique_ptr<JSONValue> result = parseJSON(invalidJson[i]);
-        EXPECT_FALSE(result.get());
-    }
-}
-
-} // namespace blink
diff --git a/third_party/WebKit/Source/platform/JSONValues.cpp b/third_party/WebKit/Source/platform/JSONValues.cpp
index 7bfb9df..86f642c 100644
--- a/third_party/WebKit/Source/platform/JSONValues.cpp
+++ b/third_party/WebKit/Source/platform/JSONValues.cpp
@@ -33,8 +33,6 @@
 #include "platform/Decimal.h"
 #include "wtf/MathExtras.h"
 #include "wtf/text/StringBuilder.h"
-#include <algorithm>
-#include <cmath>
 
 namespace blink {
 
@@ -60,17 +58,6 @@ inline bool escapeChar(UChar c, StringBuilder* dst)
     return true;
 }
 
-const LChar hexDigits[17] = "0123456789ABCDEF";
-
-void appendUnsignedAsHex(UChar number, StringBuilder* dst)
-{
-    dst->append("\\u");
-    for (size_t i = 0; i < 4; ++i) {
-        dst->append(hexDigits[(number & 0xF000) >> 12]);
-        number <<= 4;
-    }
-}
-
 void writeIndent(int depth, StringBuilder* output)
 {
     for (int i = 0; i < depth; ++i)
@@ -88,7 +75,9 @@ void escapeStringForJSON(const String& str, StringBuilder* dst)
                 // 1. Escaping <, > to prevent script execution.
                 // 2. Technically, we could also pass through c > 126 as UTF8, but this
                 //    is also optional. It would also be a pain to implement here.
-                appendUnsignedAsHex(c, dst);
+                unsigned symbol = static_cast<unsigned>(c);
+                String symbolCode = String::format("\\u%04X", symbol);
+                dst->append(symbolCode);
             } else {
                 dst->append(c);
             }
@@ -115,12 +104,27 @@ bool JSONValue::asBoolean(bool*) const
     return false;
 }
 
-bool JSONValue::asDouble(double*) const
+bool JSONValue::asNumber(double*) const
+{
+    return false;
+}
+
+bool JSONValue::asNumber(long*) const
+{
+    return false;
+}
+
+bool JSONValue::asNumber(int*) const
+{
+    return false;
+}
+
+bool JSONValue::asNumber(unsigned long*) const
 {
     return false;
 }
 
-bool JSONValue::asInteger(int*) const
+bool JSONValue::asNumber(unsigned*) const
 {
     return false;
 }
@@ -148,7 +152,7 @@ String JSONValue::toPrettyJSONString() const
 
 void JSONValue::writeJSON(StringBuilder* output) const
 {
-    DCHECK(m_type == TypeNull);
+    ASSERT(m_type == TypeNull);
     output->append(nullString, 4);
 }
 
@@ -163,11 +167,6 @@ void JSONValue::prettyWriteJSONInternal(StringBuilder* output, int depth) const
     writeJSON(output);
 }
 
-std::unique_ptr<JSONValue> JSONValue::clone() const
-{
-    return JSONValue::null();
-}
-
 bool JSONBasicValue::asBoolean(bool* output) const
 {
     if (getType() != TypeBoolean)
@@ -176,58 +175,63 @@ bool JSONBasicValue::asBoolean(bool* output) const
     return true;
 }
 
-bool JSONBasicValue::asDouble(double* output) const
+bool JSONBasicValue::asNumber(double* output) const
 {
-    if (getType() == TypeDouble) {
-        *output = m_doubleValue;
-        return true;
-    }
-    if (getType() == TypeInteger) {
-        *output = m_integerValue;
-        return true;
-    }
-    return false;
+    if (getType() != TypeNumber)
+        return false;
+    *output = m_doubleValue;
+    return true;
+}
+
+bool JSONBasicValue::asNumber(long* output) const
+{
+    if (getType() != TypeNumber)
+        return false;
+    *output = static_cast<long>(m_doubleValue);
+    return true;
+}
+
+bool JSONBasicValue::asNumber(int* output) const
+{
+    if (getType() != TypeNumber)
+        return false;
+    *output = static_cast<int>(m_doubleValue);
+    return true;
+}
+
+bool JSONBasicValue::asNumber(unsigned long* output) const
+{
+    if (getType() != TypeNumber)
+        return false;
+    *output = static_cast<unsigned long>(m_doubleValue);
+    return true;
 }
 
-bool JSONBasicValue::asInteger(int* output) const
+bool JSONBasicValue::asNumber(unsigned* output) const
 {
-    if (getType() != TypeInteger)
+    if (getType() != TypeNumber)
         return false;
-    *output = m_integerValue;
+    *output = static_cast<unsigned>(m_doubleValue);
     return true;
 }
 
 void JSONBasicValue::writeJSON(StringBuilder* output) const
 {
-    DCHECK(getType() == TypeBoolean || getType() == TypeInteger || getType() == TypeDouble);
+    ASSERT(getType() == TypeBoolean || getType() == TypeNumber);
     if (getType() == TypeBoolean) {
         if (m_boolValue)
             output->append(trueString, 4);
         else
             output->append(falseString, 5);
-    } else if (getType() == TypeDouble) {
+    } else if (getType() == TypeNumber) {
         if (!std::isfinite(m_doubleValue)) {
             output->append(nullString, 4);
             return;
         }
         output->append(Decimal::fromDouble(m_doubleValue).toString());
-    } else if (getType() == TypeInteger) {
-        output->append(String::number(m_integerValue));
     }
 }
 
-std::unique_ptr<JSONValue> JSONBasicValue::clone() const
-{
-    switch (getType()) {
-    case TypeDouble: return JSONBasicValue::create(m_doubleValue);
-    case TypeInteger: return JSONBasicValue::create(m_integerValue);
-    case TypeBoolean: return JSONBasicValue::create(m_boolValue);
-    default:
-        NOTREACHED();
-    }
-    return nullptr;
-}
-
 bool JSONString::asString(String* output) const
 {
     *output = m_stringValue;
@@ -236,15 +240,10 @@ bool JSONString::asString(String* output) const
 
 void JSONString::writeJSON(StringBuilder* output) const
 {
-    DCHECK(getType() == TypeString);
+    ASSERT(getType() == TypeString);
     doubleQuoteStringForJSON(m_stringValue, output);
 }
 
-std::unique_ptr<JSONValue> JSONString::clone() const
-{
-    return JSONString::create(m_stringValue);
-}
-
 JSONObject::~JSONObject()
 {
 }
@@ -254,12 +253,7 @@ void JSONObject::setBoolean(const String& name, bool value)
     setValue(name, JSONBasicValue::create(value));
 }
 
-void JSONObject::setInteger(const String& name, int value)
-{
-    setValue(name, JSONBasicValue::create(value));
-}
-
-void JSONObject::setDouble(const String& name, double value)
+void JSONObject::setNumber(const String& name, double value)
 {
     setValue(name, JSONBasicValue::create(value));
 }
@@ -269,75 +263,69 @@ void JSONObject::setString(const String& name, const String& value)
     setValue(name, JSONString::create(value));
 }
 
-void JSONObject::setValue(const String& name, std::unique_ptr<JSONValue> value)
+void JSONObject::setValue(const String& name, PassRefPtr<JSONValue> value)
 {
-    set(name, value);
+    ASSERT(value);
+    if (m_data.set(name, value).isNewEntry)
+        m_order.append(name);
 }
 
-void JSONObject::setObject(const String& name, std::unique_ptr<JSONObject> value)
+void JSONObject::setObject(const String& name, PassRefPtr<JSONObject> value)
 {
-    set(name, value);
+    ASSERT(value);
+    if (m_data.set(name, value).isNewEntry)
+        m_order.append(name);
 }
 
-void JSONObject::setArray(const String& name, std::unique_ptr<JSONArray> value)
+void JSONObject::setArray(const String& name, PassRefPtr<JSONArray> value)
 {
-    set(name, value);
+    ASSERT(value);
+    if (m_data.set(name, value).isNewEntry)
+        m_order.append(name);
 }
 
-bool JSONObject::getBoolean(const String& name, bool* output) const
+JSONObject::iterator JSONObject::find(const String& name)
 {
-    JSONValue* value = get(name);
-    if (!value)
-        return false;
-    return value->asBoolean(output);
+    return m_data.find(name);
 }
 
-bool JSONObject::getInteger(const String& name, int* output) const
+JSONObject::const_iterator JSONObject::find(const String& name) const
 {
-    JSONValue* value = get(name);
-    if (!value)
-        return false;
-    return value->asInteger(output);
+    return m_data.find(name);
 }
 
-bool JSONObject::getDouble(const String& name, double* output) const
+bool JSONObject::getBoolean(const String& name, bool* output) const
 {
-    JSONValue* value = get(name);
+    RefPtr<JSONValue> value = get(name);
     if (!value)
         return false;
-    return value->asDouble(output);
+    return value->asBoolean(output);
 }
 
 bool JSONObject::getString(const String& name, String* output) const
 {
-    JSONValue* value = get(name);
+    RefPtr<JSONValue> value = get(name);
     if (!value)
         return false;
     return value->asString(output);
 }
 
-JSONObject* JSONObject::getObject(const String& name) const
+PassRefPtr<JSONObject> JSONObject::getObject(const String& name) const
 {
     return JSONObject::cast(get(name));
 }
 
-JSONArray* JSONObject::getArray(const String& name) const
+PassRefPtr<JSONArray> JSONObject::getArray(const String& name) const
 {
     return JSONArray::cast(get(name));
 }
 
-JSONValue* JSONObject::get(const String& name) const
+PassRefPtr<JSONValue> JSONObject::get(const String& name) const
 {
     Dictionary::const_iterator it = m_data.find(name);
     if (it == m_data.end())
         return nullptr;
-    return it->value.get();
-}
-
-JSONObject::Entry JSONObject::at(size_t index) const
-{
-    const String key = m_order[index];
-    return std::make_pair(key, m_data.find(key)->value.get());
+    return it->value;
 }
 
 bool JSONObject::booleanProperty(const String& name, bool defaultValue) const
@@ -347,20 +335,6 @@ bool JSONObject::booleanProperty(const String& name, bool defaultValue) const
     return result;
 }
 
-int JSONObject::integerProperty(const String& name, int defaultValue) const
-{
-    int result = defaultValue;
-    getInteger(name, &result);
-    return result;
-}
-
-double JSONObject::doubleProperty(const String& name, double defaultValue) const
-{
-    double result = defaultValue;
-    getDouble(name, &result);
-    return result;
-}
-
 void JSONObject::remove(const String& name)
 {
     m_data.remove(name);
@@ -377,7 +351,7 @@ void JSONObject::writeJSON(StringBuilder* output) const
     output->append('{');
     for (size_t i = 0; i < m_order.size(); ++i) {
         Dictionary::const_iterator it = m_data.find(m_order[i]);
-        CHECK(it != m_data.end());
+        ASSERT_WITH_SECURITY_IMPLICATION(it != m_data.end());
         if (i)
             output->append(',');
         doubleQuoteStringForJSON(it->key, output);
@@ -392,7 +366,7 @@ void JSONObject::prettyWriteJSONInternal(StringBuilder* output, int depth) const
     output->append("{\n");
     for (size_t i = 0; i < m_order.size(); ++i) {
         Dictionary::const_iterator it = m_data.find(m_order[i]);
-        CHECK(it != m_data.end());
+        ASSERT_WITH_SECURITY_IMPLICATION(it != m_data.end());
         if (i)
             output->append(",\n");
         writeIndent(depth + 1, output);
@@ -405,18 +379,6 @@ void JSONObject::prettyWriteJSONInternal(StringBuilder* output, int depth) const
     output->append('}');
 }
 
-std::unique_ptr<JSONValue> JSONObject::clone() const
-{
-    std::unique_ptr<JSONObject> result = JSONObject::create();
-    for (size_t i = 0; i < m_order.size(); ++i) {
-        String key = m_order[i];
-        Dictionary::const_iterator value = m_data.find(key);
-        DCHECK(value != m_data.end() && value->value);
-        result->setValue(key, value->value->clone());
-    }
-    return std::move(result);
-}
-
 JSONObject::JSONObject()
     : JSONValue(TypeObject)
     , m_data()
@@ -431,12 +393,10 @@ JSONArray::~JSONArray()
 void JSONArray::writeJSON(StringBuilder* output) const
 {
     output->append('[');
-    bool first = true;
-    for (const std::unique_ptr<JSONValue>& value : m_data) {
-        if (!first)
+    for (Vector<RefPtr<JSONValue>>::const_iterator it = m_data.begin(); it != m_data.end(); ++it) {
+        if (it != m_data.begin())
             output->append(',');
-        value->writeJSON(output);
-        first = false;
+        (*it)->writeJSON(output);
     }
     output->append(']');
 }
@@ -444,16 +404,14 @@ void JSONArray::writeJSON(StringBuilder* output) const
 void JSONArray::prettyWriteJSONInternal(StringBuilder* output, int depth) const
 {
     output->append('[');
-    bool first = true;
     bool lastInsertedNewLine = false;
-    for (const std::unique_ptr<JSONValue>& value : m_data) {
-        bool insertNewLine = value->getType() == JSONValue::TypeObject || value->getType() == JSONValue::TypeArray || value->getType() == JSONValue::TypeString;
-        if (first) {
+    for (Vector<RefPtr<JSONValue>>::const_iterator it = m_data.begin(); it != m_data.end(); ++it) {
+        bool insertNewLine = (*it)->getType() == JSONValue::TypeObject || (*it)->getType() == JSONValue::TypeArray || (*it)->getType() == JSONValue::TypeString;
+        if (it == m_data.begin()) {
             if (insertNewLine) {
                 output->append('\n');
                 writeIndent(depth + 1, output);
             }
-            first = false;
         } else {
             output->append(',');
             if (lastInsertedNewLine) {
@@ -463,7 +421,7 @@ void JSONArray::prettyWriteJSONInternal(StringBuilder* output, int depth) const
                 output->append(' ');
             }
         }
-        value->prettyWriteJSONInternal(output, depth + 1);
+        (*it)->prettyWriteJSONInternal(output, depth + 1);
         lastInsertedNewLine = insertNewLine;
     }
     if (lastInsertedNewLine) {
@@ -473,16 +431,9 @@ void JSONArray::prettyWriteJSONInternal(StringBuilder* output, int depth) const
     output->append(']');
 }
 
-std::unique_ptr<JSONValue> JSONArray::clone() const
-{
-    std::unique_ptr<JSONArray> result = JSONArray::create();
-    for (const std::unique_ptr<JSONValue>& value : m_data)
-        result->pushValue(value->clone());
-    return std::move(result);
-}
-
 JSONArray::JSONArray()
     : JSONValue(TypeArray)
+    , m_data()
 {
 }
 
@@ -491,12 +442,12 @@ void JSONArray::pushBoolean(bool value)
     m_data.append(JSONBasicValue::create(value));
 }
 
-void JSONArray::pushInteger(int value)
+void JSONArray::pushInt(int value)
 {
     m_data.append(JSONBasicValue::create(value));
 }
 
-void JSONArray::pushDouble(double value)
+void JSONArray::pushNumber(double value)
 {
     m_data.append(JSONBasicValue::create(value));
 }
@@ -506,28 +457,28 @@ void JSONArray::pushString(const String& value)
     m_data.append(JSONString::create(value));
 }
 
-void JSONArray::pushValue(std::unique_ptr<JSONValue> value)
+void JSONArray::pushValue(PassRefPtr<JSONValue> value)
 {
-    DCHECK(value);
-    m_data.append(std::move(value));
+    ASSERT(value);
+    m_data.append(value);
 }
 
-void JSONArray::pushObject(std::unique_ptr<JSONObject> value)
+void JSONArray::pushObject(PassRefPtr<JSONObject> value)
 {
-    DCHECK(value);
-    m_data.append(std::move(value));
+    ASSERT(value);
+    m_data.append(value);
 }
 
-void JSONArray::pushArray(std::unique_ptr<JSONArray> value)
+void JSONArray::pushArray(PassRefPtr<JSONArray> value)
 {
-    DCHECK(value);
-    m_data.append(std::move(value));
+    ASSERT(value);
+    m_data.append(value);
 }
 
-JSONValue* JSONArray::at(size_t index)
+PassRefPtr<JSONValue> JSONArray::get(size_t index)
 {
-    DCHECK_LT(index, m_data.size());
-    return m_data[index].get();
+    ASSERT_WITH_SECURITY_IMPLICATION(index < m_data.size());
+    return m_data[index];
 }
 
 } // namespace blink
diff --git a/third_party/WebKit/Source/platform/JSONValues.h b/third_party/WebKit/Source/platform/JSONValues.h
index 2aaec4a..1789d42 100644
--- a/third_party/WebKit/Source/platform/JSONValues.h
+++ b/third_party/WebKit/Source/platform/JSONValues.h
@@ -35,14 +35,12 @@
 #include "wtf/Allocator.h"
 #include "wtf/Forward.h"
 #include "wtf/HashMap.h"
-#include "wtf/Noncopyable.h"
+#include "wtf/RefCounted.h"
 #include "wtf/TypeTraits.h"
 #include "wtf/Vector.h"
 #include "wtf/text/StringHash.h"
 #include "wtf/text/WTFString.h"
 
-#include <memory>
-
 namespace blink {
 
 class JSONValue;
@@ -54,108 +52,110 @@ namespace blink {
 class JSONArray;
 class JSONObject;
 
-class PLATFORM_EXPORT JSONValue {
-    USING_FAST_MALLOC(JSONValue);
-    WTF_MAKE_NONCOPYABLE(JSONValue);
+class PLATFORM_EXPORT JSONValue : public RefCounted<JSONValue> {
 public:
     static const int maxDepth = 1000;
 
     virtual ~JSONValue() { }
 
-    static std::unique_ptr<JSONValue> null()
+    static PassRefPtr<JSONValue> null()
     {
-        return wrapUnique(new JSONValue());
+        return adoptRef(new JSONValue());
     }
 
-    enum ValueType {
+    typedef enum {
         TypeNull = 0,
         TypeBoolean,
-        TypeInteger,
-        TypeDouble,
+        TypeNumber,
         TypeString,
         TypeObject,
         TypeArray
-    };
+    } Type;
 
-    ValueType getType() const { return m_type; }
+    Type getType() const { return m_type; }
 
     bool isNull() const { return m_type == TypeNull; }
 
     virtual bool asBoolean(bool* output) const;
-    virtual bool asDouble(double* output) const;
-    virtual bool asInteger(int* output) const;
+    virtual bool asNumber(double* output) const;
+    virtual bool asNumber(long* output) const;
+    virtual bool asNumber(int* output) const;
+    virtual bool asNumber(unsigned long* output) const;
+    virtual bool asNumber(unsigned* output) const;
     virtual bool asString(String* output) const;
 
     String toJSONString() const;
     String toPrettyJSONString() const;
     virtual void writeJSON(StringBuilder* output) const;
     virtual void prettyWriteJSON(StringBuilder* output) const;
-    virtual std::unique_ptr<JSONValue> clone() const;
 
     static String quoteString(const String&);
 
 protected:
     JSONValue() : m_type(TypeNull) { }
-    explicit JSONValue(ValueType type) : m_type(type) { }
+    explicit JSONValue(Type type) : m_type(type) { }
     virtual void prettyWriteJSONInternal(StringBuilder* output, int depth) const;
 
 private:
     friend class JSONObject;
     friend class JSONArray;
 
-    ValueType m_type;
+    Type m_type;
 };
 
 class PLATFORM_EXPORT JSONBasicValue : public JSONValue {
 public:
-    static std::unique_ptr<JSONBasicValue> create(bool value)
+
+    static PassRefPtr<JSONBasicValue> create(bool value)
     {
-        return wrapUnique(new JSONBasicValue(value));
+        return adoptRef(new JSONBasicValue(value));
     }
 
-    static std::unique_ptr<JSONBasicValue> create(int value)
+    static PassRefPtr<JSONBasicValue> create(int value)
     {
-        return wrapUnique(new JSONBasicValue(value));
+        return adoptRef(new JSONBasicValue(value));
     }
 
-    static std::unique_ptr<JSONBasicValue> create(double value)
+    static PassRefPtr<JSONBasicValue> create(double value)
     {
-        return wrapUnique(new JSONBasicValue(value));
+        return adoptRef(new JSONBasicValue(value));
     }
 
     bool asBoolean(bool* output) const override;
-    bool asDouble(double* output) const override;
-    bool asInteger(int* output) const override;
+    bool asNumber(double* output) const override;
+    bool asNumber(long* output) const override;
+    bool asNumber(int* output) const override;
+    bool asNumber(unsigned long* output) const override;
+    bool asNumber(unsigned* output) const override;
+
     void writeJSON(StringBuilder* output) const override;
-    std::unique_ptr<JSONValue> clone() const override;
 
 private:
     explicit JSONBasicValue(bool value) : JSONValue(TypeBoolean), m_boolValue(value) { }
-    explicit JSONBasicValue(int value) : JSONValue(TypeInteger), m_integerValue(value) { }
-    explicit JSONBasicValue(double value) : JSONValue(TypeDouble), m_doubleValue(value) { }
+    explicit JSONBasicValue(int value) : JSONValue(TypeNumber), m_doubleValue((double)value) { }
+    explicit JSONBasicValue(double value) : JSONValue(TypeNumber), m_doubleValue(value) { }
 
     union {
         bool m_boolValue;
         double m_doubleValue;
-        int m_integerValue;
     };
 };
 
 class PLATFORM_EXPORT JSONString : public JSONValue {
 public:
-    static std::unique_ptr<JSONString> create(const String& value)
+    static PassRefPtr<JSONString> create(const String& value)
     {
-        return wrapUnique(new JSONString(value));
+        return adoptRef(new JSONString(value));
     }
 
-    static std::unique_ptr<JSONString> create(const char* value)
+    static PassRefPtr<JSONString> create(const char* value)
     {
-        return wrapUnique(new JSONString(value));
+        return adoptRef(new JSONString(value));
     }
 
     bool asString(String* output) const override;
+
     void writeJSON(StringBuilder* output) const override;
-    std::unique_ptr<JSONValue> clone() const override;
 
 private:
     explicit JSONString(const String& value) : JSONValue(TypeString), m_stringValue(value) { }
@@ -165,53 +165,59 @@ private:
 };
 
 class PLATFORM_EXPORT JSONObject : public JSONValue {
+private:
+    typedef HashMap<String, RefPtr<JSONValue>> Dictionary;
+
 public:
-    using Entry = std::pair<String, JSONValue*>;
-    static std::unique_ptr<JSONObject> create()
+    typedef Dictionary::iterator iterator;
+    typedef Dictionary::const_iterator const_iterator;
+
+    static PassRefPtr<JSONObject> create()
     {
-        return wrapUnique(new JSONObject());
+        return adoptRef(new JSONObject());
     }
 
-    static JSONObject* cast(JSONValue* value)
+    static PassRefPtr<JSONObject> cast(PassRefPtr<JSONValue> value)
     {
         if (!value || value->getType() != TypeObject)
             return nullptr;
-        return static_cast<JSONObject*>(value);
-    }
-
-    static std::unique_ptr<JSONObject> cast(std::unique_ptr<JSONValue> value)
-    {
-        return wrapUnique(JSONObject::cast(value.release()));
+        return adoptRef(static_cast<JSONObject*>(value.leakRef()));
     }
 
     void writeJSON(StringBuilder* output) const override;
-    std::unique_ptr<JSONValue> clone() const override;
 
-    size_t size() const { return m_data.size(); }
+    int size() const { return m_data.size(); }
 
     void setBoolean(const String& name, bool);
-    void setInteger(const String& name, int);
-    void setDouble(const String& name, double);
+    void setNumber(const String& name, double);
     void setString(const String& name, const String&);
-    void setValue(const String& name, std::unique_ptr<JSONValue>);
-    void setObject(const String& name, std::unique_ptr<JSONObject>);
-    void setArray(const String& name, std::unique_ptr<JSONArray>);
+    void setValue(const String& name, PassRefPtr<JSONValue>);
+    void setObject(const String& name, PassRefPtr<JSONObject>);
+    void setArray(const String& name, PassRefPtr<JSONArray>);
 
+    iterator find(const String& name);
+    const_iterator find(const String& name) const;
     bool getBoolean(const String& name, bool* output) const;
-    bool getInteger(const String& name, int* output) const;
-    bool getDouble(const String& name, double* output) const;
+    template<class T> bool getNumber(const String& name, T* output) const
+    {
+        RefPtr<JSONValue> value = get(name);
+        if (!value)
+            return false;
+        return value->asNumber(output);
+    }
     bool getString(const String& name, String* output) const;
-
-    JSONObject* getObject(const String& name) const;
-    JSONArray* getArray(const String& name) const;
-    JSONValue* get(const String& name) const;
-    Entry at(size_t index) const;
+    PassRefPtr<JSONObject> getObject(const String& name) const;
+    PassRefPtr<JSONArray> getArray(const String& name) const;
+    PassRefPtr<JSONValue> get(const String& name) const;
 
     bool booleanProperty(const String& name, bool defaultValue) const;
-    int integerProperty(const String& name, int defaultValue) const;
-    double doubleProperty(const String& name, double defaultValue) const;
+
     void remove(const String& name);
 
+    iterator begin() { return m_data.begin(); }
+    iterator end() { return m_data.end(); }
+    const_iterator begin() const { return m_data.begin(); }
+    const_iterator end() const { return m_data.end(); }
     ~JSONObject() override;
 
 protected:
@@ -219,60 +225,54 @@ protected:
 
 private:
     JSONObject();
-    template<typename T>
-    void set(const String& key, std::unique_ptr<T>& value)
-    {
-        DCHECK(value);
-        if (m_data.set(key, std::move(value)).isNewEntry)
-            m_order.append(key);
-    }
 
-    using Dictionary = HashMap<String, std::unique_ptr<JSONValue>>;
     Dictionary m_data;
     Vector<String> m_order;
 };
 
 class PLATFORM_EXPORT JSONArray : public JSONValue {
 public:
-    static std::unique_ptr<JSONArray> create()
+    typedef Vector<RefPtr<JSONValue>>::iterator iterator;
+    typedef Vector<RefPtr<JSONValue>>::const_iterator const_iterator;
+
+    static PassRefPtr<JSONArray> create()
     {
-        return wrapUnique(new JSONArray());
+        return adoptRef(new JSONArray());
     }
 
-    static JSONArray* cast(JSONValue* value)
+    static PassRefPtr<JSONArray> cast(PassRefPtr<JSONValue> value)
     {
         if (!value || value->getType() != TypeArray)
             return nullptr;
-        return static_cast<JSONArray*>(value);
-    }
-
-    static std::unique_ptr<JSONArray> cast(std::unique_ptr<JSONValue> value)
-    {
-        return wrapUnique(JSONArray::cast(value.release()));
+        return adoptRef(static_cast<JSONArray*>(value.leakRef()));
     }
 
     ~JSONArray() override;
 
     void writeJSON(StringBuilder* output) const override;
-    std::unique_ptr<JSONValue> clone() const override;
 
     void pushBoolean(bool);
-    void pushInteger(int);
-    void pushDouble(double);
+    void pushInt(int);
+    void pushNumber(double);
     void pushString(const String&);
-    void pushValue(std::unique_ptr<JSONValue>);
-    void pushObject(std::unique_ptr<JSONObject>);
-    void pushArray(std::unique_ptr<JSONArray>);
+    void pushValue(PassRefPtr<JSONValue>);
+    void pushObject(PassRefPtr<JSONObject>);
+    void pushArray(PassRefPtr<JSONArray>);
+
+    PassRefPtr<JSONValue> get(size_t index);
+    unsigned length() const { return m_data.size(); }
 
-    JSONValue* at(size_t index);
-    size_t size() const { return m_data.size(); }
+    iterator begin() { return m_data.begin(); }
+    iterator end() { return m_data.end(); }
+    const_iterator begin() const { return m_data.begin(); }
+    const_iterator end() const { return m_data.end(); }
 
 protected:
     void prettyWriteJSONInternal(StringBuilder* output, int depth) const override;
 
 private:
     JSONArray();
-    Vector<std::unique_ptr<JSONValue>> m_data;
+    Vector<RefPtr<JSONValue>> m_data;
 };
 
 PLATFORM_EXPORT void escapeStringForJSON(const String&, StringBuilder*);
diff --git a/third_party/WebKit/Source/platform/MIMETypeRegistry.cpp b/third_party/WebKit/Source/platform/MIMETypeRegistry.cpp
index 25a995a..11aa2de 100644
--- a/third_party/WebKit/Source/platform/MIMETypeRegistry.cpp
+++ b/third_party/WebKit/Source/platform/MIMETypeRegistry.cpp
@@ -55,7 +55,14 @@ String MIMETypeRegistry::getMIMETypeForPath(const String& path)
         return "application/octet-stream";
     String extension = path.substring(pos + 1);
     String mimeType = getMIMETypeForExtension(extension);
-    return mimeType.isEmpty() ? "application/octet-stream" : mimeType;
+    if (mimeType.isEmpty()) {
+        // If there's no mimetype registered for the extension, check to see
+        // if a plugin can handle the extension.
+        mimeType = getPluginMimeTypeFromExtension(extension);
+    }
+    if (mimeType.isEmpty())
+        return "application/octet-stream";
+    return mimeType;
 }
 
 bool MIMETypeRegistry::isSupportedImageMIMEType(const String& mimeType)
diff --git a/third_party/WebKit/Source/platform/RuntimeEnabledFeatures.in b/third_party/WebKit/Source/platform/RuntimeEnabledFeatures.in
index 583ded6..659fc29 100644
--- a/third_party/WebKit/Source/platform/RuntimeEnabledFeatures.in
+++ b/third_party/WebKit/Source/platform/RuntimeEnabledFeatures.in
@@ -73,6 +73,7 @@ CustomSchemeHandler depends_on=NavigatorContentUtils, status=experimental
 Database status=stable
 DecodeToYUV status=experimental
 DeviceLight status=experimental
+DisableBlockingMethodsDuringMicrotasks status=experimental
 DisplayList2dCanvas status=stable
 DocumentWriteEvaluator
 DOMConvenienceAPI status=stable
@@ -110,6 +111,7 @@ IntersectionObserver status=stable
 LangAttributeAwareFormControlUI
 LayoutNG
 LinkPreload status=stable
+LinkHeader status=stable
 LinkServiceWorker status=experimental
 FractionalScrollOffsets
 MediaCapture
diff --git a/third_party/WebKit/Source/platform/ScriptForbiddenScope.cpp b/third_party/WebKit/Source/platform/ScriptForbiddenScope.cpp
index b9f234c..3274d0b 100644
--- a/third_party/WebKit/Source/platform/ScriptForbiddenScope.cpp
+++ b/third_party/WebKit/Source/platform/ScriptForbiddenScope.cpp
@@ -8,6 +8,56 @@
 
 namespace blink {
 
-unsigned ScriptForbiddenScope::s_scriptForbiddenCount = 0;
+static unsigned s_scriptForbiddenCount = 0;
 
+ScriptForbiddenScope::ScriptForbiddenScope()
+{
+    enter();
+}
+
+ScriptForbiddenScope::~ScriptForbiddenScope()
+{
+    exit();
+}
+
+void ScriptForbiddenScope::enter()
+{
+    ASSERT(isMainThread());
+    ++s_scriptForbiddenCount;
+}
+
+void ScriptForbiddenScope::exit()
+{
+    ASSERT(isMainThread());
+    ASSERT(s_scriptForbiddenCount);
+    --s_scriptForbiddenCount;
+}
+
+bool ScriptForbiddenScope::isScriptForbidden()
+{
+    return isMainThread() && s_scriptForbiddenCount;
+}
+
+ScriptForbiddenScope::AllowUserAgentScript::AllowUserAgentScript()
+{
+    if (isMainThread())
+        m_change.emplace(&s_scriptForbiddenCount, 0);
+}
+
+ScriptForbiddenScope::AllowUserAgentScript::~AllowUserAgentScript()
+{
+    ASSERT(!isMainThread() || !s_scriptForbiddenCount);
+}
+
+ScriptForbiddenIfMainThreadScope::ScriptForbiddenIfMainThreadScope()
+{
+    if (isMainThread())
+        ScriptForbiddenScope::enter();
+}
+
+ScriptForbiddenIfMainThreadScope::~ScriptForbiddenIfMainThreadScope()
+{
+    if (isMainThread())
+        ScriptForbiddenScope::exit();
+}
 } // namespace blink
diff --git a/third_party/WebKit/Source/platform/ScriptForbiddenScope.h b/third_party/WebKit/Source/platform/ScriptForbiddenScope.h
index 52b85d8..4a8e814 100644
--- a/third_party/WebKit/Source/platform/ScriptForbiddenScope.h
+++ b/third_party/WebKit/Source/platform/ScriptForbiddenScope.h
@@ -18,44 +18,22 @@ class PLATFORM_EXPORT ScriptForbiddenScope final {
     STACK_ALLOCATED();
     WTF_MAKE_NONCOPYABLE(ScriptForbiddenScope);
 public:
-    ScriptForbiddenScope() { enter(); }
-    ~ScriptForbiddenScope() { exit(); }
+    ScriptForbiddenScope();
+    ~ScriptForbiddenScope();
 
     class PLATFORM_EXPORT AllowUserAgentScript final {
         STACK_ALLOCATED();
         WTF_MAKE_NONCOPYABLE(AllowUserAgentScript);
     public:
-        AllowUserAgentScript()
-        {
-            if (isMainThread())
-                m_change.emplace(&s_scriptForbiddenCount, 0);
-        }
-        ~AllowUserAgentScript()
-        {
-            DCHECK(!isMainThread() || !s_scriptForbiddenCount);
-        }
-
+        AllowUserAgentScript();
+        ~AllowUserAgentScript();
     private:
         Optional<AutoReset<unsigned>> m_change;
     };
 
-    static void enter()
-    {
-        DCHECK(isMainThread());
-        ++s_scriptForbiddenCount;
-    }
-    static void exit()
-    {
-        DCHECK(s_scriptForbiddenCount);
-        --s_scriptForbiddenCount;
-    }
-    static bool isScriptForbidden()
-    {
-        return isMainThread() && s_scriptForbiddenCount;
-    }
-
-private:
-    static unsigned s_scriptForbiddenCount;
+    static void enter();
+    static void exit();
+    static bool isScriptForbidden();
 };
 
 // Scoped disabling of script execution on the main thread,
@@ -69,18 +47,8 @@ class PLATFORM_EXPORT ScriptForbiddenIfMainThreadScope final {
     STACK_ALLOCATED();
     WTF_MAKE_NONCOPYABLE(ScriptForbiddenIfMainThreadScope);
 public:
-    ScriptForbiddenIfMainThreadScope()
-    {
-        m_IsMainThread = isMainThread();
-        if (m_IsMainThread)
-            ScriptForbiddenScope::enter();
-    }
-    ~ScriptForbiddenIfMainThreadScope()
-    {
-        if (m_IsMainThread)
-            ScriptForbiddenScope::exit();
-    }
-    bool m_IsMainThread;
+    ScriptForbiddenIfMainThreadScope();
+    ~ScriptForbiddenIfMainThreadScope();
 };
 
 } // namespace blink
diff --git a/third_party/WebKit/Source/platform/blink_platform.gypi b/third_party/WebKit/Source/platform/blink_platform.gypi
index 47b6819..acb4a34 100644
--- a/third_party/WebKit/Source/platform/blink_platform.gypi
+++ b/third_party/WebKit/Source/platform/blink_platform.gypi
@@ -42,8 +42,6 @@
       'Histogram.cpp',
       'Histogram.h',
       'HostWindow.h',
-      'JSONParser.cpp',
-      'JSONParser.h',
       'JSONValues.cpp',
       'JSONValues.h',
       'KeyboardCodes.h',
@@ -1155,7 +1153,6 @@
       'LayoutLocaleTest.cpp',
       'LayoutUnitTest.cpp',
       'LifecycleContextTest.cpp',
-      'JSONParserTest.cpp',
       'PODArenaTest.cpp',
       'PODFreeListArenaTest.cpp',
       'PODIntervalTreeTest.cpp',
diff --git a/third_party/WebKit/Source/platform/graphics/Color.cpp b/third_party/WebKit/Source/platform/graphics/Color.cpp
index 3ba79ed..cc973b6 100644
--- a/third_party/WebKit/Source/platform/graphics/Color.cpp
+++ b/third_party/WebKit/Source/platform/graphics/Color.cpp
@@ -212,7 +212,10 @@ String Color::serializedAsCSSComponentValue() const
     result.appendNumber(static_cast<unsigned char>(blue()));
     if (colorHasAlpha) {
         result.append(", ");
-        result.appendNumber(alpha() / 255.0f, 6);
+
+        NumberToStringBuffer buffer;
+        const char* alphaString = numberToFixedPrecisionString(alpha() / 255.0f, 6, buffer, true);
+        result.append(alphaString, strlen(alphaString));
     }
 
     result.append(')');
diff --git a/third_party/WebKit/Source/platform/graphics/CompositingReasons.h b/third_party/WebKit/Source/platform/graphics/CompositingReasons.h
index 48e61ea..c176a29 100644
--- a/third_party/WebKit/Source/platform/graphics/CompositingReasons.h
+++ b/third_party/WebKit/Source/platform/graphics/CompositingReasons.h
@@ -79,6 +79,8 @@ const uint64_t CompositingReasonInlineTransform                          = UINT6
 
 const uint64_t CompositingReasonCompositorProxy                          = UINT64_C(1) << 49;
 
+const uint64_t CompositingReasonRequestVisibility                        = UINT64_C(1) << 50;
+
 // Various combinations of compositing reasons are defined here also, for more intutive and faster bitwise logic.
 const uint64_t CompositingReasonComboAllDirectReasons =
     CompositingReason3DTransform
@@ -96,7 +98,8 @@ const uint64_t CompositingReasonComboAllDirectReasons =
     | CompositingReasonVideoOverlay
     | CompositingReasonWillChangeCompositingHint
     | CompositingReasonCompositorProxy
-    | CompositingReasonBackdropFilter;
+    | CompositingReasonBackdropFilter
+    | CompositingReasonRequestVisibility;
 
 const uint64_t CompositingReasonComboAllDirectStyleDeterminedReasons =
     CompositingReason3DTransform
@@ -105,7 +108,8 @@ const uint64_t CompositingReasonComboAllDirectStyleDeterminedReasons =
     | CompositingReasonTransitionProperty
     | CompositingReasonWillChangeCompositingHint
     | CompositingReasonCompositorProxy
-    | CompositingReasonBackdropFilter;
+    | CompositingReasonBackdropFilter
+    | CompositingReasonRequestVisibility;
 
 const uint64_t CompositingReasonComboCompositedDescendants =
     CompositingReasonTransformWithCompositedDescendants
@@ -116,7 +120,8 @@ const uint64_t CompositingReasonComboCompositedDescendants =
     | CompositingReasonBlendingWithCompositedDescendants
     | CompositingReasonReflectionWithCompositedDescendants
     | CompositingReasonClipsCompositingDescendants
-    | CompositingReasonPositionFixedWithCompositedDescendants;
+    | CompositingReasonPositionFixedWithCompositedDescendants
+    | CompositingReasonRequestVisibility;
 
 const uint64_t CompositingReasonCombo3DDescendants =
     CompositingReasonPreserve3DWith3DDescendants
@@ -126,7 +131,8 @@ const uint64_t CompositingReasonComboAllStyleDeterminedReasons =
     CompositingReasonComboAllDirectStyleDeterminedReasons
     | CompositingReasonComboCompositedDescendants
     | CompositingReasonCombo3DDescendants
-    | CompositingReasonInlineTransform;
+    | CompositingReasonInlineTransform
+    | CompositingReasonRequestVisibility;
 
 const uint64_t CompositingReasonComboReasonsThatRequireOwnBacking =
     CompositingReasonComboAllDirectReasons
@@ -142,7 +148,8 @@ const uint64_t CompositingReasonComboReasonsThatRequireOwnBacking =
     | CompositingReasonIsolateCompositedDescendants
     | CompositingReasonPreserve3DWith3DDescendants // preserve-3d has to create backing store to ensure that 3d-transformed elements intersect.
     | CompositingReasonBackdropFilter
-    | CompositingReasonPositionFixedWithCompositedDescendants;
+    | CompositingReasonPositionFixedWithCompositedDescendants
+    | CompositingReasonRequestVisibility;
 
 const uint64_t CompositingReasonComboSquashableReasons =
     CompositingReasonOverlap
diff --git a/third_party/WebKit/Source/platform/graphics/GraphicsLayer.cpp b/third_party/WebKit/Source/platform/graphics/GraphicsLayer.cpp
index e2d0901..6b2e4e6 100644
--- a/third_party/WebKit/Source/platform/graphics/GraphicsLayer.cpp
+++ b/third_party/WebKit/Source/platform/graphics/GraphicsLayer.cpp
@@ -133,6 +133,7 @@ GraphicsLayer::GraphicsLayer(GraphicsLayerClient* client)
     , m_isTrackingPaintInvalidations(client && client->isTrackingPaintInvalidations())
     , m_paintingPhase(GraphicsLayerPaintAllWithOverflowClip)
     , m_parent(0)
+    , m_crossroot_parent(0)
     , m_maskLayer(0)
     , m_contentsClippingMaskLayer(0)
     , m_replicaLayer(0)
@@ -196,6 +197,12 @@ void GraphicsLayer::setParent(GraphicsLayer* layer)
     m_parent = layer;
 }
 
+void GraphicsLayer::setCrossrootParent(GraphicsLayer* layer)
+{
+    ASSERT(!layer || !layer->hasAncestor(this));
+    m_crossroot_parent = layer;
+}
+
 #if ENABLE(ASSERT)
 
 bool GraphicsLayer::hasAncestor(GraphicsLayer* ancestor) const
@@ -289,6 +296,16 @@ void GraphicsLayer::removeFromParent()
     platformLayer()->removeFromParent();
 }
 
+void GraphicsLayer::removeFromCrossrootParent()
+{
+    if (m_crossroot_parent) {
+        // We use reverseFind so that removeAllChildren() isn't n^2.
+        m_crossroot_parent->m_children.remove(m_crossroot_parent->m_children.reverseFind(this));
+        setParent(0);
+    }
+    platformLayer()->removeFromParent();
+}
+
 void GraphicsLayer::setReplicatedByLayer(GraphicsLayer* layer)
 {
     // FIXME: this could probably be a full early exit.
@@ -618,31 +635,31 @@ static bool comparePaintInvalidationInfo(const PaintInvalidationInfo& a, const P
 }
 
 template <typename T>
-static std::unique_ptr<JSONArray> pointAsJSONArray(const T& point)
+static PassRefPtr<JSONArray> pointAsJSONArray(const T& point)
 {
-    std::unique_ptr<JSONArray> array = JSONArray::create();
-    array->pushDouble(point.x());
-    array->pushDouble(point.y());
+    RefPtr<JSONArray> array = JSONArray::create();
+    array->pushNumber(point.x());
+    array->pushNumber(point.y());
     return array;
 }
 
 template <typename T>
-static std::unique_ptr<JSONArray> sizeAsJSONArray(const T& size)
+static PassRefPtr<JSONArray> sizeAsJSONArray(const T& size)
 {
-    std::unique_ptr<JSONArray> array = JSONArray::create();
-    array->pushDouble(size.width());
-    array->pushDouble(size.height());
+    RefPtr<JSONArray> array = JSONArray::create();
+    array->pushNumber(size.width());
+    array->pushNumber(size.height());
     return array;
 }
 
 template <typename T>
-static std::unique_ptr<JSONArray> rectAsJSONArray(const T& rect)
+static PassRefPtr<JSONArray> rectAsJSONArray(const T& rect)
 {
-    std::unique_ptr<JSONArray> array = JSONArray::create();
-    array->pushDouble(rect.x());
-    array->pushDouble(rect.y());
-    array->pushDouble(rect.width());
-    array->pushDouble(rect.height());
+    RefPtr<JSONArray> array = JSONArray::create();
+    array->pushNumber(rect.x());
+    array->pushNumber(rect.y());
+    array->pushNumber(rect.width());
+    array->pushNumber(rect.height());
     return array;
 }
 
@@ -651,40 +668,40 @@ static double roundCloseToZero(double number)
     return std::abs(number) < 1e-7 ? 0 : number;
 }
 
-static std::unique_ptr<JSONArray> transformAsJSONArray(const TransformationMatrix& t)
+static PassRefPtr<JSONArray> transformAsJSONArray(const TransformationMatrix& t)
 {
-    std::unique_ptr<JSONArray> array = JSONArray::create();
+    RefPtr<JSONArray> array = JSONArray::create();
     {
-        std::unique_ptr<JSONArray> row = JSONArray::create();
-        row->pushDouble(roundCloseToZero(t.m11()));
-        row->pushDouble(roundCloseToZero(t.m12()));
-        row->pushDouble(roundCloseToZero(t.m13()));
-        row->pushDouble(roundCloseToZero(t.m14()));
-        array->pushArray(std::move(row));
+        RefPtr<JSONArray> row = JSONArray::create();
+        row->pushNumber(roundCloseToZero(t.m11()));
+        row->pushNumber(roundCloseToZero(t.m12()));
+        row->pushNumber(roundCloseToZero(t.m13()));
+        row->pushNumber(roundCloseToZero(t.m14()));
+        array->pushArray(row);
     }
     {
-        std::unique_ptr<JSONArray> row = JSONArray::create();
-        row->pushDouble(roundCloseToZero(t.m21()));
-        row->pushDouble(roundCloseToZero(t.m22()));
-        row->pushDouble(roundCloseToZero(t.m23()));
-        row->pushDouble(roundCloseToZero(t.m24()));
-        array->pushArray(std::move(row));
+        RefPtr<JSONArray> row = JSONArray::create();
+        row->pushNumber(roundCloseToZero(t.m21()));
+        row->pushNumber(roundCloseToZero(t.m22()));
+        row->pushNumber(roundCloseToZero(t.m23()));
+        row->pushNumber(roundCloseToZero(t.m24()));
+        array->pushArray(row);
     }
     {
-        std::unique_ptr<JSONArray> row = JSONArray::create();
-        row->pushDouble(roundCloseToZero(t.m31()));
-        row->pushDouble(roundCloseToZero(t.m32()));
-        row->pushDouble(roundCloseToZero(t.m33()));
-        row->pushDouble(roundCloseToZero(t.m34()));
-        array->pushArray(std::move(row));
+        RefPtr<JSONArray> row = JSONArray::create();
+        row->pushNumber(roundCloseToZero(t.m31()));
+        row->pushNumber(roundCloseToZero(t.m32()));
+        row->pushNumber(roundCloseToZero(t.m33()));
+        row->pushNumber(roundCloseToZero(t.m34()));
+        array->pushArray(row);
     }
     {
-        std::unique_ptr<JSONArray> row = JSONArray::create();
-        row->pushDouble(roundCloseToZero(t.m41()));
-        row->pushDouble(roundCloseToZero(t.m42()));
-        row->pushDouble(roundCloseToZero(t.m43()));
-        row->pushDouble(roundCloseToZero(t.m44()));
-        array->pushArray(std::move(row));
+        RefPtr<JSONArray> row = JSONArray::create();
+        row->pushNumber(roundCloseToZero(t.m41()));
+        row->pushNumber(roundCloseToZero(t.m42()));
+        row->pushNumber(roundCloseToZero(t.m43()));
+        row->pushNumber(roundCloseToZero(t.m44()));
+        array->pushArray(row);
     }
     return array;
 }
@@ -696,15 +713,15 @@ static String pointerAsString(const void* ptr)
     return ts.release();
 }
 
-std::unique_ptr<JSONObject> GraphicsLayer::layerTreeAsJSON(LayerTreeFlags flags) const
+PassRefPtr<JSONObject> GraphicsLayer::layerTreeAsJSON(LayerTreeFlags flags) const
 {
     RenderingContextMap renderingContextMap;
     return layerTreeAsJSONInternal(flags, renderingContextMap);
 }
 
-std::unique_ptr<JSONObject> GraphicsLayer::layerTreeAsJSONInternal(LayerTreeFlags flags, RenderingContextMap& renderingContextMap) const
+PassRefPtr<JSONObject> GraphicsLayer::layerTreeAsJSONInternal(LayerTreeFlags flags, RenderingContextMap& renderingContextMap) const
 {
-    std::unique_ptr<JSONObject> json = JSONObject::create();
+    RefPtr<JSONObject> json = JSONObject::create();
 
     if (flags & LayerTreeIncludesDebugInfo)
         json->setString("this", pointerAsString(this));
@@ -721,7 +738,7 @@ std::unique_ptr<JSONObject> GraphicsLayer::layerTreeAsJSONInternal(LayerTreeFlag
         json->setArray("bounds", sizeAsJSONArray(m_size));
 
     if (m_opacity != 1)
-        json->setDouble("opacity", m_opacity);
+        json->setNumber("opacity", m_opacity);
 
     if (m_blendMode != WebBlendModeNormal)
         json->setString("blendMode", compositeOperatorName(CompositeSourceOver, m_blendMode));
@@ -743,7 +760,7 @@ std::unique_ptr<JSONObject> GraphicsLayer::layerTreeAsJSONInternal(LayerTreeFlag
         else
             contextId = it->value;
 
-        json->setInteger("3dRenderingContext", contextId);
+        json->setNumber("3dRenderingContext", contextId);
     }
 
     if (m_drawsContent)
@@ -776,37 +793,37 @@ std::unique_ptr<JSONObject> GraphicsLayer::layerTreeAsJSONInternal(LayerTreeFlag
             Vector<PaintInvalidationInfo>& infos = it->value.trackedPaintInvalidations;
             if (!infos.isEmpty()) {
                 std::sort(infos.begin(), infos.end(), &comparePaintInvalidationInfo);
-                std::unique_ptr<JSONArray> paintInvalidationsJSON = JSONArray::create();
+                RefPtr<JSONArray> paintInvalidationsJSON = JSONArray::create();
                 for (auto& info : infos) {
-                    std::unique_ptr<JSONObject> infoJSON = JSONObject::create();
+                    RefPtr<JSONObject> infoJSON = JSONObject::create();
                     infoJSON->setString("object", info.clientDebugName);
                     if (!info.rect.isEmpty())
                         infoJSON->setArray("rect", rectAsJSONArray(info.rect));
                     infoJSON->setString("reason", paintInvalidationReasonToString(info.reason));
-                    paintInvalidationsJSON->pushObject(std::move(infoJSON));
+                    paintInvalidationsJSON->pushObject(infoJSON);
                 }
-                json->setArray("paintInvalidations", std::move(paintInvalidationsJSON));
+                json->setArray("paintInvalidations", paintInvalidationsJSON);
             }
 #if DCHECK_IS_ON()
             Vector<UnderPaintInvalidation>& underPaintInvalidations = it->value.underPaintInvalidations;
             if (!underPaintInvalidations.isEmpty()) {
-                std::unique_ptr<JSONArray> underPaintInvalidationsJSON = JSONArray::create();
+                RefPtr<JSONArray> underPaintInvalidationsJSON = JSONArray::create();
                 for (auto& underPaintInvalidation : underPaintInvalidations) {
-                    std::unique_ptr<JSONObject> underPaintInvalidationJSON = JSONObject::create();
-                    underPaintInvalidationJSON->setDouble("x", underPaintInvalidation.x);
-                    underPaintInvalidationJSON->setDouble("y", underPaintInvalidation.x);
+                    RefPtr<JSONObject> underPaintInvalidationJSON = JSONObject::create();
+                    underPaintInvalidationJSON->setNumber("x", underPaintInvalidation.x);
+                    underPaintInvalidationJSON->setNumber("y", underPaintInvalidation.x);
                     underPaintInvalidationJSON->setString("oldPixel", Color(underPaintInvalidation.oldPixel).nameForLayoutTreeAsText());
                     underPaintInvalidationJSON->setString("newPixel", Color(underPaintInvalidation.newPixel).nameForLayoutTreeAsText());
-                    underPaintInvalidationsJSON->pushObject(std::move(underPaintInvalidationJSON));
+                    underPaintInvalidationsJSON->pushObject(underPaintInvalidationJSON);
                 }
-                json->setArray("underPaintInvalidations", std::move(underPaintInvalidationsJSON));
+                json->setArray("underPaintInvalidations", underPaintInvalidationsJSON);
             }
 #endif
         }
     }
 
     if ((flags & LayerTreeIncludesPaintingPhases) && m_paintingPhase) {
-        std::unique_ptr<JSONArray> paintingPhasesJSON = JSONArray::create();
+        RefPtr<JSONArray> paintingPhasesJSON = JSONArray::create();
         if (m_paintingPhase & GraphicsLayerPaintBackground)
             paintingPhasesJSON->pushString("GraphicsLayerPaintBackground");
         if (m_paintingPhase & GraphicsLayerPaintForeground)
@@ -819,7 +836,7 @@ std::unique_ptr<JSONObject> GraphicsLayer::layerTreeAsJSONInternal(LayerTreeFlag
             paintingPhasesJSON->pushString("GraphicsLayerPaintOverflowContents");
         if (m_paintingPhase & GraphicsLayerPaintCompositedScroll)
             paintingPhasesJSON->pushString("GraphicsLayerPaintCompositedScroll");
-        json->setArray("paintingPhases", std::move(paintingPhasesJSON));
+        json->setArray("paintingPhases", paintingPhasesJSON);
     }
 
     if (flags & LayerTreeIncludesClipAndScrollParents) {
@@ -831,26 +848,26 @@ std::unique_ptr<JSONObject> GraphicsLayer::layerTreeAsJSONInternal(LayerTreeFlag
 
     if (flags & (LayerTreeIncludesDebugInfo | LayerTreeIncludesCompositingReasons)) {
         bool debug = flags & LayerTreeIncludesDebugInfo;
-        std::unique_ptr<JSONArray> compositingReasonsJSON = JSONArray::create();
+        RefPtr<JSONArray> compositingReasonsJSON = JSONArray::create();
         for (size_t i = 0; i < kNumberOfCompositingReasons; ++i) {
             if (m_debugInfo.getCompositingReasons() & kCompositingReasonStringMap[i].reason)
                 compositingReasonsJSON->pushString(debug ? kCompositingReasonStringMap[i].description : kCompositingReasonStringMap[i].shortName);
         }
-        json->setArray("compositingReasons", std::move(compositingReasonsJSON));
+        json->setArray("compositingReasons", compositingReasonsJSON);
 
-        std::unique_ptr<JSONArray> squashingDisallowedReasonsJSON = JSONArray::create();
+        RefPtr<JSONArray> squashingDisallowedReasonsJSON = JSONArray::create();
         for (size_t i = 0; i < kNumberOfSquashingDisallowedReasons; ++i) {
             if (m_debugInfo.getSquashingDisallowedReasons() & kSquashingDisallowedReasonStringMap[i].reason)
                 squashingDisallowedReasonsJSON->pushString(debug ? kSquashingDisallowedReasonStringMap[i].description : kSquashingDisallowedReasonStringMap[i].shortName);
         }
-        json->setArray("squashingDisallowedReasons", std::move(squashingDisallowedReasonsJSON));
+        json->setArray("squashingDisallowedReasons", squashingDisallowedReasonsJSON);
     }
 
     if (m_children.size()) {
-        std::unique_ptr<JSONArray> childrenJSON = JSONArray::create();
+        RefPtr<JSONArray> childrenJSON = JSONArray::create();
         for (size_t i = 0; i < m_children.size(); i++)
             childrenJSON->pushObject(m_children[i]->layerTreeAsJSONInternal(flags, renderingContextMap));
-        json->setArray("children", std::move(childrenJSON));
+        json->setArray("children", childrenJSON);
     }
 
     return json;
diff --git a/third_party/WebKit/Source/platform/graphics/GraphicsLayer.h b/third_party/WebKit/Source/platform/graphics/GraphicsLayer.h
index 8a2c637..b220db8 100644
--- a/third_party/WebKit/Source/platform/graphics/GraphicsLayer.h
+++ b/third_party/WebKit/Source/platform/graphics/GraphicsLayer.h
@@ -87,6 +87,9 @@ public:
     GraphicsLayer* parent() const { return m_parent; }
     void setParent(GraphicsLayer*); // Internal use only.
 
+    GraphicsLayer* crossrootParent() const { return m_crossroot_parent; }
+    void setCrossrootParent(GraphicsLayer*); // Internal use only.
+
     const Vector<GraphicsLayer*>& children() const { return m_children; }
     // Returns true if the child list changed.
     bool setChildren(const GraphicsLayerVector&);
@@ -97,6 +100,7 @@ public:
 
     void removeAllChildren();
     void removeFromParent();
+    void removeFromCrossrootParent();
 
     GraphicsLayer* maskLayer() const { return m_maskLayer; }
     void setMaskLayer(GraphicsLayer*);
@@ -202,7 +206,7 @@ public:
     // pointers for the layers and timing data will be included in the returned string.
     String layerTreeAsText(LayerTreeFlags = LayerTreeNormal) const;
 
-    std::unique_ptr<JSONObject> layerTreeAsJSON(LayerTreeFlags) const;
+    PassRefPtr<JSONObject> layerTreeAsJSON(LayerTreeFlags) const;
 
     void setTracksPaintInvalidations(bool);
     bool isTrackingOrCheckingPaintInvalidations() const
@@ -296,7 +300,7 @@ private:
     WebLayer* contentsLayerIfRegistered();
 
     typedef HashMap<int, int> RenderingContextMap;
-    std::unique_ptr<JSONObject> layerTreeAsJSONInternal(LayerTreeFlags, RenderingContextMap&) const;
+    PassRefPtr<JSONObject> layerTreeAsJSONInternal(LayerTreeFlags, RenderingContextMap&) const;
 
 #if DCHECK_IS_ON()
     PassRefPtr<SkPicture> capturePicture();
@@ -342,6 +346,7 @@ private:
 
     Vector<GraphicsLayer*> m_children;
     GraphicsLayer* m_parent;
+    GraphicsLayer* m_crossroot_parent;
 
     GraphicsLayer* m_maskLayer; // Reference to mask layer. We don't own this.
     GraphicsLayer* m_contentsClippingMaskLayer; // Reference to clipping mask layer. We don't own this.
diff --git a/third_party/WebKit/Source/platform/graphics/ImageBuffer.cpp b/third_party/WebKit/Source/platform/graphics/ImageBuffer.cpp
index 53f34f2..9727558 100644
--- a/third_party/WebKit/Source/platform/graphics/ImageBuffer.cpp
+++ b/third_party/WebKit/Source/platform/graphics/ImageBuffer.cpp
@@ -254,9 +254,6 @@ bool ImageBuffer::copyToPlatformTexture(gpu::gles2::GLES2Interface* gl, GLuint t
     GLbyte syncToken[24];
     gl->GenSyncTokenCHROMIUM(contextFenceSync, syncToken);
     sharedGL->WaitSyncTokenCHROMIUM(syncToken);
-    // This disassociates the texture from the mailbox to avoid leaking the
-    // mapping between the two.
-    sharedGL->ProduceTextureDirectCHROMIUM(0, textureInfo->fTarget, mailbox->name);
 
     // Undo grContext texture binding changes introduced in this function
     provider->grContext()->resetContext(kTextureBinding_GrGLBackendState);
diff --git a/third_party/WebKit/Source/platform/graphics/ImagePattern.cpp b/third_party/WebKit/Source/platform/graphics/ImagePattern.cpp
index e2aca3c..ffcf538 100644
--- a/third_party/WebKit/Source/platform/graphics/ImagePattern.cpp
+++ b/third_party/WebKit/Source/platform/graphics/ImagePattern.cpp
@@ -22,7 +22,6 @@ ImagePattern::ImagePattern(PassRefPtr<Image> image, RepeatMode repeatMode)
     : Pattern(repeatMode)
     , m_tileImage(toSkSp(image->imageForCurrentFrame()))
 {
-    m_previousLocalMatrix.setIdentity();
     if (m_tileImage) {
         // TODO(fmalita): mechanism to extract the actual SkImageInfo from an SkImage?
         const SkImageInfo info = SkImageInfo::MakeN32Premul(
diff --git a/third_party/WebKit/Source/platform/graphics/LoggingCanvas.cpp b/third_party/WebKit/Source/platform/graphics/LoggingCanvas.cpp
index 1f21f65..98c0397 100644
--- a/third_party/WebKit/Source/platform/graphics/LoggingCanvas.cpp
+++ b/third_party/WebKit/Source/platform/graphics/LoggingCanvas.cpp
@@ -62,24 +62,24 @@ struct VerbParams {
         , pointOffset(pointOffset) { }
 };
 
-std::unique_ptr<JSONObject> objectForSkRect(const SkRect& rect)
+PassRefPtr<JSONObject> objectForSkRect(const SkRect& rect)
 {
-    std::unique_ptr<JSONObject> rectItem = JSONObject::create();
-    rectItem->setDouble("left", rect.left());
-    rectItem->setDouble("top", rect.top());
-    rectItem->setDouble("right", rect.right());
-    rectItem->setDouble("bottom", rect.bottom());
-    return rectItem;
+    RefPtr<JSONObject> rectItem = JSONObject::create();
+    rectItem->setNumber("left", rect.left());
+    rectItem->setNumber("top", rect.top());
+    rectItem->setNumber("right", rect.right());
+    rectItem->setNumber("bottom", rect.bottom());
+    return rectItem.release();
 }
 
-std::unique_ptr<JSONObject> objectForSkIRect(const SkIRect& rect)
+PassRefPtr<JSONObject> objectForSkIRect(const SkIRect& rect)
 {
-    std::unique_ptr<JSONObject> rectItem = JSONObject::create();
-    rectItem->setDouble("left", rect.left());
-    rectItem->setDouble("top", rect.top());
-    rectItem->setDouble("right", rect.right());
-    rectItem->setDouble("bottom", rect.bottom());
-    return rectItem;
+    RefPtr<JSONObject> rectItem = JSONObject::create();
+    rectItem->setNumber("left", rect.left());
+    rectItem->setNumber("top", rect.top());
+    rectItem->setNumber("right", rect.right());
+    rectItem->setNumber("bottom", rect.bottom());
+    return rectItem.release();
 }
 
 String pointModeName(SkCanvas::PointMode mode)
@@ -94,29 +94,29 @@ String pointModeName(SkCanvas::PointMode mode)
     };
 }
 
-std::unique_ptr<JSONObject> objectForSkPoint(const SkPoint& point)
+PassRefPtr<JSONObject> objectForSkPoint(const SkPoint& point)
 {
-    std::unique_ptr<JSONObject> pointItem = JSONObject::create();
-    pointItem->setDouble("x", point.x());
-    pointItem->setDouble("y", point.y());
-    return pointItem;
+    RefPtr<JSONObject> pointItem = JSONObject::create();
+    pointItem->setNumber("x", point.x());
+    pointItem->setNumber("y", point.y());
+    return pointItem.release();
 }
 
-std::unique_ptr<JSONArray> arrayForSkPoints(size_t count, const SkPoint points[])
+PassRefPtr<JSONArray> arrayForSkPoints(size_t count, const SkPoint points[])
 {
-    std::unique_ptr<JSONArray> pointsArrayItem = JSONArray::create();
+    RefPtr<JSONArray> pointsArrayItem = JSONArray::create();
     for (size_t i = 0; i < count; ++i)
         pointsArrayItem->pushObject(objectForSkPoint(points[i]));
-    return pointsArrayItem;
+    return pointsArrayItem.release();
 }
 
-std::unique_ptr<JSONObject> objectForRadius(const SkRRect& rrect, SkRRect::Corner corner)
+PassRefPtr<JSONObject> objectForRadius(const SkRRect& rrect, SkRRect::Corner corner)
 {
-    std::unique_ptr<JSONObject> radiusItem = JSONObject::create();
+    RefPtr<JSONObject> radiusItem = JSONObject::create();
     SkVector radius = rrect.radii(corner);
-    radiusItem->setDouble("xRadius", radius.x());
-    radiusItem->setDouble("yRadius", radius.y());
-    return radiusItem;
+    radiusItem->setNumber("xRadius", radius.x());
+    radiusItem->setNumber("yRadius", radius.y());
+    return radiusItem.release();
 }
 
 String rrectTypeName(SkRRect::Type type)
@@ -147,17 +147,17 @@ String radiusName(SkRRect::Corner corner)
     }
 }
 
-std::unique_ptr<JSONObject> objectForSkRRect(const SkRRect& rrect)
+PassRefPtr<JSONObject> objectForSkRRect(const SkRRect& rrect)
 {
-    std::unique_ptr<JSONObject> rrectItem = JSONObject::create();
+    RefPtr<JSONObject> rrectItem = JSONObject::create();
     rrectItem->setString("type", rrectTypeName(rrect.type()));
-    rrectItem->setDouble("left", rrect.rect().left());
-    rrectItem->setDouble("top", rrect.rect().top());
-    rrectItem->setDouble("right", rrect.rect().right());
-    rrectItem->setDouble("bottom", rrect.rect().bottom());
+    rrectItem->setNumber("left", rrect.rect().left());
+    rrectItem->setNumber("top", rrect.rect().top());
+    rrectItem->setNumber("right", rrect.rect().right());
+    rrectItem->setNumber("bottom", rrect.rect().bottom());
     for (int i = 0; i < 4; ++i)
         rrectItem->setObject(radiusName((SkRRect::Corner) i), objectForRadius(rrect, (SkRRect::Corner) i));
-    return rrectItem;
+    return rrectItem.release();
 }
 
 String fillTypeName(SkPath::FillType type)
@@ -201,28 +201,28 @@ VerbParams segmentParams(SkPath::Verb verb)
     };
 }
 
-std::unique_ptr<JSONObject> objectForSkPath(const SkPath& path)
+PassRefPtr<JSONObject> objectForSkPath(const SkPath& path)
 {
-    std::unique_ptr<JSONObject> pathItem = JSONObject::create();
+    RefPtr<JSONObject> pathItem = JSONObject::create();
     pathItem->setString("fillType", fillTypeName(path.getFillType()));
     pathItem->setString("convexity", convexityName(path.getConvexity()));
     pathItem->setBoolean("isRect", path.isRect(0));
     SkPath::Iter iter(path, false);
     SkPoint points[4];
-    std::unique_ptr<JSONArray> pathPointsArray = JSONArray::create();
+    RefPtr<JSONArray> pathPointsArray = JSONArray::create();
     for (SkPath::Verb verb = iter.next(points, false); verb != SkPath::kDone_Verb; verb = iter.next(points, false)) {
         VerbParams verbParams = segmentParams(verb);
-        std::unique_ptr<JSONObject> pathPointItem = JSONObject::create();
+        RefPtr<JSONObject> pathPointItem = JSONObject::create();
         pathPointItem->setString("verb", verbParams.name);
         ASSERT(verbParams.pointCount + verbParams.pointOffset <= WTF_ARRAY_LENGTH(points));
         pathPointItem->setArray("points", arrayForSkPoints(verbParams.pointCount, points + verbParams.pointOffset));
         if (SkPath::kConic_Verb == verb)
-            pathPointItem->setDouble("conicWeight", iter.conicWeight());
-        pathPointsArray->pushObject(std::move(pathPointItem));
+            pathPointItem->setNumber("conicWeight", iter.conicWeight());
+        pathPointsArray->pushObject(pathPointItem);
     }
-    pathItem->setArray("pathPoints", std::move(pathPointsArray));
+    pathItem->setArray("pathPoints", pathPointsArray);
     pathItem->setObject("bounds", objectForSkRect(path.getBounds()));
-    return pathItem;
+    return pathItem.release();
 }
 
 String colorTypeName(SkColorType colorType)
@@ -240,7 +240,7 @@ String colorTypeName(SkColorType colorType)
     };
 }
 
-std::unique_ptr<JSONObject> objectForBitmapData(const SkBitmap& bitmap)
+PassRefPtr<JSONObject> objectForBitmapData(const SkBitmap& bitmap)
 {
     Vector<unsigned char> output;
 
@@ -252,51 +252,51 @@ std::unique_ptr<JSONObject> objectForBitmapData(const SkBitmap& bitmap)
         PNGImageEncoder::encode(imageData, &output);
     }
 
-    std::unique_ptr<JSONObject> dataItem = JSONObject::create();
+    RefPtr<JSONObject> dataItem = JSONObject::create();
     dataItem->setString("base64", WTF::base64Encode(reinterpret_cast<char*>(output.data()), output.size()));
     dataItem->setString("mimeType", "image/png");
-    return dataItem;
+    return dataItem.release();
 }
 
-std::unique_ptr<JSONObject> objectForSkBitmap(const SkBitmap& bitmap)
+PassRefPtr<JSONObject> objectForSkBitmap(const SkBitmap& bitmap)
 {
-    std::unique_ptr<JSONObject> bitmapItem = JSONObject::create();
-    bitmapItem->setInteger("width", bitmap.width());
-    bitmapItem->setInteger("height", bitmap.height());
+    RefPtr<JSONObject> bitmapItem = JSONObject::create();
+    bitmapItem->setNumber("width", bitmap.width());
+    bitmapItem->setNumber("height", bitmap.height());
     bitmapItem->setString("config", colorTypeName(bitmap.colorType()));
     bitmapItem->setBoolean("opaque", bitmap.isOpaque());
     bitmapItem->setBoolean("immutable", bitmap.isImmutable());
     bitmapItem->setBoolean("volatile", bitmap.isVolatile());
-    bitmapItem->setInteger("genID", bitmap.getGenerationID());
+    bitmapItem->setNumber("genID", bitmap.getGenerationID());
     bitmapItem->setObject("data", objectForBitmapData(bitmap));
-    return bitmapItem;
+    return bitmapItem.release();
 }
 
-std::unique_ptr<JSONObject> objectForSkImage(const SkImage* image)
+PassRefPtr<JSONObject> objectForSkImage(const SkImage* image)
 {
-    std::unique_ptr<JSONObject> imageItem = JSONObject::create();
-    imageItem->setInteger("width", image->width());
-    imageItem->setInteger("height", image->height());
+    RefPtr<JSONObject> imageItem = JSONObject::create();
+    imageItem->setNumber("width", image->width());
+    imageItem->setNumber("height", image->height());
     imageItem->setBoolean("opaque", image->isOpaque());
-    imageItem->setInteger("uniqueID", image->uniqueID());
-    return imageItem;
+    imageItem->setNumber("uniqueID", image->uniqueID());
+    return imageItem.release();
 }
 
-std::unique_ptr<JSONArray> arrayForSkMatrix(const SkMatrix& matrix)
+PassRefPtr<JSONArray> arrayForSkMatrix(const SkMatrix& matrix)
 {
-    std::unique_ptr<JSONArray> matrixArray = JSONArray::create();
+    RefPtr<JSONArray> matrixArray = JSONArray::create();
     for (int i = 0; i < 9; ++i)
-        matrixArray->pushDouble(matrix[i]);
-    return matrixArray;
+        matrixArray->pushNumber(matrix[i]);
+    return matrixArray.release();
 }
 
-std::unique_ptr<JSONObject> objectForSkShader(const SkShader& shader)
+PassRefPtr<JSONObject> objectForSkShader(const SkShader& shader)
 {
-    std::unique_ptr<JSONObject> shaderItem = JSONObject::create();
+    RefPtr<JSONObject> shaderItem = JSONObject::create();
     const SkMatrix localMatrix = shader.getLocalMatrix();
     if (!localMatrix.isIdentity())
         shaderItem->setArray("localMatrix", arrayForSkMatrix(localMatrix));
-    return shaderItem;
+    return shaderItem.release();
 }
 
 String stringForSkColor(const SkColor& color)
@@ -422,17 +422,17 @@ String hintingName(SkPaint::Hinting hinting)
     };
 }
 
-std::unique_ptr<JSONObject> objectForSkPaint(const SkPaint& paint)
+PassRefPtr<JSONObject> objectForSkPaint(const SkPaint& paint)
 {
-    std::unique_ptr<JSONObject> paintItem = JSONObject::create();
-    paintItem->setDouble("textSize", paint.getTextSize());
-    paintItem->setDouble("textScaleX", paint.getTextScaleX());
-    paintItem->setDouble("textSkewX", paint.getTextSkewX());
+    RefPtr<JSONObject> paintItem = JSONObject::create();
+    paintItem->setNumber("textSize", paint.getTextSize());
+    paintItem->setNumber("textScaleX", paint.getTextScaleX());
+    paintItem->setNumber("textSkewX", paint.getTextSkewX());
     if (SkShader* shader = paint.getShader())
         paintItem->setObject("shader", objectForSkShader(*shader));
     paintItem->setString("color", stringForSkColor(paint.getColor()));
-    paintItem->setDouble("strokeWidth", paint.getStrokeWidth());
-    paintItem->setDouble("strokeMiter", paint.getStrokeMiter());
+    paintItem->setNumber("strokeWidth", paint.getStrokeWidth());
+    paintItem->setNumber("strokeMiter", paint.getStrokeMiter());
     paintItem->setString("flags", stringForSkPaintFlags(paint));
     paintItem->setString("filterLevel", filterQualityName(paint.getFilterQuality()));
     paintItem->setString("textAlign", textAlignName(paint.getTextAlign()));
@@ -441,15 +441,15 @@ std::unique_ptr<JSONObject> objectForSkPaint(const SkPaint& paint)
     paintItem->setString("styleName", styleName(paint.getStyle()));
     paintItem->setString("textEncoding", textEncodingName(paint.getTextEncoding()));
     paintItem->setString("hinting", hintingName(paint.getHinting()));
-    return paintItem;
+    return paintItem.release();
 }
 
-std::unique_ptr<JSONArray> arrayForSkScalars(size_t n, const SkScalar scalars[])
+PassRefPtr<JSONArray> arrayForSkScalars(size_t n, const SkScalar scalars[])
 {
-    std::unique_ptr<JSONArray> scalarsArray = JSONArray::create();
+    RefPtr<JSONArray> scalarsArray = JSONArray::create();
     for (size_t i = 0; i < n; ++i)
-        scalarsArray->pushDouble(scalars[i]);
-    return scalarsArray;
+        scalarsArray->pushNumber(scalars[i]);
+    return scalarsArray.release();
 }
 
 String regionOpName(SkRegion::Op op)
@@ -514,32 +514,32 @@ class AutoLogger : InterceptingCanvasBase::CanvasInterceptorBase<LoggingCanvas>
 public:
     explicit AutoLogger(LoggingCanvas* canvas) : InterceptingCanvasBase::CanvasInterceptorBase<LoggingCanvas>(canvas) { }
 
-    JSONObject* logItem(const String& name);
-    JSONObject* logItemWithParams(const String& name);
+    PassRefPtr<JSONObject> logItem(const String& name);
+    PassRefPtr<JSONObject> logItemWithParams(const String& name);
     ~AutoLogger()
     {
         if (topLevelCall())
-            canvas()->m_log->pushObject(std::move(m_logItem));
+            canvas()->m_log->pushObject(m_logItem);
     }
 
 private:
-    std::unique_ptr<JSONObject> m_logItem;
+    RefPtr<JSONObject> m_logItem;
 };
 
-JSONObject* AutoLogger::logItem(const String& name)
+PassRefPtr<JSONObject> AutoLogger::logItem(const String& name)
 {
-    std::unique_ptr<JSONObject> item = JSONObject::create();
+    RefPtr<JSONObject> item = JSONObject::create();
     item->setString("method", name);
-    m_logItem = std::move(item);
-    return m_logItem.get();
+    m_logItem = item;
+    return item.release();
 }
 
-JSONObject* AutoLogger::logItemWithParams(const String& name)
+PassRefPtr<JSONObject> AutoLogger::logItemWithParams(const String& name)
 {
-    JSONObject* item = logItem(name);
-    std::unique_ptr<JSONObject> params = JSONObject::create();
-    item->setObject("params", std::move(params));
-    return item->getObject("params");
+    RefPtr<JSONObject> item = logItem(name);
+    RefPtr<JSONObject> params = JSONObject::create();
+    item->setObject("params", params);
+    return params.release();
 }
 
 LoggingCanvas::LoggingCanvas(int width, int height)
@@ -558,7 +558,7 @@ void LoggingCanvas::onDrawPaint(const SkPaint& paint)
 void LoggingCanvas::onDrawPoints(PointMode mode, size_t count, const SkPoint pts[], const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawPoints");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawPoints");
     params->setString("pointMode", pointModeName(mode));
     params->setArray("points", arrayForSkPoints(count, pts));
     params->setObject("paint", objectForSkPaint(paint));
@@ -568,7 +568,7 @@ void LoggingCanvas::onDrawPoints(PointMode mode, size_t count, const SkPoint pts
 void LoggingCanvas::onDrawRect(const SkRect& rect, const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawRect");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawRect");
     params->setObject("rect", objectForSkRect(rect));
     params->setObject("paint", objectForSkPaint(paint));
     this->SkCanvas::onDrawRect(rect, paint);
@@ -577,7 +577,7 @@ void LoggingCanvas::onDrawRect(const SkRect& rect, const SkPaint& paint)
 void LoggingCanvas::onDrawOval(const SkRect& oval, const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawOval");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawOval");
     params->setObject("oval", objectForSkRect(oval));
     params->setObject("paint", objectForSkPaint(paint));
     this->SkCanvas::onDrawOval(oval, paint);
@@ -586,7 +586,7 @@ void LoggingCanvas::onDrawOval(const SkRect& oval, const SkPaint& paint)
 void LoggingCanvas::onDrawRRect(const SkRRect& rrect, const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawRRect");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawRRect");
     params->setObject("rrect", objectForSkRRect(rrect));
     params->setObject("paint", objectForSkPaint(paint));
     this->SkCanvas::onDrawRRect(rrect, paint);
@@ -595,7 +595,7 @@ void LoggingCanvas::onDrawRRect(const SkRRect& rrect, const SkPaint& paint)
 void LoggingCanvas::onDrawPath(const SkPath& path, const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawPath");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawPath");
     params->setObject("path", objectForSkPath(path));
     params->setObject("paint", objectForSkPaint(paint));
     this->SkCanvas::onDrawPath(path, paint);
@@ -604,9 +604,9 @@ void LoggingCanvas::onDrawPath(const SkPath& path, const SkPaint& paint)
 void LoggingCanvas::onDrawBitmap(const SkBitmap& bitmap, SkScalar left, SkScalar top, const SkPaint* paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawBitmap");
-    params->setDouble("left", left);
-    params->setDouble("top", top);
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawBitmap");
+    params->setNumber("left", left);
+    params->setNumber("top", top);
     params->setObject("bitmap", objectForSkBitmap(bitmap));
     if (paint)
         params->setObject("paint", objectForSkPaint(*paint));
@@ -616,21 +616,21 @@ void LoggingCanvas::onDrawBitmap(const SkBitmap& bitmap, SkScalar left, SkScalar
 void LoggingCanvas::onDrawBitmapRect(const SkBitmap& bitmap, const SkRect* src, const SkRect& dst, const SkPaint* paint, SrcRectConstraint constraint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawBitmapRectToRect");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawBitmapRectToRect");
     params->setObject("bitmap", objectForSkBitmap(bitmap));
     if (src)
         params->setObject("src", objectForSkRect(*src));
     params->setObject("dst", objectForSkRect(dst));
     if (paint)
         params->setObject("paint", objectForSkPaint(*paint));
-    params->setInteger("flags", constraint);
+    params->setNumber("flags", constraint);
     this->SkCanvas::onDrawBitmapRect(bitmap, src, dst, paint, constraint);
 }
 
 void LoggingCanvas::onDrawBitmapNine(const SkBitmap& bitmap, const SkIRect& center, const SkRect& dst, const SkPaint* paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawBitmapNine");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawBitmapNine");
     params->setObject("bitmap", objectForSkBitmap(bitmap));
     params->setObject("center", objectForSkIRect(center));
     params->setObject("dst", objectForSkRect(dst));
@@ -642,9 +642,9 @@ void LoggingCanvas::onDrawBitmapNine(const SkBitmap& bitmap, const SkIRect& cent
 void LoggingCanvas::onDrawImage(const SkImage* image, SkScalar left, SkScalar top, const SkPaint* paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawImage");
-    params->setDouble("left", left);
-    params->setDouble("top", top);
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawImage");
+    params->setNumber("left", left);
+    params->setNumber("top", top);
     params->setObject("image", objectForSkImage(image));
     if (paint)
         params->setObject("paint", objectForSkPaint(*paint));
@@ -654,7 +654,7 @@ void LoggingCanvas::onDrawImage(const SkImage* image, SkScalar left, SkScalar to
 void LoggingCanvas::onDrawImageRect(const SkImage* image, const SkRect* src, const SkRect& dst, const SkPaint* paint, SrcRectConstraint constraint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawImageRect");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawImageRect");
     params->setObject("image", objectForSkImage(image));
     if (src)
         params->setObject("src", objectForSkRect(*src));
@@ -668,7 +668,7 @@ void LoggingCanvas::onDrawVertices(VertexMode vmode, int vertexCount, const SkPo
     const uint16_t indices[], int indexCount, const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawVertices");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawVertices");
     params->setObject("paint", objectForSkPaint(paint));
     this->SkCanvas::onDrawVertices(vmode, vertexCount, vertices, texs, colors, xmode, indices, indexCount, paint);
 }
@@ -676,7 +676,7 @@ void LoggingCanvas::onDrawVertices(VertexMode vmode, int vertexCount, const SkPo
 void LoggingCanvas::onDrawDRRect(const SkRRect& outer, const SkRRect& inner, const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawDRRect");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawDRRect");
     params->setObject("outer", objectForSkRRect(outer));
     params->setObject("inner", objectForSkRRect(inner));
     params->setObject("paint", objectForSkPaint(paint));
@@ -686,10 +686,10 @@ void LoggingCanvas::onDrawDRRect(const SkRRect& outer, const SkRRect& inner, con
 void LoggingCanvas::onDrawText(const void* text, size_t byteLength, SkScalar x, SkScalar y, const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawText");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawText");
     params->setString("text", stringForText(text, byteLength, paint));
-    params->setDouble("x", x);
-    params->setDouble("y", y);
+    params->setNumber("x", x);
+    params->setNumber("y", y);
     params->setObject("paint", objectForSkPaint(paint));
     this->SkCanvas::onDrawText(text, byteLength, x, y, paint);
 }
@@ -697,7 +697,7 @@ void LoggingCanvas::onDrawText(const void* text, size_t byteLength, SkScalar x,
 void LoggingCanvas::onDrawPosText(const void* text, size_t byteLength, const SkPoint pos[], const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawPosText");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawPosText");
     params->setString("text", stringForText(text, byteLength, paint));
     size_t pointsCount = paint.countText(text, byteLength);
     params->setArray("pos", arrayForSkPoints(pointsCount, pos));
@@ -708,11 +708,11 @@ void LoggingCanvas::onDrawPosText(const void* text, size_t byteLength, const SkP
 void LoggingCanvas::onDrawPosTextH(const void* text, size_t byteLength, const SkScalar xpos[], SkScalar constY, const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawPosTextH");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawPosTextH");
     params->setString("text", stringForText(text, byteLength, paint));
     size_t pointsCount = paint.countText(text, byteLength);
     params->setArray("xpos", arrayForSkScalars(pointsCount, xpos));
-    params->setDouble("constY", constY);
+    params->setNumber("constY", constY);
     params->setObject("paint", objectForSkPaint(paint));
     this->SkCanvas::onDrawPosTextH(text, byteLength, xpos, constY, paint);
 }
@@ -720,7 +720,7 @@ void LoggingCanvas::onDrawPosTextH(const void* text, size_t byteLength, const Sk
 void LoggingCanvas::onDrawTextOnPath(const void* text, size_t byteLength, const SkPath& path, const SkMatrix* matrix, const SkPaint& paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawTextOnPath");
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawTextOnPath");
     params->setString("text", stringForText(text, byteLength, paint));
     params->setObject("path", objectForSkPath(path));
     if (matrix)
@@ -732,9 +732,9 @@ void LoggingCanvas::onDrawTextOnPath(const void* text, size_t byteLength, const
 void LoggingCanvas::onDrawTextBlob(const SkTextBlob *blob, SkScalar x, SkScalar y, const SkPaint &paint)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("drawTextBlob");
-    params->setDouble("x", x);
-    params->setDouble("y", y);
+    RefPtr<JSONObject> params = logger.logItemWithParams("drawTextBlob");
+    params->setNumber("x", x);
+    params->setNumber("y", y);
     params->setObject("paint", objectForSkPaint(paint));
     this->SkCanvas::onDrawTextBlob(blob, x, y, paint);
 }
@@ -742,7 +742,7 @@ void LoggingCanvas::onDrawTextBlob(const SkTextBlob *blob, SkScalar x, SkScalar
 void LoggingCanvas::onClipRect(const SkRect& rect, SkRegion::Op op, ClipEdgeStyle style)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("clipRect");
+    RefPtr<JSONObject> params = logger.logItemWithParams("clipRect");
     params->setObject("rect", objectForSkRect(rect));
     params->setString("SkRegion::Op", regionOpName(op));
     params->setBoolean("softClipEdgeStyle", kSoft_ClipEdgeStyle == style);
@@ -752,7 +752,7 @@ void LoggingCanvas::onClipRect(const SkRect& rect, SkRegion::Op op, ClipEdgeStyl
 void LoggingCanvas::onClipRRect(const SkRRect& rrect, SkRegion::Op op, ClipEdgeStyle style)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("clipRRect");
+    RefPtr<JSONObject> params = logger.logItemWithParams("clipRRect");
     params->setObject("rrect", objectForSkRRect(rrect));
     params->setString("SkRegion::Op", regionOpName(op));
     params->setBoolean("softClipEdgeStyle", kSoft_ClipEdgeStyle == style);
@@ -762,7 +762,7 @@ void LoggingCanvas::onClipRRect(const SkRRect& rrect, SkRegion::Op op, ClipEdgeS
 void LoggingCanvas::onClipPath(const SkPath& path, SkRegion::Op op, ClipEdgeStyle style)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("clipPath");
+    RefPtr<JSONObject> params = logger.logItemWithParams("clipPath");
     params->setObject("path", objectForSkPath(path));
     params->setString("SkRegion::Op", regionOpName(op));
     params->setBoolean("softClipEdgeStyle", kSoft_ClipEdgeStyle == style);
@@ -772,7 +772,7 @@ void LoggingCanvas::onClipPath(const SkPath& path, SkRegion::Op op, ClipEdgeStyl
 void LoggingCanvas::onClipRegion(const SkRegion& region, SkRegion::Op op)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("clipRegion");
+    RefPtr<JSONObject> params = logger.logItemWithParams("clipRegion");
     params->setString("op", regionOpName(op));
     this->SkCanvas::onClipRegion(region, op);
 }
@@ -785,7 +785,7 @@ void LoggingCanvas::onDrawPicture(const SkPicture* picture, const SkMatrix* matr
 void LoggingCanvas::didSetMatrix(const SkMatrix& matrix)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("setMatrix");
+    RefPtr<JSONObject> params = logger.logItemWithParams("setMatrix");
     params->setArray("matrix", arrayForSkMatrix(matrix));
     this->SkCanvas::didSetMatrix(matrix);
 }
@@ -793,19 +793,19 @@ void LoggingCanvas::didSetMatrix(const SkMatrix& matrix)
 void LoggingCanvas::didConcat(const SkMatrix& matrix)
 {
     AutoLogger logger(this);
-    JSONObject* params;
+    RefPtr<JSONObject> params;
 
     switch (matrix.getType()) {
     case SkMatrix::kTranslate_Mask:
         params = logger.logItemWithParams("translate");
-        params->setDouble("dx", matrix.getTranslateX());
-        params->setDouble("dy", matrix.getTranslateY());
+        params->setNumber("dx", matrix.getTranslateX());
+        params->setNumber("dy", matrix.getTranslateY());
         break;
 
     case SkMatrix::kScale_Mask:
         params = logger.logItemWithParams("scale");
-        params->setDouble("scaleX", matrix.getScaleX());
-        params->setDouble("scaleY", matrix.getScaleY());
+        params->setNumber("scaleX", matrix.getScaleX());
+        params->setNumber("scaleY", matrix.getScaleY());
         break;
 
     default:
@@ -818,14 +818,14 @@ void LoggingCanvas::didConcat(const SkMatrix& matrix)
 void LoggingCanvas::willSave()
 {
     AutoLogger logger(this);
-    logger.logItem("save");
+    RefPtr<JSONObject> params = logger.logItem("save");
     this->SkCanvas::willSave();
 }
 
 SkCanvas::SaveLayerStrategy LoggingCanvas::getSaveLayerStrategy(const SaveLayerRec& rec)
 {
     AutoLogger logger(this);
-    JSONObject* params = logger.logItemWithParams("saveLayer");
+    RefPtr<JSONObject> params = logger.logItemWithParams("saveLayer");
     if (rec.fBounds)
         params->setObject("bounds", objectForSkRect(*rec.fBounds));
     if (rec.fPaint)
@@ -841,9 +841,9 @@ void LoggingCanvas::willRestore()
     this->SkCanvas::willRestore();
 }
 
-std::unique_ptr<JSONArray> LoggingCanvas::log()
+PassRefPtr<JSONArray> LoggingCanvas::log()
 {
-    return JSONArray::cast(m_log->clone());
+    return m_log;
 }
 
 #ifndef NDEBUG
@@ -852,9 +852,10 @@ String pictureAsDebugString(const SkPicture* picture)
     const SkIRect bounds = picture->cullRect().roundOut();
     LoggingCanvas canvas(bounds.width(), bounds.height());
     picture->playback(&canvas);
-    std::unique_ptr<JSONObject> pictureAsJSON = JSONObject::create();
+    RefPtr<JSONObject> pictureAsJSON = JSONObject::create();
     pictureAsJSON->setObject("cullRect", objectForSkRect(picture->cullRect()));
     pictureAsJSON->setArray("operations", canvas.log());
+    RefPtr<JSONArray> operationsInJson = canvas.log();
     return pictureAsJSON->toPrettyJSONString();
 }
 
diff --git a/third_party/WebKit/Source/platform/graphics/LoggingCanvas.h b/third_party/WebKit/Source/platform/graphics/LoggingCanvas.h
index 99a3eb5..1d2f0bc 100644
--- a/third_party/WebKit/Source/platform/graphics/LoggingCanvas.h
+++ b/third_party/WebKit/Source/platform/graphics/LoggingCanvas.h
@@ -33,16 +33,13 @@
 
 #include "platform/JSONValues.h"
 #include "platform/graphics/InterceptingCanvas.h"
-#include <memory>
 
 namespace blink {
 
 class LoggingCanvas : public InterceptingCanvasBase {
 public:
     LoggingCanvas(int width, int height);
-
-    // Returns a snapshot of the current log data.
-    std::unique_ptr<JSONArray> log();
+    PassRefPtr<JSONArray> log();
 
     void onDrawPaint(const SkPaint&) override;
     void onDrawPoints(PointMode, size_t count, const SkPoint pts[], const SkPaint&) override;
@@ -78,7 +75,7 @@ public:
 private:
     friend class AutoLogger;
 
-    std::unique_ptr<JSONArray> m_log;
+    RefPtr<JSONArray> m_log;
 };
 
 #ifndef NDEBUG
diff --git a/third_party/WebKit/Source/platform/graphics/PictureSnapshot.cpp b/third_party/WebKit/Source/platform/graphics/PictureSnapshot.cpp
index f7be7c9..2497346 100644
--- a/third_party/WebKit/Source/platform/graphics/PictureSnapshot.cpp
+++ b/third_party/WebKit/Source/platform/graphics/PictureSnapshot.cpp
@@ -174,7 +174,7 @@ std::unique_ptr<PictureSnapshot::Timings> PictureSnapshot::profile(unsigned minR
     return timings;
 }
 
-std::unique_ptr<JSONArray> PictureSnapshot::snapshotCommandLog() const
+PassRefPtr<JSONArray> PictureSnapshot::snapshotCommandLog() const
 {
     const SkIRect bounds = m_picture->cullRect().roundOut();
     LoggingCanvas canvas(bounds.width(), bounds.height());
diff --git a/third_party/WebKit/Source/platform/graphics/PictureSnapshot.h b/third_party/WebKit/Source/platform/graphics/PictureSnapshot.h
index 2ef4c19..ffe561f 100644
--- a/third_party/WebKit/Source/platform/graphics/PictureSnapshot.h
+++ b/third_party/WebKit/Source/platform/graphics/PictureSnapshot.h
@@ -59,7 +59,7 @@ public:
 
     std::unique_ptr<Vector<char>> replay(unsigned fromStep = 0, unsigned toStep = 0, double scale = 1.0) const;
     std::unique_ptr<Timings> profile(unsigned minIterations, double minDuration, const FloatRect* clipRect) const;
-    std::unique_ptr<JSONArray> snapshotCommandLog() const;
+    PassRefPtr<JSONArray> snapshotCommandLog() const;
     bool isEmpty() const;
 
 private:
diff --git a/third_party/WebKit/Source/platform/graphics/compositing/PaintArtifactCompositor.cpp b/third_party/WebKit/Source/platform/graphics/compositing/PaintArtifactCompositor.cpp
index da3c470..9321268 100644
--- a/third_party/WebKit/Source/platform/graphics/compositing/PaintArtifactCompositor.cpp
+++ b/third_party/WebKit/Source/platform/graphics/compositing/PaintArtifactCompositor.cpp
@@ -83,33 +83,41 @@ PaintArtifactCompositor::~PaintArtifactCompositor()
 
 namespace {
 
+static gfx::Rect largeRect(-200000, -200000, 400000, 400000);
+
 static void appendDisplayItemToCcDisplayItemList(const DisplayItem& displayItem, cc::DisplayItemList* list)
 {
     if (DisplayItem::isDrawingType(displayItem.getType())) {
         const SkPicture* picture = static_cast<const DrawingDisplayItem&>(displayItem).picture();
         if (!picture)
             return;
-        gfx::Rect bounds = gfx::SkIRectToRect(picture->cullRect().roundOut());
-        list->CreateAndAppendItem<cc::DrawingDisplayItem>(bounds, sk_ref_sp(picture));
+        // In theory we would pass the bounds of the picture, previously done as:
+        // gfx::Rect bounds = gfx::SkIRectToRect(picture->cullRect().roundOut());
+        // or use the visual rect directly. However, clip content layers attempt
+        // to raster in a different space than that of the visual rects. We'll be
+        // reworking visual rects further for SPv2, so for now we just pass a
+        // visual rect large enough to make sure items raster.
+        list->CreateAndAppendItem<cc::DrawingDisplayItem>(largeRect, sk_ref_sp(picture));
     }
 }
 
 static scoped_refptr<cc::DisplayItemList> recordPaintChunk(const PaintArtifact& artifact, const PaintChunk& chunk, const gfx::Rect& combinedBounds)
 {
     cc::DisplayItemListSettings settings;
-    scoped_refptr<cc::DisplayItemList> list = cc::DisplayItemList::Create(
-        gfx::Rect(combinedBounds.size()), settings);
+    scoped_refptr<cc::DisplayItemList> list = cc::DisplayItemList::Create(settings);
 
     gfx::Transform translation;
     translation.Translate(-combinedBounds.x(), -combinedBounds.y());
-    // TODO(jbroman, wkorman): What visual rectangle is wanted here?
-    list->CreateAndAppendItem<cc::TransformDisplayItem>(gfx::Rect(), translation);
+    // Passing combinedBounds as the visual rect for the begin/end transform item
+    // would normally be the sensible thing to do, but see comment above re:
+    // visual rects for drawing items and further rework in flight.
+    list->CreateAndAppendItem<cc::TransformDisplayItem>(largeRect, translation);
 
     const DisplayItemList& displayItems = artifact.getDisplayItemList();
     for (const auto& displayItem : displayItems.itemsInPaintChunk(chunk))
         appendDisplayItemToCcDisplayItemList(displayItem, list.get());
 
-    list->CreateAndAppendItem<cc::EndTransformDisplayItem>(gfx::Rect());
+    list->CreateAndAppendItem<cc::EndTransformDisplayItem>(largeRect);
 
     list->Finalize();
     return list;
diff --git a/third_party/WebKit/Source/platform/graphics/gpu/DrawingBuffer.cpp b/third_party/WebKit/Source/platform/graphics/gpu/DrawingBuffer.cpp
index 70038e4..6db0e44 100644
--- a/third_party/WebKit/Source/platform/graphics/gpu/DrawingBuffer.cpp
+++ b/third_party/WebKit/Source/platform/graphics/gpu/DrawingBuffer.cpp
@@ -304,9 +304,8 @@ bool DrawingBuffer::prepareMailbox(WebExternalTextureMailbox* outMailbox, WebExt
 
     m_gl->ProduceTextureDirectCHROMIUM(frontColorBufferMailbox->textureInfo.textureId, frontColorBufferMailbox->textureInfo.parameters.target, frontColorBufferMailbox->mailbox.name);
     const GLuint64 fenceSync = m_gl->InsertFenceSyncCHROMIUM();
-#if OS(MACOSX)
-    m_gl->DescheduleUntilFinishedCHROMIUM();
-#endif
+    if (RuntimeEnabledFeatures::webGLImageChromiumEnabled())
+        m_gl->DescheduleUntilFinishedCHROMIUM();
     m_gl->Flush();
     m_gl->GenSyncTokenCHROMIUM(fenceSync, frontColorBufferMailbox->mailbox.syncToken);
     frontColorBufferMailbox->mailbox.validSyncToken = true;
diff --git a/third_party/WebKit/Source/platform/graphics/paint/DrawingDisplayItem.cpp b/third_party/WebKit/Source/platform/graphics/paint/DrawingDisplayItem.cpp
index 9d8ceb8..88b6c14 100644
--- a/third_party/WebKit/Source/platform/graphics/paint/DrawingDisplayItem.cpp
+++ b/third_party/WebKit/Source/platform/graphics/paint/DrawingDisplayItem.cpp
@@ -40,11 +40,11 @@ void DrawingDisplayItem::analyzeForGpuRasterization(SkPictureGpuAnalyzer& analyz
 }
 
 #ifndef NDEBUG
-void DrawingDisplayItem::dumpPropertiesAsDebugString(StringBuilder& stringBuilder) const
+void DrawingDisplayItem::dumpPropertiesAsDebugString(WTF::StringBuilder& stringBuilder) const
 {
     DisplayItem::dumpPropertiesAsDebugString(stringBuilder);
     if (m_picture) {
-        stringBuilder.append(String::format(", rect: [%f,%f %fx%f]",
+        stringBuilder.append(WTF::String::format(", rect: [%f,%f %fx%f]",
             m_picture->cullRect().x(), m_picture->cullRect().y(),
             m_picture->cullRect().width(), m_picture->cullRect().height()));
     }
diff --git a/third_party/WebKit/Source/platform/graphics/paint/PaintController.cpp b/third_party/WebKit/Source/platform/graphics/paint/PaintController.cpp
index 58d2f40..0b79365 100644
--- a/third_party/WebKit/Source/platform/graphics/paint/PaintController.cpp
+++ b/third_party/WebKit/Source/platform/graphics/paint/PaintController.cpp
@@ -8,10 +8,10 @@
 #include "platform/graphics/GraphicsLayer.h"
 #include "platform/graphics/paint/DrawingDisplayItem.h"
 #include "third_party/skia/include/core/SkPictureAnalyzer.h"
-#include "wtf/text/StringBuilder.h"
 
 #ifndef NDEBUG
 #include "platform/graphics/LoggingCanvas.h"
+#include "wtf/text/StringBuilder.h"
 #include <stdio.h>
 #endif
 
@@ -580,6 +580,8 @@ void PaintController::checkUnderInvalidation()
 
 #endif // DCHECK_IS_ON()
 
+#ifndef NDEBUG
+
 String PaintController::displayItemListAsDebugString(const DisplayItemList& list) const
 {
     StringBuilder stringBuilder;
@@ -589,11 +591,7 @@ String PaintController::displayItemListAsDebugString(const DisplayItemList& list
         if (i)
             stringBuilder.append(",\n");
         stringBuilder.append(String::format("{index: %d, ", (int)i));
-#ifndef NDEBUG
         displayItem.dumpPropertiesAsDebugString(stringBuilder);
-#else
-        stringBuilder.append(String::format("clientDebugName: %s", displayItem.client().debugName().ascii().data()));
-#endif
         if (displayItem.hasValidClient()) {
             stringBuilder.append(", cacheIsValid: ");
             stringBuilder.append(clientCacheIsValid(displayItem.client()) ? "true" : "false");
@@ -615,4 +613,6 @@ void PaintController::showDebugData() const
     WTFLogAlways("new display item list: [%s]\n", displayItemListAsDebugString(m_newDisplayItemList).utf8().data());
 }
 
+#endif // ifndef NDEBUG
+
 } // namespace blink
diff --git a/third_party/WebKit/Source/platform/graphics/paint/PaintController.h b/third_party/WebKit/Source/platform/graphics/paint/PaintController.h
index f8bdca0..cadcb79 100644
--- a/third_party/WebKit/Source/platform/graphics/paint/PaintController.h
+++ b/third_party/WebKit/Source/platform/graphics/paint/PaintController.h
@@ -149,7 +149,9 @@ public:
 
     void appendDebugDrawingAfterCommit(const DisplayItemClient&, PassRefPtr<SkPicture>, const LayoutSize& offsetFromLayoutObject);
 
+#ifndef NDEBUG
     void showDebugData() const;
+#endif
 
 #if DCHECK_IS_ON()
     void assertDisplayItemClientsAreLive();
@@ -188,7 +190,9 @@ private:
     // Set new item state (cache skipping, etc) for a new item.
     void processNewItem(DisplayItem&);
 
-    String displayItemListAsDebugString(const DisplayItemList&) const;
+#ifndef NDEBUG
+    WTF::String displayItemListAsDebugString(const DisplayItemList&) const;
+#endif
 
     // Indices into PaintList of all DrawingDisplayItems and BeginSubsequenceDisplayItems of each client.
     // Temporarily used during merge to find out-of-order display items.
diff --git a/third_party/WebKit/Source/platform/inspector_protocol/generate-inspector-protocol-version b/third_party/WebKit/Source/platform/inspector_protocol/generate-inspector-protocol-version
index d15f765..838a3ed 100755
--- a/third_party/WebKit/Source/platform/inspector_protocol/generate-inspector-protocol-version
+++ b/third_party/WebKit/Source/platform/inspector_protocol/generate-inspector-protocol-version
@@ -451,8 +451,7 @@ def main():
         load_domains_and_baselines(arg_values[1], domains, baseline_domains)
 
     expected_errors = [
-        "Debugger.globalObjectCleared: event has been removed",
-        "Runtime.executionContextCreated.context parameter->Runtime.ExecutionContextDescription.frameId: required property has been removed"
+        "Debugger.globalObjectCleared: event has been removed"
     ]
 
     errors = compare_schemas(baseline_domains, domains, False)
diff --git a/third_party/WebKit/Source/platform/plugins/PluginData.cpp b/third_party/WebKit/Source/platform/plugins/PluginData.cpp
index 8f676b8..4897488 100644
--- a/third_party/WebKit/Source/platform/plugins/PluginData.cpp
+++ b/third_party/WebKit/Source/platform/plugins/PluginData.cpp
@@ -116,4 +116,20 @@ void PluginData::refresh()
     pluginCache().plugins(); // Force the plugins to be reloaded now.
 }
 
+String getPluginMimeTypeFromExtension(const String& extension)
+{
+    const Vector<PluginInfo>& plugins = pluginCache().plugins();
+    for (size_t i = 0; i < plugins.size(); ++i) {
+        for (size_t j = 0; j < plugins[i].mimes.size(); ++j) {
+            const MimeClassInfo& mime = plugins[i].mimes[j];
+            const Vector<String>& extensions = mime.extensions;
+            for (size_t k = 0; k < extensions.size(); ++k) {
+                if (extension == extensions[k])
+                    return mime.type;
+            }
+        }
+    }
+    return String();
+}
+
 } // namespace blink
diff --git a/third_party/WebKit/Source/platform/plugins/PluginData.h b/third_party/WebKit/Source/platform/plugins/PluginData.h
index e571695..1b881ed 100644
--- a/third_party/WebKit/Source/platform/plugins/PluginData.h
+++ b/third_party/WebKit/Source/platform/plugins/PluginData.h
@@ -73,6 +73,10 @@ private:
     Vector<size_t> m_mimePluginIndices;
 };
 
+// Checks if any of the plugins handle this extension, and if so returns the
+// plugin's mime type for this extension. Otherwise returns an empty string.
+PLATFORM_EXPORT String getPluginMimeTypeFromExtension(const String& extension);
+
 } // namespace blink
 
 #endif
diff --git a/third_party/WebKit/Source/platform/v8_inspector/DebuggerScript.js b/third_party/WebKit/Source/platform/v8_inspector/DebuggerScript.js
index cd9a2bd..5b534f3 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/DebuggerScript.js
+++ b/third_party/WebKit/Source/platform/v8_inspector/DebuggerScript.js
@@ -141,22 +141,14 @@ DebuggerScript._executionContextId = function(contextData)
 {
     if (!contextData)
         return 0;
-    var match = contextData.match(/^[^,]*,([^,]*),.*$/);
-    if (!match)
+    var firstComma = contextData.indexOf(",");
+    if (firstComma === -1)
+        return 0;
+    var secondComma = contextData.indexOf(",", firstComma + 1);
+    if (secondComma === -1)
         return 0;
-    return parseInt(match[1], 10) || 0;
-}
 
-/**
- * @param {string|undefined} contextData
- * @return {string}
- */
-DebuggerScript._executionContextAuxData = function(contextData)
-{
-    if (!contextData)
-        return "";
-    var match = contextData.match(/^[^,]*,[^,]*,(.*)$/);
-    return match ? match[1] : "";
+    return parseInt(contextData.substring(firstComma + 1, secondComma), 10) || 0;
 }
 
 /**
@@ -176,7 +168,7 @@ DebuggerScript.getScripts = function(contextGroupId)
             if (!script.context_data)
                 continue;
             // Context data is a string in the following format:
-            // <contextGroupId>,<contextId>,<auxData>
+            // <contextGroupId>,<contextId>,("default"|"nondefault")
             if (script.context_data.indexOf(contextDataPrefix) !== 0)
                 continue;
         }
@@ -216,8 +208,7 @@ DebuggerScript._formatScript = function(script)
         endLine: endLine,
         endColumn: endColumn,
         executionContextId: DebuggerScript._executionContextId(script.context_data),
-        // Note that we cannot derive aux data from context id because of compilation cache.
-        executionContextAuxData: DebuggerScript._executionContextAuxData(script.context_data),
+        isContentScript: !!script.context_data && script.context_data.endsWith(",nondefault"),
         isInternalScript: script.is_debugger_script
     };
 }
diff --git a/third_party/WebKit/Source/platform/v8_inspector/InspectedContext.cpp b/third_party/WebKit/Source/platform/v8_inspector/InspectedContext.cpp
index 16e0f02..3d51e94 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/InspectedContext.cpp
+++ b/third_party/WebKit/Source/platform/v8_inspector/InspectedContext.cpp
@@ -34,9 +34,10 @@ InspectedContext::InspectedContext(V8InspectorImpl* inspector, const V8ContextIn
     , m_context(info.context->GetIsolate(), info.context)
     , m_contextId(contextId)
     , m_contextGroupId(info.contextGroupId)
+    , m_isDefault(info.isDefault)
     , m_origin(info.origin)
     , m_humanReadableName(info.humanReadableName)
-    , m_auxData(info.auxData)
+    , m_frameId(info.frameId)
     , m_reported(false)
 {
     m_context.SetWeak(this, &InspectedContext::weakCallback, v8::WeakCallbackType::kParameter);
diff --git a/third_party/WebKit/Source/platform/v8_inspector/InspectedContext.h b/third_party/WebKit/Source/platform/v8_inspector/InspectedContext.h
index 421d3df..aadb810 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/InspectedContext.h
+++ b/third_party/WebKit/Source/platform/v8_inspector/InspectedContext.h
@@ -25,9 +25,10 @@ public:
     v8::Local<v8::Context> context() const;
     int contextId() const { return m_contextId; }
     int contextGroupId() const { return m_contextGroupId; }
+    bool isDefault() const { return m_isDefault; }
     String16 origin() const { return m_origin; }
     String16 humanReadableName() const { return m_humanReadableName; }
-    String16 auxData() const { return m_auxData; }
+    String16 frameId() const { return m_frameId; }
 
     bool isReported() const { return m_reported; }
     void setReported(bool reported) { m_reported = reported; }
@@ -49,9 +50,10 @@ private:
     v8::Global<v8::Context> m_context;
     int m_contextId;
     int m_contextGroupId;
+    bool m_isDefault;
     const String16 m_origin;
     const String16 m_humanReadableName;
-    const String16 m_auxData;
+    const String16 m_frameId;
     bool m_reported;
     std::unique_ptr<InjectedScript> m_injectedScript;
     v8::Global<v8::Object> m_console;
diff --git a/third_party/WebKit/Source/platform/v8_inspector/V8Debugger.cpp b/third_party/WebKit/Source/platform/v8_inspector/V8Debugger.cpp
index f580af4..ff93531 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/V8Debugger.cpp
+++ b/third_party/WebKit/Source/platform/v8_inspector/V8Debugger.cpp
@@ -715,7 +715,7 @@ int V8Debugger::markContext(const V8ContextInfo& info)
 {
     DCHECK(info.context->GetIsolate() == m_isolate);
     int contextId = ++m_lastContextId;
-    String16 debugData = String16::fromInteger(info.contextGroupId) + "," + String16::fromInteger(contextId) + "," + info.auxData;
+    String16 debugData = String16::fromInteger(info.contextGroupId) + "," + String16::fromInteger(contextId) + "," + (info.isDefault ? "default" : "nondefault");
     v8::Context::Scope contextScope(info.context);
     info.context->SetEmbedderData(static_cast<int>(v8::Context::kDebugIdIndex), toV8String(m_isolate, debugData));
     return contextId;
diff --git a/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerAgentImpl.cpp b/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerAgentImpl.cpp
index 584c016..6a3472e 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerAgentImpl.cpp
+++ b/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerAgentImpl.cpp
@@ -4,7 +4,6 @@
 
 #include "platform/v8_inspector/V8DebuggerAgentImpl.h"
 
-#include "platform/inspector_protocol/Parser.h"
 #include "platform/inspector_protocol/String16.h"
 #include "platform/inspector_protocol/Values.h"
 #include "platform/v8_inspector/InjectedScript.h"
@@ -1008,9 +1007,7 @@ void V8DebuggerAgentImpl::didParseSource(std::unique_ptr<V8DebuggerScript> scrip
     else if (!script->sourceMappingURL().isEmpty())
         findSourceMapURL(scriptSource, false, &isDeprecatedSourceMappingURL);
 
-    std::unique_ptr<protocol::DictionaryValue> executionContextAuxData;
-    if (!script->executionContextAuxData().isEmpty())
-        executionContextAuxData = protocol::DictionaryValue::cast(parseJSON(script->executionContextAuxData()));
+    bool isContentScript = script->isContentScript();
     bool isInternalScript = script->isInternalScript();
     bool isLiveEdit = script->isLiveEdit();
     bool hasSourceURL = script->hasSourceURL();
@@ -1019,15 +1016,15 @@ void V8DebuggerAgentImpl::didParseSource(std::unique_ptr<V8DebuggerScript> scrip
     bool deprecatedCommentWasUsed = isDeprecatedSourceURL || isDeprecatedSourceMappingURL;
 
     const Maybe<String16>& sourceMapURLParam = script->sourceMappingURL();
-    const Maybe<protocol::DictionaryValue>& executionContextAuxDataParam(std::move(executionContextAuxData));
+    const bool* isContentScriptParam = isContentScript ? &isContentScript : nullptr;
     const bool* isInternalScriptParam = isInternalScript ? &isInternalScript : nullptr;
     const bool* isLiveEditParam = isLiveEdit ? &isLiveEdit : nullptr;
     const bool* hasSourceURLParam = hasSourceURL ? &hasSourceURL : nullptr;
     const bool* deprecatedCommentWasUsedParam = deprecatedCommentWasUsed ? &deprecatedCommentWasUsed : nullptr;
     if (success)
-        m_frontend.scriptParsed(scriptId, scriptURL, script->startLine(), script->startColumn(), script->endLine(), script->endColumn(), script->executionContextId(), script->hash(), executionContextAuxDataParam, isInternalScriptParam, isLiveEditParam, sourceMapURLParam, hasSourceURLParam, deprecatedCommentWasUsedParam);
+        m_frontend.scriptParsed(scriptId, scriptURL, script->startLine(), script->startColumn(), script->endLine(), script->endColumn(), script->executionContextId(), script->hash(), isContentScriptParam, isInternalScriptParam, isLiveEditParam, sourceMapURLParam, hasSourceURLParam, deprecatedCommentWasUsedParam);
     else
-        m_frontend.scriptFailedToParse(scriptId, scriptURL, script->startLine(), script->startColumn(), script->endLine(), script->endColumn(), script->executionContextId(), script->hash(), executionContextAuxDataParam, isInternalScriptParam, sourceMapURLParam, hasSourceURLParam, deprecatedCommentWasUsedParam);
+        m_frontend.scriptFailedToParse(scriptId, scriptURL, script->startLine(), script->startColumn(), script->endLine(), script->endColumn(), script->executionContextId(), script->hash(), isContentScriptParam, isInternalScriptParam, sourceMapURLParam, hasSourceURLParam, deprecatedCommentWasUsedParam);
 
     m_scripts[scriptId] = std::move(script);
 
diff --git a/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerScript.cpp b/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerScript.cpp
index edb2fcd..91a060b 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerScript.cpp
+++ b/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerScript.cpp
@@ -78,7 +78,7 @@ V8DebuggerScript::V8DebuggerScript(v8::Isolate* isolate, v8::Local<v8::Object> o
     m_startColumn = object->Get(toV8StringInternalized(isolate, "startColumn"))->ToInteger(isolate)->Value();
     m_endLine = object->Get(toV8StringInternalized(isolate, "endLine"))->ToInteger(isolate)->Value();
     m_endColumn = object->Get(toV8StringInternalized(isolate, "endColumn"))->ToInteger(isolate)->Value();
-    m_executionContextAuxData = toProtocolStringWithTypeCheck(object->Get(toV8StringInternalized(isolate, "executionContextAuxData")));
+    m_isContentScript = object->Get(toV8StringInternalized(isolate, "isContentScript"))->ToBoolean(isolate)->Value();
     m_isInternalScript = object->Get(toV8StringInternalized(isolate, "isInternalScript"))->ToBoolean(isolate)->Value();
     m_executionContextId = object->Get(toV8StringInternalized(isolate, "executionContextId"))->ToInteger(isolate)->Value();
     m_isLiveEdit = isLiveEdit;
@@ -92,7 +92,7 @@ V8DebuggerScript::~V8DebuggerScript()
 {
 }
 
-const String16& V8DebuggerScript::sourceURL() const
+String16 V8DebuggerScript::sourceURL() const
 {
     return m_sourceURL.isEmpty() ? m_url : m_sourceURL;
 }
diff --git a/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerScript.h b/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerScript.h
index d3e9d8d..60d93d8 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerScript.h
+++ b/third_party/WebKit/Source/platform/v8_inspector/V8DebuggerScript.h
@@ -42,19 +42,19 @@ public:
     V8DebuggerScript(v8::Isolate*, v8::Local<v8::Object>, bool isLiveEdit);
     ~V8DebuggerScript();
 
-    const String16& scriptId() const { return m_id; }
-    const String16& url() const { return m_url; }
+    String16 scriptId() const { return m_id; }
+    String16 url() const { return m_url; }
     bool hasSourceURL() const { return !m_sourceURL.isEmpty(); }
-    const String16& sourceURL() const;
-    const String16& sourceMappingURL() const { return m_sourceMappingURL; }
+    String16 sourceURL() const;
+    String16 sourceMappingURL() const { return m_sourceMappingURL; }
     v8::Local<v8::String> source(v8::Isolate*) const;
-    const String16& hash() const { return m_hash; }
+    String16 hash() const { return m_hash; }
     int startLine() const { return m_startLine; }
     int startColumn() const { return m_startColumn; }
     int endLine() const { return m_endLine; }
     int endColumn() const { return m_endColumn; }
     int executionContextId() const { return m_executionContextId; }
-    const String16& executionContextAuxData() const { return m_executionContextAuxData; }
+    bool isContentScript() const { return m_isContentScript; }
     bool isInternalScript() const { return m_isInternalScript; }
     bool isLiveEdit() const { return m_isLiveEdit; }
 
@@ -74,7 +74,7 @@ private:
     int m_endLine;
     int m_endColumn;
     int m_executionContextId;
-    String16 m_executionContextAuxData;
+    bool m_isContentScript;
     bool m_isInternalScript;
     bool m_isLiveEdit;
 };
diff --git a/third_party/WebKit/Source/platform/v8_inspector/V8RuntimeAgentImpl.cpp b/third_party/WebKit/Source/platform/v8_inspector/V8RuntimeAgentImpl.cpp
index cf2c2ba..7c03080 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/V8RuntimeAgentImpl.cpp
+++ b/third_party/WebKit/Source/platform/v8_inspector/V8RuntimeAgentImpl.cpp
@@ -30,7 +30,6 @@
 
 #include "platform/v8_inspector/V8RuntimeAgentImpl.h"
 
-#include "platform/inspector_protocol/Parser.h"
 #include "platform/inspector_protocol/Values.h"
 #include "platform/v8_inspector/InjectedScript.h"
 #include "platform/v8_inspector/InspectedContext.h"
@@ -650,10 +649,10 @@ void V8RuntimeAgentImpl::reportExecutionContextCreated(InspectedContext* context
     context->setReported(true);
     std::unique_ptr<protocol::Runtime::ExecutionContextDescription> description = protocol::Runtime::ExecutionContextDescription::create()
         .setId(context->contextId())
+        .setIsDefault(context->isDefault())
         .setName(context->humanReadableName())
-        .setOrigin(context->origin()).build();
-    if (!context->auxData().isEmpty())
-        description->setAuxData(protocol::DictionaryValue::cast(parseJSON(context->auxData())));
+        .setOrigin(context->origin())
+        .setFrameId(context->frameId()).build();
     m_frontend.executionContextCreated(std::move(description));
 }
 
diff --git a/third_party/WebKit/Source/platform/v8_inspector/debugger_script_externs.js b/third_party/WebKit/Source/platform/v8_inspector/debugger_script_externs.js
index dddc709..cf2a045 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/debugger_script_externs.js
+++ b/third_party/WebKit/Source/platform/v8_inspector/debugger_script_externs.js
@@ -29,7 +29,7 @@ var RawLocation;
         startColumn: number,
         endColumn: number,
         executionContextId: number,
-        executionContextAuxData: string,
+        isContentScript: boolean,
         isInternalScript: boolean
     }} */
 var FormattedScript;
diff --git a/third_party/WebKit/Source/platform/v8_inspector/js_protocol.json b/third_party/WebKit/Source/platform/v8_inspector/js_protocol.json
index 3213398..b505070 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/js_protocol.json
+++ b/third_party/WebKit/Source/platform/v8_inspector/js_protocol.json
@@ -132,9 +132,10 @@
                 "description": "Description of an isolated world.",
                 "properties": [
                     { "name": "id", "$ref": "ExecutionContextId", "description": "Unique id of the execution context. It can be used to specify in which execution context script evaluation should be performed." },
-                    { "name": "origin", "type": "string", "description": "Execution context origin.", "hidden": true },
-                    { "name": "name", "type": "string", "description": "Human readable name describing given context.", "hidden": true },
-                    { "name": "auxData", "type": "object", "optional": true, "description": "Embedder-specific auxiliary data.", "hidden": true }
+                    { "name": "isDefault", "type": "boolean", "description": "Whether context is the default page context (as opposite to e.g. context of content script).", "hidden": true },
+                    { "name": "origin", "type": "string", "description": "Execution context origin.", "hidden": true},
+                    { "name": "name", "type": "string", "description": "Human readable name describing given context.", "hidden": true},
+                    { "name": "frameId", "type": "string", "description": "Id of the owning frame. May be an empty string if the context is not associated with a frame." }
                 ]
             },
             {
@@ -190,7 +191,7 @@
                     { "name": "objectGroup", "type": "string", "optional": true, "description": "Symbolic group name that can be used to release multiple objects." },
                     { "name": "includeCommandLineAPI", "type": "boolean", "optional": true, "description": "Determines whether Command Line API should be available during the evaluation.", "hidden": true },
                     { "name": "doNotPauseOnExceptionsAndMuteConsole", "type": "boolean", "optional": true, "description": "Specifies whether evaluation should stop on exceptions and mute console. Overrides setPauseOnException state.", "hidden": true },
-                    { "name": "contextId", "$ref": "ExecutionContextId", "optional": true, "description": "Specifies in which execution context to perform evaluation. If the parameter is omitted the evaluation will be performed in the context of the inspected page." },
+                    { "name": "contextId", "$ref": "ExecutionContextId", "optional": true, "description": "Specifies in which isolated context to perform evaluation. Each content script lives in an isolated context and this parameter may be used to specify one of those contexts. If the parameter is omitted the evaluation will be performed in the context of the inspected page." },
                     { "name": "returnByValue", "type": "boolean", "optional": true, "description": "Whether the result is expected to be a JSON object that should be sent by value." },
                     { "name": "generatePreview", "type": "boolean", "optional": true, "hidden": true, "description": "Whether preview should be generated for the result." },
                     { "name": "userGesture", "type": "boolean", "optional": true, "hidden": true, "description": "Whether execution should be treated as initiated by user in the UI." },
@@ -304,7 +305,7 @@
                     { "name": "expression", "type": "string", "description": "Expression to compile." },
                     { "name": "sourceURL", "type": "string", "description": "Source url to be set for the script." },
                     { "name": "persistScript", "type": "boolean", "description": "Specifies whether the compiled script should be persisted." },
-                    { "name": "executionContextId", "$ref": "ExecutionContextId", "optional": true, "description": "Specifies in which execution context to perform script run. If the parameter is omitted the evaluation will be performed in the context of the inspected page." }
+                    { "name": "executionContextId", "$ref": "ExecutionContextId", "optional": true, "description": "Specifies in which isolated context to perform script run. Each content script lives in an isolated context and this parameter is used to specify one of those contexts. If the parameter is omitted the evaluation will be performed in the context of the inspected page." }
                 ],
                 "returns": [
                     { "name": "scriptId", "$ref": "ScriptId", "optional": true, "description": "Id of the script." },
@@ -318,7 +319,7 @@
                 "async": true,
                 "parameters": [
                     { "name": "scriptId", "$ref": "ScriptId", "description": "Id of the script to run." },
-                    { "name": "executionContextId", "$ref": "ExecutionContextId", "optional": true, "description": "Specifies in which execution context to perform script run. If the parameter is omitted the evaluation will be performed in the context of the inspected page." },
+                    { "name": "executionContextId", "$ref": "ExecutionContextId", "optional": true, "description": "Specifies in which isolated context to perform script run. Each content script lives in an isolated context and this parameter is used to specify one of those contexts. If the parameter is omitted the evaluation will be performed in the context of the inspected page." },
                     { "name": "objectGroup", "type": "string", "optional": true, "description": "Symbolic group name that can be used to release multiple objects." },
                     { "name": "doNotPauseOnExceptionsAndMuteConsole", "type": "boolean", "optional": true, "description": "Specifies whether script run should stop on exceptions and mute console. Overrides setPauseOnException state." },
                     { "name": "includeCommandLineAPI", "type": "boolean", "optional": true, "description": "Determines whether Command Line API should be available during the evaluation." },
@@ -695,7 +696,7 @@
                     { "name": "endColumn", "type": "integer", "description": "Length of the last line of the script." },
                     { "name": "executionContextId", "$ref": "Runtime.ExecutionContextId", "description": "Specifies script creation context.", "hidden": true },
                     { "name": "hash", "type": "string", "hidden": true, "description": "Content hash of the script."},
-                    { "name": "executionContextAuxData", "type": "object", "optional": true, "description": "Embedder-specific auxiliary data.", "hidden": true },
+                    { "name": "isContentScript", "type": "boolean", "optional": true, "description": "Determines whether this script is a user extension script." },
                     { "name": "isInternalScript", "type": "boolean", "optional": true, "description": "Determines whether this script is an internal script.", "hidden": true },
                     { "name": "isLiveEdit", "type": "boolean", "optional": true, "description": "True, if this script is generated as a result of the live edit operation.", "hidden": true },
                     { "name": "sourceMapURL", "type": "string", "optional": true, "description": "URL of source map associated with script (if any)." },
@@ -715,7 +716,7 @@
                     { "name": "endColumn", "type": "integer", "description": "Length of the last line of the script." },
                     { "name": "executionContextId", "$ref": "Runtime.ExecutionContextId", "description": "Specifies script creation context.", "hidden": true },
                     { "name": "hash", "type": "string", "hidden": true, "description": "Content hash of the script."},
-                    { "name": "executionContextAuxData", "type": "object", "optional": true, "description": "Embedder-specific auxiliary data.", "hidden": true },
+                    { "name": "isContentScript", "type": "boolean", "optional": true, "description": "Determines whether this script is a user extension script." },
                     { "name": "isInternalScript", "type": "boolean", "optional": true, "description": "Determines whether this script is an internal script.", "hidden": true },
                     { "name": "sourceMapURL", "type": "string", "optional": true, "description": "URL of source map associated with script (if any)." },
                     { "name": "hasSourceURL", "type": "boolean", "optional": true, "description": "True, if this script has sourceURL.", "hidden": true },
diff --git a/third_party/WebKit/Source/platform/v8_inspector/public/SimpleInspector.cpp b/third_party/WebKit/Source/platform/v8_inspector/public/SimpleInspector.cpp
index ebd9fe7..e6cb62e 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/public/SimpleInspector.cpp
+++ b/third_party/WebKit/Source/platform/v8_inspector/public/SimpleInspector.cpp
@@ -16,7 +16,8 @@ SimpleInspector::SimpleInspector(v8::Isolate* isolate, v8::Local<v8::Context> co
     : m_context(context)
 {
     m_inspector = V8Inspector::create(isolate, this);
-    m_inspector->contextCreated(V8ContextInfo(context, 1, "NodeJS Main Context"));
+    m_inspector->contextCreated(V8ContextInfo(context, 1, true, "",
+        "NodeJS Main Context", "", false));
 }
 
 SimpleInspector::~SimpleInspector()
diff --git a/third_party/WebKit/Source/platform/v8_inspector/public/V8ContextInfo.h b/third_party/WebKit/Source/platform/v8_inspector/public/V8ContextInfo.h
index 81a98e6..0dc1de2 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/public/V8ContextInfo.h
+++ b/third_party/WebKit/Source/platform/v8_inspector/public/V8ContextInfo.h
@@ -13,11 +13,14 @@ namespace blink {
 
 class V8ContextInfo {
 public:
-    V8ContextInfo(v8::Local<v8::Context> context, int contextGroupId, const String16& humanReadableName)
+    V8ContextInfo(v8::Local<v8::Context> context, int contextGroupId, bool isDefault, const String16& origin, const String16& humanReadableName, const String16& frameId, bool hasMemoryOnConsole)
         : context(context)
         , contextGroupId(contextGroupId)
+        , isDefault(isDefault)
+        , origin(origin)
         , humanReadableName(humanReadableName)
-        , hasMemoryOnConsole(false)
+        , frameId(frameId)
+        , hasMemoryOnConsole(hasMemoryOnConsole)
     {
     }
 
@@ -26,9 +29,11 @@ public:
     // V8DebuggerAgent to notify about events in the context.
     // |contextGroupId| must be non-0.
     int contextGroupId;
-    String16 humanReadableName;
-    String16 origin;
-    String16 auxData;
+    bool isDefault;
+    const String16 origin;
+    const String16 humanReadableName;
+    // TODO(dgozman): aux data?
+    const String16 frameId;
     bool hasMemoryOnConsole;
 };
 
diff --git a/third_party/WebKit/Source/platform/v8_inspector/v8_inspector.gyp b/third_party/WebKit/Source/platform/v8_inspector/v8_inspector.gyp
index e848ad5..eba83ec 100644
--- a/third_party/WebKit/Source/platform/v8_inspector/v8_inspector.gyp
+++ b/third_party/WebKit/Source/platform/v8_inspector/v8_inspector.gyp
@@ -186,6 +186,7 @@
         '../inspector_protocol/ValueConversions.h',
 
         'Atomics.h',
+        'IgnoreExceptionsScope.h',
         'InjectedScript.cpp',
         'InjectedScript.h',
         'InjectedScriptNative.cpp',
diff --git a/third_party/WebKit/Source/web/BUILD.gn b/third_party/WebKit/Source/web/BUILD.gn
index cbba1c2..78c831c 100644
--- a/third_party/WebKit/Source/web/BUILD.gn
+++ b/third_party/WebKit/Source/web/BUILD.gn
@@ -42,6 +42,10 @@ component("web") {
 
   sources = web_gypi.web_files
 
+  if (!use_default_render_theme) {
+    sources -= [ "default/WebRenderTheme.cpp" ]
+  }
+
   if (is_android) {
     set_sources_assignment_filter([])
     sources += [ "linux/WebFontRendering.cpp" ]
diff --git a/third_party/WebKit/Source/web/DateTimeChooserImpl.cpp b/third_party/WebKit/Source/web/DateTimeChooserImpl.cpp
index bed2c5e..5e18e7d 100644
--- a/third_party/WebKit/Source/web/DateTimeChooserImpl.cpp
+++ b/third_party/WebKit/Source/web/DateTimeChooserImpl.cpp
@@ -106,7 +106,7 @@ static String valueToDateTimeString(double value, AtomicString type)
 void DateTimeChooserImpl::writeDocument(SharedBuffer* data)
 {
     String stepString = String::number(m_parameters.step);
-    String stepBaseString = String::number(m_parameters.stepBase, 11);
+    String stepBaseString = String::number(m_parameters.stepBase, 11, WTF::TruncateTrailingZeros);
     String todayLabelString;
     String otherDateLabelString;
     if (m_parameters.type == InputTypeNames::month) {
diff --git a/third_party/WebKit/Source/web/FrameLoaderClientImpl.cpp b/third_party/WebKit/Source/web/FrameLoaderClientImpl.cpp
index 1f10cdc..c39b584 100644
--- a/third_party/WebKit/Source/web/FrameLoaderClientImpl.cpp
+++ b/third_party/WebKit/Source/web/FrameLoaderClientImpl.cpp
@@ -658,6 +658,24 @@ void FrameLoaderClientImpl::didAccessInitialDocument()
         m_webFrame->client()->didAccessInitialDocument();
 }
 
+void FrameLoaderClientImpl::ironframeOrigin(const CString& origin)
+{
+    if (m_webFrame->client())
+        m_webFrame->client()->ironframeOrigin(origin);
+}
+
+void FrameLoaderClientImpl::validIronframe()
+{
+    if (m_webFrame->client())
+        m_webFrame->client()->validIronframe();
+}
+
+void FrameLoaderClientImpl::invalidIronframe()
+{
+    if (m_webFrame->client())
+        m_webFrame->client()->invalidIronframe();
+}
+
 void FrameLoaderClientImpl::didDisplayInsecureContent()
 {
     if (m_webFrame->client())
@@ -844,6 +862,11 @@ ObjectContentType FrameLoaderClientImpl::getObjectContentType(
         if (extensionPos >= 0) {
             String extension = filename.substring(extensionPos + 1);
             mimeType = MIMETypeRegistry::getWellKnownMIMETypeForExtension(extension);
+            if (mimeType.isEmpty()) {
+                // If there's no mimetype registered for the extension, check to see
+                // if a plugin can handle the extension.
+                mimeType = getPluginMimeTypeFromExtension(extension);
+            }
         }
 
         if (mimeType.isEmpty())
diff --git a/third_party/WebKit/Source/web/FrameLoaderClientImpl.h b/third_party/WebKit/Source/web/FrameLoaderClientImpl.h
index d72f15d..006af43 100644
--- a/third_party/WebKit/Source/web/FrameLoaderClientImpl.h
+++ b/third_party/WebKit/Source/web/FrameLoaderClientImpl.h
@@ -112,6 +112,9 @@ public:
     void loadURLExternally(const ResourceRequest&, NavigationPolicy, const String& suggestedName, bool shouldReplaceCurrentEntry) override;
     bool navigateBackForward(int offset) const override;
     void didAccessInitialDocument() override;
+    void ironframeOrigin(const CString& origin) override;
+    void validIronframe() override;
+    void invalidIronframe() override;
     void didDisplayInsecureContent() override;
     void didRunInsecureContent(SecurityOrigin*, const KURL& insecureURL) override;
     void didDetectXSS(const KURL&, bool didBlockEntirePage) override;
diff --git a/third_party/WebKit/Source/web/TextFinder.cpp b/third_party/WebKit/Source/web/TextFinder.cpp
index b136ba9..95977ad 100644
--- a/third_party/WebKit/Source/web/TextFinder.cpp
+++ b/third_party/WebKit/Source/web/TextFinder.cpp
@@ -112,7 +112,7 @@ private:
     const bool m_reset;
 };
 
-bool TextFinder::find(int identifier, const WebString& searchText, const WebFindOptions& options, bool wrapWithinFrame, bool* activeNow)
+bool TextFinder::find(int identifier, const WebString& searchText, const WebFindOptions& options, bool wrapWithinFrame, WebRect* selectionRect, bool* activeNow)
 {
     if (!options.findNext)
         unmarkAllTextMatches();
@@ -196,8 +196,10 @@ bool TextFinder::find(int identifier, const WebString& searchText, const WebFind
             else if (m_activeMatchIndex < 0)
                 m_activeMatchIndex = m_lastMatchCount - 1;
         }
-        WebRect selectionRect = ownerFrame().frameView()->contentsToRootFrame(m_activeMatch->boundingBox());
-        reportFindInPageSelection(selectionRect, m_activeMatchIndex + 1, identifier);
+        if (selectionRect) {
+            *selectionRect = ownerFrame().frameView()->contentsToRootFrame(m_activeMatch->boundingBox());
+            reportFindInPageSelection(*selectionRect, m_activeMatchIndex + 1, identifier);
+        }
     }
 
     return true;
diff --git a/third_party/WebKit/Source/web/TextFinder.h b/third_party/WebKit/Source/web/TextFinder.h
index c670aaf..36644a8 100644
--- a/third_party/WebKit/Source/web/TextFinder.h
+++ b/third_party/WebKit/Source/web/TextFinder.h
@@ -58,35 +58,19 @@ public:
 
     bool find(
         int identifier, const WebString& searchText, const WebFindOptions&,
-        bool wrapWithinFrame, bool* activeNow = nullptr);
+        bool wrapWithinFrame, WebRect* selectionRect, bool* activeNow = nullptr);
     void clearActiveFindMatch();
     void stopFindingAndClearSelection();
-    void increaseMatchCount(int identifier, int count);
-    int findMatchMarkersVersion() const { return m_findMatchMarkersVersion; }
-    WebFloatRect activeFindMatchRect();
-    void findMatchRects(WebVector<WebFloatRect>&);
-    int selectNearestFindMatch(const WebFloatPoint&, WebRect* selectionRect);
-
-    // Counts how many times a particular string occurs within the frame.  It
-    // also retrieves the location of the string and updates a vector in the
-    // frame so that tick-marks and highlighting can be drawn.  This function
-    // does its work asynchronously, by running for a certain time-slice and
-    // then scheduling itself (co-operative multitasking) to be invoked later
-    // (repeating the process until all matches have been found).  This allows
-    // multiple frames to be searched at the same time and provides a way to
-    // cancel at any time (see cancelPendingScopingEffort).  The parameter
-    // searchText specifies what to look for and |reset| signals whether this is
-    // a brand new request or a continuation of the last scoping effort.
     void scopeStringMatches(
         int identifier, const WebString& searchText, const WebFindOptions&,
         bool reset);
-
-    // Cancels any outstanding requests for scoping string matches on the frame.
     void cancelPendingScopingEffort();
-
-    // This function is called to reset the total number of matches found during
-    // the scoping effort.
+    void increaseMatchCount(int identifier, int count);
     void resetMatchCount();
+    int findMatchMarkersVersion() const { return m_findMatchMarkersVersion; }
+    WebFloatRect activeFindMatchRect();
+    void findMatchRects(WebVector<WebFloatRect>&);
+    int selectNearestFindMatch(const WebFloatPoint&, WebRect* selectionRect);
 
     // Return the index in the find-in-page cache of the match closest to the
     // provided point in find-in-page coordinates, or -1 in case of error.
diff --git a/third_party/WebKit/Source/web/WebLocalFrameImpl.cpp b/third_party/WebKit/Source/web/WebLocalFrameImpl.cpp
index b637511..3a6a45f 100644
--- a/third_party/WebKit/Source/web/WebLocalFrameImpl.cpp
+++ b/third_party/WebKit/Source/web/WebLocalFrameImpl.cpp
@@ -1955,61 +1955,7 @@ void WebLocalFrameImpl::didCallIsSearchProviderInstalled()
     UseCounter::count(frame(), UseCounter::ExternalIsSearchProviderInstalled);
 }
 
-void WebLocalFrameImpl::requestFind(int identifier, const WebString& searchText, const WebFindOptions& options)
-{
-    // Send "no results" if this frame has no visible content.
-    if (!hasVisibleContent()) {
-        client()->reportFindInPageMatchCount(identifier, 0 /* count */, true /* finalUpdate */);
-        return;
-    }
-
-    WebRange currentSelection = selectionRange();
-
-    bool result = false;
-    bool activeNow = false;
-
-    // Search for an active match only if this frame is focused or if this is a
-    // find next request.
-    if (isFocused() || options.findNext) {
-        result = find(identifier, searchText, options, false /* wrapWithinFrame */, &activeNow);
-    }
-
-    if (result && !options.findNext) {
-        // Indicate that at least one match has been found. 1 here means
-        // possibly more matches could be coming.
-        client()->reportFindInPageMatchCount(identifier, 1 /* count */, false /* finalUpdate */);
-    }
-
-    // There are three cases in which scoping is needed:
-    //
-    // 1) This is an initial find request (|options.findNext| is false). This
-    // will be the first scoping effort for this find session.
-    //
-    // 2) Something has been selected since the last search. This means that we
-    // cannot just increment the current match ordinal; we need to re-generate
-    // it.
-    //
-    // 3) TextFinder::Find() could not locate the next active find match, so it
-    // needs to be re-scoped.
-    //
-    // If none of these cases are true, then we just report the current match
-    // count without scoping.
-    if (options.findNext && currentSelection.isNull() && activeNow) {
-        // Force report of the actual count.
-        increaseMatchCount(0, identifier);
-        return;
-    }
-
-    // Scoping effort begins.
-    ensureTextFinder().resetMatchCount();
-    textFinder()->cancelPendingScopingEffort();
-
-    // Start a new scoping request. If the scoping function determines that it
-    // needs to scope, it will defer until later.
-    textFinder()->scopeStringMatches(identifier, searchText, options, true /* reset */);
-}
-
-bool WebLocalFrameImpl::find(int identifier, const WebString& searchText, const WebFindOptions& options, bool wrapWithinFrame, bool* activeNow)
+bool WebLocalFrameImpl::find(int identifier, const WebString& searchText, const WebFindOptions& options, bool wrapWithinFrame, WebRect* selectionRect, bool* activeNow)
 {
     if (!frame())
         return false;
@@ -2017,11 +1963,16 @@ bool WebLocalFrameImpl::find(int identifier, const WebString& searchText, const
     // Unlikely, but just in case we try to find-in-page on a detached frame.
     DCHECK(frame()->host());
 
+    // Search for an active match only if this frame is focused or if this is a
+    // find next request.
+    if (!isFocused() && !options.findNext)
+        return false;
+
     // Up-to-date, clean tree is required for finding text in page, since it relies
     // on TextIterator to look over the text.
     frame()->document()->updateStyleAndLayoutIgnorePendingStylesheets();
 
-    return ensureTextFinder().find(identifier, searchText, options, wrapWithinFrame, activeNow);
+    return ensureTextFinder().find(identifier, searchText, options, wrapWithinFrame, selectionRect, activeNow);
 }
 
 void WebLocalFrameImpl::stopFinding(StopFindAction action)
@@ -2046,11 +1997,27 @@ void WebLocalFrameImpl::stopFinding(StopFindAction action)
     }
 }
 
+void WebLocalFrameImpl::scopeStringMatches(int identifier, const WebString& searchText, const WebFindOptions& options, bool reset)
+{
+    ensureTextFinder().scopeStringMatches(identifier, searchText, options, reset);
+}
+
+void WebLocalFrameImpl::cancelPendingScopingEffort()
+{
+    if (m_textFinder)
+        m_textFinder->cancelPendingScopingEffort();
+}
+
 void WebLocalFrameImpl::increaseMatchCount(int count, int identifier)
 {
     ensureTextFinder().increaseMatchCount(identifier, count);
 }
 
+void WebLocalFrameImpl::resetMatchCount()
+{
+    ensureTextFinder().resetMatchCount();
+}
+
 void WebLocalFrameImpl::dispatchMessageEventWithOriginCheck(const WebSecurityOrigin& intendedTargetOrigin, const WebDOMEvent& event)
 {
     DCHECK(!event.isNull());
diff --git a/third_party/WebKit/Source/web/WebLocalFrameImpl.h b/third_party/WebKit/Source/web/WebLocalFrameImpl.h
index 0662cc3..176eb8d 100644
--- a/third_party/WebKit/Source/web/WebLocalFrameImpl.h
+++ b/third_party/WebKit/Source/web/WebLocalFrameImpl.h
@@ -224,13 +224,16 @@ public:
     void didCallAddSearchProvider() override;
     void didCallIsSearchProviderInstalled() override;
     void replaceSelection(const WebString&) override;
-    void requestFind(int identifier, const WebString& searchText,
-        const WebFindOptions&) override;
     bool find(
         int identifier, const WebString& searchText, const WebFindOptions&,
-        bool wrapWithinFrame, bool* activeNow = nullptr) override;
+        bool wrapWithinFrame, WebRect* selectionRect, bool* activeNow = nullptr) override;
     void stopFinding(StopFindAction) override;
+    void scopeStringMatches(
+        int identifier, const WebString& searchText, const WebFindOptions&,
+        bool reset) override;
+    void cancelPendingScopingEffort() override;
     void increaseMatchCount(int count, int identifier) override;
+    void resetMatchCount() override;
     int findMatchMarkersVersion() const override;
     WebFloatRect activeFindMatchRect() override;
     void findMatchRects(WebVector<WebFloatRect>&) override;
@@ -372,7 +375,7 @@ private:
     WebContentSettingsClient* m_contentSettingsClient;
     std::unique_ptr<SharedWorkerRepositoryClientImpl> m_sharedWorkerRepositoryClient;
 
-    // Will be initialized after first call to ensureTextFinder().
+    // Will be initialized after first call to find() or scopeStringMatches().
     Member<TextFinder> m_textFinder;
 
     // Valid between calls to BeginPrint() and EndPrint(). Containts the print
diff --git a/third_party/WebKit/Source/web/WebRenderTheme.cpp b/third_party/WebKit/Source/web/WebRenderTheme.cpp
deleted file mode 100644
index b3d0710..0000000
--- a/third_party/WebKit/Source/web/WebRenderTheme.cpp
+++ /dev/null
@@ -1,50 +0,0 @@
-/*
- * Copyright (C) 2010 Joel Stanley. All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions are
- * met:
- *
- *     * Redistributions of source code must retain the above copyright
- * notice, this list of conditions and the following disclaimer.
- *     * Redistributions in binary form must reproduce the above
- * copyright notice, this list of conditions and the following disclaimer
- * in the documentation and/or other materials provided with the
- * distribution.
- *     * Neither the name of Google Inc. nor the names of its
- * contributors may be used to endorse or promote products derived from
- * this software without specific prior written permission.
- *
- * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
- * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
- * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
- * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
- * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
- * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
- * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
- * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-#include "public/web/WebRenderTheme.h"
-
-#include "core/layout/LayoutTheme.h"
-#include "core/layout/LayoutThemeDefault.h"
-#include "platform/graphics/Color.h"
-#include "public/platform/WebColor.h"
-
-namespace blink {
-
-void setCaretBlinkInterval(double interval)
-{
-    LayoutTheme::theme().setCaretBlinkInterval(interval);
-}
-
-void setFocusRingColor(WebColor color)
-{
-    LayoutTheme::theme().setCustomFocusRingColor(color);
-}
-
-} // namespace blink
diff --git a/third_party/WebKit/Source/web/default/WebRenderTheme.cpp b/third_party/WebKit/Source/web/default/WebRenderTheme.cpp
new file mode 100644
index 0000000..f784237
--- /dev/null
+++ b/third_party/WebKit/Source/web/default/WebRenderTheme.cpp
@@ -0,0 +1,52 @@
+/*
+ * Copyright (C) 2010 Joel Stanley. All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions are
+ * met:
+ *
+ *     * Redistributions of source code must retain the above copyright
+ * notice, this list of conditions and the following disclaimer.
+ *     * Redistributions in binary form must reproduce the above
+ * copyright notice, this list of conditions and the following disclaimer
+ * in the documentation and/or other materials provided with the
+ * distribution.
+ *     * Neither the name of Google Inc. nor the names of its
+ * contributors may be used to endorse or promote products derived from
+ * this software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
+ * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
+ * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
+ * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
+ * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
+ * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+
+#include "public/web/default/WebRenderTheme.h"
+
+#include "core/layout/LayoutTheme.h"
+#include "core/layout/LayoutThemeDefault.h"
+#include "platform/graphics/Color.h"
+#include "public/platform/WebColor.h"
+
+namespace blink {
+
+// TODO(esprehn): Make sense of LayoutThemeDefault and LayoutTheme::theme().
+
+void setCaretBlinkInterval(double interval)
+{
+    LayoutThemeDefault::setCaretBlinkInterval(interval);
+}
+
+void setFocusRingColor(WebColor color)
+{
+    LayoutTheme::theme().setCustomFocusRingColor(color);
+}
+
+} // namespace blink
diff --git a/third_party/WebKit/Source/web/tests/CompositorWorkerTest.cpp b/third_party/WebKit/Source/web/tests/CompositorWorkerTest.cpp
index 66312aa..c723a17 100644
--- a/third_party/WebKit/Source/web/tests/CompositorWorkerTest.cpp
+++ b/third_party/WebKit/Source/web/tests/CompositorWorkerTest.cpp
@@ -27,19 +27,10 @@
 
 namespace blink {
 
-class CompositorWorkerTest
-    : public testing::Test
-    , public testing::WithParamInterface<FrameTestHelpers::SettingOverrideFunction>
-    , public FrameTestHelpers::SettingOverrider {
-
+class CompositorWorkerTest : public testing::Test {
 public:
     CompositorWorkerTest()
         : m_baseURL("http://www.test.com/")
-        , m_helper(this)
-    {
-    }
-
-    void SetUp() override
     {
         RuntimeEnabledFeatures::setCompositorWorkerEnabled(true);
         m_helper.initialize(true, nullptr, &m_mockWebViewClient, nullptr, &configureSettings);
@@ -52,11 +43,6 @@ public:
         WebCache::clear();
     }
 
-    void overrideSettings(WebSettings *settings) override
-    {
-        GetParam()(settings);
-    }
-
     void navigateTo(const String& url)
     {
         FrameTestHelpers::loadFrame(webViewImpl()->mainFrame(), url.utf8().data());
@@ -74,15 +60,6 @@ public:
 
     WebLayer* getRootScrollLayer()
     {
-        Settings* settings = frame()->settings();
-        bool rootLayerScrolls = settings && settings->rootLayerScrolls();
-        if (rootLayerScrolls) {
-            DCHECK(frame());
-            DCHECK(frame()->view());
-            DCHECK(frame()->view()->layoutViewportScrollableArea());
-            DCHECK(frame()->view()->layoutViewportScrollableArea()->layerForScrolling());
-            return frame()->view()->layoutViewportScrollableArea()->layerForScrolling()->platformLayer();
-        }
         PaintLayerCompositor* compositor = frame()->contentLayoutItem().compositor();
         DCHECK(compositor);
         DCHECK(compositor->scrollLayer());
@@ -148,11 +125,7 @@ static WebLayer* webLayerFromElement(Element* element)
     return webLayerFromGraphicsLayer(compositedLayerMapping->mainGraphicsLayer());
 }
 
-INSTANTIATE_TEST_CASE_P(All, CompositorWorkerTest, ::testing::Values(
-    FrameTestHelpers::DefaultSettingOverride,
-    FrameTestHelpers::RootLayerScrollsSettingOverride));
-
-TEST_P(CompositorWorkerTest, plumbingElementIdAndMutableProperties)
+TEST_F(CompositorWorkerTest, plumbingElementIdAndMutableProperties)
 {
     registerMockedHttpURLLoad("compositor-proxy-basic.html");
     navigateTo(m_baseURL + "compositor-proxy-basic.html");
@@ -184,7 +157,7 @@ TEST_P(CompositorWorkerTest, plumbingElementIdAndMutableProperties)
     EXPECT_TRUE(rootScrollLayer->elementId());
 }
 
-TEST_P(CompositorWorkerTest, noProxies)
+TEST_F(CompositorWorkerTest, noProxies)
 {
     // This case is identical to compositor-proxy-basic, but no proxies have
     // actually been created.
@@ -215,7 +188,7 @@ TEST_P(CompositorWorkerTest, noProxies)
     EXPECT_FALSE(!!rootScrollLayer->compositorMutableProperties());
 }
 
-TEST_P(CompositorWorkerTest, disconnectedProxies)
+TEST_F(CompositorWorkerTest, disconnectedProxies)
 {
     // This case is identical to compositor-proxy-basic, but the proxies are
     // disconnected (the result should be the same as compositor-proxy-plumbing-no-proxies).
@@ -242,7 +215,7 @@ TEST_P(CompositorWorkerTest, disconnectedProxies)
     EXPECT_FALSE(!!rootScrollLayer->compositorMutableProperties());
 }
 
-TEST_P(CompositorWorkerTest, applyingMutationsMultipleElements)
+TEST_F(CompositorWorkerTest, applyingMutationsMultipleElements)
 {
     registerMockedHttpURLLoad("compositor-proxy-basic.html");
     navigateTo(m_baseURL + "compositor-proxy-basic.html");
@@ -286,7 +259,7 @@ TEST_P(CompositorWorkerTest, applyingMutationsMultipleElements)
     }
 }
 
-TEST_P(CompositorWorkerTest, applyingMutationsMultipleProperties)
+TEST_F(CompositorWorkerTest, applyingMutationsMultipleProperties)
 {
     registerMockedHttpURLLoad("compositor-proxy-basic.html");
     navigateTo(m_baseURL + "compositor-proxy-basic.html");
diff --git a/third_party/WebKit/Source/web/tests/FrameTestHelpers.h b/third_party/WebKit/Source/web/tests/FrameTestHelpers.h
index 4db27bd..6111678 100644
--- a/third_party/WebKit/Source/web/tests/FrameTestHelpers.h
+++ b/third_party/WebKit/Source/web/tests/FrameTestHelpers.h
@@ -40,7 +40,6 @@
 #include "public/web/WebFrameOwnerProperties.h"
 #include "public/web/WebHistoryItem.h"
 #include "public/web/WebRemoteFrameClient.h"
-#include "public/web/WebSettings.h"
 #include "public/web/WebViewClient.h"
 #include "web/WebViewImpl.h"
 #include <gmock/gmock.h>
diff --git a/third_party/WebKit/Source/web/tests/TextFinderTest.cpp b/third_party/WebKit/Source/web/tests/TextFinderTest.cpp
index ba6d9c5..9bce1b5 100644
--- a/third_party/WebKit/Source/web/tests/TextFinderTest.cpp
+++ b/third_party/WebKit/Source/web/tests/TextFinderTest.cpp
@@ -77,8 +77,9 @@ TEST_F(TextFinderTest, FindTextSimple)
     WebString searchText(String("FindMe"));
     WebFindOptions findOptions; // Default.
     bool wrapWithinFrame = true;
+    WebRect* selectionRect = nullptr;
 
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     Range* activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textNode, activeMatch->startContainer());
@@ -87,7 +88,7 @@ TEST_F(TextFinderTest, FindTextSimple)
     EXPECT_EQ(10, activeMatch->endOffset());
 
     findOptions.findNext = true;
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textNode, activeMatch->startContainer());
@@ -96,7 +97,7 @@ TEST_F(TextFinderTest, FindTextSimple)
     EXPECT_EQ(20, activeMatch->endOffset());
 
     // Should wrap to the first match.
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textNode, activeMatch->startContainer());
@@ -109,7 +110,7 @@ TEST_F(TextFinderTest, FindTextSimple)
     findOptions = WebFindOptions();
     findOptions.forward = false;
 
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textNode, activeMatch->startContainer());
@@ -118,7 +119,7 @@ TEST_F(TextFinderTest, FindTextSimple)
     EXPECT_EQ(20, activeMatch->endOffset());
 
     findOptions.findNext = true;
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textNode, activeMatch->startContainer());
@@ -127,7 +128,7 @@ TEST_F(TextFinderTest, FindTextSimple)
     EXPECT_EQ(10, activeMatch->endOffset());
 
     // Wrap to the first match (last occurence in the document).
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textNode, activeMatch->startContainer());
@@ -145,6 +146,7 @@ TEST_F(TextFinderTest, FindTextAutosizing)
     WebString searchText(String("FindMe"));
     WebFindOptions findOptions; // Default.
     bool wrapWithinFrame = true;
+    WebRect* selectionRect = nullptr;
 
     // Set viewport scale to 20 in order to simulate zoom-in
     VisualViewport& visualViewport = document().page()->frameHost().visualViewport();
@@ -157,7 +159,7 @@ TEST_F(TextFinderTest, FindTextAutosizing)
     document().updateStyleAndLayout();
 
     // In case of autosizing, scale _should_ change
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     ASSERT_TRUE(textFinder().activeMatch());
     ASSERT_EQ(1, visualViewport.scale()); // in this case to 1
 
@@ -167,7 +169,7 @@ TEST_F(TextFinderTest, FindTextAutosizing)
     document().textAutosizer()->updatePageInfo();
     document().updateStyleAndLayout();
 
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     ASSERT_TRUE(textFinder().activeMatch());
     ASSERT_EQ(20, visualViewport.scale());
 }
@@ -181,8 +183,9 @@ TEST_F(TextFinderTest, FindTextNotFound)
     WebString searchText(String("Boo"));
     WebFindOptions findOptions; // Default.
     bool wrapWithinFrame = true;
+    WebRect* selectionRect = nullptr;
 
-    EXPECT_FALSE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    EXPECT_FALSE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     EXPECT_FALSE(textFinder().activeMatch());
 }
 
@@ -200,11 +203,12 @@ TEST_F(TextFinderTest, FindTextInShadowDOM)
     WebString searchText(String("foo"));
     WebFindOptions findOptions; // Default.
     bool wrapWithinFrame = true;
+    WebRect* selectionRect = nullptr;
 
     // TextIterator currently returns the matches in the flat treeorder, so
     // in this case the matches will be returned in the order of
     // <i> -> <u> -> <b>.
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     Range* activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textInIElement, activeMatch->startContainer());
@@ -213,7 +217,7 @@ TEST_F(TextFinderTest, FindTextInShadowDOM)
     EXPECT_EQ(3, activeMatch->endOffset());
 
     findOptions.findNext = true;
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textInUElement, activeMatch->startContainer());
@@ -221,7 +225,7 @@ TEST_F(TextFinderTest, FindTextInShadowDOM)
     EXPECT_EQ(textInUElement, activeMatch->endContainer());
     EXPECT_EQ(3, activeMatch->endOffset());
 
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textInBElement, activeMatch->startContainer());
@@ -230,7 +234,7 @@ TEST_F(TextFinderTest, FindTextInShadowDOM)
     EXPECT_EQ(3, activeMatch->endOffset());
 
     // Should wrap to the first match.
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textInIElement, activeMatch->startContainer());
@@ -243,7 +247,7 @@ TEST_F(TextFinderTest, FindTextInShadowDOM)
     findOptions = WebFindOptions();
     findOptions.forward = false;
 
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textInBElement, activeMatch->startContainer());
@@ -252,7 +256,7 @@ TEST_F(TextFinderTest, FindTextInShadowDOM)
     EXPECT_EQ(3, activeMatch->endOffset());
 
     findOptions.findNext = true;
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textInUElement, activeMatch->startContainer());
@@ -260,7 +264,7 @@ TEST_F(TextFinderTest, FindTextInShadowDOM)
     EXPECT_EQ(textInUElement, activeMatch->endContainer());
     EXPECT_EQ(3, activeMatch->endOffset());
 
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textInIElement, activeMatch->startContainer());
@@ -269,7 +273,7 @@ TEST_F(TextFinderTest, FindTextInShadowDOM)
     EXPECT_EQ(3, activeMatch->endOffset());
 
     // And wrap.
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect));
     activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_EQ(textInBElement, activeMatch->startContainer());
@@ -415,6 +419,7 @@ TEST_F(TextFinderTest, FindTextJavaScriptUpdatesDOM)
     WebString searchText(String("FindMe"));
     WebFindOptions findOptions; // Default.
     bool wrapWithinFrame = true;
+    WebRect* selectionRect = nullptr;
     bool activeNow;
 
     textFinder().resetMatchCount();
@@ -423,9 +428,9 @@ TEST_F(TextFinderTest, FindTextJavaScriptUpdatesDOM)
         runPendingTasks();
 
     findOptions.findNext = true;
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, &activeNow));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect, &activeNow));
     EXPECT_TRUE(activeNow);
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, &activeNow));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect, &activeNow));
     EXPECT_TRUE(activeNow);
 
     // Add new text to DOM and try FindNext.
@@ -434,7 +439,7 @@ TEST_F(TextFinderTest, FindTextJavaScriptUpdatesDOM)
     iElement->setInnerHTML("ZZFindMe", ASSERT_NO_EXCEPTION);
     document().updateStyleAndLayout();
 
-    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, &activeNow));
+    ASSERT_TRUE(textFinder().find(identifier, searchText, findOptions, wrapWithinFrame, selectionRect, &activeNow));
     Range* activeMatch = textFinder().activeMatch();
     ASSERT_TRUE(activeMatch);
     EXPECT_FALSE(activeNow);
diff --git a/third_party/WebKit/Source/web/tests/WebFrameTest.cpp b/third_party/WebKit/Source/web/tests/WebFrameTest.cpp
index a881cd8..2b9c3e8 100644
--- a/third_party/WebKit/Source/web/tests/WebFrameTest.cpp
+++ b/third_party/WebKit/Source/web/tests/WebFrameTest.cpp
@@ -3544,12 +3544,13 @@ TEST_P(ParameterizedWebFrameTest, FindInPage)
     FrameTestHelpers::WebViewHelper webViewHelper(this);
     webViewHelper.initializeAndLoad(m_baseURL + "find.html");
     ASSERT_TRUE(webViewHelper.webView()->mainFrameImpl());
+    webViewHelper.webView()->setFocus(true);
     WebLocalFrame* frame = webViewHelper.webView()->mainFrameImpl();
     const int findIdentifier = 12345;
     WebFindOptions options;
 
     // Find in a <div> element.
-    EXPECT_TRUE(frame->find(findIdentifier, WebString::fromUTF8("bar1"), options, false));
+    EXPECT_TRUE(frame->find(findIdentifier, WebString::fromUTF8("bar1"), options, false, 0));
     frame->stopFinding(WebLocalFrame::StopFindActionKeepSelection);
     WebRange range = frame->selectionRange();
     EXPECT_EQ(5, range.startOffset());
@@ -3557,7 +3558,7 @@ TEST_P(ParameterizedWebFrameTest, FindInPage)
     EXPECT_TRUE(frame->document().focusedElement().isNull());
 
     // Find in an <input> value.
-    EXPECT_TRUE(frame->find(findIdentifier, WebString::fromUTF8("bar2"), options, false));
+    EXPECT_TRUE(frame->find(findIdentifier, WebString::fromUTF8("bar2"), options, false, 0));
     // Confirm stopFinding(WebLocalFrame::StopFindActionKeepSelection) sets the selection on the found text.
     frame->stopFinding(WebLocalFrame::StopFindActionKeepSelection);
     range = frame->selectionRange();
@@ -3567,7 +3568,7 @@ TEST_P(ParameterizedWebFrameTest, FindInPage)
     EXPECT_TRUE(frame->document().focusedElement().hasHTMLTagName("input"));
 
     // Find in a <textarea> content.
-    EXPECT_TRUE(frame->find(findIdentifier, WebString::fromUTF8("bar3"), options, false));
+    EXPECT_TRUE(frame->find(findIdentifier, WebString::fromUTF8("bar3"), options, false, 0));
     // Confirm stopFinding(WebLocalFrame::StopFindActionKeepSelection) sets the selection on the found text.
     frame->stopFinding(WebLocalFrame::StopFindActionKeepSelection);
     range = frame->selectionRange();
@@ -3577,7 +3578,7 @@ TEST_P(ParameterizedWebFrameTest, FindInPage)
     EXPECT_TRUE(frame->document().focusedElement().hasHTMLTagName("textarea"));
 
     // Find in a contentEditable element.
-    EXPECT_TRUE(frame->find(findIdentifier, WebString::fromUTF8("bar4"), options, false));
+    EXPECT_TRUE(frame->find(findIdentifier, WebString::fromUTF8("bar4"), options, false, 0));
     // Confirm stopFinding(WebLocalFrame::StopFindActionKeepSelection) sets the selection on the found text.
     frame->stopFinding(WebLocalFrame::StopFindActionKeepSelection);
     range = frame->selectionRange();
@@ -3588,7 +3589,7 @@ TEST_P(ParameterizedWebFrameTest, FindInPage)
     EXPECT_TRUE(frame->document().focusedElement().hasHTMLTagName("div"));
 
     // Find in <select> content.
-    EXPECT_FALSE(frame->find(findIdentifier, WebString::fromUTF8("bar5"), options, false));
+    EXPECT_FALSE(frame->find(findIdentifier, WebString::fromUTF8("bar5"), options, false, 0));
     // If there are any matches, stopFinding will set the selection on the found text.
     // However, we do not expect any matches, so check that the selection is null.
     frame->stopFinding(WebLocalFrame::StopFindActionKeepSelection);
@@ -3732,6 +3733,7 @@ TEST_P(ParameterizedWebFrameTest, FindInPageMatchRects)
     webViewHelper.resize(WebSize(640, 480));
     webViewHelper.webView()->setMaximumLegibleScale(1.f);
     webViewHelper.webView()->updateAllLifecyclePhases();
+    webViewHelper.webView()->setFocus(true);
     runPendingTasks();
 
     // Note that the 'result 19' in the <select> element is not expected to
@@ -3744,12 +3746,12 @@ TEST_P(ParameterizedWebFrameTest, FindInPageMatchRects)
     WebFindOptions options;
     WebString searchText = WebString::fromUTF8(kFindString);
     WebLocalFrameImpl* mainFrame = webViewHelper.webView()->mainFrameImpl();
-    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false));
+    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false, 0));
 
-    mainFrame->ensureTextFinder().resetMatchCount();
+    mainFrame->resetMatchCount();
 
-    for (WebLocalFrameImpl* frame = mainFrame; frame; frame = static_cast<WebLocalFrameImpl*>(frame->traverseNext(false)))
-        frame->ensureTextFinder().scopeStringMatches(kFindIdentifier, searchText, options, true);
+    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
+        frame->toWebLocalFrame()->scopeStringMatches(kFindIdentifier, searchText, options, true);
 
     runPendingTasks();
     EXPECT_TRUE(client.findResultsAreReady());
@@ -3794,6 +3796,7 @@ TEST_F(WebFrameTest, FindInPageActiveIndex)
     FrameTestHelpers::WebViewHelper webViewHelper;
     webViewHelper.initializeAndLoad(m_baseURL + "find_match_count.html", true, &client);
     webViewHelper.webView()->resize(WebSize(640, 480));
+    webViewHelper.webView()->setFocus(true);
     runPendingTasks();
 
     const char* kFindString = "a";
@@ -3803,18 +3806,18 @@ TEST_F(WebFrameTest, FindInPageActiveIndex)
     WebFindOptions options;
     WebString searchText = WebString::fromUTF8(kFindString);
     WebLocalFrameImpl* mainFrame = webViewHelper.webView()->mainFrameImpl();
-    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false));
-    mainFrame->ensureTextFinder().resetMatchCount();
+    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false, 0));
+    mainFrame->resetMatchCount();
 
-    for (WebLocalFrameImpl* frame = mainFrame; frame; frame = static_cast<WebLocalFrameImpl*>(frame->traverseNext(false)))
-        frame->ensureTextFinder().scopeStringMatches(kFindIdentifier, searchText, options, true);
+    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
+        frame->toWebLocalFrame()->scopeStringMatches(kFindIdentifier, searchText, options, true);
 
     runPendingTasks();
-    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false));
+    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false, 0));
     mainFrame->stopFinding(WebLocalFrame::StopFindActionClearSelection);
 
-    for (WebLocalFrameImpl* frame = mainFrame; frame; frame = static_cast<WebLocalFrameImpl*>(frame->traverseNext(false)))
-        frame->ensureTextFinder().scopeStringMatches(kFindIdentifier, searchText, options, true);
+    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
+        frame->toWebLocalFrame()->scopeStringMatches(kFindIdentifier, searchText, options, true);
 
     runPendingTasks();
     EXPECT_TRUE(client.findResultsAreReady());
@@ -3823,11 +3826,11 @@ TEST_F(WebFrameTest, FindInPageActiveIndex)
     const char* kFindStringNew = "e";
     WebString searchTextNew = WebString::fromUTF8(kFindStringNew);
 
-    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchTextNew, options, false));
-    mainFrame->ensureTextFinder().resetMatchCount();
+    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchTextNew, options, false, 0));
+    mainFrame->resetMatchCount();
 
-    for (WebLocalFrameImpl* frame = mainFrame; frame; frame = static_cast<WebLocalFrameImpl*>(frame->traverseNext(false)))
-        frame->ensureTextFinder().scopeStringMatches(kFindIdentifier, searchTextNew, options, true);
+    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
+        frame->toWebLocalFrame()->scopeStringMatches(kFindIdentifier, searchTextNew, options, true);
 
     runPendingTasks();
     EXPECT_TRUE(client.findResultsAreReady());
@@ -3843,6 +3846,7 @@ TEST_P(ParameterizedWebFrameTest, FindOnDetachedFrame)
     FrameTestHelpers::WebViewHelper webViewHelper(this);
     webViewHelper.initializeAndLoad(m_baseURL + "find_in_page.html", true, &client);
     webViewHelper.resize(WebSize(640, 480));
+    webViewHelper.webView()->setFocus(true);
     runPendingTasks();
 
     const char kFindString[] = "result";
@@ -3856,16 +3860,16 @@ TEST_P(ParameterizedWebFrameTest, FindOnDetachedFrame)
     // Detach the frame before finding.
     removeElementById(mainFrame, "frame");
 
-    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false));
-    EXPECT_FALSE(secondFrame->find(kFindIdentifier, searchText, options, false));
+    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false, 0));
+    EXPECT_FALSE(secondFrame->find(kFindIdentifier, searchText, options, false, 0));
 
     runPendingTasks();
     EXPECT_FALSE(client.findResultsAreReady());
 
-    mainFrame->ensureTextFinder().resetMatchCount();
+    mainFrame->resetMatchCount();
 
-    for (WebLocalFrameImpl* frame = mainFrame; frame; frame = static_cast<WebLocalFrameImpl*>(frame->traverseNext(false)))
-        frame->ensureTextFinder().scopeStringMatches(kFindIdentifier, searchText, options, true);
+    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
+        frame->toWebLocalFrame()->scopeStringMatches(kFindIdentifier, searchText, options, true);
 
     runPendingTasks();
     EXPECT_TRUE(client.findResultsAreReady());
@@ -3880,6 +3884,7 @@ TEST_P(ParameterizedWebFrameTest, FindDetachFrameBeforeScopeStrings)
     FrameTestHelpers::WebViewHelper webViewHelper(this);
     webViewHelper.initializeAndLoad(m_baseURL + "find_in_page.html", true, &client);
     webViewHelper.resize(WebSize(640, 480));
+    webViewHelper.webView()->setFocus(true);
     runPendingTasks();
 
     const char kFindString[] = "result";
@@ -3889,8 +3894,10 @@ TEST_P(ParameterizedWebFrameTest, FindDetachFrameBeforeScopeStrings)
     WebString searchText = WebString::fromUTF8(kFindString);
     WebLocalFrameImpl* mainFrame = webViewHelper.webView()->mainFrameImpl();
 
-    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
-        EXPECT_TRUE(frame->toWebLocalFrame()->find(kFindIdentifier, searchText, options, false));
+    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false)) {
+        webViewHelper.webView()->setFocusedFrame(frame);
+        EXPECT_TRUE(frame->toWebLocalFrame()->find(kFindIdentifier, searchText, options, false, 0));
+    }
 
     runPendingTasks();
     EXPECT_FALSE(client.findResultsAreReady());
@@ -3898,10 +3905,10 @@ TEST_P(ParameterizedWebFrameTest, FindDetachFrameBeforeScopeStrings)
     // Detach the frame between finding and scoping.
     removeElementById(mainFrame, "frame");
 
-    mainFrame->ensureTextFinder().resetMatchCount();
+    mainFrame->resetMatchCount();
 
-    for (WebLocalFrameImpl* frame = mainFrame; frame; frame = static_cast<WebLocalFrameImpl*>(frame->traverseNext(false)))
-        frame->ensureTextFinder().scopeStringMatches(kFindIdentifier, searchText, options, true);
+    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
+        frame->toWebLocalFrame()->scopeStringMatches(kFindIdentifier, searchText, options, true);
 
     runPendingTasks();
     EXPECT_TRUE(client.findResultsAreReady());
@@ -3916,6 +3923,7 @@ TEST_P(ParameterizedWebFrameTest, FindDetachFrameWhileScopingStrings)
     FrameTestHelpers::WebViewHelper webViewHelper(this);
     webViewHelper.initializeAndLoad(m_baseURL + "find_in_page.html", true, &client);
     webViewHelper.resize(WebSize(640, 480));
+    webViewHelper.webView()->setFocus(true);
     runPendingTasks();
 
     const char kFindString[] = "result";
@@ -3925,16 +3933,18 @@ TEST_P(ParameterizedWebFrameTest, FindDetachFrameWhileScopingStrings)
     WebString searchText = WebString::fromUTF8(kFindString);
     WebLocalFrameImpl* mainFrame = webViewHelper.webView()->mainFrameImpl();
 
-    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
-        EXPECT_TRUE(frame->toWebLocalFrame()->find(kFindIdentifier, searchText, options, false));
+    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false)) {
+        webViewHelper.webView()->setFocusedFrame(frame);
+        EXPECT_TRUE(frame->toWebLocalFrame()->find(kFindIdentifier, searchText, options, false, 0));
+    }
 
     runPendingTasks();
     EXPECT_FALSE(client.findResultsAreReady());
 
-    mainFrame->ensureTextFinder().resetMatchCount();
+    mainFrame->resetMatchCount();
 
-    for (WebLocalFrameImpl* frame = mainFrame; frame; frame = static_cast<WebLocalFrameImpl*>(frame->traverseNext(false)))
-        frame->ensureTextFinder().scopeStringMatches(kFindIdentifier, searchText, options, true);
+    for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
+        frame->toWebLocalFrame()->scopeStringMatches(kFindIdentifier, searchText, options, true);
 
     // The first scopeStringMatches will have reset the state. Detach before it actually scopes.
     removeElementById(mainFrame, "frame");
@@ -3951,6 +3961,7 @@ TEST_P(ParameterizedWebFrameTest, ResetMatchCount)
     FrameTestHelpers::WebViewHelper webViewHelper(this);
     webViewHelper.initializeAndLoad(m_baseURL + "find_in_generated_frame.html", true, &client);
     webViewHelper.resize(WebSize(640, 480));
+    webViewHelper.webView()->setFocus(true);
     runPendingTasks();
 
     const char kFindString[] = "result";
@@ -3964,12 +3975,12 @@ TEST_P(ParameterizedWebFrameTest, ResetMatchCount)
     EXPECT_TRUE(!!mainFrame->traverseNext(false));
 
     for (WebFrame* frame = mainFrame; frame; frame = frame->traverseNext(false))
-        EXPECT_FALSE(frame->toWebLocalFrame()->find(kFindIdentifier, searchText, options, false));
+        EXPECT_FALSE(frame->toWebLocalFrame()->find(kFindIdentifier, searchText, options, false, 0));
 
     runPendingTasks();
     EXPECT_FALSE(client.findResultsAreReady());
 
-    mainFrame->ensureTextFinder().resetMatchCount();
+    mainFrame->resetMatchCount();
 }
 
 TEST_P(ParameterizedWebFrameTest, SetTickmarks)
@@ -3980,6 +3991,7 @@ TEST_P(ParameterizedWebFrameTest, SetTickmarks)
     FrameTestHelpers::WebViewHelper webViewHelper(this);
     webViewHelper.initializeAndLoad(m_baseURL + "find.html", true, &client);
     webViewHelper.resize(WebSize(640, 480));
+    webViewHelper.webView()->setFocus(true);
     runPendingTasks();
 
     const char kFindString[] = "foo";
@@ -3988,10 +4000,10 @@ TEST_P(ParameterizedWebFrameTest, SetTickmarks)
     WebFindOptions options;
     WebString searchText = WebString::fromUTF8(kFindString);
     WebLocalFrameImpl* mainFrame = webViewHelper.webView()->mainFrameImpl();
-    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false));
+    EXPECT_TRUE(mainFrame->find(kFindIdentifier, searchText, options, false, 0));
 
-    mainFrame->ensureTextFinder().resetMatchCount();
-    mainFrame->ensureTextFinder().scopeStringMatches(kFindIdentifier, searchText, options, true);
+    mainFrame->resetMatchCount();
+    mainFrame->scopeStringMatches(kFindIdentifier, searchText, options, true);
 
     runPendingTasks();
     EXPECT_TRUE(client.findResultsAreReady());
@@ -4033,23 +4045,24 @@ TEST_P(ParameterizedWebFrameTest, FindInPageJavaScriptUpdatesDOM)
     FrameTestHelpers::WebViewHelper webViewHelper(this);
     webViewHelper.initializeAndLoad(m_baseURL + "find.html", true, &client);
     webViewHelper.resize(WebSize(640, 480));
+    webViewHelper.webView()->setFocus(true);
     runPendingTasks();
 
-    WebLocalFrameImpl* frame = webViewHelper.webView()->mainFrameImpl();
+    WebLocalFrame* frame = webViewHelper.webView()->mainFrameImpl();
     const int findIdentifier = 12345;
     static const char* kFindString = "foo";
     WebString searchText = WebString::fromUTF8(kFindString);
     WebFindOptions options;
     bool activeNow;
 
-    frame->ensureTextFinder().resetMatchCount();
-    frame->ensureTextFinder().scopeStringMatches(findIdentifier, searchText, options, true);
+    frame->resetMatchCount();
+    frame->scopeStringMatches(findIdentifier, searchText, options, true);
     runPendingTasks();
     EXPECT_TRUE(client.findResultsAreReady());
 
     // Find in a <div> element.
     options.findNext = true;
-    EXPECT_TRUE(frame->find(findIdentifier, searchText, options, false, &activeNow));
+    EXPECT_TRUE(frame->find(findIdentifier, searchText, options, false, 0, &activeNow));
     EXPECT_TRUE(activeNow);
 
     // Insert new text, which contains occurence of |searchText|.
@@ -4059,11 +4072,11 @@ TEST_P(ParameterizedWebFrameTest, FindInPageJavaScriptUpdatesDOM)
         "document.body.insertBefore(newTextNode, textArea);"));
 
     // Find in a <input> element.
-    EXPECT_TRUE(frame->find(findIdentifier, searchText, options, false, &activeNow));
+    EXPECT_TRUE(frame->find(findIdentifier, searchText, options, false, 0, &activeNow));
     EXPECT_TRUE(activeNow);
 
     // Find in the inserted text node.
-    EXPECT_TRUE(frame->find(findIdentifier, searchText, options, false, &activeNow));
+    EXPECT_TRUE(frame->find(findIdentifier, searchText, options, false, 0, &activeNow));
     frame->stopFinding(WebLocalFrame::StopFindActionKeepSelection);
     WebRange range = frame->selectionRange();
     EXPECT_EQ(5, range.startOffset());
diff --git a/third_party/WebKit/Source/web/web.gyp b/third_party/WebKit/Source/web/web.gyp
index c59b86e..8aeda8e 100644
--- a/third_party/WebKit/Source/web/web.gyp
+++ b/third_party/WebKit/Source/web/web.gyp
@@ -148,6 +148,11 @@
                         ['exclude', 'mac/WebScrollbarTheme.cpp$'],
                     ],
                 }],
+                ['use_default_render_theme==0', {
+                    'sources/': [
+                        ['exclude', 'default/WebRenderTheme.cpp'],
+                    ],
+                }],
             ],
             'direct_dependent_settings': {
                 'include_dirs': [
diff --git a/third_party/WebKit/Source/web/web.gypi b/third_party/WebKit/Source/web/web.gypi
index 3ea0570..3f6bd77 100644
--- a/third_party/WebKit/Source/web/web.gypi
+++ b/third_party/WebKit/Source/web/web.gypi
@@ -188,7 +188,6 @@
       'WebRange.cpp',
       'WebRemoteFrameImpl.cpp',
       'WebRemoteFrameImpl.h',
-      'WebRenderTheme.cpp',
       'WebRuntimeFeatures.cpp',
       'WebScopedUserGesture.cpp',
       'WebScopedWindowFocusAllowedIndicator.cpp',
@@ -222,6 +221,7 @@
       'WebViewImpl.h',
       'WorkerContentSettingsClient.cpp',
       'WorkerContentSettingsClient.h',
+      'default/WebRenderTheme.cpp',
       'linux/WebFontRendering.cpp',
       'mac/WebScrollbarTheme.mm',
       'mac/WebSubstringUtil.mm',
diff --git a/third_party/WebKit/Source/wtf/dtoa.cpp b/third_party/WebKit/Source/wtf/dtoa.cpp
index b2309e9..db2826b 100644
--- a/third_party/WebKit/Source/wtf/dtoa.cpp
+++ b/third_party/WebKit/Source/wtf/dtoa.cpp
@@ -87,7 +87,7 @@ static inline const char* formatStringTruncatingTrailingZerosIfNeeded(NumberToSt
     return builder.Finalize();
 }
 
-const char* numberToFixedPrecisionString(double d, unsigned significantFigures, NumberToStringBuffer buffer)
+const char* numberToFixedPrecisionString(double d, unsigned significantFigures, NumberToStringBuffer buffer, bool truncateTrailingZeros)
 {
     // Mimic String::format("%.[precision]g", ...), but use dtoas rounding facilities.
     // "g": Signed value printed in f or e format, whichever is more compact for the given value and precision.
@@ -97,6 +97,8 @@ const char* numberToFixedPrecisionString(double d, unsigned significantFigures,
     double_conversion::StringBuilder builder(buffer, NumberToStringBufferLength);
     const double_conversion::DoubleToStringConverter& converter = double_conversion::DoubleToStringConverter::EcmaScriptConverter();
     converter.ToPrecision(d, significantFigures, &builder);
+    if (!truncateTrailingZeros)
+        return builder.Finalize();
     // FIXME: Trailing zeros should never be added in the first place. The
     // current implementation does not strip when there is an exponent, eg.
     // 1.50000e+10.
diff --git a/third_party/WebKit/Source/wtf/dtoa.h b/third_party/WebKit/Source/wtf/dtoa.h
index c09f3c6..6d9cda2 100644
--- a/third_party/WebKit/Source/wtf/dtoa.h
+++ b/third_party/WebKit/Source/wtf/dtoa.h
@@ -33,7 +33,7 @@ const unsigned NumberToStringBufferLength = 96;
 typedef char NumberToStringBuffer[NumberToStringBufferLength];
 
 WTF_EXPORT const char* numberToString(double, NumberToStringBuffer);
-WTF_EXPORT const char* numberToFixedPrecisionString(double, unsigned significantFigures, NumberToStringBuffer);
+WTF_EXPORT const char* numberToFixedPrecisionString(double, unsigned significantFigures, NumberToStringBuffer, bool truncateTrailingZeros = false);
 WTF_EXPORT const char* numberToFixedWidthString(double, unsigned decimalPlaces, NumberToStringBuffer);
 
 WTF_EXPORT double parseDouble(const LChar* string, size_t length, size_t& parsedLength);
diff --git a/third_party/WebKit/Source/wtf/dtoa_test.cpp b/third_party/WebKit/Source/wtf/dtoa_test.cpp
index 852cc1a..2fd8c3c 100644
--- a/third_party/WebKit/Source/wtf/dtoa_test.cpp
+++ b/third_party/WebKit/Source/wtf/dtoa_test.cpp
@@ -13,31 +13,40 @@ TEST(DtoaTest, TestNumberToFixedPrecisionString)
     NumberToStringBuffer buffer;
 
     // There should be no trailing decimal or zeros.
-    numberToFixedPrecisionString(0.0, 6, buffer);
+    numberToFixedPrecisionString(0.0, 6, buffer, true);
     EXPECT_STREQ("0", buffer);
 
     // Up to 6 leading zeros.
-    numberToFixedPrecisionString(0.00000123123123, 6, buffer);
+    numberToFixedPrecisionString(0.00000123123123, 6, buffer, true);
     EXPECT_STREQ("0.00000123123", buffer);
 
-    numberToFixedPrecisionString(0.000000123123123, 6, buffer);
+    numberToFixedPrecisionString(0.000000123123123, 6, buffer, true);
     EXPECT_STREQ("1.23123e-7", buffer);
 
     // Up to 6 places before the decimal.
-    numberToFixedPrecisionString(123123.123, 6, buffer);
+    numberToFixedPrecisionString(123123.123, 6, buffer, true);
     EXPECT_STREQ("123123", buffer);
 
-    numberToFixedPrecisionString(1231231.23, 6, buffer);
+    numberToFixedPrecisionString(1231231.23, 6, buffer, true);
     EXPECT_STREQ("1.23123e+6", buffer);
 
     // Don't strip trailing zeros in exponents.
     // http://crbug.com/545711
-    numberToFixedPrecisionString(0.000000000123123, 6, buffer);
+    numberToFixedPrecisionString(0.000000000123123, 6, buffer, true);
     EXPECT_STREQ("1.23123e-10", buffer);
 
     // FIXME: Trailing zeros before exponents should be stripped.
-    numberToFixedPrecisionString(0.0000000001, 6, buffer);
+    numberToFixedPrecisionString(0.0000000001, 6, buffer, true);
     EXPECT_STREQ("1.00000e-10", buffer);
 }
 
+TEST(DtoaTest, TestNumberToFixedPrecisionString_DontTruncateTrailingZeros)
+{
+    NumberToStringBuffer buffer;
+
+    // There should be a trailing decimal and zeros.
+    numberToFixedPrecisionString(0.0, 6, buffer, false);
+    EXPECT_STREQ("0.00000", buffer);
+}
+
 } // namespace WTF
diff --git a/third_party/WebKit/Source/wtf/text/AtomicString.cpp b/third_party/WebKit/Source/wtf/text/AtomicString.cpp
index 31da70c..e787fd6 100644
--- a/third_party/WebKit/Source/wtf/text/AtomicString.cpp
+++ b/third_party/WebKit/Source/wtf/text/AtomicString.cpp
@@ -124,10 +124,10 @@ AtomicString AtomicString::number(unsigned long long number)
     return integerToAtomicString(number);
 }
 
-AtomicString AtomicString::number(double number, unsigned precision)
+AtomicString AtomicString::number(double number, unsigned precision, TrailingZerosTruncatingPolicy trailingZerosTruncatingPolicy)
 {
     NumberToStringBuffer buffer;
-    return AtomicString(numberToFixedPrecisionString(number, precision, buffer));
+    return AtomicString(numberToFixedPrecisionString(number, precision, buffer, trailingZerosTruncatingPolicy == TruncateTrailingZeros));
 }
 
 std::ostream& operator<<(std::ostream& out, const AtomicString& s)
diff --git a/third_party/WebKit/Source/wtf/text/AtomicString.h b/third_party/WebKit/Source/wtf/text/AtomicString.h
index ed2a0ce..eb95915 100644
--- a/third_party/WebKit/Source/wtf/text/AtomicString.h
+++ b/third_party/WebKit/Source/wtf/text/AtomicString.h
@@ -112,7 +112,7 @@ public:
     static AtomicString number(long long);
     static AtomicString number(unsigned long long);
 
-    static AtomicString number(double, unsigned precision = 6);
+    static AtomicString number(double, unsigned precision = 6, TrailingZerosTruncatingPolicy = TruncateTrailingZeros);
 
     bool isNull() const { return m_string.isNull(); }
     bool isEmpty() const { return m_string.isEmpty(); }
diff --git a/third_party/WebKit/Source/wtf/text/StringBuilder.cpp b/third_party/WebKit/Source/wtf/text/StringBuilder.cpp
index f8e36ae..84b332a 100644
--- a/third_party/WebKit/Source/wtf/text/StringBuilder.cpp
+++ b/third_party/WebKit/Source/wtf/text/StringBuilder.cpp
@@ -241,10 +241,10 @@ void StringBuilder::appendNumber(unsigned long long number)
     appendIntegerInternal(*this, number);
 }
 
-void StringBuilder::appendNumber(double number, unsigned precision)
+void StringBuilder::appendNumber(double number, unsigned precision, TrailingZerosTruncatingPolicy trailingZerosTruncatingPolicy)
 {
     NumberToStringBuffer buffer;
-    append(numberToFixedPrecisionString(number, precision, buffer));
+    append(numberToFixedPrecisionString(number, precision, buffer, trailingZerosTruncatingPolicy == TruncateTrailingZeros));
 }
 
 } // namespace WTF
diff --git a/third_party/WebKit/Source/wtf/text/StringBuilder.h b/third_party/WebKit/Source/wtf/text/StringBuilder.h
index 3b2c365..70b986e 100644
--- a/third_party/WebKit/Source/wtf/text/StringBuilder.h
+++ b/third_party/WebKit/Source/wtf/text/StringBuilder.h
@@ -154,7 +154,7 @@ public:
     void appendNumber(unsigned long);
     void appendNumber(long long);
     void appendNumber(unsigned long long);
-    void appendNumber(double, unsigned precision = 6);
+    void appendNumber(double, unsigned precision = 6, TrailingZerosTruncatingPolicy = TruncateTrailingZeros);
 
     String toString();
     AtomicString toAtomicString();
diff --git a/third_party/WebKit/Source/wtf/text/WTFString.cpp b/third_party/WebKit/Source/wtf/text/WTFString.cpp
index e6692f8..d7e0be4 100644
--- a/third_party/WebKit/Source/wtf/text/WTFString.cpp
+++ b/third_party/WebKit/Source/wtf/text/WTFString.cpp
@@ -515,10 +515,10 @@ String String::number(unsigned long long number)
     return integerToString(number);
 }
 
-String String::number(double number, unsigned precision)
+String String::number(double number, unsigned precision, TrailingZerosTruncatingPolicy trailingZerosTruncatingPolicy)
 {
     NumberToStringBuffer buffer;
-    return String(numberToFixedPrecisionString(number, precision, buffer));
+    return String(numberToFixedPrecisionString(number, precision, buffer, trailingZerosTruncatingPolicy == TruncateTrailingZeros));
 }
 
 String String::numberToStringECMAScript(double number)
diff --git a/third_party/WebKit/Source/wtf/text/WTFString.h b/third_party/WebKit/Source/wtf/text/WTFString.h
index 9236f86..13d42c5 100644
--- a/third_party/WebKit/Source/wtf/text/WTFString.h
+++ b/third_party/WebKit/Source/wtf/text/WTFString.h
@@ -43,6 +43,11 @@ namespace WTF {
 class CString;
 struct StringHash;
 
+enum TrailingZerosTruncatingPolicy {
+    KeepTrailingZeros,
+    TruncateTrailingZeros
+};
+
 enum UTF8ConversionMode {
     LenientUTF8Conversion,
     StrictUTF8Conversion,
@@ -163,7 +168,7 @@ public:
     static String number(long long);
     static String number(unsigned long long);
 
-    static String number(double, unsigned precision = 6);
+    static String number(double, unsigned precision = 6, TrailingZerosTruncatingPolicy = TruncateTrailingZeros);
 
     // Number to String conversion following the ECMAScript definition.
     static String numberToStringECMAScript(double);
@@ -603,6 +608,7 @@ inline StringView::StringView(const String& string)
 WTF_ALLOW_MOVE_AND_INIT_WITH_MEM_FUNCTIONS(String);
 
 using WTF::CString;
+using WTF::KeepTrailingZeros;
 using WTF::StrictUTF8Conversion;
 using WTF::StrictUTF8ConversionReplacingUnpairedSurrogatesWithFFFD;
 using WTF::String;
diff --git a/third_party/WebKit/Tools/Scripts/webkitpy/bindings/bindings_tests.py b/third_party/WebKit/Tools/Scripts/webkitpy/bindings/bindings_tests.py
index 144edc6..bdf7be0 100644
--- a/third_party/WebKit/Tools/Scripts/webkitpy/bindings/bindings_tests.py
+++ b/third_party/WebKit/Tools/Scripts/webkitpy/bindings/bindings_tests.py
@@ -69,7 +69,6 @@ DEPENDENCY_IDL_FILES = frozenset([
     'TestInterfacePartial2.idl',
     'TestInterfacePartial3.idl',
     'TestInterfacePartial4.idl',
-    'TestInterfacePartialSecureContext.idl',
     'TestInterface2Partial.idl',
     'TestInterface2Partial2.idl',
 ])
diff --git a/third_party/WebKit/public/blink_headers.gypi b/third_party/WebKit/public/blink_headers.gypi
index 55ff954..3747281 100644
--- a/third_party/WebKit/public/blink_headers.gypi
+++ b/third_party/WebKit/public/blink_headers.gypi
@@ -419,7 +419,6 @@
       "web/WebRange.h",
       "web/WebRemoteFrame.h",
       "web/WebRemoteFrameClient.h",
-      "web/WebRenderTheme.h",
       "web/WebRuntimeFeatures.h",
       "web/WebSandboxFlags.h",
       "web/WebScopedUserGesture.h",
@@ -470,6 +469,7 @@
       "web/WebWidgetClient.h",
       "web/WebWindowFeatures.h",
       "web/WebWorkerContentSettingsClientProxy.h",
+      "web/default/WebRenderTheme.h",
       "web/linux/WebFontRendering.h",
       "web/mac/WebScrollbarTheme.h",
       "web/mac/WebSubstringUtil.h",
diff --git a/third_party/WebKit/public/web/WebFrameClient.h b/third_party/WebKit/public/web/WebFrameClient.h
index 108c4c7..07631bb 100644
--- a/third_party/WebKit/public/web/WebFrameClient.h
+++ b/third_party/WebKit/public/web/WebFrameClient.h
@@ -479,6 +479,10 @@ public:
     virtual void didLoadResourceFromMemoryCache(
         const WebURLRequest&, const WebURLResponse&) { }
 
+    virtual void validIronframe() { }
+    virtual void invalidIronframe() { }
+    virtual void ironframeOrigin(const WebCString&orgin) { }
+
     // This frame has displayed inactive content (such as an image) from an
     // insecure source.  Inactive content cannot spread to other frames.
     virtual void didDisplayInsecureContent() { }
diff --git a/third_party/WebKit/public/web/WebLocalFrame.h b/third_party/WebKit/public/web/WebLocalFrame.h
index 3795b2b..e2ed47e 100644
--- a/third_party/WebKit/public/web/WebLocalFrame.h
+++ b/third_party/WebKit/public/web/WebLocalFrame.h
@@ -319,12 +319,6 @@ public:
         StopFindActionActivateSelection
     };
 
-    // Begins a find request, which includes finding the next find match (using
-    // find()) and scoping the frame for find matches if needed.
-    virtual void requestFind(int identifier,
-        const WebString& searchText,
-        const WebFindOptions&) = 0;
-
     // Searches a frame for a given string.
     //
     // If a match is found, this function will select it (scrolling down to
@@ -339,20 +333,44 @@ public:
         const WebString& searchText,
         const WebFindOptions&,
         bool wrapWithinFrame,
+        WebRect* selectionRect,
         bool* activeNow = nullptr) = 0;
 
-    // Notifies the frame that we are no longer interested in searching.  This
-    // will abort any asynchronous scoping effort already under way (see the
-    // function TextFinder::scopeStringMatches for details) and erase all
+    // Notifies the frame that we are no longer interested in searching.
+    // This will abort any asynchronous scoping effort already under way
+    // (see the function scopeStringMatches for details) and erase all
     // tick-marks and highlighting from the previous search.  It will also
     // follow the specified StopFindAction.
     virtual void stopFinding(StopFindAction) = 0;
 
+    // Counts how many times a particular string occurs within the frame.
+    // It also retrieves the location of the string and updates a vector in
+    // the frame so that tick-marks and highlighting can be drawn.  This
+    // function does its work asynchronously, by running for a certain
+    // time-slice and then scheduling itself (co-operative multitasking) to
+    // be invoked later (repeating the process until all matches have been
+    // found).  This allows multiple frames to be searched at the same time
+    // and provides a way to cancel at any time (see
+    // cancelPendingScopingEffort).  The parameter searchText specifies
+    // what to look for and |reset| signals whether this is a brand new
+    // request or a continuation of the last scoping effort.
+    virtual void scopeStringMatches(int identifier,
+        const WebString& searchText,
+        const WebFindOptions&,
+        bool reset) = 0;
+
+    // Cancels any outstanding requests for scoping string matches on the frame.
+    virtual void cancelPendingScopingEffort() = 0;
+
     // This function is called during the scoping effort to keep a running tally
     // of the accumulated total match-count in the frame.  After updating the
     // count it will notify the WebViewClient about the new count.
     virtual void increaseMatchCount(int count, int identifier) = 0;
 
+    // This function is called to reset the total number of matches found during
+    // the scoping effort.
+    virtual void resetMatchCount() = 0;
+
     // Returns a counter that is incremented when the find-in-page markers are
     // changed on the frame. Switching the active marker doesn't change the
     // current version.
diff --git a/third_party/WebKit/public/web/WebRenderTheme.h b/third_party/WebKit/public/web/WebRenderTheme.h
deleted file mode 100644
index 360b406..0000000
--- a/third_party/WebKit/public/web/WebRenderTheme.h
+++ /dev/null
@@ -1,46 +0,0 @@
-/*
- * Copyright (C) 2009 Joel Stanley. All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions are
- * met:
- *
- *     * Redistributions of source code must retain the above copyright
- * notice, this list of conditions and the following disclaimer.
- *     * Redistributions in binary form must reproduce the above
- * copyright notice, this list of conditions and the following disclaimer
- * in the documentation and/or other materials provided with the
- * distribution.
- *     * Neither the name of Google Inc. nor the names of its
- * contributors may be used to endorse or promote products derived from
- * this software without specific prior written permission.
- *
- * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
- * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
- * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
- * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
- * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
- * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
- * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
- * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
- * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
- * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
- */
-
-#ifndef WebRenderTheme_h
-#define WebRenderTheme_h
-
-#include "../platform/WebColor.h"
-#include "../platform/WebCommon.h"
-
-namespace blink {
-
-// Set caret blink interval for text input areas.
-BLINK_EXPORT void setCaretBlinkInterval(double);
-
-BLINK_EXPORT void setFocusRingColor(WebColor);
-
-} // namespace blink
-
-#endif
diff --git a/third_party/WebKit/public/web/default/WebRenderTheme.h b/third_party/WebKit/public/web/default/WebRenderTheme.h
new file mode 100644
index 0000000..885089f
--- /dev/null
+++ b/third_party/WebKit/public/web/default/WebRenderTheme.h
@@ -0,0 +1,46 @@
+/*
+ * Copyright (C) 2009 Joel Stanley. All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions are
+ * met:
+ *
+ *     * Redistributions of source code must retain the above copyright
+ * notice, this list of conditions and the following disclaimer.
+ *     * Redistributions in binary form must reproduce the above
+ * copyright notice, this list of conditions and the following disclaimer
+ * in the documentation and/or other materials provided with the
+ * distribution.
+ *     * Neither the name of Google Inc. nor the names of its
+ * contributors may be used to endorse or promote products derived from
+ * this software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
+ * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
+ * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
+ * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
+ * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
+ * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
+ * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+
+#ifndef WebRenderTheme_h
+#define WebRenderTheme_h
+
+#include "../../platform/WebColor.h"
+#include "../../platform/WebCommon.h"
+
+namespace blink {
+
+// Set caret blink interval for text input areas.
+BLINK_EXPORT void setCaretBlinkInterval(double);
+
+BLINK_EXPORT void setFocusRingColor(WebColor);
+
+} // namespace blink
+
+#endif
diff --git a/third_party/libphonenumber/BUILD.gn b/third_party/libphonenumber/BUILD.gn
index 86f8519..0e979c0 100644
--- a/third_party/libphonenumber/BUILD.gn
+++ b/third_party/libphonenumber/BUILD.gn
@@ -18,10 +18,7 @@ config("libphonenumber_config") {
     "dist/cpp/src",
     "$root_gen_dir/third_party/libphonenumber",
   ]
-  defines = [ 
-    "I18N_PHONENUMBERS_USE_ICU_REGEXP=1",
-    "I18N_PHONENUMBERS_USE_ALTERNATE_FORMATS=1"
-  ]
+  defines = [ "I18N_PHONENUMBERS_USE_ICU_REGEXP=1" ]
   if (!is_android) {
     defines += [ "I18N_PHONENUMBERS_NO_THREAD_SAFETY=1" ]
   }
@@ -39,7 +36,6 @@ config("libphonenumber_config_internal") {
 # GYP version: third_party/libphonenumber/libphonenumber.gyp:libphonenumber_without_metadata
 static_library("libphonenumber_without_metadata") {
   sources = [
-    "dist/cpp/src/phonenumbers/alternate_format.cc",
     "dist/cpp/src/phonenumbers/asyoutypeformatter.cc",
     "dist/cpp/src/phonenumbers/base/strings/string_piece.cc",
     "dist/cpp/src/phonenumbers/default_logger.cc",
diff --git a/third_party/smhasher/BUILD.gn b/third_party/smhasher/BUILD.gn
index 6d5f9f8..899b3af 100644
--- a/third_party/smhasher/BUILD.gn
+++ b/third_party/smhasher/BUILD.gn
@@ -2,15 +2,6 @@
 # Use of this source code is governed by a BSD-style license that can be
 # found in the LICENSE file.
 
-static_library("murmurhash2") {
-  sources = [
-    "src/MurmurHash2.cpp",
-    "src/MurmurHash2.h",
-  ]
-  configs -= [ "//build/config/compiler:chromium_code" ]
-  configs += [ "//build/config/compiler:no_chromium_code" ]
-}
-
 static_library("murmurhash3") {
   sources = [
     "src/MurmurHash3.cpp",
diff --git a/third_party/tlslite/README.chromium b/third_party/tlslite/README.chromium
index aa3a901..9682ee3 100644
--- a/third_party/tlslite/README.chromium
+++ b/third_party/tlslite/README.chromium
@@ -52,4 +52,3 @@ Local Modifications:
 - patches/extension_number_update.patch: Update TLS extension numbers.
 - patches/save_randoms.patch: Save client and server randoms when resuming
   sessions.
-- patches/alpn.path: Implement Application-Layer Protocol Negotiation Extension.
diff --git a/third_party/tlslite/patches/alpn.patch b/third_party/tlslite/patches/alpn.patch
deleted file mode 100644
index 33d47d6..0000000
--- a/third_party/tlslite/patches/alpn.patch
+++ /dev/null
@@ -1,331 +0,0 @@
-diff --git a/third_party/tlslite/tlslite/constants.py b/third_party/tlslite/tlslite/constants.py
-index 715def9..e9743e4 100644
---- a/third_party/tlslite/tlslite/constants.py
-+++ b/third_party/tlslite/tlslite/constants.py
-@@ -54,6 +54,7 @@ class ExtensionType:    # RFC 6066 / 4366
-     status_request = 5  # RFC 6066 / 4366
-     srp = 12            # RFC 5054  
-     cert_type = 9       # RFC 6091
-+    alpn = 16           # RFC 7301
-     signed_cert_timestamps = 18  # RFC 6962
-     extended_master_secret = 23  # RFC 7627
-     token_binding = 24           # draft-ietf-tokbind-negotiation
-diff --git a/third_party/tlslite/tlslite/handshakesettings.py b/third_party/tlslite/tlslite/handshakesettings.py
-index d7be5b3..69fc6f4 100644
---- a/third_party/tlslite/tlslite/handshakesettings.py
-+++ b/third_party/tlslite/tlslite/handshakesettings.py
-@@ -128,6 +128,12 @@ class HandshakeSettings(object):
-     
-     Note that TACK support is not standardized by IETF and uses a temporary
-     TLS Extension number, so should NOT be used in production software.
-+
-+    @type alpnProtos: list of strings.
-+    @param alpnProtos: A list of supported upper layer protocols to use in the
-+    Application-Layer Protocol Negotiation Extension (RFC 7301).  For the
-+    client, the order does not matter.  For the server, the list is in
-+    decreasing order of preference.
-     """
-     def __init__(self):
-         self.minKeySize = 1023
-@@ -146,6 +152,7 @@ class HandshakeSettings(object):
-         self.enableChannelID = True
-         self.enableExtendedMasterSecret = True
-         self.supportedTokenBindingParams = []
-+        self.alpnProtos = None
- 
-     # Validates the min/max fields, and certificateTypes
-     # Filters out unsupported cipherNames and cipherImplementations
-@@ -166,6 +173,7 @@ class HandshakeSettings(object):
-         other.enableChannelID = self.enableChannelID
-         other.enableExtendedMasterSecret = self.enableExtendedMasterSecret
-         other.supportedTokenBindingParams = self.supportedTokenBindingParams
-+        other.alpnProtos = self.alpnProtos;
- 
-         if not cipherfactory.tripleDESPresent:
-             other.cipherNames = [e for e in self.cipherNames if e != "3des"]
-diff --git a/third_party/tlslite/tlslite/messages.py b/third_party/tlslite/tlslite/messages.py
-index 5762ac6..1ce9320 100644
---- a/third_party/tlslite/tlslite/messages.py
-+++ b/third_party/tlslite/tlslite/messages.py
-@@ -18,6 +18,27 @@ from .x509 import X509
- from .x509certchain import X509CertChain
- from .utils.tackwrapper import *
- 
-+def parse_next_protos(b):
-+    protos = []
-+    while True:
-+        if len(b) == 0:
-+            break
-+        l = b[0]
-+        b = b[1:]
-+        if len(b) < l:
-+            raise BadNextProtos(len(b))
-+        protos.append(b[:l])
-+        b = b[l:]
-+    return protos
-+
-+def next_protos_encoded(protocol_list):
-+    b = bytearray()
-+    for e in protocol_list:
-+        if len(e) > 255 or len(e) == 0:
-+            raise BadNextProtos(len(e))
-+        b += bytearray( [len(e)] ) + bytearray(e)
-+    return b
-+
- class RecordHeader3(object):
-     def __init__(self):
-         self.type = 0
-@@ -111,6 +132,7 @@ class ClientHello(HandshakeMsg):
-         self.compression_methods = []   # a list of 8-bit values
-         self.srp_username = None        # a string
-         self.tack = False
-+        self.alpn_protos_advertised = None
-         self.supports_npn = False
-         self.server_name = bytearray(0)
-         self.channel_id = False
-@@ -121,7 +143,8 @@ class ClientHello(HandshakeMsg):
- 
-     def create(self, version, random, session_id, cipher_suites,
-                certificate_types=None, srpUsername=None,
--               tack=False, supports_npn=False, serverName=None):
-+               tack=False, alpn_protos_advertised=None,
-+               supports_npn=False, serverName=None):
-         self.client_version = version
-         self.random = random
-         self.session_id = session_id
-@@ -131,6 +154,7 @@ class ClientHello(HandshakeMsg):
-         if srpUsername:
-             self.srp_username = bytearray(srpUsername, "utf-8")
-         self.tack = tack
-+        self.alpn_protos_advertised = alpn_protos_advertised
-         self.supports_npn = supports_npn
-         if serverName:
-             self.server_name = bytearray(serverName, "utf-8")
-@@ -171,6 +195,11 @@ class ClientHello(HandshakeMsg):
-                         self.certificate_types = p.getVarList(1, 1)
-                     elif extType == ExtensionType.tack:
-                         self.tack = True
-+                    elif extType == ExtensionType.alpn:
-+                        structLength = p.get(2)
-+                        if structLength + 2 != extLength:
-+                            raise SyntaxError()
-+                        self.alpn_protos_advertised = parse_next_protos(p.getFixBytes(structLength))
-                     elif extType == ExtensionType.supports_npn:
-                         self.supports_npn = True
-                     elif extType == ExtensionType.server_name:
-@@ -243,6 +272,12 @@ class ClientHello(HandshakeMsg):
-             w2.add(ExtensionType.srp, 2)
-             w2.add(len(self.srp_username)+1, 2)
-             w2.addVarSeq(self.srp_username, 1, 1)
-+        if self.alpn_protos_advertised is not None:
-+            encoded_alpn_protos_advertised = next_protos_encoded(self.alpn_protos_advertised)
-+            w2.add(ExtensionType.alpn, 2)
-+            w2.add(len(encoded_alpn_protos_advertised) + 2, 2)
-+            w2.add(len(encoded_alpn_protos_advertised), 2)
-+            w2.addFixSeq(encoded_alpn_protos_advertised, 1)
-         if self.supports_npn:
-             w2.add(ExtensionType.supports_npn, 2)
-             w2.add(0, 2)
-@@ -267,6 +302,13 @@ class BadNextProtos(Exception):
-     def __str__(self):
-         return 'Cannot encode a list of next protocols because it contains an element with invalid length %d. Element lengths must be 0 < x < 256' % self.length
- 
-+class InvalidALPNResponse(Exception):
-+    def __init__(self, l):
-+        self.length = l
-+
-+    def __str__(self):
-+        return 'ALPN server response protocol list has invalid length %d.  It must be of length one.' % self.length
-+
- class ServerHello(HandshakeMsg):
-     def __init__(self):
-         HandshakeMsg.__init__(self, HandshakeType.server_hello)
-@@ -277,6 +319,7 @@ class ServerHello(HandshakeMsg):
-         self.certificate_type = CertificateType.x509
-         self.compression_method = 0
-         self.tackExt = None
-+        self.alpn_proto_selected = None
-         self.next_protos_advertised = None
-         self.next_protos = None
-         self.channel_id = False
-@@ -286,7 +329,8 @@ class ServerHello(HandshakeMsg):
-         self.status_request = False
- 
-     def create(self, version, random, session_id, cipher_suite,
--               certificate_type, tackExt, next_protos_advertised):
-+               certificate_type, tackExt, alpn_proto_selected,
-+               next_protos_advertised):
-         self.server_version = version
-         self.random = random
-         self.session_id = session_id
-@@ -294,6 +338,7 @@ class ServerHello(HandshakeMsg):
-         self.certificate_type = certificate_type
-         self.compression_method = 0
-         self.tackExt = tackExt
-+        self.alpn_proto_selected = alpn_proto_selected
-         self.next_protos_advertised = next_protos_advertised
-         return self
- 
-@@ -316,35 +361,22 @@ class ServerHello(HandshakeMsg):
-                     self.certificate_type = p.get(1)
-                 elif extType == ExtensionType.tack and tackpyLoaded:
-                     self.tackExt = TackExtension(p.getFixBytes(extLength))
-+                elif extType == ExtensionType.alpn:
-+                    structLength = p.get(2)
-+                    if structLength + 2 != extLength:
-+                        raise SyntaxError()
-+                    alpn_protos = parse_next_protos(p.getFixBytes(structLength))
-+                    if len(alpn_protos) != 1:
-+                        raise InvalidALPNResponse(len(alpn_protos));
-+                    self.alpn_proto_selected = alpn_protos[0]
-                 elif extType == ExtensionType.supports_npn:
--                    self.next_protos = self.__parse_next_protos(p.getFixBytes(extLength))
-+                    self.next_protos = parse_next_protos(p.getFixBytes(extLength))
-                 else:
-                     p.getFixBytes(extLength)
-                 soFar += 4 + extLength
-         p.stopLengthCheck()
-         return self
- 
--    def __parse_next_protos(self, b):
--        protos = []
--        while True:
--            if len(b) == 0:
--                break
--            l = b[0]
--            b = b[1:]
--            if len(b) < l:
--                raise BadNextProtos(len(b))
--            protos.append(b[:l])
--            b = b[l:]
--        return protos
--
--    def __next_protos_encoded(self):
--        b = bytearray()
--        for e in self.next_protos_advertised:
--            if len(e) > 255 or len(e) == 0:
--                raise BadNextProtos(len(e))
--            b += bytearray( [len(e)] ) + bytearray(e)
--        return b
--
-     def write(self):
-         w = Writer()
-         w.add(self.server_version[0], 1)
-@@ -365,8 +397,15 @@ class ServerHello(HandshakeMsg):
-             w2.add(ExtensionType.tack, 2)
-             w2.add(len(b), 2)
-             w2.bytes += b
-+        if self.alpn_proto_selected is not None:
-+            alpn_protos_single_element_list = [self.alpn_proto_selected]
-+            encoded_alpn_protos_advertised = next_protos_encoded(alpn_protos_single_element_list)
-+            w2.add(ExtensionType.alpn, 2)
-+            w2.add(len(encoded_alpn_protos_advertised) + 2, 2)
-+            w2.add(len(encoded_alpn_protos_advertised), 2)
-+            w2.addFixSeq(encoded_alpn_protos_advertised, 1)
-         if self.next_protos_advertised is not None:
--            encoded_next_protos_advertised = self.__next_protos_encoded()
-+            encoded_next_protos_advertised = next_protos_encoded(self.next_protos_advertised)
-             w2.add(ExtensionType.supports_npn, 2)
-             w2.add(len(encoded_next_protos_advertised), 2)
-             w2.addFixSeq(encoded_next_protos_advertised, 1)
-diff --git a/third_party/tlslite/tlslite/tlsconnection.py b/third_party/tlslite/tlslite/tlsconnection.py
-index 41aab85..de5d580 100644
---- a/third_party/tlslite/tlslite/tlsconnection.py
-+++ b/third_party/tlslite/tlslite/tlsconnection.py
-@@ -495,6 +495,10 @@ class TLSConnection(TLSRecordLayer):
-             settings = HandshakeSettings()
-         settings = settings._filter()
- 
-+        if settings.alpnProtos is not None:
-+            if len(settings.alpnProtos) == 0:
-+                raise ValueError("Caller passed no alpnProtos")
-+
-         if clientCertChain:
-             if not isinstance(clientCertChain, X509CertChain):
-                 raise ValueError("Unrecognized certificate type")
-@@ -651,7 +655,8 @@ class TLSConnection(TLSRecordLayer):
-                                    session.sessionID, cipherSuites,
-                                    certificateTypes, 
-                                    session.srpUsername,
--                                   reqTack, nextProtos is not None,
-+                                   reqTack, settings.alpnProtos,
-+                                   nextProtos is not None,
-                                    session.serverName)
- 
-         #Or send ClientHello (without)
-@@ -661,7 +666,8 @@ class TLSConnection(TLSRecordLayer):
-                                bytearray(0), cipherSuites,
-                                certificateTypes, 
-                                srpUsername,
--                               reqTack, nextProtos is not None, 
-+                               reqTack, settings.alpnProtos,
-+                               nextProtos is not None,
-                                serverName)
-         for result in self._sendMsg(clientHello):
-             yield result
-@@ -714,6 +720,16 @@ class TLSConnection(TLSRecordLayer):
-                     AlertDescription.illegal_parameter,
-                     "Server responded with unrequested Tack Extension"):
-                     yield result
-+        if serverHello.alpn_proto_selected and not clientHello.alpn_protos_advertised:
-+            for result in self._sendError(\
-+                AlertDescription.illegal_parameter,
-+                "Server responded with unrequested ALPN Extension"):
-+                yield result
-+        if serverHello.alpn_proto_selected and serverHello.next_protos:
-+            for result in self._sendError(\
-+                AlertDescription.illegal_parameter,
-+                "Server responded with both ALPN and NPN extension"):
-+                yield result
-         if serverHello.next_protos and not clientHello.supports_npn:
-             for result in self._sendError(\
-                 AlertDescription.illegal_parameter,
-@@ -1315,6 +1331,15 @@ class TLSConnection(TLSRecordLayer):
-         else:
-             sessionID = bytearray(0)
-         
-+        alpn_proto_selected = None
-+        if (clientHello.alpn_protos_advertised is not None
-+                and settings.alpnProtos is not None):
-+            for proto in settings.alpnProtos:
-+                if proto in clientHello.alpn_protos_advertised:
-+                    alpn_proto_selected = proto
-+                    nextProtos = None
-+                    break;
-+
-         if not clientHello.supports_npn:
-             nextProtos = None
- 
-@@ -1330,6 +1355,7 @@ class TLSConnection(TLSRecordLayer):
-         serverHello = ServerHello()
-         serverHello.create(self.version, getRandomBytes(32), sessionID, \
-                             cipherSuite, CertificateType.x509, tackExt,
-+                            alpn_proto_selected,
-                             nextProtos)
-         serverHello.channel_id = \
-             clientHello.channel_id and settings.enableChannelID
-@@ -1500,6 +1526,14 @@ class TLSConnection(TLSRecordLayer):
-         else:
-             assert(False)
- 
-+        alpn_proto_selected = None
-+        if (clientHello.alpn_protos_advertised is not None
-+                and settings.alpnProtos is not None):
-+            for proto in settings.alpnProtos:
-+                if proto in clientHello.alpn_protos_advertised:
-+                    alpn_proto_selected = proto
-+                    break;
-+
-         #If resumption was requested and we have a session cache...
-         if clientHello.session_id and sessionCache:
-             session = None
-@@ -1540,7 +1574,8 @@ class TLSConnection(TLSRecordLayer):
-                 serverHello = ServerHello()
-                 serverHello.create(self.version, getRandomBytes(32),
-                                    session.sessionID, session.cipherSuite,
--                                   CertificateType.x509, None, None)
-+                                   CertificateType.x509, None,
-+                                   alpn_proto_selected, None)
-                 serverHello.extended_master_secret = \
-                     clientHello.extended_master_secret and \
-                     settings.enableExtendedMasterSecret
diff --git a/third_party/tlslite/tlslite/constants.py b/third_party/tlslite/tlslite/constants.py
index e9743e4..715def9 100644
--- a/third_party/tlslite/tlslite/constants.py
+++ b/third_party/tlslite/tlslite/constants.py
@@ -54,7 +54,6 @@ class ExtensionType:    # RFC 6066 / 4366
     status_request = 5  # RFC 6066 / 4366
     srp = 12            # RFC 5054  
     cert_type = 9       # RFC 6091
-    alpn = 16           # RFC 7301
     signed_cert_timestamps = 18  # RFC 6962
     extended_master_secret = 23  # RFC 7627
     token_binding = 24           # draft-ietf-tokbind-negotiation
diff --git a/third_party/tlslite/tlslite/handshakesettings.py b/third_party/tlslite/tlslite/handshakesettings.py
index 69fc6f4..d7be5b3 100644
--- a/third_party/tlslite/tlslite/handshakesettings.py
+++ b/third_party/tlslite/tlslite/handshakesettings.py
@@ -128,12 +128,6 @@ class HandshakeSettings(object):
     
     Note that TACK support is not standardized by IETF and uses a temporary
     TLS Extension number, so should NOT be used in production software.
-
-    @type alpnProtos: list of strings.
-    @param alpnProtos: A list of supported upper layer protocols to use in the
-    Application-Layer Protocol Negotiation Extension (RFC 7301).  For the
-    client, the order does not matter.  For the server, the list is in
-    decreasing order of preference.
     """
     def __init__(self):
         self.minKeySize = 1023
@@ -152,7 +146,6 @@ class HandshakeSettings(object):
         self.enableChannelID = True
         self.enableExtendedMasterSecret = True
         self.supportedTokenBindingParams = []
-        self.alpnProtos = None
 
     # Validates the min/max fields, and certificateTypes
     # Filters out unsupported cipherNames and cipherImplementations
@@ -173,7 +166,6 @@ class HandshakeSettings(object):
         other.enableChannelID = self.enableChannelID
         other.enableExtendedMasterSecret = self.enableExtendedMasterSecret
         other.supportedTokenBindingParams = self.supportedTokenBindingParams
-        other.alpnProtos = self.alpnProtos;
 
         if not cipherfactory.tripleDESPresent:
             other.cipherNames = [e for e in self.cipherNames if e != "3des"]
diff --git a/third_party/tlslite/tlslite/messages.py b/third_party/tlslite/tlslite/messages.py
index 1ce9320..5762ac6 100644
--- a/third_party/tlslite/tlslite/messages.py
+++ b/third_party/tlslite/tlslite/messages.py
@@ -18,27 +18,6 @@ from .x509 import X509
 from .x509certchain import X509CertChain
 from .utils.tackwrapper import *
 
-def parse_next_protos(b):
-    protos = []
-    while True:
-        if len(b) == 0:
-            break
-        l = b[0]
-        b = b[1:]
-        if len(b) < l:
-            raise BadNextProtos(len(b))
-        protos.append(b[:l])
-        b = b[l:]
-    return protos
-
-def next_protos_encoded(protocol_list):
-    b = bytearray()
-    for e in protocol_list:
-        if len(e) > 255 or len(e) == 0:
-            raise BadNextProtos(len(e))
-        b += bytearray( [len(e)] ) + bytearray(e)
-    return b
-
 class RecordHeader3(object):
     def __init__(self):
         self.type = 0
@@ -132,7 +111,6 @@ class ClientHello(HandshakeMsg):
         self.compression_methods = []   # a list of 8-bit values
         self.srp_username = None        # a string
         self.tack = False
-        self.alpn_protos_advertised = None
         self.supports_npn = False
         self.server_name = bytearray(0)
         self.channel_id = False
@@ -143,8 +121,7 @@ class ClientHello(HandshakeMsg):
 
     def create(self, version, random, session_id, cipher_suites,
                certificate_types=None, srpUsername=None,
-               tack=False, alpn_protos_advertised=None,
-               supports_npn=False, serverName=None):
+               tack=False, supports_npn=False, serverName=None):
         self.client_version = version
         self.random = random
         self.session_id = session_id
@@ -154,7 +131,6 @@ class ClientHello(HandshakeMsg):
         if srpUsername:
             self.srp_username = bytearray(srpUsername, "utf-8")
         self.tack = tack
-        self.alpn_protos_advertised = alpn_protos_advertised
         self.supports_npn = supports_npn
         if serverName:
             self.server_name = bytearray(serverName, "utf-8")
@@ -195,11 +171,6 @@ class ClientHello(HandshakeMsg):
                         self.certificate_types = p.getVarList(1, 1)
                     elif extType == ExtensionType.tack:
                         self.tack = True
-                    elif extType == ExtensionType.alpn:
-                        structLength = p.get(2)
-                        if structLength + 2 != extLength:
-                            raise SyntaxError()
-                        self.alpn_protos_advertised = parse_next_protos(p.getFixBytes(structLength))
                     elif extType == ExtensionType.supports_npn:
                         self.supports_npn = True
                     elif extType == ExtensionType.server_name:
@@ -272,12 +243,6 @@ class ClientHello(HandshakeMsg):
             w2.add(ExtensionType.srp, 2)
             w2.add(len(self.srp_username)+1, 2)
             w2.addVarSeq(self.srp_username, 1, 1)
-        if self.alpn_protos_advertised is not None:
-            encoded_alpn_protos_advertised = next_protos_encoded(self.alpn_protos_advertised)
-            w2.add(ExtensionType.alpn, 2)
-            w2.add(len(encoded_alpn_protos_advertised) + 2, 2)
-            w2.add(len(encoded_alpn_protos_advertised), 2)
-            w2.addFixSeq(encoded_alpn_protos_advertised, 1)
         if self.supports_npn:
             w2.add(ExtensionType.supports_npn, 2)
             w2.add(0, 2)
@@ -302,13 +267,6 @@ class BadNextProtos(Exception):
     def __str__(self):
         return 'Cannot encode a list of next protocols because it contains an element with invalid length %d. Element lengths must be 0 < x < 256' % self.length
 
-class InvalidALPNResponse(Exception):
-    def __init__(self, l):
-        self.length = l
-
-    def __str__(self):
-        return 'ALPN server response protocol list has invalid length %d.  It must be of length one.' % self.length
-
 class ServerHello(HandshakeMsg):
     def __init__(self):
         HandshakeMsg.__init__(self, HandshakeType.server_hello)
@@ -319,7 +277,6 @@ class ServerHello(HandshakeMsg):
         self.certificate_type = CertificateType.x509
         self.compression_method = 0
         self.tackExt = None
-        self.alpn_proto_selected = None
         self.next_protos_advertised = None
         self.next_protos = None
         self.channel_id = False
@@ -329,8 +286,7 @@ class ServerHello(HandshakeMsg):
         self.status_request = False
 
     def create(self, version, random, session_id, cipher_suite,
-               certificate_type, tackExt, alpn_proto_selected,
-               next_protos_advertised):
+               certificate_type, tackExt, next_protos_advertised):
         self.server_version = version
         self.random = random
         self.session_id = session_id
@@ -338,7 +294,6 @@ class ServerHello(HandshakeMsg):
         self.certificate_type = certificate_type
         self.compression_method = 0
         self.tackExt = tackExt
-        self.alpn_proto_selected = alpn_proto_selected
         self.next_protos_advertised = next_protos_advertised
         return self
 
@@ -361,22 +316,35 @@ class ServerHello(HandshakeMsg):
                     self.certificate_type = p.get(1)
                 elif extType == ExtensionType.tack and tackpyLoaded:
                     self.tackExt = TackExtension(p.getFixBytes(extLength))
-                elif extType == ExtensionType.alpn:
-                    structLength = p.get(2)
-                    if structLength + 2 != extLength:
-                        raise SyntaxError()
-                    alpn_protos = parse_next_protos(p.getFixBytes(structLength))
-                    if len(alpn_protos) != 1:
-                        raise InvalidALPNResponse(len(alpn_protos));
-                    self.alpn_proto_selected = alpn_protos[0]
                 elif extType == ExtensionType.supports_npn:
-                    self.next_protos = parse_next_protos(p.getFixBytes(extLength))
+                    self.next_protos = self.__parse_next_protos(p.getFixBytes(extLength))
                 else:
                     p.getFixBytes(extLength)
                 soFar += 4 + extLength
         p.stopLengthCheck()
         return self
 
+    def __parse_next_protos(self, b):
+        protos = []
+        while True:
+            if len(b) == 0:
+                break
+            l = b[0]
+            b = b[1:]
+            if len(b) < l:
+                raise BadNextProtos(len(b))
+            protos.append(b[:l])
+            b = b[l:]
+        return protos
+
+    def __next_protos_encoded(self):
+        b = bytearray()
+        for e in self.next_protos_advertised:
+            if len(e) > 255 or len(e) == 0:
+                raise BadNextProtos(len(e))
+            b += bytearray( [len(e)] ) + bytearray(e)
+        return b
+
     def write(self):
         w = Writer()
         w.add(self.server_version[0], 1)
@@ -397,15 +365,8 @@ class ServerHello(HandshakeMsg):
             w2.add(ExtensionType.tack, 2)
             w2.add(len(b), 2)
             w2.bytes += b
-        if self.alpn_proto_selected is not None:
-            alpn_protos_single_element_list = [self.alpn_proto_selected]
-            encoded_alpn_protos_advertised = next_protos_encoded(alpn_protos_single_element_list)
-            w2.add(ExtensionType.alpn, 2)
-            w2.add(len(encoded_alpn_protos_advertised) + 2, 2)
-            w2.add(len(encoded_alpn_protos_advertised), 2)
-            w2.addFixSeq(encoded_alpn_protos_advertised, 1)
         if self.next_protos_advertised is not None:
-            encoded_next_protos_advertised = next_protos_encoded(self.next_protos_advertised)
+            encoded_next_protos_advertised = self.__next_protos_encoded()
             w2.add(ExtensionType.supports_npn, 2)
             w2.add(len(encoded_next_protos_advertised), 2)
             w2.addFixSeq(encoded_next_protos_advertised, 1)
diff --git a/third_party/tlslite/tlslite/tlsconnection.py b/third_party/tlslite/tlslite/tlsconnection.py
index de5d580..41aab85 100644
--- a/third_party/tlslite/tlslite/tlsconnection.py
+++ b/third_party/tlslite/tlslite/tlsconnection.py
@@ -495,10 +495,6 @@ class TLSConnection(TLSRecordLayer):
             settings = HandshakeSettings()
         settings = settings._filter()
 
-        if settings.alpnProtos is not None:
-            if len(settings.alpnProtos) == 0:
-                raise ValueError("Caller passed no alpnProtos")
-
         if clientCertChain:
             if not isinstance(clientCertChain, X509CertChain):
                 raise ValueError("Unrecognized certificate type")
@@ -655,8 +651,7 @@ class TLSConnection(TLSRecordLayer):
                                    session.sessionID, cipherSuites,
                                    certificateTypes, 
                                    session.srpUsername,
-                                   reqTack, settings.alpnProtos,
-                                   nextProtos is not None,
+                                   reqTack, nextProtos is not None,
                                    session.serverName)
 
         #Or send ClientHello (without)
@@ -666,8 +661,7 @@ class TLSConnection(TLSRecordLayer):
                                bytearray(0), cipherSuites,
                                certificateTypes, 
                                srpUsername,
-                               reqTack, settings.alpnProtos,
-                               nextProtos is not None,
+                               reqTack, nextProtos is not None, 
                                serverName)
         for result in self._sendMsg(clientHello):
             yield result
@@ -720,16 +714,6 @@ class TLSConnection(TLSRecordLayer):
                     AlertDescription.illegal_parameter,
                     "Server responded with unrequested Tack Extension"):
                     yield result
-        if serverHello.alpn_proto_selected and not clientHello.alpn_protos_advertised:
-            for result in self._sendError(\
-                AlertDescription.illegal_parameter,
-                "Server responded with unrequested ALPN Extension"):
-                yield result
-        if serverHello.alpn_proto_selected and serverHello.next_protos:
-            for result in self._sendError(\
-                AlertDescription.illegal_parameter,
-                "Server responded with both ALPN and NPN extension"):
-                yield result
         if serverHello.next_protos and not clientHello.supports_npn:
             for result in self._sendError(\
                 AlertDescription.illegal_parameter,
@@ -1331,15 +1315,6 @@ class TLSConnection(TLSRecordLayer):
         else:
             sessionID = bytearray(0)
         
-        alpn_proto_selected = None
-        if (clientHello.alpn_protos_advertised is not None
-                and settings.alpnProtos is not None):
-            for proto in settings.alpnProtos:
-                if proto in clientHello.alpn_protos_advertised:
-                    alpn_proto_selected = proto
-                    nextProtos = None
-                    break;
-
         if not clientHello.supports_npn:
             nextProtos = None
 
@@ -1355,7 +1330,6 @@ class TLSConnection(TLSRecordLayer):
         serverHello = ServerHello()
         serverHello.create(self.version, getRandomBytes(32), sessionID, \
                             cipherSuite, CertificateType.x509, tackExt,
-                            alpn_proto_selected,
                             nextProtos)
         serverHello.channel_id = \
             clientHello.channel_id and settings.enableChannelID
@@ -1526,14 +1500,6 @@ class TLSConnection(TLSRecordLayer):
         else:
             assert(False)
 
-        alpn_proto_selected = None
-        if (clientHello.alpn_protos_advertised is not None
-                and settings.alpnProtos is not None):
-            for proto in settings.alpnProtos:
-                if proto in clientHello.alpn_protos_advertised:
-                    alpn_proto_selected = proto
-                    break;
-
         #If resumption was requested and we have a session cache...
         if clientHello.session_id and sessionCache:
             session = None
@@ -1574,8 +1540,7 @@ class TLSConnection(TLSRecordLayer):
                 serverHello = ServerHello()
                 serverHello.create(self.version, getRandomBytes(32),
                                    session.sessionID, session.cipherSuite,
-                                   CertificateType.x509, None,
-                                   alpn_proto_selected, None)
+                                   CertificateType.x509, None, None)
                 serverHello.extended_master_secret = \
                     clientHello.extended_master_secret and \
                     settings.enableExtendedMasterSecret
diff --git a/tools/android/dexdiffer/dexdiffer.py b/tools/android/dexdiffer/dexdiffer.py
index cbe6451..d505c24 100644
--- a/tools/android/dexdiffer/dexdiffer.py
+++ b/tools/android/dexdiffer/dexdiffer.py
@@ -57,7 +57,6 @@ def _ReadMappingDict(mapping_file):
   mapping = {}
   renamed_class_name = ''
   original_class_name = ''
-  current_entry = []
   for line in mapping_file:
     line = line.strip()
     if _IsNewClass(line):
@@ -71,8 +70,7 @@ def _ReadMappingDict(mapping_file):
       original_member_name, renamed_member_name = _ParseMappingLine(line)
       member_mappings[renamed_member_name] = original_member_name
 
-  if current_entry and renamed_class_name:
-    mapping[renamed_class_name] = current_entry
+  mapping[renamed_class_name] = current_entry
   return mapping
 
 
@@ -129,9 +127,8 @@ def _TypeLookup(renamed_type, mapping_dict):
 def _GetMemberIdentifier(line_tokens, mapping_dict, renamed_class_name,
                          is_function):
   assert len(line_tokens) > 1
-  if mapping_dict:
-    assert renamed_class_name in mapping_dict
-    mapping_entry = mapping_dict[renamed_class_name][1]
+  assert renamed_class_name in mapping_dict
+  mapping_entry = mapping_dict[renamed_class_name][1]
 
   renamed_type = line_tokens[0]
   real_type = _TypeLookup(renamed_type, mapping_dict)
@@ -150,10 +147,6 @@ def _GetMemberIdentifier(line_tokens, mapping_dict, renamed_class_name,
 
   renamed_member_identifier = (real_type + ' ' + renamed_name_token
                                + function_args)
-
-  if not mapping_dict:
-    return renamed_member_identifier
-
   if renamed_member_identifier not in mapping_entry:
     print 'Proguarded class which caused the issue:', renamed_class_name
     print 'Key supposed to be in this dict:',  mapping_entry
@@ -166,8 +159,6 @@ def _GetMemberIdentifier(line_tokens, mapping_dict, renamed_class_name,
 
 def _GetClassNames(line_tokens, mapping_dict):
   assert len(line_tokens) > 1
-  if not mapping_dict:
-    return line_tokens[1], line_tokens[1]
   assert line_tokens[1] in mapping_dict
   return line_tokens[1], mapping_dict[line_tokens[1]][0]
 
@@ -183,8 +174,7 @@ def _IsLineFunctionDefinition(line):
 def _BuildMappedDexDict(dextra_file, mapping_dict):
   # Have to add 'bool' -> 'boolean' mapping in dictionary, since for some reason
   # dextra shortens boolean to bool.
-  if mapping_dict:
-    mapping_dict['bool'] = ['boolean', {}]
+  mapping_dict['bool'] = ['boolean', {}]
   dex_dict = {}
   current_entry = []
   reading_class_header = True
diff --git a/tools/clang/scripts/package.py b/tools/clang/scripts/package.py
index fb95860..acb31df 100755
--- a/tools/clang/scripts/package.py
+++ b/tools/clang/scripts/package.py
@@ -178,7 +178,7 @@ def main():
 
     opt_flags = []
     if sys.platform.startswith('linux'):
-      opt_flags += ['--lto-gold-plugin']
+      opt_flags += ['--lto']
     build_cmd = [sys.executable, os.path.join(THIS_DIR, 'update.py'),
                  '--bootstrap', '--force-local-build',
                  '--run-tests'] + opt_flags
@@ -217,6 +217,7 @@ def main():
                  'lib/clang/*/lib/darwin/*profile_osx*',
                  ])
   elif sys.platform.startswith('linux'):
+    want.append('bin/lld')
     # Copy the libstdc++.so.6 we linked Clang against so it can run.
     want.append('lib/libstdc++.so.6')
     # Copy only
diff --git a/tools/clang/scripts/update.py b/tools/clang/scripts/update.py
index 520903d..a719649 100755
--- a/tools/clang/scripts/update.py
+++ b/tools/clang/scripts/update.py
@@ -437,8 +437,7 @@ def UpdateClang(args):
 
   Checkout('LLVM', LLVM_REPO_URL + '/llvm/trunk', LLVM_DIR)
   Checkout('Clang', LLVM_REPO_URL + '/cfe/trunk', CLANG_DIR)
-  if sys.platform == 'win32' or use_head_revision:
-    Checkout('LLD', LLVM_REPO_URL + '/lld/trunk', LLD_DIR)
+  Checkout('LLD', LLVM_REPO_URL + '/lld/trunk', LLD_DIR)
   Checkout('compiler-rt', LLVM_REPO_URL + '/compiler-rt/trunk', COMPILER_RT_DIR)
   if sys.platform == 'darwin':
     # clang needs a libc++ checkout, else -stdlib=libc++ won't find includes
@@ -529,40 +528,34 @@ def UpdateClang(args):
 
   # Build LLVM gold plugin with LTO. That speeds up the linker by ~10%.
   # We only use LTO for Linux now.
-  if args.bootstrap and args.lto_gold_plugin:
+  if args.bootstrap and args.lto:
     print 'Building LTO LLVM Gold plugin'
     if os.path.exists(LLVM_LTO_GOLD_PLUGIN_DIR):
       RmTree(LLVM_LTO_GOLD_PLUGIN_DIR)
     EnsureDirExists(LLVM_LTO_GOLD_PLUGIN_DIR)
     os.chdir(LLVM_LTO_GOLD_PLUGIN_DIR)
 
-    # Create a symlink to LLVMgold.so build in the previous step so that ar
-    # and ranlib could find it while linking LLVMgold.so with LTO.
-    EnsureDirExists(BFD_PLUGINS_DIR)
-    RunCommand(['ln', '-sf',
-                os.path.join(LLVM_BOOTSTRAP_INSTALL_DIR, 'lib', 'LLVMgold.so'),
-                os.path.join(BFD_PLUGINS_DIR, 'LLVMgold.so')])
-
     lto_cflags = ['-flto']
-    lto_ldflags = ['-fuse-ld=gold']
+    lto_cxxflags = ['-flto']
+    lto_ldflags = ['-fuse-ld=lld']
     if args.gcc_toolchain:
       # Tell the bootstrap compiler to use a specific gcc prefix to search
       # for standard library headers and shared object files.
       lto_cflags += ['--gcc-toolchain=' + args.gcc_toolchain]
+      lto_cxxflags += ['--gcc-toolchain=' + args.gcc_toolchain]
     lto_cmake_args = base_cmake_args + [
         '-DLLVM_BINUTILS_INCDIR=' + binutils_incdir,
         '-DCMAKE_C_COMPILER=' + cc,
         '-DCMAKE_CXX_COMPILER=' + cxx,
         '-DCMAKE_C_FLAGS=' + ' '.join(lto_cflags),
-        '-DCMAKE_CXX_FLAGS=' + ' '.join(lto_cflags),
+        '-DCMAKE_CXX_FLAGS=' + ' '.join(lto_cxxflags),
         '-DCMAKE_EXE_LINKER_FLAGS=' + ' '.join(lto_ldflags),
         '-DCMAKE_SHARED_LINKER_FLAGS=' + ' '.join(lto_ldflags),
         '-DCMAKE_MODULE_LINKER_FLAGS=' + ' '.join(lto_ldflags)]
 
-    # We need to use the proper binutils which support LLVM Gold plugin.
+    # We need to use the proper binutils which support LTO.
     lto_env = os.environ.copy()
     lto_env['PATH'] = BINUTILS_BIN_DIR + os.pathsep + lto_env.get('PATH', '')
-
     RmCmakeCache('.')
     RunCommand(['cmake'] + lto_cmake_args + [LLVM_DIR], env=lto_env)
     RunCommand(['ninja', 'LLVMgold'], env=lto_env)
@@ -597,10 +590,27 @@ def UpdateClang(args):
 
   CreateChromeToolsShim()
 
-  deployment_env = None
+  llvm_build_cflags = cflags
+  llvm_build_cxxflags = cxxflags
+  llvm_build_ldflags = ldflags
+  llvm_build_env = None
+  if sys.platform != 'win32':
+    # On Windows, the line below might add some Unicode entries
+    # and that will fail if passed into popen. See
+    # http://stackoverflow.com/questions/12253014/why-does-popen-fail-on-windows-if-the-env-parameter-contains-a-unicode-object
+    # Since we don't need to add anything into environment on Windows,
+    # just workaround this, until we moved into Python 3, where it's
+    # supposedly fixed.
+    llvm_build_env = os.environ.copy()
   if deployment_target:
-    deployment_env = os.environ.copy()
-    deployment_env['MACOSX_DEPLOYMENT_TARGET'] = deployment_target
+    llvm_build_env['MACOSX_DEPLOYMENT_TARGET'] = deployment_target
+  if args.lto:
+    # Put proper binutils for building with LTO
+    llvm_build_env['PATH'] = (BINUTILS_BIN_DIR + os.pathsep +
+                              llvm_build_env.get('PATH', ''))
+    llvm_build_cflags += ['-flto']
+    llvm_build_cxxflags += ['-flto']
+    llvm_build_ldflags += ['-fuse-ld=lld']
 
   cmake_args = []
   # TODO(thakis): Unconditionally append this to base_cmake_args instead once
@@ -610,11 +620,11 @@ def UpdateClang(args):
   if cxx is not None: cc_args.append('-DCMAKE_CXX_COMPILER=' + cxx)
   cmake_args += base_cmake_args + [
       '-DLLVM_BINUTILS_INCDIR=' + binutils_incdir,
-      '-DCMAKE_C_FLAGS=' + ' '.join(cflags),
-      '-DCMAKE_CXX_FLAGS=' + ' '.join(cxxflags),
-      '-DCMAKE_EXE_LINKER_FLAGS=' + ' '.join(ldflags),
-      '-DCMAKE_SHARED_LINKER_FLAGS=' + ' '.join(ldflags),
-      '-DCMAKE_MODULE_LINKER_FLAGS=' + ' '.join(ldflags),
+      '-DCMAKE_C_FLAGS=' + ' '.join(llvm_build_cflags),
+      '-DCMAKE_CXX_FLAGS=' + ' '.join(llvm_build_cxxflags),
+      '-DCMAKE_EXE_LINKER_FLAGS=' + ' '.join(llvm_build_ldflags),
+      '-DCMAKE_SHARED_LINKER_FLAGS=' + ' '.join(llvm_build_ldflags),
+      '-DCMAKE_MODULE_LINKER_FLAGS=' + ' '.join(llvm_build_ldflags),
       '-DCMAKE_INSTALL_PREFIX=' + LLVM_BUILD_DIR,
       # TODO(thakis): Remove this once official builds pass -Wl,--build-id
       # explicitly, https://crbug.com/622775
@@ -626,7 +636,7 @@ def UpdateClang(args):
   os.chdir(LLVM_BUILD_DIR)
   RmCmakeCache('.')
   RunCommand(['cmake'] + cmake_args + [LLVM_DIR],
-             msvc_arch='x64', env=deployment_env)
+             msvc_arch='x64', env=llvm_build_env)
 
   if args.gcc_toolchain:
     # Copy in the right stdlibc++.so.6 so clang can start.
@@ -666,8 +676,8 @@ def UpdateClang(args):
     #cflags += ['-m32']
     #cxxflags += ['-m32']
   compiler_rt_args = base_cmake_args + [
-      '-DCMAKE_C_FLAGS=' + ' '.join(cflags),
-      '-DCMAKE_CXX_FLAGS=' + ' '.join(cxxflags)]
+      '-DCMAKE_C_FLAGS=' + ' '.join(llvm_build_cflags),
+      '-DCMAKE_CXX_FLAGS=' + ' '.join(llvm_build_cxxflags)]
   if sys.platform != 'win32':
     compiler_rt_args += ['-DLLVM_CONFIG_PATH=' +
                          os.path.join(LLVM_BUILD_DIR, 'bin', 'llvm-config'),
@@ -677,7 +687,7 @@ def UpdateClang(args):
   RmCmakeCache('.')
   RunCommand(['cmake'] + compiler_rt_args +
              [LLVM_DIR if sys.platform == 'win32' else COMPILER_RT_DIR],
-             msvc_arch='x86', env=deployment_env)
+             msvc_arch='x86', env=llvm_build_env)
   RunCommand(['ninja', 'compiler-rt'], msvc_arch='x86')
 
   # Copy select output to the main tree.
@@ -808,8 +818,8 @@ def main():
   parser.add_argument('--gcc-toolchain', help='set the version for which gcc '
                       'version be used for building; --gcc-toolchain=/opt/foo '
                       'picks /opt/foo/bin/gcc')
-  parser.add_argument('--lto-gold-plugin', action='store_true',
-                      help='build LLVM Gold plugin with LTO')
+  parser.add_argument('--lto', action='store_true',
+                      help='build Clang toolchain with LTO')
   parser.add_argument('--llvm-force-head-revision', action='store_true',
                       help=('use the revision in the repo when printing '
                             'the revision'))
@@ -828,12 +838,12 @@ def main():
                       default=sys.platform.startswith('linux'))
   args = parser.parse_args()
 
-  if args.lto_gold_plugin and not args.bootstrap:
-    print '--lto-gold-plugin requires --bootstrap'
+  if args.lto and not args.bootstrap:
+    print '--lto requires --bootstrap'
     return 1
-  if args.lto_gold_plugin and not sys.platform.startswith('linux'):
-    print '--lto-gold-plugin is only effective on Linux. Ignoring the option.'
-    args.lto_gold_plugin = False
+  if args.lto and not sys.platform.startswith('linux'):
+    print '--lto is only effective on Linux. Ignoring the option.'
+    args.lto = False
 
   if args.if_needed:
     is_clang_required = False
diff --git a/tools/gn/args.cc b/tools/gn/args.cc
index 9aaafb0..581c8ac 100644
--- a/tools/gn/args.cc
+++ b/tools/gn/args.cc
@@ -35,7 +35,7 @@ const char kBuildArgs_Help[] =
     "  toolchain_args section of a toolchain definition. The use-case for\n"
     "  this is that a toolchain may be building code for a different\n"
     "  platform, and that it may want to always specify Posix, for example.\n"
-    "  See \"gn help toolchain\" for more.\n"
+    "  See \"gn help toolchain_args\" for more.\n"
     "\n"
     "  If you specify an override for a build argument that never appears in\n"
     "  a \"declare_args\" call, a nonfatal error will be displayed.\n"
diff --git a/tools/gn/command_format.cc b/tools/gn/command_format.cc
index 3106b2c..7b8f2f3 100644
--- a/tools/gn/command_format.cc
+++ b/tools/gn/command_format.cc
@@ -24,13 +24,14 @@ namespace commands {
 
 const char kSwitchDryRun[] = "dry-run";
 const char kSwitchDumpTree[] = "dump-tree";
+const char kSwitchInPlace[] = "in-place";
 const char kSwitchStdin[] = "stdin";
 
 const char kFormat[] = "format";
 const char kFormat_HelpShort[] =
     "format: Format .gn file.";
 const char kFormat_Help[] =
-    "gn format [--dump-tree] (--stdin | <build_file>)\n"
+    "gn format [--dump-tree] [--in-place] [--stdin] BUILD.gn\n"
     "\n"
     "  Formats .gn file to a standard format.\n"
     "\n"
@@ -45,7 +46,6 @@ const char kFormat_Help[] =
     "  ]\n"
     "\n"
     "Arguments\n"
-    "\n"
     "  --dry-run\n"
     "      Does not change or output anything, but sets the process exit code\n"
     "      based on whether output would be different than what's on disk.\n"
@@ -55,12 +55,16 @@ const char kFormat_Help[] =
     "      - Exit code 2: successful format, but differs from on disk.\n"
     "\n"
     "  --dump-tree\n"
-    "      For debugging, dumps the parse tree to stdout and does not update\n"
-    "      the file or print formatted output.\n"
+    "      For debugging only, dumps the parse tree.\n"
+    "\n"
+    "  --in-place\n"
+    "      Instead of writing the formatted file to stdout, replace the input\n"
+    "      file with the formatted output. If no reformatting is required,\n"
+    "      the input file will not be touched, and nothing printed.\n"
     "\n"
     "  --stdin\n"
-    "      Read input from stdin and write to stdout rather than update\n"
-    "      a file in-place.\n"
+    "      Read input from stdin (and write to stdout). Not compatible with\n"
+    "      --in-place of course.\n"
     "\n"
     "Examples\n"
     "  gn format //some/BUILD.gn\n"
@@ -503,28 +507,17 @@ int Printer::Expr(const ParseNode* root,
     bool is_assignment = binop->op().value() == "=" ||
                          binop->op().value() == "+=" ||
                          binop->op().value() == "-=";
-
-    int indent_column = start_column;
-    if (is_assignment) {
-      // Default to a double-indent for wrapped assignments.
-      indent_column = margin() + kIndentSize * 2;
-
-      // A special case for the long lists and scope assignments that are
-      // common in .gn files, don't indent them + 4, even though they're just
-      // continuations when they're simple lists like "x = [ a, b, c, ... ]" or
-      // scopes like "x = { a = 1 b = 2 }". Put back to "normal" indenting.
-      const ListNode* right_as_list = binop->right()->AsList();
-      if (right_as_list) {
-        if (right_as_list->prefer_multiline() ||
-            ListWillBeMultiline(right_as_list->contents(),
-                                right_as_list->End()))
-          indent_column = start_column;
-      } else {
-        const BlockNode* right_as_block = binop->right()->AsBlock();
-        if (right_as_block)
-          indent_column = start_column;
-      }
-    }
+    // A sort of funny special case for the long lists that are common in .gn
+    // files, don't indent them + 4, even though they're just continuations when
+    // they're simple lists like "x = [ a, b, c, ... ]"
+    const ListNode* right_as_list = binop->right()->AsList();
+    int indent_column =
+        (is_assignment &&
+         (!right_as_list || (!right_as_list->prefer_multiline() &&
+                             !ListWillBeMultiline(right_as_list->contents(),
+                                                  right_as_list->End()))))
+            ? margin() + kIndentSize * 2
+            : start_column;
     if (stack_.back().continuation_requires_indent)
       indent_column += kIndentSize * 2;
 
@@ -931,7 +924,11 @@ void DoFormat(const ParseNode* root, bool dump_tree, std::string* output) {
   if (dump_tree) {
     std::ostringstream os;
     root->Print(os, 0);
+    printf("----------------------\n");
+    printf("-- PARSE TREE --------\n");
+    printf("----------------------\n");
     printf("%s", os.str().c_str());
+    printf("----------------------\n");
   }
   Printer pr;
   pr.Block(root);
@@ -1005,10 +1002,13 @@ int RunFormat(const std::vector<std::string>& args) {
       base::CommandLine::ForCurrentProcess()->HasSwitch(kSwitchDumpTree);
   bool from_stdin =
       base::CommandLine::ForCurrentProcess()->HasSwitch(kSwitchStdin);
+  bool in_place =
+    base::CommandLine::ForCurrentProcess()->HasSwitch(kSwitchInPlace);
 
   if (dry_run) {
     // --dry-run only works with an actual file to compare to.
     from_stdin = false;
+    in_place = true;
   }
 
   if (from_stdin) {
@@ -1021,8 +1021,7 @@ int RunFormat(const std::vector<std::string>& args) {
     std::string output;
     if (!FormatStringToString(input, dump_tree, &output))
       return 1;
-    if (!dump_tree)
-      printf("%s", output.c_str());
+    printf("%s", output.c_str());
     return 0;
   }
 
@@ -1048,8 +1047,7 @@ int RunFormat(const std::vector<std::string>& args) {
 
   std::string output_string;
   if (FormatFileToString(&setup, file, dump_tree, &output_string)) {
-    if (!dump_tree) {
-      // Update the file in-place.
+    if (in_place) {
       base::FilePath to_write = setup.build_settings().GetFullPath(file);
       std::string original_contents;
       if (!base::ReadFileToString(to_write, &original_contents)) {
@@ -1071,6 +1069,8 @@ int RunFormat(const std::vector<std::string>& args) {
         }
         printf("Wrote formatted to '%s'.\n", to_write.AsUTF8Unsafe().c_str());
       }
+    } else {
+      printf("%s", output_string.c_str());
     }
   }
 
diff --git a/tools/gn/command_format_unittest.cc b/tools/gn/command_format_unittest.cc
index d753b33..7c79d41 100644
--- a/tools/gn/command_format_unittest.cc
+++ b/tools/gn/command_format_unittest.cc
@@ -104,4 +104,3 @@ FORMAT_TEST(063)
 FORMAT_TEST(064)
 FORMAT_TEST(065)
 FORMAT_TEST(066)
-FORMAT_TEST(067)
diff --git a/tools/gn/format_test_data/067.gn b/tools/gn/format_test_data/067.gn
deleted file mode 100644
index b3d5eaa..0000000
--- a/tools/gn/format_test_data/067.gn
+++ /dev/null
@@ -1,8 +0,0 @@
-# Scope wrapping.
-
-myscope = {
-}
-myscope = { a = 1 }
-myscope = { a = 1 b = 2}
-# Comment
-SomeFunction({a=1}, "foo")
diff --git a/tools/gn/format_test_data/067.golden b/tools/gn/format_test_data/067.golden
deleted file mode 100644
index 9ce2fa7..0000000
--- a/tools/gn/format_test_data/067.golden
+++ /dev/null
@@ -1,17 +0,0 @@
-# Scope wrapping.
-
-myscope = {
-}
-myscope = {
-  a = 1
-}
-myscope = {
-  a = 1
-  b = 2
-}
-
-# Comment
-SomeFunction({
-               a = 1
-             },
-             "foo")
diff --git a/tools/gn/function_forward_variables_from.cc b/tools/gn/function_forward_variables_from.cc
index 0445f8b..8c7a558 100644
--- a/tools/gn/function_forward_variables_from.cc
+++ b/tools/gn/function_forward_variables_from.cc
@@ -172,27 +172,23 @@ Value RunForwardVariablesFrom(Scope* scope,
     return Value();
   }
 
-  Value* value = nullptr;  // Value to use, may point to result_value.
-  Value result_value;  // Storage for the "evaluate" case.
+  // Extract the scope identifier. This assumes the first parameter is an
+  // identifier. It is difficult to write code where this is not the case, and
+  // this saves an expensive scope copy. If necessary, this could be expanded
+  // to execute the ParseNode and get the value out if it's not an identifer.
   const IdentifierNode* identifier = args_vector[0]->AsIdentifier();
-  if (identifier) {
-    // Optimize the common case where the input scope is an identifier. This
-    // prevents a copy of a potentially large Scope object.
-    value = scope->GetMutableValue(identifier->value().value(),
-                                   Scope::SEARCH_NESTED, true);
-    if (!value) {
-      *err = Err(identifier, "Undefined identifier.");
-      return Value();
-    }
-  } else {
-    // Non-optimized case, just evaluate the argument.
-    result_value = args_vector[0]->Execute(scope, err);
-    if (err->has_error())
-      return Value();
-    value = &result_value;
+  if (!identifier) {
+    *err = Err(args_vector[0].get(), "Expected an identifier for the scope.");
+    return Value();
   }
 
   // Extract the source scope.
+  Value* value = scope->GetMutableValue(
+      identifier->value().value(), Scope::SEARCH_NESTED, true);
+  if (!value) {
+    *err = Err(identifier, "Undefined identifier.");
+    return Value();
+  }
   if (!value->VerifyTypeIs(Value::SCOPE, err))
     return Value();
   Scope* source = value->scope_value();
diff --git a/tools/gn/function_forward_variables_from_unittest.cc b/tools/gn/function_forward_variables_from_unittest.cc
index 84d8b6e..2e6f5a2 100644
--- a/tools/gn/function_forward_variables_from_unittest.cc
+++ b/tools/gn/function_forward_variables_from_unittest.cc
@@ -50,28 +50,6 @@ TEST(FunctionForwardVariablesFrom, List) {
   }
 }
 
-TEST(FunctionForwardVariablesFrom, LiteralList) {
-  Scheduler scheduler;
-  TestWithScope setup;
-
-  // Forwards all variables from a literal scope into another scope definition.
-  TestParseInput input(
-    "a = {\n"
-    "  forward_variables_from({x = 1 y = 2}, \"*\")\n"
-    "  z = 3\n"
-    "}\n"
-    "print(\"${a.x} ${a.y} ${a.z}\")\n");
-
-  ASSERT_FALSE(input.has_error());
-
-  Err err;
-  input.parsed()->Execute(setup.scope(), &err);
-  ASSERT_FALSE(err.has_error()) << err.message();
-
-  EXPECT_EQ("1 2 3\n", setup.print_output());
-  setup.print_output().clear();
-}
-
 TEST(FunctionForwardVariablesFrom, ListWithExclusion) {
   Scheduler scheduler;
   TestWithScope setup;
@@ -116,7 +94,7 @@ TEST(FunctionForwardVariablesFrom, ErrorCases) {
   Err err;
   invalid_source.parsed()->Execute(setup.scope(), &err);
   EXPECT_TRUE(err.has_error());
-  EXPECT_EQ("This is not a scope.", err.message());
+  EXPECT_EQ("Expected an identifier for the scope.", err.message());
 
   // Type check the list. We need to use a new template name each time since
   // all of these invocations are executing in sequence in the same scope.
diff --git a/tools/gn/function_toolchain.cc b/tools/gn/function_toolchain.cc
index 852d25a..faa190e 100644
--- a/tools/gn/function_toolchain.cc
+++ b/tools/gn/function_toolchain.cc
@@ -314,26 +314,10 @@ const char kToolchain_Help[] =
     "    The tool() function call specifies the commands commands to run for\n"
     "    a given step. See \"gn help tool\".\n"
     "\n"
-    "  toolchain_args\n"
-    "    Overrides for build arguments to pass to the toolchain when invoking\n"
-    "    it. This is a variable of type \"scope\" where the variable names\n"
-    "    correspond to varibles in declare_args() blocks.\n"
-    "\n"
-    "    When you specify a target using an alternate toolchain, the master\n"
-    "    build configuration file is re-interpreted in the context of that\n"
-    "    toolchain (see \"gn help toolchain\"). The toolchain_args allows you\n"
-    "    to control the arguments passed into this alternate invocation of\n"
-    "    the build.\n"
-    "\n"
-    "    Any default system arguments or arguments passed in via \"gn args\"\n"
-    "    will also be passed to the alternate invocation unless explicitly\n"
-    "    overridden by toolchain_args.\n"
-    "\n"
-    "    The toolchain_args will be ignored when the toolchain being defined\n"
-    "    is the default. In this case, it's expected you want the default\n"
-    "    argument values.\n"
-    "\n"
-    "    See also \"gn help buildargs\" for an overview of these arguments.\n"
+    "  toolchain_args()\n"
+    "    List of arguments to pass to the toolchain when invoking this\n"
+    "    toolchain. This applies only to non-default toolchains. See\n"
+    "    \"gn help toolchain_args\" for more.\n"
     "\n"
     "  deps\n"
     "    Dependencies of this toolchain. These dependencies will be resolved\n"
@@ -366,19 +350,18 @@ const char kToolchain_Help[] =
     "      by the toolchain label).\n"
     "   2. Re-runs the master build configuration file, applying the\n"
     "      arguments specified by the toolchain_args section of the toolchain\n"
-    "      definition.\n"
+    "      definition (see \"gn help toolchain_args\").\n"
     "   3. Loads the destination build file in the context of the\n"
     "      configuration file in the previous step.\n"
     "\n"
-    "Example\n"
-    "\n"
+    "Example:\n"
     "  toolchain(\"plugin_toolchain\") {\n"
     "    tool(\"cc\") {\n"
     "      command = \"gcc {{source}}\"\n"
     "      ...\n"
     "    }\n"
     "\n"
-    "    toolchain_args = {\n"
+    "    toolchain_args() {\n"
     "      is_plugin = true\n"
     "      is_32bit = true\n"
     "      is_64bit = false\n"
@@ -429,17 +412,6 @@ Value RunToolchain(Scope* scope,
       return Value();
   }
 
-  // Read toolchain args (if any).
-  const Value* toolchain_args = block_scope.GetValue("toolchain_args", true);
-  if (toolchain_args) {
-    if (!toolchain_args->VerifyTypeIs(Value::SCOPE, err))
-      return Value();
-
-    Scope::KeyValueMap values;
-    toolchain_args->scope_value()->GetCurrentScopeValues(&values);
-    toolchain->args() = values;
-  }
-
   if (!block_scope.CheckForUnusedVars(err))
     return Value();
 
@@ -1043,45 +1015,79 @@ Value RunTool(Scope* scope,
   return Value();
 }
 
+// toolchain_args --------------------------------------------------------------
+
 extern const char kToolchainArgs[] = "toolchain_args";
 extern const char kToolchainArgs_HelpShort[] =
     "toolchain_args: Set build arguments for toolchain build setup.";
 extern const char kToolchainArgs_Help[] =
     "toolchain_args: Set build arguments for toolchain build setup.\n"
     "\n"
-    "  DEPRECATED. Instead use:\n"
-    "    toolchain_args = { ... }\n"
+    "  Used inside a toolchain definition to pass arguments to an alternate\n"
+    "  toolchain's invocation of the build.\n"
+    "\n"
+    "  When you specify a target using an alternate toolchain, the master\n"
+    "  build configuration file is re-interpreted in the context of that\n"
+    "  toolchain (see \"gn help toolchain\"). The toolchain_args function\n"
+    "  allows you to control the arguments passed into this alternate\n"
+    "  invocation of the build.\n"
+    "\n"
+    "  Any default system arguments or arguments passed in on the command-\n"
+    "  line will also be passed to the alternate invocation unless explicitly\n"
+    "  overridden by toolchain_args.\n"
+    "\n"
+    "  The toolchain_args will be ignored when the toolchain being defined\n"
+    "  is the default. In this case, it's expected you want the default\n"
+    "  argument values.\n"
+    "\n"
+    "  See also \"gn help buildargs\" for an overview of these arguments.\n"
     "\n"
-    "  See \"gn help toolchain\" for documentation.\n";
+    "Example:\n"
+    "  toolchain(\"my_weird_toolchain\") {\n"
+    "    ...\n"
+    "    toolchain_args() {\n"
+    "      # Override the system values for a generic Posix system.\n"
+    "      is_win = false\n"
+    "      is_posix = true\n"
+    "\n"
+    "      # Pass this new value for specific setup for my toolchain.\n"
+    "      is_my_weird_system = true\n"
+    "    }\n"
+    "  }\n";
 
 Value RunToolchainArgs(Scope* scope,
                        const FunctionCallNode* function,
                        const std::vector<Value>& args,
                        BlockNode* block,
                        Err* err) {
-  // This is a backwards-compatible shim that converts the old form of:
-  //   toolchain_args() {
-  //     foo = bar
-  //   }
-  // to the new form:
-  //   toolchain_args = {
-  //     foo = bar
-  //   }
-  // It will be deleted when all users of toolchain_args as a function are
-  // deleted.
+  // Find the toolchain definition we're executing inside of. The toolchain
+  // function will set a property pointing to it that we'll pick up.
+  Toolchain* toolchain = reinterpret_cast<Toolchain*>(
+      scope->GetProperty(&kToolchainPropertyKey, nullptr));
+  if (!toolchain) {
+    *err = Err(function->function(),
+               "toolchain_args() called outside of toolchain().",
+               "The toolchain_args() function can only be used inside a "
+               "toolchain() definition.");
+    return Value();
+  }
+
   if (!args.empty()) {
     *err = Err(function->function(), "This function takes no arguments.");
     return Value();
   }
 
-  std::unique_ptr<Scope> block_scope(new Scope(scope));
-  block->Execute(block_scope.get(), err);
+  // This function makes a new scope with various variable sets on it, which
+  // we then save on the toolchain to use when re-invoking the build.
+  Scope block_scope(scope);
+  block->Execute(&block_scope, err);
   if (err->has_error())
     return Value();
 
-  block_scope->DetachFromContaining();
-  scope->SetValue("toolchain_args", Value(function, std::move(block_scope)),
-                  function);
+  Scope::KeyValueMap values;
+  block_scope.GetCurrentScopeValues(&values);
+  toolchain->args() = values;
+
   return Value();
 }
 
diff --git a/tools/metrics/actions/actions.xml b/tools/metrics/actions/actions.xml
index 820924f..5e25e02 100644
--- a/tools/metrics/actions/actions.xml
+++ b/tools/metrics/actions/actions.xml
@@ -2896,15 +2896,6 @@ should be able to be added at any place in this file.
   </description>
 </action>
 
-<action name="ContextualSearch.TapSuppressed.TapThresholdExceeded">
-  <owner>donnd@chromium.org</owner>
-  <description>
-    A tap that typically would have triggered Contextual Search was suppressed
-    because the number of taps since last opening has exceeded the suppression
-    threshold.
-  </description>
-</action>
-
 <action name="ContextualSearch.UncommonClose">
   <owner>donnd@chromium.org</owner>
   <description>
@@ -14852,15 +14843,6 @@ should be able to be added at any place in this file.
   <obsolete>Removed from codebase; see GoogleUpdate.UpgradeResult.</obsolete>
 </action>
 
-<action name="UserManager_Cleared_Legacy_User_Prefs">
-  <owner>mahmadi@chromium.org</owner>
-  <description>
-    Recorded when prefs::kBrowserGuestModeEnabled and
-    prefs::kBrowserAddPersonEnabled are cleared because they no longer exist in
-    the Material Design settings page.
-  </description>
-</action>
-
 <action name="VideoPlayer.CastVideoError">
   <owner>yoshiki@chromium.org</owner>
   <description>
diff --git a/tools/metrics/histograms/histograms.xml b/tools/metrics/histograms/histograms.xml
index 7dd4a38..5b8d8d5 100644
--- a/tools/metrics/histograms/histograms.xml
+++ b/tools/metrics/histograms/histograms.xml
@@ -17637,30 +17637,6 @@ http://cs/file:chrome/histograms.xml - but prefer this file for new entries.
   </summary>
 </histogram>
 
-<histogram name="GPU.DestroyProgramManagerPrograms.Elapsed" units="ms">
-  <owner>ericrk@chromium.org</owner>
-  <summary>
-    The amount of time spent destroying programs during ProgramManager::Destroy.
-  </summary>
-</histogram>
-
-<histogram name="GPU.DestroyProgramManagerPrograms.Programs" units="programs">
-  <owner>ericrk@chromium.org</owner>
-  <summary>
-    The number of progams destroyed during ProgramManager::Destroy.
-  </summary>
-</histogram>
-
-<histogram name="GPU.DestroyProgramManagerPrograms.ProgramsPerMs"
-    units="programs per ms">
-  <owner>ericrk@chromium.org</owner>
-  <summary>
-    The number of programs destroyed per millisecond during
-    ProgramManager::Destroy. Only logged if both the number of programs and the
-    elapsed time are greater than zero.
-  </summary>
-</histogram>
-
 <histogram name="GPU.DoLinkProgramTime" units="ms">
   <owner>jmadill@chromium.org</owner>
   <summary>
@@ -39347,12 +39323,6 @@ http://cs/file:chrome/histograms.xml - but prefer this file for new entries.
   </summary>
 </histogram>
 
-<histogram name="PaymentRequest.CheckoutFunnel.Aborted"
-    enum="PaymentRequestAbortReason">
-  <owner>sebsg@chromium.org</owner>
-  <summary>The reason that lead to an abort of the Payment Request.</summary>
-</histogram>
-
 <histogram name="PaymentRequest.CheckoutFunnel.Completed" enum="BooleanHit">
   <owner>sebsg@chromium.org</owner>
   <summary>When the merchant has processed the user's Payment Request.</summary>
@@ -87386,18 +87356,6 @@ To add a new entry, add it with any value and run test to compute valid value.
   <int value="3" label="Server failed"/>
 </enum>
 
-<enum name="PaymentRequestAbortReason" type="int">
-  <int value="0" label="DismissedByUser"/>
-  <int value="1" label="AbortedByMerchant"/>
-  <int value="2" label="InvalidDataFromRenderer"/>
-  <int value="3" label="MojoConnectionError"/>
-  <int value="4" label="MojoRendererClosing"/>
-  <int value="5" label="InstrumentDetailsError"/>
-  <int value="6" label="NoMatchingPaymentMethod"/>
-  <int value="7" label="NoSupportedPaymentMethod"/>
-  <int value="8" label="Other"/>
-</enum>
-
 <enum name="PaymentRequestRequestedInformation" type="int">
   <int value="0" label="None"/>
   <int value="1" label="Email"/>
@@ -87865,7 +87823,6 @@ To add a new entry, add it with any value and run test to compute valid value.
   <int value="2" label="Unthrottled by Retroactive Whitelist"/>
   <int value="3" label="Unthrottled by Audio Playback"/>
   <int value="4" label="Unthrottled by Size Change"/>
-  <int value="5" label="Unthrottled by Omnibox icon"/>
 </enum>
 
 <enum name="PNaClOptionsOptLevelEnum" type="int">
@@ -99941,7 +99898,6 @@ To add a new entry, add it with any value and run test to compute valid value.
   <suffix name="async_loading" label="Offline async loaded pages"/>
   <suffix name="custom_tabs" label="Offline custom tabs"/>
   <suffix name="download" label="Offline downloaded pages"/>
-  <affected-histogram name="OfflinePages.Background.OfflinerRequestStatus"/>
   <affected-histogram name="OfflinePages.DeletePage.AccessCount"/>
   <affected-histogram name="OfflinePages.DeletePage.LastOpenToCreated"/>
   <affected-histogram name="OfflinePages.DeletePage.PageSize"/>
diff --git a/tools/perf/benchmarks/octane.py b/tools/perf/benchmarks/octane.py
index 4c7aa5e..4f0022e 100644
--- a/tools/perf/benchmarks/octane.py
+++ b/tools/perf/benchmarks/octane.py
@@ -135,7 +135,7 @@ class _OctaneMeasurement(legacy_page_test.LegacyPageTest):
 class Octane(perf_benchmark.PerfBenchmark):
   """Google's Octane JavaScript benchmark.
 
-  http://chromium.github.io/octane/index.html?auto=1
+  http://octane-benchmark.googlecode.com/svn/latest/index.html
   """
   test = _OctaneMeasurement
 
@@ -149,6 +149,6 @@ class Octane(perf_benchmark.PerfBenchmark):
         base_dir=os.path.dirname(os.path.abspath(__file__)),
         cloud_storage_bucket=story.PUBLIC_BUCKET)
     ps.AddStory(page_module.Page(
-        'http://chromium.github.io/octane/index.html?auto=1',
+        'http://octane-benchmark.googlecode.com/svn/latest/index.html?auto=1',
         ps, ps.base_dir, make_javascript_deterministic=False))
     return ps
diff --git a/tools/perf/benchmarks/page_cycler.py b/tools/perf/benchmarks/page_cycler.py
index 115fea1..a62424f 100644
--- a/tools/perf/benchmarks/page_cycler.py
+++ b/tools/perf/benchmarks/page_cycler.py
@@ -6,6 +6,7 @@ from core import perf_benchmark
 
 from measurements import page_cycler
 import page_sets
+from telemetry import benchmark
 
 
 class _PageCycler(perf_benchmark.PerfBenchmark):
@@ -33,12 +34,8 @@ class _PageCycler(perf_benchmark.PerfBenchmark):
         cold_load_percent=self.cold_load_percent,
         report_speed_index=options.report_speed_index)
 
-  @classmethod
-  def ShouldDisable(cls, possible_browser):
-    # Superseded by page_cycler_v2.py on all other platforms (crbug.com/611329).
-    return possible_browser.platform.GetOSName() != 'chromeos'
-
 
+@benchmark.Enabled('chromeos')
 class PageCyclerIntlArFaHe(_PageCycler):
   """Page load time for a variety of pages in Arabic, Farsi and Hebrew.
 
@@ -51,6 +48,7 @@ class PageCyclerIntlArFaHe(_PageCycler):
     return 'page_cycler.intl_ar_fa_he'
 
 
+@benchmark.Enabled('chromeos')
 class PageCyclerIntlEsFrPtBr(_PageCycler):
   """Page load time for a pages in Spanish, French and Brazilian Portuguese.
 
@@ -75,6 +73,7 @@ class PageCyclerIntlHiRu(_PageCycler):
     return 'page_cycler.intl_hi_ru'
 
 
+@benchmark.Enabled('chromeos')
 class PageCyclerIntlJaZh(_PageCycler):
   """Page load time benchmark for a variety of pages in Japanese and Chinese.
 
@@ -108,7 +107,16 @@ class PageCyclerIntlKoThVi(_PageCycler):
   def Name(cls):
     return 'page_cycler.intl_ko_th_vi'
 
+  @classmethod
+  def ShouldDisable(cls, possible_browser):
+    # http://crbug.com/597656 (Android Nexus 5X).
+    # http://crbug.com/605543 (Mac Snow Leopard).
+    return (possible_browser.browser_type == 'reference' and (
+              possible_browser.platform.GetDeviceTypeName() == 'Nexus 5X' or
+              possible_browser.platform.GetOSVersionName() == 'snowleopard'))
+
 
+@benchmark.Disabled('android')  # crbug.com/357326
 class PageCyclerToughLayoutCases(_PageCycler):
   """Page loading for the slowest layouts observed in the Alexa top 1 million.
 
@@ -130,6 +138,17 @@ class PageCyclerTypical25(_PageCycler):
   options = {'pageset_repeat': 3}
 
   @classmethod
+  def ShouldDisable(cls, possible_browser):
+    if possible_browser.browser_type == 'reference':
+      if possible_browser.platform.GetDeviceTypeName() == 'Nexus 5X':
+        return True  # http://crbug.com/597656
+      if possible_browser.platform.GetOSVersionName() == 'yosemite':
+        return True  # http://crbug.com/634337
+    if possible_browser.platform.GetDeviceTypeName() == 'AOSP on BullHead':
+      return True  # http://crbug.com/616781
+    return False
+
+  @classmethod
   def Name(cls):
     return 'page_cycler.typical_25'
 
@@ -137,6 +156,7 @@ class PageCyclerTypical25(_PageCycler):
     return page_sets.Typical25PageSet(run_no_page_interactions=True)
 
 
+@benchmark.Disabled('reference', 'android')
 class PageCyclerBasicOopifIsolated(_PageCycler):
   """ A benchmark measuring performance of out-of-process iframes. """
   page_set = page_sets.OopifBasicPageSet
@@ -157,3 +177,7 @@ class PageCyclerBasicOopif(_PageCycler):
   @classmethod
   def Name(cls):
     return 'page_cycler.basic_oopif'
+
+  @classmethod
+  def ShouldDisable(cls, possible_browser):
+    return cls.IsSvelte(possible_browser)  # http://crbug.com/607657
diff --git a/tools/perf/benchmarks/system_health.py b/tools/perf/benchmarks/system_health.py
index 2d80785..815143c 100644
--- a/tools/perf/benchmarks/system_health.py
+++ b/tools/perf/benchmarks/system_health.py
@@ -55,6 +55,10 @@ class _MemorySystemHealthBenchmark(perf_benchmark.PerfBenchmark):
     # is able to cope with the data load generated by TBMv2 metrics.
     return not _IGNORED_STATS_RE.search(value.name)
 
+  @classmethod
+  def ShouldDisable(cls, possible_browser):
+    return cls.IsSvelte(possible_browser)  # http://crbug.com/634112
+
 
 class DesktopMemorySystemHealth(_MemorySystemHealthBenchmark):
   """Desktop Chrome Memory System Health Benchmark."""
diff --git a/tools/perf/benchmarks/system_health_smoke_test.py b/tools/perf/benchmarks/system_health_smoke_test.py
index ccc7ded..5975313 100644
--- a/tools/perf/benchmarks/system_health_smoke_test.py
+++ b/tools/perf/benchmarks/system_health_smoke_test.py
@@ -32,6 +32,8 @@ def GetSystemHealthBenchmarksToSmokeTest():
 
 
 _DISABLED_TESTS = frozenset({
+  # crbug.com/634389
+  'benchmarks.system_health_smoke_test.SystemHealthBenchmarkSmokeTest.system_health.memory_desktop.browse:news:cnn',  # pylint: disable=line-too-long
   # crbug.com/629123
   'benchmarks.system_health_smoke_test.SystemHealthBenchmarkSmokeTest.system_health.memory_mobile.browse:news:hackernews',  # pylint: disable=line-too-long
   'benchmarks.system_health_smoke_test.SystemHealthBenchmarkSmokeTest.system_health.memory_mobile.browse:news:nytimes',  # pylint: disable=line-too-long
diff --git a/tools/perf/benchmarks/tab_switching.py b/tools/perf/benchmarks/tab_switching.py
index 2f24167..689ac16 100644
--- a/tools/perf/benchmarks/tab_switching.py
+++ b/tools/perf/benchmarks/tab_switching.py
@@ -11,7 +11,6 @@ from telemetry import benchmark
 
 @benchmark.Enabled('has tabs')
 @benchmark.Disabled('android')  # http://crbug.com/460084
-@benchmark.Disabled('mac-reference')  # http://crbug.com/634378
 class TabSwitchingTop10(perf_benchmark.PerfBenchmark):
   """This test records the MPArch.RWH_TabSwitchPaintDuration histogram.
 
diff --git a/tools/perf/fetch_benchmark_deps_unittest.py b/tools/perf/fetch_benchmark_deps_unittest.py
index 83e9684..847002b 100644
--- a/tools/perf/fetch_benchmark_deps_unittest.py
+++ b/tools/perf/fetch_benchmark_deps_unittest.py
@@ -67,7 +67,7 @@ class FetchBenchmarkDepsUnittest(unittest.TestCase):
 
   def testFetchOctane(self):
     octane_wpr_path = os.path.join(
-        os.path.dirname(__file__), 'page_sets', 'data', 'octane_002.wpr')
+        os.path.dirname(__file__), 'page_sets', 'data', 'octane_001.wpr')
     expected = os.path.relpath(octane_wpr_path,
                                path_util.GetChromiumSrcDir())
     self._RunFetchBenchmarkDepsTest('octane', NormPaths(expected))
diff --git a/tools/perf/page_sets/data/octane.json b/tools/perf/page_sets/data/octane.json
index fb5e7e3..79c9786 100644
--- a/tools/perf/page_sets/data/octane.json
+++ b/tools/perf/page_sets/data/octane.json
@@ -1,8 +1,8 @@
 {
-    "description": "Describes the Web Page Replay archives for a page set. Don't edit by hand! Use record_wpr for updating.",
+    "description": "Describes the Web Page Replay archives for a page set. Don't edit by hand! Use record_wpr for updating.", 
     "archives": {
-        "octane_002.wpr": [
-            "http://chromium.github.io/octane/index.html?auto=1"
+        "octane_001.wpr": [
+            "http://octane-benchmark.googlecode.com/svn/latest/index.html?auto=1"
         ]
     }
 }
\ No newline at end of file
diff --git a/tools/perf/page_sets/data/octane_001.wpr.sha1 b/tools/perf/page_sets/data/octane_001.wpr.sha1
new file mode 100644
index 0000000..79f1724
--- /dev/null
+++ b/tools/perf/page_sets/data/octane_001.wpr.sha1
@@ -0,0 +1 @@
+91024454a5ba912abba0a89c046beed4e447f9de
\ No newline at end of file
diff --git a/tools/perf/page_sets/data/octane_002.wpr.sha1 b/tools/perf/page_sets/data/octane_002.wpr.sha1
deleted file mode 100644
index 92d99fb..0000000
--- a/tools/perf/page_sets/data/octane_002.wpr.sha1
+++ /dev/null
@@ -1 +0,0 @@
-be500a76f06992f058eb19a53a4dfdf6e3840730
\ No newline at end of file
diff --git a/tools/perf/page_sets/data/system_health_desktop.json b/tools/perf/page_sets/data/system_health_desktop.json
index 9753e23..f41de53 100644
--- a/tools/perf/page_sets/data/system_health_desktop.json
+++ b/tools/perf/page_sets/data/system_health_desktop.json
@@ -4,6 +4,7 @@
             "load:search:amazon",
             "load:search:flipkart",
             "load:search:ebay",
+            "load:search:google",
             "load:search:yandex",
             "load:search:taobao",
             "load:search:yahoo",
@@ -84,10 +85,6 @@
         ],
         "system_health_desktop_021.wpr": [
             "browse:news:flipboard"
-        ],
-        "system_health_desktop_022.wpr": [
-            "load:search:google",
-            "search:portal:google"
         ]
     },
     "description": "Describes the Web Page Replay archives for a story set. Don't edit by hand! Use record_wpr for updating."
diff --git a/tools/perf/page_sets/data/system_health_desktop_022.wpr.sha1 b/tools/perf/page_sets/data/system_health_desktop_022.wpr.sha1
deleted file mode 100644
index 683d315..0000000
--- a/tools/perf/page_sets/data/system_health_desktop_022.wpr.sha1
+++ /dev/null
@@ -1 +0,0 @@
-9726f93eb27fb3571cfa6fe790435b407ffc9910
\ No newline at end of file
diff --git a/tools/perf/page_sets/data/system_health_mobile.json b/tools/perf/page_sets/data/system_health_mobile.json
index 2782af2..503504a 100644
--- a/tools/perf/page_sets/data/system_health_mobile.json
+++ b/tools/perf/page_sets/data/system_health_mobile.json
@@ -4,6 +4,7 @@
             "load:search:amazon",
             "load:search:baidu",
             "load:search:yandex",
+            "load:search:google",
             "load:search:taobao",
             "load:search:ebay",
             "load:search:yahoo"
@@ -93,10 +94,6 @@
         ],
         "system_health_mobile_028.wpr": [
             "browse:social:facebook"
-        ],
-        "system_health_mobile_029.wpr": [
-            "load:search:google",
-            "search:portal:google"
         ]
     },
     "description": "Describes the Web Page Replay archives for a story set. Don't edit by hand! Use record_wpr for updating."
diff --git a/tools/perf/page_sets/data/system_health_mobile_029.wpr.sha1 b/tools/perf/page_sets/data/system_health_mobile_029.wpr.sha1
deleted file mode 100644
index f553527..0000000
--- a/tools/perf/page_sets/data/system_health_mobile_029.wpr.sha1
+++ /dev/null
@@ -1 +0,0 @@
-fc90d05538f8815499f291bdc4a85be9361f5daf
\ No newline at end of file
diff --git a/tools/perf/page_sets/system_health/browsing_stories.py b/tools/perf/page_sets/system_health/browsing_stories.py
index dbc22bc..34efe2b 100644
--- a/tools/perf/page_sets/system_health/browsing_stories.py
+++ b/tools/perf/page_sets/system_health/browsing_stories.py
@@ -199,7 +199,7 @@ class WashingtonPostMobileStory(_NewsBrowsingStory):
   URL = 'https://www.washingtonpost.com/pwa'
   IS_SINGLE_PAGE_APP = True
   ITEM_SELECTOR = '.hed > a'
-  SUPPORTED_PLATFORMS = platforms.NO_PLATFORMS  # http://crbug.com/634112
+  SUPPORTED_PLATFORMS = platforms.MOBILE_ONLY
   _CLOSE_BUTTON_SELECTOR = '.close'
 
   def _DidLoadDocument(self, action_runner):
diff --git a/tools/perf/page_sets/system_health/loading_stories.py b/tools/perf/page_sets/system_health/loading_stories.py
index 65e23e4..7bc4953 100644
--- a/tools/perf/page_sets/system_health/loading_stories.py
+++ b/tools/perf/page_sets/system_health/loading_stories.py
@@ -17,12 +17,11 @@ class _LoadingStory(system_health_story.SystemHealthStory):
 ################################################################################
 # Search and e-commerce.
 ################################################################################
-# TODO(petrcermak): Split these into 'portal' and 'shopping' stories.
 
 
 class LoadGoogleStory(_LoadingStory):
   NAME = 'load:search:google'
-  URL = 'https://www.google.co.uk/'
+  URL = 'https://www.google.com/#hl=en&q=science'
 
 
 class LoadBaiduStory(_LoadingStory):
@@ -177,7 +176,7 @@ class LoadSohuStory(_LoadingStory):
 class LoadWashingtonPostMobileStory(_LoadingStory):
   NAME = 'load:news:washingtonpost'
   URL = 'https://www.washingtonpost.com/pwa'
-  SUPPORTED_PLATFORMS = platforms.NO_PLATFORMS  # http://crbug.com/634112
+  SUPPORTED_PLATFORMS = platforms.MOBILE_ONLY
   _CLOSE_BUTTON_SELECTOR = '.close'
 
   def _DidLoadDocument(self, action_runner):
diff --git a/tools/perf/page_sets/system_health/searching_stories.py b/tools/perf/page_sets/system_health/searching_stories.py
deleted file mode 100644
index 96dd713..0000000
--- a/tools/perf/page_sets/system_health/searching_stories.py
+++ /dev/null
@@ -1,48 +0,0 @@
-# Copyright 2016 The Chromium Authors. All rights reserved.
-# Use of this source code is governed by a BSD-style license that can be
-# found in the LICENSE file.
-
-from page_sets.system_health import platforms
-from page_sets.system_health import system_health_story
-
-
-class SearchGoogleStory(system_health_story.SystemHealthStory):
-  NAME = 'search:portal:google'
-  URL = 'https://www.google.co.uk/'
-  # Tap simulation doesn't fully work on Windows. http://crbug.com/634343
-  SUPPORTED_PLATFORMS = platforms.MOBILE_ONLY
-
-  _SEARCH_BOX_SELECTOR = 'input[aria-label="Search"]'
-  _RESULT_SELECTOR = '.r > a[href*="wikipedia"]'
-
-  def _DidLoadDocument(self, action_runner):
-    # Click on the search box.
-    action_runner.Wait(1)
-    action_runner.WaitForElement(selector=self._SEARCH_BOX_SELECTOR)
-    action_runner.TapElement(selector=self._SEARCH_BOX_SELECTOR)
-
-    # Submit search query.
-    action_runner.Wait(1)
-    action_runner.EnterText('what is science')
-    action_runner.Wait(0.5)
-    action_runner.PressKey('Return')
-
-    # Scroll to the Wikipedia result.
-    action_runner.WaitForElement(selector=self._RESULT_SELECTOR)
-    action_runner.Wait(1)
-    # TODO(petrcermak): Turn this into a proper Telemetry API (ScrollToElement).
-    result_visible_expression = ('''
-        (function() {
-          var resultElem = document.querySelector(\'%s\');
-          var boundingRect = resultElem.getBoundingClientRect();
-          return boundingRect.bottom >= window.innerHeight
-        })()''' % self._RESULT_SELECTOR)
-    while action_runner.EvaluateJavaScript(result_visible_expression):
-      action_runner.RepeatableBrowserDrivenScroll(y_scroll_distance_ratio=0.75,
-                                                  prevent_fling=False)
-      action_runner.Wait(0.2)
-
-    # Click on the Wikipedia result.
-    action_runner.Wait(1)
-    action_runner.TapElement(selector=self._RESULT_SELECTOR)
-    action_runner.tab.WaitForDocumentReadyStateToBeComplete()
diff --git a/tools/roll_webrtc.py b/tools/roll_webrtc.py
index 2488565..36ce27b 100755
--- a/tools/roll_webrtc.py
+++ b/tools/roll_webrtc.py
@@ -154,6 +154,24 @@ def _PrintTrybotsStatus(tryjob_results):
   for status,name_list in status_to_name.iteritems():
     print '%s: %s' % (status, ','.join(sorted(name_list)))
 
+
+def _GenerateCLDescriptionCommand(webrtc_current, webrtc_new):
+  def GetChangeLogURL(git_repo_url, current_hash, new_hash):
+    return '%s/+log/%s..%s' % (git_repo_url, current_hash[0:7], new_hash[0:7])
+
+  webrtc_str = 'WebRTC %s:%s' % (webrtc_current.commit_position,
+                                 webrtc_new.commit_position)
+  webrtc_changelog_url = GetChangeLogURL(webrtc_current.git_repo_url,
+                                         webrtc_current.git_commit,
+                                         webrtc_new.git_commit)
+
+  description = [ '-m', 'Roll ' + webrtc_str ]
+  description.extend(['-m', 'Changes: %s' % webrtc_changelog_url])
+  description.extend(['-m', 'TBR='])
+  description.extend(['-m', 'CQ_INCLUDE_TRYBOTS=%s' % EXTRA_TRYBOTS])
+  return description
+
+
 class AutoRoller(object):
   def __init__(self, chromium_src):
     self._chromium_src = chromium_src
@@ -183,38 +201,6 @@ class AutoRoller(object):
       sys.exit(p.returncode)
     return output
 
-  def _GenerateCLDescriptionCommand(self, webrtc_current, webrtc_new):
-    commit_range = '%s..%s' % (webrtc_current.git_commit[:7],
-                               webrtc_new.git_commit[:7])
-
-    webrtc_changelog_url = '%s/+log/%s' % (webrtc_current.git_repo_url,
-                                           commit_range)
-
-    git_log_cmd = ['git', 'log', commit_range, '--date=short', '--no-merges',
-                   '--format=%ad %ae %s']
-
-    working_dir = os.path.join(self._chromium_src, WEBRTC_PATH)
-    git_log = self._RunCommand(git_log_cmd, working_dir=working_dir)
-
-    nb_commits = git_log.count('\n')
-    webrtc_header = 'Roll WebRTC %s:%s (%d commit%s)' % (
-        webrtc_current.commit_position, webrtc_new.commit_position,
-        nb_commits, 's' if nb_commits > 1 else '')
-
-    description = ('%s\n\n'
-                   'Changes: %s\n\n'
-                   '$ %s\n'
-                   '%s\n'
-                   'TBR=\n'
-                   'CQ_INCLUDE_TRYBOTS=%s\n') % (
-                       webrtc_header,
-                       webrtc_changelog_url,
-                       ' '.join(git_log_cmd),
-                       git_log,
-                       EXTRA_TRYBOTS)
-
-    return description
-
   def _GetCommitInfo(self, path_below_src, git_hash=None, git_repo_url=None):
     working_dir = os.path.join(self._chromium_src, path_below_src)
     self._RunCommand(['git', 'fetch', 'origin'], working_dir=working_dir)
@@ -312,11 +298,11 @@ class AutoRoller(object):
       print 'The latest revision is already rolled for WebRTC.'
       self._DeleteRollBranch()
     else:
-      description = self._GenerateCLDescriptionCommand(
+      description = _GenerateCLDescriptionCommand(
         webrtc_current, webrtc_latest)
       logging.debug('Committing changes locally.')
       self._RunCommand(['git', 'add', '--update', '.'])
-      self._RunCommand(['git', 'commit', '-m', description])
+      self._RunCommand(['git', 'commit'] + description)
       logging.debug('Uploading changes...')
       self._RunCommand(['git', 'cl', 'upload'],
                        extra_env={'EDITOR': 'true'})
diff --git a/ui/base/BUILD.gn b/ui/base/BUILD.gn
index 5accf0e..38116ea 100644
--- a/ui/base/BUILD.gn
+++ b/ui/base/BUILD.gn
@@ -797,6 +797,9 @@ test("ui_base_unittests") {
     if (is_linux && use_aura && !is_chromeos) {
       sources += [ "ime/input_method_auralinux_unittest.cc" ]
     }
+    if (is_mac) {
+      sources += [ "resource/resource_bundle_mac_unittest.mm" ]
+    }
     if (use_x11) {
       sources += [ "ime/composition_text_util_pango_unittest.cc" ]
     }
diff --git a/ui/base/dragdrop/os_exchange_data_provider_factory.cc b/ui/base/dragdrop/os_exchange_data_provider_factory.cc
index 147cebf..df3aab7 100644
--- a/ui/base/dragdrop/os_exchange_data_provider_factory.cc
+++ b/ui/base/dragdrop/os_exchange_data_provider_factory.cc
@@ -22,7 +22,6 @@ OSExchangeDataProviderFactory::Factory* factory_ = nullptr;
 
 // static
 void OSExchangeDataProviderFactory::SetFactory(Factory* factory) {
-  DCHECK(!factory_ || !factory);
   factory_ = factory;
 }
 
diff --git a/ui/base/resource/data_pack.cc b/ui/base/resource/data_pack.cc
index 4a98c18..245c1b7 100644
--- a/ui/base/resource/data_pack.cc
+++ b/ui/base/resource/data_pack.cc
@@ -67,7 +67,8 @@ namespace ui {
 DataPack::DataPack(ui::ScaleFactor scale_factor)
     : resource_count_(0),
       text_encoding_type_(BINARY),
-      scale_factor_(scale_factor) {
+      scale_factor_(scale_factor),
+      has_only_material_design_assets_(false) {
 }
 
 DataPack::~DataPack() {
@@ -232,6 +233,10 @@ ui::ScaleFactor DataPack::GetScaleFactor() const {
   return scale_factor_;
 }
 
+bool DataPack::HasOnlyMaterialDesignAssets() const {
+  return has_only_material_design_assets_;
+}
+
 #if DCHECK_IS_ON()
 void DataPack::CheckForDuplicateResources(
     const ScopedVector<ResourceHandle>& packs) {
@@ -241,6 +246,10 @@ void DataPack::CheckForDuplicateResources(
     const uint16_t resource_id = entry->resource_id;
     const float resource_scale = GetScaleForScaleFactor(scale_factor_);
     for (const ResourceHandle* handle : packs) {
+      if (HasOnlyMaterialDesignAssets() !=
+          handle->HasOnlyMaterialDesignAssets()) {
+        continue;
+      }
       if (GetScaleForScaleFactor(handle->GetScaleFactor()) != resource_scale)
         continue;
       DCHECK(!handle->HasResource(resource_id)) << "Duplicate resource "
diff --git a/ui/base/resource/data_pack.h b/ui/base/resource/data_pack.h
index 26b94c2..4657818 100644
--- a/ui/base/resource/data_pack.h
+++ b/ui/base/resource/data_pack.h
@@ -36,6 +36,10 @@ class UI_DATA_PACK_EXPORT DataPack : public ResourceHandle {
   explicit DataPack(ui::ScaleFactor scale_factor);
   ~DataPack() override;
 
+  void set_has_only_material_design_assets(bool has_only_material_assets) {
+    has_only_material_design_assets_ = has_only_material_assets;
+  }
+
   // Load a pack file from |path|, returning false on error.
   bool LoadFromPath(const base::FilePath& path);
 
@@ -62,6 +66,7 @@ class UI_DATA_PACK_EXPORT DataPack : public ResourceHandle {
       uint16_t resource_id) const override;
   TextEncodingType GetTextEncodingType() const override;
   ui::ScaleFactor GetScaleFactor() const override;
+  bool HasOnlyMaterialDesignAssets() const override;
 
 #if DCHECK_IS_ON()
   // Checks to see if any resource in this DataPack already exists in the list
@@ -86,6 +91,10 @@ class UI_DATA_PACK_EXPORT DataPack : public ResourceHandle {
   // resource pak.
   ui::ScaleFactor scale_factor_;
 
+  // Set to true if the only resources contained within this DataPack are
+  // material design image assets.
+  bool has_only_material_design_assets_;
+
   DISALLOW_COPY_AND_ASSIGN(DataPack);
 };
 
diff --git a/ui/base/resource/resource_bundle.cc b/ui/base/resource/resource_bundle.cc
index 940b6a9..f3aec91 100644
--- a/ui/base/resource/resource_bundle.cc
+++ b/ui/base/resource/resource_bundle.cc
@@ -31,6 +31,7 @@
 #include "third_party/zlib/zlib.h"
 #include "ui/base/l10n/l10n_util.h"
 #include "ui/base/layout.h"
+#include "ui/base/material_design/material_design_controller.h"
 #include "ui/base/resource/data_pack.h"
 #include "ui/base/ui_base_paths.h"
 #include "ui/base/ui_base_switches.h"
@@ -291,12 +292,24 @@ bool ResourceBundle::LocaleDataPakExists(const std::string& locale) {
 
 void ResourceBundle::AddDataPackFromPath(const base::FilePath& path,
                                          ScaleFactor scale_factor) {
-  AddDataPackFromPathInternal(path, scale_factor, false);
+  AddDataPackFromPathInternal(path, scale_factor, false, false);
 }
 
 void ResourceBundle::AddOptionalDataPackFromPath(const base::FilePath& path,
-                                                 ScaleFactor scale_factor) {
-  AddDataPackFromPathInternal(path, scale_factor, true);
+                                         ScaleFactor scale_factor) {
+  AddDataPackFromPathInternal(path, scale_factor, true, false);
+}
+
+void ResourceBundle::AddMaterialDesignDataPackFromPath(
+    const base::FilePath& path,
+    ScaleFactor scale_factor) {
+  AddDataPackFromPathInternal(path, scale_factor, false, true);
+}
+
+void ResourceBundle::AddOptionalMaterialDesignDataPackFromPath(
+    const base::FilePath& path,
+    ScaleFactor scale_factor) {
+  AddDataPackFromPathInternal(path, scale_factor, true, true);
 }
 
 void ResourceBundle::AddDataPackFromFile(base::File file,
@@ -737,6 +750,28 @@ void ResourceBundle::FreeImages() {
 }
 
 void ResourceBundle::LoadChromeResources() {
+// TODO(estade): remove material design specific resources.
+// See crbug.com/613593
+#if defined(OS_MACOSX)
+  // The material design data packs contain some of the same asset IDs as in
+  // the non-material design data packs. Add these to the ResourceBundle
+  // first so that they are searched first when a request for an asset is
+  // made.
+  if (MaterialDesignController::IsModeMaterial()) {
+    if (IsScaleFactorSupported(SCALE_FACTOR_100P)) {
+      AddMaterialDesignDataPackFromPath(
+          GetResourcesPakFilePath("chrome_material_100_percent.pak"),
+          SCALE_FACTOR_100P);
+    }
+
+    if (IsScaleFactorSupported(SCALE_FACTOR_200P)) {
+      AddOptionalMaterialDesignDataPackFromPath(
+          GetResourcesPakFilePath("chrome_material_200_percent.pak"),
+          SCALE_FACTOR_200P);
+    }
+  }
+#endif
+
   // Always load the 1x data pack first as the 2x data pack contains both 1x and
   // 2x images. The 1x data pack only has 1x images, thus passes in an accurate
   // scale factor to gfx::ImageSkia::AddRepresentation.
@@ -754,7 +789,8 @@ void ResourceBundle::LoadChromeResources() {
 void ResourceBundle::AddDataPackFromPathInternal(
     const base::FilePath& path,
     ScaleFactor scale_factor,
-    bool optional) {
+    bool optional,
+    bool has_only_material_assets) {
   // Do not pass an empty |path| value to this method. If the absolute path is
   // unknown pass just the pack file name.
   DCHECK(!path.empty());
@@ -768,6 +804,7 @@ void ResourceBundle::AddDataPackFromPathInternal(
     return;
 
   std::unique_ptr<DataPack> data_pack(new DataPack(scale_factor));
+  data_pack->set_has_only_material_design_assets(has_only_material_assets);
   if (data_pack->LoadFromPath(pack_path)) {
     AddDataPack(data_pack.release());
   } else if (!optional) {
diff --git a/ui/base/resource/resource_bundle.h b/ui/base/resource/resource_bundle.h
index dea3b8f..29584f6 100644
--- a/ui/base/resource/resource_bundle.h
+++ b/ui/base/resource/resource_bundle.h
@@ -179,6 +179,15 @@ class UI_BASE_EXPORT ResourceBundle {
   void AddOptionalDataPackFromPath(const base::FilePath& path,
                                    ScaleFactor scale_factor);
 
+  // The same as AddDataPackFromPath() and AddOptionalDataPackFromPath(),
+  // except the data pack is flagged as containing only material design assets.
+  // TODO(tdanderson): These methods are temporary and should be removed after
+  //                   the transition to material design in the browser UI.
+  void AddMaterialDesignDataPackFromPath(const base::FilePath& path,
+                                         ScaleFactor scale_factor);
+  void AddOptionalMaterialDesignDataPackFromPath(const base::FilePath& path,
+                                                 ScaleFactor scale_factor);
+
   // Changes the locale for an already-initialized ResourceBundle, returning the
   // name of the newly-loaded locale.  Future calls to get strings will return
   // the strings for this new locale.  This has no effect on existing or future
@@ -280,6 +289,12 @@ class UI_BASE_EXPORT ResourceBundle {
   // Returns SCALE_FACTOR_100P if no resource is loaded.
   ScaleFactor GetMaxScaleFactor() const;
 
+#if defined(OS_MACOSX)
+  // Loads Material Design data packs and makes them the first items in
+  // |data_packs_|.
+  void LoadMaterialDesignResources();
+#endif
+
   // Returns true if |scale_factor| is supported by this platform.
   static bool IsScaleFactorSupported(ScaleFactor scale_factor);
 
@@ -287,6 +302,12 @@ class UI_BASE_EXPORT ResourceBundle {
   FRIEND_TEST_ALL_PREFIXES(ResourceBundleTest, DelegateGetPathForLocalePack);
   FRIEND_TEST_ALL_PREFIXES(ResourceBundleTest, DelegateGetImageNamed);
   FRIEND_TEST_ALL_PREFIXES(ResourceBundleTest, DelegateGetNativeImageNamed);
+  FRIEND_TEST_ALL_PREFIXES(ResourceBundleImageTest,
+                           CountMaterialDesignDataPacksInResourceBundle);
+  FRIEND_TEST_ALL_PREFIXES(ResourceBundleMacImageTest,
+                           CheckImageFromMaterialDesign);
+  FRIEND_TEST_ALL_PREFIXES(ChromeBrowserMainMacBrowserTest,
+                           MDResourceAccess);
 
   friend class ResourceBundleMacImageTest;
   friend class ResourceBundleImageTest;
@@ -313,14 +334,19 @@ class UI_BASE_EXPORT ResourceBundle {
   // Load the main resources.
   void LoadCommonResources();
 
-  // Loads the resource paks chrome_{100,200}_percent.pak.
+  // Loads the resource paks chrome_{100,200}_percent.pak. Also loads the
+  // resource paks chrome_material_{100,200}_percent.pak contaning top
+  // chrome material design assets if the runtime flag is enabled.
   void LoadChromeResources();
 
   // Implementation for the public methods which add a DataPack from a path. If
-  // |optional| is false, an error is logged on failure to load.
+  // |optional| is false, an error is logged on failure to load. Sets the
+  // member |has_only_material_design_assets_| on the created DataPack to the
+  // value of |has_only_material_assets|.
   void AddDataPackFromPathInternal(const base::FilePath& path,
                                    ScaleFactor scale_factor,
-                                   bool optional);
+                                   bool optional,
+                                   bool has_only_material_assets);
 
   // Inserts |data_pack| to |data_pack_| and updates |max_scale_factor_|
   // accordingly.
diff --git a/ui/base/resource/resource_bundle_mac.mm b/ui/base/resource/resource_bundle_mac.mm
index 2dbe9ea..8f5934c 100644
--- a/ui/base/resource/resource_bundle_mac.mm
+++ b/ui/base/resource/resource_bundle_mac.mm
@@ -14,6 +14,7 @@
 #include "base/memory/ref_counted_memory.h"
 #include "base/strings/sys_string_conversions.h"
 #include "base/synchronization/lock.h"
+#include "ui/base/material_design/material_design_controller.h"
 #include "ui/base/resource/resource_handle.h"
 #include "ui/gfx/image/image.h"
 
@@ -59,6 +60,40 @@ void ResourceBundle::LoadCommonResources() {
   }
 }
 
+void ResourceBundle::LoadMaterialDesignResources() {
+  if (!MaterialDesignController::IsModeMaterial()) {
+    return;
+  }
+
+  // The Material Design data packs contain some of the same asset IDs as in
+  // the non-Material Design data packs. Set aside the current packs and add the
+  // Material Design packs so that they are searched first when a request for an
+  // asset is made. The Material Design packs cannot be loaded in
+  // LoadCommonResources() because the MaterialDesignController is not always
+  // initialized at the time it is called.
+  // TODO(shrike) - remove this method and restore loading of Material Design
+  // packs to LoadCommonResources() when the MaterialDesignController goes away.
+  std::vector<std::unique_ptr<ResourceHandle>> tmp_packs;
+  for (auto it = data_packs_.begin(); it != data_packs_.end(); ++it) {
+    std::unique_ptr<ResourceHandle> next_pack(*it);
+    tmp_packs.push_back(std::move(next_pack));
+  }
+  data_packs_.weak_clear();
+
+  AddMaterialDesignDataPackFromPath(
+      GetResourcesPakFilePath(@"chrome_material_100_percent", nil),
+      SCALE_FACTOR_100P);
+
+  AddOptionalMaterialDesignDataPackFromPath(
+      GetResourcesPakFilePath(@"chrome_material_200_percent", nil),
+      SCALE_FACTOR_200P);
+
+  // Add back the non-Material Design packs so that they serve as a fallback.
+  for (auto it = tmp_packs.begin(); it != tmp_packs.end(); ++it) {
+    data_packs_.push_back(std::move(*it));
+  }
+}
+
 base::FilePath ResourceBundle::GetLocaleFilePath(const std::string& app_locale,
                                                  bool test_file_exists) {
   NSString* mac_locale = base::SysUTF8ToNSString(app_locale);
@@ -110,7 +145,11 @@ gfx::Image& ResourceBundle::GetNativeImageNamed(int resource_id) {
 
   if (image.IsEmpty()) {
     base::scoped_nsobject<NSImage> ns_image;
+    // Material Design packs are meant to override the standard packs, so
+    // search for the image in those packs first.
     for (size_t i = 0; i < data_packs_.size(); ++i) {
+      if (!data_packs_[i]->HasOnlyMaterialDesignAssets())
+        continue;
       scoped_refptr<base::RefCountedStaticMemory> data(
           data_packs_[i]->GetStaticMemory(resource_id));
       if (!data.get())
@@ -135,6 +174,8 @@ gfx::Image& ResourceBundle::GetNativeImageNamed(int resource_id) {
   if (image.IsEmpty()) {
     base::scoped_nsobject<NSImage> ns_image;
     for (size_t i = 0; i < data_packs_.size(); ++i) {
+      if (data_packs_[i]->HasOnlyMaterialDesignAssets())
+        continue;
       scoped_refptr<base::RefCountedStaticMemory> data(
           data_packs_[i]->GetStaticMemory(resource_id));
       if (!data.get())
diff --git a/ui/base/resource/resource_bundle_mac_unittest.mm b/ui/base/resource/resource_bundle_mac_unittest.mm
new file mode 100644
index 0000000..bbae992
--- /dev/null
+++ b/ui/base/resource/resource_bundle_mac_unittest.mm
@@ -0,0 +1,205 @@
+// Copyright 2015 The Chromium Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "ui/base/resource/resource_bundle.h"
+
+#import <AppKit/AppKit.h>
+#include <stddef.h>
+#include <stdint.h>
+
+#include "base/base_paths.h"
+#include "base/big_endian.h"
+#include "base/files/file_path.h"
+#include "base/files/file_util.h"
+#include "base/files/scoped_temp_dir.h"
+#include "base/logging.h"
+#include "base/macros.h"
+#include "base/memory/ref_counted_memory.h"
+#include "testing/gmock/include/gmock/gmock.h"
+#include "testing/gtest/include/gtest/gtest.h"
+#include "third_party/skia/include/core/SkBitmap.h"
+#include "ui/base/resource/data_pack.h"
+#include "ui/gfx/codec/png_codec.h"
+#include "ui/gfx/image/image_skia.h"
+#include "ui/resources/grit/ui_resources.h"
+#include "ui/strings/grit/app_locale_settings.h"
+
+namespace ui {
+
+extern const char kEmptyPakContents[];
+extern const size_t kEmptyPakSize;
+
+namespace {
+
+const unsigned char kPngMagic[8] = { 0x89, 'P', 'N', 'G', 13, 10, 26, 10 };
+const size_t kPngChunkMetadataSize = 12;
+const unsigned char kPngIHDRChunkType[4] = { 'I', 'H', 'D', 'R' };
+
+// Returns |bitmap_data| with |custom_chunk| inserted after the IHDR chunk.
+void AddCustomChunk(const base::StringPiece& custom_chunk,
+                    std::vector<unsigned char>* bitmap_data) {
+  EXPECT_LT(arraysize(kPngMagic) + kPngChunkMetadataSize, bitmap_data->size());
+  EXPECT_TRUE(std::equal(
+      bitmap_data->begin(),
+      bitmap_data->begin() + arraysize(kPngMagic),
+      kPngMagic));
+  std::vector<unsigned char>::iterator ihdr_start =
+      bitmap_data->begin() + arraysize(kPngMagic);
+  char ihdr_length_data[sizeof(uint32_t)];
+  for (size_t i = 0; i < sizeof(uint32_t); ++i)
+    ihdr_length_data[i] = *(ihdr_start + i);
+  uint32_t ihdr_chunk_length = 0;
+  base::ReadBigEndian(reinterpret_cast<char*>(ihdr_length_data),
+                      &ihdr_chunk_length);
+  EXPECT_TRUE(
+      std::equal(ihdr_start + sizeof(uint32_t),
+                 ihdr_start + sizeof(uint32_t) + sizeof(kPngIHDRChunkType),
+                 kPngIHDRChunkType));
+
+  bitmap_data->insert(ihdr_start + kPngChunkMetadataSize + ihdr_chunk_length,
+                      custom_chunk.begin(), custom_chunk.end());
+}
+
+// Creates datapack at |path| with a single bitmap at resource ID 3
+// which is |edge_size|x|edge_size| pixels.
+// If |custom_chunk| is non empty, adds it after the IHDR chunk
+// in the encoded bitmap data.
+void CreateDataPackWithSingleBitmap(const base::FilePath& path,
+                                    int edge_size,
+                                    const base::StringPiece& custom_chunk) {
+  SkBitmap bitmap;
+  bitmap.allocN32Pixels(edge_size, edge_size);
+  bitmap.eraseColor(SK_ColorWHITE);
+  std::vector<unsigned char> bitmap_data;
+  EXPECT_TRUE(gfx::PNGCodec::EncodeBGRASkBitmap(bitmap, false, &bitmap_data));
+
+  if (custom_chunk.size() > 0)
+    AddCustomChunk(custom_chunk, &bitmap_data);
+
+  std::map<uint16_t, base::StringPiece> resources;
+  resources[3u] = base::StringPiece(
+      reinterpret_cast<const char*>(&bitmap_data[0]), bitmap_data.size());
+  DataPack::WritePack(path, resources, ui::DataPack::BINARY);
+}
+
+}  // namespace
+
+class ResourceBundleMacImageTest : public testing::Test {
+ public:
+  ResourceBundleMacImageTest() : resource_bundle_(NULL) {}
+
+  ~ResourceBundleMacImageTest() override {}
+
+  void SetUp() override {
+    // Create a temporary directory to write test resource bundles to.
+    ASSERT_TRUE(dir_.CreateUniqueTempDir());
+  }
+
+  // Overridden from testing::Test:
+  void TearDown() override { delete resource_bundle_; }
+
+  // Returns new ResoureBundle with the specified |delegate|. The
+  // ResourceBundleTest class manages the lifetime of the returned
+  // ResourceBundle.
+  ResourceBundle* CreateResourceBundle(ResourceBundle::Delegate* delegate) {
+    DCHECK(!resource_bundle_);
+
+    resource_bundle_ = new ResourceBundle(delegate);
+    return resource_bundle_;
+  }
+
+  // Returns resource bundle which uses an empty data pak for locale data.
+  ui::ResourceBundle* CreateResourceBundleWithEmptyLocalePak() {
+    // Write an empty data pak for locale data.
+    const base::FilePath& locale_path = dir_path().Append(
+        FILE_PATH_LITERAL("locale.pak"));
+    EXPECT_EQ(base::WriteFile(locale_path, kEmptyPakContents, kEmptyPakSize),
+              static_cast<int>(kEmptyPakSize));
+
+    ui::ResourceBundle* resource_bundle = CreateResourceBundle(NULL);
+
+    // Load the empty locale data pak.
+    resource_bundle->LoadTestResources(base::FilePath(), locale_path);
+    return resource_bundle;
+  }
+
+  // Returns the path of temporary directory to write test data packs into.
+  const base::FilePath& dir_path() { return dir_.path(); }
+
+  // Returns the number of DataPacks managed by |resource_bundle| which are
+  // flagged as containing only material design resources.
+  size_t NumberOfMaterialDesignDataPacksInResourceBundle(
+      ResourceBundle* resource_bundle) {
+    DCHECK(resource_bundle);
+    size_t num_material_packs = 0;
+    for (size_t i = 0; i < resource_bundle->data_packs_.size(); i++) {
+      if (resource_bundle->data_packs_[i]->HasOnlyMaterialDesignAssets())
+        num_material_packs++;
+    }
+
+    return num_material_packs;
+  }
+
+protected:
+  ResourceBundle* resource_bundle_;
+
+ private:
+  std::unique_ptr<DataPack> locale_pack_;
+  base::ScopedTempDir dir_;
+
+  DISALLOW_COPY_AND_ASSIGN(ResourceBundleMacImageTest);
+};
+
+// Verifies that ResourceBundle searches the Material Design data pack before
+// the default data pack, and that the returned image contains only the
+// representation from the Material Design pack.
+TEST_F(ResourceBundleMacImageTest, CheckImageFromMaterialDesign) {
+  // Create two .pak files, each containing a single image with the
+  // same asset ID but different sizes (note that the images must be
+  // different sizes in this test in order to correctly determine
+  // from which data pack the asset was pulled). Note also that the value
+  // of |material_size| was chosen to be divisible by 3, since iOS may
+  // use this scale factor.
+  const int default_size = 10;
+  const int material_size = 48;
+  ASSERT_NE(default_size, material_size);
+  base::FilePath default_path = dir_path().AppendASCII("default.pak");
+  base::FilePath material_path = dir_path().AppendASCII("material.pak");
+  CreateDataPackWithSingleBitmap(default_path,
+                                 default_size,
+                                 base::StringPiece());
+  CreateDataPackWithSingleBitmap(material_path,
+                                 material_size,
+                                 base::StringPiece());
+
+  ScaleFactor scale_factor = SCALE_FACTOR_100P;
+  ResourceBundle* resource_bundle = CreateResourceBundleWithEmptyLocalePak();
+
+  // Load the 'material' data pack into ResourceBundle first.
+  resource_bundle->AddMaterialDesignDataPackFromPath(material_path,
+                                                     scale_factor);
+  resource_bundle->AddDataPackFromPath(default_path, scale_factor);
+
+  // Confirm that there are two data packs available.
+  const unsigned int data_packs_size = resource_bundle->data_packs_.size();
+  const unsigned int expected_size = 2;
+  EXPECT_EQ(expected_size, data_packs_size);
+
+  const size_t md_data_pack_count =
+      NumberOfMaterialDesignDataPacksInResourceBundle(resource_bundle);
+  const size_t expected_pack_count = 1;
+  EXPECT_EQ(expected_pack_count, md_data_pack_count);
+
+  // Normally with two packs containing the same image, GetNativeImageNamed()
+  // returns an NSImage that contains both representations. With the Material
+  // Design pack, any images it contains should override the ones in the default
+  // pack, so if both packs contain the same image, the returned NSImage should
+  // contain just a single representation.
+  NSImage* icon = resource_bundle->GetNativeImageNamed(3).ToNSImage();
+  const unsigned long representations_count = [[icon representations] count];
+  const unsigned long expected_count = 1;
+  EXPECT_EQ(expected_count, representations_count);
+}
+
+}  // namespace ui
diff --git a/ui/base/resource/resource_bundle_unittest.cc b/ui/base/resource/resource_bundle_unittest.cc
index fdaffdb..f053f57 100644
--- a/ui/base/resource/resource_bundle_unittest.cc
+++ b/ui/base/resource/resource_bundle_unittest.cc
@@ -418,6 +418,20 @@ class ResourceBundleImageTest : public ResourceBundleTest {
     return resource_bundle->data_packs_.size();
   }
 
+  // Returns the number of DataPacks managed by |resource_bundle| which are
+  // flagged as containing only material design resources.
+  size_t NumMaterialDesignDataPacksInResourceBundle(
+      ResourceBundle* resource_bundle) {
+    DCHECK(resource_bundle);
+    size_t num_material_packs = 0;
+    for (size_t i = 0; i < resource_bundle->data_packs_.size(); i++) {
+      if (resource_bundle->data_packs_[i]->HasOnlyMaterialDesignAssets())
+        num_material_packs++;
+    }
+
+    return num_material_packs;
+  }
+
  private:
   std::unique_ptr<DataPack> locale_pack_;
   base::ScopedTempDir dir_;
@@ -540,6 +554,101 @@ TEST_F(ResourceBundleImageTest, GetImageNamed) {
   EXPECT_EQ(1.4f, image_skia->GetRepresentation(1.4f).scale());
 }
 
+// Verifies that the correct number of DataPacks managed by ResourceBundle
+// are flagged as containing only material design assets.
+TEST_F(ResourceBundleImageTest, CountMaterialDesignDataPacksInResourceBundle) {
+  ResourceBundle* resource_bundle = CreateResourceBundle(nullptr);
+  EXPECT_EQ(0u, NumDataPacksInResourceBundle(resource_bundle));
+  EXPECT_EQ(0u, NumMaterialDesignDataPacksInResourceBundle(resource_bundle));
+
+  // Add a non-material data pack.
+  base::FilePath default_path = dir_path().AppendASCII("default.pak");
+  CreateDataPackWithSingleBitmap(default_path, 10, base::StringPiece());
+  resource_bundle->AddDataPackFromPath(default_path, SCALE_FACTOR_100P);
+  EXPECT_EQ(1u, NumDataPacksInResourceBundle(resource_bundle));
+  EXPECT_EQ(0u, NumMaterialDesignDataPacksInResourceBundle(resource_bundle));
+
+  // Add a material data pack.
+  base::FilePath material_path1 = dir_path().AppendASCII("material1.pak");
+  CreateDataPackWithSingleBitmap(material_path1, 10, base::StringPiece());
+  resource_bundle->AddMaterialDesignDataPackFromPath(material_path1,
+                                                     SCALE_FACTOR_100P);
+  EXPECT_EQ(2u, NumDataPacksInResourceBundle(resource_bundle));
+  EXPECT_EQ(1u, NumMaterialDesignDataPacksInResourceBundle(resource_bundle));
+}
+
+// Verifies that data packs containing material design resources are permitted
+// to have resource IDs which are present within other data packs managed by
+// ResourceBundle. This test passes if it does not trigger the DCHECK in
+// DataPack::CheckForDuplicateResources().
+TEST_F(ResourceBundleImageTest, NoCrashWithDuplicateMaterialDesignResources) {
+  // Create two data packs, each containing a single asset with the same ID.
+  base::FilePath default_path = dir_path().AppendASCII("default.pak");
+  base::FilePath material_path = dir_path().AppendASCII("material.pak");
+  CreateDataPackWithSingleBitmap(default_path, 10, base::StringPiece());
+  CreateDataPackWithSingleBitmap(material_path, 10, base::StringPiece());
+
+  // Should not crash.
+  ResourceBundle* resource_bundle = CreateResourceBundleWithEmptyLocalePak();
+  resource_bundle->AddMaterialDesignDataPackFromPath(material_path,
+                                                     SCALE_FACTOR_100P);
+  resource_bundle->AddDataPackFromPath(default_path, SCALE_FACTOR_100P);
+}
+
+// Verifies that ResourceBundle searches data pack A before data pack B for
+// an asset if A was added to the ResourceBundle before B.
+TEST_F(ResourceBundleImageTest, DataPackSearchOrder) {
+  // Create two .pak files, each containing a single image with the
+  // same asset ID but different sizes (note that the images must be
+  // different sizes in this test in order to correctly determine
+  // from which data pack the asset was pulled). Note also that the value
+  // of |material_size| was chosen to be divisible by 3, since iOS may
+  // use this scale factor.
+  const int default_size = 10;
+  const int material_size = 48;
+  ASSERT_NE(default_size, material_size);
+  base::FilePath default_path = dir_path().AppendASCII("default.pak");
+  base::FilePath material_path = dir_path().AppendASCII("material.pak");
+  CreateDataPackWithSingleBitmap(default_path,
+                                 default_size,
+                                 base::StringPiece());
+  CreateDataPackWithSingleBitmap(material_path,
+                                 material_size,
+                                 base::StringPiece());
+
+  ScaleFactor scale_factor = SCALE_FACTOR_100P;
+  int expected_size = material_size;
+  ResourceBundle* resource_bundle = CreateResourceBundleWithEmptyLocalePak();
+
+#if defined(OS_IOS)
+  // iOS retina devices do not use 100P scaling. See crbug.com/298406.
+  scale_factor = resource_bundle->GetMaxScaleFactor();
+  expected_size = material_size / GetScaleForScaleFactor(scale_factor);
+#endif
+
+  // Load the 'material' data pack into ResourceBundle first.
+  resource_bundle->AddMaterialDesignDataPackFromPath(material_path,
+                                                     scale_factor);
+  resource_bundle->AddDataPackFromPath(default_path, scale_factor);
+
+  // A request for the image with ID 3 should return the image from the material
+  // data pack.
+  gfx::ImageSkia* image_skia = resource_bundle->GetImageSkiaNamed(3);
+  const SkBitmap* bitmap = image_skia->bitmap();
+  ASSERT_TRUE(bitmap);
+  EXPECT_EQ(expected_size, bitmap->width());
+  EXPECT_EQ(expected_size, bitmap->height());
+
+  // A subsequent request for the image with ID 3 (i.e., after the image
+  // has been cached by ResourceBundle) should also return the image
+  // from the material data pack.
+  gfx::ImageSkia* image_skia2 = resource_bundle->GetImageSkiaNamed(3);
+  const SkBitmap* bitmap2 = image_skia2->bitmap();
+  ASSERT_TRUE(bitmap2);
+  EXPECT_EQ(expected_size, bitmap2->width());
+  EXPECT_EQ(expected_size, bitmap2->height());
+}
+
 // Test that GetImageNamed() behaves properly for images which GRIT has
 // annotated as having fallen back to 1x.
 TEST_F(ResourceBundleImageTest, GetImageNamedFallback1x) {
diff --git a/ui/base/resource/resource_data_dll_win.cc b/ui/base/resource/resource_data_dll_win.cc
index 12c54c9..4cf3266 100644
--- a/ui/base/resource/resource_data_dll_win.cc
+++ b/ui/base/resource/resource_data_dll_win.cc
@@ -62,4 +62,8 @@ ScaleFactor ResourceDataDLL::GetScaleFactor() const {
   return ui::SCALE_FACTOR_NONE;
 }
 
+bool ResourceDataDLL::HasOnlyMaterialDesignAssets() const {
+  return false;
+}
+
 }  // namespace ui
diff --git a/ui/base/resource/resource_data_dll_win.h b/ui/base/resource/resource_data_dll_win.h
index c5f0e60..b7f6018 100644
--- a/ui/base/resource/resource_data_dll_win.h
+++ b/ui/base/resource/resource_data_dll_win.h
@@ -27,6 +27,7 @@ class ResourceDataDLL : public ResourceHandle {
       uint16_t resource_id) const override;
   TextEncodingType GetTextEncodingType() const override;
   ScaleFactor GetScaleFactor() const override;
+  bool HasOnlyMaterialDesignAssets() const override;
 
  private:
   const HINSTANCE module_;
diff --git a/ui/base/resource/resource_handle.h b/ui/base/resource/resource_handle.h
index 055b037..9632c53 100644
--- a/ui/base/resource/resource_handle.h
+++ b/ui/base/resource/resource_handle.h
@@ -48,6 +48,10 @@ class UI_DATA_PACK_EXPORT ResourceHandle {
   // The scale of images in this resource pack relative to images in the 1x
   // resource pak.
   virtual ScaleFactor GetScaleFactor() const = 0;
+
+  // Returns true if the only resources contained within this DataPack are
+  // material design image assets.
+  virtual bool HasOnlyMaterialDesignAssets() const = 0;
 };
 
 }  // namespace ui
diff --git a/ui/base/ui_base_tests.gyp b/ui/base/ui_base_tests.gyp
index 12e80b0..fd5aa0b 100644
--- a/ui/base/ui_base_tests.gyp
+++ b/ui/base/ui_base_tests.gyp
@@ -45,6 +45,7 @@
         'models/tree_node_iterator_unittest.cc',
         'resource/data_pack_literal.cc',
         'resource/data_pack_unittest.cc',
+        'resource/resource_bundle_mac_unittest.mm',
         'resource/resource_bundle_unittest.cc',
         'resource/scale_factor_unittest.cc',
         'template_expressions_unittest.cc',
diff --git a/ui/compositor/canvas_painter.cc b/ui/compositor/canvas_painter.cc
index 618fa75..b67d486 100644
--- a/ui/compositor/canvas_painter.cc
+++ b/ui/compositor/canvas_painter.cc
@@ -17,9 +17,8 @@ CanvasPainter::CanvasPainter(gfx::Canvas* canvas, float raster_scale_factor)
           gfx::Rect(canvas_->sk_canvas()->getBaseLayerSize().width(),
                     canvas_->sk_canvas()->getBaseLayerSize().height()),
           1.f / raster_scale_factor)),
-      list_(cc::DisplayItemList::Create(rect_, cc::DisplayItemListSettings())),
-      context_(list_.get(), raster_scale_factor_, rect_) {
-}
+      list_(cc::DisplayItemList::Create(cc::DisplayItemListSettings())),
+      context_(list_.get(), raster_scale_factor_, rect_) {}
 
 CanvasPainter::~CanvasPainter() {
   list_->Finalize();
diff --git a/ui/compositor/layer.cc b/ui/compositor/layer.cc
index 7dcf177..5161068 100644
--- a/ui/compositor/layer.cc
+++ b/ui/compositor/layer.cc
@@ -775,7 +775,7 @@ scoped_refptr<cc::DisplayItemList> Layer::PaintContentsToDisplayList(
   cc::DisplayItemListSettings settings;
   settings.use_cached_picture = false;
   scoped_refptr<cc::DisplayItemList> display_list =
-      cc::DisplayItemList::Create(PaintableRegion(), settings);
+      cc::DisplayItemList::Create(settings);
   if (delegate_) {
     delegate_->OnPaintLayer(
         PaintContext(display_list.get(), device_scale_factor_, invalidation));
diff --git a/ui/gfx/color_transform_unittest.cc b/ui/gfx/color_transform_unittest.cc
index 3203059..d943c7d 100644
--- a/ui/gfx/color_transform_unittest.cc
+++ b/ui/gfx/color_transform_unittest.cc
@@ -336,13 +336,7 @@ unsigned char srgb_icc_data[] = {
     0x00, 0x00, 0x07, 0x94, 0x00, 0x00, 0xfd, 0x8f, 0xff, 0xff, 0xfb, 0xa1,
     0xff, 0xff, 0xfd, 0xa2, 0x00, 0x00, 0x03, 0xdb, 0x00, 0x00, 0xc0, 0x75};
 
-// MSan detects an uninitialized read in QCMS. https://crbug.com/635042
-#if defined(MEMORY_SANITIZER)
-#define MAYBE_BT709toSRGBICC DISABLED_BT709toSRGBICC
-#else
-#define MAYBE_BT709toSRGBICC BT709toSRGBICC
-#endif
-TEST(SimpleColorSpace, MAYBE_BT709toSRGBICC) {
+TEST(SimpleColorSpace, BT709toSRGBICC) {
   ICCProfile srgb_icc = ICCProfile::FromData(
       reinterpret_cast<char*>(srgb_icc_data), arraysize(srgb_icc_data));
 
diff --git a/ui/gl/ca_renderer_layer_params.h b/ui/gl/ca_renderer_layer_params.h
index ab046a2..22ba8aa 100644
--- a/ui/gl/ca_renderer_layer_params.h
+++ b/ui/gl/ca_renderer_layer_params.h
@@ -49,7 +49,8 @@ struct GL_EXPORT CARendererLayerParams {
 
   // This is a subset of cc::FilterOperation::FilterType.
   enum class FilterEffectType : uint32_t {
-    GRAYSCALE,
+    MIN,
+    GRAYSCALE = MIN,
     SEPIA,
     SATURATE,
     HUE_ROTATE,
@@ -59,6 +60,7 @@ struct GL_EXPORT CARendererLayerParams {
     OPACITY,
     BLUR,
     DROP_SHADOW,
+    MAX = DROP_SHADOW
   };
   struct GL_EXPORT FilterEffect {
     FilterEffectType type = FilterEffectType::GRAYSCALE;
diff --git a/ui/gl/init/gl_factory_mac.cc b/ui/gl/init/gl_factory_mac.cc
index 225fd16..faca605 100644
--- a/ui/gl/init/gl_factory_mac.cc
+++ b/ui/gl/init/gl_factory_mac.cc
@@ -5,7 +5,6 @@
 #include "ui/gl/init/gl_factory.h"
 
 #include "base/command_line.h"
-#include "base/feature_list.h"
 #include "base/logging.h"
 #include "base/macros.h"
 #include "base/trace_event/trace_event.h"
@@ -20,11 +19,6 @@
 #include "ui/gl/gl_surface_stub.h"
 #include "ui/gl/gl_switches.h"
 
-namespace features {
-const base::Feature kDesktopCoreProfileGLOnMac{
-    "DesktopCoreProfileGLOnMac", base::FEATURE_DISABLED_BY_DEFAULT};
-}
-
 namespace gl {
 namespace init {
 
@@ -64,8 +58,7 @@ class NoOpGLSurface : public GLSurface {
 
 std::vector<GLImplementation> GetAllowedGLImplementations() {
   std::vector<GLImplementation> impls;
-  if (base::FeatureList::IsEnabled(features::kDesktopCoreProfileGLOnMac) ||
-      base::CommandLine::ForCurrentProcess()->HasSwitch(
+  if (base::CommandLine::ForCurrentProcess()->HasSwitch(
           switches::kEnableUnsafeES3APIs)) {
     impls.push_back(kGLImplementationDesktopGLCoreProfile);
   }
diff --git a/ui/login/account_picker/user_pod_row.js b/ui/login/account_picker/user_pod_row.js
index d14bb17..0027539 100644
--- a/ui/login/account_picker/user_pod_row.js
+++ b/ui/login/account_picker/user_pod_row.js
@@ -1111,6 +1111,8 @@ cr.define('login', function() {
       // Set the focus to the input element after showing/hiding pin keyboard.
       if (this.pinKeyboard && visible)
         this.pinKeyboard.focus();
+      else
+        this.mainInput.focus();
     },
 
     isPinShown: function() {
diff --git a/ui/native_theme/BUILD.gn b/ui/native_theme/BUILD.gn
index 6314939..b79e113 100644
--- a/ui/native_theme/BUILD.gn
+++ b/ui/native_theme/BUILD.gn
@@ -81,7 +81,6 @@ test("native_theme_unittests") {
     "//base/test:test_support",
     "//skia:skia",
     "//testing/gtest",
-    "//ui/base",
     "//ui/gfx/geometry:geometry",
   ]
 }
diff --git a/ui/native_theme/native_theme.gyp b/ui/native_theme/native_theme.gyp
index 0359a30..afec2e9 100644
--- a/ui/native_theme/native_theme.gyp
+++ b/ui/native_theme/native_theme.gyp
@@ -58,7 +58,6 @@
         '../../base/base.gyp:test_support_base',
         '../../skia/skia.gyp:skia',
         '../../testing/gtest.gyp:gtest',
-        '../base/ui_base.gyp:ui_base',
         '../gfx/gfx.gyp:gfx_geometry',
         'native_theme',
       ],
diff --git a/ui/native_theme/native_theme_mac_unittest.cc b/ui/native_theme/native_theme_mac_unittest.cc
index cd8d49b..c7c92d6 100644
--- a/ui/native_theme/native_theme_mac_unittest.cc
+++ b/ui/native_theme/native_theme_mac_unittest.cc
@@ -2,7 +2,6 @@
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
-#include "ui/base/material_design/material_design_controller.h"
 #include "ui/native_theme/native_theme_mac.h"
 
 #include "base/mac/mac_util.h"
@@ -10,17 +9,10 @@
 
 namespace ui {
 
-class NativeThemeMacTest : public testing::Test {
- public:
-  static void SetUpTestCase() {
-    MaterialDesignController::Initialize();
-  }
-};
-
 // Test to ensure any system colors that are looked up by name exist on all Mac
 // platforms Chrome supports, and that their colorspace and component count is
 // sane.
-TEST_F(NativeThemeMacTest, SystemColorsExist) {
+TEST(NativeThemeMacTest, SystemColorsExist) {
   NativeTheme* native_theme = NativeThemeMac::instance();
   ASSERT_TRUE(native_theme);
   for (int i = 0; i < NativeTheme::kColorId_NumColors; ++i) {
@@ -35,7 +27,7 @@ TEST_F(NativeThemeMacTest, SystemColorsExist) {
 
 // Spot-check some system colours that can't be changed through System
 // Preferences.
-TEST_F(NativeThemeMacTest, SystemColorSpotChecks) {
+TEST(NativeThemeMacTest, SystemColorSpotChecks) {
   NativeTheme* native_theme = NativeThemeMac::instance();
   const SkColor kWindowColorCatsMavericks = SkColorSetARGB(255, 232, 232, 232);
   const SkColor kWindowColorYosemite = SkColorSetARGB(255, 236, 236, 236);
diff --git a/ui/native_theme/native_theme_switches.cc b/ui/native_theme/native_theme_switches.cc
index fc8c0ff..873af51 100644
--- a/ui/native_theme/native_theme_switches.cc
+++ b/ui/native_theme/native_theme_switches.cc
@@ -13,9 +13,6 @@ const char kEnableOverlayScrollbar[] = "enable-overlay-scrollbar";
 // Disables overlay scrollbars on Aura or Linux. Does nothing on Mac.
 const char kDisableOverlayScrollbar[] = "disable-overlay-scrollbar";
 
-// Hides scrollbars on Aura, Linux, Android, ChromeOS. Does nothing on Mac.
-const char kHideScrollbars[] = "hide-scrollbars";
-
 }  // namespace switches
 
 namespace ui {
@@ -24,10 +21,6 @@ bool IsOverlayScrollbarEnabled() {
   const base::CommandLine& command_line =
       *base::CommandLine::ForCurrentProcess();
 
-  // Hidden scrollbars are realized through never-showing overlay scrollbars.
-  if (ShouldHideScrollbars())
-    return true;
-
   if (command_line.HasSwitch(switches::kDisableOverlayScrollbar))
     return false;
   else if (command_line.HasSwitch(switches::kEnableOverlayScrollbar))
@@ -36,10 +29,4 @@ bool IsOverlayScrollbarEnabled() {
   return false;
 }
 
-bool ShouldHideScrollbars() {
-  const base::CommandLine& command_line =
-      *base::CommandLine::ForCurrentProcess();
-  return command_line.HasSwitch(switches::kHideScrollbars);
-}
-
 }  // namespace ui
diff --git a/ui/native_theme/native_theme_switches.h b/ui/native_theme/native_theme_switches.h
index 643ba62..026ee70 100644
--- a/ui/native_theme/native_theme_switches.h
+++ b/ui/native_theme/native_theme_switches.h
@@ -13,14 +13,12 @@ namespace switches {
 
 NATIVE_THEME_EXPORT extern const char kDisableOverlayScrollbar[];
 NATIVE_THEME_EXPORT extern const char kEnableOverlayScrollbar[];
-NATIVE_THEME_EXPORT extern const char kHideScrollbars[];
 
 }  // namespace switches
 
 namespace ui {
 
 NATIVE_THEME_EXPORT bool IsOverlayScrollbarEnabled();
-NATIVE_THEME_EXPORT bool ShouldHideScrollbars();
 
 }  // namespace ui
 
diff --git a/ui/views/controls/message_box_view.h b/ui/views/controls/message_box_view.h
index af6905d..2d83532 100644
--- a/ui/views/controls/message_box_view.h
+++ b/ui/views/controls/message_box_view.h
@@ -63,9 +63,6 @@ class VIEWS_EXPORT MessageBoxView : public View {
   // Returns user entered data in the prompt field.
   base::string16 GetInputText();
 
-  // Returns true if this message box has a visible checkbox, false otherwise.
-  bool HasCheckBox() const { return !!checkbox_; }
-
   // Returns true if a checkbox is selected, false otherwise. (And false if
   // the message box has no checkbox.)
   bool IsCheckBoxSelected();
diff --git a/ui/views/mus/BUILD.gn b/ui/views/mus/BUILD.gn
index 72110d4..a1a4704 100644
--- a/ui/views/mus/BUILD.gn
+++ b/ui/views/mus/BUILD.gn
@@ -28,8 +28,6 @@ component("mus") {
     "mus_export.h",
     "native_widget_mus.cc",
     "native_widget_mus.h",
-    "os_exchange_data_provider_mus.cc",
-    "os_exchange_data_provider_mus.h",
     "screen_mus.cc",
     "screen_mus.h",
     "screen_mus_delegate.h",
diff --git a/ui/views/mus/os_exchange_data_provider_mus.cc b/ui/views/mus/os_exchange_data_provider_mus.cc
deleted file mode 100644
index 84a35d5..0000000
--- a/ui/views/mus/os_exchange_data_provider_mus.cc
+++ /dev/null
@@ -1,147 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#include "ui/views/mus/os_exchange_data_provider_mus.h"
-
-namespace views {
-
-OSExchangeDataProviderMus::OSExchangeDataProviderMus() {}
-
-OSExchangeDataProviderMus::~OSExchangeDataProviderMus() {}
-
-std::unique_ptr<ui::OSExchangeData::Provider>
-OSExchangeDataProviderMus::Clone() const {
-  return std::unique_ptr<ui::OSExchangeData::Provider>();
-}
-
-void OSExchangeDataProviderMus::MarkOriginatedFromRenderer() {
-}
-
-bool OSExchangeDataProviderMus::DidOriginateFromRenderer() const {
-  return false;
-}
-
-void OSExchangeDataProviderMus::SetString(const base::string16& data) {
-}
-
-void OSExchangeDataProviderMus::SetURL(const GURL& url,
-                                       const base::string16& title) {
-}
-
-void OSExchangeDataProviderMus::SetFilename(const base::FilePath& path) {
-}
-
-void OSExchangeDataProviderMus::SetFilenames(
-    const std::vector<ui::FileInfo>& file_names) {
-}
-
-void OSExchangeDataProviderMus::SetPickledData(
-    const ui::Clipboard::FormatType& format,
-    const base::Pickle& data) {
-}
-
-bool OSExchangeDataProviderMus::GetString(base::string16* data) const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::GetURLAndTitle(
-    ui::OSExchangeData::FilenameToURLPolicy policy,
-    GURL* url,
-    base::string16* title) const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::GetFilename(base::FilePath* path) const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::GetFilenames(
-    std::vector<ui::FileInfo>* file_names) const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::GetPickledData(
-    const ui::Clipboard::FormatType& format,
-    base::Pickle* data) const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::HasString() const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::HasURL(
-    ui::OSExchangeData::FilenameToURLPolicy policy) const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::HasFile() const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::HasCustomFormat(
-    const ui::Clipboard::FormatType& format) const {
-  return false;
-}
-
-// These methods were added in an ad-hoc way to different operating
-// systems. We need to support them until they get cleaned up.
-#if (!defined(OS_CHROMEOS) && defined(USE_X11)) || defined(OS_WIN)
-void OSExchangeDataProviderMus::SetFileContents(
-    const base::FilePath& filename,
-    const std::string& file_contents) {
-
-}
-#endif
-
-#if defined(OS_WIN)
-bool OSExchangeDataProviderMus::GetFileContents(
-    base::FilePath* filename,
-    std::string* file_contents) const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::HasFileContents() const {
-  return false;
-}
-
-void OSExchangeDataProviderMus::SetDownloadFileInfo(
-    const ui::OSExchangeData::DownloadFileInfo& download) {
-}
-#endif
-
-#if defined(USE_AURA)
-void OSExchangeDataProviderMus::SetHtml(const base::string16& html,
-                                        const GURL& base_url) {
-
-}
-
-bool OSExchangeDataProviderMus::GetHtml(base::string16* html,
-                                        GURL* base_url) const {
-  return false;
-}
-
-bool OSExchangeDataProviderMus::HasHtml() const {
-  return false;
-}
-#endif
-
-#if defined(USE_AURA) || defined(OS_MACOSX)
-void OSExchangeDataProviderMus::SetDragImage(
-    const gfx::ImageSkia& image,
-    const gfx::Vector2d& cursor_offset) {
-  drag_image_ = image;
-  drag_image_offset_ = cursor_offset;
-}
-
-const gfx::ImageSkia& OSExchangeDataProviderMus::GetDragImage() const {
-  return drag_image_;
-}
-
-const gfx::Vector2d& OSExchangeDataProviderMus::GetDragImageOffset() const {
-  return drag_image_offset_;
-}
-#endif
-
-}  // namespace views
diff --git a/ui/views/mus/os_exchange_data_provider_mus.h b/ui/views/mus/os_exchange_data_provider_mus.h
deleted file mode 100644
index 7d47dd5..0000000
--- a/ui/views/mus/os_exchange_data_provider_mus.h
+++ /dev/null
@@ -1,88 +0,0 @@
-// Copyright 2016 The Chromium Authors. All rights reserved.
-// Use of this source code is governed by a BSD-style license that can be
-// found in the LICENSE file.
-
-#ifndef UI_VIEWS_MUS_OS_EXCHANGE_DATA_PROVIDER_MUS_H_
-#define UI_VIEWS_MUS_OS_EXCHANGE_DATA_PROVIDER_MUS_H_
-
-#include "ui/base/dragdrop/os_exchange_data.h"
-
-#include "ui/gfx/geometry/vector2d.h"
-#include "ui/gfx/image/image_skia.h"
-
-namespace views {
-
-class OSExchangeDataProviderMus : public ui::OSExchangeData::Provider {
- public:
-  OSExchangeDataProviderMus();
-  ~OSExchangeDataProviderMus() override;
-
-  // Overridden from OSExchangeData::Provider:
-  std::unique_ptr<Provider> Clone() const override;
-
-  void MarkOriginatedFromRenderer() override;
-  bool DidOriginateFromRenderer() const override;
-
-  void SetString(const base::string16& data) override;
-  void SetURL(const GURL& url, const base::string16& title) override;
-  void SetFilename(const base::FilePath& path) override;
-  void SetFilenames(const std::vector<ui::FileInfo>& file_names) override;
-  void SetPickledData(const ui::Clipboard::FormatType& format,
-                              const base::Pickle& data) override;
-
-  bool GetString(base::string16* data) const override;
-  bool GetURLAndTitle(ui::OSExchangeData::FilenameToURLPolicy policy,
-                              GURL* url,
-                              base::string16* title) const override;
-  bool GetFilename(base::FilePath* path) const override;
-  bool GetFilenames(std::vector<ui::FileInfo>* file_names) const override;
-  bool GetPickledData(const ui::Clipboard::FormatType& format,
-                              base::Pickle* data) const override;
-
-  bool HasString() const override;
-  bool HasURL(ui::OSExchangeData::FilenameToURLPolicy policy) const override;
-  bool HasFile() const override;
-  bool HasCustomFormat(const ui::Clipboard::FormatType& format) const override;
-
-  // Provider doesn't have a consistent interface between operating systems;
-  // this wasn't seen as a problem when there was a single Provider subclass
-  // per operating system. Now we have to have at least two providers per OS,
-  // leading to the following warts, which will remain until we clean all the
-  // callsites up.
-#if (!defined(OS_CHROMEOS) && defined(USE_X11)) || defined(OS_WIN)
-  void SetFileContents(const base::FilePath& filename,
-                       const std::string& file_contents) override;
-#endif
-#if defined(OS_WIN)
-  bool GetFileContents(base::FilePath* filename,
-                       std::string* file_contents) const override;
-  bool HasFileContents() const override;
-  void SetDownloadFileInfo(
-      const ui::OSExchangeData::DownloadFileInfo& download) override;
-#endif
-
-#if defined(USE_AURA)
-  void SetHtml(const base::string16& html, const GURL& base_url) override;
-  bool GetHtml(base::string16* html, GURL* base_url) const override;
-  bool HasHtml() const override;
-#endif
-
-#if defined(USE_AURA) || defined(OS_MACOSX)
-  void SetDragImage(const gfx::ImageSkia& image,
-                            const gfx::Vector2d& cursor_offset) override;
-  const gfx::ImageSkia& GetDragImage() const override;
-  const gfx::Vector2d& GetDragImageOffset() const override;
-#endif
-
- private:
-  // Drag image and offset data.
-  gfx::ImageSkia drag_image_;
-  gfx::Vector2d drag_image_offset_;
-
-
-  DISALLOW_COPY_AND_ASSIGN(OSExchangeDataProviderMus);
-};
-
-}  // namespace views
-
-#endif  // UI_VIEWS_MUS_OS_EXCHANGE_DATA_PROVIDER_MUS_H_
diff --git a/ui/views/mus/window_manager_connection.cc b/ui/views/mus/window_manager_connection.cc
index fccfb9e..a16ed87 100644
--- a/ui/views/mus/window_manager_connection.cc
+++ b/ui/views/mus/window_manager_connection.cc
@@ -7,7 +7,6 @@
 #include <utility>
 
 #include "base/lazy_instance.h"
-#include "base/memory/ptr_util.h"
 #include "base/threading/thread_local.h"
 #include "services/shell/public/cpp/connection.h"
 #include "services/shell/public/cpp/connector.h"
@@ -20,7 +19,6 @@
 #include "services/ui/public/interfaces/window_tree.mojom.h"
 #include "ui/views/mus/clipboard_mus.h"
 #include "ui/views/mus/native_widget_mus.h"
-#include "ui/views/mus/os_exchange_data_provider_mus.h"
 #include "ui/views/mus/screen_mus.h"
 #include "ui/views/pointer_watcher.h"
 #include "ui/views/touch_event_watcher.h"
@@ -42,7 +40,6 @@ WindowManagerConnection::~WindowManagerConnection() {
   // ~WindowTreeClient calls back to us (we're its delegate), destroy it while
   // we are still valid.
   client_.reset();
-  ui::OSExchangeDataProviderFactory::SetFactory(nullptr);
   ui::Clipboard::DestroyClipboardForCurrentThread();
   gpu_service_.reset();
   lazy_tls_ptr.Pointer()->Set(nullptr);
@@ -164,8 +161,6 @@ WindowManagerConnection::WindowManagerConnection(
   clipboard->Init(connector);
   ui::Clipboard::SetClipboardForCurrentThread(std::move(clipboard));
 
-  ui::OSExchangeDataProviderFactory::SetFactory(this);
-
   ViewsDelegate::GetInstance()->set_native_widget_factory(base::Bind(
       &WindowManagerConnection::CreateNativeWidgetMus,
       base::Unretained(this),
@@ -241,9 +236,4 @@ gfx::Point WindowManagerConnection::GetCursorScreenPoint() {
   return client_->GetCursorScreenPoint();
 }
 
-std::unique_ptr<OSExchangeData::Provider>
-WindowManagerConnection::BuildProvider() {
-  return base::MakeUnique<OSExchangeDataProviderMus>();
-}
-
 }  // namespace views
diff --git a/ui/views/mus/window_manager_connection.h b/ui/views/mus/window_manager_connection.h
index 4cbdcda..69291f7 100644
--- a/ui/views/mus/window_manager_connection.h
+++ b/ui/views/mus/window_manager_connection.h
@@ -16,7 +16,6 @@
 #include "base/observer_list.h"
 #include "services/shell/public/cpp/identity.h"
 #include "services/ui/public/cpp/window_tree_client_delegate.h"
-#include "ui/base/dragdrop/os_exchange_data_provider_factory.h"
 #include "ui/views/mus/mus_export.h"
 #include "ui/views/mus/screen_mus_delegate.h"
 #include "ui/views/widget/widget.h"
@@ -50,8 +49,7 @@ class NativeWidgetDelegate;
 // TODO(sky): this name is now totally confusing. Come up with a better one.
 class VIEWS_MUS_EXPORT WindowManagerConnection
     : public NON_EXPORTED_BASE(ui::WindowTreeClientDelegate),
-      public ScreenMusDelegate,
-      public ui::OSExchangeDataProviderFactory::Factory {
+      public ScreenMusDelegate {
  public:
   ~WindowManagerConnection() override;
 
@@ -98,9 +96,6 @@ class VIEWS_MUS_EXPORT WindowManagerConnection
   void OnWindowManagerFrameValuesChanged() override;
   gfx::Point GetCursorScreenPoint() override;
 
-  // ui:OSExchangeDataProviderFactory::Factory:
-  std::unique_ptr<OSExchangeData::Provider> BuildProvider() override;
-
   shell::Connector* connector_;
   shell::Identity identity_;
   std::unique_ptr<ScreenMus> screen_;
diff --git a/ui/views/view_unittest.cc b/ui/views/view_unittest.cc
index 38f55bd..e9af12a 100644
--- a/ui/views/view_unittest.cc
+++ b/ui/views/view_unittest.cc
@@ -526,7 +526,7 @@ TEST_F(ViewTest, PaintEmptyView) {
   // Paint "everything".
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
 
   // The empty view has nothing to paint so it doesn't try build a cache, nor do
@@ -548,7 +548,7 @@ TEST_F(ViewTest, PaintWithMovedViewUsesCache) {
   gfx::Rect pixel_rect = gfx::Rect(1, 1);
   float device_scale_factor = 1.f;
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(
       ui::PaintContext(list.get(), device_scale_factor, pixel_rect));
   EXPECT_TRUE(v1->did_paint_);
@@ -564,14 +564,14 @@ TEST_F(ViewTest, PaintWithMovedViewUsesCache) {
             list->VisualRectForTesting(item_index));
 
   // If invalidation doesn't intersect v1, we paint with the cache.
-  list = cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(
       ui::PaintContext(list.get(), device_scale_factor, pixel_rect));
   EXPECT_FALSE(v1->did_paint_);
   v1->Reset();
 
   // If invalidation does intersect v1, we don't paint with the cache.
-  list = cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(
       ui::PaintContext(list.get(), device_scale_factor, v1->bounds()));
   EXPECT_TRUE(v1->did_paint_);
@@ -579,7 +579,7 @@ TEST_F(ViewTest, PaintWithMovedViewUsesCache) {
 
   // Moving the view should still use the cache when the invalidation doesn't
   // intersect v1.
-  list = cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   v1->SetX(9);
   root_view->Paint(
       ui::PaintContext(list.get(), device_scale_factor, pixel_rect));
@@ -596,7 +596,7 @@ TEST_F(ViewTest, PaintWithMovedViewUsesCache) {
 
   // Moving the view should not use the cache when painting without
   // invalidation.
-  list = cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   v1->SetX(8);
   root_view->Paint(ui::PaintContext(
       ui::PaintContext(list.get(), device_scale_factor, pixel_rect),
@@ -626,7 +626,7 @@ TEST_F(ViewTest, PaintWithMovedViewUsesCacheInRTL) {
   gfx::Rect pixel_rect = gfx::Rect(1, 1);
   float device_scale_factor = 1.f;
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(
       ui::PaintContext(list.get(), device_scale_factor, pixel_rect));
   EXPECT_TRUE(v1->did_paint_);
@@ -643,14 +643,14 @@ TEST_F(ViewTest, PaintWithMovedViewUsesCacheInRTL) {
             list->VisualRectForTesting(item_index));
 
   // If invalidation doesn't intersect v1, we paint with the cache.
-  list = cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(
       ui::PaintContext(list.get(), device_scale_factor, pixel_rect));
   EXPECT_FALSE(v1->did_paint_);
   v1->Reset();
 
   // If invalidation does intersect v1, we don't paint with the cache.
-  list = cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(
       ui::PaintContext(list.get(), device_scale_factor, v1->bounds()));
   EXPECT_TRUE(v1->did_paint_);
@@ -658,7 +658,7 @@ TEST_F(ViewTest, PaintWithMovedViewUsesCacheInRTL) {
 
   // Moving the view should still use the cache when the invalidation doesn't
   // intersect v1.
-  list = cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   v1->SetX(9);
   root_view->Paint(
       ui::PaintContext(list.get(), device_scale_factor, pixel_rect));
@@ -676,7 +676,7 @@ TEST_F(ViewTest, PaintWithMovedViewUsesCacheInRTL) {
 
   // Moving the view should not use the cache when painting without
   // invalidation.
-  list = cc::DisplayItemList::Create(pixel_rect, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   v1->SetX(8);
   root_view->Paint(ui::PaintContext(
       ui::PaintContext(list.get(), device_scale_factor, pixel_rect),
@@ -710,14 +710,14 @@ TEST_F(ViewTest, PaintWithUnknownInvalidation) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
 
   gfx::Rect paint_area(1, 1);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   // With a known invalidation, v1 and v2 are not painted.
   EXPECT_FALSE(v1->did_paint_);
@@ -750,14 +750,14 @@ TEST_F(ViewTest, PaintContainsChildren) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
 
   gfx::Rect paint_area(25, 26);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -794,14 +794,14 @@ TEST_F(ViewTest, PaintContainsChildrenInRTL) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
 
   gfx::Rect paint_area(25, 26);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -826,14 +826,14 @@ TEST_F(ViewTest, PaintIntersectsChildren) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
 
   gfx::Rect paint_area(9, 10, 5, 6);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -870,14 +870,14 @@ TEST_F(ViewTest, PaintIntersectsChildrenInRTL) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
 
   gfx::Rect paint_area(2, 10, 5, 6);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -902,14 +902,14 @@ TEST_F(ViewTest, PaintIntersectsChildButNotGrandChild) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
 
   gfx::Rect paint_area(9, 10, 2, 3);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -946,14 +946,14 @@ TEST_F(ViewTest, PaintIntersectsChildButNotGrandChildInRTL) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
 
   gfx::Rect paint_area(2, 10, 2, 3);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -978,14 +978,14 @@ TEST_F(ViewTest, PaintIntersectsNoChildren) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
 
   gfx::Rect paint_area(9, 10, 2, 1);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -1022,14 +1022,14 @@ TEST_F(ViewTest, PaintIntersectsNoChildrenInRTL) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
 
   gfx::Rect paint_area(2, 10, 2, 1);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -1054,7 +1054,7 @@ TEST_F(ViewTest, PaintIntersectsOneChild) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
@@ -1062,7 +1062,7 @@ TEST_F(ViewTest, PaintIntersectsOneChild) {
   // Intersects with the second child only.
   gfx::Rect paint_area(3, 3, 1, 2);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -1110,7 +1110,7 @@ TEST_F(ViewTest, PaintIntersectsOneChildInRTL) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   root_view->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
@@ -1118,7 +1118,7 @@ TEST_F(ViewTest, PaintIntersectsOneChildInRTL) {
   // Intersects with the first child only.
   gfx::Rect paint_area(3, 10, 1, 2);
   gfx::Rect root_area(root_view->size());
-  list = cc::DisplayItemList::Create(root_area, cc::DisplayItemListSettings());
+  list = cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
   EXPECT_FALSE(v1->did_paint_);
   EXPECT_FALSE(v2->did_paint_);
@@ -1155,7 +1155,7 @@ TEST_F(ViewTest, PaintInPromotedToLayer) {
   // invalidation.
   gfx::Rect first_paint(1, 1);
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(first_paint, cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   v1->Paint(ui::PaintContext(list.get(), 1.f, first_paint));
   v1->Reset();
   v2->Reset();
@@ -1164,7 +1164,7 @@ TEST_F(ViewTest, PaintInPromotedToLayer) {
     gfx::Rect paint_area(25, 26);
     gfx::Rect view_area(root_view->size());
     scoped_refptr<cc::DisplayItemList> list =
-        cc::DisplayItemList::Create(view_area, cc::DisplayItemListSettings());
+        cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
     // The promoted views are not painted as they are separate paint roots.
     root_view->Paint(ui::PaintContext(list.get(), 1.f, paint_area));
@@ -1176,7 +1176,7 @@ TEST_F(ViewTest, PaintInPromotedToLayer) {
     gfx::Rect paint_area(1, 1);
     gfx::Rect view_area(v1->size());
     scoped_refptr<cc::DisplayItemList> list =
-        cc::DisplayItemList::Create(view_area, cc::DisplayItemListSettings());
+        cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
     // The |v1| view is painted. If it used its offset incorrect, it would think
     // its at (10,11) instead of at (0,0) since it is the paint root.
@@ -1191,7 +1191,7 @@ TEST_F(ViewTest, PaintInPromotedToLayer) {
     gfx::Rect paint_area(3, 3, 1, 2);
     gfx::Rect view_area(v1->size());
     scoped_refptr<cc::DisplayItemList> list =
-        cc::DisplayItemList::Create(view_area, cc::DisplayItemListSettings());
+        cc::DisplayItemList::Create(cc::DisplayItemListSettings());
 
     // The |v2| view is painted also. If it used its offset incorrect, it would
     // think its at (13,15) instead of at (3,4) since |v1| is the paint root.
@@ -1238,7 +1238,7 @@ TEST_F(ViewTest, PaintLocalBounds) {
   EXPECT_EQ(gfx::Rect(0, 1000, 100, 100), v1->GetVisibleBounds());
 
   scoped_refptr<cc::DisplayItemList> list =
-      cc::DisplayItemList::Create(gfx::Rect(), cc::DisplayItemListSettings());
+      cc::DisplayItemList::Create(cc::DisplayItemListSettings());
   ui::PaintContext context(list.get(), 1.f, gfx::Rect());
 
   v1->Paint(context);
diff --git a/ui/views/widget/desktop_aura/desktop_native_widget_aura_unittest.cc b/ui/views/widget/desktop_aura/desktop_native_widget_aura_unittest.cc
index 0020aed..5865426 100644
--- a/ui/views/widget/desktop_aura/desktop_native_widget_aura_unittest.cc
+++ b/ui/views/widget/desktop_aura/desktop_native_widget_aura_unittest.cc
@@ -509,8 +509,6 @@ TEST_F(DesktopAuraWidgetTest, CloseWidgetDuringMouseReleased) {
   RunCloseWidgetDuringDispatchTest(this, ui::ET_MOUSE_RELEASED);
 }
 
-namespace {
-
 // Provides functionality to create a window modal dialog.
 class ModalDialogDelegate : public DialogDelegateView {
  public:
@@ -524,8 +522,6 @@ class ModalDialogDelegate : public DialogDelegateView {
   DISALLOW_COPY_AND_ASSIGN(ModalDialogDelegate);
 };
 
-}  // namespace
-
 // This test verifies that whether mouse events when a modal dialog is
 // displayed are eaten or recieved by the dialog.
 TEST_F(WidgetTest, WindowMouseModalityTest) {
diff --git a/ui/views/widget/widget_unittest.cc b/ui/views/widget/widget_unittest.cc
index 95fc77e..41d666e 100644
--- a/ui/views/widget/widget_unittest.cc
+++ b/ui/views/widget/widget_unittest.cc
@@ -3636,8 +3636,6 @@ TEST_F(WidgetTest, WidgetRemovalsObserverCalledWhenMovingBetweenWidgets) {
 
 #if defined(OS_WIN)
 
-namespace {
-
 // Provides functionality to create a window modal dialog.
 class ModalDialogDelegate : public DialogDelegateView {
 public:
@@ -3653,8 +3651,6 @@ private:
   DISALLOW_COPY_AND_ASSIGN(ModalDialogDelegate);
 };
 
-}  // namespace
-
 // Tests the case where an intervening owner popup window is destroyed out from
 // under the currently active modal top-level window. In this instance, the
 // remaining top-level windows should be re-enabled.
diff --git a/ui/views/window/dialog_client_view.cc b/ui/views/window/dialog_client_view.cc
index fb92712..55bf004 100644
--- a/ui/views/window/dialog_client_view.cc
+++ b/ui/views/window/dialog_client_view.cc
@@ -11,7 +11,6 @@
 #include "ui/events/keycodes/keyboard_codes.h"
 #include "ui/views/background.h"
 #include "ui/views/controls/button/blue_button.h"
-#include "ui/views/controls/button/custom_button.h"
 #include "ui/views/controls/button/label_button.h"
 #include "ui/views/controls/button/md_text_button.h"
 #include "ui/views/layout/layout_constants.h"
@@ -39,19 +38,14 @@ bool ShouldShow(View* view) {
 }
 
 // Do the layout for a button.
-void LayoutButton(LabelButton* button,
-                  gfx::Rect* row_bounds,
-                  int button_height) {
+void LayoutButton(LabelButton* button, gfx::Rect* row_bounds) {
   if (!button)
     return;
 
   const gfx::Size size = button->GetPreferredSize();
   row_bounds->set_width(row_bounds->width() - size.width());
-  DCHECK_LE(button_height, row_bounds->height());
-  button->SetBounds(
-      row_bounds->right(),
-      row_bounds->y() + (row_bounds->height() - button_height) / 2,
-      size.width(), button_height);
+  button->SetBounds(row_bounds->right(), row_bounds->y(),
+                    size.width(), row_bounds->height());
   row_bounds->set_width(row_bounds->width() - kRelatedButtonHSpacing);
 }
 
@@ -186,17 +180,12 @@ void DialogClientView::Layout() {
     const int height = GetButtonsAndExtraViewRowHeight();
     gfx::Rect row_bounds(bounds.x(), bounds.bottom() - height,
                          bounds.width(), height);
-    // If the |extra_view_| is a also button, then the |button_height| is the
-    // maximum height of the three buttons, otherwise it is the maximum height
-    // of the ok and cancel buttons.
-    const int button_height =
-        CustomButton::AsCustomButton(extra_view_) ? height : GetButtonHeight();
     if (kIsOkButtonOnLeftSide) {
-      LayoutButton(cancel_button_, &row_bounds, button_height);
-      LayoutButton(ok_button_, &row_bounds, button_height);
+      LayoutButton(cancel_button_, &row_bounds);
+      LayoutButton(ok_button_, &row_bounds);
     } else {
-      LayoutButton(ok_button_, &row_bounds, button_height);
-      LayoutButton(cancel_button_, &row_bounds, button_height);
+      LayoutButton(ok_button_, &row_bounds);
+      LayoutButton(cancel_button_, &row_bounds);
     }
     if (extra_view_) {
       int custom_padding = 0;
@@ -327,18 +316,13 @@ LabelButton* DialogClientView::CreateDialogButton(ui::DialogButton type) {
   return button;
 }
 
-int DialogClientView::GetButtonHeight() const {
-  return std::max(
+int DialogClientView::GetButtonsAndExtraViewRowHeight() const {
+  int extra_view_height = ShouldShow(extra_view_) ?
+      extra_view_->GetPreferredSize().height() : 0;
+  int buttons_height = std::max(
       ok_button_ ? ok_button_->GetPreferredSize().height() : 0,
       cancel_button_ ? cancel_button_->GetPreferredSize().height() : 0);
-}
-
-int DialogClientView::GetExtraViewHeight() const {
-  return ShouldShow(extra_view_) ? extra_view_->GetPreferredSize().height() : 0;
-}
-
-int DialogClientView::GetButtonsAndExtraViewRowHeight() const {
-  return std::max(GetExtraViewHeight(), GetButtonHeight());
+  return std::max(extra_view_height, buttons_height);
 }
 
 gfx::Insets DialogClientView::GetButtonRowInsets() const {
diff --git a/ui/views/window/dialog_client_view.h b/ui/views/window/dialog_client_view.h
index 3fb88c0..60080b0 100644
--- a/ui/views/window/dialog_client_view.h
+++ b/ui/views/window/dialog_client_view.h
@@ -87,12 +87,6 @@ class VIEWS_EXPORT DialogClientView : public ClientView,
   // Update |button|'s text and enabled state according to the delegate's state.
   void UpdateButton(LabelButton* button, ui::DialogButton type);
 
-  // Returns the height of the buttons.
-  int GetButtonHeight() const;
-
-  // Returns the height of the extra view.
-  int GetExtraViewHeight() const;
-
   // Returns the height of the row containing the buttons and the extra view.
   int GetButtonsAndExtraViewRowHeight() const;
 
diff --git a/ui/webui/resources/cr_elements/cr_profile_avatar_selector/cr_profile_avatar_selector.html b/ui/webui/resources/cr_elements/cr_profile_avatar_selector/cr_profile_avatar_selector.html
index caa6ed1..857b2d2 100644
--- a/ui/webui/resources/cr_elements/cr_profile_avatar_selector/cr_profile_avatar_selector.html
+++ b/ui/webui/resources/cr_elements/cr_profile_avatar_selector/cr_profile_avatar_selector.html
@@ -20,10 +20,10 @@
 
       .avatar {
         --paper-button: {
-          background: var(--paper-grey-300);
+          background-color: var(--paper-grey-300);
         };
         --paper-button-flat-keyboard-focus: {
-          background: var(--paper-grey-400);
+          background-color: var(--paper-grey-400);
         };
         align-items: center;
         border-radius: 2px;
diff --git a/ui/webui/resources/cr_elements/icons.html b/ui/webui/resources/cr_elements/icons.html
index 6b3e996..8ebbfb0 100644
--- a/ui/webui/resources/cr_elements/icons.html
+++ b/ui/webui/resources/cr_elements/icons.html
@@ -12,7 +12,6 @@ Do not add rarely used icons here; place those in your application.
       These icons are copied from Polymer's iron-icons and kept in sorted order.
       See http://goo.gl/Y1OdAq for instructions on adding additional icons.
       -->
-      <g id="add"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></g>
       <g id="arrow-drop-down"><path d="M7 10l5 5 5-5z"></path></g>
       <g id="cancel"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"></path></g>
 <if expr="chromeos">
diff --git a/ui/webui/resources/cr_elements/shared_style_css.html b/ui/webui/resources/cr_elements/shared_style_css.html
index 0735d97..eff2d6b 100644
--- a/ui/webui/resources/cr_elements/shared_style_css.html
+++ b/ui/webui/resources/cr_elements/shared_style_css.html
@@ -10,7 +10,7 @@
         background: var(--google-blue-500);
         color: white;
         --paper-button-flat-keyboard-focus: {
-          background: rgb(58, 117, 215);  /* 88% of --google-blue-500 */
+          background-color: rgb(58, 117, 215);  /* 88% of --google-blue-500 */
         };
       }
 
@@ -20,7 +20,7 @@
 
       .cancel-button {
         --paper-button-flat-keyboard-focus: {
-          background: rgba(0, 0, 0, .12);
+          background-color: rgba(0, 0, 0, .12);
         };
       }
 
diff --git a/url/url_canon_icu_alternatives_android.cc b/url/url_canon_icu_alternatives_android.cc
index bf363b9..9536bc7 100644
--- a/url/url_canon_icu_alternatives_android.cc
+++ b/url/url_canon_icu_alternatives_android.cc
@@ -11,8 +11,6 @@
 #include "jni/IDNStringUtil_jni.h"
 #include "url/url_canon_internal.h"
 
-using base::android::ScopedJavaLocalRef;
-
 namespace url {
 
 // This uses the JDK's conversion function, which uses IDNA 2003, unlike the
